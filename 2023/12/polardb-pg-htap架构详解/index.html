<!doctype html><html lang=zh-CH><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta name=robots content="noodp"><title>polardb pg HTAP架构详解 - 杂货铺</title><meta name=Description content="杂七杂八的，随手记录。"><meta property="og:url" content="https://yangyingchao.github.io/2023/12/polardb-pg-htap%E6%9E%B6%E6%9E%84%E8%AF%A6%E8%A7%A3/"><meta property="og:site_name" content="杂货铺"><meta property="og:title" content="polardb pg HTAP架构详解"><meta property="og:description" content="Table of Contents 1 HTAP 架构原理 2 分布式优化器 3 算子并行化 4 消除数据倾斜问题 5 SQL 级别弹性扩展 6 事务一致性 7 TPC-H 性能：加速比 8 TPC-H 性能：和传统 MPP 数仓对比 9 分布式执行加速索引创建 10 分布式并行执行加速多模：时空数据库 本文为摘录(或转载)，侵删，原文为： https://help.aliyun.com/zh/polardb/polardb-for-postgresql/polardb-for-postgresql-architecture/?spm=a2c4g.11186623.0.0.2e3b5fb1p0L9je
PolarDB PostgreSQL 版读写分离后，由于底层是存储池，理论上 IO 吞吐是无限大的。而大查询只能在单个计算节点上执行，单个计算节点的 CPU/MEM/IO 是有限的，因此单个计算节点无法发挥出存储侧的大 IO 带宽的优势，也无法通过增加计算资源来加速大的查询。PolarDB PostgreSQL 版推出了基于 Shared-Storage 的 MPP 分布式并行执行，来加速在 OLTP 场景下 OLAP 查询。"><meta property="og:locale" content="zh_CH"><meta property="og:type" content="article"><meta property="article:section" content="posts"><meta property="article:published_time" content="2023-12-11T00:00:00+00:00"><meta property="article:modified_time" content="2023-12-11T00:00:00+00:00"><meta property="og:image" content="https://yangyingchao.github.io/logo.png"><meta name=twitter:card content="summary_large_image"><meta name=twitter:image content="https://yangyingchao.github.io/logo.png"><meta name=twitter:title content="polardb pg HTAP架构详解"><meta name=twitter:description content="Table of Contents 1 HTAP 架构原理 2 分布式优化器 3 算子并行化 4 消除数据倾斜问题 5 SQL 级别弹性扩展 6 事务一致性 7 TPC-H 性能：加速比 8 TPC-H 性能：和传统 MPP 数仓对比 9 分布式执行加速索引创建 10 分布式并行执行加速多模：时空数据库 本文为摘录(或转载)，侵删，原文为： https://help.aliyun.com/zh/polardb/polardb-for-postgresql/polardb-for-postgresql-architecture/?spm=a2c4g.11186623.0.0.2e3b5fb1p0L9je
PolarDB PostgreSQL 版读写分离后，由于底层是存储池，理论上 IO 吞吐是无限大的。而大查询只能在单个计算节点上执行，单个计算节点的 CPU/MEM/IO 是有限的，因此单个计算节点无法发挥出存储侧的大 IO 带宽的优势，也无法通过增加计算资源来加速大的查询。PolarDB PostgreSQL 版推出了基于 Shared-Storage 的 MPP 分布式并行执行，来加速在 OLTP 场景下 OLAP 查询。"><meta name=application-name content="杂货铺"><meta name=apple-mobile-web-app-title content="杂货铺"><meta name=theme-color content="#ffffff"><meta name=msapplication-TileColor content="#da532c"><link rel="shortcut icon" type=image/x-icon href=/favicon.ico><link rel=icon type=image/png sizes=32x32 href=/favicon-32x32.png><link rel=icon type=image/png sizes=16x16 href=/favicon-16x16.png><link rel=apple-touch-icon sizes=180x180 href=/apple-touch-icon.png><link rel=mask-icon href=/safari-pinned-tab.svg color=#5bbad5><link rel=manifest href=/site.webmanifest><link rel=canonical href=https://yangyingchao.github.io/2023/12/polardb-pg-htap%E6%9E%B6%E6%9E%84%E8%AF%A6%E8%A7%A3/><link rel=prev href=https://yangyingchao.github.io/2023/12/polardb-pg-%E5%AD%98%E5%82%A8%E8%AE%A1%E7%AE%97%E5%88%86%E7%A6%BB%E6%9E%B6%E6%9E%84%E8%AF%A6%E8%A7%A3/><link rel=next href=https://yangyingchao.github.io/2023/12/polardb-for-postgresql%E6%9E%B6%E6%9E%84%E4%BB%8B%E7%BB%8D/><link rel=stylesheet href=/css/style.min.css><link rel=preload href=https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6.1.1/css/all.min.css as=style onload='this.onload=null,this.rel="stylesheet"'><noscript><link rel=stylesheet href=https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6.1.1/css/all.min.css></noscript><link rel=preload href=https://cdn.jsdelivr.net/npm/animate.css@4.1.1/animate.min.css as=style onload='this.onload=null,this.rel="stylesheet"'><noscript><link rel=stylesheet href=https://cdn.jsdelivr.net/npm/animate.css@4.1.1/animate.min.css></noscript><script type=application/ld+json>{"@context":"http://schema.org","@type":"BlogPosting","headline":"polardb pg HTAP架构详解","inLanguage":"zh-CH","mainEntityOfPage":{"@type":"WebPage","@id":"https:\/\/yangyingchao.github.io\/2023\/12\/polardb-pg-htap%E6%9E%B6%E6%9E%84%E8%AF%A6%E8%A7%A3\/"},"image":["https:\/\/yangyingchao.github.io\/images\/Apple-Devices-Preview.png"],"genre":"posts","wordcount":1839,"url":"https:\/\/yangyingchao.github.io\/2023\/12\/polardb-pg-htap%E6%9E%B6%E6%9E%84%E8%AF%A6%E8%A7%A3\/","datePublished":"2023-12-11T00:00:00+00:00","dateModified":"2023-12-11T00:00:00+00:00","publisher":{"@type":"Organization","name":"xxxx","logo":{"@type":"ImageObject","url":"https:\/\/yangyingchao.github.io\/images\/avatar.jpg","width":160,"height":160}},"author":{"@type":"Person","name":"yc"},"description":""}</script></head><body data-header-desktop=fixed data-header-mobile=auto><script type=text/javascript>(window.localStorage&&localStorage.getItem("theme")?localStorage.getItem("theme")==="dark":"auto"==="auto"?window.matchMedia("(prefers-color-scheme: dark)").matches:"auto"==="dark")&&document.body.setAttribute("theme","dark")</script><div id=mask></div><div class=wrapper><header class=desktop id=header-desktop><div class=header-wrapper><div class=header-title><a href=/ title=杂货铺><span class=header-title-pre><i class='fa-solid fa-house-chimney'></i></span>老杨的杂货铺</a></div><div class=menu><div class=menu-inner><a class=menu-item href=/posts/>所有文章 </a><a class=menu-item href=/tags/>标签 </a><a class=menu-item href=https://github.com/yangyingchao title=GitHub rel="noopener noreffer" target=_blank><i class='fab fa-github fa-fw' aria-hidden=true></i> </a><span class="menu-item delimiter"></span><a href=javascript:void(0); class="menu-item theme-switch" title=切换主题>
<i class="fas fa-adjust fa-fw" aria-hidden=true></i></a></div></div></div></header><header class=mobile id=header-mobile><div class=header-container><div class=header-wrapper><div class=header-title><a href=/ title=杂货铺><span class=header-title-pre><i class='fa-solid fa-house-chimney'></i></span>老杨的杂货铺</a></div><div class=menu-toggle id=menu-toggle-mobile><span></span><span></span><span></span></div></div><div class=menu id=menu-mobile><a class=menu-item href=/posts/ title>所有文章</a><a class=menu-item href=/tags/ title>标签</a><a class=menu-item href=https://github.com/yangyingchao title=GitHub rel="noopener noreffer" target=_blank><i class='fab fa-github fa-fw' aria-hidden=true></i> </a><a href=javascript:void(0); class="menu-item theme-switch" title=切换主题><i class="fas fa-adjust fa-fw" aria-hidden=true></i></a></div></div></header><main class=main><div class=container><div class=toc id=toc-auto><h2 class=toc-title>目录</h2><div class=toc-content id=toc-content-auto></div></div><article class="page single"><h1 class="single-title animate__animated animate__flipInX">polardb pg HTAP架构详解</h1><div class=post-meta><div class=post-meta-line><span class=post-author><a href=/ title=Author rel=author class=author><i class="fas fa-user-circle fa-fw" aria-hidden=true></i>yc</a></span></div><div class=post-meta-line><i class="far fa-calendar-alt fa-fw" aria-hidden=true></i>&nbsp;<time datetime=2023-12-11>2023-12-11</time>&nbsp;<i class="fas fa-pencil-alt fa-fw" aria-hidden=true></i>&nbsp;约 1839 字&nbsp;
<i class="far fa-clock fa-fw" aria-hidden=true></i>&nbsp;预计阅读 4 分钟&nbsp;</div></div><div class="details toc" id=toc-static data-kept><div class="details-summary toc-title"><span>目录</span>
<span><i class="details-icon fas fa-angle-right" aria-hidden=true></i></span></div><div class="details-content toc-content" id=toc-content-static><nav id=TableOfContents><ul><li><a href=#h:036ce9a9-077e-48de-bb55-5234be6c2087><span class=section-num>1</span> HTAP 架构原理</a></li><li><a href=#h:5fb147d2-245c-4846-a70f-120912f6df84><span class=section-num>2</span> 分布式优化器</a></li><li><a href=#h:bd455b10-a8d7-45a2-a36b-ce3ffa9fb862><span class=section-num>3</span> 算子并行化</a></li><li><a href=#h:9800261a-d0c9-4291-b68d-70585cab4086><span class=section-num>4</span> 消除数据倾斜问题</a></li><li><a href=#h:ce8787fe-c246-42e2-90b2-f7f85da2ec59><span class=section-num>5</span> SQL 级别弹性扩展</a></li><li><a href=#h:00c5781c-9f42-42bf-b6d3-5cd0f06d7274><span class=section-num>6</span> 事务一致性</a></li><li><a href=#h:50f1201d-8be4-44f6-a94a-813611fe0e09><span class=section-num>7</span> TPC-H 性能：加速比</a></li><li><a href=#h:f71c9216-f9a9-439c-ba38-301fa36ce12e><span class=section-num>8</span> TPC-H 性能：和传统 MPP 数仓对比</a></li><li><a href=#h:a08fa54c-934e-4eef-b8af-7270e0256978><span class=section-num>9</span> 分布式执行加速索引创建</a></li><li><a href=#h:417292af-a08f-42fe-87f1-b61f525ca2e3><span class=section-num>10</span> 分布式并行执行加速多模：时空数据库</a></li></ul></nav></div></div><div class=content id=content><div class="ox-hugo-toc toc has-section-numbers"><div class=heading>Table of Contents</div><ul><li><span class=section-num>1</span> <a href=#h:036ce9a9-077e-48de-bb55-5234be6c2087 rel>HTAP 架构原理</a></li><li><span class=section-num>2</span> <a href=#h:5fb147d2-245c-4846-a70f-120912f6df84 rel>分布式优化器</a></li><li><span class=section-num>3</span> <a href=#h:bd455b10-a8d7-45a2-a36b-ce3ffa9fb862 rel>算子并行化</a></li><li><span class=section-num>4</span> <a href=#h:9800261a-d0c9-4291-b68d-70585cab4086 rel>消除数据倾斜问题</a></li><li><span class=section-num>5</span> <a href=#h:ce8787fe-c246-42e2-90b2-f7f85da2ec59 rel>SQL 级别弹性扩展</a></li><li><span class=section-num>6</span> <a href=#h:00c5781c-9f42-42bf-b6d3-5cd0f06d7274 rel>事务一致性</a></li><li><span class=section-num>7</span> <a href=#h:50f1201d-8be4-44f6-a94a-813611fe0e09 rel>TPC-H 性能：加速比</a></li><li><span class=section-num>8</span> <a href=#h:f71c9216-f9a9-439c-ba38-301fa36ce12e rel>TPC-H 性能：和传统 MPP 数仓对比</a></li><li><span class=section-num>9</span> <a href=#h:a08fa54c-934e-4eef-b8af-7270e0256978 rel>分布式执行加速索引创建</a></li><li><span class=section-num>10</span> <a href=#h:417292af-a08f-42fe-87f1-b61f525ca2e3 rel>分布式并行执行加速多模：时空数据库</a></li></ul></div><p>本文为摘录(或转载)，侵删，原文为： <a href="https://help.aliyun.com/zh/polardb/polardb-for-postgresql/polardb-for-postgresql-architecture/?spm=a2c4g.11186623.0.0.2e3b5fb1p0L9je" target=_blank rel="noopener noreffer">https://help.aliyun.com/zh/polardb/polardb-for-postgresql/polardb-for-postgresql-architecture/?spm=a2c4g.11186623.0.0.2e3b5fb1p0L9je</a></p><p>PolarDB PostgreSQL 版读写分离后，由于底层是存储池，理论上 IO 吞吐是无限大的。而大查询只能在单个计算节点上执行，单个计算节点的 CPU/MEM/IO 是有限的，因此单个计算节点无法发挥出存储侧的大 IO 带宽的优势，也无法通过增加计算资源来加速大的查询。PolarDB PostgreSQL 版推出了基于 Shared-Storage 的 MPP 分布式并行执行，来加速在 OLTP 场景下 OLAP 查询。</p><h2 id=h:036ce9a9-077e-48de-bb55-5234be6c2087><span class=section-num>1</span> HTAP 架构原理</h2><p>PolarDB PostgreSQL 版底层存储在不同节点上是共享的，因此不能直接像传统 MPP 一样去扫描表。
PolarDB PostgreSQL 版在原来单机执行引擎上支持了 MPP 分布式并行执行，同时对 Shared-Storage 进行了优化。 基于 Shared-Storage 的 MPP 是业界首创。原理如下：</p><ul><li><p>Shuffle 算子屏蔽数据分布。</p></li><li><p>ParallelScan 算子屏蔽共享存储。</p></li></ul><figure><img src=/ox-hugo/p524517.png width=800px></figure><p>如图所示：</p><ul><li><p>表 A 和表 B 做 join，并做聚合。</p></li><li><p>共享存储中的表仍然是单张表，并没有做物理上的分区。</p></li><li><p>重新设计 4 类扫描算子，使之在扫描共享存储上的表时能够分片扫描，形成 virtual partition。</p></li></ul><h2 id=h:5fb147d2-245c-4846-a70f-120912f6df84><span class=section-num>2</span> 分布式优化器</h2><p>基于社区的 GPORCA 优化器扩展了能感知共享存储特性的 Transformation Rules。使得能够探索共享存储下特有的 Plan 空间。例如，对于一个表在 PolarDB PostgreSQL 版中既可以全量的扫描，也可以分区域扫描，这个是和传统 MPP 的本质区别。如下图所示，上面灰色部分是 PolarDB PostgreSQL 版内核与 GPORCA 优化器的适配部分。下半部分是 ORCA 内核，灰色模块是在 ORCA 内核中对共享存储特性所做的扩展。</p><figure><img src=/ox-hugo/p524524.png width=800px></figure><h2 id=h:bd455b10-a8d7-45a2-a36b-ce3ffa9fb862><span class=section-num>3</span> 算子并行化</h2><p>PolarDB PostgreSQL 版中有 4 类算子需要并行化，以下介绍一个具有代表性的 Seqscan 的算子的并行化。</p><p>为了最大限度的利用存储的大 IO 带宽，在顺序扫描时，按照 4 MB 为单位做逻辑切分，将 IO 尽量打散到不同的盘上，达到所有的盘同时提供读服务的效果。这样做还有一个优势，就是每个只读节点只扫描部分表文件，则最终能缓存的表大小是所有只读节点的 BufferPool 总和。</p><figure><img src=/ox-hugo/p524526.png width=800px></figure><p>下面的图表中：</p><ul><li><p>增加只读节点，扫描性能线性提升 30 倍。</p></li><li><p>打开 Buffer 时，扫描从 37 分钟降到 3.75 秒。</p></li></ul><figure><img src=/ox-hugo/p524527.png width=800px></figure><h2 id=h:9800261a-d0c9-4291-b68d-70585cab4086><span class=section-num>4</span> 消除数据倾斜问题</h2><p>倾斜是传统 MPP 固有的问题：</p><ul><li><p>在 PolarDB PostgreSQL 版中，大对象的是通过 heap 表关联 TOAST​表，无论对哪个表切分都无法达到均衡。</p></li><li><p>另外，不同只读节点的事务、Buffer、网络、IO 负载抖动。</p></li></ul><p>以上两点会导致分布执行时存在长尾进程。</p><figure><img src=/ox-hugo/p524528.png width=800px></figure><ul><li><p>协调节点内部分成 DataThread 和 ControlThread。</p></li><li><p>DataThread 负责收集汇总元组。</p></li><li><p>ControlThread 负责控制每个扫描算子的扫描进度。</p></li><li><p>扫描快的工作进程能多扫描逻辑的数据切片。</p></li><li><p>过程中需要考虑 Buffer 的亲和性。</p></li></ul><p><strong>说明</strong><br></p><p>尽管是动态分配，尽量维护 Buffer 的亲和性。另外，每个算子的上下文存储在 worker 的私有内存中，
Coordinator 不存储具体表的信息。</p><p>下面表格中，当出现大对象时，静态切分出现数据倾斜，而动态扫描仍然能够线性提升。</p><figure><img src=/ox-hugo/p524529.png width=800px></figure><h2 id=h:ce8787fe-c246-42e2-90b2-f7f85da2ec59><span class=section-num>5</span> SQL 级别弹性扩展</h2><p>利用数据共享的特点，还可以支持云原生下极致弹性的要求。将 Coordinator 全链路上各个模块所需要的外部依赖存在共享存储上，同时 worker 全链路上需要的运行时参数通过控制链路从
Coordinator 同步过来，使 Coordinator 和 worker 无状态化。</p><figure><img src=/ox-hugo/p524530.png width=800px></figure><p>因此：</p><ul><li><p>SQL 连接的任意只读节点都可以成为 Coordinator 节点，这解决了 Coordinator 单点问题。</p></li><li><p>支持不同的 SQL 使用不同的 CPU 数目执行，灵活的配置不同业务 SQL 配置不同的 CPU 核心数。</p></li></ul><figure><img src=/ox-hugo/p524531.png width=800px></figure><h2 id=h:00c5781c-9f42-42bf-b6d3-5cd0f06d7274><span class=section-num>6</span> 事务一致性</h2><p>多个计算节点数据一致性通过等待回放和 globalsnapshot 机制来完成。等待回放保证所有 worker 能看到所需要的数据版本，而 globalsnapshot 保证了选出一个统一的版本。</p><figure><img src=/ox-hugo/p524533.png width=800px></figure><h2 id=h:50f1201d-8be4-44f6-a94a-813611fe0e09><span class=section-num>7</span> TPC-H 性能：加速比</h2><figure><img src=/ox-hugo/p524534.png width=800px></figure><p>使用 1 TB 的 TPC-H 进行了测试，首先对比了 PolarDB PostgreSQL 版新的分布式并行和单机并行的性能，有 3 条 SQL 提速 60 倍，19 条 SQL 提速 10 倍以上。</p><figure><img src=/ox-hugo/p524535.png width=800px></figure><figure><img src=/ox-hugo/p524536.png width=800px></figure><p>此外，使用分布式执行引擎测试，增加 CPU 时的性能，可以看到，从 16 核和 128 核时性能线性提升。单看 22 条 SQL，通过增加 CPU，每条 SQL 性能线性提升。</p><h2 id=h:f71c9216-f9a9-439c-ba38-301fa36ce12e><span class=section-num>8</span> TPC-H 性能：和传统 MPP 数仓对比</h2><p>和传统 MPP 数仓对比，同样使用 16 个节点，PolarDB PostgreSQL 版的性能是传统 MPP 数仓的 90%。</p><figure><img src=/ox-hugo/p524538.png width=800px></figure><figure><img src=/ox-hugo/p524539.png width=800px></figure><p>前面讲到给 PolarDB PostgreSQL 版的分布式引擎做到了弹性扩展，数据不需要充分重分布，当
dop=8 时，性能是传统 MPP 数仓的 5.6 倍。</p><h2 id=h:a08fa54c-934e-4eef-b8af-7270e0256978><span class=section-num>9</span> 分布式执行加速索引创建</h2><p>OLTP 业务中会建大量的索引，经分析建索引过程中，80%是在排序和构建索引页，20%在写索引页。通过使用分布式并行来加速排序过程，同时流水化批量写入。</p><figure><img src=/ox-hugo/p524541.png width=800px></figure><p>上述优化能够使得创建索引有 4~5 倍的提升。</p><figure><img src=/ox-hugo/p524542.png width=800px></figure><h2 id=h:417292af-a08f-42fe-87f1-b61f525ca2e3><span class=section-num>10</span> 分布式并行执行加速多模：时空数据库</h2><p>PolarDB PostgreSQL 版是对多模数据库，支持时空数据。时空数据库是计算密集型和 IO 密集型，可以借助分布式执行来加速。PolarDB PostgreSQL 版针对共享存储退出了扫描共享 RTREE 索引的功能。</p><figure><img src=/ox-hugo/p524543.png width=800px></figure><ul><li><p>数据量：40000 万，500 GB。</p></li><li><p>规格：5个只读节点，每个节点规格为 16 核 CPU、128 GB 内存。</p></li><li><p>性能：</p><ul><li><p>随 CPU 数目线性提升。</p></li><li><p>80 核 CPU 时，提升 71 倍。</p></li></ul></li></ul><figure><img src=/ox-hugo/p524546.png width=800px></figure></div><div class=post-footer id=post-footer><div class=post-info><div class=post-info-line><div class=post-info-mod><span>更新于 2023-12-11</span></div></div><div class=post-info-line><div class=post-info-md></div><div class=post-info-share><span></span></div></div></div><div class=post-info-more><section class=post-tags></section><section><span><a href=javascript:void(0); onclick=window.history.back()>返回</a></span>&nbsp;|&nbsp;<span><a href=/>主页</a></span></section></div><div class=post-nav><a href=/2023/12/polardb-pg-%E5%AD%98%E5%82%A8%E8%AE%A1%E7%AE%97%E5%88%86%E7%A6%BB%E6%9E%B6%E6%9E%84%E8%AF%A6%E8%A7%A3/ class=prev rel=prev title="PolarDB PostgreSQL 版：存储计算分离架构详解"><i class="fas fa-angle-left fa-fw" aria-hidden=true></i>PolarDB PostgreSQL 版：存储计算分离架构详解</a>
<a href=/2023/12/polardb-for-postgresql%E6%9E%B6%E6%9E%84%E4%BB%8B%E7%BB%8D/ class=next rel=next title="PolarDB for PostgreSQL架构介绍">PolarDB for PostgreSQL架构介绍<i class="fas fa-angle-right fa-fw" aria-hidden=true></i></a></div></div></article></div></main><footer class=footer><div class=footer-container><div class=footer-line itemscope itemtype=http://schema.org/CreativeWork>&nbsp;|&nbsp;<span class=license><a rel="license external nofollow noopener noreffer" href=https://creativecommons.org/licenses/by-nc/4.0/ target=_blank>CC BY-NC 4.0</a></span></div></div></footer></div><div id=fixed-buttons><a href=# id=back-to-top class=fixed-button title=回到顶部><i class="fas fa-arrow-up fa-fw" aria-hidden=true></i>
</a><a href=# id=view-comments class=fixed-button title=查看评论><i class="fas fa-comment fa-fw" aria-hidden=true></i></a></div><script type=text/javascript src=https://cdn.jsdelivr.net/npm/lazysizes@5.3.2/lazysizes.min.js></script><script type=text/javascript src=https://cdn.jsdelivr.net/npm/clipboard@2.0.11/dist/clipboard.min.js></script><script type=text/javascript>window.config={code:{copyTitle:"复制到剪贴板",maxShownLines:50},comment:{}}</script><script type=text/javascript src=/js/theme.min.js></script></body></html>