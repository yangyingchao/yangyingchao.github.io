<!doctype html><html lang=zh-CH><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta name=robots content="noodp"><title>Time to Better Know The Time in PostgreSQL - 杂货铺</title><meta name=Description content="杂七杂八的，随手记录。"><meta property="og:url" content="https://yangyingchao.github.io/2025/11/time-to-better-know-the-time-in-postgresql/"><meta property="og:site_name" content="杂货铺"><meta property="og:title" content="Time to Better Know The Time in PostgreSQL"><meta property="og:description" content="Table of Contents 1 Simple things 2 PostgreSQL timestamp vs timestamptz 3 AT TIME ZONE 3.1 当应用于 timestamp（无时区时间戳）时 3.2 当应用于 timestamptz （带时区时间戳）时 3.3 实际用法 3.4 常见错误 4 Timestamps and the storage 5 Getting the current time 获取当前时间 5.1 CURRENT_TIMESTAMP vs NOW() 5.2 Transaction Behavior 5.3 Alternative Time Functions 5.4 总结 6 Intervals 7 Time ranges 8 Time to wrap up 本文为摘录(或转载)，侵删，原文为： https://boringsql.com/posts/know-the-time-in-postgresql/"><meta property="og:locale" content="zh_CH"><meta property="og:type" content="article"><meta property="article:section" content="posts"><meta property="article:published_time" content="2025-11-03T00:00:00+00:00"><meta property="article:modified_time" content="2025-11-03T00:00:00+00:00"><meta property="article:tag" content="Pg"><meta property="article:tag" content="Time"><meta property="article:tag" content="Date"><meta property="og:image" content="https://yangyingchao.github.io/logo.png"><meta name=twitter:card content="summary_large_image"><meta name=twitter:image content="https://yangyingchao.github.io/logo.png"><meta name=twitter:title content="Time to Better Know The Time in PostgreSQL"><meta name=twitter:description content="Table of Contents 1 Simple things 2 PostgreSQL timestamp vs timestamptz 3 AT TIME ZONE 3.1 当应用于 timestamp（无时区时间戳）时 3.2 当应用于 timestamptz （带时区时间戳）时 3.3 实际用法 3.4 常见错误 4 Timestamps and the storage 5 Getting the current time 获取当前时间 5.1 CURRENT_TIMESTAMP vs NOW() 5.2 Transaction Behavior 5.3 Alternative Time Functions 5.4 总结 6 Intervals 7 Time ranges 8 Time to wrap up 本文为摘录(或转载)，侵删，原文为： https://boringsql.com/posts/know-the-time-in-postgresql/"><meta name=application-name content="杂货铺"><meta name=apple-mobile-web-app-title content="杂货铺"><meta name=theme-color content="#ffffff"><meta name=msapplication-TileColor content="#da532c"><link rel="shortcut icon" type=image/x-icon href=/favicon.ico><link rel=icon type=image/png sizes=32x32 href=/favicon-32x32.png><link rel=icon type=image/png sizes=16x16 href=/favicon-16x16.png><link rel=apple-touch-icon sizes=180x180 href=/apple-touch-icon.png><link rel=mask-icon href=/safari-pinned-tab.svg color=#5bbad5><link rel=manifest href=/site.webmanifest><link rel=canonical href=https://yangyingchao.github.io/2025/11/time-to-better-know-the-time-in-postgresql/><link rel=prev href=https://yangyingchao.github.io/2025/11/%E5%8D%81%E6%9C%88%E9%98%85%E8%AF%BB%E6%80%BB%E7%BB%93/><link rel=next href=https://yangyingchao.github.io/2025/11/postgresql-and-numa/><link rel=stylesheet href=/css/style.min.css><link rel=preload href=https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6.1.1/css/all.min.css as=style onload='this.onload=null,this.rel="stylesheet"'><noscript><link rel=stylesheet href=https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6.1.1/css/all.min.css></noscript><link rel=preload href=https://cdn.jsdelivr.net/npm/animate.css@4.1.1/animate.min.css as=style onload='this.onload=null,this.rel="stylesheet"'><noscript><link rel=stylesheet href=https://cdn.jsdelivr.net/npm/animate.css@4.1.1/animate.min.css></noscript><script type=application/ld+json>{"@context":"http://schema.org","@type":"BlogPosting","headline":"Time to Better Know The Time in PostgreSQL","inLanguage":"zh-CH","mainEntityOfPage":{"@type":"WebPage","@id":"https:\/\/yangyingchao.github.io\/2025\/11\/time-to-better-know-the-time-in-postgresql\/"},"image":["https:\/\/yangyingchao.github.io\/images\/Apple-Devices-Preview.png"],"genre":"posts","keywords":"pg, time, date","wordcount":5447,"url":"https:\/\/yangyingchao.github.io\/2025\/11\/time-to-better-know-the-time-in-postgresql\/","datePublished":"2025-11-03T00:00:00+00:00","dateModified":"2025-11-03T00:00:00+00:00","publisher":{"@type":"Organization","name":"xxxx","logo":{"@type":"ImageObject","url":"https:\/\/yangyingchao.github.io\/images\/avatar.jpg","width":160,"height":160}},"author":{"@type":"Person","name":"yc"},"description":""}</script></head><body data-header-desktop=fixed data-header-mobile=auto><script type=text/javascript>(window.localStorage&&localStorage.getItem("theme")?localStorage.getItem("theme")==="dark":"auto"==="auto"?window.matchMedia("(prefers-color-scheme: dark)").matches:"auto"==="dark")&&document.body.setAttribute("theme","dark")</script><div id=mask></div><div class=wrapper><header class=desktop id=header-desktop><div class=header-wrapper><div class=header-title><a href=/ title=杂货铺><span class=header-title-pre><i class='fa-solid fa-house-chimney'></i></span>老杨的杂货铺</a></div><div class=menu><div class=menu-inner><a class=menu-item href=/posts/>所有文章 </a><a class=menu-item href=/tags/>标签 </a><a class=menu-item href=https://github.com/yangyingchao title=GitHub rel="noopener noreffer" target=_blank><i class='fab fa-github fa-fw' aria-hidden=true></i> </a><span class="menu-item delimiter"></span><span class="menu-item search" id=search-desktop>
<input type=text placeholder=搜索文章标题或内容... id=search-input-desktop>
<a href=javascript:void(0); class="search-button search-toggle" id=search-toggle-desktop title=搜索><i class="fas fa-search fa-fw" aria-hidden=true></i>
</a><a href=javascript:void(0); class="search-button search-clear" id=search-clear-desktop title=清空><i class="fas fa-times-circle fa-fw" aria-hidden=true></i>
</a><span class="search-button search-loading" id=search-loading-desktop><i class="fas fa-spinner fa-fw fa-spin" aria-hidden=true></i>
</span></span><a href=javascript:void(0); class="menu-item theme-switch" title=切换主题><i class="fas fa-adjust fa-fw" aria-hidden=true></i></a></div></div></div></header><header class=mobile id=header-mobile><div class=header-container><div class=header-wrapper><div class=header-title><a href=/ title=杂货铺><span class=header-title-pre><i class='fa-solid fa-house-chimney'></i></span>老杨的杂货铺</a></div><div class=menu-toggle id=menu-toggle-mobile><span></span><span></span><span></span></div></div><div class=menu id=menu-mobile><div class=search-wrapper><div class="search mobile" id=search-mobile><input type=text placeholder=搜索文章标题或内容... id=search-input-mobile>
<a href=javascript:void(0); class="search-button search-toggle" id=search-toggle-mobile title=搜索><i class="fas fa-search fa-fw" aria-hidden=true></i>
</a><a href=javascript:void(0); class="search-button search-clear" id=search-clear-mobile title=清空><i class="fas fa-times-circle fa-fw" aria-hidden=true></i>
</a><span class="search-button search-loading" id=search-loading-mobile><i class="fas fa-spinner fa-fw fa-spin" aria-hidden=true></i></span></div><a href=javascript:void(0); class=search-cancel id=search-cancel-mobile>取消</a></div><a class=menu-item href=/posts/ title>所有文章</a><a class=menu-item href=/tags/ title>标签</a><a class=menu-item href=https://github.com/yangyingchao title=GitHub rel="noopener noreffer" target=_blank><i class='fab fa-github fa-fw' aria-hidden=true></i> </a><a href=javascript:void(0); class="menu-item theme-switch" title=切换主题><i class="fas fa-adjust fa-fw" aria-hidden=true></i></a></div></div></header><div class="search-dropdown desktop"><div id=search-dropdown-desktop></div></div><div class="search-dropdown mobile"><div id=search-dropdown-mobile></div></div><main class=main><div class=container><div class=toc id=toc-auto><h2 class=toc-title>目录</h2><div class=toc-content id=toc-content-auto></div></div><article class="page single"><h1 class="single-title animate__animated animate__flipInX">Time to Better Know The Time in PostgreSQL</h1><div class=post-meta><div class=post-meta-line><span class=post-author><a href=/ title=Author rel=author class=author><i class="fas fa-user-circle fa-fw" aria-hidden=true></i>yc</a></span></div><div class=post-meta-line><i class="far fa-calendar-alt fa-fw" aria-hidden=true></i>&nbsp;<time datetime=2025-11-03>2025-11-03</time>&nbsp;<i class="fas fa-pencil-alt fa-fw" aria-hidden=true></i>&nbsp;约 5447 字&nbsp;
<i class="far fa-clock fa-fw" aria-hidden=true></i>&nbsp;预计阅读 11 分钟&nbsp;</div></div><div class="details toc" id=toc-static data-kept><div class="details-summary toc-title"><span>目录</span>
<span><i class="details-icon fas fa-angle-right" aria-hidden=true></i></span></div><div class="details-content toc-content" id=toc-content-static><nav id=TableOfContents><ul><li><a href=#simple-things><span class=section-num>1</span> Simple things</a></li><li><a href=#postgresql-timestamp-vs-timestamptz><span class=section-num>2</span> PostgreSQL <code>timestamp</code> vs <code>timestamptz</code></a></li><li><a href=#at-time-zone><span class=section-num>3</span> AT TIME ZONE</a><ul><li><a href=#当应用于-timestamp-无时区时间戳-时><span class=section-num>3.1</span> 当应用于 timestamp（无时区时间戳）时</a></li><li><a href=#当应用于-timestamptz-带时区时间戳-时><span class=section-num>3.2</span> 当应用于 <code>timestamptz</code> （带时区时间戳）时</a></li><li><a href=#实际用法><span class=section-num>3.3</span> 实际用法</a></li><li><a href=#常见错误><span class=section-num>3.4</span> 常见错误</a></li></ul></li><li><a href=#timestamps-and-the-storage><span class=section-num>4</span> Timestamps and the storage</a></li><li><a href=#getting-the-current-time-获取当前时间><span class=section-num>5</span> Getting the current time 获取当前时间</a><ul><li><a href=#current-timestamp-vs-now><span class=section-num>5.1</span> <code>CURRENT_TIMESTAMP</code> vs <code>NOW()</code></a></li><li><a href=#transaction-behavior><span class=section-num>5.2</span> Transaction Behavior</a></li><li><a href=#alternative-time-functions><span class=section-num>5.3</span> Alternative Time Functions</a></li><li><a href=#总结><span class=section-num>5.4</span> 总结</a></li></ul></li><li><a href=#intervals><span class=section-num>6</span> Intervals</a></li><li><a href=#time-ranges><span class=section-num>7</span> Time ranges</a></li><li><a href=#time-to-wrap-up><span class=section-num>8</span> Time to wrap up</a></li></ul></nav></div></div><div class=content id=content><div class="ox-hugo-toc toc has-section-numbers"><div class=heading>Table of Contents</div><ul><li><span class=section-num>1</span> <a href=#simple-things rel>Simple things</a></li><li><span class=section-num>2</span> <a href=#postgresql-timestamp-vs-timestamptz rel>PostgreSQL <code>timestamp</code> vs <code>timestamptz</code></a></li><li><span class=section-num>3</span> <a href=#at-time-zone rel>AT TIME ZONE</a><ul><li><span class=section-num>3.1</span> <a href=#%e5%bd%93%e5%ba%94%e7%94%a8%e4%ba%8e-timestamp-%e6%97%a0%e6%97%b6%e5%8c%ba%e6%97%b6%e9%97%b4%e6%88%b3-%e6%97%b6 rel>当应用于 timestamp（无时区时间戳）时</a></li><li><span class=section-num>3.2</span> <a href=#%e5%bd%93%e5%ba%94%e7%94%a8%e4%ba%8e-timestamptz-%e5%b8%a6%e6%97%b6%e5%8c%ba%e6%97%b6%e9%97%b4%e6%88%b3-%e6%97%b6 rel>当应用于 <code>timestamptz</code> （带时区时间戳）时</a></li><li><span class=section-num>3.3</span> <a href=#%e5%ae%9e%e9%99%85%e7%94%a8%e6%b3%95 rel>实际用法</a></li><li><span class=section-num>3.4</span> <a href=#%e5%b8%b8%e8%a7%81%e9%94%99%e8%af%af rel>常见错误</a></li></ul></li><li><span class=section-num>4</span> <a href=#timestamps-and-the-storage rel>Timestamps and the storage</a></li><li><span class=section-num>5</span> <a href=#getting-the-current-time-%e8%8e%b7%e5%8f%96%e5%bd%93%e5%89%8d%e6%97%b6%e9%97%b4 rel>Getting the current time 获取当前时间</a><ul><li><span class=section-num>5.1</span> <a href=#current-timestamp-vs-now rel><code>CURRENT_TIMESTAMP</code> vs <code>NOW()</code></a></li><li><span class=section-num>5.2</span> <a href=#transaction-behavior rel>Transaction Behavior</a></li><li><span class=section-num>5.3</span> <a href=#alternative-time-functions rel>Alternative Time Functions</a></li><li><span class=section-num>5.4</span> <a href=#%e6%80%bb%e7%bb%93 rel>总结</a></li></ul></li><li><span class=section-num>6</span> <a href=#intervals rel>Intervals</a></li><li><span class=section-num>7</span> <a href=#time-ranges rel>Time ranges</a></li><li><span class=section-num>8</span> <a href=#time-to-wrap-up rel>Time to wrap up</a></li></ul></div><p>本文为摘录(或转载)，侵删，原文为： <a href=https://boringsql.com/posts/know-the-time-in-postgresql/ target=_blank rel="noopener noreffer">https://boringsql.com/posts/know-the-time-in-postgresql/</a></p><h2 id=simple-things><span class=section-num>1</span> Simple things</h2><p>我们可以从简单的陈述开始，比如说:</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-sql data-lang=sql><span class=line><span class=cl><span class=k>SELECT</span><span class=w> </span><span class=s1>&#39;2025-03-30 00:30&#39;</span><span class=w> </span><span class=k>as</span><span class=w> </span><span class=n>t</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=k>Result</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>       </span><span class=n>t</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=c1>------------------
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=mi>2025</span><span class=o>-</span><span class=mi>03</span><span class=o>-</span><span class=mi>30</span><span class=w> </span><span class=mi>00</span><span class=p>:</span><span class=mi>30</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><p>这会给你（我希望这不是一个大惊喜）一个简单的文本字面量 (text literal)，而不是与日期和时间有关的内容。一旦你在类似于以下的查询中使用这个字符串字面量:</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-sql data-lang=sql><span class=line><span class=cl><span class=k>SELECT</span><span class=w> </span><span class=o>*</span><span class=w> </span><span class=k>FROM</span><span class=w> </span><span class=n>events</span><span class=w> </span><span class=k>WHERE</span><span class=w> </span><span class=n>start_at</span><span class=w> </span><span class=o>&gt;</span><span class=w> </span><span class=s1>&#39;2025-03-30 00:30&#39;</span><span class=p>;</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><p>PostgreSQL 会隐式地将字符串转换为没有时区的时间戳。之所以能够发生这种情况，是因为 <code>start_at</code>
很可能是基于时间戳的字段，允许自动转换以匹配列的数据类型。这不同于查询:</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-sql data-lang=sql><span class=line><span class=cl><span class=k>SELECT</span><span class=w> </span><span class=s1>&#39;2025-03-30 01:00&#39;</span><span class=w> </span><span class=o>-</span><span class=w> </span><span class=nb>interval</span><span class=w> </span><span class=s1>&#39;15 minutes&#39;</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=k>Result</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>ERROR</span><span class=p>:</span><span class=w>  </span><span class=n>invalid</span><span class=w> </span><span class=k>input</span><span class=w> </span><span class=n>syntax</span><span class=w> </span><span class=k>for</span><span class=w> </span><span class=k>type</span><span class=w> </span><span class=nb>interval</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;2025-03-30 01:00&#34;</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><p>这将简单地无法工作，因为 PostgreSQL 无法执行自动转换（对此稍后我们会涉及，这可能是意外的行为，但事情就是这样）。让这个示例查询正常工作的正确方法是使用以下两种方式之一（功能上等效，但表示法不同）。</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-sql data-lang=sql><span class=line><span class=cl><span class=c1>-- PostgreSQL cast notation
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=k>SELECT</span><span class=w> </span><span class=s1>&#39;2025-03-30 01:00&#39;</span><span class=p>::</span><span class=k>timestamp</span><span class=w> </span><span class=o>-</span><span class=w> </span><span class=nb>interval</span><span class=w> </span><span class=s1>&#39;15 minutes&#39;</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=c1>-- SQL standard explicit type notation
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=k>SELECT</span><span class=w> </span><span class=k>timestamp</span><span class=w> </span><span class=s1>&#39;2025-03-03 01:00&#39;</span><span class=w> </span><span class=o>-</span><span class=w> </span><span class=nb>interval</span><span class=w> </span><span class=s1>&#39;15 minutes&#39;</span><span class=p>;</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><h2 id=postgresql-timestamp-vs-timestamptz><span class=section-num>2</span> PostgreSQL <code>timestamp</code> vs <code>timestamptz</code></h2><p>在 PostgreSQL 中处理时间时，下一个可能导致混淆的来源是存在两种不同的数据类型：</p><ul><li><code>timestamp</code> （或 timestamp without time zone 无时区时间戳）</li><li><code>timestamptz</code> （或 timestamp with time zone 带时区时间戳 ）<br>尽管名称暗示了不同，但关键区别不在于它们是否存储时区信息，而在于它们在存储和检索过程中如何处理这些信息。</li></ul><p><strong>重要提示：</strong> 在我们讨论细节之前，请记住始终使用 timestamptz。正如官方“不这样做”页面所示，使用 timestamp
就像是在存储时钟的图片，而不是某个时间点的快照。尽管这篇文章可能会使用 timestamp，但完全是出于演示目的。</p><p>您需要记住的所有事项是，timestamp 存储的是输入的确切日期时间值，没有任何时区上下文或调整。它本质上是日历日期和墙壁时钟时间的快照，与任何特定地理位置无关。</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span><span class=lnt>7
</span><span class=lnt>8
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-sql data-lang=sql><span class=line><span class=cl><span class=c1>-- this stores what you provided
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=k>SELECT</span><span class=w> </span><span class=s1>&#39;2025-03-30 01:30&#39;</span><span class=p>::</span><span class=k>timestamp</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=k>Result</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=k>timestamp</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=c1>---------------------
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=mi>2025</span><span class=o>-</span><span class=mi>03</span><span class=o>-</span><span class=mi>30</span><span class=w> </span><span class=mi>01</span><span class=p>:</span><span class=mi>30</span><span class=p>:</span><span class=mi>00</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><p>另一方面，timestamptz 会将所有输入在内部标准化为 UTC，然后将值转换为会话的时区以进行显示。这为您的日期时间值提供了地理上下文。</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span><span class=lnt>7
</span><span class=lnt>8
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-sql data-lang=sql><span class=line><span class=cl><span class=c1>-- this converts your input to UTC based on your session timezone
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=k>SELECT</span><span class=w> </span><span class=s1>&#39;2025-03-30 01:30&#39;</span><span class=p>::</span><span class=n>timestamptz</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=k>Result</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=n>timestamptz</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=c1>-----------------------
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=mi>2025</span><span class=o>-</span><span class=mi>03</span><span class=o>-</span><span class=mi>30</span><span class=w> </span><span class=mi>01</span><span class=p>:</span><span class=mi>30</span><span class=p>:</span><span class=mi>00</span><span class=o>+</span><span class=mi>01</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><p>而这就是潜在混淆可能开始的地方。让我们看一个例子：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-sql data-lang=sql><span class=line><span class=cl><span class=c1>-- With UTC timezone
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=k>SET</span><span class=w> </span><span class=n>timezone</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=s1>&#39;UTC&#39;</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=k>SELECT</span><span class=w> </span><span class=s1>&#39;2025-03-30 01:30&#39;</span><span class=p>::</span><span class=n>timestamptz</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=k>Result</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=n>timestamptz</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=c1>-----------------------
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=w> </span><span class=mi>2025</span><span class=o>-</span><span class=mi>03</span><span class=o>-</span><span class=mi>30</span><span class=w> </span><span class=mi>01</span><span class=p>:</span><span class=mi>30</span><span class=p>:</span><span class=mi>00</span><span class=o>+</span><span class=mi>00</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=c1>-- With Tokyo timezone
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=k>SET</span><span class=w> </span><span class=n>timezone</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=s1>&#39;Asia/Tokyo&#39;</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=k>SELECT</span><span class=w> </span><span class=s1>&#39;2025-03-30 01:30&#39;</span><span class=p>::</span><span class=n>timestamptz</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=k>Result</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=n>timestamptz</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=c1>-----------------------
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=w> </span><span class=mi>2025</span><span class=o>-</span><span class=mi>03</span><span class=o>-</span><span class=mi>30</span><span class=w> </span><span class=mi>01</span><span class=p>:</span><span class=mi>30</span><span class=p>:</span><span class=mi>00</span><span class=o>+</span><span class=mi>09</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><p>这会根据会话时区为您提供正确的表示。这在我们添加实际存储时非常有用。</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-sql data-lang=sql><span class=line><span class=cl><span class=c1>-- Create table and view with Berlin timezone
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=k>SET</span><span class=w> </span><span class=n>timezone</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=s1>&#39;Europe/Berlin&#39;</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=k>CREATE</span><span class=w> </span><span class=k>TABLE</span><span class=w> </span><span class=n>time_flies</span><span class=p>(</span><span class=n>moment</span><span class=w> </span><span class=k>timestamp</span><span class=w> </span><span class=k>with</span><span class=w> </span><span class=n>time</span><span class=w> </span><span class=k>zone</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=k>INSERT</span><span class=w> </span><span class=k>INTO</span><span class=w> </span><span class=n>time_flies</span><span class=w> </span><span class=k>VALUES</span><span class=w> </span><span class=p>(</span><span class=s1>&#39;2025-03-30 00:30&#39;</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=k>SELECT</span><span class=w> </span><span class=n>moment</span><span class=w> </span><span class=k>FROM</span><span class=w> </span><span class=n>time_flies</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=k>Result</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>         </span><span class=n>moment</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=c1>------------------------
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=w> </span><span class=mi>2025</span><span class=o>-</span><span class=mi>03</span><span class=o>-</span><span class=mi>30</span><span class=w> </span><span class=mi>00</span><span class=p>:</span><span class=mi>30</span><span class=p>:</span><span class=mi>00</span><span class=o>+</span><span class=mi>01</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=c1>-- View the same data with New York timezone
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=k>SET</span><span class=w> </span><span class=n>timezone</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=s1>&#39;America/New_York&#39;</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=k>SELECT</span><span class=w> </span><span class=n>moment</span><span class=w> </span><span class=k>FROM</span><span class=w> </span><span class=n>time_flies</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=k>Result</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>         </span><span class=n>moment</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=c1>------------------------
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=w> </span><span class=mi>2025</span><span class=o>-</span><span class=mi>03</span><span class=o>-</span><span class=mi>29</span><span class=w> </span><span class=mi>19</span><span class=p>:</span><span class=mi>30</span><span class=p>:</span><span class=mi>00</span><span class=o>-</span><span class=mi>04</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><p>这演示了使用自动时区转换的优势，使您不仅能够避免时区错误，还能避免与夏令时相关的问题。当我们大多数人在本地夏令时更改期间酣然入睡时，错误地计算时差可就不是一件有趣的事情了。使用 <code>timestamptz</code>
是避免这种情况的确保方法。让我们以最近（在撰写本文时）发生的夏令时变化为例。</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-sql data-lang=sql><span class=line><span class=cl><span class=c1>-- Set Berlin timezone (during DST change)
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=k>SET</span><span class=w> </span><span class=n>timezone</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=s1>&#39;Europe/Berlin&#39;</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=c1>-- Using timestamp (without timezone awareness)
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=k>SELECT</span><span class=w> </span><span class=s1>&#39;2025-03-30 01:30&#39;</span><span class=p>::</span><span class=k>timestamp</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=nb>interval</span><span class=w> </span><span class=s1>&#39;45 minutes&#39;</span><span class=w> </span><span class=k>as</span><span class=w> </span><span class=n>end_time</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=k>Result</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=n>end_time</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=c1>---------------------
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=w> </span><span class=mi>2025</span><span class=o>-</span><span class=mi>03</span><span class=o>-</span><span class=mi>30</span><span class=w> </span><span class=mi>02</span><span class=p>:</span><span class=mi>15</span><span class=p>:</span><span class=mi>00</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=c1>-- Using timestamptz (with timezone awareness)
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=k>SELECT</span><span class=w> </span><span class=s1>&#39;2025-03-30 01:30&#39;</span><span class=p>::</span><span class=n>timestamptz</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=nb>interval</span><span class=w> </span><span class=s1>&#39;45 minutes&#39;</span><span class=w> </span><span class=k>as</span><span class=w> </span><span class=n>end_time</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=k>Result</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>end_time</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=c1>------------------------
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=w> </span><span class=mi>2025</span><span class=o>-</span><span class=mi>03</span><span class=o>-</span><span class=mi>30</span><span class=w> </span><span class=mi>03</span><span class=p>:</span><span class=mi>15</span><span class=p>:</span><span class=mi>00</span><span class=o>+</span><span class=mi>02</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><h2 id=at-time-zone><span class=section-num>3</span> AT TIME ZONE</h2><p>PostgreSQL 中另一个强大但可能令人困惑的操作符是 <code>AT TIME ZONE</code> ，它允许您在不同的时区之间转换时间戳，但其行为根据输入数据类型的不同而有所变化。</p><h3 id=当应用于-timestamp-无时区时间戳-时><span class=section-num>3.1</span> 当应用于 timestamp（无时区时间戳）时</h3><p>当您将 AT TIME ZONE 应用于一个时间戳时，PostgreSQL 将输入解释为位于指定的时区，并将其转换为 <code>timestamptz</code>:</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span><span class=lnt>7
</span><span class=lnt>8
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-sql data-lang=sql><span class=line><span class=cl><span class=c1>-- First, set UTC timezone
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=k>SET</span><span class=w> </span><span class=n>timezone</span><span class=o>=</span><span class=s1>&#39;UTC&#39;</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=c1>-- Interpret &#39;2025-03-30 01:30&#39; as if it were in the &#39;Europe/Paris&#39; time zone
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=k>SELECT</span><span class=w> </span><span class=s1>&#39;2025-03-30 01:30&#39;</span><span class=p>::</span><span class=k>timestamp</span><span class=w> </span><span class=k>AT</span><span class=w> </span><span class=n>TIME</span><span class=w> </span><span class=k>ZONE</span><span class=w> </span><span class=s1>&#39;Europe/Paris&#39;</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=k>Result</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>timezone</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=c1>------------------------
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=w> </span><span class=mi>2025</span><span class=o>-</span><span class=mi>03</span><span class=o>-</span><span class=mi>30</span><span class=w> </span><span class=mi>00</span><span class=p>:</span><span class=mi>30</span><span class=p>:</span><span class=mi>00</span><span class=o>+</span><span class=mi>00</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><p>它的作用实际上是“取这个墙壁时间，将其视为在指定时区，然后给我这个时刻对应的时间（作为 <code>timestamptz</code> ）”。这里的表示基于会话时区设置。</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span><span class=lnt>7
</span><span class=lnt>8
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-sql data-lang=sql><span class=line><span class=cl><span class=c1>-- Set timezone
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=k>SET</span><span class=w> </span><span class=n>timezone</span><span class=o>=</span><span class=s1>&#39;America/Port_of_Spain&#39;</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=c1>-- Convert the timestamptz to how it would appear on wall clocks in Tokyo
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=k>SELECT</span><span class=w> </span><span class=s1>&#39;2025-03-30 01:30+01:00&#39;</span><span class=p>::</span><span class=n>timestamptz</span><span class=w> </span><span class=k>AT</span><span class=w> </span><span class=n>TIME</span><span class=w> </span><span class=k>ZONE</span><span class=w> </span><span class=s1>&#39;Asia/Tokyo&#39;</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=k>Result</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>timezone</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=c1>---------------------
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=w> </span><span class=mi>2025</span><span class=o>-</span><span class=mi>03</span><span class=o>-</span><span class=mi>30</span><span class=w> </span><span class=mi>09</span><span class=p>:</span><span class=mi>30</span><span class=p>:</span><span class=mi>00</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><h3 id=当应用于-timestamptz-带时区时间戳-时><span class=section-num>3.2</span> 当应用于 <code>timestamptz</code> （带时区时间戳）时</h3><p>当您将 AT TIME ZONE 应用于一个 timestamptz 时，PostgreSQL 会将时间戳转换为指定的时区，并返回一个无时区时间戳：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span><span class=lnt>7
</span><span class=lnt>8
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-sql data-lang=sql><span class=line><span class=cl><span class=c1>-- Set timezone
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=k>SET</span><span class=w> </span><span class=n>timezone</span><span class=o>=</span><span class=s1>&#39;America/Port_of_Spain&#39;</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=c1>-- Convert the timestamptz to how it would appear on wall clocks in Tokyo
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=k>SELECT</span><span class=w> </span><span class=s1>&#39;2025-03-30 01:30+01:00&#39;</span><span class=p>::</span><span class=n>timestamptz</span><span class=w> </span><span class=k>AT</span><span class=w> </span><span class=n>TIME</span><span class=w> </span><span class=k>ZONE</span><span class=w> </span><span class=s1>&#39;Asia/Tokyo&#39;</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=k>Result</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>timezone</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=c1>---------------------
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=w> </span><span class=mi>2025</span><span class=o>-</span><span class=mi>03</span><span class=o>-</span><span class=mi>30</span><span class=w> </span><span class=mi>09</span><span class=p>:</span><span class=mi>30</span><span class=p>:</span><span class=mi>00</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><p>这个操作的意思是：“取这个时刻，告诉我在指定时区会是什么墙壁时间。”</p><h3 id=实际用法><span class=section-num>3.3</span> 实际用法</h3><p>正确使用时间戳的唯一用途可能是为多个时区提供“墙壁时间”表示，以便进行（视图）表示目的。</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-sql data-lang=sql><span class=line><span class=cl><span class=c1>-- 公司范围会议在各办公室的时间是什么？
</span></span></span><span class=line><span class=cl><span class=c1>-- What time is the company-wide meeting in various offices?
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=k>SELECT</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=s1>&#39;2025-03-30 15:00&#39;</span><span class=p>::</span><span class=n>timestamptz</span><span class=w> </span><span class=k>AS</span><span class=w> </span><span class=n>meeting_time_utc</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=s1>&#39;2025-03-30 15:00&#39;</span><span class=p>::</span><span class=n>timestamptz</span><span class=w> </span><span class=k>AT</span><span class=w> </span><span class=n>TIME</span><span class=w> </span><span class=k>ZONE</span><span class=w> </span><span class=s1>&#39;Europe/London&#39;</span><span class=w> </span><span class=k>AS</span><span class=w> </span><span class=n>london_office_time</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=s1>&#39;2025-03-30 15:00&#39;</span><span class=p>::</span><span class=n>timestamptz</span><span class=w> </span><span class=k>AT</span><span class=w> </span><span class=n>TIME</span><span class=w> </span><span class=k>ZONE</span><span class=w> </span><span class=s1>&#39;Asia/Tokyo&#39;</span><span class=w> </span><span class=k>AS</span><span class=w> </span><span class=n>tokyo_office_time</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=k>Result</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>meeting_time_utc</span><span class=w>    </span><span class=o>|</span><span class=w> </span><span class=n>london_office_time</span><span class=w>  </span><span class=o>|</span><span class=w>  </span><span class=n>tokyo_office_time</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=c1>------------------------+---------------------+---------------------
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=w> </span><span class=mi>2025</span><span class=o>-</span><span class=mi>03</span><span class=o>-</span><span class=mi>30</span><span class=w> </span><span class=mi>15</span><span class=p>:</span><span class=mi>00</span><span class=p>:</span><span class=mi>00</span><span class=o>+</span><span class=mi>02</span><span class=w> </span><span class=o>|</span><span class=w> </span><span class=mi>2025</span><span class=o>-</span><span class=mi>03</span><span class=o>-</span><span class=mi>30</span><span class=w> </span><span class=mi>14</span><span class=p>:</span><span class=mi>00</span><span class=p>:</span><span class=mi>00</span><span class=w> </span><span class=o>|</span><span class=w> </span><span class=mi>2025</span><span class=o>-</span><span class=mi>03</span><span class=o>-</span><span class=mi>30</span><span class=w> </span><span class=mi>22</span><span class=p>:</span><span class=mi>00</span><span class=p>:</span><span class=mi>00</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><p>重要的是要注意，在基于 API 的客户端中，最好始终表示完整的时间表示法，并将表示层留给客户端。类似于此，除非您需要处理多个时区，并且依赖于正确的本地时间表示，否则最好使用本地会话时区设置，而不是使用 AT TIME ZONE
操作符。这适用于时间的输入和输出。</p><h3 id=常见错误><span class=section-num>3.4</span> 常见错误</h3><p>让我们考虑一个示例，您可能会考虑使用 AT TIME ZONE“神奇地转换”已经存储的时间。</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-sql data-lang=sql><span class=line><span class=cl><span class=c1>-- 设置示例
</span></span></span><span class=line><span class=cl><span class=c1>-- Setup example
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=k>SET</span><span class=w> </span><span class=n>timezone</span><span class=o>=</span><span class=s1>&#39;Europe/Berlin&#39;</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=k>CREATE</span><span class=w> </span><span class=k>TABLE</span><span class=w> </span><span class=n>different_moments</span><span class=p>(</span><span class=n>moment1</span><span class=w> </span><span class=n>timestamptz</span><span class=p>,</span><span class=w> </span><span class=n>moment2</span><span class=w> </span><span class=n>timestamptz</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=k>INSERT</span><span class=w> </span><span class=k>INTO</span><span class=w> </span><span class=n>different_moments</span><span class=w> </span><span class=p>(</span><span class=n>moment1</span><span class=p>)</span><span class=w> </span><span class=k>values</span><span class=w> </span><span class=p>(</span><span class=s1>&#39;2025-03-30 01:30&#39;</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=c1>-- Apply double time zone conversion
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=k>UPDATE</span><span class=w> </span><span class=n>different_moments</span><span class=w> </span><span class=k>SET</span><span class=w> </span><span class=n>moment2</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>moment1</span><span class=w> </span><span class=k>AT</span><span class=w> </span><span class=n>TIME</span><span class=w> </span><span class=k>ZONE</span><span class=w> </span><span class=s1>&#39;Europe/Berlin&#39;</span><span class=w> </span><span class=k>AT</span><span class=w> </span><span class=n>TIME</span><span class=w> </span><span class=k>ZONE</span><span class=w> </span><span class=s1>&#39;America/New_York&#39;</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=c1>-- View the results
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=k>SELECT</span><span class=w> </span><span class=o>*</span><span class=w> </span><span class=k>FROM</span><span class=w> </span><span class=n>different_moments</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=k>Result</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>moment1</span><span class=w>         </span><span class=o>|</span><span class=w>        </span><span class=n>moment2</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=c1>------------------------+------------------------
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=w> </span><span class=mi>2025</span><span class=o>-</span><span class=mi>03</span><span class=o>-</span><span class=mi>30</span><span class=w> </span><span class=mi>01</span><span class=p>:</span><span class=mi>30</span><span class=p>:</span><span class=mi>00</span><span class=o>+</span><span class=mi>01</span><span class=w> </span><span class=o>|</span><span class=w> </span><span class=mi>2025</span><span class=o>-</span><span class=mi>03</span><span class=o>-</span><span class=mi>30</span><span class=w> </span><span class=mi>07</span><span class=p>:</span><span class=mi>30</span><span class=p>:</span><span class=mi>00</span><span class=o>+</span><span class=mi>02</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><p>除非您了解时间戳和时间戳之间的隐式转换以及反向转换，否则您可能会面临很多惊讶。在这个特定情况下，第一个转换执行了冗余转换并去除了时区偏移。第二次“强制”它进入纽约时间，而随后的选择在本地会话时区下呈现。</p><h2 id=timestamps-and-the-storage><span class=section-num>4</span> Timestamps and the storage</h2><p>虽然您从现在开始将使用 <code>timestamptz</code> ，但 PostgreSQL 仍然有几个与其存储数据方式相关的细微差别。</p><p>首先，较不为人知的特性可能是时间戳的精度。让我们考虑以下表格：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span><span class=lnt>7
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-sql data-lang=sql><span class=line><span class=cl><span class=c1>-- Table with various timestamp precision specifications
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=k>CREATE</span><span class=w> </span><span class=k>TABLE</span><span class=w> </span><span class=k>precision</span><span class=w> </span><span class=p>(</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>t1</span><span class=w> </span><span class=k>timestamp</span><span class=w> </span><span class=k>with</span><span class=w> </span><span class=n>time</span><span class=w> </span><span class=k>zone</span><span class=p>,</span><span class=w>        </span><span class=c1>-- default precision (6)
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=w>        </span><span class=n>t2</span><span class=w> </span><span class=k>timestamp</span><span class=p>(</span><span class=mi>0</span><span class=p>)</span><span class=w> </span><span class=k>with</span><span class=w> </span><span class=n>time</span><span class=w> </span><span class=k>zone</span><span class=p>,</span><span class=w>     </span><span class=c1>-- seconds precision
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=w>        </span><span class=n>t3</span><span class=w> </span><span class=k>timestamp</span><span class=p>(</span><span class=mi>2</span><span class=p>)</span><span class=w> </span><span class=k>with</span><span class=w> </span><span class=n>time</span><span class=w> </span><span class=k>zone</span><span class=p>,</span><span class=w>     </span><span class=c1>-- centiseconds precision
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=w>        </span><span class=n>t4</span><span class=w> </span><span class=k>timestamp</span><span class=p>(</span><span class=mi>4</span><span class=p>)</span><span class=w> </span><span class=k>with</span><span class=w> </span><span class=n>time</span><span class=w> </span><span class=k>zone</span><span class=w>      </span><span class=c1>-- 10 microseconds precision
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=p>);</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><p>实际上，时间戳的默认精度为 <code>6</code> 位数字（微秒），但您可以为时间戳和 timestamptz 类型指定从 <code>0</code> 到 <code>6</code> 的任意精度。与此同时，无论指定的精度如何，它对存储（ <code>8 字节</code> ）没有任何影响：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-sql data-lang=sql><span class=line><span class=cl><span class=c1>-- Insert the same timestamp into all columns
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=k>INSERT</span><span class=w> </span><span class=k>INTO</span><span class=w> </span><span class=k>precision</span><span class=w> </span><span class=k>VALUES</span><span class=w> </span><span class=p>(</span><span class=k>current_timestamp</span><span class=p>,</span><span class=w> </span><span class=k>current_timestamp</span><span class=p>,</span><span class=w> </span><span class=k>current_timestamp</span><span class=p>,</span><span class=w> </span><span class=k>current_timestamp</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=k>SELECT</span><span class=w> </span><span class=o>*</span><span class=w> </span><span class=k>FROM</span><span class=w> </span><span class=k>precision</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=k>Result</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=o>-</span><span class=p>[</span><span class=w> </span><span class=n>RECORD</span><span class=w> </span><span class=mi>1</span><span class=w> </span><span class=p>]</span><span class=c1>---------------------
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=n>t1</span><span class=w> </span><span class=o>|</span><span class=w> </span><span class=mi>2025</span><span class=o>-</span><span class=mi>04</span><span class=o>-</span><span class=mi>03</span><span class=w> </span><span class=mi>21</span><span class=p>:</span><span class=mi>19</span><span class=p>:</span><span class=mi>20</span><span class=p>.</span><span class=mi>952354</span><span class=o>+</span><span class=mi>02</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>t2</span><span class=w> </span><span class=o>|</span><span class=w> </span><span class=mi>2025</span><span class=o>-</span><span class=mi>04</span><span class=o>-</span><span class=mi>04</span><span class=w> </span><span class=mi>21</span><span class=p>:</span><span class=mi>19</span><span class=p>:</span><span class=mi>21</span><span class=o>+</span><span class=mi>02</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>t3</span><span class=w> </span><span class=o>|</span><span class=w> </span><span class=mi>2025</span><span class=o>-</span><span class=mi>04</span><span class=o>-</span><span class=mi>04</span><span class=w> </span><span class=mi>21</span><span class=p>:</span><span class=mi>19</span><span class=p>:</span><span class=mi>20</span><span class=p>.</span><span class=mi>95</span><span class=o>+</span><span class=mi>02</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>t4</span><span class=w> </span><span class=o>|</span><span class=w> </span><span class=mi>2025</span><span class=o>-</span><span class=mi>04</span><span class=o>-</span><span class=mi>04</span><span class=w> </span><span class=mi>21</span><span class=p>:</span><span class=mi>19</span><span class=p>:</span><span class=mi>20</span><span class=p>.</span><span class=mi>9524</span><span class=o>+</span><span class=mi>02</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><p>除了精度之外，PostgreSQL 中时间戳存储还有一些其他有趣的方面：</p><ul><li>它的 <code>timestamptz</code> 范围是有限的，范围为 <code>'4713-01-01 BC'</code> 和 <code>'294276-12-31'</code> 。</li><li>同时支持正无穷大和负无穷大, 使用 <code>'infinity'::timestamptz</code> 和 <code>'-infinity'::timestamptz</code><br>这可能为开放区间提供 <code>NULL</code> 的替代品。如果您选择使用无穷大而不是 <code>NULL</code> 值，则可以使用 <code>isfinite(timestamp)</code>
测试所提供的日期/时间戳是否为有限值。</li></ul><h2 id=getting-the-current-time-获取当前时间><span class=section-num>5</span> Getting the current time 获取当前时间</h2><p>并不是很多开发者意识到在 SQL 中获取当前日期时间的方式有不同的方法。这些方法不仅在语法上有所不同，在其底层逻辑上也有所不同。</p><h3 id=current-timestamp-vs-now><span class=section-num>5.1</span> <code>CURRENT_TIMESTAMP</code> vs <code>NOW()</code></h3><ul><li><p><code>*CURRENT_TIMESTAMP*</code><br><code>CURRENT_TIMESTAMP</code> 是 SQL 标准的一部分，值得注意的是，它被定义为“时间变化变量”和“日期时间值函数”。在
PostgreSQL 中，您可以选择使用或不使用括号，这两种形式都是有效的：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-sql data-lang=sql><span class=line><span class=cl><span class=k>SELECT</span><span class=w> </span><span class=k>CURRENT_TIMESTAMP</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=k>SELECT</span><span class=w> </span><span class=k>CURRENT_TIMESTAMP</span><span class=p>(</span><span class=mi>2</span><span class=p>);</span><span class=w>  </span><span class=c1>-- (2) specifies precision
</span></span></span></code></pre></td></tr></table></div></div><p>除了 <code>CURRENT_TIMESTAMP</code> ，SQL 标准还定义了 CURRENT_TIME 和 CURRENT_DATE，分别用于处理单独的时间和日期组件。</p></li><li><p><code>*NOW()*</code><br><code>NOW()</code> 虽然不是 SQL 标准的一部分，但在许多数据库系统中是一个广泛使用的替代方法。与 CURRENT_TIMESTAMP 不同，它严格来说是一个函数，因此在调用时始终需要括号。其简单明了的语法 - <code>NOW()</code> - 使其成为开发者们的热门选择。</p></li></ul><h3 id=transaction-behavior><span class=section-num>5.2</span> Transaction Behavior</h3><p><code>NOW()</code> 和 <code>CURRENT_TIMESTAMP</code> 都具有相同的事务行为：它们返回 <strong>当前事务开始时的时间戳</strong> ，而不是执行时的时刻：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-sql data-lang=sql><span class=line><span class=cl><span class=k>BEGIN</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=k>SELECT</span><span class=w> </span><span class=n>NOW</span><span class=p>();</span><span class=w>                     </span><span class=c1>-- Returns transaction start time
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=k>SELECT</span><span class=w> </span><span class=n>pg_sleep</span><span class=p>(</span><span class=mi>5</span><span class=p>);</span><span class=w>               </span><span class=c1>-- Wait 5 seconds
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=k>SELECT</span><span class=w> </span><span class=n>NOW</span><span class=p>();</span><span class=w>                     </span><span class=c1>-- Still returns the same time
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=k>COMMIT</span><span class=p>;</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><p>这种行为确保了事务内的数据一致性，但在测量经过时间时可能会令人意外。</p><h3 id=alternative-time-functions><span class=section-num>5.3</span> Alternative Time Functions</h3><p>当您需要实际的当前时间而不考虑事务状态时， <code>CLOCK_TIMESTAMP()</code> 是您最好的选择。它返回执行的精确时刻，这使得它在测量实际经过时间时特别有用。以下是它与 <code>NOW()</code> 的区别：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span><span class=lnt>7
</span><span class=lnt>8
</span><span class=lnt>9
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-sql data-lang=sql><span class=line><span class=cl><span class=k>BEGIN</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=k>SELECT</span><span class=w> </span><span class=n>pg_sleep</span><span class=p>(</span><span class=mi>1</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=k>SELECT</span><span class=w> </span><span class=n>NOW</span><span class=p>()</span><span class=w> </span><span class=k>AS</span><span class=w> </span><span class=n>transaction_time</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>       </span><span class=n>CLOCK_TIMESTAMP</span><span class=p>()</span><span class=w> </span><span class=k>AS</span><span class=w> </span><span class=n>actual_time</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=k>COMMIT</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=k>Result</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>       </span><span class=n>transaction_time</span><span class=w>        </span><span class=o>|</span><span class=w>          </span><span class=n>actual_time</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=c1>------------------------------+-------------------------------
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=w> </span><span class=mi>2025</span><span class=o>-</span><span class=mi>04</span><span class=o>-</span><span class=mi>03</span><span class=w> </span><span class=mi>19</span><span class=p>:</span><span class=mi>28</span><span class=p>:</span><span class=mi>25</span><span class=p>.</span><span class=mi>310254</span><span class=o>+</span><span class=mi>00</span><span class=w> </span><span class=o>|</span><span class=w> </span><span class=mi>2025</span><span class=o>-</span><span class=mi>04</span><span class=o>-</span><span class=mi>03</span><span class=w> </span><span class=mi>19</span><span class=p>:</span><span class=mi>28</span><span class=p>:</span><span class=mi>26</span><span class=p>.</span><span class=mi>311917</span><span class=o>+</span><span class=mi>00</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><p>另一个有用的函数是 <code>STATEMENT_TIMESTAMP()</code> ，它捕获当前语句开始执行的时间。这与 <code>CLOCK_TIMESTAMP()=</code> 有细微的区别，后者给出的是函数执行的确切时刻。这个区别在以下示例中变得清晰：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span><span class=lnt>7
</span><span class=lnt>8
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-sql data-lang=sql><span class=line><span class=cl><span class=k>SELECT</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>pg_sleep</span><span class=p>(</span><span class=mi>2</span><span class=p>),</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>STATEMENT_TIMESTAMP</span><span class=p>()</span><span class=w> </span><span class=k>AS</span><span class=w> </span><span class=k>statement</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>CLOCK_TIMESTAMP</span><span class=p>()</span><span class=w> </span><span class=k>AS</span><span class=w> </span><span class=n>wall_time</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=k>Result</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w> </span><span class=n>pg_sleep</span><span class=w> </span><span class=o>|</span><span class=w>           </span><span class=k>statement</span><span class=w>           </span><span class=o>|</span><span class=w>          </span><span class=n>wall_time</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=c1>----------+-------------------------------+------------------------------
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=w>          </span><span class=o>|</span><span class=w> </span><span class=mi>2025</span><span class=o>-</span><span class=mi>04</span><span class=o>-</span><span class=mi>03</span><span class=w> </span><span class=mi>19</span><span class=p>:</span><span class=mi>32</span><span class=p>:</span><span class=mi>15</span><span class=p>.</span><span class=mi>984459</span><span class=o>+</span><span class=mi>00</span><span class=w> </span><span class=o>|</span><span class=w> </span><span class=mi>2025</span><span class=o>-</span><span class=mi>04</span><span class=o>-</span><span class=mi>03</span><span class=w> </span><span class=mi>19</span><span class=p>:</span><span class=mi>32</span><span class=p>:</span><span class=mi>17</span><span class=p>.</span><span class=mi>98661</span><span class=o>+</span><span class=mi>00</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><p>这些时间戳函数服务于不同的目的，当您需要测量事务时间或分析语句级性能时，它们是非常宝贵的。每个函数为您在数据库操作中的时间提供了不同的视角。</p><h3 id=总结><span class=section-num>5.4</span> 总结</h3><ul><li><code>CURRENT_TIMESTAMP</code> & <code>NOW()</code> ： 返回事务开始的时刻</li><li><code>STATEMENT_TIMESTAMP()</code> ： 返回语句开始的时刻</li><li><code>CLOCK_TIMESTAMP()</code> ： 返回函数执行的时刻</li></ul><h2 id=intervals><span class=section-num>6</span> Intervals</h2><p>可以推测，如果您在 PostgreSQL 中处理过时间，您一定接触过区间（ <code>interval</code> ）。您可能只是使用类似于 <code>interval '1 year 2 months 3 days 4 hours'</code> 的方式输入它。从技术上讲，这种表示法是由 <code>intervalstyle</code> 设置驱动的，而在这个例子中，它被设置为 <code>postgres_verbose</code> 。但您还有更多的选项。</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-sql data-lang=sql><span class=line><span class=cl><span class=c1>-- PostgreSQL default style
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=k>SET</span><span class=w> </span><span class=n>intervalstyle</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=s1>&#39;postgres&#39;</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=k>SELECT</span><span class=w> </span><span class=nb>interval</span><span class=w> </span><span class=s1>&#39;1 year 2 months 3 days 4 hours&#39;</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=k>Result</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>           </span><span class=nb>interval</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=c1>-------------------------------
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=w> </span><span class=mi>1</span><span class=w> </span><span class=k>year</span><span class=w> </span><span class=mi>2</span><span class=w> </span><span class=n>mons</span><span class=w> </span><span class=mi>3</span><span class=w> </span><span class=n>days</span><span class=w> </span><span class=mi>04</span><span class=p>:</span><span class=mi>00</span><span class=p>:</span><span class=mi>00</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=c1>-- SQL standard style
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=k>SET</span><span class=w> </span><span class=n>intervalstyle</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=s1>&#39;sql_standard&#39;</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=k>SELECT</span><span class=w> </span><span class=nb>interval</span><span class=w> </span><span class=s1>&#39;1 year 2 months 3 days 4 hours&#39;</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=k>Result</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>     </span><span class=nb>interval</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=c1>------------------
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=w> </span><span class=o>+</span><span class=mi>1</span><span class=o>-</span><span class=mi>2</span><span class=w> </span><span class=o>+</span><span class=mi>3</span><span class=w> </span><span class=o>+</span><span class=mi>4</span><span class=p>:</span><span class=mi>00</span><span class=p>:</span><span class=mi>00</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=c1>-- ISO 8601 style
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=k>SET</span><span class=w> </span><span class=n>intervalstyle</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=s1>&#39;iso_8601&#39;</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=k>SELECT</span><span class=w> </span><span class=nb>interval</span><span class=w> </span><span class=s1>&#39;1 year 2 months 3 days 4 hours&#39;</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=k>Result</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nb>interval</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=c1>------------
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=w> </span><span class=n>P1Y2M3DT4H</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><p>通过会话的 <code>intervalstyle</code> ，您只会改变区间格式的表示，而不会改变实际值。然而，您可能会遇到一种区间定义，在输入或输出时可能让人不易理解。这时， <code>justify_interval</code> 函数就派上用场了—— 它帮助您将时间表达式规范化为常规格式。</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-sql data-lang=sql><span class=line><span class=cl><span class=c1>-- Normalize complex interval
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=k>SELECT</span><span class=w> </span><span class=n>justify_interval</span><span class=p>(</span><span class=nb>interval</span><span class=w> </span><span class=s1>&#39;15 months 40 days 30 hours&#39;</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=k>Result</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>justify_interval</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=c1>---------------------------------
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=w> </span><span class=o>@</span><span class=w> </span><span class=mi>1</span><span class=w> </span><span class=k>year</span><span class=w> </span><span class=mi>4</span><span class=w> </span><span class=n>mons</span><span class=w> </span><span class=mi>11</span><span class=w> </span><span class=n>days</span><span class=w> </span><span class=mi>6</span><span class=w> </span><span class=n>hours</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=c1>-- Practical example: normalize project durations
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=k>SELECT</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>project_name</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>total_hours</span><span class=w> </span><span class=o>||</span><span class=w> </span><span class=s1>&#39; hours&#39;</span><span class=w> </span><span class=k>AS</span><span class=w> </span><span class=n>raw_duration</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>justify_interval</span><span class=p>(</span><span class=nb>interval</span><span class=w> </span><span class=s1>&#39;1 hour&#39;</span><span class=w> </span><span class=o>*</span><span class=w> </span><span class=n>total_hours</span><span class=p>)</span><span class=w> </span><span class=k>AS</span><span class=w> </span><span class=n>normalized_duration</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=k>FROM</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>(</span><span class=k>VALUES</span><span class=w> </span><span class=p>(</span><span class=s1>&#39;Database Migration&#39;</span><span class=p>,</span><span class=w> </span><span class=mi>1850</span><span class=p>),</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=p>(</span><span class=s1>&#39;API Development&#39;</span><span class=p>,</span><span class=w> </span><span class=mi>720</span><span class=p>),</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=p>(</span><span class=s1>&#39;UI Redesign&#39;</span><span class=p>,</span><span class=w> </span><span class=mi>340</span><span class=p>))</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=k>AS</span><span class=w> </span><span class=n>projects</span><span class=p>(</span><span class=n>project_name</span><span class=p>,</span><span class=w> </span><span class=n>total_hours</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=k>Result</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>project_name</span><span class=w>    </span><span class=o>|</span><span class=w> </span><span class=n>raw_duration</span><span class=w> </span><span class=o>|</span><span class=w>   </span><span class=n>normalized_duration</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=c1>--------------------+--------------+--------------------------
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=w> </span><span class=k>Database</span><span class=w> </span><span class=n>Migration</span><span class=w> </span><span class=o>|</span><span class=w> </span><span class=mi>1850</span><span class=w> </span><span class=n>hours</span><span class=w>   </span><span class=o>|</span><span class=w> </span><span class=o>@</span><span class=w> </span><span class=mi>2</span><span class=w> </span><span class=n>mons</span><span class=w> </span><span class=mi>17</span><span class=w> </span><span class=n>days</span><span class=w> </span><span class=mi>2</span><span class=w> </span><span class=n>hours</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w> </span><span class=n>API</span><span class=w> </span><span class=n>Development</span><span class=w>    </span><span class=o>|</span><span class=w> </span><span class=mi>720</span><span class=w> </span><span class=n>hours</span><span class=w>    </span><span class=o>|</span><span class=w> </span><span class=o>@</span><span class=w> </span><span class=mi>1</span><span class=w> </span><span class=n>mon</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w> </span><span class=n>UI</span><span class=w> </span><span class=n>Redesign</span><span class=w>        </span><span class=o>|</span><span class=w> </span><span class=mi>340</span><span class=w> </span><span class=n>hours</span><span class=w>    </span><span class=o>|</span><span class=w> </span><span class=o>@</span><span class=w> </span><span class=mi>14</span><span class=w> </span><span class=n>days</span><span class=w> </span><span class=mi>4</span><span class=w> </span><span class=n>hours</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><p>内部规范化的一个重要特性是，它使用 30 天的时间段作为一个月的定义。</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-sql data-lang=sql><span class=line><span class=cl><span class=c1>-- Month definition in normalize intervals
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=k>SELECT</span><span class=w> </span><span class=n>justify_interval</span><span class=p>(</span><span class=nb>interval</span><span class=w> </span><span class=s1>&#39;30 days&#39;</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=k>Result</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w> </span><span class=n>justify_interval</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=c1>------------------
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=w> </span><span class=o>@</span><span class=w> </span><span class=mi>1</span><span class=w> </span><span class=n>mon</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><p>这可能是可以理解的，但在使用天数和月份区间时，您需要注意一些边界情况。</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span><span class=lnt>7
</span><span class=lnt>8
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-sql data-lang=sql><span class=line><span class=cl><span class=c1>-- Edge case comparison: month vs 30 days
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=k>SELECT</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nb>date</span><span class=w> </span><span class=s1>&#39;2025-01-31&#39;</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=nb>interval</span><span class=w> </span><span class=s1>&#39;1 month&#39;</span><span class=w> </span><span class=k>as</span><span class=w> </span><span class=n>example1</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nb>date</span><span class=w> </span><span class=s1>&#39;2025-01-31&#39;</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=nb>interval</span><span class=w> </span><span class=s1>&#39;30 days&#39;</span><span class=w> </span><span class=k>as</span><span class=w> </span><span class=n>example2</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=k>Result</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=o>-</span><span class=p>[</span><span class=w> </span><span class=n>RECORD</span><span class=w> </span><span class=mi>1</span><span class=w> </span><span class=p>]</span><span class=c1>-----------------
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=n>example1</span><span class=w> </span><span class=o>|</span><span class=w> </span><span class=mi>2025</span><span class=o>-</span><span class=mi>02</span><span class=o>-</span><span class=mi>28</span><span class=w> </span><span class=mi>00</span><span class=p>:</span><span class=mi>00</span><span class=p>:</span><span class=mi>00</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>example2</span><span class=w> </span><span class=o>|</span><span class=w> </span><span class=mi>2025</span><span class=o>-</span><span class=mi>03</span><span class=o>-</span><span class=mi>02</span><span class=w> </span><span class=mi>00</span><span class=p>:</span><span class=mi>00</span><span class=p>:</span><span class=mi>00</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><p>最后一点，您可以（与日期/时间戳相同）使用 extract 函数获取特定部分。</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span><span class=lnt>7
</span><span class=lnt>8
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-sql data-lang=sql><span class=line><span class=cl><span class=c1>-- Extract specific parts from intervals
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=k>SELECT</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=k>extract</span><span class=p>(</span><span class=n>days</span><span class=w> </span><span class=k>from</span><span class=w> </span><span class=nb>interval</span><span class=w> </span><span class=s1>&#39;1 year 3 months 21 days&#39;</span><span class=p>)</span><span class=w> </span><span class=k>AS</span><span class=w> </span><span class=n>days</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=k>extract</span><span class=p>(</span><span class=n>hours</span><span class=w> </span><span class=k>from</span><span class=w> </span><span class=nb>interval</span><span class=w> </span><span class=s1>&#39;25:30:45&#39;</span><span class=p>)</span><span class=w> </span><span class=k>AS</span><span class=w> </span><span class=n>hours</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=k>Result</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w> </span><span class=n>days</span><span class=w> </span><span class=o>|</span><span class=w> </span><span class=n>hours</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=c1>------+-------
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=w> </span><span class=mi>21</span><span class=w>   </span><span class=o>|</span><span class=w> </span><span class=mi>25</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><h2 id=time-ranges><span class=section-num>7</span> Time ranges</h2><p>处理时间戳是自然而然的，但时间范围往往被视为丑小鸭。而这其实是不公平的——在 PostgreSQL 中，时间戳范围是强大但未被充分利用的特性，可以优雅地解决常见的基于时间的挑战。PostgreSQL 提供了专门的范围类型，非常适合建模时间段、预订、日程安排以及任何您需要跟踪具有定义的起始和结束点的间隔的情况：</p><ul><li><p><code>tsrange</code> - 无时区时间戳的范围</p></li><li><p><code>tstzrange</code> - 带时区时间戳的范围<br>遵循之前的建议——就像您应该默认使用时间戳一样，除非您有非常具体的理由，否则始终使用 tstzrange
进行时间范围的定义。时间戳范围不仅仅是方便的语法——它们提供了一整套操作，用于确定时间段之间的关系，并启用强大的约束，以处理复杂的业务规则，而无需重新发明轮子。时间戳范围可以使用范围构造函数语法或字符串语法创建。</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-sql data-lang=sql><span class=line><span class=cl><span class=c1>-- Range constructor syntax
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=k>SELECT</span><span class=w> </span><span class=n>tstzrange</span><span class=p>(</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=s1>&#39;2025-04-01 09:00:00+02&#39;</span><span class=p>::</span><span class=n>timestamptz</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=s1>&#39;2025-04-01 17:30:00+02&#39;</span><span class=p>::</span><span class=n>timestamptz</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=s1>&#39;[)&#39;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>)</span><span class=w> </span><span class=k>AS</span><span class=w> </span><span class=n>workday</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=c1>-- String syntax
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=k>SELECT</span><span class=w> </span><span class=s1>&#39;[2025-04-01 09:00:00+02, 2025-04-01 17:30:00+02)&#39;</span><span class=p>::</span><span class=n>tstzrange</span><span class=w> </span><span class=k>AS</span><span class=w> </span><span class=n>workday</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=k>Result</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                       </span><span class=n>workday</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>[</span><span class=s2>&#34;2025-04-01 07:00:00+00&#34;</span><span class=p>,</span><span class=s2>&#34;2025-04-01 15:30:00+00&#34;</span><span class=p>)</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div></li></ul><p>时间戳范围的默认边界表示法是 <code>[)</code> - 下限是包含的（包括开始时间），上限是排除的（不包括结束时间）。对于基于时间的应用程序，这种约定特别有价值。考虑安排连续的一小时会议，从 9:00 到 10:00 和从 10:00 到 11:00。使用
[) 表示法，这些可以表示为 [09:00, 10:00) 和 [10:00, 11:00)，完美地创建相邻而不重叠或间隙。如果使用包含边界
[09:00, 10:00] 和 [10:00, 11:00]，那么 10:00 的时刻在技术上将属于两个范围——这在调度上是一个逻辑上的不可能性。这种与我们对时间段的概念理解的自然对齐，使得 [) 表示法成为大多数应用场景的默认和推荐选择。时间戳范围支持许多用于检查关系的操作：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span><span class=lnt>34
</span><span class=lnt>35
</span><span class=lnt>36
</span><span class=lnt>37
</span><span class=lnt>38
</span><span class=lnt>39
</span><span class=lnt>40
</span><span class=lnt>41
</span><span class=lnt>42
</span><span class=lnt>43
</span><span class=lnt>44
</span><span class=lnt>45
</span><span class=lnt>46
</span><span class=lnt>47
</span><span class=lnt>48
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-sql data-lang=sql><span class=line><span class=cl><span class=c1>-- 1. 检查时间戳是否在范围内
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=k>SELECT</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=s1>&#39;[2025-04-01 09:00, 2025-04-01 17:00)&#39;</span><span class=p>::</span><span class=n>tstzrange</span><span class=w> </span><span class=o>@&gt;</span><span class=w> </span><span class=s1>&#39;2025-04-01 12:30&#39;</span><span class=p>::</span><span class=n>timestamptz</span><span class=w> </span><span class=k>AS</span><span class=w> </span><span class=n>is_during_workday</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=err>结果：</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w> </span><span class=n>is_during_workday</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=c1>------------------
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=w> </span><span class=n>t</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=c1>-- 2. 检查两个范围是否重叠
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=k>SELECT</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=s1>&#39;[2025-04-01 09:00, 2025-04-01 12:00)&#39;</span><span class=p>::</span><span class=n>tstzrange</span><span class=w> </span><span class=o>&amp;&amp;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=s1>&#39;[2025-04-01 11:00, 2025-04-01 14:00)&#39;</span><span class=p>::</span><span class=n>tstzrange</span><span class=w> </span><span class=k>AS</span><span class=w> </span><span class=n>meetings_overlap</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=err>结果：</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w> </span><span class=n>meetings_overlap</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=c1>-----------------
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=w> </span><span class=n>t</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=c1>-- 3. 提取时间范围的边界
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=k>SELECT</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=k>lower</span><span class=p>(</span><span class=s1>&#39;[2025-04-01 09:00, 2025-04-01 17:00)&#39;</span><span class=p>::</span><span class=n>tstzrange</span><span class=p>)</span><span class=w> </span><span class=k>AS</span><span class=w> </span><span class=n>start_time</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=k>upper</span><span class=p>(</span><span class=s1>&#39;[2025-04-01 09:00, 2025-04-01 17:00)&#39;</span><span class=p>::</span><span class=n>tstzrange</span><span class=p>)</span><span class=w> </span><span class=k>AS</span><span class=w> </span><span class=n>end_time</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=err>结果：</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>start_time</span><span class=w>        </span><span class=o>|</span><span class=w>         </span><span class=n>end_time</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=c1>--------------------------+--------------------------
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=w> </span><span class=mi>2025</span><span class=o>-</span><span class=mi>04</span><span class=o>-</span><span class=mi>01</span><span class=w> </span><span class=mi>09</span><span class=p>:</span><span class=mi>00</span><span class=p>:</span><span class=mi>00</span><span class=o>+</span><span class=mi>00</span><span class=w>   </span><span class=o>|</span><span class=w> </span><span class=mi>2025</span><span class=o>-</span><span class=mi>04</span><span class=o>-</span><span class=mi>01</span><span class=w> </span><span class=mi>17</span><span class=p>:</span><span class=mi>00</span><span class=p>:</span><span class=mi>00</span><span class=o>+</span><span class=mi>00</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=err>以及明显的操作：</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=c1>-- 1. 合并相邻范围
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=k>SELECT</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=s1>&#39;[2025-04-01 09:00, 2025-04-01 12:00)&#39;</span><span class=p>::</span><span class=n>tstzrange</span><span class=w> </span><span class=o>+</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=s1>&#39;[2025-04-01 12:00, 2025-04-01 17:00)&#39;</span><span class=p>::</span><span class=n>tstzrange</span><span class=w> </span><span class=k>AS</span><span class=w> </span><span class=n>full_day</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=err>结果：</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                           </span><span class=n>full_day</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=c1>-------------------------------------------------------------
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=w> </span><span class=p>[</span><span class=s2>&#34;2025-04-01 09:00:00+00&#34;</span><span class=p>,</span><span class=s2>&#34;2025-04-01 17:00:00+00&#34;</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=c1>-- 2. 找到重叠范围之间的交集
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=k>SELECT</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=s1>&#39;[2025-04-01 09:00, 2025-04-01 14:00)&#39;</span><span class=p>::</span><span class=n>tstzrange</span><span class=w> </span><span class=o>*</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=s1>&#39;[2025-04-01 12:00, 2025-04-01 17:00)&#39;</span><span class=p>::</span><span class=n>tstzrange</span><span class=w> </span><span class=k>AS</span><span class=w> </span><span class=n>overlap_period</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=err>结果：</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                        </span><span class=n>overlap_period</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=c1>-------------------------------------------------------------
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=w> </span><span class=p>[</span><span class=s2>&#34;2025-04-01 12:00:00+00&#34;</span><span class=p>,</span><span class=s2>&#34;2025-04-01 14:00:00+00&#34;</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=c1>-- 3. 找到不重叠范围之间的间隙
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=k>SELECT</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=s1>&#39;[2025-04-01 09:00, 2025-04-01 11:00)&#39;</span><span class=p>::</span><span class=n>tstzrange</span><span class=w> </span><span class=o>-</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=s1>&#39;[2025-04-01 14:00, 2025-04-01 17:00)&#39;</span><span class=p>::</span><span class=n>tstzrange</span><span class=w> </span><span class=k>AS</span><span class=w> </span><span class=n>gap</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=err>结果：</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                             </span><span class=n>gap</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=c1>-------------------------------------------------------------
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=w> </span><span class=p>[</span><span class=s2>&#34;2025-04-01 11:00:00+00&#34;</span><span class=p>,</span><span class=s2>&#34;2025-04-01 14:00:00+00&#34;</span><span class=p>)</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><p>如果您遵循之前提到的逻辑，您将不会对 tstzrange 处理夏令时过渡感到疑惑。</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-sql data-lang=sql><span class=line><span class=cl><span class=c1>-- 测试夏令时过渡处理
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=k>SET</span><span class=w> </span><span class=n>timezone</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=s1>&#39;Europe/Berlin&#39;</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=k>SELECT</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=s1>&#39;[2025-03-30 01:00:00, 2025-03-30 03:00:00)&#39;</span><span class=p>::</span><span class=n>tstzrange</span><span class=w> </span><span class=k>AS</span><span class=w> </span><span class=n>dst_transition_range</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=k>upper</span><span class=p>(</span><span class=s1>&#39;[2025-03-30 01:00:00, 2025-03-30 03:00:00)&#39;</span><span class=p>::</span><span class=n>tstzrange</span><span class=p>)</span><span class=w> </span><span class=o>-</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=k>lower</span><span class=p>(</span><span class=s1>&#39;[2025-03-30 01:00:00, 2025-03-30 03:00:00)&#39;</span><span class=p>::</span><span class=n>tstzrange</span><span class=p>)</span><span class=w> </span><span class=k>AS</span><span class=w> </span><span class=n>actual_duration</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=err>结果：</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=n>dst_transition_range</span><span class=w>                 </span><span class=o>|</span><span class=w> </span><span class=n>actual_duration</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=c1>-----------------------------------------------------+-----------------
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=w> </span><span class=p>[</span><span class=s2>&#34;2025-03-30 01:00:00+01&#34;</span><span class=p>,</span><span class=s2>&#34;2025-03-30 03:00:00+02&#34;</span><span class=p>)</span><span class=w> </span><span class=o>|</span><span class=w> </span><span class=o>@</span><span class=w> </span><span class=mi>1</span><span class=w> </span><span class=n>hour</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><p>时间范围在几乎所有场景中都表现优秀的领域是索引。如果考虑使用 start_at 和 end_at 列的手动实现范围，通常依赖于 B
树索引。虽然它们可能在简单查询中有效，但对于时间范围而言就不够了。考虑这个例子：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-sql data-lang=sql><span class=line><span class=cl><span class=c1>-- 传统方法，使用两个列和 B 树索引
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=k>SELECT</span><span class=w> </span><span class=o>*</span><span class=w> </span><span class=k>FROM</span><span class=w> </span><span class=n>events_columns</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=k>WHERE</span><span class=w> </span><span class=n>start_at</span><span class=w> </span><span class=o>&lt;=</span><span class=w> </span><span class=s1>&#39;2025-04-01 17:00&#39;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=k>AND</span><span class=w> </span><span class=n>end_at</span><span class=w> </span><span class=o>&gt;=</span><span class=w> </span><span class=s1>&#39;2025-04-01 09:00&#39;</span><span class=p>;</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><p>对于这个查询，PostgreSQL 可能会使用其中一个索引（如果它的选择性足够高），但基本问题仍然存在：每个 B 树索引只能有效地过滤其自身的列。查询规划器可能会使用 start_at 索引查找在 17:00 之前开始的事件，或使用 end_at 索引查找在 09:00 之后结束的事件，但它不能同时使用这两个索引来查找交集。使用范围类型，我们可以使用专门设计用于范围操作的 GiST（广义搜索树）索引：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-sql data-lang=sql><span class=line><span class=cl><span class=c1>-- 创建专门的 GiST 索引以进行时间范围操作
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=k>CREATE</span><span class=w> </span><span class=k>INDEX</span><span class=w> </span><span class=n>idx_events_range</span><span class=w> </span><span class=k>ON</span><span class=w> </span><span class=n>events_range</span><span class=w> </span><span class=k>USING</span><span class=w> </span><span class=n>GIST</span><span class=p>(</span><span class=n>time_period</span><span class=p>);</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><p>这使您能够将示例查询转化为：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-sql data-lang=sql><span class=line><span class=cl><span class=c1>-- 基于范围的查找，使用 &amp;&amp;（重叠）操作符
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=k>SELECT</span><span class=w> </span><span class=o>*</span><span class=w> </span><span class=k>FROM</span><span class=w> </span><span class=n>events_range</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=k>WHERE</span><span class=w> </span><span class=n>time_period</span><span class=w> </span><span class=o>&amp;&amp;</span><span class=w> </span><span class=n>tstzrange</span><span class=p>(</span><span class=s1>&#39;2025-04-01 09:00&#39;</span><span class=p>,</span><span class=w> </span><span class=s1>&#39;2025-04-01 17:00&#39;</span><span class=p>);</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><p>这两种方法之间的性能差距是显著的——在大型数据集上，使用 GiST 索引的范围查询通常比传统方法快 2-10 倍。随着数据量的增加，这种差异会变得更加明显。</p><h2 id=time-to-wrap-up><span class=section-num>8</span> Time to wrap up</h2><p>在 PostgreSQL 中处理时间表面上看似简单，但正如我们所探讨的，它充满了细微差别，这些细微差别可能会影响您应用程序的可靠性。此次深入探讨的关键要点应包括：</p><p>– 总是使用 <code>timestamptz</code> 而不是 <code>timestamp</code>
– 有意识地处理时区– 利用 PostgreSQL 专用的时间工具– 注意边界情况</p><p>时间处理仍然是软件工程中最具迷惑性的复杂方面之一，但 PostgreSQL 提供了一个强大的工具包，可以有效地管理时间。通过理解这些“无趣”但至关重要的概念，您将避免常见的陷阱，构建能够自信且精准处理时间的应用程序。</p></div><div class=post-footer id=post-footer><div class=post-info><div class=post-info-line><div class=post-info-mod><span>更新于 2025-11-03</span></div></div><div class=post-info-line><div class=post-info-md></div><div class=post-info-share><span></span></div></div></div><div class=post-info-more><section class=post-tags><i class="fas fa-tags fa-fw" aria-hidden=true></i>&nbsp;<a href=/tags/pg/>Pg</a>,&nbsp;<a href=/tags/time/>Time</a>,&nbsp;<a href=/tags/date/>Date</a></section><section><span><a href=javascript:void(0); onclick=window.history.back()>返回</a></span>&nbsp;|&nbsp;<span><a href=/>主页</a></span></section></div><div class=post-nav><a href=/2025/11/%E5%8D%81%E6%9C%88%E9%98%85%E8%AF%BB%E6%80%BB%E7%BB%93/ class=prev rel=prev title=十月阅读总结><i class="fas fa-angle-left fa-fw" aria-hidden=true></i>十月阅读总结</a>
<a href=/2025/11/postgresql-and-numa/ class=next rel=next title="PostgreSQL and NUMA">PostgreSQL and NUMA<i class="fas fa-angle-right fa-fw" aria-hidden=true></i></a></div></div></article></div></main><footer class=footer><div class=footer-container><div class=footer-line itemscope itemtype=http://schema.org/CreativeWork>&nbsp;|&nbsp;<span class=license><a rel="license external nofollow noopener noreffer" href=https://creativecommons.org/licenses/by-nc/4.0/ target=_blank>CC BY-NC 4.0</a></span></div></div></footer></div><div id=fixed-buttons><a href=# id=back-to-top class=fixed-button title=回到顶部><i class="fas fa-arrow-up fa-fw" aria-hidden=true></i>
</a><a href=# id=view-comments class=fixed-button title=查看评论><i class="fas fa-comment fa-fw" aria-hidden=true></i></a></div><script type=text/javascript src=https://cdn.jsdelivr.net/npm/autocomplete.js@0.38.1/dist/autocomplete.min.js></script><script type=text/javascript src=https://cdn.jsdelivr.net/npm/lunr@2.3.9/lunr.min.js></script><script type=text/javascript src=/lib/lunr/lunr.stemmer.support.min.js></script><script type=text/javascript src=/lib/lunr/lunr.zh.min.js></script><script type=text/javascript src=https://cdn.jsdelivr.net/npm/lazysizes@5.3.2/lazysizes.min.js></script><script type=text/javascript src=https://cdn.jsdelivr.net/npm/clipboard@2.0.11/dist/clipboard.min.js></script><script type=text/javascript>window.config={code:{copyTitle:"复制到剪贴板",maxShownLines:50},comment:{},search:{highlightTag:"em",lunrIndexURL:"/index.json",lunrLanguageCode:"zh",lunrSegmentitURL:"/lib/lunr/lunr.segmentit.js",maxResultLength:10,noResultsFound:"没有找到结果",snippetLength:30,type:"lunr"}}</script><script type=text/javascript src=/js/theme.min.js></script></body></html>