<!doctype html><html lang=zh-cn><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta name=robots content="noodp"><title>Barriers in PostgresSQL - 老杨的杂货铺</title><meta name=Description content="杂七杂八的，随手记录。"><meta property="og:url" content="https://yangyingchao.github.io/barriers-in-postgressql/">
<meta property="og:site_name" content="老杨的杂货铺"><meta property="og:title" content="Barriers in PostgresSQL"><meta property="og:description" content="Table of Contents 1 Barriers: 协调进程的同步屏障 1.1 静态参与 2 TODO: Barriers API 3 TODO: how it is used in hash jon… 简单总结一下 PG 中进程同步用到的屏障： https://github.com/postgres/postgres/blob/master/src/backend/storage/ipc/barrier.c
1 Barriers: 协调进程的同步屏障 来自维基百科[1]："><meta property="og:locale" content="zh_cn"><meta property="og:type" content="article"><meta property="article:section" content="posts"><meta property="article:published_time" content="2023-10-21T00:00:00+00:00"><meta property="article:modified_time" content="2023-10-21T00:00:00+00:00"><meta property="article:tag" content="Pg"><meta property="article:tag" content="Ipc"><meta property="article:tag" content="Barriers"><meta property="og:image" content="https://yangyingchao.github.io/logo.png"><meta name=twitter:card content="summary_large_image"><meta name=twitter:image content="https://yangyingchao.github.io/logo.png"><meta name=twitter:title content="Barriers in PostgresSQL"><meta name=twitter:description content="Table of Contents 1 Barriers: 协调进程的同步屏障 1.1 静态参与 2 TODO: Barriers API 3 TODO: how it is used in hash jon… 简单总结一下 PG 中进程同步用到的屏障： https://github.com/postgres/postgres/blob/master/src/backend/storage/ipc/barrier.c
1 Barriers: 协调进程的同步屏障 来自维基百科[1]："><meta name=application-name content="LoveIt"><meta name=apple-mobile-web-app-title content="LoveIt"><meta name=theme-color content="#ffffff"><meta name=msapplication-TileColor content="#da532c"><link rel="shortcut icon" type=image/x-icon href=/favicon.ico><link rel=icon type=image/png sizes=32x32 href=/favicon-32x32.png><link rel=icon type=image/png sizes=16x16 href=/favicon-16x16.png><link rel=apple-touch-icon sizes=180x180 href=/apple-touch-icon.png><link rel=mask-icon href=/safari-pinned-tab.svg color=#5bbad5><link rel=manifest href=/site.webmanifest><link rel=canonical href=https://yangyingchao.github.io/barriers-in-postgressql/><link rel=prev href=https://yangyingchao.github.io/w-pmu3_td3depow-xede-a/><link rel=next href=https://yangyingchao.github.io/silly-questions-related-to-docker--debian/><link rel=stylesheet href=/css/style.min.css><link rel=preload href=https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6.1.1/css/all.min.css as=style onload='this.onload=null,this.rel="stylesheet"'><noscript><link rel=stylesheet href=https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6.1.1/css/all.min.css></noscript><link rel=preload href=https://cdn.jsdelivr.net/npm/animate.css@4.1.1/animate.min.css as=style onload='this.onload=null,this.rel="stylesheet"'><noscript><link rel=stylesheet href=https://cdn.jsdelivr.net/npm/animate.css@4.1.1/animate.min.css></noscript><script type=application/ld+json>{"@context":"http://schema.org","@type":"BlogPosting","headline":"Barriers in PostgresSQL","inLanguage":"zh-cn","mainEntityOfPage":{"@type":"WebPage","@id":"https:\/\/yangyingchao.github.io\/barriers-in-postgressql\/"},"image":["https:\/\/yangyingchao.github.io\/images\/Apple-Devices-Preview.png"],"genre":"posts","keywords":"pg, ipc, barriers","wordcount":1345,"url":"https:\/\/yangyingchao.github.io\/barriers-in-postgressql\/","datePublished":"2023-10-21T00:00:00+00:00","dateModified":"2023-10-21T00:00:00+00:00","publisher":{"@type":"Organization","name":"xxxx","logo":"https:\/\/yangyingchao.github.io\/images\/avatar.png"},"author":{"@type":"Person","name":"yc"},"description":""}</script></head><body data-header-desktop=normal data-header-mobile=auto><script type=text/javascript>(window.localStorage&&localStorage.getItem("theme")?localStorage.getItem("theme")==="dark":"auto"==="auto"?window.matchMedia("(prefers-color-scheme: dark)").matches:"auto"==="dark")&&document.body.setAttribute("theme","dark")</script><div id=mask></div><div class=wrapper><header class=desktop id=header-desktop><div class=header-wrapper><div class=header-title><a href=/ title=老杨的杂货铺><span class=header-title-pre><i class="fa-solid fa-house-chimney"></i></span>老杨的杂货铺</a></div><div class=menu><div class=menu-inner><a class=menu-item href=/posts/>所有文章 </a><a class=menu-item href=/tags/>标签 </a><a class=menu-item href=/categories/>分类 </a><a class=menu-item href=https://github.com/yangyingchao/MyNotes title=GitHub rel="noopener noreffer" target=_blank><i class='fab fa-github fa-fw' aria-hidden=true></i> </a><span class="menu-item delimiter"></span><span class="menu-item search" id=search-desktop>
<input type=text placeholder=搜索文章标题或内容... id=search-input-desktop>
<a href=javascript:void(0); class="search-button search-toggle" id=search-toggle-desktop title=搜索><i class="fas fa-search fa-fw" aria-hidden=true></i>
</a><a href=javascript:void(0); class="search-button search-clear" id=search-clear-desktop title=清空><i class="fas fa-times-circle fa-fw" aria-hidden=true></i>
</a><span class="search-button search-loading" id=search-loading-desktop><i class="fas fa-spinner fa-fw fa-spin" aria-hidden=true></i>
</span></span><a href=javascript:void(0); class="menu-item theme-switch" title=切换主题><i class="fas fa-adjust fa-fw" aria-hidden=true></i></a></div></div></div></header><header class=mobile id=header-mobile><div class=header-container><div class=header-wrapper><div class=header-title><a href=/ title=老杨的杂货铺><span class=header-title-pre><i class="fa-solid fa-house-chimney"></i></span>老杨的杂货铺</a></div><div class=menu-toggle id=menu-toggle-mobile><span></span><span></span><span></span></div></div><div class=menu id=menu-mobile><div class=search-wrapper><div class="search mobile" id=search-mobile><input type=text placeholder=搜索文章标题或内容... id=search-input-mobile>
<a href=javascript:void(0); class="search-button search-toggle" id=search-toggle-mobile title=搜索><i class="fas fa-search fa-fw" aria-hidden=true></i>
</a><a href=javascript:void(0); class="search-button search-clear" id=search-clear-mobile title=清空><i class="fas fa-times-circle fa-fw" aria-hidden=true></i>
</a><span class="search-button search-loading" id=search-loading-mobile><i class="fas fa-spinner fa-fw fa-spin" aria-hidden=true></i></span></div><a href=javascript:void(0); class=search-cancel id=search-cancel-mobile>取消</a></div><a class=menu-item href=/posts/ title>所有文章</a><a class=menu-item href=/tags/ title>标签</a><a class=menu-item href=/categories/ title>分类</a><a class=menu-item href=https://github.com/yangyingchao/MyNotes title=GitHub rel="noopener noreffer" target=_blank><i class='fab fa-github fa-fw' aria-hidden=true></i></a><a href=javascript:void(0); class="menu-item theme-switch" title=切换主题>
<i class="fas fa-adjust fa-fw" aria-hidden=true></i></a></div></div></header><div class="search-dropdown desktop"><div id=search-dropdown-desktop></div></div><div class="search-dropdown mobile"><div id=search-dropdown-mobile></div></div><main class=main><div class=container><div class=toc id=toc-auto><h2 class=toc-title>目录</h2><div class=toc-content id=toc-content-auto></div></div><article class="page single"><h1 class="single-title animate__animated animate__flipInX">Barriers in PostgresSQL</h1><div class=post-meta><div class=post-meta-line><span class=post-author><a href=/ title=Author rel=author class=author><i class="fas fa-user-circle fa-fw" aria-hidden=true></i>yc</a></span></div><div class=post-meta-line><i class="far fa-calendar-alt fa-fw" aria-hidden=true></i>&nbsp;<time datetime=2023-10-21>2023-10-21</time>&nbsp;<i class="fas fa-pencil-alt fa-fw" aria-hidden=true></i>&nbsp;约 1345 字&nbsp;
<i class="far fa-clock fa-fw" aria-hidden=true></i>&nbsp;预计阅读 3 分钟&nbsp;</div></div><div class="details toc" id=toc-static data-kept><div class="details-summary toc-title"><span>目录</span>
<span><i class="details-icon fas fa-angle-right" aria-hidden=true></i></span></div><div class="details-content toc-content" id=toc-content-static><nav id=TableOfContents><ul><li><a href=#h:88e9d8e9-1ea1-450e-bd7c-cfc191923b9c><span class=section-num>1</span> Barriers: 协调进程的同步屏障</a><ul><li><a href=#h:2d66dbfb-2295-40bf-bab2-22f8c77a3414><span class=section-num>1.1</span> 静态参与</a></li></ul></li><li><a href=#h:d5dd2d64-5c1c-470a-bc3b-d3a9acbd7356><span class=section-num>2</span> TODO: Barriers API</a></li><li><a href=#h:4733ab46-ff4d-47aa-93eb-44dcbfba482a><span class=section-num>3</span> TODO: how it is used in hash jon…</a></li></ul></nav></div></div><div class=content id=content><div class="ox-hugo-toc toc has-section-numbers"><div class=heading>Table of Contents</div><ul><li><span class=section-num>1</span> <a href=#h:88e9d8e9-1ea1-450e-bd7c-cfc191923b9c rel>Barriers: 协调进程的同步屏障</a><ul><li><span class=section-num>1.1</span> <a href=#h:2d66dbfb-2295-40bf-bab2-22f8c77a3414 rel>静态参与</a></li></ul></li><li><span class=section-num>2</span> <a href=#h:d5dd2d64-5c1c-470a-bc3b-d3a9acbd7356 rel>TODO: Barriers API</a></li><li><span class=section-num>3</span> <a href=#h:4733ab46-ff4d-47aa-93eb-44dcbfba482a rel>TODO: how it is used in hash jon…</a></li></ul></div><p>简单总结一下 PG 中进程同步用到的屏障：
<a href=https://github.com/postgres/postgres/blob/master/src/backend/storage/ipc/barrier.c target=_blank rel="noopener noreffer">https://github.com/postgres/postgres/blob/master/src/backend/storage/ipc/barrier.c</a></p><h2 id=h:88e9d8e9-1ea1-450e-bd7c-cfc191923b9c><span class=section-num>1</span> Barriers: 协调进程的同步屏障</h2><p>来自维基百科[1]：</p><blockquote><p>“在并行计算中，屏障是一种同步方法。在源代码中，对于一组线程或进程而言，屏障意味着任何一个线程或进程必须在此处停止，并且在所有其他线程或进程到达该屏障之前无法继续进行。”</p></blockquote><p>协调进程同步的屏障可以归纳为以下几点：</p><ol><li>并发性：多个进程同时执行可能导致数据竞争和冲突，因此需要采取措施来确保数据的一致性和正确性。</li><li>同步需求不明确：不同的进程可能对同步的时间和顺序有不同的要求，导致难以找到一种通用的同步机制来满足所有进程的需求。</li><li>通信开销：在进程间进行同步需要进行通信，而通信本身会带来开销，包括延迟和带宽消耗。</li><li>死锁：在复杂的同步机制中，可能存在死锁的风险，即进程互相等待对方释放资源，从而导致系统无法继续执行。</li><li>跨平台兼容性：在跨平台开发中，不同操作系统或编程语言的同步机制可能不兼容，限制了进程间的同步和协作。</li></ol><p>该屏障的实现允许静态参与和动态参与两种方式：</p><ul><li><p>静态参与</p><ul><li>参与者集合在一开始就确定（事先已知）</li><li>阶段号被内部使用，但是并不一定需要客户端代码访问它，</li><li>只有当声明的参与者数量达到屏障时，阶段才会前进，</li><li>客户端代码应始终能够确定计算的当前阶段。</li></ul></li><li><p>动态参与</p><ul><li>其中进程可以随时加入或离开</li><li>可以使用一个阶段号跟踪并行算法的进展情况，</li><li>当新参与者加入时，可能需要与多阶段算法的当前阶段同步</li></ul></li></ul><p>假设一个并行算法，它涉及到分开的计算阶段 A、B 和 C，每个阶段的输出在下一个阶段开始之前都是必需的。</p><h3 id=h:2d66dbfb-2295-40bf-bab2-22f8c77a3414><span class=section-num>1.1</span> 静态参与</h3><p>在初始化为 4 个参与者的静态屏障的情况下，每个参与者都在阶段 A 上工作，然后调用
BarrierArriveAndWait 进行等待，直到所有 4 个参与者到达该点。当 BarrierArriveAndWait 返回控制权时，每个参与者都可以在 B 上工作，以此类推。因为屏障知道要期望多少个参与者，所以计算的阶段不需要标签或数字，因为每个进程的程序计数器都暗示了当前阶段。即使某些进程开始运行阶段 A 较慢，其他参与者也在等待他们，并将耐心等待在屏障处。</p><p>代码可以写成如下形式：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-c data-lang=c><span class=line><span class=cl><span class=nf>perform_a</span><span class=p>();</span>
</span></span><span class=line><span class=cl><span class=nf>BarrierArriveAndWait</span><span class=p>(</span><span class=o>&amp;</span><span class=n>barrier</span><span class=p>,</span> <span class=p>...);</span>
</span></span><span class=line><span class=cl><span class=nf>perform_b</span><span class=p>();</span>
</span></span><span class=line><span class=cl><span class=nf>BarrierArriveAndWait</span><span class=p>(</span><span class=o>&amp;</span><span class=n>barrier</span><span class=p>,</span> <span class=p>...);</span>
</span></span><span class=line><span class=cl><span class=nf>perform_c</span><span class=p>();</span>
</span></span><span class=line><span class=cl><span class=nf>BarrierArriveAndWait</span><span class=p>(</span><span class=o>&amp;</span><span class=n>barrier</span><span class=p>,</span> <span class=p>...);</span>
</span></span></code></pre></td></tr></table></div></div><p>If the number of participants is not known up front, then a dynamic barrier
is needed and the number should be set to zero at initialization. New
complications arise because the number necessarily changes over time as
participants attach and detach, and therefore phases B, C or even the end
of processing may be reached before any given participant has started
running and attached. Therefore the client code must perform an initial
test of the phase number after attaching, because it needs to find out
which phase of the algorithm has been reached by any participants that are
already attached in order to synchronize with that work. Once the program
counter or some other representation of current progress is synchronized
with the barrier&rsquo;s phase, normal control flow can be used just as in the
static case. Our example could be written using a switch statement with
cases that fall-through, as follows:</p><p>如果事先不知道参与者的数量，那么就需要使用动态屏障，并在初始化时将数量设为零。由于参与者的附加和解除附加使数量随时间而变化，因此在某个给定的参与者开始运行和附加之前，可能会到达
B、C 阶段甚至处理结束。因此，客户端代码在附加后必须对阶段号进行初始测试，因为它需要找出已经附加的任何参与者所达到的算法阶段，以与该工作进行同步。一旦程序计数器或表示当前进度的其他表示与屏障的阶段进行了同步，就可以像静态情况下一样使用正常的控制流。我们的示例可以使用带有贯穿的 switch 语句来编写，如下所示：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-c data-lang=c><span class=line><span class=cl><span class=n>phase</span> <span class=o>=</span> <span class=nf>BarrierAttach</span><span class=p>(</span><span class=o>&amp;</span><span class=n>barrier</span><span class=p>);</span>
</span></span><span class=line><span class=cl><span class=k>switch</span> <span class=p>(</span><span class=n>phase</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=p>{</span>
</span></span><span class=line><span class=cl><span class=k>case</span> <span class=nl>PHASE_A</span><span class=p>:</span>
</span></span><span class=line><span class=cl>    <span class=nf>perform_a</span><span class=p>();</span>
</span></span><span class=line><span class=cl>    <span class=nf>BarrierArriveAndWait</span><span class=p>(</span><span class=o>&amp;</span><span class=n>barrier</span><span class=p>,</span> <span class=p>...);</span>
</span></span><span class=line><span class=cl><span class=k>case</span> <span class=nl>PHASE_B</span><span class=p>:</span>
</span></span><span class=line><span class=cl>    <span class=nf>perform_b</span><span class=p>();</span>
</span></span><span class=line><span class=cl>    <span class=nf>BarrierArriveAndWait</span><span class=p>(</span><span class=o>&amp;</span><span class=n>barrier</span><span class=p>,</span> <span class=p>...);</span>
</span></span><span class=line><span class=cl><span class=k>case</span> <span class=nl>PHASE_C</span><span class=p>:</span>
</span></span><span class=line><span class=cl>    <span class=nf>perform_c</span><span class=p>();</span>
</span></span><span class=line><span class=cl>    <span class=nf>BarrierArriveAndWait</span><span class=p>(</span><span class=o>&amp;</span><span class=n>barrier</span><span class=p>,</span> <span class=p>...);</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl><span class=nf>BarrierDetach</span><span class=p>(</span><span class=o>&amp;</span><span class=n>barrier</span><span class=p>);</span>
</span></span></code></pre></td></tr></table></div></div><p>Static barriers behave similarly to POSIX&rsquo;s pthread_barrier_t. Dynamic
barriers behave similarly to Java&rsquo;s java.util.concurrent.Phaser.</p><p>静态屏障的行为类似于 POSIX 的 <code>pthread_barrier</code> _t。动态屏障的行为类似于 Java 的 <code>java.util.concurrent.Phaser</code> 。</p><h2 id=h:d5dd2d64-5c1c-470a-bc3b-d3a9acbd7356><span class=section-num>2</span> TODO: Barriers API</h2><h2 id=h:4733ab46-ff4d-47aa-93eb-44dcbfba482a><span class=section-num>3</span> TODO: how it is used in hash jon…</h2></div><div class=post-footer id=post-footer><div class=post-info><div class=post-info-line><div class=post-info-mod><span>更新于 2023-10-21</span></div></div><div class=post-info-line><div class=post-info-md><span><a class=link-to-markdown href=/barriers-in-postgressql/index.md target=_blank>阅读原始文档</a></span></div><div class=post-info-share><span></span></div></div></div><div class=post-info-more><section class=post-tags><i class="fas fa-tags fa-fw" aria-hidden=true></i>&nbsp;<a href=/tags/pg/>Pg</a>,&nbsp;<a href=/tags/ipc/>Ipc</a>,&nbsp;<a href=/tags/barriers/>Barriers</a></section><section><span><a href=javascript:void(0); onclick=window.history.back()>返回</a></span>&nbsp;|&nbsp;<span><a href=/>主页</a></span></section></div><div class=post-nav><a href=/w-pmu3_td3depow-xede-a/ class=prev rel=prev title="Linux 中如何安全地抹去磁盘数据"><i class="fas fa-angle-left fa-fw" aria-hidden=true></i>Linux 中如何安全地抹去磁盘数据</a>
<a href=/silly-questions-related-to-docker--debian/ class=next rel=next title="silly questions related to docker & debian">silly questions related to docker & debian<i class="fas fa-angle-right fa-fw" aria-hidden=true></i></a></div></div><div id=comments><div id=giscus class=comment></div><noscript>Please enable JavaScript to view the comments powered by <a href=https://giscus.app>Giscus</a>.</noscript></div></article></div></main><footer class=footer><div class=footer-container><div class=footer-line itemscope itemtype=http://schema.org/CreativeWork>&nbsp;|&nbsp;<span class=license><a rel="license external nofollow noopener noreffer" href=https://creativecommons.org/licenses/by-nc/4.0/ target=_blank>CC BY-NC 4.0</a></span></div></div></footer></div><div id=fixed-buttons><a href=# id=back-to-top class=fixed-button title=回到顶部><i class="fas fa-arrow-up fa-fw" aria-hidden=true></i>
</a><a href=# id=view-comments class=fixed-button title=查看评论><i class="fas fa-comment fa-fw" aria-hidden=true></i></a></div><script type=text/javascript src=https://cdn.jsdelivr.net/npm/autocomplete.js@0.38.1/dist/autocomplete.min.js></script><script type=text/javascript src=https://cdn.jsdelivr.net/npm/algoliasearch@4.13.1/dist/algoliasearch-lite.umd.min.js></script><script type=text/javascript src=https://cdn.jsdelivr.net/npm/lazysizes@5.3.2/lazysizes.min.js></script><script type=text/javascript src=https://cdn.jsdelivr.net/npm/clipboard@2.0.11/dist/clipboard.min.js></script><script type=text/javascript>window.config={code:{copyTitle:"复制到剪贴板",maxShownLines:50},comment:{giscus:{category:"Announcements",categoryId:"R_kgDON6NYZA",darkTheme:"dark",emitMetadata:"0",inputPosition:"bottom",lang:"zh-CN",lazyLoading:!1,lightTheme:"light",mapping:"pathname",reactionsEnabled:"1",repo:"yangyingchao/giscus",repoId:""}},search:{algoliaAppID:null,algoliaIndex:"index.zh-cn",algoliaSearchKey:null,highlightTag:"em",maxResultLength:10,noResultsFound:"没有找到结果",snippetLength:30,type:"algolia"}}</script><script type=text/javascript src=/js/theme.min.js></script></body></html>