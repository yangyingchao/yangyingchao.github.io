<rss xmlns:atom="http://www.w3.org/2005/Atom" version="2.0"><channel><title>杂货铺</title><link>https://yangyingchao.github.io/</link><description>杂七杂八的，随手记录。</description><generator>Hugo -- gohugo.io</generator><language>zh-CH</language><managingEditor>yang.yingchao@qq.com (yc)</managingEditor><webMaster>yang.yingchao@qq.com (yc)</webMaster><lastBuildDate>Wed, 31 Dec 2025 00:00:00 +0000</lastBuildDate><atom:link href="https://yangyingchao.github.io/index.xml" rel="self" type="application/rss+xml"/><item><title>策略思维_商界、政界及日常生活中的策略竞争-阿维纳什·k·迪克西特;巴里·j·奈尔伯夫;王尔山</title><link>https://yangyingchao.github.io/2025/12/%E7%AC%94%E8%AE%B0%E7%AD%96%E7%95%A5%E6%80%9D%E7%BB%B4_%E5%95%86%E7%95%8C%E6%94%BF%E7%95%8C%E5%8F%8A%E6%97%A5%E5%B8%B8%E7%94%9F%E6%B4%BB%E4%B8%AD%E7%9A%84%E7%AD%96%E7%95%A5%E7%AB%9E%E4%BA%89-%E9%98%BF%E7%BB%B4%E7%BA%B3%E4%BB%80k%E8%BF%AA%E5%85%8B%E8%A5%BF%E7%89%B9%E5%B7%B4%E9%87%8Cj%E5%A5%88%E5%B0%94%E4%BC%AF%E5%A4%AB%E7%8E%8B%E5%B0%94%E5%B1%B1/</link><pubDate>Wed, 31 Dec 2025 00:00:00 +0000</pubDate><author>yc</author><guid>https://yangyingchao.github.io/2025/12/%E7%AC%94%E8%AE%B0%E7%AD%96%E7%95%A5%E6%80%9D%E7%BB%B4_%E5%95%86%E7%95%8C%E6%94%BF%E7%95%8C%E5%8F%8A%E6%97%A5%E5%B8%B8%E7%94%9F%E6%B4%BB%E4%B8%AD%E7%9A%84%E7%AD%96%E7%95%A5%E7%AB%9E%E4%BA%89-%E9%98%BF%E7%BB%B4%E7%BA%B3%E4%BB%80k%E8%BF%AA%E5%85%8B%E8%A5%BF%E7%89%B9%E5%B7%B4%E9%87%8Cj%E5%A5%88%E5%B0%94%E4%BC%AF%E5%A4%AB%E7%8E%8B%E5%B0%94%E5%B1%B1/</guid><description></description></item><item><title>一句顶一万句-刘震云</title><link>https://yangyingchao.github.io/2025/12/%E7%AC%94%E8%AE%B0%E4%B8%80%E5%8F%A5%E9%A1%B6%E4%B8%80%E4%B8%87%E5%8F%A5-%E5%88%98%E9%9C%87%E4%BA%91/</link><pubDate>Wed, 31 Dec 2025 00:00:00 +0000</pubDate><author>yc</author><guid>https://yangyingchao.github.io/2025/12/%E7%AC%94%E8%AE%B0%E4%B8%80%E5%8F%A5%E9%A1%B6%E4%B8%80%E4%B8%87%E5%8F%A5-%E5%88%98%E9%9C%87%E4%BA%91/</guid><description></description></item><item><title>How SQLite Is Tested (SQLite 是怎么测试的)</title><link>https://yangyingchao.github.io/2025/12/how-sqlite-is-tested/</link><pubDate>Fri, 19 Dec 2025 00:00:00 +0000</pubDate><author>yc</author><guid>https://yangyingchao.github.io/2025/12/how-sqlite-is-tested/</guid><description><![CDATA[<div class="ox-hugo-toc toc has-section-numbers">
<div class="heading">Table of Contents</div>
<ul>
<li><span class="section-num">1</span> <a href="#introduction-%e7%ae%80%e4%bb%8b" rel="">Introduction 简介</a>
<ul>
<li><span class="section-num">1.1</span> <a href="#executive-summary-%e6%89%a7%e8%a1%8c%e6%91%98%e8%a6%81" rel="">Executive Summary 执行摘要</a></li>
</ul>
</li>
<li><span class="section-num">2</span> <a href="#test-harnesses-%e6%b5%8b%e8%af%95%e5%b7%a5%e5%85%b7%e5%a5%97%e4%bb%b6" rel="">Test Harnesses 测试工具套件</a></li>
<li><span class="section-num">3</span> <a href="#anomaly-testing-%e5%bc%82%e5%b8%b8%e6%b5%8b%e8%af%95" rel="">Anomaly Testing 异常测试</a>
<ul>
<li><span class="section-num">3.1</span> <a href="#out-of-memory-testing-%e5%86%85%e5%ad%98%e6%ba%a2%e5%87%ba%e6%b5%8b%e8%af%95" rel="">Out-Of-Memory Testing 内存溢出测试</a></li>
<li><span class="section-num">3.2</span> <a href="#i-o-error-testing-%e8%be%93%e5%85%a5-%e8%be%93%e5%87%ba%e9%94%99%e8%af%af%e6%b5%8b%e8%af%95" rel=""><span class="org-todo todo TODO">TODO</span> I/O Error Testing 输入/输出错误测试</a></li>
<li><span class="section-num">3.3</span> <a href="#crash-testing-%e5%b4%a9%e6%ba%83%e6%b5%8b%e8%af%95" rel="">Crash Testing 崩溃测试</a></li>
<li><span class="section-num">3.4</span> <a href="#compound-failure-tests-%e5%a4%8d%e5%90%88%e6%95%85%e9%9a%9c%e6%b5%8b%e8%af%95" rel="">Compound failure tests 复合故障测试</a></li>
</ul>
</li>
<li><span class="section-num">4</span> <a href="#fuzz-testing-%e6%a8%a1%e7%b3%8a%e6%b5%8b%e8%af%95" rel="">Fuzz Testing 模糊测试</a>
<ul>
<li><span class="section-num">4.1</span> <a href="#sql-fuzz" rel="">SQL Fuzz</a></li>
<li><span class="section-num">4.2</span> <a href="#malformed-database-files-%e6%a0%bc%e5%bc%8f%e9%94%99%e8%af%af%e7%9a%84%e6%95%b0%e6%8d%ae%e5%ba%93%e6%96%87%e4%bb%b6" rel="">Malformed Database Files 格式错误的数据库文件</a></li>
<li><span class="section-num">4.3</span> <a href="#boundary-value-tests-%e8%be%b9%e7%95%8c%e5%80%bc%e6%b5%8b%e8%af%95" rel="">Boundary Value Tests 边界值测试</a></li>
</ul>
</li>
<li><span class="section-num">5</span> <a href="#regression-testing-%e5%9b%9e%e5%bd%92%e6%b5%8b%e8%af%95" rel="">Regression Testing 回归测试</a></li>
<li><span class="section-num">6</span> <a href="#automatic-resource-leak-detection-%e8%87%aa%e5%8a%a8%e8%b5%84%e6%ba%90%e6%b3%84%e6%bc%8f%e6%a3%80%e6%b5%8b" rel="">Automatic Resource Leak Detection 自动资源泄漏检测</a></li>
<li><span class="section-num">7</span> <a href="#test-coverage-%e6%b5%8b%e8%af%95%e8%a6%86%e7%9b%96%e7%8e%87" rel="">Test Coverage 测试覆盖率</a>
<ul>
<li><span class="section-num">7.1</span> <a href="#statement-versus-branch-coverage-%e8%af%ad%e5%8f%a5%e8%a6%86%e7%9b%96%e7%8e%87%e4%b8%8e%e5%88%86%e6%94%af%e8%a6%86%e7%9b%96%e7%8e%87" rel="">Statement versus branch coverage 语句覆盖率与分支覆盖率</a></li>
<li><span class="section-num">7.2</span> <a href="#coverage-testing-of-defensive-code-%e9%98%b2%e5%be%a1%e6%80%a7%e4%bb%a3%e7%a0%81%e7%9a%84%e8%a6%86%e7%9b%96%e7%8e%87%e6%b5%8b%e8%af%95" rel="">Coverage testing of defensive code 防御性代码的覆盖率测试</a></li>
<li><span class="section-num">7.3</span> <a href="#forcing-coverage-of-boundary-values-and-boolean-vector-tests-%e5%bc%ba%e5%88%b6%e8%a6%86%e7%9b%96%e8%be%b9%e7%95%8c%e5%80%bc%e5%92%8c%e5%b8%83%e5%b0%94%e5%90%91%e9%87%8f%e6%b5%8b%e8%af%95" rel="">Forcing coverage of boundary values and boolean vector tests 强制覆盖边界值和布尔向量测试</a></li>
<li><span class="section-num">7.4</span> <a href="#%e5%88%86%e6%94%af%e8%a6%86%e7%9b%96%e7%8e%87%e4%b8%8e-mc-dc-%e8%a6%86%e7%9b%96%e7%8e%87%e6%af%94%e8%be%83" rel="">分支覆盖率与 MC/DC 覆盖率比较</a></li>
<li><span class="section-num">7.5</span> <a href="#%e6%b5%8b%e9%87%8f%e5%88%86%e6%94%af%e8%a6%86%e7%9b%96%e7%8e%87" rel="">测量分支覆盖率</a></li>
<li><span class="section-num">7.6</span> <a href="#%e5%8f%98%e5%bc%82%e6%b5%8b%e8%af%95" rel="">变异测试</a></li>
<li><span class="section-num">7.7</span> <a href="#%e5%ae%8c%e6%95%b4%e6%b5%8b%e8%af%95%e8%a6%86%e7%9b%96%e7%8e%87%e7%9a%84%e7%bb%8f%e9%aa%8c" rel="">完整测试覆盖率的经验</a></li>
</ul>
</li>
<li><span class="section-num">8</span> <a href="#%e5%8a%a8%e6%80%81%e5%88%86%e6%9e%90-dynamic-analysis" rel="">动态分析 Dynamic Analysis</a>
<ul>
<li><span class="section-num">8.1</span> <a href="#assert-%e6%96%ad%e8%a8%80" rel="">Assert 断言</a></li>
<li><span class="section-num">8.2</span> <a href="#valgrind" rel="">Valgrind</a></li>
<li><span class="section-num">8.3</span> <a href="#memsys2" rel="">Memsys2</a></li>
<li><span class="section-num">8.4</span> <a href="#mutex-asserts" rel="">Mutex Asserts</a></li>
<li><span class="section-num">8.5</span> <a href="#journal-tests" rel="">Journal Tests</a></li>
<li><span class="section-num">8.6</span> <a href="#undefined-behavior-checks" rel="">Undefined Behavior Checks</a></li>
</ul>
</li>
<li><span class="section-num">9</span> <a href="#%e7%a6%81%e7%94%a8%e4%bc%98%e5%8c%96%e6%b5%8b%e8%af%95-disabled-optimization-tests" rel="">禁用优化测试 Disabled Optimization Tests</a></li>
<li><span class="section-num">10</span> <a href="#checklists-%e6%a3%80%e6%9f%a5%e6%b8%85%e5%8d%95" rel="">Checklists 检查清单</a></li>
<li><span class="section-num">11</span> <a href="#static-analysis" rel="">Static Analysis</a></li>
<li><span class="section-num">12</span> <a href="#summary" rel="">Summary</a></li>
</ul>
</div>
<!--endtoc-->
<p>本文为摘录(或转载)，侵删，原文为：
-https://sqlite.org/testing.html#defcode
-https://sqlite.org/testing.html</p>]]></description></item><item><title>Failed to get D-Bus connection: Operation not permitted</title><link>https://yangyingchao.github.io/2025/12/failed-to-get-d-bus-connection-operation-not-permitted/</link><pubDate>Wed, 17 Dec 2025 00:00:00 +0000</pubDate><author>yc</author><guid>https://yangyingchao.github.io/2025/12/failed-to-get-d-bus-connection-operation-not-permitted/</guid><description><![CDATA[<p>when meet this wiered error inside docker, you may try:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-shell" data-lang="shell"><span class="line"><span class="cl">wget  https://raw.githubusercontent.com/gdraheim/docker-systemctl-replacement/master/files/docker/systemctl.py
</span></span><span class="line"><span class="cl">mv /usr/bin/systemctl /usr/bin/systemctl_bak
</span></span><span class="line"><span class="cl">mv systemctl.py /usr/bin/systemctl
</span></span></code></pre></td></tr></table>
</div>
</div><p>Content of systemctl.py:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">   1
</span><span class="lnt">   2
</span><span class="lnt">   3
</span><span class="lnt">   4
</span><span class="lnt">   5
</span><span class="lnt">   6
</span><span class="lnt">   7
</span><span class="lnt">   8
</span><span class="lnt">   9
</span><span class="lnt">  10
</span><span class="lnt">  11
</span><span class="lnt">  12
</span><span class="lnt">  13
</span><span class="lnt">  14
</span><span class="lnt">  15
</span><span class="lnt">  16
</span><span class="lnt">  17
</span><span class="lnt">  18
</span><span class="lnt">  19
</span><span class="lnt">  20
</span><span class="lnt">  21
</span><span class="lnt">  22
</span><span class="lnt">  23
</span><span class="lnt">  24
</span><span class="lnt">  25
</span><span class="lnt">  26
</span><span class="lnt">  27
</span><span class="lnt">  28
</span><span class="lnt">  29
</span><span class="lnt">  30
</span><span class="lnt">  31
</span><span class="lnt">  32
</span><span class="lnt">  33
</span><span class="lnt">  34
</span><span class="lnt">  35
</span><span class="lnt">  36
</span><span class="lnt">  37
</span><span class="lnt">  38
</span><span class="lnt">  39
</span><span class="lnt">  40
</span><span class="lnt">  41
</span><span class="lnt">  42
</span><span class="lnt">  43
</span><span class="lnt">  44
</span><span class="lnt">  45
</span><span class="lnt">  46
</span><span class="lnt">  47
</span><span class="lnt">  48
</span><span class="lnt">  49
</span><span class="lnt">  50
</span><span class="lnt">  51
</span><span class="lnt">  52
</span><span class="lnt">  53
</span><span class="lnt">  54
</span><span class="lnt">  55
</span><span class="lnt">  56
</span><span class="lnt">  57
</span><span class="lnt">  58
</span><span class="lnt">  59
</span><span class="lnt">  60
</span><span class="lnt">  61
</span><span class="lnt">  62
</span><span class="lnt">  63
</span><span class="lnt">  64
</span><span class="lnt">  65
</span><span class="lnt">  66
</span><span class="lnt">  67
</span><span class="lnt">  68
</span><span class="lnt">  69
</span><span class="lnt">  70
</span><span class="lnt">  71
</span><span class="lnt">  72
</span><span class="lnt">  73
</span><span class="lnt">  74
</span><span class="lnt">  75
</span><span class="lnt">  76
</span><span class="lnt">  77
</span><span class="lnt">  78
</span><span class="lnt">  79
</span><span class="lnt">  80
</span><span class="lnt">  81
</span><span class="lnt">  82
</span><span class="lnt">  83
</span><span class="lnt">  84
</span><span class="lnt">  85
</span><span class="lnt">  86
</span><span class="lnt">  87
</span><span class="lnt">  88
</span><span class="lnt">  89
</span><span class="lnt">  90
</span><span class="lnt">  91
</span><span class="lnt">  92
</span><span class="lnt">  93
</span><span class="lnt">  94
</span><span class="lnt">  95
</span><span class="lnt">  96
</span><span class="lnt">  97
</span><span class="lnt">  98
</span><span class="lnt">  99
</span><span class="lnt"> 100
</span><span class="lnt"> 101
</span><span class="lnt"> 102
</span><span class="lnt"> 103
</span><span class="lnt"> 104
</span><span class="lnt"> 105
</span><span class="lnt"> 106
</span><span class="lnt"> 107
</span><span class="lnt"> 108
</span><span class="lnt"> 109
</span><span class="lnt"> 110
</span><span class="lnt"> 111
</span><span class="lnt"> 112
</span><span class="lnt"> 113
</span><span class="lnt"> 114
</span><span class="lnt"> 115
</span><span class="lnt"> 116
</span><span class="lnt"> 117
</span><span class="lnt"> 118
</span><span class="lnt"> 119
</span><span class="lnt"> 120
</span><span class="lnt"> 121
</span><span class="lnt"> 122
</span><span class="lnt"> 123
</span><span class="lnt"> 124
</span><span class="lnt"> 125
</span><span class="lnt"> 126
</span><span class="lnt"> 127
</span><span class="lnt"> 128
</span><span class="lnt"> 129
</span><span class="lnt"> 130
</span><span class="lnt"> 131
</span><span class="lnt"> 132
</span><span class="lnt"> 133
</span><span class="lnt"> 134
</span><span class="lnt"> 135
</span><span class="lnt"> 136
</span><span class="lnt"> 137
</span><span class="lnt"> 138
</span><span class="lnt"> 139
</span><span class="lnt"> 140
</span><span class="lnt"> 141
</span><span class="lnt"> 142
</span><span class="lnt"> 143
</span><span class="lnt"> 144
</span><span class="lnt"> 145
</span><span class="lnt"> 146
</span><span class="lnt"> 147
</span><span class="lnt"> 148
</span><span class="lnt"> 149
</span><span class="lnt"> 150
</span><span class="lnt"> 151
</span><span class="lnt"> 152
</span><span class="lnt"> 153
</span><span class="lnt"> 154
</span><span class="lnt"> 155
</span><span class="lnt"> 156
</span><span class="lnt"> 157
</span><span class="lnt"> 158
</span><span class="lnt"> 159
</span><span class="lnt"> 160
</span><span class="lnt"> 161
</span><span class="lnt"> 162
</span><span class="lnt"> 163
</span><span class="lnt"> 164
</span><span class="lnt"> 165
</span><span class="lnt"> 166
</span><span class="lnt"> 167
</span><span class="lnt"> 168
</span><span class="lnt"> 169
</span><span class="lnt"> 170
</span><span class="lnt"> 171
</span><span class="lnt"> 172
</span><span class="lnt"> 173
</span><span class="lnt"> 174
</span><span class="lnt"> 175
</span><span class="lnt"> 176
</span><span class="lnt"> 177
</span><span class="lnt"> 178
</span><span class="lnt"> 179
</span><span class="lnt"> 180
</span><span class="lnt"> 181
</span><span class="lnt"> 182
</span><span class="lnt"> 183
</span><span class="lnt"> 184
</span><span class="lnt"> 185
</span><span class="lnt"> 186
</span><span class="lnt"> 187
</span><span class="lnt"> 188
</span><span class="lnt"> 189
</span><span class="lnt"> 190
</span><span class="lnt"> 191
</span><span class="lnt"> 192
</span><span class="lnt"> 193
</span><span class="lnt"> 194
</span><span class="lnt"> 195
</span><span class="lnt"> 196
</span><span class="lnt"> 197
</span><span class="lnt"> 198
</span><span class="lnt"> 199
</span><span class="lnt"> 200
</span><span class="lnt"> 201
</span><span class="lnt"> 202
</span><span class="lnt"> 203
</span><span class="lnt"> 204
</span><span class="lnt"> 205
</span><span class="lnt"> 206
</span><span class="lnt"> 207
</span><span class="lnt"> 208
</span><span class="lnt"> 209
</span><span class="lnt"> 210
</span><span class="lnt"> 211
</span><span class="lnt"> 212
</span><span class="lnt"> 213
</span><span class="lnt"> 214
</span><span class="lnt"> 215
</span><span class="lnt"> 216
</span><span class="lnt"> 217
</span><span class="lnt"> 218
</span><span class="lnt"> 219
</span><span class="lnt"> 220
</span><span class="lnt"> 221
</span><span class="lnt"> 222
</span><span class="lnt"> 223
</span><span class="lnt"> 224
</span><span class="lnt"> 225
</span><span class="lnt"> 226
</span><span class="lnt"> 227
</span><span class="lnt"> 228
</span><span class="lnt"> 229
</span><span class="lnt"> 230
</span><span class="lnt"> 231
</span><span class="lnt"> 232
</span><span class="lnt"> 233
</span><span class="lnt"> 234
</span><span class="lnt"> 235
</span><span class="lnt"> 236
</span><span class="lnt"> 237
</span><span class="lnt"> 238
</span><span class="lnt"> 239
</span><span class="lnt"> 240
</span><span class="lnt"> 241
</span><span class="lnt"> 242
</span><span class="lnt"> 243
</span><span class="lnt"> 244
</span><span class="lnt"> 245
</span><span class="lnt"> 246
</span><span class="lnt"> 247
</span><span class="lnt"> 248
</span><span class="lnt"> 249
</span><span class="lnt"> 250
</span><span class="lnt"> 251
</span><span class="lnt"> 252
</span><span class="lnt"> 253
</span><span class="lnt"> 254
</span><span class="lnt"> 255
</span><span class="lnt"> 256
</span><span class="lnt"> 257
</span><span class="lnt"> 258
</span><span class="lnt"> 259
</span><span class="lnt"> 260
</span><span class="lnt"> 261
</span><span class="lnt"> 262
</span><span class="lnt"> 263
</span><span class="lnt"> 264
</span><span class="lnt"> 265
</span><span class="lnt"> 266
</span><span class="lnt"> 267
</span><span class="lnt"> 268
</span><span class="lnt"> 269
</span><span class="lnt"> 270
</span><span class="lnt"> 271
</span><span class="lnt"> 272
</span><span class="lnt"> 273
</span><span class="lnt"> 274
</span><span class="lnt"> 275
</span><span class="lnt"> 276
</span><span class="lnt"> 277
</span><span class="lnt"> 278
</span><span class="lnt"> 279
</span><span class="lnt"> 280
</span><span class="lnt"> 281
</span><span class="lnt"> 282
</span><span class="lnt"> 283
</span><span class="lnt"> 284
</span><span class="lnt"> 285
</span><span class="lnt"> 286
</span><span class="lnt"> 287
</span><span class="lnt"> 288
</span><span class="lnt"> 289
</span><span class="lnt"> 290
</span><span class="lnt"> 291
</span><span class="lnt"> 292
</span><span class="lnt"> 293
</span><span class="lnt"> 294
</span><span class="lnt"> 295
</span><span class="lnt"> 296
</span><span class="lnt"> 297
</span><span class="lnt"> 298
</span><span class="lnt"> 299
</span><span class="lnt"> 300
</span><span class="lnt"> 301
</span><span class="lnt"> 302
</span><span class="lnt"> 303
</span><span class="lnt"> 304
</span><span class="lnt"> 305
</span><span class="lnt"> 306
</span><span class="lnt"> 307
</span><span class="lnt"> 308
</span><span class="lnt"> 309
</span><span class="lnt"> 310
</span><span class="lnt"> 311
</span><span class="lnt"> 312
</span><span class="lnt"> 313
</span><span class="lnt"> 314
</span><span class="lnt"> 315
</span><span class="lnt"> 316
</span><span class="lnt"> 317
</span><span class="lnt"> 318
</span><span class="lnt"> 319
</span><span class="lnt"> 320
</span><span class="lnt"> 321
</span><span class="lnt"> 322
</span><span class="lnt"> 323
</span><span class="lnt"> 324
</span><span class="lnt"> 325
</span><span class="lnt"> 326
</span><span class="lnt"> 327
</span><span class="lnt"> 328
</span><span class="lnt"> 329
</span><span class="lnt"> 330
</span><span class="lnt"> 331
</span><span class="lnt"> 332
</span><span class="lnt"> 333
</span><span class="lnt"> 334
</span><span class="lnt"> 335
</span><span class="lnt"> 336
</span><span class="lnt"> 337
</span><span class="lnt"> 338
</span><span class="lnt"> 339
</span><span class="lnt"> 340
</span><span class="lnt"> 341
</span><span class="lnt"> 342
</span><span class="lnt"> 343
</span><span class="lnt"> 344
</span><span class="lnt"> 345
</span><span class="lnt"> 346
</span><span class="lnt"> 347
</span><span class="lnt"> 348
</span><span class="lnt"> 349
</span><span class="lnt"> 350
</span><span class="lnt"> 351
</span><span class="lnt"> 352
</span><span class="lnt"> 353
</span><span class="lnt"> 354
</span><span class="lnt"> 355
</span><span class="lnt"> 356
</span><span class="lnt"> 357
</span><span class="lnt"> 358
</span><span class="lnt"> 359
</span><span class="lnt"> 360
</span><span class="lnt"> 361
</span><span class="lnt"> 362
</span><span class="lnt"> 363
</span><span class="lnt"> 364
</span><span class="lnt"> 365
</span><span class="lnt"> 366
</span><span class="lnt"> 367
</span><span class="lnt"> 368
</span><span class="lnt"> 369
</span><span class="lnt"> 370
</span><span class="lnt"> 371
</span><span class="lnt"> 372
</span><span class="lnt"> 373
</span><span class="lnt"> 374
</span><span class="lnt"> 375
</span><span class="lnt"> 376
</span><span class="lnt"> 377
</span><span class="lnt"> 378
</span><span class="lnt"> 379
</span><span class="lnt"> 380
</span><span class="lnt"> 381
</span><span class="lnt"> 382
</span><span class="lnt"> 383
</span><span class="lnt"> 384
</span><span class="lnt"> 385
</span><span class="lnt"> 386
</span><span class="lnt"> 387
</span><span class="lnt"> 388
</span><span class="lnt"> 389
</span><span class="lnt"> 390
</span><span class="lnt"> 391
</span><span class="lnt"> 392
</span><span class="lnt"> 393
</span><span class="lnt"> 394
</span><span class="lnt"> 395
</span><span class="lnt"> 396
</span><span class="lnt"> 397
</span><span class="lnt"> 398
</span><span class="lnt"> 399
</span><span class="lnt"> 400
</span><span class="lnt"> 401
</span><span class="lnt"> 402
</span><span class="lnt"> 403
</span><span class="lnt"> 404
</span><span class="lnt"> 405
</span><span class="lnt"> 406
</span><span class="lnt"> 407
</span><span class="lnt"> 408
</span><span class="lnt"> 409
</span><span class="lnt"> 410
</span><span class="lnt"> 411
</span><span class="lnt"> 412
</span><span class="lnt"> 413
</span><span class="lnt"> 414
</span><span class="lnt"> 415
</span><span class="lnt"> 416
</span><span class="lnt"> 417
</span><span class="lnt"> 418
</span><span class="lnt"> 419
</span><span class="lnt"> 420
</span><span class="lnt"> 421
</span><span class="lnt"> 422
</span><span class="lnt"> 423
</span><span class="lnt"> 424
</span><span class="lnt"> 425
</span><span class="lnt"> 426
</span><span class="lnt"> 427
</span><span class="lnt"> 428
</span><span class="lnt"> 429
</span><span class="lnt"> 430
</span><span class="lnt"> 431
</span><span class="lnt"> 432
</span><span class="lnt"> 433
</span><span class="lnt"> 434
</span><span class="lnt"> 435
</span><span class="lnt"> 436
</span><span class="lnt"> 437
</span><span class="lnt"> 438
</span><span class="lnt"> 439
</span><span class="lnt"> 440
</span><span class="lnt"> 441
</span><span class="lnt"> 442
</span><span class="lnt"> 443
</span><span class="lnt"> 444
</span><span class="lnt"> 445
</span><span class="lnt"> 446
</span><span class="lnt"> 447
</span><span class="lnt"> 448
</span><span class="lnt"> 449
</span><span class="lnt"> 450
</span><span class="lnt"> 451
</span><span class="lnt"> 452
</span><span class="lnt"> 453
</span><span class="lnt"> 454
</span><span class="lnt"> 455
</span><span class="lnt"> 456
</span><span class="lnt"> 457
</span><span class="lnt"> 458
</span><span class="lnt"> 459
</span><span class="lnt"> 460
</span><span class="lnt"> 461
</span><span class="lnt"> 462
</span><span class="lnt"> 463
</span><span class="lnt"> 464
</span><span class="lnt"> 465
</span><span class="lnt"> 466
</span><span class="lnt"> 467
</span><span class="lnt"> 468
</span><span class="lnt"> 469
</span><span class="lnt"> 470
</span><span class="lnt"> 471
</span><span class="lnt"> 472
</span><span class="lnt"> 473
</span><span class="lnt"> 474
</span><span class="lnt"> 475
</span><span class="lnt"> 476
</span><span class="lnt"> 477
</span><span class="lnt"> 478
</span><span class="lnt"> 479
</span><span class="lnt"> 480
</span><span class="lnt"> 481
</span><span class="lnt"> 482
</span><span class="lnt"> 483
</span><span class="lnt"> 484
</span><span class="lnt"> 485
</span><span class="lnt"> 486
</span><span class="lnt"> 487
</span><span class="lnt"> 488
</span><span class="lnt"> 489
</span><span class="lnt"> 490
</span><span class="lnt"> 491
</span><span class="lnt"> 492
</span><span class="lnt"> 493
</span><span class="lnt"> 494
</span><span class="lnt"> 495
</span><span class="lnt"> 496
</span><span class="lnt"> 497
</span><span class="lnt"> 498
</span><span class="lnt"> 499
</span><span class="lnt"> 500
</span><span class="lnt"> 501
</span><span class="lnt"> 502
</span><span class="lnt"> 503
</span><span class="lnt"> 504
</span><span class="lnt"> 505
</span><span class="lnt"> 506
</span><span class="lnt"> 507
</span><span class="lnt"> 508
</span><span class="lnt"> 509
</span><span class="lnt"> 510
</span><span class="lnt"> 511
</span><span class="lnt"> 512
</span><span class="lnt"> 513
</span><span class="lnt"> 514
</span><span class="lnt"> 515
</span><span class="lnt"> 516
</span><span class="lnt"> 517
</span><span class="lnt"> 518
</span><span class="lnt"> 519
</span><span class="lnt"> 520
</span><span class="lnt"> 521
</span><span class="lnt"> 522
</span><span class="lnt"> 523
</span><span class="lnt"> 524
</span><span class="lnt"> 525
</span><span class="lnt"> 526
</span><span class="lnt"> 527
</span><span class="lnt"> 528
</span><span class="lnt"> 529
</span><span class="lnt"> 530
</span><span class="lnt"> 531
</span><span class="lnt"> 532
</span><span class="lnt"> 533
</span><span class="lnt"> 534
</span><span class="lnt"> 535
</span><span class="lnt"> 536
</span><span class="lnt"> 537
</span><span class="lnt"> 538
</span><span class="lnt"> 539
</span><span class="lnt"> 540
</span><span class="lnt"> 541
</span><span class="lnt"> 542
</span><span class="lnt"> 543
</span><span class="lnt"> 544
</span><span class="lnt"> 545
</span><span class="lnt"> 546
</span><span class="lnt"> 547
</span><span class="lnt"> 548
</span><span class="lnt"> 549
</span><span class="lnt"> 550
</span><span class="lnt"> 551
</span><span class="lnt"> 552
</span><span class="lnt"> 553
</span><span class="lnt"> 554
</span><span class="lnt"> 555
</span><span class="lnt"> 556
</span><span class="lnt"> 557
</span><span class="lnt"> 558
</span><span class="lnt"> 559
</span><span class="lnt"> 560
</span><span class="lnt"> 561
</span><span class="lnt"> 562
</span><span class="lnt"> 563
</span><span class="lnt"> 564
</span><span class="lnt"> 565
</span><span class="lnt"> 566
</span><span class="lnt"> 567
</span><span class="lnt"> 568
</span><span class="lnt"> 569
</span><span class="lnt"> 570
</span><span class="lnt"> 571
</span><span class="lnt"> 572
</span><span class="lnt"> 573
</span><span class="lnt"> 574
</span><span class="lnt"> 575
</span><span class="lnt"> 576
</span><span class="lnt"> 577
</span><span class="lnt"> 578
</span><span class="lnt"> 579
</span><span class="lnt"> 580
</span><span class="lnt"> 581
</span><span class="lnt"> 582
</span><span class="lnt"> 583
</span><span class="lnt"> 584
</span><span class="lnt"> 585
</span><span class="lnt"> 586
</span><span class="lnt"> 587
</span><span class="lnt"> 588
</span><span class="lnt"> 589
</span><span class="lnt"> 590
</span><span class="lnt"> 591
</span><span class="lnt"> 592
</span><span class="lnt"> 593
</span><span class="lnt"> 594
</span><span class="lnt"> 595
</span><span class="lnt"> 596
</span><span class="lnt"> 597
</span><span class="lnt"> 598
</span><span class="lnt"> 599
</span><span class="lnt"> 600
</span><span class="lnt"> 601
</span><span class="lnt"> 602
</span><span class="lnt"> 603
</span><span class="lnt"> 604
</span><span class="lnt"> 605
</span><span class="lnt"> 606
</span><span class="lnt"> 607
</span><span class="lnt"> 608
</span><span class="lnt"> 609
</span><span class="lnt"> 610
</span><span class="lnt"> 611
</span><span class="lnt"> 612
</span><span class="lnt"> 613
</span><span class="lnt"> 614
</span><span class="lnt"> 615
</span><span class="lnt"> 616
</span><span class="lnt"> 617
</span><span class="lnt"> 618
</span><span class="lnt"> 619
</span><span class="lnt"> 620
</span><span class="lnt"> 621
</span><span class="lnt"> 622
</span><span class="lnt"> 623
</span><span class="lnt"> 624
</span><span class="lnt"> 625
</span><span class="lnt"> 626
</span><span class="lnt"> 627
</span><span class="lnt"> 628
</span><span class="lnt"> 629
</span><span class="lnt"> 630
</span><span class="lnt"> 631
</span><span class="lnt"> 632
</span><span class="lnt"> 633
</span><span class="lnt"> 634
</span><span class="lnt"> 635
</span><span class="lnt"> 636
</span><span class="lnt"> 637
</span><span class="lnt"> 638
</span><span class="lnt"> 639
</span><span class="lnt"> 640
</span><span class="lnt"> 641
</span><span class="lnt"> 642
</span><span class="lnt"> 643
</span><span class="lnt"> 644
</span><span class="lnt"> 645
</span><span class="lnt"> 646
</span><span class="lnt"> 647
</span><span class="lnt"> 648
</span><span class="lnt"> 649
</span><span class="lnt"> 650
</span><span class="lnt"> 651
</span><span class="lnt"> 652
</span><span class="lnt"> 653
</span><span class="lnt"> 654
</span><span class="lnt"> 655
</span><span class="lnt"> 656
</span><span class="lnt"> 657
</span><span class="lnt"> 658
</span><span class="lnt"> 659
</span><span class="lnt"> 660
</span><span class="lnt"> 661
</span><span class="lnt"> 662
</span><span class="lnt"> 663
</span><span class="lnt"> 664
</span><span class="lnt"> 665
</span><span class="lnt"> 666
</span><span class="lnt"> 667
</span><span class="lnt"> 668
</span><span class="lnt"> 669
</span><span class="lnt"> 670
</span><span class="lnt"> 671
</span><span class="lnt"> 672
</span><span class="lnt"> 673
</span><span class="lnt"> 674
</span><span class="lnt"> 675
</span><span class="lnt"> 676
</span><span class="lnt"> 677
</span><span class="lnt"> 678
</span><span class="lnt"> 679
</span><span class="lnt"> 680
</span><span class="lnt"> 681
</span><span class="lnt"> 682
</span><span class="lnt"> 683
</span><span class="lnt"> 684
</span><span class="lnt"> 685
</span><span class="lnt"> 686
</span><span class="lnt"> 687
</span><span class="lnt"> 688
</span><span class="lnt"> 689
</span><span class="lnt"> 690
</span><span class="lnt"> 691
</span><span class="lnt"> 692
</span><span class="lnt"> 693
</span><span class="lnt"> 694
</span><span class="lnt"> 695
</span><span class="lnt"> 696
</span><span class="lnt"> 697
</span><span class="lnt"> 698
</span><span class="lnt"> 699
</span><span class="lnt"> 700
</span><span class="lnt"> 701
</span><span class="lnt"> 702
</span><span class="lnt"> 703
</span><span class="lnt"> 704
</span><span class="lnt"> 705
</span><span class="lnt"> 706
</span><span class="lnt"> 707
</span><span class="lnt"> 708
</span><span class="lnt"> 709
</span><span class="lnt"> 710
</span><span class="lnt"> 711
</span><span class="lnt"> 712
</span><span class="lnt"> 713
</span><span class="lnt"> 714
</span><span class="lnt"> 715
</span><span class="lnt"> 716
</span><span class="lnt"> 717
</span><span class="lnt"> 718
</span><span class="lnt"> 719
</span><span class="lnt"> 720
</span><span class="lnt"> 721
</span><span class="lnt"> 722
</span><span class="lnt"> 723
</span><span class="lnt"> 724
</span><span class="lnt"> 725
</span><span class="lnt"> 726
</span><span class="lnt"> 727
</span><span class="lnt"> 728
</span><span class="lnt"> 729
</span><span class="lnt"> 730
</span><span class="lnt"> 731
</span><span class="lnt"> 732
</span><span class="lnt"> 733
</span><span class="lnt"> 734
</span><span class="lnt"> 735
</span><span class="lnt"> 736
</span><span class="lnt"> 737
</span><span class="lnt"> 738
</span><span class="lnt"> 739
</span><span class="lnt"> 740
</span><span class="lnt"> 741
</span><span class="lnt"> 742
</span><span class="lnt"> 743
</span><span class="lnt"> 744
</span><span class="lnt"> 745
</span><span class="lnt"> 746
</span><span class="lnt"> 747
</span><span class="lnt"> 748
</span><span class="lnt"> 749
</span><span class="lnt"> 750
</span><span class="lnt"> 751
</span><span class="lnt"> 752
</span><span class="lnt"> 753
</span><span class="lnt"> 754
</span><span class="lnt"> 755
</span><span class="lnt"> 756
</span><span class="lnt"> 757
</span><span class="lnt"> 758
</span><span class="lnt"> 759
</span><span class="lnt"> 760
</span><span class="lnt"> 761
</span><span class="lnt"> 762
</span><span class="lnt"> 763
</span><span class="lnt"> 764
</span><span class="lnt"> 765
</span><span class="lnt"> 766
</span><span class="lnt"> 767
</span><span class="lnt"> 768
</span><span class="lnt"> 769
</span><span class="lnt"> 770
</span><span class="lnt"> 771
</span><span class="lnt"> 772
</span><span class="lnt"> 773
</span><span class="lnt"> 774
</span><span class="lnt"> 775
</span><span class="lnt"> 776
</span><span class="lnt"> 777
</span><span class="lnt"> 778
</span><span class="lnt"> 779
</span><span class="lnt"> 780
</span><span class="lnt"> 781
</span><span class="lnt"> 782
</span><span class="lnt"> 783
</span><span class="lnt"> 784
</span><span class="lnt"> 785
</span><span class="lnt"> 786
</span><span class="lnt"> 787
</span><span class="lnt"> 788
</span><span class="lnt"> 789
</span><span class="lnt"> 790
</span><span class="lnt"> 791
</span><span class="lnt"> 792
</span><span class="lnt"> 793
</span><span class="lnt"> 794
</span><span class="lnt"> 795
</span><span class="lnt"> 796
</span><span class="lnt"> 797
</span><span class="lnt"> 798
</span><span class="lnt"> 799
</span><span class="lnt"> 800
</span><span class="lnt"> 801
</span><span class="lnt"> 802
</span><span class="lnt"> 803
</span><span class="lnt"> 804
</span><span class="lnt"> 805
</span><span class="lnt"> 806
</span><span class="lnt"> 807
</span><span class="lnt"> 808
</span><span class="lnt"> 809
</span><span class="lnt"> 810
</span><span class="lnt"> 811
</span><span class="lnt"> 812
</span><span class="lnt"> 813
</span><span class="lnt"> 814
</span><span class="lnt"> 815
</span><span class="lnt"> 816
</span><span class="lnt"> 817
</span><span class="lnt"> 818
</span><span class="lnt"> 819
</span><span class="lnt"> 820
</span><span class="lnt"> 821
</span><span class="lnt"> 822
</span><span class="lnt"> 823
</span><span class="lnt"> 824
</span><span class="lnt"> 825
</span><span class="lnt"> 826
</span><span class="lnt"> 827
</span><span class="lnt"> 828
</span><span class="lnt"> 829
</span><span class="lnt"> 830
</span><span class="lnt"> 831
</span><span class="lnt"> 832
</span><span class="lnt"> 833
</span><span class="lnt"> 834
</span><span class="lnt"> 835
</span><span class="lnt"> 836
</span><span class="lnt"> 837
</span><span class="lnt"> 838
</span><span class="lnt"> 839
</span><span class="lnt"> 840
</span><span class="lnt"> 841
</span><span class="lnt"> 842
</span><span class="lnt"> 843
</span><span class="lnt"> 844
</span><span class="lnt"> 845
</span><span class="lnt"> 846
</span><span class="lnt"> 847
</span><span class="lnt"> 848
</span><span class="lnt"> 849
</span><span class="lnt"> 850
</span><span class="lnt"> 851
</span><span class="lnt"> 852
</span><span class="lnt"> 853
</span><span class="lnt"> 854
</span><span class="lnt"> 855
</span><span class="lnt"> 856
</span><span class="lnt"> 857
</span><span class="lnt"> 858
</span><span class="lnt"> 859
</span><span class="lnt"> 860
</span><span class="lnt"> 861
</span><span class="lnt"> 862
</span><span class="lnt"> 863
</span><span class="lnt"> 864
</span><span class="lnt"> 865
</span><span class="lnt"> 866
</span><span class="lnt"> 867
</span><span class="lnt"> 868
</span><span class="lnt"> 869
</span><span class="lnt"> 870
</span><span class="lnt"> 871
</span><span class="lnt"> 872
</span><span class="lnt"> 873
</span><span class="lnt"> 874
</span><span class="lnt"> 875
</span><span class="lnt"> 876
</span><span class="lnt"> 877
</span><span class="lnt"> 878
</span><span class="lnt"> 879
</span><span class="lnt"> 880
</span><span class="lnt"> 881
</span><span class="lnt"> 882
</span><span class="lnt"> 883
</span><span class="lnt"> 884
</span><span class="lnt"> 885
</span><span class="lnt"> 886
</span><span class="lnt"> 887
</span><span class="lnt"> 888
</span><span class="lnt"> 889
</span><span class="lnt"> 890
</span><span class="lnt"> 891
</span><span class="lnt"> 892
</span><span class="lnt"> 893
</span><span class="lnt"> 894
</span><span class="lnt"> 895
</span><span class="lnt"> 896
</span><span class="lnt"> 897
</span><span class="lnt"> 898
</span><span class="lnt"> 899
</span><span class="lnt"> 900
</span><span class="lnt"> 901
</span><span class="lnt"> 902
</span><span class="lnt"> 903
</span><span class="lnt"> 904
</span><span class="lnt"> 905
</span><span class="lnt"> 906
</span><span class="lnt"> 907
</span><span class="lnt"> 908
</span><span class="lnt"> 909
</span><span class="lnt"> 910
</span><span class="lnt"> 911
</span><span class="lnt"> 912
</span><span class="lnt"> 913
</span><span class="lnt"> 914
</span><span class="lnt"> 915
</span><span class="lnt"> 916
</span><span class="lnt"> 917
</span><span class="lnt"> 918
</span><span class="lnt"> 919
</span><span class="lnt"> 920
</span><span class="lnt"> 921
</span><span class="lnt"> 922
</span><span class="lnt"> 923
</span><span class="lnt"> 924
</span><span class="lnt"> 925
</span><span class="lnt"> 926
</span><span class="lnt"> 927
</span><span class="lnt"> 928
</span><span class="lnt"> 929
</span><span class="lnt"> 930
</span><span class="lnt"> 931
</span><span class="lnt"> 932
</span><span class="lnt"> 933
</span><span class="lnt"> 934
</span><span class="lnt"> 935
</span><span class="lnt"> 936
</span><span class="lnt"> 937
</span><span class="lnt"> 938
</span><span class="lnt"> 939
</span><span class="lnt"> 940
</span><span class="lnt"> 941
</span><span class="lnt"> 942
</span><span class="lnt"> 943
</span><span class="lnt"> 944
</span><span class="lnt"> 945
</span><span class="lnt"> 946
</span><span class="lnt"> 947
</span><span class="lnt"> 948
</span><span class="lnt"> 949
</span><span class="lnt"> 950
</span><span class="lnt"> 951
</span><span class="lnt"> 952
</span><span class="lnt"> 953
</span><span class="lnt"> 954
</span><span class="lnt"> 955
</span><span class="lnt"> 956
</span><span class="lnt"> 957
</span><span class="lnt"> 958
</span><span class="lnt"> 959
</span><span class="lnt"> 960
</span><span class="lnt"> 961
</span><span class="lnt"> 962
</span><span class="lnt"> 963
</span><span class="lnt"> 964
</span><span class="lnt"> 965
</span><span class="lnt"> 966
</span><span class="lnt"> 967
</span><span class="lnt"> 968
</span><span class="lnt"> 969
</span><span class="lnt"> 970
</span><span class="lnt"> 971
</span><span class="lnt"> 972
</span><span class="lnt"> 973
</span><span class="lnt"> 974
</span><span class="lnt"> 975
</span><span class="lnt"> 976
</span><span class="lnt"> 977
</span><span class="lnt"> 978
</span><span class="lnt"> 979
</span><span class="lnt"> 980
</span><span class="lnt"> 981
</span><span class="lnt"> 982
</span><span class="lnt"> 983
</span><span class="lnt"> 984
</span><span class="lnt"> 985
</span><span class="lnt"> 986
</span><span class="lnt"> 987
</span><span class="lnt"> 988
</span><span class="lnt"> 989
</span><span class="lnt"> 990
</span><span class="lnt"> 991
</span><span class="lnt"> 992
</span><span class="lnt"> 993
</span><span class="lnt"> 994
</span><span class="lnt"> 995
</span><span class="lnt"> 996
</span><span class="lnt"> 997
</span><span class="lnt"> 998
</span><span class="lnt"> 999
</span><span class="lnt">1000
</span><span class="lnt">1001
</span><span class="lnt">1002
</span><span class="lnt">1003
</span><span class="lnt">1004
</span><span class="lnt">1005
</span><span class="lnt">1006
</span><span class="lnt">1007
</span><span class="lnt">1008
</span><span class="lnt">1009
</span><span class="lnt">1010
</span><span class="lnt">1011
</span><span class="lnt">1012
</span><span class="lnt">1013
</span><span class="lnt">1014
</span><span class="lnt">1015
</span><span class="lnt">1016
</span><span class="lnt">1017
</span><span class="lnt">1018
</span><span class="lnt">1019
</span><span class="lnt">1020
</span><span class="lnt">1021
</span><span class="lnt">1022
</span><span class="lnt">1023
</span><span class="lnt">1024
</span><span class="lnt">1025
</span><span class="lnt">1026
</span><span class="lnt">1027
</span><span class="lnt">1028
</span><span class="lnt">1029
</span><span class="lnt">1030
</span><span class="lnt">1031
</span><span class="lnt">1032
</span><span class="lnt">1033
</span><span class="lnt">1034
</span><span class="lnt">1035
</span><span class="lnt">1036
</span><span class="lnt">1037
</span><span class="lnt">1038
</span><span class="lnt">1039
</span><span class="lnt">1040
</span><span class="lnt">1041
</span><span class="lnt">1042
</span><span class="lnt">1043
</span><span class="lnt">1044
</span><span class="lnt">1045
</span><span class="lnt">1046
</span><span class="lnt">1047
</span><span class="lnt">1048
</span><span class="lnt">1049
</span><span class="lnt">1050
</span><span class="lnt">1051
</span><span class="lnt">1052
</span><span class="lnt">1053
</span><span class="lnt">1054
</span><span class="lnt">1055
</span><span class="lnt">1056
</span><span class="lnt">1057
</span><span class="lnt">1058
</span><span class="lnt">1059
</span><span class="lnt">1060
</span><span class="lnt">1061
</span><span class="lnt">1062
</span><span class="lnt">1063
</span><span class="lnt">1064
</span><span class="lnt">1065
</span><span class="lnt">1066
</span><span class="lnt">1067
</span><span class="lnt">1068
</span><span class="lnt">1069
</span><span class="lnt">1070
</span><span class="lnt">1071
</span><span class="lnt">1072
</span><span class="lnt">1073
</span><span class="lnt">1074
</span><span class="lnt">1075
</span><span class="lnt">1076
</span><span class="lnt">1077
</span><span class="lnt">1078
</span><span class="lnt">1079
</span><span class="lnt">1080
</span><span class="lnt">1081
</span><span class="lnt">1082
</span><span class="lnt">1083
</span><span class="lnt">1084
</span><span class="lnt">1085
</span><span class="lnt">1086
</span><span class="lnt">1087
</span><span class="lnt">1088
</span><span class="lnt">1089
</span><span class="lnt">1090
</span><span class="lnt">1091
</span><span class="lnt">1092
</span><span class="lnt">1093
</span><span class="lnt">1094
</span><span class="lnt">1095
</span><span class="lnt">1096
</span><span class="lnt">1097
</span><span class="lnt">1098
</span><span class="lnt">1099
</span><span class="lnt">1100
</span><span class="lnt">1101
</span><span class="lnt">1102
</span><span class="lnt">1103
</span><span class="lnt">1104
</span><span class="lnt">1105
</span><span class="lnt">1106
</span><span class="lnt">1107
</span><span class="lnt">1108
</span><span class="lnt">1109
</span><span class="lnt">1110
</span><span class="lnt">1111
</span><span class="lnt">1112
</span><span class="lnt">1113
</span><span class="lnt">1114
</span><span class="lnt">1115
</span><span class="lnt">1116
</span><span class="lnt">1117
</span><span class="lnt">1118
</span><span class="lnt">1119
</span><span class="lnt">1120
</span><span class="lnt">1121
</span><span class="lnt">1122
</span><span class="lnt">1123
</span><span class="lnt">1124
</span><span class="lnt">1125
</span><span class="lnt">1126
</span><span class="lnt">1127
</span><span class="lnt">1128
</span><span class="lnt">1129
</span><span class="lnt">1130
</span><span class="lnt">1131
</span><span class="lnt">1132
</span><span class="lnt">1133
</span><span class="lnt">1134
</span><span class="lnt">1135
</span><span class="lnt">1136
</span><span class="lnt">1137
</span><span class="lnt">1138
</span><span class="lnt">1139
</span><span class="lnt">1140
</span><span class="lnt">1141
</span><span class="lnt">1142
</span><span class="lnt">1143
</span><span class="lnt">1144
</span><span class="lnt">1145
</span><span class="lnt">1146
</span><span class="lnt">1147
</span><span class="lnt">1148
</span><span class="lnt">1149
</span><span class="lnt">1150
</span><span class="lnt">1151
</span><span class="lnt">1152
</span><span class="lnt">1153
</span><span class="lnt">1154
</span><span class="lnt">1155
</span><span class="lnt">1156
</span><span class="lnt">1157
</span><span class="lnt">1158
</span><span class="lnt">1159
</span><span class="lnt">1160
</span><span class="lnt">1161
</span><span class="lnt">1162
</span><span class="lnt">1163
</span><span class="lnt">1164
</span><span class="lnt">1165
</span><span class="lnt">1166
</span><span class="lnt">1167
</span><span class="lnt">1168
</span><span class="lnt">1169
</span><span class="lnt">1170
</span><span class="lnt">1171
</span><span class="lnt">1172
</span><span class="lnt">1173
</span><span class="lnt">1174
</span><span class="lnt">1175
</span><span class="lnt">1176
</span><span class="lnt">1177
</span><span class="lnt">1178
</span><span class="lnt">1179
</span><span class="lnt">1180
</span><span class="lnt">1181
</span><span class="lnt">1182
</span><span class="lnt">1183
</span><span class="lnt">1184
</span><span class="lnt">1185
</span><span class="lnt">1186
</span><span class="lnt">1187
</span><span class="lnt">1188
</span><span class="lnt">1189
</span><span class="lnt">1190
</span><span class="lnt">1191
</span><span class="lnt">1192
</span><span class="lnt">1193
</span><span class="lnt">1194
</span><span class="lnt">1195
</span><span class="lnt">1196
</span><span class="lnt">1197
</span><span class="lnt">1198
</span><span class="lnt">1199
</span><span class="lnt">1200
</span><span class="lnt">1201
</span><span class="lnt">1202
</span><span class="lnt">1203
</span><span class="lnt">1204
</span><span class="lnt">1205
</span><span class="lnt">1206
</span><span class="lnt">1207
</span><span class="lnt">1208
</span><span class="lnt">1209
</span><span class="lnt">1210
</span><span class="lnt">1211
</span><span class="lnt">1212
</span><span class="lnt">1213
</span><span class="lnt">1214
</span><span class="lnt">1215
</span><span class="lnt">1216
</span><span class="lnt">1217
</span><span class="lnt">1218
</span><span class="lnt">1219
</span><span class="lnt">1220
</span><span class="lnt">1221
</span><span class="lnt">1222
</span><span class="lnt">1223
</span><span class="lnt">1224
</span><span class="lnt">1225
</span><span class="lnt">1226
</span><span class="lnt">1227
</span><span class="lnt">1228
</span><span class="lnt">1229
</span><span class="lnt">1230
</span><span class="lnt">1231
</span><span class="lnt">1232
</span><span class="lnt">1233
</span><span class="lnt">1234
</span><span class="lnt">1235
</span><span class="lnt">1236
</span><span class="lnt">1237
</span><span class="lnt">1238
</span><span class="lnt">1239
</span><span class="lnt">1240
</span><span class="lnt">1241
</span><span class="lnt">1242
</span><span class="lnt">1243
</span><span class="lnt">1244
</span><span class="lnt">1245
</span><span class="lnt">1246
</span><span class="lnt">1247
</span><span class="lnt">1248
</span><span class="lnt">1249
</span><span class="lnt">1250
</span><span class="lnt">1251
</span><span class="lnt">1252
</span><span class="lnt">1253
</span><span class="lnt">1254
</span><span class="lnt">1255
</span><span class="lnt">1256
</span><span class="lnt">1257
</span><span class="lnt">1258
</span><span class="lnt">1259
</span><span class="lnt">1260
</span><span class="lnt">1261
</span><span class="lnt">1262
</span><span class="lnt">1263
</span><span class="lnt">1264
</span><span class="lnt">1265
</span><span class="lnt">1266
</span><span class="lnt">1267
</span><span class="lnt">1268
</span><span class="lnt">1269
</span><span class="lnt">1270
</span><span class="lnt">1271
</span><span class="lnt">1272
</span><span class="lnt">1273
</span><span class="lnt">1274
</span><span class="lnt">1275
</span><span class="lnt">1276
</span><span class="lnt">1277
</span><span class="lnt">1278
</span><span class="lnt">1279
</span><span class="lnt">1280
</span><span class="lnt">1281
</span><span class="lnt">1282
</span><span class="lnt">1283
</span><span class="lnt">1284
</span><span class="lnt">1285
</span><span class="lnt">1286
</span><span class="lnt">1287
</span><span class="lnt">1288
</span><span class="lnt">1289
</span><span class="lnt">1290
</span><span class="lnt">1291
</span><span class="lnt">1292
</span><span class="lnt">1293
</span><span class="lnt">1294
</span><span class="lnt">1295
</span><span class="lnt">1296
</span><span class="lnt">1297
</span><span class="lnt">1298
</span><span class="lnt">1299
</span><span class="lnt">1300
</span><span class="lnt">1301
</span><span class="lnt">1302
</span><span class="lnt">1303
</span><span class="lnt">1304
</span><span class="lnt">1305
</span><span class="lnt">1306
</span><span class="lnt">1307
</span><span class="lnt">1308
</span><span class="lnt">1309
</span><span class="lnt">1310
</span><span class="lnt">1311
</span><span class="lnt">1312
</span><span class="lnt">1313
</span><span class="lnt">1314
</span><span class="lnt">1315
</span><span class="lnt">1316
</span><span class="lnt">1317
</span><span class="lnt">1318
</span><span class="lnt">1319
</span><span class="lnt">1320
</span><span class="lnt">1321
</span><span class="lnt">1322
</span><span class="lnt">1323
</span><span class="lnt">1324
</span><span class="lnt">1325
</span><span class="lnt">1326
</span><span class="lnt">1327
</span><span class="lnt">1328
</span><span class="lnt">1329
</span><span class="lnt">1330
</span><span class="lnt">1331
</span><span class="lnt">1332
</span><span class="lnt">1333
</span><span class="lnt">1334
</span><span class="lnt">1335
</span><span class="lnt">1336
</span><span class="lnt">1337
</span><span class="lnt">1338
</span><span class="lnt">1339
</span><span class="lnt">1340
</span><span class="lnt">1341
</span><span class="lnt">1342
</span><span class="lnt">1343
</span><span class="lnt">1344
</span><span class="lnt">1345
</span><span class="lnt">1346
</span><span class="lnt">1347
</span><span class="lnt">1348
</span><span class="lnt">1349
</span><span class="lnt">1350
</span><span class="lnt">1351
</span><span class="lnt">1352
</span><span class="lnt">1353
</span><span class="lnt">1354
</span><span class="lnt">1355
</span><span class="lnt">1356
</span><span class="lnt">1357
</span><span class="lnt">1358
</span><span class="lnt">1359
</span><span class="lnt">1360
</span><span class="lnt">1361
</span><span class="lnt">1362
</span><span class="lnt">1363
</span><span class="lnt">1364
</span><span class="lnt">1365
</span><span class="lnt">1366
</span><span class="lnt">1367
</span><span class="lnt">1368
</span><span class="lnt">1369
</span><span class="lnt">1370
</span><span class="lnt">1371
</span><span class="lnt">1372
</span><span class="lnt">1373
</span><span class="lnt">1374
</span><span class="lnt">1375
</span><span class="lnt">1376
</span><span class="lnt">1377
</span><span class="lnt">1378
</span><span class="lnt">1379
</span><span class="lnt">1380
</span><span class="lnt">1381
</span><span class="lnt">1382
</span><span class="lnt">1383
</span><span class="lnt">1384
</span><span class="lnt">1385
</span><span class="lnt">1386
</span><span class="lnt">1387
</span><span class="lnt">1388
</span><span class="lnt">1389
</span><span class="lnt">1390
</span><span class="lnt">1391
</span><span class="lnt">1392
</span><span class="lnt">1393
</span><span class="lnt">1394
</span><span class="lnt">1395
</span><span class="lnt">1396
</span><span class="lnt">1397
</span><span class="lnt">1398
</span><span class="lnt">1399
</span><span class="lnt">1400
</span><span class="lnt">1401
</span><span class="lnt">1402
</span><span class="lnt">1403
</span><span class="lnt">1404
</span><span class="lnt">1405
</span><span class="lnt">1406
</span><span class="lnt">1407
</span><span class="lnt">1408
</span><span class="lnt">1409
</span><span class="lnt">1410
</span><span class="lnt">1411
</span><span class="lnt">1412
</span><span class="lnt">1413
</span><span class="lnt">1414
</span><span class="lnt">1415
</span><span class="lnt">1416
</span><span class="lnt">1417
</span><span class="lnt">1418
</span><span class="lnt">1419
</span><span class="lnt">1420
</span><span class="lnt">1421
</span><span class="lnt">1422
</span><span class="lnt">1423
</span><span class="lnt">1424
</span><span class="lnt">1425
</span><span class="lnt">1426
</span><span class="lnt">1427
</span><span class="lnt">1428
</span><span class="lnt">1429
</span><span class="lnt">1430
</span><span class="lnt">1431
</span><span class="lnt">1432
</span><span class="lnt">1433
</span><span class="lnt">1434
</span><span class="lnt">1435
</span><span class="lnt">1436
</span><span class="lnt">1437
</span><span class="lnt">1438
</span><span class="lnt">1439
</span><span class="lnt">1440
</span><span class="lnt">1441
</span><span class="lnt">1442
</span><span class="lnt">1443
</span><span class="lnt">1444
</span><span class="lnt">1445
</span><span class="lnt">1446
</span><span class="lnt">1447
</span><span class="lnt">1448
</span><span class="lnt">1449
</span><span class="lnt">1450
</span><span class="lnt">1451
</span><span class="lnt">1452
</span><span class="lnt">1453
</span><span class="lnt">1454
</span><span class="lnt">1455
</span><span class="lnt">1456
</span><span class="lnt">1457
</span><span class="lnt">1458
</span><span class="lnt">1459
</span><span class="lnt">1460
</span><span class="lnt">1461
</span><span class="lnt">1462
</span><span class="lnt">1463
</span><span class="lnt">1464
</span><span class="lnt">1465
</span><span class="lnt">1466
</span><span class="lnt">1467
</span><span class="lnt">1468
</span><span class="lnt">1469
</span><span class="lnt">1470
</span><span class="lnt">1471
</span><span class="lnt">1472
</span><span class="lnt">1473
</span><span class="lnt">1474
</span><span class="lnt">1475
</span><span class="lnt">1476
</span><span class="lnt">1477
</span><span class="lnt">1478
</span><span class="lnt">1479
</span><span class="lnt">1480
</span><span class="lnt">1481
</span><span class="lnt">1482
</span><span class="lnt">1483
</span><span class="lnt">1484
</span><span class="lnt">1485
</span><span class="lnt">1486
</span><span class="lnt">1487
</span><span class="lnt">1488
</span><span class="lnt">1489
</span><span class="lnt">1490
</span><span class="lnt">1491
</span><span class="lnt">1492
</span><span class="lnt">1493
</span><span class="lnt">1494
</span><span class="lnt">1495
</span><span class="lnt">1496
</span><span class="lnt">1497
</span><span class="lnt">1498
</span><span class="lnt">1499
</span><span class="lnt">1500
</span><span class="lnt">1501
</span><span class="lnt">1502
</span><span class="lnt">1503
</span><span class="lnt">1504
</span><span class="lnt">1505
</span><span class="lnt">1506
</span><span class="lnt">1507
</span><span class="lnt">1508
</span><span class="lnt">1509
</span><span class="lnt">1510
</span><span class="lnt">1511
</span><span class="lnt">1512
</span><span class="lnt">1513
</span><span class="lnt">1514
</span><span class="lnt">1515
</span><span class="lnt">1516
</span><span class="lnt">1517
</span><span class="lnt">1518
</span><span class="lnt">1519
</span><span class="lnt">1520
</span><span class="lnt">1521
</span><span class="lnt">1522
</span><span class="lnt">1523
</span><span class="lnt">1524
</span><span class="lnt">1525
</span><span class="lnt">1526
</span><span class="lnt">1527
</span><span class="lnt">1528
</span><span class="lnt">1529
</span><span class="lnt">1530
</span><span class="lnt">1531
</span><span class="lnt">1532
</span><span class="lnt">1533
</span><span class="lnt">1534
</span><span class="lnt">1535
</span><span class="lnt">1536
</span><span class="lnt">1537
</span><span class="lnt">1538
</span><span class="lnt">1539
</span><span class="lnt">1540
</span><span class="lnt">1541
</span><span class="lnt">1542
</span><span class="lnt">1543
</span><span class="lnt">1544
</span><span class="lnt">1545
</span><span class="lnt">1546
</span><span class="lnt">1547
</span><span class="lnt">1548
</span><span class="lnt">1549
</span><span class="lnt">1550
</span><span class="lnt">1551
</span><span class="lnt">1552
</span><span class="lnt">1553
</span><span class="lnt">1554
</span><span class="lnt">1555
</span><span class="lnt">1556
</span><span class="lnt">1557
</span><span class="lnt">1558
</span><span class="lnt">1559
</span><span class="lnt">1560
</span><span class="lnt">1561
</span><span class="lnt">1562
</span><span class="lnt">1563
</span><span class="lnt">1564
</span><span class="lnt">1565
</span><span class="lnt">1566
</span><span class="lnt">1567
</span><span class="lnt">1568
</span><span class="lnt">1569
</span><span class="lnt">1570
</span><span class="lnt">1571
</span><span class="lnt">1572
</span><span class="lnt">1573
</span><span class="lnt">1574
</span><span class="lnt">1575
</span><span class="lnt">1576
</span><span class="lnt">1577
</span><span class="lnt">1578
</span><span class="lnt">1579
</span><span class="lnt">1580
</span><span class="lnt">1581
</span><span class="lnt">1582
</span><span class="lnt">1583
</span><span class="lnt">1584
</span><span class="lnt">1585
</span><span class="lnt">1586
</span><span class="lnt">1587
</span><span class="lnt">1588
</span><span class="lnt">1589
</span><span class="lnt">1590
</span><span class="lnt">1591
</span><span class="lnt">1592
</span><span class="lnt">1593
</span><span class="lnt">1594
</span><span class="lnt">1595
</span><span class="lnt">1596
</span><span class="lnt">1597
</span><span class="lnt">1598
</span><span class="lnt">1599
</span><span class="lnt">1600
</span><span class="lnt">1601
</span><span class="lnt">1602
</span><span class="lnt">1603
</span><span class="lnt">1604
</span><span class="lnt">1605
</span><span class="lnt">1606
</span><span class="lnt">1607
</span><span class="lnt">1608
</span><span class="lnt">1609
</span><span class="lnt">1610
</span><span class="lnt">1611
</span><span class="lnt">1612
</span><span class="lnt">1613
</span><span class="lnt">1614
</span><span class="lnt">1615
</span><span class="lnt">1616
</span><span class="lnt">1617
</span><span class="lnt">1618
</span><span class="lnt">1619
</span><span class="lnt">1620
</span><span class="lnt">1621
</span><span class="lnt">1622
</span><span class="lnt">1623
</span><span class="lnt">1624
</span><span class="lnt">1625
</span><span class="lnt">1626
</span><span class="lnt">1627
</span><span class="lnt">1628
</span><span class="lnt">1629
</span><span class="lnt">1630
</span><span class="lnt">1631
</span><span class="lnt">1632
</span><span class="lnt">1633
</span><span class="lnt">1634
</span><span class="lnt">1635
</span><span class="lnt">1636
</span><span class="lnt">1637
</span><span class="lnt">1638
</span><span class="lnt">1639
</span><span class="lnt">1640
</span><span class="lnt">1641
</span><span class="lnt">1642
</span><span class="lnt">1643
</span><span class="lnt">1644
</span><span class="lnt">1645
</span><span class="lnt">1646
</span><span class="lnt">1647
</span><span class="lnt">1648
</span><span class="lnt">1649
</span><span class="lnt">1650
</span><span class="lnt">1651
</span><span class="lnt">1652
</span><span class="lnt">1653
</span><span class="lnt">1654
</span><span class="lnt">1655
</span><span class="lnt">1656
</span><span class="lnt">1657
</span><span class="lnt">1658
</span><span class="lnt">1659
</span><span class="lnt">1660
</span><span class="lnt">1661
</span><span class="lnt">1662
</span><span class="lnt">1663
</span><span class="lnt">1664
</span><span class="lnt">1665
</span><span class="lnt">1666
</span><span class="lnt">1667
</span><span class="lnt">1668
</span><span class="lnt">1669
</span><span class="lnt">1670
</span><span class="lnt">1671
</span><span class="lnt">1672
</span><span class="lnt">1673
</span><span class="lnt">1674
</span><span class="lnt">1675
</span><span class="lnt">1676
</span><span class="lnt">1677
</span><span class="lnt">1678
</span><span class="lnt">1679
</span><span class="lnt">1680
</span><span class="lnt">1681
</span><span class="lnt">1682
</span><span class="lnt">1683
</span><span class="lnt">1684
</span><span class="lnt">1685
</span><span class="lnt">1686
</span><span class="lnt">1687
</span><span class="lnt">1688
</span><span class="lnt">1689
</span><span class="lnt">1690
</span><span class="lnt">1691
</span><span class="lnt">1692
</span><span class="lnt">1693
</span><span class="lnt">1694
</span><span class="lnt">1695
</span><span class="lnt">1696
</span><span class="lnt">1697
</span><span class="lnt">1698
</span><span class="lnt">1699
</span><span class="lnt">1700
</span><span class="lnt">1701
</span><span class="lnt">1702
</span><span class="lnt">1703
</span><span class="lnt">1704
</span><span class="lnt">1705
</span><span class="lnt">1706
</span><span class="lnt">1707
</span><span class="lnt">1708
</span><span class="lnt">1709
</span><span class="lnt">1710
</span><span class="lnt">1711
</span><span class="lnt">1712
</span><span class="lnt">1713
</span><span class="lnt">1714
</span><span class="lnt">1715
</span><span class="lnt">1716
</span><span class="lnt">1717
</span><span class="lnt">1718
</span><span class="lnt">1719
</span><span class="lnt">1720
</span><span class="lnt">1721
</span><span class="lnt">1722
</span><span class="lnt">1723
</span><span class="lnt">1724
</span><span class="lnt">1725
</span><span class="lnt">1726
</span><span class="lnt">1727
</span><span class="lnt">1728
</span><span class="lnt">1729
</span><span class="lnt">1730
</span><span class="lnt">1731
</span><span class="lnt">1732
</span><span class="lnt">1733
</span><span class="lnt">1734
</span><span class="lnt">1735
</span><span class="lnt">1736
</span><span class="lnt">1737
</span><span class="lnt">1738
</span><span class="lnt">1739
</span><span class="lnt">1740
</span><span class="lnt">1741
</span><span class="lnt">1742
</span><span class="lnt">1743
</span><span class="lnt">1744
</span><span class="lnt">1745
</span><span class="lnt">1746
</span><span class="lnt">1747
</span><span class="lnt">1748
</span><span class="lnt">1749
</span><span class="lnt">1750
</span><span class="lnt">1751
</span><span class="lnt">1752
</span><span class="lnt">1753
</span><span class="lnt">1754
</span><span class="lnt">1755
</span><span class="lnt">1756
</span><span class="lnt">1757
</span><span class="lnt">1758
</span><span class="lnt">1759
</span><span class="lnt">1760
</span><span class="lnt">1761
</span><span class="lnt">1762
</span><span class="lnt">1763
</span><span class="lnt">1764
</span><span class="lnt">1765
</span><span class="lnt">1766
</span><span class="lnt">1767
</span><span class="lnt">1768
</span><span class="lnt">1769
</span><span class="lnt">1770
</span><span class="lnt">1771
</span><span class="lnt">1772
</span><span class="lnt">1773
</span><span class="lnt">1774
</span><span class="lnt">1775
</span><span class="lnt">1776
</span><span class="lnt">1777
</span><span class="lnt">1778
</span><span class="lnt">1779
</span><span class="lnt">1780
</span><span class="lnt">1781
</span><span class="lnt">1782
</span><span class="lnt">1783
</span><span class="lnt">1784
</span><span class="lnt">1785
</span><span class="lnt">1786
</span><span class="lnt">1787
</span><span class="lnt">1788
</span><span class="lnt">1789
</span><span class="lnt">1790
</span><span class="lnt">1791
</span><span class="lnt">1792
</span><span class="lnt">1793
</span><span class="lnt">1794
</span><span class="lnt">1795
</span><span class="lnt">1796
</span><span class="lnt">1797
</span><span class="lnt">1798
</span><span class="lnt">1799
</span><span class="lnt">1800
</span><span class="lnt">1801
</span><span class="lnt">1802
</span><span class="lnt">1803
</span><span class="lnt">1804
</span><span class="lnt">1805
</span><span class="lnt">1806
</span><span class="lnt">1807
</span><span class="lnt">1808
</span><span class="lnt">1809
</span><span class="lnt">1810
</span><span class="lnt">1811
</span><span class="lnt">1812
</span><span class="lnt">1813
</span><span class="lnt">1814
</span><span class="lnt">1815
</span><span class="lnt">1816
</span><span class="lnt">1817
</span><span class="lnt">1818
</span><span class="lnt">1819
</span><span class="lnt">1820
</span><span class="lnt">1821
</span><span class="lnt">1822
</span><span class="lnt">1823
</span><span class="lnt">1824
</span><span class="lnt">1825
</span><span class="lnt">1826
</span><span class="lnt">1827
</span><span class="lnt">1828
</span><span class="lnt">1829
</span><span class="lnt">1830
</span><span class="lnt">1831
</span><span class="lnt">1832
</span><span class="lnt">1833
</span><span class="lnt">1834
</span><span class="lnt">1835
</span><span class="lnt">1836
</span><span class="lnt">1837
</span><span class="lnt">1838
</span><span class="lnt">1839
</span><span class="lnt">1840
</span><span class="lnt">1841
</span><span class="lnt">1842
</span><span class="lnt">1843
</span><span class="lnt">1844
</span><span class="lnt">1845
</span><span class="lnt">1846
</span><span class="lnt">1847
</span><span class="lnt">1848
</span><span class="lnt">1849
</span><span class="lnt">1850
</span><span class="lnt">1851
</span><span class="lnt">1852
</span><span class="lnt">1853
</span><span class="lnt">1854
</span><span class="lnt">1855
</span><span class="lnt">1856
</span><span class="lnt">1857
</span><span class="lnt">1858
</span><span class="lnt">1859
</span><span class="lnt">1860
</span><span class="lnt">1861
</span><span class="lnt">1862
</span><span class="lnt">1863
</span><span class="lnt">1864
</span><span class="lnt">1865
</span><span class="lnt">1866
</span><span class="lnt">1867
</span><span class="lnt">1868
</span><span class="lnt">1869
</span><span class="lnt">1870
</span><span class="lnt">1871
</span><span class="lnt">1872
</span><span class="lnt">1873
</span><span class="lnt">1874
</span><span class="lnt">1875
</span><span class="lnt">1876
</span><span class="lnt">1877
</span><span class="lnt">1878
</span><span class="lnt">1879
</span><span class="lnt">1880
</span><span class="lnt">1881
</span><span class="lnt">1882
</span><span class="lnt">1883
</span><span class="lnt">1884
</span><span class="lnt">1885
</span><span class="lnt">1886
</span><span class="lnt">1887
</span><span class="lnt">1888
</span><span class="lnt">1889
</span><span class="lnt">1890
</span><span class="lnt">1891
</span><span class="lnt">1892
</span><span class="lnt">1893
</span><span class="lnt">1894
</span><span class="lnt">1895
</span><span class="lnt">1896
</span><span class="lnt">1897
</span><span class="lnt">1898
</span><span class="lnt">1899
</span><span class="lnt">1900
</span><span class="lnt">1901
</span><span class="lnt">1902
</span><span class="lnt">1903
</span><span class="lnt">1904
</span><span class="lnt">1905
</span><span class="lnt">1906
</span><span class="lnt">1907
</span><span class="lnt">1908
</span><span class="lnt">1909
</span><span class="lnt">1910
</span><span class="lnt">1911
</span><span class="lnt">1912
</span><span class="lnt">1913
</span><span class="lnt">1914
</span><span class="lnt">1915
</span><span class="lnt">1916
</span><span class="lnt">1917
</span><span class="lnt">1918
</span><span class="lnt">1919
</span><span class="lnt">1920
</span><span class="lnt">1921
</span><span class="lnt">1922
</span><span class="lnt">1923
</span><span class="lnt">1924
</span><span class="lnt">1925
</span><span class="lnt">1926
</span><span class="lnt">1927
</span><span class="lnt">1928
</span><span class="lnt">1929
</span><span class="lnt">1930
</span><span class="lnt">1931
</span><span class="lnt">1932
</span><span class="lnt">1933
</span><span class="lnt">1934
</span><span class="lnt">1935
</span><span class="lnt">1936
</span><span class="lnt">1937
</span><span class="lnt">1938
</span><span class="lnt">1939
</span><span class="lnt">1940
</span><span class="lnt">1941
</span><span class="lnt">1942
</span><span class="lnt">1943
</span><span class="lnt">1944
</span><span class="lnt">1945
</span><span class="lnt">1946
</span><span class="lnt">1947
</span><span class="lnt">1948
</span><span class="lnt">1949
</span><span class="lnt">1950
</span><span class="lnt">1951
</span><span class="lnt">1952
</span><span class="lnt">1953
</span><span class="lnt">1954
</span><span class="lnt">1955
</span><span class="lnt">1956
</span><span class="lnt">1957
</span><span class="lnt">1958
</span><span class="lnt">1959
</span><span class="lnt">1960
</span><span class="lnt">1961
</span><span class="lnt">1962
</span><span class="lnt">1963
</span><span class="lnt">1964
</span><span class="lnt">1965
</span><span class="lnt">1966
</span><span class="lnt">1967
</span><span class="lnt">1968
</span><span class="lnt">1969
</span><span class="lnt">1970
</span><span class="lnt">1971
</span><span class="lnt">1972
</span><span class="lnt">1973
</span><span class="lnt">1974
</span><span class="lnt">1975
</span><span class="lnt">1976
</span><span class="lnt">1977
</span><span class="lnt">1978
</span><span class="lnt">1979
</span><span class="lnt">1980
</span><span class="lnt">1981
</span><span class="lnt">1982
</span><span class="lnt">1983
</span><span class="lnt">1984
</span><span class="lnt">1985
</span><span class="lnt">1986
</span><span class="lnt">1987
</span><span class="lnt">1988
</span><span class="lnt">1989
</span><span class="lnt">1990
</span><span class="lnt">1991
</span><span class="lnt">1992
</span><span class="lnt">1993
</span><span class="lnt">1994
</span><span class="lnt">1995
</span><span class="lnt">1996
</span><span class="lnt">1997
</span><span class="lnt">1998
</span><span class="lnt">1999
</span><span class="lnt">2000
</span><span class="lnt">2001
</span><span class="lnt">2002
</span><span class="lnt">2003
</span><span class="lnt">2004
</span><span class="lnt">2005
</span><span class="lnt">2006
</span><span class="lnt">2007
</span><span class="lnt">2008
</span><span class="lnt">2009
</span><span class="lnt">2010
</span><span class="lnt">2011
</span><span class="lnt">2012
</span><span class="lnt">2013
</span><span class="lnt">2014
</span><span class="lnt">2015
</span><span class="lnt">2016
</span><span class="lnt">2017
</span><span class="lnt">2018
</span><span class="lnt">2019
</span><span class="lnt">2020
</span><span class="lnt">2021
</span><span class="lnt">2022
</span><span class="lnt">2023
</span><span class="lnt">2024
</span><span class="lnt">2025
</span><span class="lnt">2026
</span><span class="lnt">2027
</span><span class="lnt">2028
</span><span class="lnt">2029
</span><span class="lnt">2030
</span><span class="lnt">2031
</span><span class="lnt">2032
</span><span class="lnt">2033
</span><span class="lnt">2034
</span><span class="lnt">2035
</span><span class="lnt">2036
</span><span class="lnt">2037
</span><span class="lnt">2038
</span><span class="lnt">2039
</span><span class="lnt">2040
</span><span class="lnt">2041
</span><span class="lnt">2042
</span><span class="lnt">2043
</span><span class="lnt">2044
</span><span class="lnt">2045
</span><span class="lnt">2046
</span><span class="lnt">2047
</span><span class="lnt">2048
</span><span class="lnt">2049
</span><span class="lnt">2050
</span><span class="lnt">2051
</span><span class="lnt">2052
</span><span class="lnt">2053
</span><span class="lnt">2054
</span><span class="lnt">2055
</span><span class="lnt">2056
</span><span class="lnt">2057
</span><span class="lnt">2058
</span><span class="lnt">2059
</span><span class="lnt">2060
</span><span class="lnt">2061
</span><span class="lnt">2062
</span><span class="lnt">2063
</span><span class="lnt">2064
</span><span class="lnt">2065
</span><span class="lnt">2066
</span><span class="lnt">2067
</span><span class="lnt">2068
</span><span class="lnt">2069
</span><span class="lnt">2070
</span><span class="lnt">2071
</span><span class="lnt">2072
</span><span class="lnt">2073
</span><span class="lnt">2074
</span><span class="lnt">2075
</span><span class="lnt">2076
</span><span class="lnt">2077
</span><span class="lnt">2078
</span><span class="lnt">2079
</span><span class="lnt">2080
</span><span class="lnt">2081
</span><span class="lnt">2082
</span><span class="lnt">2083
</span><span class="lnt">2084
</span><span class="lnt">2085
</span><span class="lnt">2086
</span><span class="lnt">2087
</span><span class="lnt">2088
</span><span class="lnt">2089
</span><span class="lnt">2090
</span><span class="lnt">2091
</span><span class="lnt">2092
</span><span class="lnt">2093
</span><span class="lnt">2094
</span><span class="lnt">2095
</span><span class="lnt">2096
</span><span class="lnt">2097
</span><span class="lnt">2098
</span><span class="lnt">2099
</span><span class="lnt">2100
</span><span class="lnt">2101
</span><span class="lnt">2102
</span><span class="lnt">2103
</span><span class="lnt">2104
</span><span class="lnt">2105
</span><span class="lnt">2106
</span><span class="lnt">2107
</span><span class="lnt">2108
</span><span class="lnt">2109
</span><span class="lnt">2110
</span><span class="lnt">2111
</span><span class="lnt">2112
</span><span class="lnt">2113
</span><span class="lnt">2114
</span><span class="lnt">2115
</span><span class="lnt">2116
</span><span class="lnt">2117
</span><span class="lnt">2118
</span><span class="lnt">2119
</span><span class="lnt">2120
</span><span class="lnt">2121
</span><span class="lnt">2122
</span><span class="lnt">2123
</span><span class="lnt">2124
</span><span class="lnt">2125
</span><span class="lnt">2126
</span><span class="lnt">2127
</span><span class="lnt">2128
</span><span class="lnt">2129
</span><span class="lnt">2130
</span><span class="lnt">2131
</span><span class="lnt">2132
</span><span class="lnt">2133
</span><span class="lnt">2134
</span><span class="lnt">2135
</span><span class="lnt">2136
</span><span class="lnt">2137
</span><span class="lnt">2138
</span><span class="lnt">2139
</span><span class="lnt">2140
</span><span class="lnt">2141
</span><span class="lnt">2142
</span><span class="lnt">2143
</span><span class="lnt">2144
</span><span class="lnt">2145
</span><span class="lnt">2146
</span><span class="lnt">2147
</span><span class="lnt">2148
</span><span class="lnt">2149
</span><span class="lnt">2150
</span><span class="lnt">2151
</span><span class="lnt">2152
</span><span class="lnt">2153
</span><span class="lnt">2154
</span><span class="lnt">2155
</span><span class="lnt">2156
</span><span class="lnt">2157
</span><span class="lnt">2158
</span><span class="lnt">2159
</span><span class="lnt">2160
</span><span class="lnt">2161
</span><span class="lnt">2162
</span><span class="lnt">2163
</span><span class="lnt">2164
</span><span class="lnt">2165
</span><span class="lnt">2166
</span><span class="lnt">2167
</span><span class="lnt">2168
</span><span class="lnt">2169
</span><span class="lnt">2170
</span><span class="lnt">2171
</span><span class="lnt">2172
</span><span class="lnt">2173
</span><span class="lnt">2174
</span><span class="lnt">2175
</span><span class="lnt">2176
</span><span class="lnt">2177
</span><span class="lnt">2178
</span><span class="lnt">2179
</span><span class="lnt">2180
</span><span class="lnt">2181
</span><span class="lnt">2182
</span><span class="lnt">2183
</span><span class="lnt">2184
</span><span class="lnt">2185
</span><span class="lnt">2186
</span><span class="lnt">2187
</span><span class="lnt">2188
</span><span class="lnt">2189
</span><span class="lnt">2190
</span><span class="lnt">2191
</span><span class="lnt">2192
</span><span class="lnt">2193
</span><span class="lnt">2194
</span><span class="lnt">2195
</span><span class="lnt">2196
</span><span class="lnt">2197
</span><span class="lnt">2198
</span><span class="lnt">2199
</span><span class="lnt">2200
</span><span class="lnt">2201
</span><span class="lnt">2202
</span><span class="lnt">2203
</span><span class="lnt">2204
</span><span class="lnt">2205
</span><span class="lnt">2206
</span><span class="lnt">2207
</span><span class="lnt">2208
</span><span class="lnt">2209
</span><span class="lnt">2210
</span><span class="lnt">2211
</span><span class="lnt">2212
</span><span class="lnt">2213
</span><span class="lnt">2214
</span><span class="lnt">2215
</span><span class="lnt">2216
</span><span class="lnt">2217
</span><span class="lnt">2218
</span><span class="lnt">2219
</span><span class="lnt">2220
</span><span class="lnt">2221
</span><span class="lnt">2222
</span><span class="lnt">2223
</span><span class="lnt">2224
</span><span class="lnt">2225
</span><span class="lnt">2226
</span><span class="lnt">2227
</span><span class="lnt">2228
</span><span class="lnt">2229
</span><span class="lnt">2230
</span><span class="lnt">2231
</span><span class="lnt">2232
</span><span class="lnt">2233
</span><span class="lnt">2234
</span><span class="lnt">2235
</span><span class="lnt">2236
</span><span class="lnt">2237
</span><span class="lnt">2238
</span><span class="lnt">2239
</span><span class="lnt">2240
</span><span class="lnt">2241
</span><span class="lnt">2242
</span><span class="lnt">2243
</span><span class="lnt">2244
</span><span class="lnt">2245
</span><span class="lnt">2246
</span><span class="lnt">2247
</span><span class="lnt">2248
</span><span class="lnt">2249
</span><span class="lnt">2250
</span><span class="lnt">2251
</span><span class="lnt">2252
</span><span class="lnt">2253
</span><span class="lnt">2254
</span><span class="lnt">2255
</span><span class="lnt">2256
</span><span class="lnt">2257
</span><span class="lnt">2258
</span><span class="lnt">2259
</span><span class="lnt">2260
</span><span class="lnt">2261
</span><span class="lnt">2262
</span><span class="lnt">2263
</span><span class="lnt">2264
</span><span class="lnt">2265
</span><span class="lnt">2266
</span><span class="lnt">2267
</span><span class="lnt">2268
</span><span class="lnt">2269
</span><span class="lnt">2270
</span><span class="lnt">2271
</span><span class="lnt">2272
</span><span class="lnt">2273
</span><span class="lnt">2274
</span><span class="lnt">2275
</span><span class="lnt">2276
</span><span class="lnt">2277
</span><span class="lnt">2278
</span><span class="lnt">2279
</span><span class="lnt">2280
</span><span class="lnt">2281
</span><span class="lnt">2282
</span><span class="lnt">2283
</span><span class="lnt">2284
</span><span class="lnt">2285
</span><span class="lnt">2286
</span><span class="lnt">2287
</span><span class="lnt">2288
</span><span class="lnt">2289
</span><span class="lnt">2290
</span><span class="lnt">2291
</span><span class="lnt">2292
</span><span class="lnt">2293
</span><span class="lnt">2294
</span><span class="lnt">2295
</span><span class="lnt">2296
</span><span class="lnt">2297
</span><span class="lnt">2298
</span><span class="lnt">2299
</span><span class="lnt">2300
</span><span class="lnt">2301
</span><span class="lnt">2302
</span><span class="lnt">2303
</span><span class="lnt">2304
</span><span class="lnt">2305
</span><span class="lnt">2306
</span><span class="lnt">2307
</span><span class="lnt">2308
</span><span class="lnt">2309
</span><span class="lnt">2310
</span><span class="lnt">2311
</span><span class="lnt">2312
</span><span class="lnt">2313
</span><span class="lnt">2314
</span><span class="lnt">2315
</span><span class="lnt">2316
</span><span class="lnt">2317
</span><span class="lnt">2318
</span><span class="lnt">2319
</span><span class="lnt">2320
</span><span class="lnt">2321
</span><span class="lnt">2322
</span><span class="lnt">2323
</span><span class="lnt">2324
</span><span class="lnt">2325
</span><span class="lnt">2326
</span><span class="lnt">2327
</span><span class="lnt">2328
</span><span class="lnt">2329
</span><span class="lnt">2330
</span><span class="lnt">2331
</span><span class="lnt">2332
</span><span class="lnt">2333
</span><span class="lnt">2334
</span><span class="lnt">2335
</span><span class="lnt">2336
</span><span class="lnt">2337
</span><span class="lnt">2338
</span><span class="lnt">2339
</span><span class="lnt">2340
</span><span class="lnt">2341
</span><span class="lnt">2342
</span><span class="lnt">2343
</span><span class="lnt">2344
</span><span class="lnt">2345
</span><span class="lnt">2346
</span><span class="lnt">2347
</span><span class="lnt">2348
</span><span class="lnt">2349
</span><span class="lnt">2350
</span><span class="lnt">2351
</span><span class="lnt">2352
</span><span class="lnt">2353
</span><span class="lnt">2354
</span><span class="lnt">2355
</span><span class="lnt">2356
</span><span class="lnt">2357
</span><span class="lnt">2358
</span><span class="lnt">2359
</span><span class="lnt">2360
</span><span class="lnt">2361
</span><span class="lnt">2362
</span><span class="lnt">2363
</span><span class="lnt">2364
</span><span class="lnt">2365
</span><span class="lnt">2366
</span><span class="lnt">2367
</span><span class="lnt">2368
</span><span class="lnt">2369
</span><span class="lnt">2370
</span><span class="lnt">2371
</span><span class="lnt">2372
</span><span class="lnt">2373
</span><span class="lnt">2374
</span><span class="lnt">2375
</span><span class="lnt">2376
</span><span class="lnt">2377
</span><span class="lnt">2378
</span><span class="lnt">2379
</span><span class="lnt">2380
</span><span class="lnt">2381
</span><span class="lnt">2382
</span><span class="lnt">2383
</span><span class="lnt">2384
</span><span class="lnt">2385
</span><span class="lnt">2386
</span><span class="lnt">2387
</span><span class="lnt">2388
</span><span class="lnt">2389
</span><span class="lnt">2390
</span><span class="lnt">2391
</span><span class="lnt">2392
</span><span class="lnt">2393
</span><span class="lnt">2394
</span><span class="lnt">2395
</span><span class="lnt">2396
</span><span class="lnt">2397
</span><span class="lnt">2398
</span><span class="lnt">2399
</span><span class="lnt">2400
</span><span class="lnt">2401
</span><span class="lnt">2402
</span><span class="lnt">2403
</span><span class="lnt">2404
</span><span class="lnt">2405
</span><span class="lnt">2406
</span><span class="lnt">2407
</span><span class="lnt">2408
</span><span class="lnt">2409
</span><span class="lnt">2410
</span><span class="lnt">2411
</span><span class="lnt">2412
</span><span class="lnt">2413
</span><span class="lnt">2414
</span><span class="lnt">2415
</span><span class="lnt">2416
</span><span class="lnt">2417
</span><span class="lnt">2418
</span><span class="lnt">2419
</span><span class="lnt">2420
</span><span class="lnt">2421
</span><span class="lnt">2422
</span><span class="lnt">2423
</span><span class="lnt">2424
</span><span class="lnt">2425
</span><span class="lnt">2426
</span><span class="lnt">2427
</span><span class="lnt">2428
</span><span class="lnt">2429
</span><span class="lnt">2430
</span><span class="lnt">2431
</span><span class="lnt">2432
</span><span class="lnt">2433
</span><span class="lnt">2434
</span><span class="lnt">2435
</span><span class="lnt">2436
</span><span class="lnt">2437
</span><span class="lnt">2438
</span><span class="lnt">2439
</span><span class="lnt">2440
</span><span class="lnt">2441
</span><span class="lnt">2442
</span><span class="lnt">2443
</span><span class="lnt">2444
</span><span class="lnt">2445
</span><span class="lnt">2446
</span><span class="lnt">2447
</span><span class="lnt">2448
</span><span class="lnt">2449
</span><span class="lnt">2450
</span><span class="lnt">2451
</span><span class="lnt">2452
</span><span class="lnt">2453
</span><span class="lnt">2454
</span><span class="lnt">2455
</span><span class="lnt">2456
</span><span class="lnt">2457
</span><span class="lnt">2458
</span><span class="lnt">2459
</span><span class="lnt">2460
</span><span class="lnt">2461
</span><span class="lnt">2462
</span><span class="lnt">2463
</span><span class="lnt">2464
</span><span class="lnt">2465
</span><span class="lnt">2466
</span><span class="lnt">2467
</span><span class="lnt">2468
</span><span class="lnt">2469
</span><span class="lnt">2470
</span><span class="lnt">2471
</span><span class="lnt">2472
</span><span class="lnt">2473
</span><span class="lnt">2474
</span><span class="lnt">2475
</span><span class="lnt">2476
</span><span class="lnt">2477
</span><span class="lnt">2478
</span><span class="lnt">2479
</span><span class="lnt">2480
</span><span class="lnt">2481
</span><span class="lnt">2482
</span><span class="lnt">2483
</span><span class="lnt">2484
</span><span class="lnt">2485
</span><span class="lnt">2486
</span><span class="lnt">2487
</span><span class="lnt">2488
</span><span class="lnt">2489
</span><span class="lnt">2490
</span><span class="lnt">2491
</span><span class="lnt">2492
</span><span class="lnt">2493
</span><span class="lnt">2494
</span><span class="lnt">2495
</span><span class="lnt">2496
</span><span class="lnt">2497
</span><span class="lnt">2498
</span><span class="lnt">2499
</span><span class="lnt">2500
</span><span class="lnt">2501
</span><span class="lnt">2502
</span><span class="lnt">2503
</span><span class="lnt">2504
</span><span class="lnt">2505
</span><span class="lnt">2506
</span><span class="lnt">2507
</span><span class="lnt">2508
</span><span class="lnt">2509
</span><span class="lnt">2510
</span><span class="lnt">2511
</span><span class="lnt">2512
</span><span class="lnt">2513
</span><span class="lnt">2514
</span><span class="lnt">2515
</span><span class="lnt">2516
</span><span class="lnt">2517
</span><span class="lnt">2518
</span><span class="lnt">2519
</span><span class="lnt">2520
</span><span class="lnt">2521
</span><span class="lnt">2522
</span><span class="lnt">2523
</span><span class="lnt">2524
</span><span class="lnt">2525
</span><span class="lnt">2526
</span><span class="lnt">2527
</span><span class="lnt">2528
</span><span class="lnt">2529
</span><span class="lnt">2530
</span><span class="lnt">2531
</span><span class="lnt">2532
</span><span class="lnt">2533
</span><span class="lnt">2534
</span><span class="lnt">2535
</span><span class="lnt">2536
</span><span class="lnt">2537
</span><span class="lnt">2538
</span><span class="lnt">2539
</span><span class="lnt">2540
</span><span class="lnt">2541
</span><span class="lnt">2542
</span><span class="lnt">2543
</span><span class="lnt">2544
</span><span class="lnt">2545
</span><span class="lnt">2546
</span><span class="lnt">2547
</span><span class="lnt">2548
</span><span class="lnt">2549
</span><span class="lnt">2550
</span><span class="lnt">2551
</span><span class="lnt">2552
</span><span class="lnt">2553
</span><span class="lnt">2554
</span><span class="lnt">2555
</span><span class="lnt">2556
</span><span class="lnt">2557
</span><span class="lnt">2558
</span><span class="lnt">2559
</span><span class="lnt">2560
</span><span class="lnt">2561
</span><span class="lnt">2562
</span><span class="lnt">2563
</span><span class="lnt">2564
</span><span class="lnt">2565
</span><span class="lnt">2566
</span><span class="lnt">2567
</span><span class="lnt">2568
</span><span class="lnt">2569
</span><span class="lnt">2570
</span><span class="lnt">2571
</span><span class="lnt">2572
</span><span class="lnt">2573
</span><span class="lnt">2574
</span><span class="lnt">2575
</span><span class="lnt">2576
</span><span class="lnt">2577
</span><span class="lnt">2578
</span><span class="lnt">2579
</span><span class="lnt">2580
</span><span class="lnt">2581
</span><span class="lnt">2582
</span><span class="lnt">2583
</span><span class="lnt">2584
</span><span class="lnt">2585
</span><span class="lnt">2586
</span><span class="lnt">2587
</span><span class="lnt">2588
</span><span class="lnt">2589
</span><span class="lnt">2590
</span><span class="lnt">2591
</span><span class="lnt">2592
</span><span class="lnt">2593
</span><span class="lnt">2594
</span><span class="lnt">2595
</span><span class="lnt">2596
</span><span class="lnt">2597
</span><span class="lnt">2598
</span><span class="lnt">2599
</span><span class="lnt">2600
</span><span class="lnt">2601
</span><span class="lnt">2602
</span><span class="lnt">2603
</span><span class="lnt">2604
</span><span class="lnt">2605
</span><span class="lnt">2606
</span><span class="lnt">2607
</span><span class="lnt">2608
</span><span class="lnt">2609
</span><span class="lnt">2610
</span><span class="lnt">2611
</span><span class="lnt">2612
</span><span class="lnt">2613
</span><span class="lnt">2614
</span><span class="lnt">2615
</span><span class="lnt">2616
</span><span class="lnt">2617
</span><span class="lnt">2618
</span><span class="lnt">2619
</span><span class="lnt">2620
</span><span class="lnt">2621
</span><span class="lnt">2622
</span><span class="lnt">2623
</span><span class="lnt">2624
</span><span class="lnt">2625
</span><span class="lnt">2626
</span><span class="lnt">2627
</span><span class="lnt">2628
</span><span class="lnt">2629
</span><span class="lnt">2630
</span><span class="lnt">2631
</span><span class="lnt">2632
</span><span class="lnt">2633
</span><span class="lnt">2634
</span><span class="lnt">2635
</span><span class="lnt">2636
</span><span class="lnt">2637
</span><span class="lnt">2638
</span><span class="lnt">2639
</span><span class="lnt">2640
</span><span class="lnt">2641
</span><span class="lnt">2642
</span><span class="lnt">2643
</span><span class="lnt">2644
</span><span class="lnt">2645
</span><span class="lnt">2646
</span><span class="lnt">2647
</span><span class="lnt">2648
</span><span class="lnt">2649
</span><span class="lnt">2650
</span><span class="lnt">2651
</span><span class="lnt">2652
</span><span class="lnt">2653
</span><span class="lnt">2654
</span><span class="lnt">2655
</span><span class="lnt">2656
</span><span class="lnt">2657
</span><span class="lnt">2658
</span><span class="lnt">2659
</span><span class="lnt">2660
</span><span class="lnt">2661
</span><span class="lnt">2662
</span><span class="lnt">2663
</span><span class="lnt">2664
</span><span class="lnt">2665
</span><span class="lnt">2666
</span><span class="lnt">2667
</span><span class="lnt">2668
</span><span class="lnt">2669
</span><span class="lnt">2670
</span><span class="lnt">2671
</span><span class="lnt">2672
</span><span class="lnt">2673
</span><span class="lnt">2674
</span><span class="lnt">2675
</span><span class="lnt">2676
</span><span class="lnt">2677
</span><span class="lnt">2678
</span><span class="lnt">2679
</span><span class="lnt">2680
</span><span class="lnt">2681
</span><span class="lnt">2682
</span><span class="lnt">2683
</span><span class="lnt">2684
</span><span class="lnt">2685
</span><span class="lnt">2686
</span><span class="lnt">2687
</span><span class="lnt">2688
</span><span class="lnt">2689
</span><span class="lnt">2690
</span><span class="lnt">2691
</span><span class="lnt">2692
</span><span class="lnt">2693
</span><span class="lnt">2694
</span><span class="lnt">2695
</span><span class="lnt">2696
</span><span class="lnt">2697
</span><span class="lnt">2698
</span><span class="lnt">2699
</span><span class="lnt">2700
</span><span class="lnt">2701
</span><span class="lnt">2702
</span><span class="lnt">2703
</span><span class="lnt">2704
</span><span class="lnt">2705
</span><span class="lnt">2706
</span><span class="lnt">2707
</span><span class="lnt">2708
</span><span class="lnt">2709
</span><span class="lnt">2710
</span><span class="lnt">2711
</span><span class="lnt">2712
</span><span class="lnt">2713
</span><span class="lnt">2714
</span><span class="lnt">2715
</span><span class="lnt">2716
</span><span class="lnt">2717
</span><span class="lnt">2718
</span><span class="lnt">2719
</span><span class="lnt">2720
</span><span class="lnt">2721
</span><span class="lnt">2722
</span><span class="lnt">2723
</span><span class="lnt">2724
</span><span class="lnt">2725
</span><span class="lnt">2726
</span><span class="lnt">2727
</span><span class="lnt">2728
</span><span class="lnt">2729
</span><span class="lnt">2730
</span><span class="lnt">2731
</span><span class="lnt">2732
</span><span class="lnt">2733
</span><span class="lnt">2734
</span><span class="lnt">2735
</span><span class="lnt">2736
</span><span class="lnt">2737
</span><span class="lnt">2738
</span><span class="lnt">2739
</span><span class="lnt">2740
</span><span class="lnt">2741
</span><span class="lnt">2742
</span><span class="lnt">2743
</span><span class="lnt">2744
</span><span class="lnt">2745
</span><span class="lnt">2746
</span><span class="lnt">2747
</span><span class="lnt">2748
</span><span class="lnt">2749
</span><span class="lnt">2750
</span><span class="lnt">2751
</span><span class="lnt">2752
</span><span class="lnt">2753
</span><span class="lnt">2754
</span><span class="lnt">2755
</span><span class="lnt">2756
</span><span class="lnt">2757
</span><span class="lnt">2758
</span><span class="lnt">2759
</span><span class="lnt">2760
</span><span class="lnt">2761
</span><span class="lnt">2762
</span><span class="lnt">2763
</span><span class="lnt">2764
</span><span class="lnt">2765
</span><span class="lnt">2766
</span><span class="lnt">2767
</span><span class="lnt">2768
</span><span class="lnt">2769
</span><span class="lnt">2770
</span><span class="lnt">2771
</span><span class="lnt">2772
</span><span class="lnt">2773
</span><span class="lnt">2774
</span><span class="lnt">2775
</span><span class="lnt">2776
</span><span class="lnt">2777
</span><span class="lnt">2778
</span><span class="lnt">2779
</span><span class="lnt">2780
</span><span class="lnt">2781
</span><span class="lnt">2782
</span><span class="lnt">2783
</span><span class="lnt">2784
</span><span class="lnt">2785
</span><span class="lnt">2786
</span><span class="lnt">2787
</span><span class="lnt">2788
</span><span class="lnt">2789
</span><span class="lnt">2790
</span><span class="lnt">2791
</span><span class="lnt">2792
</span><span class="lnt">2793
</span><span class="lnt">2794
</span><span class="lnt">2795
</span><span class="lnt">2796
</span><span class="lnt">2797
</span><span class="lnt">2798
</span><span class="lnt">2799
</span><span class="lnt">2800
</span><span class="lnt">2801
</span><span class="lnt">2802
</span><span class="lnt">2803
</span><span class="lnt">2804
</span><span class="lnt">2805
</span><span class="lnt">2806
</span><span class="lnt">2807
</span><span class="lnt">2808
</span><span class="lnt">2809
</span><span class="lnt">2810
</span><span class="lnt">2811
</span><span class="lnt">2812
</span><span class="lnt">2813
</span><span class="lnt">2814
</span><span class="lnt">2815
</span><span class="lnt">2816
</span><span class="lnt">2817
</span><span class="lnt">2818
</span><span class="lnt">2819
</span><span class="lnt">2820
</span><span class="lnt">2821
</span><span class="lnt">2822
</span><span class="lnt">2823
</span><span class="lnt">2824
</span><span class="lnt">2825
</span><span class="lnt">2826
</span><span class="lnt">2827
</span><span class="lnt">2828
</span><span class="lnt">2829
</span><span class="lnt">2830
</span><span class="lnt">2831
</span><span class="lnt">2832
</span><span class="lnt">2833
</span><span class="lnt">2834
</span><span class="lnt">2835
</span><span class="lnt">2836
</span><span class="lnt">2837
</span><span class="lnt">2838
</span><span class="lnt">2839
</span><span class="lnt">2840
</span><span class="lnt">2841
</span><span class="lnt">2842
</span><span class="lnt">2843
</span><span class="lnt">2844
</span><span class="lnt">2845
</span><span class="lnt">2846
</span><span class="lnt">2847
</span><span class="lnt">2848
</span><span class="lnt">2849
</span><span class="lnt">2850
</span><span class="lnt">2851
</span><span class="lnt">2852
</span><span class="lnt">2853
</span><span class="lnt">2854
</span><span class="lnt">2855
</span><span class="lnt">2856
</span><span class="lnt">2857
</span><span class="lnt">2858
</span><span class="lnt">2859
</span><span class="lnt">2860
</span><span class="lnt">2861
</span><span class="lnt">2862
</span><span class="lnt">2863
</span><span class="lnt">2864
</span><span class="lnt">2865
</span><span class="lnt">2866
</span><span class="lnt">2867
</span><span class="lnt">2868
</span><span class="lnt">2869
</span><span class="lnt">2870
</span><span class="lnt">2871
</span><span class="lnt">2872
</span><span class="lnt">2873
</span><span class="lnt">2874
</span><span class="lnt">2875
</span><span class="lnt">2876
</span><span class="lnt">2877
</span><span class="lnt">2878
</span><span class="lnt">2879
</span><span class="lnt">2880
</span><span class="lnt">2881
</span><span class="lnt">2882
</span><span class="lnt">2883
</span><span class="lnt">2884
</span><span class="lnt">2885
</span><span class="lnt">2886
</span><span class="lnt">2887
</span><span class="lnt">2888
</span><span class="lnt">2889
</span><span class="lnt">2890
</span><span class="lnt">2891
</span><span class="lnt">2892
</span><span class="lnt">2893
</span><span class="lnt">2894
</span><span class="lnt">2895
</span><span class="lnt">2896
</span><span class="lnt">2897
</span><span class="lnt">2898
</span><span class="lnt">2899
</span><span class="lnt">2900
</span><span class="lnt">2901
</span><span class="lnt">2902
</span><span class="lnt">2903
</span><span class="lnt">2904
</span><span class="lnt">2905
</span><span class="lnt">2906
</span><span class="lnt">2907
</span><span class="lnt">2908
</span><span class="lnt">2909
</span><span class="lnt">2910
</span><span class="lnt">2911
</span><span class="lnt">2912
</span><span class="lnt">2913
</span><span class="lnt">2914
</span><span class="lnt">2915
</span><span class="lnt">2916
</span><span class="lnt">2917
</span><span class="lnt">2918
</span><span class="lnt">2919
</span><span class="lnt">2920
</span><span class="lnt">2921
</span><span class="lnt">2922
</span><span class="lnt">2923
</span><span class="lnt">2924
</span><span class="lnt">2925
</span><span class="lnt">2926
</span><span class="lnt">2927
</span><span class="lnt">2928
</span><span class="lnt">2929
</span><span class="lnt">2930
</span><span class="lnt">2931
</span><span class="lnt">2932
</span><span class="lnt">2933
</span><span class="lnt">2934
</span><span class="lnt">2935
</span><span class="lnt">2936
</span><span class="lnt">2937
</span><span class="lnt">2938
</span><span class="lnt">2939
</span><span class="lnt">2940
</span><span class="lnt">2941
</span><span class="lnt">2942
</span><span class="lnt">2943
</span><span class="lnt">2944
</span><span class="lnt">2945
</span><span class="lnt">2946
</span><span class="lnt">2947
</span><span class="lnt">2948
</span><span class="lnt">2949
</span><span class="lnt">2950
</span><span class="lnt">2951
</span><span class="lnt">2952
</span><span class="lnt">2953
</span><span class="lnt">2954
</span><span class="lnt">2955
</span><span class="lnt">2956
</span><span class="lnt">2957
</span><span class="lnt">2958
</span><span class="lnt">2959
</span><span class="lnt">2960
</span><span class="lnt">2961
</span><span class="lnt">2962
</span><span class="lnt">2963
</span><span class="lnt">2964
</span><span class="lnt">2965
</span><span class="lnt">2966
</span><span class="lnt">2967
</span><span class="lnt">2968
</span><span class="lnt">2969
</span><span class="lnt">2970
</span><span class="lnt">2971
</span><span class="lnt">2972
</span><span class="lnt">2973
</span><span class="lnt">2974
</span><span class="lnt">2975
</span><span class="lnt">2976
</span><span class="lnt">2977
</span><span class="lnt">2978
</span><span class="lnt">2979
</span><span class="lnt">2980
</span><span class="lnt">2981
</span><span class="lnt">2982
</span><span class="lnt">2983
</span><span class="lnt">2984
</span><span class="lnt">2985
</span><span class="lnt">2986
</span><span class="lnt">2987
</span><span class="lnt">2988
</span><span class="lnt">2989
</span><span class="lnt">2990
</span><span class="lnt">2991
</span><span class="lnt">2992
</span><span class="lnt">2993
</span><span class="lnt">2994
</span><span class="lnt">2995
</span><span class="lnt">2996
</span><span class="lnt">2997
</span><span class="lnt">2998
</span><span class="lnt">2999
</span><span class="lnt">3000
</span><span class="lnt">3001
</span><span class="lnt">3002
</span><span class="lnt">3003
</span><span class="lnt">3004
</span><span class="lnt">3005
</span><span class="lnt">3006
</span><span class="lnt">3007
</span><span class="lnt">3008
</span><span class="lnt">3009
</span><span class="lnt">3010
</span><span class="lnt">3011
</span><span class="lnt">3012
</span><span class="lnt">3013
</span><span class="lnt">3014
</span><span class="lnt">3015
</span><span class="lnt">3016
</span><span class="lnt">3017
</span><span class="lnt">3018
</span><span class="lnt">3019
</span><span class="lnt">3020
</span><span class="lnt">3021
</span><span class="lnt">3022
</span><span class="lnt">3023
</span><span class="lnt">3024
</span><span class="lnt">3025
</span><span class="lnt">3026
</span><span class="lnt">3027
</span><span class="lnt">3028
</span><span class="lnt">3029
</span><span class="lnt">3030
</span><span class="lnt">3031
</span><span class="lnt">3032
</span><span class="lnt">3033
</span><span class="lnt">3034
</span><span class="lnt">3035
</span><span class="lnt">3036
</span><span class="lnt">3037
</span><span class="lnt">3038
</span><span class="lnt">3039
</span><span class="lnt">3040
</span><span class="lnt">3041
</span><span class="lnt">3042
</span><span class="lnt">3043
</span><span class="lnt">3044
</span><span class="lnt">3045
</span><span class="lnt">3046
</span><span class="lnt">3047
</span><span class="lnt">3048
</span><span class="lnt">3049
</span><span class="lnt">3050
</span><span class="lnt">3051
</span><span class="lnt">3052
</span><span class="lnt">3053
</span><span class="lnt">3054
</span><span class="lnt">3055
</span><span class="lnt">3056
</span><span class="lnt">3057
</span><span class="lnt">3058
</span><span class="lnt">3059
</span><span class="lnt">3060
</span><span class="lnt">3061
</span><span class="lnt">3062
</span><span class="lnt">3063
</span><span class="lnt">3064
</span><span class="lnt">3065
</span><span class="lnt">3066
</span><span class="lnt">3067
</span><span class="lnt">3068
</span><span class="lnt">3069
</span><span class="lnt">3070
</span><span class="lnt">3071
</span><span class="lnt">3072
</span><span class="lnt">3073
</span><span class="lnt">3074
</span><span class="lnt">3075
</span><span class="lnt">3076
</span><span class="lnt">3077
</span><span class="lnt">3078
</span><span class="lnt">3079
</span><span class="lnt">3080
</span><span class="lnt">3081
</span><span class="lnt">3082
</span><span class="lnt">3083
</span><span class="lnt">3084
</span><span class="lnt">3085
</span><span class="lnt">3086
</span><span class="lnt">3087
</span><span class="lnt">3088
</span><span class="lnt">3089
</span><span class="lnt">3090
</span><span class="lnt">3091
</span><span class="lnt">3092
</span><span class="lnt">3093
</span><span class="lnt">3094
</span><span class="lnt">3095
</span><span class="lnt">3096
</span><span class="lnt">3097
</span><span class="lnt">3098
</span><span class="lnt">3099
</span><span class="lnt">3100
</span><span class="lnt">3101
</span><span class="lnt">3102
</span><span class="lnt">3103
</span><span class="lnt">3104
</span><span class="lnt">3105
</span><span class="lnt">3106
</span><span class="lnt">3107
</span><span class="lnt">3108
</span><span class="lnt">3109
</span><span class="lnt">3110
</span><span class="lnt">3111
</span><span class="lnt">3112
</span><span class="lnt">3113
</span><span class="lnt">3114
</span><span class="lnt">3115
</span><span class="lnt">3116
</span><span class="lnt">3117
</span><span class="lnt">3118
</span><span class="lnt">3119
</span><span class="lnt">3120
</span><span class="lnt">3121
</span><span class="lnt">3122
</span><span class="lnt">3123
</span><span class="lnt">3124
</span><span class="lnt">3125
</span><span class="lnt">3126
</span><span class="lnt">3127
</span><span class="lnt">3128
</span><span class="lnt">3129
</span><span class="lnt">3130
</span><span class="lnt">3131
</span><span class="lnt">3132
</span><span class="lnt">3133
</span><span class="lnt">3134
</span><span class="lnt">3135
</span><span class="lnt">3136
</span><span class="lnt">3137
</span><span class="lnt">3138
</span><span class="lnt">3139
</span><span class="lnt">3140
</span><span class="lnt">3141
</span><span class="lnt">3142
</span><span class="lnt">3143
</span><span class="lnt">3144
</span><span class="lnt">3145
</span><span class="lnt">3146
</span><span class="lnt">3147
</span><span class="lnt">3148
</span><span class="lnt">3149
</span><span class="lnt">3150
</span><span class="lnt">3151
</span><span class="lnt">3152
</span><span class="lnt">3153
</span><span class="lnt">3154
</span><span class="lnt">3155
</span><span class="lnt">3156
</span><span class="lnt">3157
</span><span class="lnt">3158
</span><span class="lnt">3159
</span><span class="lnt">3160
</span><span class="lnt">3161
</span><span class="lnt">3162
</span><span class="lnt">3163
</span><span class="lnt">3164
</span><span class="lnt">3165
</span><span class="lnt">3166
</span><span class="lnt">3167
</span><span class="lnt">3168
</span><span class="lnt">3169
</span><span class="lnt">3170
</span><span class="lnt">3171
</span><span class="lnt">3172
</span><span class="lnt">3173
</span><span class="lnt">3174
</span><span class="lnt">3175
</span><span class="lnt">3176
</span><span class="lnt">3177
</span><span class="lnt">3178
</span><span class="lnt">3179
</span><span class="lnt">3180
</span><span class="lnt">3181
</span><span class="lnt">3182
</span><span class="lnt">3183
</span><span class="lnt">3184
</span><span class="lnt">3185
</span><span class="lnt">3186
</span><span class="lnt">3187
</span><span class="lnt">3188
</span><span class="lnt">3189
</span><span class="lnt">3190
</span><span class="lnt">3191
</span><span class="lnt">3192
</span><span class="lnt">3193
</span><span class="lnt">3194
</span><span class="lnt">3195
</span><span class="lnt">3196
</span><span class="lnt">3197
</span><span class="lnt">3198
</span><span class="lnt">3199
</span><span class="lnt">3200
</span><span class="lnt">3201
</span><span class="lnt">3202
</span><span class="lnt">3203
</span><span class="lnt">3204
</span><span class="lnt">3205
</span><span class="lnt">3206
</span><span class="lnt">3207
</span><span class="lnt">3208
</span><span class="lnt">3209
</span><span class="lnt">3210
</span><span class="lnt">3211
</span><span class="lnt">3212
</span><span class="lnt">3213
</span><span class="lnt">3214
</span><span class="lnt">3215
</span><span class="lnt">3216
</span><span class="lnt">3217
</span><span class="lnt">3218
</span><span class="lnt">3219
</span><span class="lnt">3220
</span><span class="lnt">3221
</span><span class="lnt">3222
</span><span class="lnt">3223
</span><span class="lnt">3224
</span><span class="lnt">3225
</span><span class="lnt">3226
</span><span class="lnt">3227
</span><span class="lnt">3228
</span><span class="lnt">3229
</span><span class="lnt">3230
</span><span class="lnt">3231
</span><span class="lnt">3232
</span><span class="lnt">3233
</span><span class="lnt">3234
</span><span class="lnt">3235
</span><span class="lnt">3236
</span><span class="lnt">3237
</span><span class="lnt">3238
</span><span class="lnt">3239
</span><span class="lnt">3240
</span><span class="lnt">3241
</span><span class="lnt">3242
</span><span class="lnt">3243
</span><span class="lnt">3244
</span><span class="lnt">3245
</span><span class="lnt">3246
</span><span class="lnt">3247
</span><span class="lnt">3248
</span><span class="lnt">3249
</span><span class="lnt">3250
</span><span class="lnt">3251
</span><span class="lnt">3252
</span><span class="lnt">3253
</span><span class="lnt">3254
</span><span class="lnt">3255
</span><span class="lnt">3256
</span><span class="lnt">3257
</span><span class="lnt">3258
</span><span class="lnt">3259
</span><span class="lnt">3260
</span><span class="lnt">3261
</span><span class="lnt">3262
</span><span class="lnt">3263
</span><span class="lnt">3264
</span><span class="lnt">3265
</span><span class="lnt">3266
</span><span class="lnt">3267
</span><span class="lnt">3268
</span><span class="lnt">3269
</span><span class="lnt">3270
</span><span class="lnt">3271
</span><span class="lnt">3272
</span><span class="lnt">3273
</span><span class="lnt">3274
</span><span class="lnt">3275
</span><span class="lnt">3276
</span><span class="lnt">3277
</span><span class="lnt">3278
</span><span class="lnt">3279
</span><span class="lnt">3280
</span><span class="lnt">3281
</span><span class="lnt">3282
</span><span class="lnt">3283
</span><span class="lnt">3284
</span><span class="lnt">3285
</span><span class="lnt">3286
</span><span class="lnt">3287
</span><span class="lnt">3288
</span><span class="lnt">3289
</span><span class="lnt">3290
</span><span class="lnt">3291
</span><span class="lnt">3292
</span><span class="lnt">3293
</span><span class="lnt">3294
</span><span class="lnt">3295
</span><span class="lnt">3296
</span><span class="lnt">3297
</span><span class="lnt">3298
</span><span class="lnt">3299
</span><span class="lnt">3300
</span><span class="lnt">3301
</span><span class="lnt">3302
</span><span class="lnt">3303
</span><span class="lnt">3304
</span><span class="lnt">3305
</span><span class="lnt">3306
</span><span class="lnt">3307
</span><span class="lnt">3308
</span><span class="lnt">3309
</span><span class="lnt">3310
</span><span class="lnt">3311
</span><span class="lnt">3312
</span><span class="lnt">3313
</span><span class="lnt">3314
</span><span class="lnt">3315
</span><span class="lnt">3316
</span><span class="lnt">3317
</span><span class="lnt">3318
</span><span class="lnt">3319
</span><span class="lnt">3320
</span><span class="lnt">3321
</span><span class="lnt">3322
</span><span class="lnt">3323
</span><span class="lnt">3324
</span><span class="lnt">3325
</span><span class="lnt">3326
</span><span class="lnt">3327
</span><span class="lnt">3328
</span><span class="lnt">3329
</span><span class="lnt">3330
</span><span class="lnt">3331
</span><span class="lnt">3332
</span><span class="lnt">3333
</span><span class="lnt">3334
</span><span class="lnt">3335
</span><span class="lnt">3336
</span><span class="lnt">3337
</span><span class="lnt">3338
</span><span class="lnt">3339
</span><span class="lnt">3340
</span><span class="lnt">3341
</span><span class="lnt">3342
</span><span class="lnt">3343
</span><span class="lnt">3344
</span><span class="lnt">3345
</span><span class="lnt">3346
</span><span class="lnt">3347
</span><span class="lnt">3348
</span><span class="lnt">3349
</span><span class="lnt">3350
</span><span class="lnt">3351
</span><span class="lnt">3352
</span><span class="lnt">3353
</span><span class="lnt">3354
</span><span class="lnt">3355
</span><span class="lnt">3356
</span><span class="lnt">3357
</span><span class="lnt">3358
</span><span class="lnt">3359
</span><span class="lnt">3360
</span><span class="lnt">3361
</span><span class="lnt">3362
</span><span class="lnt">3363
</span><span class="lnt">3364
</span><span class="lnt">3365
</span><span class="lnt">3366
</span><span class="lnt">3367
</span><span class="lnt">3368
</span><span class="lnt">3369
</span><span class="lnt">3370
</span><span class="lnt">3371
</span><span class="lnt">3372
</span><span class="lnt">3373
</span><span class="lnt">3374
</span><span class="lnt">3375
</span><span class="lnt">3376
</span><span class="lnt">3377
</span><span class="lnt">3378
</span><span class="lnt">3379
</span><span class="lnt">3380
</span><span class="lnt">3381
</span><span class="lnt">3382
</span><span class="lnt">3383
</span><span class="lnt">3384
</span><span class="lnt">3385
</span><span class="lnt">3386
</span><span class="lnt">3387
</span><span class="lnt">3388
</span><span class="lnt">3389
</span><span class="lnt">3390
</span><span class="lnt">3391
</span><span class="lnt">3392
</span><span class="lnt">3393
</span><span class="lnt">3394
</span><span class="lnt">3395
</span><span class="lnt">3396
</span><span class="lnt">3397
</span><span class="lnt">3398
</span><span class="lnt">3399
</span><span class="lnt">3400
</span><span class="lnt">3401
</span><span class="lnt">3402
</span><span class="lnt">3403
</span><span class="lnt">3404
</span><span class="lnt">3405
</span><span class="lnt">3406
</span><span class="lnt">3407
</span><span class="lnt">3408
</span><span class="lnt">3409
</span><span class="lnt">3410
</span><span class="lnt">3411
</span><span class="lnt">3412
</span><span class="lnt">3413
</span><span class="lnt">3414
</span><span class="lnt">3415
</span><span class="lnt">3416
</span><span class="lnt">3417
</span><span class="lnt">3418
</span><span class="lnt">3419
</span><span class="lnt">3420
</span><span class="lnt">3421
</span><span class="lnt">3422
</span><span class="lnt">3423
</span><span class="lnt">3424
</span><span class="lnt">3425
</span><span class="lnt">3426
</span><span class="lnt">3427
</span><span class="lnt">3428
</span><span class="lnt">3429
</span><span class="lnt">3430
</span><span class="lnt">3431
</span><span class="lnt">3432
</span><span class="lnt">3433
</span><span class="lnt">3434
</span><span class="lnt">3435
</span><span class="lnt">3436
</span><span class="lnt">3437
</span><span class="lnt">3438
</span><span class="lnt">3439
</span><span class="lnt">3440
</span><span class="lnt">3441
</span><span class="lnt">3442
</span><span class="lnt">3443
</span><span class="lnt">3444
</span><span class="lnt">3445
</span><span class="lnt">3446
</span><span class="lnt">3447
</span><span class="lnt">3448
</span><span class="lnt">3449
</span><span class="lnt">3450
</span><span class="lnt">3451
</span><span class="lnt">3452
</span><span class="lnt">3453
</span><span class="lnt">3454
</span><span class="lnt">3455
</span><span class="lnt">3456
</span><span class="lnt">3457
</span><span class="lnt">3458
</span><span class="lnt">3459
</span><span class="lnt">3460
</span><span class="lnt">3461
</span><span class="lnt">3462
</span><span class="lnt">3463
</span><span class="lnt">3464
</span><span class="lnt">3465
</span><span class="lnt">3466
</span><span class="lnt">3467
</span><span class="lnt">3468
</span><span class="lnt">3469
</span><span class="lnt">3470
</span><span class="lnt">3471
</span><span class="lnt">3472
</span><span class="lnt">3473
</span><span class="lnt">3474
</span><span class="lnt">3475
</span><span class="lnt">3476
</span><span class="lnt">3477
</span><span class="lnt">3478
</span><span class="lnt">3479
</span><span class="lnt">3480
</span><span class="lnt">3481
</span><span class="lnt">3482
</span><span class="lnt">3483
</span><span class="lnt">3484
</span><span class="lnt">3485
</span><span class="lnt">3486
</span><span class="lnt">3487
</span><span class="lnt">3488
</span><span class="lnt">3489
</span><span class="lnt">3490
</span><span class="lnt">3491
</span><span class="lnt">3492
</span><span class="lnt">3493
</span><span class="lnt">3494
</span><span class="lnt">3495
</span><span class="lnt">3496
</span><span class="lnt">3497
</span><span class="lnt">3498
</span><span class="lnt">3499
</span><span class="lnt">3500
</span><span class="lnt">3501
</span><span class="lnt">3502
</span><span class="lnt">3503
</span><span class="lnt">3504
</span><span class="lnt">3505
</span><span class="lnt">3506
</span><span class="lnt">3507
</span><span class="lnt">3508
</span><span class="lnt">3509
</span><span class="lnt">3510
</span><span class="lnt">3511
</span><span class="lnt">3512
</span><span class="lnt">3513
</span><span class="lnt">3514
</span><span class="lnt">3515
</span><span class="lnt">3516
</span><span class="lnt">3517
</span><span class="lnt">3518
</span><span class="lnt">3519
</span><span class="lnt">3520
</span><span class="lnt">3521
</span><span class="lnt">3522
</span><span class="lnt">3523
</span><span class="lnt">3524
</span><span class="lnt">3525
</span><span class="lnt">3526
</span><span class="lnt">3527
</span><span class="lnt">3528
</span><span class="lnt">3529
</span><span class="lnt">3530
</span><span class="lnt">3531
</span><span class="lnt">3532
</span><span class="lnt">3533
</span><span class="lnt">3534
</span><span class="lnt">3535
</span><span class="lnt">3536
</span><span class="lnt">3537
</span><span class="lnt">3538
</span><span class="lnt">3539
</span><span class="lnt">3540
</span><span class="lnt">3541
</span><span class="lnt">3542
</span><span class="lnt">3543
</span><span class="lnt">3544
</span><span class="lnt">3545
</span><span class="lnt">3546
</span><span class="lnt">3547
</span><span class="lnt">3548
</span><span class="lnt">3549
</span><span class="lnt">3550
</span><span class="lnt">3551
</span><span class="lnt">3552
</span><span class="lnt">3553
</span><span class="lnt">3554
</span><span class="lnt">3555
</span><span class="lnt">3556
</span><span class="lnt">3557
</span><span class="lnt">3558
</span><span class="lnt">3559
</span><span class="lnt">3560
</span><span class="lnt">3561
</span><span class="lnt">3562
</span><span class="lnt">3563
</span><span class="lnt">3564
</span><span class="lnt">3565
</span><span class="lnt">3566
</span><span class="lnt">3567
</span><span class="lnt">3568
</span><span class="lnt">3569
</span><span class="lnt">3570
</span><span class="lnt">3571
</span><span class="lnt">3572
</span><span class="lnt">3573
</span><span class="lnt">3574
</span><span class="lnt">3575
</span><span class="lnt">3576
</span><span class="lnt">3577
</span><span class="lnt">3578
</span><span class="lnt">3579
</span><span class="lnt">3580
</span><span class="lnt">3581
</span><span class="lnt">3582
</span><span class="lnt">3583
</span><span class="lnt">3584
</span><span class="lnt">3585
</span><span class="lnt">3586
</span><span class="lnt">3587
</span><span class="lnt">3588
</span><span class="lnt">3589
</span><span class="lnt">3590
</span><span class="lnt">3591
</span><span class="lnt">3592
</span><span class="lnt">3593
</span><span class="lnt">3594
</span><span class="lnt">3595
</span><span class="lnt">3596
</span><span class="lnt">3597
</span><span class="lnt">3598
</span><span class="lnt">3599
</span><span class="lnt">3600
</span><span class="lnt">3601
</span><span class="lnt">3602
</span><span class="lnt">3603
</span><span class="lnt">3604
</span><span class="lnt">3605
</span><span class="lnt">3606
</span><span class="lnt">3607
</span><span class="lnt">3608
</span><span class="lnt">3609
</span><span class="lnt">3610
</span><span class="lnt">3611
</span><span class="lnt">3612
</span><span class="lnt">3613
</span><span class="lnt">3614
</span><span class="lnt">3615
</span><span class="lnt">3616
</span><span class="lnt">3617
</span><span class="lnt">3618
</span><span class="lnt">3619
</span><span class="lnt">3620
</span><span class="lnt">3621
</span><span class="lnt">3622
</span><span class="lnt">3623
</span><span class="lnt">3624
</span><span class="lnt">3625
</span><span class="lnt">3626
</span><span class="lnt">3627
</span><span class="lnt">3628
</span><span class="lnt">3629
</span><span class="lnt">3630
</span><span class="lnt">3631
</span><span class="lnt">3632
</span><span class="lnt">3633
</span><span class="lnt">3634
</span><span class="lnt">3635
</span><span class="lnt">3636
</span><span class="lnt">3637
</span><span class="lnt">3638
</span><span class="lnt">3639
</span><span class="lnt">3640
</span><span class="lnt">3641
</span><span class="lnt">3642
</span><span class="lnt">3643
</span><span class="lnt">3644
</span><span class="lnt">3645
</span><span class="lnt">3646
</span><span class="lnt">3647
</span><span class="lnt">3648
</span><span class="lnt">3649
</span><span class="lnt">3650
</span><span class="lnt">3651
</span><span class="lnt">3652
</span><span class="lnt">3653
</span><span class="lnt">3654
</span><span class="lnt">3655
</span><span class="lnt">3656
</span><span class="lnt">3657
</span><span class="lnt">3658
</span><span class="lnt">3659
</span><span class="lnt">3660
</span><span class="lnt">3661
</span><span class="lnt">3662
</span><span class="lnt">3663
</span><span class="lnt">3664
</span><span class="lnt">3665
</span><span class="lnt">3666
</span><span class="lnt">3667
</span><span class="lnt">3668
</span><span class="lnt">3669
</span><span class="lnt">3670
</span><span class="lnt">3671
</span><span class="lnt">3672
</span><span class="lnt">3673
</span><span class="lnt">3674
</span><span class="lnt">3675
</span><span class="lnt">3676
</span><span class="lnt">3677
</span><span class="lnt">3678
</span><span class="lnt">3679
</span><span class="lnt">3680
</span><span class="lnt">3681
</span><span class="lnt">3682
</span><span class="lnt">3683
</span><span class="lnt">3684
</span><span class="lnt">3685
</span><span class="lnt">3686
</span><span class="lnt">3687
</span><span class="lnt">3688
</span><span class="lnt">3689
</span><span class="lnt">3690
</span><span class="lnt">3691
</span><span class="lnt">3692
</span><span class="lnt">3693
</span><span class="lnt">3694
</span><span class="lnt">3695
</span><span class="lnt">3696
</span><span class="lnt">3697
</span><span class="lnt">3698
</span><span class="lnt">3699
</span><span class="lnt">3700
</span><span class="lnt">3701
</span><span class="lnt">3702
</span><span class="lnt">3703
</span><span class="lnt">3704
</span><span class="lnt">3705
</span><span class="lnt">3706
</span><span class="lnt">3707
</span><span class="lnt">3708
</span><span class="lnt">3709
</span><span class="lnt">3710
</span><span class="lnt">3711
</span><span class="lnt">3712
</span><span class="lnt">3713
</span><span class="lnt">3714
</span><span class="lnt">3715
</span><span class="lnt">3716
</span><span class="lnt">3717
</span><span class="lnt">3718
</span><span class="lnt">3719
</span><span class="lnt">3720
</span><span class="lnt">3721
</span><span class="lnt">3722
</span><span class="lnt">3723
</span><span class="lnt">3724
</span><span class="lnt">3725
</span><span class="lnt">3726
</span><span class="lnt">3727
</span><span class="lnt">3728
</span><span class="lnt">3729
</span><span class="lnt">3730
</span><span class="lnt">3731
</span><span class="lnt">3732
</span><span class="lnt">3733
</span><span class="lnt">3734
</span><span class="lnt">3735
</span><span class="lnt">3736
</span><span class="lnt">3737
</span><span class="lnt">3738
</span><span class="lnt">3739
</span><span class="lnt">3740
</span><span class="lnt">3741
</span><span class="lnt">3742
</span><span class="lnt">3743
</span><span class="lnt">3744
</span><span class="lnt">3745
</span><span class="lnt">3746
</span><span class="lnt">3747
</span><span class="lnt">3748
</span><span class="lnt">3749
</span><span class="lnt">3750
</span><span class="lnt">3751
</span><span class="lnt">3752
</span><span class="lnt">3753
</span><span class="lnt">3754
</span><span class="lnt">3755
</span><span class="lnt">3756
</span><span class="lnt">3757
</span><span class="lnt">3758
</span><span class="lnt">3759
</span><span class="lnt">3760
</span><span class="lnt">3761
</span><span class="lnt">3762
</span><span class="lnt">3763
</span><span class="lnt">3764
</span><span class="lnt">3765
</span><span class="lnt">3766
</span><span class="lnt">3767
</span><span class="lnt">3768
</span><span class="lnt">3769
</span><span class="lnt">3770
</span><span class="lnt">3771
</span><span class="lnt">3772
</span><span class="lnt">3773
</span><span class="lnt">3774
</span><span class="lnt">3775
</span><span class="lnt">3776
</span><span class="lnt">3777
</span><span class="lnt">3778
</span><span class="lnt">3779
</span><span class="lnt">3780
</span><span class="lnt">3781
</span><span class="lnt">3782
</span><span class="lnt">3783
</span><span class="lnt">3784
</span><span class="lnt">3785
</span><span class="lnt">3786
</span><span class="lnt">3787
</span><span class="lnt">3788
</span><span class="lnt">3789
</span><span class="lnt">3790
</span><span class="lnt">3791
</span><span class="lnt">3792
</span><span class="lnt">3793
</span><span class="lnt">3794
</span><span class="lnt">3795
</span><span class="lnt">3796
</span><span class="lnt">3797
</span><span class="lnt">3798
</span><span class="lnt">3799
</span><span class="lnt">3800
</span><span class="lnt">3801
</span><span class="lnt">3802
</span><span class="lnt">3803
</span><span class="lnt">3804
</span><span class="lnt">3805
</span><span class="lnt">3806
</span><span class="lnt">3807
</span><span class="lnt">3808
</span><span class="lnt">3809
</span><span class="lnt">3810
</span><span class="lnt">3811
</span><span class="lnt">3812
</span><span class="lnt">3813
</span><span class="lnt">3814
</span><span class="lnt">3815
</span><span class="lnt">3816
</span><span class="lnt">3817
</span><span class="lnt">3818
</span><span class="lnt">3819
</span><span class="lnt">3820
</span><span class="lnt">3821
</span><span class="lnt">3822
</span><span class="lnt">3823
</span><span class="lnt">3824
</span><span class="lnt">3825
</span><span class="lnt">3826
</span><span class="lnt">3827
</span><span class="lnt">3828
</span><span class="lnt">3829
</span><span class="lnt">3830
</span><span class="lnt">3831
</span><span class="lnt">3832
</span><span class="lnt">3833
</span><span class="lnt">3834
</span><span class="lnt">3835
</span><span class="lnt">3836
</span><span class="lnt">3837
</span><span class="lnt">3838
</span><span class="lnt">3839
</span><span class="lnt">3840
</span><span class="lnt">3841
</span><span class="lnt">3842
</span><span class="lnt">3843
</span><span class="lnt">3844
</span><span class="lnt">3845
</span><span class="lnt">3846
</span><span class="lnt">3847
</span><span class="lnt">3848
</span><span class="lnt">3849
</span><span class="lnt">3850
</span><span class="lnt">3851
</span><span class="lnt">3852
</span><span class="lnt">3853
</span><span class="lnt">3854
</span><span class="lnt">3855
</span><span class="lnt">3856
</span><span class="lnt">3857
</span><span class="lnt">3858
</span><span class="lnt">3859
</span><span class="lnt">3860
</span><span class="lnt">3861
</span><span class="lnt">3862
</span><span class="lnt">3863
</span><span class="lnt">3864
</span><span class="lnt">3865
</span><span class="lnt">3866
</span><span class="lnt">3867
</span><span class="lnt">3868
</span><span class="lnt">3869
</span><span class="lnt">3870
</span><span class="lnt">3871
</span><span class="lnt">3872
</span><span class="lnt">3873
</span><span class="lnt">3874
</span><span class="lnt">3875
</span><span class="lnt">3876
</span><span class="lnt">3877
</span><span class="lnt">3878
</span><span class="lnt">3879
</span><span class="lnt">3880
</span><span class="lnt">3881
</span><span class="lnt">3882
</span><span class="lnt">3883
</span><span class="lnt">3884
</span><span class="lnt">3885
</span><span class="lnt">3886
</span><span class="lnt">3887
</span><span class="lnt">3888
</span><span class="lnt">3889
</span><span class="lnt">3890
</span><span class="lnt">3891
</span><span class="lnt">3892
</span><span class="lnt">3893
</span><span class="lnt">3894
</span><span class="lnt">3895
</span><span class="lnt">3896
</span><span class="lnt">3897
</span><span class="lnt">3898
</span><span class="lnt">3899
</span><span class="lnt">3900
</span><span class="lnt">3901
</span><span class="lnt">3902
</span><span class="lnt">3903
</span><span class="lnt">3904
</span><span class="lnt">3905
</span><span class="lnt">3906
</span><span class="lnt">3907
</span><span class="lnt">3908
</span><span class="lnt">3909
</span><span class="lnt">3910
</span><span class="lnt">3911
</span><span class="lnt">3912
</span><span class="lnt">3913
</span><span class="lnt">3914
</span><span class="lnt">3915
</span><span class="lnt">3916
</span><span class="lnt">3917
</span><span class="lnt">3918
</span><span class="lnt">3919
</span><span class="lnt">3920
</span><span class="lnt">3921
</span><span class="lnt">3922
</span><span class="lnt">3923
</span><span class="lnt">3924
</span><span class="lnt">3925
</span><span class="lnt">3926
</span><span class="lnt">3927
</span><span class="lnt">3928
</span><span class="lnt">3929
</span><span class="lnt">3930
</span><span class="lnt">3931
</span><span class="lnt">3932
</span><span class="lnt">3933
</span><span class="lnt">3934
</span><span class="lnt">3935
</span><span class="lnt">3936
</span><span class="lnt">3937
</span><span class="lnt">3938
</span><span class="lnt">3939
</span><span class="lnt">3940
</span><span class="lnt">3941
</span><span class="lnt">3942
</span><span class="lnt">3943
</span><span class="lnt">3944
</span><span class="lnt">3945
</span><span class="lnt">3946
</span><span class="lnt">3947
</span><span class="lnt">3948
</span><span class="lnt">3949
</span><span class="lnt">3950
</span><span class="lnt">3951
</span><span class="lnt">3952
</span><span class="lnt">3953
</span><span class="lnt">3954
</span><span class="lnt">3955
</span><span class="lnt">3956
</span><span class="lnt">3957
</span><span class="lnt">3958
</span><span class="lnt">3959
</span><span class="lnt">3960
</span><span class="lnt">3961
</span><span class="lnt">3962
</span><span class="lnt">3963
</span><span class="lnt">3964
</span><span class="lnt">3965
</span><span class="lnt">3966
</span><span class="lnt">3967
</span><span class="lnt">3968
</span><span class="lnt">3969
</span><span class="lnt">3970
</span><span class="lnt">3971
</span><span class="lnt">3972
</span><span class="lnt">3973
</span><span class="lnt">3974
</span><span class="lnt">3975
</span><span class="lnt">3976
</span><span class="lnt">3977
</span><span class="lnt">3978
</span><span class="lnt">3979
</span><span class="lnt">3980
</span><span class="lnt">3981
</span><span class="lnt">3982
</span><span class="lnt">3983
</span><span class="lnt">3984
</span><span class="lnt">3985
</span><span class="lnt">3986
</span><span class="lnt">3987
</span><span class="lnt">3988
</span><span class="lnt">3989
</span><span class="lnt">3990
</span><span class="lnt">3991
</span><span class="lnt">3992
</span><span class="lnt">3993
</span><span class="lnt">3994
</span><span class="lnt">3995
</span><span class="lnt">3996
</span><span class="lnt">3997
</span><span class="lnt">3998
</span><span class="lnt">3999
</span><span class="lnt">4000
</span><span class="lnt">4001
</span><span class="lnt">4002
</span><span class="lnt">4003
</span><span class="lnt">4004
</span><span class="lnt">4005
</span><span class="lnt">4006
</span><span class="lnt">4007
</span><span class="lnt">4008
</span><span class="lnt">4009
</span><span class="lnt">4010
</span><span class="lnt">4011
</span><span class="lnt">4012
</span><span class="lnt">4013
</span><span class="lnt">4014
</span><span class="lnt">4015
</span><span class="lnt">4016
</span><span class="lnt">4017
</span><span class="lnt">4018
</span><span class="lnt">4019
</span><span class="lnt">4020
</span><span class="lnt">4021
</span><span class="lnt">4022
</span><span class="lnt">4023
</span><span class="lnt">4024
</span><span class="lnt">4025
</span><span class="lnt">4026
</span><span class="lnt">4027
</span><span class="lnt">4028
</span><span class="lnt">4029
</span><span class="lnt">4030
</span><span class="lnt">4031
</span><span class="lnt">4032
</span><span class="lnt">4033
</span><span class="lnt">4034
</span><span class="lnt">4035
</span><span class="lnt">4036
</span><span class="lnt">4037
</span><span class="lnt">4038
</span><span class="lnt">4039
</span><span class="lnt">4040
</span><span class="lnt">4041
</span><span class="lnt">4042
</span><span class="lnt">4043
</span><span class="lnt">4044
</span><span class="lnt">4045
</span><span class="lnt">4046
</span><span class="lnt">4047
</span><span class="lnt">4048
</span><span class="lnt">4049
</span><span class="lnt">4050
</span><span class="lnt">4051
</span><span class="lnt">4052
</span><span class="lnt">4053
</span><span class="lnt">4054
</span><span class="lnt">4055
</span><span class="lnt">4056
</span><span class="lnt">4057
</span><span class="lnt">4058
</span><span class="lnt">4059
</span><span class="lnt">4060
</span><span class="lnt">4061
</span><span class="lnt">4062
</span><span class="lnt">4063
</span><span class="lnt">4064
</span><span class="lnt">4065
</span><span class="lnt">4066
</span><span class="lnt">4067
</span><span class="lnt">4068
</span><span class="lnt">4069
</span><span class="lnt">4070
</span><span class="lnt">4071
</span><span class="lnt">4072
</span><span class="lnt">4073
</span><span class="lnt">4074
</span><span class="lnt">4075
</span><span class="lnt">4076
</span><span class="lnt">4077
</span><span class="lnt">4078
</span><span class="lnt">4079
</span><span class="lnt">4080
</span><span class="lnt">4081
</span><span class="lnt">4082
</span><span class="lnt">4083
</span><span class="lnt">4084
</span><span class="lnt">4085
</span><span class="lnt">4086
</span><span class="lnt">4087
</span><span class="lnt">4088
</span><span class="lnt">4089
</span><span class="lnt">4090
</span><span class="lnt">4091
</span><span class="lnt">4092
</span><span class="lnt">4093
</span><span class="lnt">4094
</span><span class="lnt">4095
</span><span class="lnt">4096
</span><span class="lnt">4097
</span><span class="lnt">4098
</span><span class="lnt">4099
</span><span class="lnt">4100
</span><span class="lnt">4101
</span><span class="lnt">4102
</span><span class="lnt">4103
</span><span class="lnt">4104
</span><span class="lnt">4105
</span><span class="lnt">4106
</span><span class="lnt">4107
</span><span class="lnt">4108
</span><span class="lnt">4109
</span><span class="lnt">4110
</span><span class="lnt">4111
</span><span class="lnt">4112
</span><span class="lnt">4113
</span><span class="lnt">4114
</span><span class="lnt">4115
</span><span class="lnt">4116
</span><span class="lnt">4117
</span><span class="lnt">4118
</span><span class="lnt">4119
</span><span class="lnt">4120
</span><span class="lnt">4121
</span><span class="lnt">4122
</span><span class="lnt">4123
</span><span class="lnt">4124
</span><span class="lnt">4125
</span><span class="lnt">4126
</span><span class="lnt">4127
</span><span class="lnt">4128
</span><span class="lnt">4129
</span><span class="lnt">4130
</span><span class="lnt">4131
</span><span class="lnt">4132
</span><span class="lnt">4133
</span><span class="lnt">4134
</span><span class="lnt">4135
</span><span class="lnt">4136
</span><span class="lnt">4137
</span><span class="lnt">4138
</span><span class="lnt">4139
</span><span class="lnt">4140
</span><span class="lnt">4141
</span><span class="lnt">4142
</span><span class="lnt">4143
</span><span class="lnt">4144
</span><span class="lnt">4145
</span><span class="lnt">4146
</span><span class="lnt">4147
</span><span class="lnt">4148
</span><span class="lnt">4149
</span><span class="lnt">4150
</span><span class="lnt">4151
</span><span class="lnt">4152
</span><span class="lnt">4153
</span><span class="lnt">4154
</span><span class="lnt">4155
</span><span class="lnt">4156
</span><span class="lnt">4157
</span><span class="lnt">4158
</span><span class="lnt">4159
</span><span class="lnt">4160
</span><span class="lnt">4161
</span><span class="lnt">4162
</span><span class="lnt">4163
</span><span class="lnt">4164
</span><span class="lnt">4165
</span><span class="lnt">4166
</span><span class="lnt">4167
</span><span class="lnt">4168
</span><span class="lnt">4169
</span><span class="lnt">4170
</span><span class="lnt">4171
</span><span class="lnt">4172
</span><span class="lnt">4173
</span><span class="lnt">4174
</span><span class="lnt">4175
</span><span class="lnt">4176
</span><span class="lnt">4177
</span><span class="lnt">4178
</span><span class="lnt">4179
</span><span class="lnt">4180
</span><span class="lnt">4181
</span><span class="lnt">4182
</span><span class="lnt">4183
</span><span class="lnt">4184
</span><span class="lnt">4185
</span><span class="lnt">4186
</span><span class="lnt">4187
</span><span class="lnt">4188
</span><span class="lnt">4189
</span><span class="lnt">4190
</span><span class="lnt">4191
</span><span class="lnt">4192
</span><span class="lnt">4193
</span><span class="lnt">4194
</span><span class="lnt">4195
</span><span class="lnt">4196
</span><span class="lnt">4197
</span><span class="lnt">4198
</span><span class="lnt">4199
</span><span class="lnt">4200
</span><span class="lnt">4201
</span><span class="lnt">4202
</span><span class="lnt">4203
</span><span class="lnt">4204
</span><span class="lnt">4205
</span><span class="lnt">4206
</span><span class="lnt">4207
</span><span class="lnt">4208
</span><span class="lnt">4209
</span><span class="lnt">4210
</span><span class="lnt">4211
</span><span class="lnt">4212
</span><span class="lnt">4213
</span><span class="lnt">4214
</span><span class="lnt">4215
</span><span class="lnt">4216
</span><span class="lnt">4217
</span><span class="lnt">4218
</span><span class="lnt">4219
</span><span class="lnt">4220
</span><span class="lnt">4221
</span><span class="lnt">4222
</span><span class="lnt">4223
</span><span class="lnt">4224
</span><span class="lnt">4225
</span><span class="lnt">4226
</span><span class="lnt">4227
</span><span class="lnt">4228
</span><span class="lnt">4229
</span><span class="lnt">4230
</span><span class="lnt">4231
</span><span class="lnt">4232
</span><span class="lnt">4233
</span><span class="lnt">4234
</span><span class="lnt">4235
</span><span class="lnt">4236
</span><span class="lnt">4237
</span><span class="lnt">4238
</span><span class="lnt">4239
</span><span class="lnt">4240
</span><span class="lnt">4241
</span><span class="lnt">4242
</span><span class="lnt">4243
</span><span class="lnt">4244
</span><span class="lnt">4245
</span><span class="lnt">4246
</span><span class="lnt">4247
</span><span class="lnt">4248
</span><span class="lnt">4249
</span><span class="lnt">4250
</span><span class="lnt">4251
</span><span class="lnt">4252
</span><span class="lnt">4253
</span><span class="lnt">4254
</span><span class="lnt">4255
</span><span class="lnt">4256
</span><span class="lnt">4257
</span><span class="lnt">4258
</span><span class="lnt">4259
</span><span class="lnt">4260
</span><span class="lnt">4261
</span><span class="lnt">4262
</span><span class="lnt">4263
</span><span class="lnt">4264
</span><span class="lnt">4265
</span><span class="lnt">4266
</span><span class="lnt">4267
</span><span class="lnt">4268
</span><span class="lnt">4269
</span><span class="lnt">4270
</span><span class="lnt">4271
</span><span class="lnt">4272
</span><span class="lnt">4273
</span><span class="lnt">4274
</span><span class="lnt">4275
</span><span class="lnt">4276
</span><span class="lnt">4277
</span><span class="lnt">4278
</span><span class="lnt">4279
</span><span class="lnt">4280
</span><span class="lnt">4281
</span><span class="lnt">4282
</span><span class="lnt">4283
</span><span class="lnt">4284
</span><span class="lnt">4285
</span><span class="lnt">4286
</span><span class="lnt">4287
</span><span class="lnt">4288
</span><span class="lnt">4289
</span><span class="lnt">4290
</span><span class="lnt">4291
</span><span class="lnt">4292
</span><span class="lnt">4293
</span><span class="lnt">4294
</span><span class="lnt">4295
</span><span class="lnt">4296
</span><span class="lnt">4297
</span><span class="lnt">4298
</span><span class="lnt">4299
</span><span class="lnt">4300
</span><span class="lnt">4301
</span><span class="lnt">4302
</span><span class="lnt">4303
</span><span class="lnt">4304
</span><span class="lnt">4305
</span><span class="lnt">4306
</span><span class="lnt">4307
</span><span class="lnt">4308
</span><span class="lnt">4309
</span><span class="lnt">4310
</span><span class="lnt">4311
</span><span class="lnt">4312
</span><span class="lnt">4313
</span><span class="lnt">4314
</span><span class="lnt">4315
</span><span class="lnt">4316
</span><span class="lnt">4317
</span><span class="lnt">4318
</span><span class="lnt">4319
</span><span class="lnt">4320
</span><span class="lnt">4321
</span><span class="lnt">4322
</span><span class="lnt">4323
</span><span class="lnt">4324
</span><span class="lnt">4325
</span><span class="lnt">4326
</span><span class="lnt">4327
</span><span class="lnt">4328
</span><span class="lnt">4329
</span><span class="lnt">4330
</span><span class="lnt">4331
</span><span class="lnt">4332
</span><span class="lnt">4333
</span><span class="lnt">4334
</span><span class="lnt">4335
</span><span class="lnt">4336
</span><span class="lnt">4337
</span><span class="lnt">4338
</span><span class="lnt">4339
</span><span class="lnt">4340
</span><span class="lnt">4341
</span><span class="lnt">4342
</span><span class="lnt">4343
</span><span class="lnt">4344
</span><span class="lnt">4345
</span><span class="lnt">4346
</span><span class="lnt">4347
</span><span class="lnt">4348
</span><span class="lnt">4349
</span><span class="lnt">4350
</span><span class="lnt">4351
</span><span class="lnt">4352
</span><span class="lnt">4353
</span><span class="lnt">4354
</span><span class="lnt">4355
</span><span class="lnt">4356
</span><span class="lnt">4357
</span><span class="lnt">4358
</span><span class="lnt">4359
</span><span class="lnt">4360
</span><span class="lnt">4361
</span><span class="lnt">4362
</span><span class="lnt">4363
</span><span class="lnt">4364
</span><span class="lnt">4365
</span><span class="lnt">4366
</span><span class="lnt">4367
</span><span class="lnt">4368
</span><span class="lnt">4369
</span><span class="lnt">4370
</span><span class="lnt">4371
</span><span class="lnt">4372
</span><span class="lnt">4373
</span><span class="lnt">4374
</span><span class="lnt">4375
</span><span class="lnt">4376
</span><span class="lnt">4377
</span><span class="lnt">4378
</span><span class="lnt">4379
</span><span class="lnt">4380
</span><span class="lnt">4381
</span><span class="lnt">4382
</span><span class="lnt">4383
</span><span class="lnt">4384
</span><span class="lnt">4385
</span><span class="lnt">4386
</span><span class="lnt">4387
</span><span class="lnt">4388
</span><span class="lnt">4389
</span><span class="lnt">4390
</span><span class="lnt">4391
</span><span class="lnt">4392
</span><span class="lnt">4393
</span><span class="lnt">4394
</span><span class="lnt">4395
</span><span class="lnt">4396
</span><span class="lnt">4397
</span><span class="lnt">4398
</span><span class="lnt">4399
</span><span class="lnt">4400
</span><span class="lnt">4401
</span><span class="lnt">4402
</span><span class="lnt">4403
</span><span class="lnt">4404
</span><span class="lnt">4405
</span><span class="lnt">4406
</span><span class="lnt">4407
</span><span class="lnt">4408
</span><span class="lnt">4409
</span><span class="lnt">4410
</span><span class="lnt">4411
</span><span class="lnt">4412
</span><span class="lnt">4413
</span><span class="lnt">4414
</span><span class="lnt">4415
</span><span class="lnt">4416
</span><span class="lnt">4417
</span><span class="lnt">4418
</span><span class="lnt">4419
</span><span class="lnt">4420
</span><span class="lnt">4421
</span><span class="lnt">4422
</span><span class="lnt">4423
</span><span class="lnt">4424
</span><span class="lnt">4425
</span><span class="lnt">4426
</span><span class="lnt">4427
</span><span class="lnt">4428
</span><span class="lnt">4429
</span><span class="lnt">4430
</span><span class="lnt">4431
</span><span class="lnt">4432
</span><span class="lnt">4433
</span><span class="lnt">4434
</span><span class="lnt">4435
</span><span class="lnt">4436
</span><span class="lnt">4437
</span><span class="lnt">4438
</span><span class="lnt">4439
</span><span class="lnt">4440
</span><span class="lnt">4441
</span><span class="lnt">4442
</span><span class="lnt">4443
</span><span class="lnt">4444
</span><span class="lnt">4445
</span><span class="lnt">4446
</span><span class="lnt">4447
</span><span class="lnt">4448
</span><span class="lnt">4449
</span><span class="lnt">4450
</span><span class="lnt">4451
</span><span class="lnt">4452
</span><span class="lnt">4453
</span><span class="lnt">4454
</span><span class="lnt">4455
</span><span class="lnt">4456
</span><span class="lnt">4457
</span><span class="lnt">4458
</span><span class="lnt">4459
</span><span class="lnt">4460
</span><span class="lnt">4461
</span><span class="lnt">4462
</span><span class="lnt">4463
</span><span class="lnt">4464
</span><span class="lnt">4465
</span><span class="lnt">4466
</span><span class="lnt">4467
</span><span class="lnt">4468
</span><span class="lnt">4469
</span><span class="lnt">4470
</span><span class="lnt">4471
</span><span class="lnt">4472
</span><span class="lnt">4473
</span><span class="lnt">4474
</span><span class="lnt">4475
</span><span class="lnt">4476
</span><span class="lnt">4477
</span><span class="lnt">4478
</span><span class="lnt">4479
</span><span class="lnt">4480
</span><span class="lnt">4481
</span><span class="lnt">4482
</span><span class="lnt">4483
</span><span class="lnt">4484
</span><span class="lnt">4485
</span><span class="lnt">4486
</span><span class="lnt">4487
</span><span class="lnt">4488
</span><span class="lnt">4489
</span><span class="lnt">4490
</span><span class="lnt">4491
</span><span class="lnt">4492
</span><span class="lnt">4493
</span><span class="lnt">4494
</span><span class="lnt">4495
</span><span class="lnt">4496
</span><span class="lnt">4497
</span><span class="lnt">4498
</span><span class="lnt">4499
</span><span class="lnt">4500
</span><span class="lnt">4501
</span><span class="lnt">4502
</span><span class="lnt">4503
</span><span class="lnt">4504
</span><span class="lnt">4505
</span><span class="lnt">4506
</span><span class="lnt">4507
</span><span class="lnt">4508
</span><span class="lnt">4509
</span><span class="lnt">4510
</span><span class="lnt">4511
</span><span class="lnt">4512
</span><span class="lnt">4513
</span><span class="lnt">4514
</span><span class="lnt">4515
</span><span class="lnt">4516
</span><span class="lnt">4517
</span><span class="lnt">4518
</span><span class="lnt">4519
</span><span class="lnt">4520
</span><span class="lnt">4521
</span><span class="lnt">4522
</span><span class="lnt">4523
</span><span class="lnt">4524
</span><span class="lnt">4525
</span><span class="lnt">4526
</span><span class="lnt">4527
</span><span class="lnt">4528
</span><span class="lnt">4529
</span><span class="lnt">4530
</span><span class="lnt">4531
</span><span class="lnt">4532
</span><span class="lnt">4533
</span><span class="lnt">4534
</span><span class="lnt">4535
</span><span class="lnt">4536
</span><span class="lnt">4537
</span><span class="lnt">4538
</span><span class="lnt">4539
</span><span class="lnt">4540
</span><span class="lnt">4541
</span><span class="lnt">4542
</span><span class="lnt">4543
</span><span class="lnt">4544
</span><span class="lnt">4545
</span><span class="lnt">4546
</span><span class="lnt">4547
</span><span class="lnt">4548
</span><span class="lnt">4549
</span><span class="lnt">4550
</span><span class="lnt">4551
</span><span class="lnt">4552
</span><span class="lnt">4553
</span><span class="lnt">4554
</span><span class="lnt">4555
</span><span class="lnt">4556
</span><span class="lnt">4557
</span><span class="lnt">4558
</span><span class="lnt">4559
</span><span class="lnt">4560
</span><span class="lnt">4561
</span><span class="lnt">4562
</span><span class="lnt">4563
</span><span class="lnt">4564
</span><span class="lnt">4565
</span><span class="lnt">4566
</span><span class="lnt">4567
</span><span class="lnt">4568
</span><span class="lnt">4569
</span><span class="lnt">4570
</span><span class="lnt">4571
</span><span class="lnt">4572
</span><span class="lnt">4573
</span><span class="lnt">4574
</span><span class="lnt">4575
</span><span class="lnt">4576
</span><span class="lnt">4577
</span><span class="lnt">4578
</span><span class="lnt">4579
</span><span class="lnt">4580
</span><span class="lnt">4581
</span><span class="lnt">4582
</span><span class="lnt">4583
</span><span class="lnt">4584
</span><span class="lnt">4585
</span><span class="lnt">4586
</span><span class="lnt">4587
</span><span class="lnt">4588
</span><span class="lnt">4589
</span><span class="lnt">4590
</span><span class="lnt">4591
</span><span class="lnt">4592
</span><span class="lnt">4593
</span><span class="lnt">4594
</span><span class="lnt">4595
</span><span class="lnt">4596
</span><span class="lnt">4597
</span><span class="lnt">4598
</span><span class="lnt">4599
</span><span class="lnt">4600
</span><span class="lnt">4601
</span><span class="lnt">4602
</span><span class="lnt">4603
</span><span class="lnt">4604
</span><span class="lnt">4605
</span><span class="lnt">4606
</span><span class="lnt">4607
</span><span class="lnt">4608
</span><span class="lnt">4609
</span><span class="lnt">4610
</span><span class="lnt">4611
</span><span class="lnt">4612
</span><span class="lnt">4613
</span><span class="lnt">4614
</span><span class="lnt">4615
</span><span class="lnt">4616
</span><span class="lnt">4617
</span><span class="lnt">4618
</span><span class="lnt">4619
</span><span class="lnt">4620
</span><span class="lnt">4621
</span><span class="lnt">4622
</span><span class="lnt">4623
</span><span class="lnt">4624
</span><span class="lnt">4625
</span><span class="lnt">4626
</span><span class="lnt">4627
</span><span class="lnt">4628
</span><span class="lnt">4629
</span><span class="lnt">4630
</span><span class="lnt">4631
</span><span class="lnt">4632
</span><span class="lnt">4633
</span><span class="lnt">4634
</span><span class="lnt">4635
</span><span class="lnt">4636
</span><span class="lnt">4637
</span><span class="lnt">4638
</span><span class="lnt">4639
</span><span class="lnt">4640
</span><span class="lnt">4641
</span><span class="lnt">4642
</span><span class="lnt">4643
</span><span class="lnt">4644
</span><span class="lnt">4645
</span><span class="lnt">4646
</span><span class="lnt">4647
</span><span class="lnt">4648
</span><span class="lnt">4649
</span><span class="lnt">4650
</span><span class="lnt">4651
</span><span class="lnt">4652
</span><span class="lnt">4653
</span><span class="lnt">4654
</span><span class="lnt">4655
</span><span class="lnt">4656
</span><span class="lnt">4657
</span><span class="lnt">4658
</span><span class="lnt">4659
</span><span class="lnt">4660
</span><span class="lnt">4661
</span><span class="lnt">4662
</span><span class="lnt">4663
</span><span class="lnt">4664
</span><span class="lnt">4665
</span><span class="lnt">4666
</span><span class="lnt">4667
</span><span class="lnt">4668
</span><span class="lnt">4669
</span><span class="lnt">4670
</span><span class="lnt">4671
</span><span class="lnt">4672
</span><span class="lnt">4673
</span><span class="lnt">4674
</span><span class="lnt">4675
</span><span class="lnt">4676
</span><span class="lnt">4677
</span><span class="lnt">4678
</span><span class="lnt">4679
</span><span class="lnt">4680
</span><span class="lnt">4681
</span><span class="lnt">4682
</span><span class="lnt">4683
</span><span class="lnt">4684
</span><span class="lnt">4685
</span><span class="lnt">4686
</span><span class="lnt">4687
</span><span class="lnt">4688
</span><span class="lnt">4689
</span><span class="lnt">4690
</span><span class="lnt">4691
</span><span class="lnt">4692
</span><span class="lnt">4693
</span><span class="lnt">4694
</span><span class="lnt">4695
</span><span class="lnt">4696
</span><span class="lnt">4697
</span><span class="lnt">4698
</span><span class="lnt">4699
</span><span class="lnt">4700
</span><span class="lnt">4701
</span><span class="lnt">4702
</span><span class="lnt">4703
</span><span class="lnt">4704
</span><span class="lnt">4705
</span><span class="lnt">4706
</span><span class="lnt">4707
</span><span class="lnt">4708
</span><span class="lnt">4709
</span><span class="lnt">4710
</span><span class="lnt">4711
</span><span class="lnt">4712
</span><span class="lnt">4713
</span><span class="lnt">4714
</span><span class="lnt">4715
</span><span class="lnt">4716
</span><span class="lnt">4717
</span><span class="lnt">4718
</span><span class="lnt">4719
</span><span class="lnt">4720
</span><span class="lnt">4721
</span><span class="lnt">4722
</span><span class="lnt">4723
</span><span class="lnt">4724
</span><span class="lnt">4725
</span><span class="lnt">4726
</span><span class="lnt">4727
</span><span class="lnt">4728
</span><span class="lnt">4729
</span><span class="lnt">4730
</span><span class="lnt">4731
</span><span class="lnt">4732
</span><span class="lnt">4733
</span><span class="lnt">4734
</span><span class="lnt">4735
</span><span class="lnt">4736
</span><span class="lnt">4737
</span><span class="lnt">4738
</span><span class="lnt">4739
</span><span class="lnt">4740
</span><span class="lnt">4741
</span><span class="lnt">4742
</span><span class="lnt">4743
</span><span class="lnt">4744
</span><span class="lnt">4745
</span><span class="lnt">4746
</span><span class="lnt">4747
</span><span class="lnt">4748
</span><span class="lnt">4749
</span><span class="lnt">4750
</span><span class="lnt">4751
</span><span class="lnt">4752
</span><span class="lnt">4753
</span><span class="lnt">4754
</span><span class="lnt">4755
</span><span class="lnt">4756
</span><span class="lnt">4757
</span><span class="lnt">4758
</span><span class="lnt">4759
</span><span class="lnt">4760
</span><span class="lnt">4761
</span><span class="lnt">4762
</span><span class="lnt">4763
</span><span class="lnt">4764
</span><span class="lnt">4765
</span><span class="lnt">4766
</span><span class="lnt">4767
</span><span class="lnt">4768
</span><span class="lnt">4769
</span><span class="lnt">4770
</span><span class="lnt">4771
</span><span class="lnt">4772
</span><span class="lnt">4773
</span><span class="lnt">4774
</span><span class="lnt">4775
</span><span class="lnt">4776
</span><span class="lnt">4777
</span><span class="lnt">4778
</span><span class="lnt">4779
</span><span class="lnt">4780
</span><span class="lnt">4781
</span><span class="lnt">4782
</span><span class="lnt">4783
</span><span class="lnt">4784
</span><span class="lnt">4785
</span><span class="lnt">4786
</span><span class="lnt">4787
</span><span class="lnt">4788
</span><span class="lnt">4789
</span><span class="lnt">4790
</span><span class="lnt">4791
</span><span class="lnt">4792
</span><span class="lnt">4793
</span><span class="lnt">4794
</span><span class="lnt">4795
</span><span class="lnt">4796
</span><span class="lnt">4797
</span><span class="lnt">4798
</span><span class="lnt">4799
</span><span class="lnt">4800
</span><span class="lnt">4801
</span><span class="lnt">4802
</span><span class="lnt">4803
</span><span class="lnt">4804
</span><span class="lnt">4805
</span><span class="lnt">4806
</span><span class="lnt">4807
</span><span class="lnt">4808
</span><span class="lnt">4809
</span><span class="lnt">4810
</span><span class="lnt">4811
</span><span class="lnt">4812
</span><span class="lnt">4813
</span><span class="lnt">4814
</span><span class="lnt">4815
</span><span class="lnt">4816
</span><span class="lnt">4817
</span><span class="lnt">4818
</span><span class="lnt">4819
</span><span class="lnt">4820
</span><span class="lnt">4821
</span><span class="lnt">4822
</span><span class="lnt">4823
</span><span class="lnt">4824
</span><span class="lnt">4825
</span><span class="lnt">4826
</span><span class="lnt">4827
</span><span class="lnt">4828
</span><span class="lnt">4829
</span><span class="lnt">4830
</span><span class="lnt">4831
</span><span class="lnt">4832
</span><span class="lnt">4833
</span><span class="lnt">4834
</span><span class="lnt">4835
</span><span class="lnt">4836
</span><span class="lnt">4837
</span><span class="lnt">4838
</span><span class="lnt">4839
</span><span class="lnt">4840
</span><span class="lnt">4841
</span><span class="lnt">4842
</span><span class="lnt">4843
</span><span class="lnt">4844
</span><span class="lnt">4845
</span><span class="lnt">4846
</span><span class="lnt">4847
</span><span class="lnt">4848
</span><span class="lnt">4849
</span><span class="lnt">4850
</span><span class="lnt">4851
</span><span class="lnt">4852
</span><span class="lnt">4853
</span><span class="lnt">4854
</span><span class="lnt">4855
</span><span class="lnt">4856
</span><span class="lnt">4857
</span><span class="lnt">4858
</span><span class="lnt">4859
</span><span class="lnt">4860
</span><span class="lnt">4861
</span><span class="lnt">4862
</span><span class="lnt">4863
</span><span class="lnt">4864
</span><span class="lnt">4865
</span><span class="lnt">4866
</span><span class="lnt">4867
</span><span class="lnt">4868
</span><span class="lnt">4869
</span><span class="lnt">4870
</span><span class="lnt">4871
</span><span class="lnt">4872
</span><span class="lnt">4873
</span><span class="lnt">4874
</span><span class="lnt">4875
</span><span class="lnt">4876
</span><span class="lnt">4877
</span><span class="lnt">4878
</span><span class="lnt">4879
</span><span class="lnt">4880
</span><span class="lnt">4881
</span><span class="lnt">4882
</span><span class="lnt">4883
</span><span class="lnt">4884
</span><span class="lnt">4885
</span><span class="lnt">4886
</span><span class="lnt">4887
</span><span class="lnt">4888
</span><span class="lnt">4889
</span><span class="lnt">4890
</span><span class="lnt">4891
</span><span class="lnt">4892
</span><span class="lnt">4893
</span><span class="lnt">4894
</span><span class="lnt">4895
</span><span class="lnt">4896
</span><span class="lnt">4897
</span><span class="lnt">4898
</span><span class="lnt">4899
</span><span class="lnt">4900
</span><span class="lnt">4901
</span><span class="lnt">4902
</span><span class="lnt">4903
</span><span class="lnt">4904
</span><span class="lnt">4905
</span><span class="lnt">4906
</span><span class="lnt">4907
</span><span class="lnt">4908
</span><span class="lnt">4909
</span><span class="lnt">4910
</span><span class="lnt">4911
</span><span class="lnt">4912
</span><span class="lnt">4913
</span><span class="lnt">4914
</span><span class="lnt">4915
</span><span class="lnt">4916
</span><span class="lnt">4917
</span><span class="lnt">4918
</span><span class="lnt">4919
</span><span class="lnt">4920
</span><span class="lnt">4921
</span><span class="lnt">4922
</span><span class="lnt">4923
</span><span class="lnt">4924
</span><span class="lnt">4925
</span><span class="lnt">4926
</span><span class="lnt">4927
</span><span class="lnt">4928
</span><span class="lnt">4929
</span><span class="lnt">4930
</span><span class="lnt">4931
</span><span class="lnt">4932
</span><span class="lnt">4933
</span><span class="lnt">4934
</span><span class="lnt">4935
</span><span class="lnt">4936
</span><span class="lnt">4937
</span><span class="lnt">4938
</span><span class="lnt">4939
</span><span class="lnt">4940
</span><span class="lnt">4941
</span><span class="lnt">4942
</span><span class="lnt">4943
</span><span class="lnt">4944
</span><span class="lnt">4945
</span><span class="lnt">4946
</span><span class="lnt">4947
</span><span class="lnt">4948
</span><span class="lnt">4949
</span><span class="lnt">4950
</span><span class="lnt">4951
</span><span class="lnt">4952
</span><span class="lnt">4953
</span><span class="lnt">4954
</span><span class="lnt">4955
</span><span class="lnt">4956
</span><span class="lnt">4957
</span><span class="lnt">4958
</span><span class="lnt">4959
</span><span class="lnt">4960
</span><span class="lnt">4961
</span><span class="lnt">4962
</span><span class="lnt">4963
</span><span class="lnt">4964
</span><span class="lnt">4965
</span><span class="lnt">4966
</span><span class="lnt">4967
</span><span class="lnt">4968
</span><span class="lnt">4969
</span><span class="lnt">4970
</span><span class="lnt">4971
</span><span class="lnt">4972
</span><span class="lnt">4973
</span><span class="lnt">4974
</span><span class="lnt">4975
</span><span class="lnt">4976
</span><span class="lnt">4977
</span><span class="lnt">4978
</span><span class="lnt">4979
</span><span class="lnt">4980
</span><span class="lnt">4981
</span><span class="lnt">4982
</span><span class="lnt">4983
</span><span class="lnt">4984
</span><span class="lnt">4985
</span><span class="lnt">4986
</span><span class="lnt">4987
</span><span class="lnt">4988
</span><span class="lnt">4989
</span><span class="lnt">4990
</span><span class="lnt">4991
</span><span class="lnt">4992
</span><span class="lnt">4993
</span><span class="lnt">4994
</span><span class="lnt">4995
</span><span class="lnt">4996
</span><span class="lnt">4997
</span><span class="lnt">4998
</span><span class="lnt">4999
</span><span class="lnt">5000
</span><span class="lnt">5001
</span><span class="lnt">5002
</span><span class="lnt">5003
</span><span class="lnt">5004
</span><span class="lnt">5005
</span><span class="lnt">5006
</span><span class="lnt">5007
</span><span class="lnt">5008
</span><span class="lnt">5009
</span><span class="lnt">5010
</span><span class="lnt">5011
</span><span class="lnt">5012
</span><span class="lnt">5013
</span><span class="lnt">5014
</span><span class="lnt">5015
</span><span class="lnt">5016
</span><span class="lnt">5017
</span><span class="lnt">5018
</span><span class="lnt">5019
</span><span class="lnt">5020
</span><span class="lnt">5021
</span><span class="lnt">5022
</span><span class="lnt">5023
</span><span class="lnt">5024
</span><span class="lnt">5025
</span><span class="lnt">5026
</span><span class="lnt">5027
</span><span class="lnt">5028
</span><span class="lnt">5029
</span><span class="lnt">5030
</span><span class="lnt">5031
</span><span class="lnt">5032
</span><span class="lnt">5033
</span><span class="lnt">5034
</span><span class="lnt">5035
</span><span class="lnt">5036
</span><span class="lnt">5037
</span><span class="lnt">5038
</span><span class="lnt">5039
</span><span class="lnt">5040
</span><span class="lnt">5041
</span><span class="lnt">5042
</span><span class="lnt">5043
</span><span class="lnt">5044
</span><span class="lnt">5045
</span><span class="lnt">5046
</span><span class="lnt">5047
</span><span class="lnt">5048
</span><span class="lnt">5049
</span><span class="lnt">5050
</span><span class="lnt">5051
</span><span class="lnt">5052
</span><span class="lnt">5053
</span><span class="lnt">5054
</span><span class="lnt">5055
</span><span class="lnt">5056
</span><span class="lnt">5057
</span><span class="lnt">5058
</span><span class="lnt">5059
</span><span class="lnt">5060
</span><span class="lnt">5061
</span><span class="lnt">5062
</span><span class="lnt">5063
</span><span class="lnt">5064
</span><span class="lnt">5065
</span><span class="lnt">5066
</span><span class="lnt">5067
</span><span class="lnt">5068
</span><span class="lnt">5069
</span><span class="lnt">5070
</span><span class="lnt">5071
</span><span class="lnt">5072
</span><span class="lnt">5073
</span><span class="lnt">5074
</span><span class="lnt">5075
</span><span class="lnt">5076
</span><span class="lnt">5077
</span><span class="lnt">5078
</span><span class="lnt">5079
</span><span class="lnt">5080
</span><span class="lnt">5081
</span><span class="lnt">5082
</span><span class="lnt">5083
</span><span class="lnt">5084
</span><span class="lnt">5085
</span><span class="lnt">5086
</span><span class="lnt">5087
</span><span class="lnt">5088
</span><span class="lnt">5089
</span><span class="lnt">5090
</span><span class="lnt">5091
</span><span class="lnt">5092
</span><span class="lnt">5093
</span><span class="lnt">5094
</span><span class="lnt">5095
</span><span class="lnt">5096
</span><span class="lnt">5097
</span><span class="lnt">5098
</span><span class="lnt">5099
</span><span class="lnt">5100
</span><span class="lnt">5101
</span><span class="lnt">5102
</span><span class="lnt">5103
</span><span class="lnt">5104
</span><span class="lnt">5105
</span><span class="lnt">5106
</span><span class="lnt">5107
</span><span class="lnt">5108
</span><span class="lnt">5109
</span><span class="lnt">5110
</span><span class="lnt">5111
</span><span class="lnt">5112
</span><span class="lnt">5113
</span><span class="lnt">5114
</span><span class="lnt">5115
</span><span class="lnt">5116
</span><span class="lnt">5117
</span><span class="lnt">5118
</span><span class="lnt">5119
</span><span class="lnt">5120
</span><span class="lnt">5121
</span><span class="lnt">5122
</span><span class="lnt">5123
</span><span class="lnt">5124
</span><span class="lnt">5125
</span><span class="lnt">5126
</span><span class="lnt">5127
</span><span class="lnt">5128
</span><span class="lnt">5129
</span><span class="lnt">5130
</span><span class="lnt">5131
</span><span class="lnt">5132
</span><span class="lnt">5133
</span><span class="lnt">5134
</span><span class="lnt">5135
</span><span class="lnt">5136
</span><span class="lnt">5137
</span><span class="lnt">5138
</span><span class="lnt">5139
</span><span class="lnt">5140
</span><span class="lnt">5141
</span><span class="lnt">5142
</span><span class="lnt">5143
</span><span class="lnt">5144
</span><span class="lnt">5145
</span><span class="lnt">5146
</span><span class="lnt">5147
</span><span class="lnt">5148
</span><span class="lnt">5149
</span><span class="lnt">5150
</span><span class="lnt">5151
</span><span class="lnt">5152
</span><span class="lnt">5153
</span><span class="lnt">5154
</span><span class="lnt">5155
</span><span class="lnt">5156
</span><span class="lnt">5157
</span><span class="lnt">5158
</span><span class="lnt">5159
</span><span class="lnt">5160
</span><span class="lnt">5161
</span><span class="lnt">5162
</span><span class="lnt">5163
</span><span class="lnt">5164
</span><span class="lnt">5165
</span><span class="lnt">5166
</span><span class="lnt">5167
</span><span class="lnt">5168
</span><span class="lnt">5169
</span><span class="lnt">5170
</span><span class="lnt">5171
</span><span class="lnt">5172
</span><span class="lnt">5173
</span><span class="lnt">5174
</span><span class="lnt">5175
</span><span class="lnt">5176
</span><span class="lnt">5177
</span><span class="lnt">5178
</span><span class="lnt">5179
</span><span class="lnt">5180
</span><span class="lnt">5181
</span><span class="lnt">5182
</span><span class="lnt">5183
</span><span class="lnt">5184
</span><span class="lnt">5185
</span><span class="lnt">5186
</span><span class="lnt">5187
</span><span class="lnt">5188
</span><span class="lnt">5189
</span><span class="lnt">5190
</span><span class="lnt">5191
</span><span class="lnt">5192
</span><span class="lnt">5193
</span><span class="lnt">5194
</span><span class="lnt">5195
</span><span class="lnt">5196
</span><span class="lnt">5197
</span><span class="lnt">5198
</span><span class="lnt">5199
</span><span class="lnt">5200
</span><span class="lnt">5201
</span><span class="lnt">5202
</span><span class="lnt">5203
</span><span class="lnt">5204
</span><span class="lnt">5205
</span><span class="lnt">5206
</span><span class="lnt">5207
</span><span class="lnt">5208
</span><span class="lnt">5209
</span><span class="lnt">5210
</span><span class="lnt">5211
</span><span class="lnt">5212
</span><span class="lnt">5213
</span><span class="lnt">5214
</span><span class="lnt">5215
</span><span class="lnt">5216
</span><span class="lnt">5217
</span><span class="lnt">5218
</span><span class="lnt">5219
</span><span class="lnt">5220
</span><span class="lnt">5221
</span><span class="lnt">5222
</span><span class="lnt">5223
</span><span class="lnt">5224
</span><span class="lnt">5225
</span><span class="lnt">5226
</span><span class="lnt">5227
</span><span class="lnt">5228
</span><span class="lnt">5229
</span><span class="lnt">5230
</span><span class="lnt">5231
</span><span class="lnt">5232
</span><span class="lnt">5233
</span><span class="lnt">5234
</span><span class="lnt">5235
</span><span class="lnt">5236
</span><span class="lnt">5237
</span><span class="lnt">5238
</span><span class="lnt">5239
</span><span class="lnt">5240
</span><span class="lnt">5241
</span><span class="lnt">5242
</span><span class="lnt">5243
</span><span class="lnt">5244
</span><span class="lnt">5245
</span><span class="lnt">5246
</span><span class="lnt">5247
</span><span class="lnt">5248
</span><span class="lnt">5249
</span><span class="lnt">5250
</span><span class="lnt">5251
</span><span class="lnt">5252
</span><span class="lnt">5253
</span><span class="lnt">5254
</span><span class="lnt">5255
</span><span class="lnt">5256
</span><span class="lnt">5257
</span><span class="lnt">5258
</span><span class="lnt">5259
</span><span class="lnt">5260
</span><span class="lnt">5261
</span><span class="lnt">5262
</span><span class="lnt">5263
</span><span class="lnt">5264
</span><span class="lnt">5265
</span><span class="lnt">5266
</span><span class="lnt">5267
</span><span class="lnt">5268
</span><span class="lnt">5269
</span><span class="lnt">5270
</span><span class="lnt">5271
</span><span class="lnt">5272
</span><span class="lnt">5273
</span><span class="lnt">5274
</span><span class="lnt">5275
</span><span class="lnt">5276
</span><span class="lnt">5277
</span><span class="lnt">5278
</span><span class="lnt">5279
</span><span class="lnt">5280
</span><span class="lnt">5281
</span><span class="lnt">5282
</span><span class="lnt">5283
</span><span class="lnt">5284
</span><span class="lnt">5285
</span><span class="lnt">5286
</span><span class="lnt">5287
</span><span class="lnt">5288
</span><span class="lnt">5289
</span><span class="lnt">5290
</span><span class="lnt">5291
</span><span class="lnt">5292
</span><span class="lnt">5293
</span><span class="lnt">5294
</span><span class="lnt">5295
</span><span class="lnt">5296
</span><span class="lnt">5297
</span><span class="lnt">5298
</span><span class="lnt">5299
</span><span class="lnt">5300
</span><span class="lnt">5301
</span><span class="lnt">5302
</span><span class="lnt">5303
</span><span class="lnt">5304
</span><span class="lnt">5305
</span><span class="lnt">5306
</span><span class="lnt">5307
</span><span class="lnt">5308
</span><span class="lnt">5309
</span><span class="lnt">5310
</span><span class="lnt">5311
</span><span class="lnt">5312
</span><span class="lnt">5313
</span><span class="lnt">5314
</span><span class="lnt">5315
</span><span class="lnt">5316
</span><span class="lnt">5317
</span><span class="lnt">5318
</span><span class="lnt">5319
</span><span class="lnt">5320
</span><span class="lnt">5321
</span><span class="lnt">5322
</span><span class="lnt">5323
</span><span class="lnt">5324
</span><span class="lnt">5325
</span><span class="lnt">5326
</span><span class="lnt">5327
</span><span class="lnt">5328
</span><span class="lnt">5329
</span><span class="lnt">5330
</span><span class="lnt">5331
</span><span class="lnt">5332
</span><span class="lnt">5333
</span><span class="lnt">5334
</span><span class="lnt">5335
</span><span class="lnt">5336
</span><span class="lnt">5337
</span><span class="lnt">5338
</span><span class="lnt">5339
</span><span class="lnt">5340
</span><span class="lnt">5341
</span><span class="lnt">5342
</span><span class="lnt">5343
</span><span class="lnt">5344
</span><span class="lnt">5345
</span><span class="lnt">5346
</span><span class="lnt">5347
</span><span class="lnt">5348
</span><span class="lnt">5349
</span><span class="lnt">5350
</span><span class="lnt">5351
</span><span class="lnt">5352
</span><span class="lnt">5353
</span><span class="lnt">5354
</span><span class="lnt">5355
</span><span class="lnt">5356
</span><span class="lnt">5357
</span><span class="lnt">5358
</span><span class="lnt">5359
</span><span class="lnt">5360
</span><span class="lnt">5361
</span><span class="lnt">5362
</span><span class="lnt">5363
</span><span class="lnt">5364
</span><span class="lnt">5365
</span><span class="lnt">5366
</span><span class="lnt">5367
</span><span class="lnt">5368
</span><span class="lnt">5369
</span><span class="lnt">5370
</span><span class="lnt">5371
</span><span class="lnt">5372
</span><span class="lnt">5373
</span><span class="lnt">5374
</span><span class="lnt">5375
</span><span class="lnt">5376
</span><span class="lnt">5377
</span><span class="lnt">5378
</span><span class="lnt">5379
</span><span class="lnt">5380
</span><span class="lnt">5381
</span><span class="lnt">5382
</span><span class="lnt">5383
</span><span class="lnt">5384
</span><span class="lnt">5385
</span><span class="lnt">5386
</span><span class="lnt">5387
</span><span class="lnt">5388
</span><span class="lnt">5389
</span><span class="lnt">5390
</span><span class="lnt">5391
</span><span class="lnt">5392
</span><span class="lnt">5393
</span><span class="lnt">5394
</span><span class="lnt">5395
</span><span class="lnt">5396
</span><span class="lnt">5397
</span><span class="lnt">5398
</span><span class="lnt">5399
</span><span class="lnt">5400
</span><span class="lnt">5401
</span><span class="lnt">5402
</span><span class="lnt">5403
</span><span class="lnt">5404
</span><span class="lnt">5405
</span><span class="lnt">5406
</span><span class="lnt">5407
</span><span class="lnt">5408
</span><span class="lnt">5409
</span><span class="lnt">5410
</span><span class="lnt">5411
</span><span class="lnt">5412
</span><span class="lnt">5413
</span><span class="lnt">5414
</span><span class="lnt">5415
</span><span class="lnt">5416
</span><span class="lnt">5417
</span><span class="lnt">5418
</span><span class="lnt">5419
</span><span class="lnt">5420
</span><span class="lnt">5421
</span><span class="lnt">5422
</span><span class="lnt">5423
</span><span class="lnt">5424
</span><span class="lnt">5425
</span><span class="lnt">5426
</span><span class="lnt">5427
</span><span class="lnt">5428
</span><span class="lnt">5429
</span><span class="lnt">5430
</span><span class="lnt">5431
</span><span class="lnt">5432
</span><span class="lnt">5433
</span><span class="lnt">5434
</span><span class="lnt">5435
</span><span class="lnt">5436
</span><span class="lnt">5437
</span><span class="lnt">5438
</span><span class="lnt">5439
</span><span class="lnt">5440
</span><span class="lnt">5441
</span><span class="lnt">5442
</span><span class="lnt">5443
</span><span class="lnt">5444
</span><span class="lnt">5445
</span><span class="lnt">5446
</span><span class="lnt">5447
</span><span class="lnt">5448
</span><span class="lnt">5449
</span><span class="lnt">5450
</span><span class="lnt">5451
</span><span class="lnt">5452
</span><span class="lnt">5453
</span><span class="lnt">5454
</span><span class="lnt">5455
</span><span class="lnt">5456
</span><span class="lnt">5457
</span><span class="lnt">5458
</span><span class="lnt">5459
</span><span class="lnt">5460
</span><span class="lnt">5461
</span><span class="lnt">5462
</span><span class="lnt">5463
</span><span class="lnt">5464
</span><span class="lnt">5465
</span><span class="lnt">5466
</span><span class="lnt">5467
</span><span class="lnt">5468
</span><span class="lnt">5469
</span><span class="lnt">5470
</span><span class="lnt">5471
</span><span class="lnt">5472
</span><span class="lnt">5473
</span><span class="lnt">5474
</span><span class="lnt">5475
</span><span class="lnt">5476
</span><span class="lnt">5477
</span><span class="lnt">5478
</span><span class="lnt">5479
</span><span class="lnt">5480
</span><span class="lnt">5481
</span><span class="lnt">5482
</span><span class="lnt">5483
</span><span class="lnt">5484
</span><span class="lnt">5485
</span><span class="lnt">5486
</span><span class="lnt">5487
</span><span class="lnt">5488
</span><span class="lnt">5489
</span><span class="lnt">5490
</span><span class="lnt">5491
</span><span class="lnt">5492
</span><span class="lnt">5493
</span><span class="lnt">5494
</span><span class="lnt">5495
</span><span class="lnt">5496
</span><span class="lnt">5497
</span><span class="lnt">5498
</span><span class="lnt">5499
</span><span class="lnt">5500
</span><span class="lnt">5501
</span><span class="lnt">5502
</span><span class="lnt">5503
</span><span class="lnt">5504
</span><span class="lnt">5505
</span><span class="lnt">5506
</span><span class="lnt">5507
</span><span class="lnt">5508
</span><span class="lnt">5509
</span><span class="lnt">5510
</span><span class="lnt">5511
</span><span class="lnt">5512
</span><span class="lnt">5513
</span><span class="lnt">5514
</span><span class="lnt">5515
</span><span class="lnt">5516
</span><span class="lnt">5517
</span><span class="lnt">5518
</span><span class="lnt">5519
</span><span class="lnt">5520
</span><span class="lnt">5521
</span><span class="lnt">5522
</span><span class="lnt">5523
</span><span class="lnt">5524
</span><span class="lnt">5525
</span><span class="lnt">5526
</span><span class="lnt">5527
</span><span class="lnt">5528
</span><span class="lnt">5529
</span><span class="lnt">5530
</span><span class="lnt">5531
</span><span class="lnt">5532
</span><span class="lnt">5533
</span><span class="lnt">5534
</span><span class="lnt">5535
</span><span class="lnt">5536
</span><span class="lnt">5537
</span><span class="lnt">5538
</span><span class="lnt">5539
</span><span class="lnt">5540
</span><span class="lnt">5541
</span><span class="lnt">5542
</span><span class="lnt">5543
</span><span class="lnt">5544
</span><span class="lnt">5545
</span><span class="lnt">5546
</span><span class="lnt">5547
</span><span class="lnt">5548
</span><span class="lnt">5549
</span><span class="lnt">5550
</span><span class="lnt">5551
</span><span class="lnt">5552
</span><span class="lnt">5553
</span><span class="lnt">5554
</span><span class="lnt">5555
</span><span class="lnt">5556
</span><span class="lnt">5557
</span><span class="lnt">5558
</span><span class="lnt">5559
</span><span class="lnt">5560
</span><span class="lnt">5561
</span><span class="lnt">5562
</span><span class="lnt">5563
</span><span class="lnt">5564
</span><span class="lnt">5565
</span><span class="lnt">5566
</span><span class="lnt">5567
</span><span class="lnt">5568
</span><span class="lnt">5569
</span><span class="lnt">5570
</span><span class="lnt">5571
</span><span class="lnt">5572
</span><span class="lnt">5573
</span><span class="lnt">5574
</span><span class="lnt">5575
</span><span class="lnt">5576
</span><span class="lnt">5577
</span><span class="lnt">5578
</span><span class="lnt">5579
</span><span class="lnt">5580
</span><span class="lnt">5581
</span><span class="lnt">5582
</span><span class="lnt">5583
</span><span class="lnt">5584
</span><span class="lnt">5585
</span><span class="lnt">5586
</span><span class="lnt">5587
</span><span class="lnt">5588
</span><span class="lnt">5589
</span><span class="lnt">5590
</span><span class="lnt">5591
</span><span class="lnt">5592
</span><span class="lnt">5593
</span><span class="lnt">5594
</span><span class="lnt">5595
</span><span class="lnt">5596
</span><span class="lnt">5597
</span><span class="lnt">5598
</span><span class="lnt">5599
</span><span class="lnt">5600
</span><span class="lnt">5601
</span><span class="lnt">5602
</span><span class="lnt">5603
</span><span class="lnt">5604
</span><span class="lnt">5605
</span><span class="lnt">5606
</span><span class="lnt">5607
</span><span class="lnt">5608
</span><span class="lnt">5609
</span><span class="lnt">5610
</span><span class="lnt">5611
</span><span class="lnt">5612
</span><span class="lnt">5613
</span><span class="lnt">5614
</span><span class="lnt">5615
</span><span class="lnt">5616
</span><span class="lnt">5617
</span><span class="lnt">5618
</span><span class="lnt">5619
</span><span class="lnt">5620
</span><span class="lnt">5621
</span><span class="lnt">5622
</span><span class="lnt">5623
</span><span class="lnt">5624
</span><span class="lnt">5625
</span><span class="lnt">5626
</span><span class="lnt">5627
</span><span class="lnt">5628
</span><span class="lnt">5629
</span><span class="lnt">5630
</span><span class="lnt">5631
</span><span class="lnt">5632
</span><span class="lnt">5633
</span><span class="lnt">5634
</span><span class="lnt">5635
</span><span class="lnt">5636
</span><span class="lnt">5637
</span><span class="lnt">5638
</span><span class="lnt">5639
</span><span class="lnt">5640
</span><span class="lnt">5641
</span><span class="lnt">5642
</span><span class="lnt">5643
</span><span class="lnt">5644
</span><span class="lnt">5645
</span><span class="lnt">5646
</span><span class="lnt">5647
</span><span class="lnt">5648
</span><span class="lnt">5649
</span><span class="lnt">5650
</span><span class="lnt">5651
</span><span class="lnt">5652
</span><span class="lnt">5653
</span><span class="lnt">5654
</span><span class="lnt">5655
</span><span class="lnt">5656
</span><span class="lnt">5657
</span><span class="lnt">5658
</span><span class="lnt">5659
</span><span class="lnt">5660
</span><span class="lnt">5661
</span><span class="lnt">5662
</span><span class="lnt">5663
</span><span class="lnt">5664
</span><span class="lnt">5665
</span><span class="lnt">5666
</span><span class="lnt">5667
</span><span class="lnt">5668
</span><span class="lnt">5669
</span><span class="lnt">5670
</span><span class="lnt">5671
</span><span class="lnt">5672
</span><span class="lnt">5673
</span><span class="lnt">5674
</span><span class="lnt">5675
</span><span class="lnt">5676
</span><span class="lnt">5677
</span><span class="lnt">5678
</span><span class="lnt">5679
</span><span class="lnt">5680
</span><span class="lnt">5681
</span><span class="lnt">5682
</span><span class="lnt">5683
</span><span class="lnt">5684
</span><span class="lnt">5685
</span><span class="lnt">5686
</span><span class="lnt">5687
</span><span class="lnt">5688
</span><span class="lnt">5689
</span><span class="lnt">5690
</span><span class="lnt">5691
</span><span class="lnt">5692
</span><span class="lnt">5693
</span><span class="lnt">5694
</span><span class="lnt">5695
</span><span class="lnt">5696
</span><span class="lnt">5697
</span><span class="lnt">5698
</span><span class="lnt">5699
</span><span class="lnt">5700
</span><span class="lnt">5701
</span><span class="lnt">5702
</span><span class="lnt">5703
</span><span class="lnt">5704
</span><span class="lnt">5705
</span><span class="lnt">5706
</span><span class="lnt">5707
</span><span class="lnt">5708
</span><span class="lnt">5709
</span><span class="lnt">5710
</span><span class="lnt">5711
</span><span class="lnt">5712
</span><span class="lnt">5713
</span><span class="lnt">5714
</span><span class="lnt">5715
</span><span class="lnt">5716
</span><span class="lnt">5717
</span><span class="lnt">5718
</span><span class="lnt">5719
</span><span class="lnt">5720
</span><span class="lnt">5721
</span><span class="lnt">5722
</span><span class="lnt">5723
</span><span class="lnt">5724
</span><span class="lnt">5725
</span><span class="lnt">5726
</span><span class="lnt">5727
</span><span class="lnt">5728
</span><span class="lnt">5729
</span><span class="lnt">5730
</span><span class="lnt">5731
</span><span class="lnt">5732
</span><span class="lnt">5733
</span><span class="lnt">5734
</span><span class="lnt">5735
</span><span class="lnt">5736
</span><span class="lnt">5737
</span><span class="lnt">5738
</span><span class="lnt">5739
</span><span class="lnt">5740
</span><span class="lnt">5741
</span><span class="lnt">5742
</span><span class="lnt">5743
</span><span class="lnt">5744
</span><span class="lnt">5745
</span><span class="lnt">5746
</span><span class="lnt">5747
</span><span class="lnt">5748
</span><span class="lnt">5749
</span><span class="lnt">5750
</span><span class="lnt">5751
</span><span class="lnt">5752
</span><span class="lnt">5753
</span><span class="lnt">5754
</span><span class="lnt">5755
</span><span class="lnt">5756
</span><span class="lnt">5757
</span><span class="lnt">5758
</span><span class="lnt">5759
</span><span class="lnt">5760
</span><span class="lnt">5761
</span><span class="lnt">5762
</span><span class="lnt">5763
</span><span class="lnt">5764
</span><span class="lnt">5765
</span><span class="lnt">5766
</span><span class="lnt">5767
</span><span class="lnt">5768
</span><span class="lnt">5769
</span><span class="lnt">5770
</span><span class="lnt">5771
</span><span class="lnt">5772
</span><span class="lnt">5773
</span><span class="lnt">5774
</span><span class="lnt">5775
</span><span class="lnt">5776
</span><span class="lnt">5777
</span><span class="lnt">5778
</span><span class="lnt">5779
</span><span class="lnt">5780
</span><span class="lnt">5781
</span><span class="lnt">5782
</span><span class="lnt">5783
</span><span class="lnt">5784
</span><span class="lnt">5785
</span><span class="lnt">5786
</span><span class="lnt">5787
</span><span class="lnt">5788
</span><span class="lnt">5789
</span><span class="lnt">5790
</span><span class="lnt">5791
</span><span class="lnt">5792
</span><span class="lnt">5793
</span><span class="lnt">5794
</span><span class="lnt">5795
</span><span class="lnt">5796
</span><span class="lnt">5797
</span><span class="lnt">5798
</span><span class="lnt">5799
</span><span class="lnt">5800
</span><span class="lnt">5801
</span><span class="lnt">5802
</span><span class="lnt">5803
</span><span class="lnt">5804
</span><span class="lnt">5805
</span><span class="lnt">5806
</span><span class="lnt">5807
</span><span class="lnt">5808
</span><span class="lnt">5809
</span><span class="lnt">5810
</span><span class="lnt">5811
</span><span class="lnt">5812
</span><span class="lnt">5813
</span><span class="lnt">5814
</span><span class="lnt">5815
</span><span class="lnt">5816
</span><span class="lnt">5817
</span><span class="lnt">5818
</span><span class="lnt">5819
</span><span class="lnt">5820
</span><span class="lnt">5821
</span><span class="lnt">5822
</span><span class="lnt">5823
</span><span class="lnt">5824
</span><span class="lnt">5825
</span><span class="lnt">5826
</span><span class="lnt">5827
</span><span class="lnt">5828
</span><span class="lnt">5829
</span><span class="lnt">5830
</span><span class="lnt">5831
</span><span class="lnt">5832
</span><span class="lnt">5833
</span><span class="lnt">5834
</span><span class="lnt">5835
</span><span class="lnt">5836
</span><span class="lnt">5837
</span><span class="lnt">5838
</span><span class="lnt">5839
</span><span class="lnt">5840
</span><span class="lnt">5841
</span><span class="lnt">5842
</span><span class="lnt">5843
</span><span class="lnt">5844
</span><span class="lnt">5845
</span><span class="lnt">5846
</span><span class="lnt">5847
</span><span class="lnt">5848
</span><span class="lnt">5849
</span><span class="lnt">5850
</span><span class="lnt">5851
</span><span class="lnt">5852
</span><span class="lnt">5853
</span><span class="lnt">5854
</span><span class="lnt">5855
</span><span class="lnt">5856
</span><span class="lnt">5857
</span><span class="lnt">5858
</span><span class="lnt">5859
</span><span class="lnt">5860
</span><span class="lnt">5861
</span><span class="lnt">5862
</span><span class="lnt">5863
</span><span class="lnt">5864
</span><span class="lnt">5865
</span><span class="lnt">5866
</span><span class="lnt">5867
</span><span class="lnt">5868
</span><span class="lnt">5869
</span><span class="lnt">5870
</span><span class="lnt">5871
</span><span class="lnt">5872
</span><span class="lnt">5873
</span><span class="lnt">5874
</span><span class="lnt">5875
</span><span class="lnt">5876
</span><span class="lnt">5877
</span><span class="lnt">5878
</span><span class="lnt">5879
</span><span class="lnt">5880
</span><span class="lnt">5881
</span><span class="lnt">5882
</span><span class="lnt">5883
</span><span class="lnt">5884
</span><span class="lnt">5885
</span><span class="lnt">5886
</span><span class="lnt">5887
</span><span class="lnt">5888
</span><span class="lnt">5889
</span><span class="lnt">5890
</span><span class="lnt">5891
</span><span class="lnt">5892
</span><span class="lnt">5893
</span><span class="lnt">5894
</span><span class="lnt">5895
</span><span class="lnt">5896
</span><span class="lnt">5897
</span><span class="lnt">5898
</span><span class="lnt">5899
</span><span class="lnt">5900
</span><span class="lnt">5901
</span><span class="lnt">5902
</span><span class="lnt">5903
</span><span class="lnt">5904
</span><span class="lnt">5905
</span><span class="lnt">5906
</span><span class="lnt">5907
</span><span class="lnt">5908
</span><span class="lnt">5909
</span><span class="lnt">5910
</span><span class="lnt">5911
</span><span class="lnt">5912
</span><span class="lnt">5913
</span><span class="lnt">5914
</span><span class="lnt">5915
</span><span class="lnt">5916
</span><span class="lnt">5917
</span><span class="lnt">5918
</span><span class="lnt">5919
</span><span class="lnt">5920
</span><span class="lnt">5921
</span><span class="lnt">5922
</span><span class="lnt">5923
</span><span class="lnt">5924
</span><span class="lnt">5925
</span><span class="lnt">5926
</span><span class="lnt">5927
</span><span class="lnt">5928
</span><span class="lnt">5929
</span><span class="lnt">5930
</span><span class="lnt">5931
</span><span class="lnt">5932
</span><span class="lnt">5933
</span><span class="lnt">5934
</span><span class="lnt">5935
</span><span class="lnt">5936
</span><span class="lnt">5937
</span><span class="lnt">5938
</span><span class="lnt">5939
</span><span class="lnt">5940
</span><span class="lnt">5941
</span><span class="lnt">5942
</span><span class="lnt">5943
</span><span class="lnt">5944
</span><span class="lnt">5945
</span><span class="lnt">5946
</span><span class="lnt">5947
</span><span class="lnt">5948
</span><span class="lnt">5949
</span><span class="lnt">5950
</span><span class="lnt">5951
</span><span class="lnt">5952
</span><span class="lnt">5953
</span><span class="lnt">5954
</span><span class="lnt">5955
</span><span class="lnt">5956
</span><span class="lnt">5957
</span><span class="lnt">5958
</span><span class="lnt">5959
</span><span class="lnt">5960
</span><span class="lnt">5961
</span><span class="lnt">5962
</span><span class="lnt">5963
</span><span class="lnt">5964
</span><span class="lnt">5965
</span><span class="lnt">5966
</span><span class="lnt">5967
</span><span class="lnt">5968
</span><span class="lnt">5969
</span><span class="lnt">5970
</span><span class="lnt">5971
</span><span class="lnt">5972
</span><span class="lnt">5973
</span><span class="lnt">5974
</span><span class="lnt">5975
</span><span class="lnt">5976
</span><span class="lnt">5977
</span><span class="lnt">5978
</span><span class="lnt">5979
</span><span class="lnt">5980
</span><span class="lnt">5981
</span><span class="lnt">5982
</span><span class="lnt">5983
</span><span class="lnt">5984
</span><span class="lnt">5985
</span><span class="lnt">5986
</span><span class="lnt">5987
</span><span class="lnt">5988
</span><span class="lnt">5989
</span><span class="lnt">5990
</span><span class="lnt">5991
</span><span class="lnt">5992
</span><span class="lnt">5993
</span><span class="lnt">5994
</span><span class="lnt">5995
</span><span class="lnt">5996
</span><span class="lnt">5997
</span><span class="lnt">5998
</span><span class="lnt">5999
</span><span class="lnt">6000
</span><span class="lnt">6001
</span><span class="lnt">6002
</span><span class="lnt">6003
</span><span class="lnt">6004
</span><span class="lnt">6005
</span><span class="lnt">6006
</span><span class="lnt">6007
</span><span class="lnt">6008
</span><span class="lnt">6009
</span><span class="lnt">6010
</span><span class="lnt">6011
</span><span class="lnt">6012
</span><span class="lnt">6013
</span><span class="lnt">6014
</span><span class="lnt">6015
</span><span class="lnt">6016
</span><span class="lnt">6017
</span><span class="lnt">6018
</span><span class="lnt">6019
</span><span class="lnt">6020
</span><span class="lnt">6021
</span><span class="lnt">6022
</span><span class="lnt">6023
</span><span class="lnt">6024
</span><span class="lnt">6025
</span><span class="lnt">6026
</span><span class="lnt">6027
</span><span class="lnt">6028
</span><span class="lnt">6029
</span><span class="lnt">6030
</span><span class="lnt">6031
</span><span class="lnt">6032
</span><span class="lnt">6033
</span><span class="lnt">6034
</span><span class="lnt">6035
</span><span class="lnt">6036
</span><span class="lnt">6037
</span><span class="lnt">6038
</span><span class="lnt">6039
</span><span class="lnt">6040
</span><span class="lnt">6041
</span><span class="lnt">6042
</span><span class="lnt">6043
</span><span class="lnt">6044
</span><span class="lnt">6045
</span><span class="lnt">6046
</span><span class="lnt">6047
</span><span class="lnt">6048
</span><span class="lnt">6049
</span><span class="lnt">6050
</span><span class="lnt">6051
</span><span class="lnt">6052
</span><span class="lnt">6053
</span><span class="lnt">6054
</span><span class="lnt">6055
</span><span class="lnt">6056
</span><span class="lnt">6057
</span><span class="lnt">6058
</span><span class="lnt">6059
</span><span class="lnt">6060
</span><span class="lnt">6061
</span><span class="lnt">6062
</span><span class="lnt">6063
</span><span class="lnt">6064
</span><span class="lnt">6065
</span><span class="lnt">6066
</span><span class="lnt">6067
</span><span class="lnt">6068
</span><span class="lnt">6069
</span><span class="lnt">6070
</span><span class="lnt">6071
</span><span class="lnt">6072
</span><span class="lnt">6073
</span><span class="lnt">6074
</span><span class="lnt">6075
</span><span class="lnt">6076
</span><span class="lnt">6077
</span><span class="lnt">6078
</span><span class="lnt">6079
</span><span class="lnt">6080
</span><span class="lnt">6081
</span><span class="lnt">6082
</span><span class="lnt">6083
</span><span class="lnt">6084
</span><span class="lnt">6085
</span><span class="lnt">6086
</span><span class="lnt">6087
</span><span class="lnt">6088
</span><span class="lnt">6089
</span><span class="lnt">6090
</span><span class="lnt">6091
</span><span class="lnt">6092
</span><span class="lnt">6093
</span><span class="lnt">6094
</span><span class="lnt">6095
</span><span class="lnt">6096
</span><span class="lnt">6097
</span><span class="lnt">6098
</span><span class="lnt">6099
</span><span class="lnt">6100
</span><span class="lnt">6101
</span><span class="lnt">6102
</span><span class="lnt">6103
</span><span class="lnt">6104
</span><span class="lnt">6105
</span><span class="lnt">6106
</span><span class="lnt">6107
</span><span class="lnt">6108
</span><span class="lnt">6109
</span><span class="lnt">6110
</span><span class="lnt">6111
</span><span class="lnt">6112
</span><span class="lnt">6113
</span><span class="lnt">6114
</span><span class="lnt">6115
</span><span class="lnt">6116
</span><span class="lnt">6117
</span><span class="lnt">6118
</span><span class="lnt">6119
</span><span class="lnt">6120
</span><span class="lnt">6121
</span><span class="lnt">6122
</span><span class="lnt">6123
</span><span class="lnt">6124
</span><span class="lnt">6125
</span><span class="lnt">6126
</span><span class="lnt">6127
</span><span class="lnt">6128
</span><span class="lnt">6129
</span><span class="lnt">6130
</span><span class="lnt">6131
</span><span class="lnt">6132
</span><span class="lnt">6133
</span><span class="lnt">6134
</span><span class="lnt">6135
</span><span class="lnt">6136
</span><span class="lnt">6137
</span><span class="lnt">6138
</span><span class="lnt">6139
</span><span class="lnt">6140
</span><span class="lnt">6141
</span><span class="lnt">6142
</span><span class="lnt">6143
</span><span class="lnt">6144
</span><span class="lnt">6145
</span><span class="lnt">6146
</span><span class="lnt">6147
</span><span class="lnt">6148
</span><span class="lnt">6149
</span><span class="lnt">6150
</span><span class="lnt">6151
</span><span class="lnt">6152
</span><span class="lnt">6153
</span><span class="lnt">6154
</span><span class="lnt">6155
</span><span class="lnt">6156
</span><span class="lnt">6157
</span><span class="lnt">6158
</span><span class="lnt">6159
</span><span class="lnt">6160
</span><span class="lnt">6161
</span><span class="lnt">6162
</span><span class="lnt">6163
</span><span class="lnt">6164
</span><span class="lnt">6165
</span><span class="lnt">6166
</span><span class="lnt">6167
</span><span class="lnt">6168
</span><span class="lnt">6169
</span><span class="lnt">6170
</span><span class="lnt">6171
</span><span class="lnt">6172
</span><span class="lnt">6173
</span><span class="lnt">6174
</span><span class="lnt">6175
</span><span class="lnt">6176
</span><span class="lnt">6177
</span><span class="lnt">6178
</span><span class="lnt">6179
</span><span class="lnt">6180
</span><span class="lnt">6181
</span><span class="lnt">6182
</span><span class="lnt">6183
</span><span class="lnt">6184
</span><span class="lnt">6185
</span><span class="lnt">6186
</span><span class="lnt">6187
</span><span class="lnt">6188
</span><span class="lnt">6189
</span><span class="lnt">6190
</span><span class="lnt">6191
</span><span class="lnt">6192
</span><span class="lnt">6193
</span><span class="lnt">6194
</span><span class="lnt">6195
</span><span class="lnt">6196
</span><span class="lnt">6197
</span><span class="lnt">6198
</span><span class="lnt">6199
</span><span class="lnt">6200
</span><span class="lnt">6201
</span><span class="lnt">6202
</span><span class="lnt">6203
</span><span class="lnt">6204
</span><span class="lnt">6205
</span><span class="lnt">6206
</span><span class="lnt">6207
</span><span class="lnt">6208
</span><span class="lnt">6209
</span><span class="lnt">6210
</span><span class="lnt">6211
</span><span class="lnt">6212
</span><span class="lnt">6213
</span><span class="lnt">6214
</span><span class="lnt">6215
</span><span class="lnt">6216
</span><span class="lnt">6217
</span><span class="lnt">6218
</span><span class="lnt">6219
</span><span class="lnt">6220
</span><span class="lnt">6221
</span><span class="lnt">6222
</span><span class="lnt">6223
</span><span class="lnt">6224
</span><span class="lnt">6225
</span><span class="lnt">6226
</span><span class="lnt">6227
</span><span class="lnt">6228
</span><span class="lnt">6229
</span><span class="lnt">6230
</span><span class="lnt">6231
</span><span class="lnt">6232
</span><span class="lnt">6233
</span><span class="lnt">6234
</span><span class="lnt">6235
</span><span class="lnt">6236
</span><span class="lnt">6237
</span><span class="lnt">6238
</span><span class="lnt">6239
</span><span class="lnt">6240
</span><span class="lnt">6241
</span><span class="lnt">6242
</span><span class="lnt">6243
</span><span class="lnt">6244
</span><span class="lnt">6245
</span><span class="lnt">6246
</span><span class="lnt">6247
</span><span class="lnt">6248
</span><span class="lnt">6249
</span><span class="lnt">6250
</span><span class="lnt">6251
</span><span class="lnt">6252
</span><span class="lnt">6253
</span><span class="lnt">6254
</span><span class="lnt">6255
</span><span class="lnt">6256
</span><span class="lnt">6257
</span><span class="lnt">6258
</span><span class="lnt">6259
</span><span class="lnt">6260
</span><span class="lnt">6261
</span><span class="lnt">6262
</span><span class="lnt">6263
</span><span class="lnt">6264
</span><span class="lnt">6265
</span><span class="lnt">6266
</span><span class="lnt">6267
</span><span class="lnt">6268
</span><span class="lnt">6269
</span><span class="lnt">6270
</span><span class="lnt">6271
</span><span class="lnt">6272
</span><span class="lnt">6273
</span><span class="lnt">6274
</span><span class="lnt">6275
</span><span class="lnt">6276
</span><span class="lnt">6277
</span><span class="lnt">6278
</span><span class="lnt">6279
</span><span class="lnt">6280
</span><span class="lnt">6281
</span><span class="lnt">6282
</span><span class="lnt">6283
</span><span class="lnt">6284
</span><span class="lnt">6285
</span><span class="lnt">6286
</span><span class="lnt">6287
</span><span class="lnt">6288
</span><span class="lnt">6289
</span><span class="lnt">6290
</span><span class="lnt">6291
</span><span class="lnt">6292
</span><span class="lnt">6293
</span><span class="lnt">6294
</span><span class="lnt">6295
</span><span class="lnt">6296
</span><span class="lnt">6297
</span><span class="lnt">6298
</span><span class="lnt">6299
</span><span class="lnt">6300
</span><span class="lnt">6301
</span><span class="lnt">6302
</span><span class="lnt">6303
</span><span class="lnt">6304
</span><span class="lnt">6305
</span><span class="lnt">6306
</span><span class="lnt">6307
</span><span class="lnt">6308
</span><span class="lnt">6309
</span><span class="lnt">6310
</span><span class="lnt">6311
</span><span class="lnt">6312
</span><span class="lnt">6313
</span><span class="lnt">6314
</span><span class="lnt">6315
</span><span class="lnt">6316
</span><span class="lnt">6317
</span><span class="lnt">6318
</span><span class="lnt">6319
</span><span class="lnt">6320
</span><span class="lnt">6321
</span><span class="lnt">6322
</span><span class="lnt">6323
</span><span class="lnt">6324
</span><span class="lnt">6325
</span><span class="lnt">6326
</span><span class="lnt">6327
</span><span class="lnt">6328
</span><span class="lnt">6329
</span><span class="lnt">6330
</span><span class="lnt">6331
</span><span class="lnt">6332
</span><span class="lnt">6333
</span><span class="lnt">6334
</span><span class="lnt">6335
</span><span class="lnt">6336
</span><span class="lnt">6337
</span><span class="lnt">6338
</span><span class="lnt">6339
</span><span class="lnt">6340
</span><span class="lnt">6341
</span><span class="lnt">6342
</span><span class="lnt">6343
</span><span class="lnt">6344
</span><span class="lnt">6345
</span><span class="lnt">6346
</span><span class="lnt">6347
</span><span class="lnt">6348
</span><span class="lnt">6349
</span><span class="lnt">6350
</span><span class="lnt">6351
</span><span class="lnt">6352
</span><span class="lnt">6353
</span><span class="lnt">6354
</span><span class="lnt">6355
</span><span class="lnt">6356
</span><span class="lnt">6357
</span><span class="lnt">6358
</span><span class="lnt">6359
</span><span class="lnt">6360
</span><span class="lnt">6361
</span><span class="lnt">6362
</span><span class="lnt">6363
</span><span class="lnt">6364
</span><span class="lnt">6365
</span><span class="lnt">6366
</span><span class="lnt">6367
</span><span class="lnt">6368
</span><span class="lnt">6369
</span><span class="lnt">6370
</span><span class="lnt">6371
</span><span class="lnt">6372
</span><span class="lnt">6373
</span><span class="lnt">6374
</span><span class="lnt">6375
</span><span class="lnt">6376
</span><span class="lnt">6377
</span><span class="lnt">6378
</span><span class="lnt">6379
</span><span class="lnt">6380
</span><span class="lnt">6381
</span><span class="lnt">6382
</span><span class="lnt">6383
</span><span class="lnt">6384
</span><span class="lnt">6385
</span><span class="lnt">6386
</span><span class="lnt">6387
</span><span class="lnt">6388
</span><span class="lnt">6389
</span><span class="lnt">6390
</span><span class="lnt">6391
</span><span class="lnt">6392
</span><span class="lnt">6393
</span><span class="lnt">6394
</span><span class="lnt">6395
</span><span class="lnt">6396
</span><span class="lnt">6397
</span><span class="lnt">6398
</span><span class="lnt">6399
</span><span class="lnt">6400
</span><span class="lnt">6401
</span><span class="lnt">6402
</span><span class="lnt">6403
</span><span class="lnt">6404
</span><span class="lnt">6405
</span><span class="lnt">6406
</span><span class="lnt">6407
</span><span class="lnt">6408
</span><span class="lnt">6409
</span><span class="lnt">6410
</span><span class="lnt">6411
</span><span class="lnt">6412
</span><span class="lnt">6413
</span><span class="lnt">6414
</span><span class="lnt">6415
</span><span class="lnt">6416
</span><span class="lnt">6417
</span><span class="lnt">6418
</span><span class="lnt">6419
</span><span class="lnt">6420
</span><span class="lnt">6421
</span><span class="lnt">6422
</span><span class="lnt">6423
</span><span class="lnt">6424
</span><span class="lnt">6425
</span><span class="lnt">6426
</span><span class="lnt">6427
</span><span class="lnt">6428
</span><span class="lnt">6429
</span><span class="lnt">6430
</span><span class="lnt">6431
</span><span class="lnt">6432
</span><span class="lnt">6433
</span><span class="lnt">6434
</span><span class="lnt">6435
</span><span class="lnt">6436
</span><span class="lnt">6437
</span><span class="lnt">6438
</span><span class="lnt">6439
</span><span class="lnt">6440
</span><span class="lnt">6441
</span><span class="lnt">6442
</span><span class="lnt">6443
</span><span class="lnt">6444
</span><span class="lnt">6445
</span><span class="lnt">6446
</span><span class="lnt">6447
</span><span class="lnt">6448
</span><span class="lnt">6449
</span><span class="lnt">6450
</span><span class="lnt">6451
</span><span class="lnt">6452
</span><span class="lnt">6453
</span><span class="lnt">6454
</span><span class="lnt">6455
</span><span class="lnt">6456
</span><span class="lnt">6457
</span><span class="lnt">6458
</span><span class="lnt">6459
</span><span class="lnt">6460
</span><span class="lnt">6461
</span><span class="lnt">6462
</span><span class="lnt">6463
</span><span class="lnt">6464
</span><span class="lnt">6465
</span><span class="lnt">6466
</span><span class="lnt">6467
</span><span class="lnt">6468
</span><span class="lnt">6469
</span><span class="lnt">6470
</span><span class="lnt">6471
</span><span class="lnt">6472
</span><span class="lnt">6473
</span><span class="lnt">6474
</span><span class="lnt">6475
</span><span class="lnt">6476
</span><span class="lnt">6477
</span><span class="lnt">6478
</span><span class="lnt">6479
</span><span class="lnt">6480
</span><span class="lnt">6481
</span><span class="lnt">6482
</span><span class="lnt">6483
</span><span class="lnt">6484
</span><span class="lnt">6485
</span><span class="lnt">6486
</span><span class="lnt">6487
</span><span class="lnt">6488
</span><span class="lnt">6489
</span><span class="lnt">6490
</span><span class="lnt">6491
</span><span class="lnt">6492
</span><span class="lnt">6493
</span><span class="lnt">6494
</span><span class="lnt">6495
</span><span class="lnt">6496
</span><span class="lnt">6497
</span><span class="lnt">6498
</span><span class="lnt">6499
</span><span class="lnt">6500
</span><span class="lnt">6501
</span><span class="lnt">6502
</span><span class="lnt">6503
</span><span class="lnt">6504
</span><span class="lnt">6505
</span><span class="lnt">6506
</span><span class="lnt">6507
</span><span class="lnt">6508
</span><span class="lnt">6509
</span><span class="lnt">6510
</span><span class="lnt">6511
</span><span class="lnt">6512
</span><span class="lnt">6513
</span><span class="lnt">6514
</span><span class="lnt">6515
</span><span class="lnt">6516
</span><span class="lnt">6517
</span><span class="lnt">6518
</span><span class="lnt">6519
</span><span class="lnt">6520
</span><span class="lnt">6521
</span><span class="lnt">6522
</span><span class="lnt">6523
</span><span class="lnt">6524
</span><span class="lnt">6525
</span><span class="lnt">6526
</span><span class="lnt">6527
</span><span class="lnt">6528
</span><span class="lnt">6529
</span><span class="lnt">6530
</span><span class="lnt">6531
</span><span class="lnt">6532
</span><span class="lnt">6533
</span><span class="lnt">6534
</span><span class="lnt">6535
</span><span class="lnt">6536
</span><span class="lnt">6537
</span><span class="lnt">6538
</span><span class="lnt">6539
</span><span class="lnt">6540
</span><span class="lnt">6541
</span><span class="lnt">6542
</span><span class="lnt">6543
</span><span class="lnt">6544
</span><span class="lnt">6545
</span><span class="lnt">6546
</span><span class="lnt">6547
</span><span class="lnt">6548
</span><span class="lnt">6549
</span><span class="lnt">6550
</span><span class="lnt">6551
</span><span class="lnt">6552
</span><span class="lnt">6553
</span><span class="lnt">6554
</span><span class="lnt">6555
</span><span class="lnt">6556
</span><span class="lnt">6557
</span><span class="lnt">6558
</span><span class="lnt">6559
</span><span class="lnt">6560
</span><span class="lnt">6561
</span><span class="lnt">6562
</span><span class="lnt">6563
</span><span class="lnt">6564
</span><span class="lnt">6565
</span><span class="lnt">6566
</span><span class="lnt">6567
</span><span class="lnt">6568
</span><span class="lnt">6569
</span><span class="lnt">6570
</span><span class="lnt">6571
</span><span class="lnt">6572
</span><span class="lnt">6573
</span><span class="lnt">6574
</span><span class="lnt">6575
</span><span class="lnt">6576
</span><span class="lnt">6577
</span><span class="lnt">6578
</span><span class="lnt">6579
</span><span class="lnt">6580
</span><span class="lnt">6581
</span><span class="lnt">6582
</span><span class="lnt">6583
</span><span class="lnt">6584
</span><span class="lnt">6585
</span><span class="lnt">6586
</span><span class="lnt">6587
</span><span class="lnt">6588
</span><span class="lnt">6589
</span><span class="lnt">6590
</span><span class="lnt">6591
</span><span class="lnt">6592
</span><span class="lnt">6593
</span><span class="lnt">6594
</span><span class="lnt">6595
</span><span class="lnt">6596
</span><span class="lnt">6597
</span><span class="lnt">6598
</span><span class="lnt">6599
</span><span class="lnt">6600
</span><span class="lnt">6601
</span><span class="lnt">6602
</span><span class="lnt">6603
</span><span class="lnt">6604
</span><span class="lnt">6605
</span><span class="lnt">6606
</span><span class="lnt">6607
</span><span class="lnt">6608
</span><span class="lnt">6609
</span><span class="lnt">6610
</span><span class="lnt">6611
</span><span class="lnt">6612
</span><span class="lnt">6613
</span><span class="lnt">6614
</span><span class="lnt">6615
</span><span class="lnt">6616
</span><span class="lnt">6617
</span><span class="lnt">6618
</span><span class="lnt">6619
</span><span class="lnt">6620
</span><span class="lnt">6621
</span><span class="lnt">6622
</span><span class="lnt">6623
</span><span class="lnt">6624
</span><span class="lnt">6625
</span><span class="lnt">6626
</span><span class="lnt">6627
</span><span class="lnt">6628
</span><span class="lnt">6629
</span><span class="lnt">6630
</span><span class="lnt">6631
</span><span class="lnt">6632
</span><span class="lnt">6633
</span><span class="lnt">6634
</span><span class="lnt">6635
</span><span class="lnt">6636
</span><span class="lnt">6637
</span><span class="lnt">6638
</span><span class="lnt">6639
</span><span class="lnt">6640
</span><span class="lnt">6641
</span><span class="lnt">6642
</span><span class="lnt">6643
</span><span class="lnt">6644
</span><span class="lnt">6645
</span><span class="lnt">6646
</span><span class="lnt">6647
</span><span class="lnt">6648
</span><span class="lnt">6649
</span><span class="lnt">6650
</span><span class="lnt">6651
</span><span class="lnt">6652
</span><span class="lnt">6653
</span><span class="lnt">6654
</span><span class="lnt">6655
</span><span class="lnt">6656
</span><span class="lnt">6657
</span><span class="lnt">6658
</span><span class="lnt">6659
</span><span class="lnt">6660
</span><span class="lnt">6661
</span><span class="lnt">6662
</span><span class="lnt">6663
</span><span class="lnt">6664
</span><span class="lnt">6665
</span><span class="lnt">6666
</span><span class="lnt">6667
</span><span class="lnt">6668
</span><span class="lnt">6669
</span><span class="lnt">6670
</span><span class="lnt">6671
</span><span class="lnt">6672
</span><span class="lnt">6673
</span><span class="lnt">6674
</span><span class="lnt">6675
</span><span class="lnt">6676
</span><span class="lnt">6677
</span><span class="lnt">6678
</span><span class="lnt">6679
</span><span class="lnt">6680
</span><span class="lnt">6681
</span><span class="lnt">6682
</span><span class="lnt">6683
</span><span class="lnt">6684
</span><span class="lnt">6685
</span><span class="lnt">6686
</span><span class="lnt">6687
</span><span class="lnt">6688
</span><span class="lnt">6689
</span><span class="lnt">6690
</span><span class="lnt">6691
</span><span class="lnt">6692
</span><span class="lnt">6693
</span><span class="lnt">6694
</span><span class="lnt">6695
</span><span class="lnt">6696
</span><span class="lnt">6697
</span><span class="lnt">6698
</span><span class="lnt">6699
</span><span class="lnt">6700
</span><span class="lnt">6701
</span><span class="lnt">6702
</span><span class="lnt">6703
</span><span class="lnt">6704
</span><span class="lnt">6705
</span><span class="lnt">6706
</span><span class="lnt">6707
</span><span class="lnt">6708
</span><span class="lnt">6709
</span><span class="lnt">6710
</span><span class="lnt">6711
</span><span class="lnt">6712
</span><span class="lnt">6713
</span><span class="lnt">6714
</span><span class="lnt">6715
</span><span class="lnt">6716
</span><span class="lnt">6717
</span><span class="lnt">6718
</span><span class="lnt">6719
</span><span class="lnt">6720
</span><span class="lnt">6721
</span><span class="lnt">6722
</span><span class="lnt">6723
</span><span class="lnt">6724
</span><span class="lnt">6725
</span><span class="lnt">6726
</span><span class="lnt">6727
</span><span class="lnt">6728
</span><span class="lnt">6729
</span><span class="lnt">6730
</span><span class="lnt">6731
</span><span class="lnt">6732
</span><span class="lnt">6733
</span><span class="lnt">6734
</span><span class="lnt">6735
</span><span class="lnt">6736
</span><span class="lnt">6737
</span><span class="lnt">6738
</span><span class="lnt">6739
</span><span class="lnt">6740
</span><span class="lnt">6741
</span><span class="lnt">6742
</span><span class="lnt">6743
</span><span class="lnt">6744
</span><span class="lnt">6745
</span><span class="lnt">6746
</span><span class="lnt">6747
</span><span class="lnt">6748
</span><span class="lnt">6749
</span><span class="lnt">6750
</span><span class="lnt">6751
</span><span class="lnt">6752
</span><span class="lnt">6753
</span><span class="lnt">6754
</span><span class="lnt">6755
</span><span class="lnt">6756
</span><span class="lnt">6757
</span><span class="lnt">6758
</span><span class="lnt">6759
</span><span class="lnt">6760
</span><span class="lnt">6761
</span><span class="lnt">6762
</span><span class="lnt">6763
</span><span class="lnt">6764
</span><span class="lnt">6765
</span><span class="lnt">6766
</span><span class="lnt">6767
</span><span class="lnt">6768
</span><span class="lnt">6769
</span><span class="lnt">6770
</span><span class="lnt">6771
</span><span class="lnt">6772
</span><span class="lnt">6773
</span><span class="lnt">6774
</span><span class="lnt">6775
</span><span class="lnt">6776
</span><span class="lnt">6777
</span><span class="lnt">6778
</span><span class="lnt">6779
</span><span class="lnt">6780
</span><span class="lnt">6781
</span><span class="lnt">6782
</span><span class="lnt">6783
</span><span class="lnt">6784
</span><span class="lnt">6785
</span><span class="lnt">6786
</span><span class="lnt">6787
</span><span class="lnt">6788
</span><span class="lnt">6789
</span><span class="lnt">6790
</span><span class="lnt">6791
</span><span class="lnt">6792
</span><span class="lnt">6793
</span><span class="lnt">6794
</span><span class="lnt">6795
</span><span class="lnt">6796
</span><span class="lnt">6797
</span><span class="lnt">6798
</span><span class="lnt">6799
</span><span class="lnt">6800
</span><span class="lnt">6801
</span><span class="lnt">6802
</span><span class="lnt">6803
</span><span class="lnt">6804
</span><span class="lnt">6805
</span><span class="lnt">6806
</span><span class="lnt">6807
</span><span class="lnt">6808
</span><span class="lnt">6809
</span><span class="lnt">6810
</span><span class="lnt">6811
</span><span class="lnt">6812
</span><span class="lnt">6813
</span><span class="lnt">6814
</span><span class="lnt">6815
</span><span class="lnt">6816
</span><span class="lnt">6817
</span><span class="lnt">6818
</span><span class="lnt">6819
</span><span class="lnt">6820
</span><span class="lnt">6821
</span><span class="lnt">6822
</span><span class="lnt">6823
</span><span class="lnt">6824
</span><span class="lnt">6825
</span><span class="lnt">6826
</span><span class="lnt">6827
</span><span class="lnt">6828
</span><span class="lnt">6829
</span><span class="lnt">6830
</span><span class="lnt">6831
</span><span class="lnt">6832
</span><span class="lnt">6833
</span><span class="lnt">6834
</span><span class="lnt">6835
</span><span class="lnt">6836
</span><span class="lnt">6837
</span><span class="lnt">6838
</span><span class="lnt">6839
</span><span class="lnt">6840
</span><span class="lnt">6841
</span><span class="lnt">6842
</span><span class="lnt">6843
</span><span class="lnt">6844
</span><span class="lnt">6845
</span><span class="lnt">6846
</span><span class="lnt">6847
</span><span class="lnt">6848
</span><span class="lnt">6849
</span><span class="lnt">6850
</span><span class="lnt">6851
</span><span class="lnt">6852
</span><span class="lnt">6853
</span><span class="lnt">6854
</span><span class="lnt">6855
</span><span class="lnt">6856
</span><span class="lnt">6857
</span><span class="lnt">6858
</span><span class="lnt">6859
</span><span class="lnt">6860
</span><span class="lnt">6861
</span><span class="lnt">6862
</span><span class="lnt">6863
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="ch">#! /usr/bin/python2</span>
</span></span><span class="line"><span class="cl"><span class="c1"># generated from systemctl3.py - do not change</span>
</span></span><span class="line"><span class="cl"><span class="kn">from</span> <span class="nn">__future__</span> <span class="kn">import</span> <span class="n">print_function</span>
</span></span><span class="line"><span class="cl"><span class="kn">import</span> <span class="nn">threading</span>
</span></span><span class="line"><span class="cl"><span class="kn">import</span> <span class="nn">grp</span>
</span></span><span class="line"><span class="cl"><span class="kn">import</span> <span class="nn">pwd</span>
</span></span><span class="line"><span class="cl"><span class="kn">import</span> <span class="nn">hashlib</span>
</span></span><span class="line"><span class="cl"><span class="kn">import</span> <span class="nn">select</span>
</span></span><span class="line"><span class="cl"><span class="kn">import</span> <span class="nn">fcntl</span>
</span></span><span class="line"><span class="cl"><span class="kn">import</span> <span class="nn">string</span>
</span></span><span class="line"><span class="cl"><span class="kn">import</span> <span class="nn">datetime</span>
</span></span><span class="line"><span class="cl"><span class="kn">import</span> <span class="nn">socket</span>
</span></span><span class="line"><span class="cl"><span class="kn">import</span> <span class="nn">time</span>
</span></span><span class="line"><span class="cl"><span class="kn">import</span> <span class="nn">signal</span>
</span></span><span class="line"><span class="cl"><span class="kn">import</span> <span class="nn">sys</span>
</span></span><span class="line"><span class="cl"><span class="kn">import</span> <span class="nn">os</span>
</span></span><span class="line"><span class="cl"><span class="kn">import</span> <span class="nn">errno</span>
</span></span><span class="line"><span class="cl"><span class="kn">import</span> <span class="nn">collections</span>
</span></span><span class="line"><span class="cl"><span class="kn">import</span> <span class="nn">shlex</span>
</span></span><span class="line"><span class="cl"><span class="kn">import</span> <span class="nn">fnmatch</span>
</span></span><span class="line"><span class="cl"><span class="kn">import</span> <span class="nn">re</span>
</span></span><span class="line"><span class="cl"><span class="kn">from</span> <span class="nn">types</span> <span class="kn">import</span> <span class="n">GeneratorType</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">__copyright__</span> <span class="o">=</span> <span class="s2">&#34;(C) 2016-2025 Guido U. Draheim, licensed under the EUPL&#34;</span>
</span></span><span class="line"><span class="cl"><span class="n">__version__</span> <span class="o">=</span> <span class="s2">&#34;1.5.9063&#34;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># |</span>
</span></span><span class="line"><span class="cl"><span class="c1"># |</span>
</span></span><span class="line"><span class="cl"><span class="c1"># |</span>
</span></span><span class="line"><span class="cl"><span class="c1"># |</span>
</span></span><span class="line"><span class="cl"><span class="c1"># |</span>
</span></span><span class="line"><span class="cl"><span class="c1"># |</span>
</span></span><span class="line"><span class="cl"><span class="c1"># |</span>
</span></span><span class="line"><span class="cl"><span class="c1"># |</span>
</span></span><span class="line"><span class="cl"><span class="c1"># |</span>
</span></span><span class="line"><span class="cl"><span class="c1"># |</span>
</span></span><span class="line"><span class="cl"><span class="c1"># |</span>
</span></span><span class="line"><span class="cl"><span class="c1"># |</span>
</span></span><span class="line"><span class="cl"><span class="c1"># |</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kn">import</span> <span class="nn">logging</span>
</span></span><span class="line"><span class="cl"><span class="n">logg</span> <span class="o">=</span> <span class="n">logging</span><span class="o">.</span><span class="n">getLogger</span><span class="p">(</span><span class="s2">&#34;systemctl&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">if</span> <span class="n">sys</span><span class="o">.</span><span class="n">version</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;3&#39;</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">    <span class="n">basestring</span> <span class="o">=</span> <span class="nb">str</span>
</span></span><span class="line"><span class="cl">    <span class="n">xrange</span> <span class="o">=</span> <span class="nb">range</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">DEBUG_AFTER</span> <span class="o">=</span> <span class="kc">False</span>
</span></span><span class="line"><span class="cl"><span class="n">DEBUG_STATUS</span> <span class="o">=</span> <span class="kc">False</span>
</span></span><span class="line"><span class="cl"><span class="n">DEBUG_BOOTTIME</span> <span class="o">=</span> <span class="kc">False</span>
</span></span><span class="line"><span class="cl"><span class="n">DEBUG_INITLOOP</span> <span class="o">=</span> <span class="kc">False</span>
</span></span><span class="line"><span class="cl"><span class="n">DEBUG_KILLALL</span> <span class="o">=</span> <span class="kc">False</span>
</span></span><span class="line"><span class="cl"><span class="n">DEBUG_FLOCK</span> <span class="o">=</span> <span class="kc">False</span>
</span></span><span class="line"><span class="cl"><span class="n">DebugPrintResult</span> <span class="o">=</span> <span class="kc">False</span>
</span></span><span class="line"><span class="cl"><span class="n">TestListen</span> <span class="o">=</span> <span class="kc">False</span>
</span></span><span class="line"><span class="cl"><span class="n">TestAccept</span> <span class="o">=</span> <span class="kc">False</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">HINT</span> <span class="o">=</span> <span class="p">(</span><span class="n">logging</span><span class="o">.</span><span class="n">DEBUG</span> <span class="o">+</span> <span class="n">logging</span><span class="o">.</span><span class="n">INFO</span><span class="p">)</span> <span class="o">//</span> <span class="mi">2</span>
</span></span><span class="line"><span class="cl"><span class="n">NOTE</span> <span class="o">=</span> <span class="p">(</span><span class="n">logging</span><span class="o">.</span><span class="n">WARNING</span> <span class="o">+</span> <span class="n">logging</span><span class="o">.</span><span class="n">INFO</span><span class="p">)</span> <span class="o">//</span> <span class="mi">2</span>
</span></span><span class="line"><span class="cl"><span class="n">DONE</span> <span class="o">=</span> <span class="p">(</span><span class="n">logging</span><span class="o">.</span><span class="n">WARNING</span> <span class="o">+</span> <span class="n">logging</span><span class="o">.</span><span class="n">ERROR</span><span class="p">)</span> <span class="o">//</span> <span class="mi">2</span>
</span></span><span class="line"><span class="cl"><span class="n">logging</span><span class="o">.</span><span class="n">addLevelName</span><span class="p">(</span><span class="n">HINT</span><span class="p">,</span> <span class="s2">&#34;HINT&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">logging</span><span class="o">.</span><span class="n">addLevelName</span><span class="p">(</span><span class="n">NOTE</span><span class="p">,</span> <span class="s2">&#34;NOTE&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">logging</span><span class="o">.</span><span class="n">addLevelName</span><span class="p">(</span><span class="n">DONE</span><span class="p">,</span> <span class="s2">&#34;DONE&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">def</span> <span class="nf">logg_debug_flock</span><span class="p">(</span><span class="nb">format</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="n">DEBUG_FLOCK</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">        <span class="n">logg</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="nb">format</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">)</span> <span class="c1"># pragma: no cover</span>
</span></span><span class="line"><span class="cl"><span class="k">def</span> <span class="nf">logg_debug_after</span><span class="p">(</span><span class="nb">format</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="n">DEBUG_AFTER</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">        <span class="n">logg</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="nb">format</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">)</span> <span class="c1"># pragma: no cover</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">NOT_A_PROBLEM</span> <span class="o">=</span> <span class="mi">0</span>   <span class="c1"># FOUND_OK</span>
</span></span><span class="line"><span class="cl"><span class="n">NOT_OK</span> <span class="o">=</span> <span class="mi">1</span>          <span class="c1"># FOUND_ERROR</span>
</span></span><span class="line"><span class="cl"><span class="n">NOT_ACTIVE</span> <span class="o">=</span> <span class="mi">2</span>      <span class="c1"># FOUND_INACTIVE</span>
</span></span><span class="line"><span class="cl"><span class="n">NOT_FOUND</span> <span class="o">=</span> <span class="mi">4</span>       <span class="c1"># FOUND_UNKNOWN</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># defaults for options</span>
</span></span><span class="line"><span class="cl"><span class="n">_extra_vars</span> <span class="o">=</span> <span class="p">[]</span>
</span></span><span class="line"><span class="cl"><span class="n">_force</span> <span class="o">=</span> <span class="kc">False</span>
</span></span><span class="line"><span class="cl"><span class="n">_full</span> <span class="o">=</span> <span class="kc">False</span>
</span></span><span class="line"><span class="cl"><span class="n">_log_lines</span> <span class="o">=</span> <span class="mi">0</span>
</span></span><span class="line"><span class="cl"><span class="n">_no_pager</span> <span class="o">=</span> <span class="kc">False</span>
</span></span><span class="line"><span class="cl"><span class="n">_now</span> <span class="o">=</span> <span class="kc">False</span>
</span></span><span class="line"><span class="cl"><span class="n">_no_reload</span> <span class="o">=</span> <span class="kc">False</span>
</span></span><span class="line"><span class="cl"><span class="n">_no_legend</span> <span class="o">=</span> <span class="kc">False</span>
</span></span><span class="line"><span class="cl"><span class="n">_no_ask_password</span> <span class="o">=</span> <span class="kc">False</span>
</span></span><span class="line"><span class="cl"><span class="n">_preset_mode</span> <span class="o">=</span> <span class="s2">&#34;all&#34;</span>
</span></span><span class="line"><span class="cl"><span class="n">_quiet</span> <span class="o">=</span> <span class="kc">False</span>
</span></span><span class="line"><span class="cl"><span class="n">_root</span> <span class="o">=</span> <span class="s2">&#34;&#34;</span>
</span></span><span class="line"><span class="cl"><span class="n">_show_all</span> <span class="o">=</span> <span class="kc">False</span>
</span></span><span class="line"><span class="cl"><span class="n">_user_mode</span> <span class="o">=</span> <span class="kc">False</span>
</span></span><span class="line"><span class="cl"><span class="n">_only_what</span> <span class="o">=</span> <span class="p">[]</span>
</span></span><span class="line"><span class="cl"><span class="n">_only_type</span> <span class="o">=</span> <span class="p">[]</span>
</span></span><span class="line"><span class="cl"><span class="n">_only_state</span> <span class="o">=</span> <span class="p">[]</span>
</span></span><span class="line"><span class="cl"><span class="n">_only_property</span> <span class="o">=</span> <span class="p">[]</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># common default paths</span>
</span></span><span class="line"><span class="cl"><span class="n">_system_folders</span> <span class="o">=</span> <span class="p">[</span>
</span></span><span class="line"><span class="cl">    <span class="s2">&#34;/etc/systemd/system&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="s2">&#34;/run/systemd/system&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="s2">&#34;/var/run/systemd/system&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="s2">&#34;/usr/local/lib/systemd/system&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="s2">&#34;/usr/lib/systemd/system&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="s2">&#34;/lib/systemd/system&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl"><span class="p">]</span>
</span></span><span class="line"><span class="cl"><span class="n">_user_folders</span> <span class="o">=</span> <span class="p">[</span>
</span></span><span class="line"><span class="cl">    <span class="s2">&#34;</span><span class="si">{XDG_CONFIG_HOME}</span><span class="s2">/systemd/user&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="s2">&#34;/etc/systemd/user&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="s2">&#34;</span><span class="si">{XDG_RUNTIME_DIR}</span><span class="s2">/systemd/user&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="s2">&#34;/run/systemd/user&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="s2">&#34;/var/run/systemd/user&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="s2">&#34;</span><span class="si">{XDG_DATA_HOME}</span><span class="s2">/systemd/user&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="s2">&#34;/usr/local/lib/systemd/user&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="s2">&#34;/usr/lib/systemd/user&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="s2">&#34;/lib/systemd/user&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl"><span class="p">]</span>
</span></span><span class="line"><span class="cl"><span class="n">_init_folders</span> <span class="o">=</span> <span class="p">[</span>
</span></span><span class="line"><span class="cl">    <span class="s2">&#34;/etc/init.d&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="s2">&#34;/run/init.d&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="s2">&#34;/var/run/init.d&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl"><span class="p">]</span>
</span></span><span class="line"><span class="cl"><span class="n">_preset_folders</span> <span class="o">=</span> <span class="p">[</span>
</span></span><span class="line"><span class="cl">    <span class="s2">&#34;/etc/systemd/system-preset&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="s2">&#34;/run/systemd/system-preset&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="s2">&#34;/var/run/systemd/system-preset&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="s2">&#34;/usr/local/lib/systemd/system-preset&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="s2">&#34;/usr/lib/systemd/system-preset&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="s2">&#34;/lib/systemd/system-preset&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl"><span class="p">]</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># standard paths</span>
</span></span><span class="line"><span class="cl"><span class="n">_dev_null</span> <span class="o">=</span> <span class="s2">&#34;/dev/null&#34;</span>
</span></span><span class="line"><span class="cl"><span class="n">_dev_zero</span> <span class="o">=</span> <span class="s2">&#34;/dev/zero&#34;</span>
</span></span><span class="line"><span class="cl"><span class="n">_etc_hosts</span> <span class="o">=</span> <span class="s2">&#34;/etc/hosts&#34;</span>
</span></span><span class="line"><span class="cl"><span class="n">_rc3_boot_folder</span> <span class="o">=</span> <span class="s2">&#34;/etc/rc3.d&#34;</span>
</span></span><span class="line"><span class="cl"><span class="n">_rc3_init_folder</span> <span class="o">=</span> <span class="s2">&#34;/etc/init.d/rc3.d&#34;</span>
</span></span><span class="line"><span class="cl"><span class="n">_rc5_boot_folder</span> <span class="o">=</span> <span class="s2">&#34;/etc/rc5.d&#34;</span>
</span></span><span class="line"><span class="cl"><span class="n">_rc5_init_folder</span> <span class="o">=</span> <span class="s2">&#34;/etc/init.d/rc5.d&#34;</span>
</span></span><span class="line"><span class="cl"><span class="n">_proc_pid_stat</span> <span class="o">=</span> <span class="s2">&#34;/proc/</span><span class="si">{pid}</span><span class="s2">/stat&#34;</span>
</span></span><span class="line"><span class="cl"><span class="n">_proc_pid_status</span> <span class="o">=</span> <span class="s2">&#34;/proc/</span><span class="si">{pid}</span><span class="s2">/status&#34;</span>
</span></span><span class="line"><span class="cl"><span class="n">_proc_pid_cmdline</span><span class="o">=</span> <span class="s2">&#34;/proc/</span><span class="si">{pid}</span><span class="s2">/cmdline&#34;</span>
</span></span><span class="line"><span class="cl"><span class="n">_proc_pid_dir</span> <span class="o">=</span> <span class="s2">&#34;/proc&#34;</span>
</span></span><span class="line"><span class="cl"><span class="n">_proc_sys_uptime</span> <span class="o">=</span> <span class="s2">&#34;/proc/uptime&#34;</span>
</span></span><span class="line"><span class="cl"><span class="n">_proc_sys_stat</span> <span class="o">=</span> <span class="s2">&#34;/proc/stat&#34;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># default values</span>
</span></span><span class="line"><span class="cl"><span class="n">SystemCompatibilityVersion</span> <span class="o">=</span> <span class="mi">219</span>
</span></span><span class="line"><span class="cl"><span class="n">SysInitTarget</span> <span class="o">=</span> <span class="s2">&#34;sysinit.target&#34;</span>
</span></span><span class="line"><span class="cl"><span class="n">SysInitWait</span> <span class="o">=</span> <span class="mi">5</span> <span class="c1"># max for target</span>
</span></span><span class="line"><span class="cl"><span class="n">MinimumYield</span> <span class="o">=</span> <span class="mf">0.5</span>
</span></span><span class="line"><span class="cl"><span class="n">MinimumTimeoutStartSec</span> <span class="o">=</span> <span class="mi">4</span>
</span></span><span class="line"><span class="cl"><span class="n">MinimumTimeoutStopSec</span> <span class="o">=</span> <span class="mi">4</span>
</span></span><span class="line"><span class="cl"><span class="n">DefaultTimeoutStartSec</span> <span class="o">=</span> <span class="mi">90</span>   <span class="c1"># official value</span>
</span></span><span class="line"><span class="cl"><span class="n">DefaultTimeoutStopSec</span> <span class="o">=</span> <span class="mi">90</span>    <span class="c1"># official value</span>
</span></span><span class="line"><span class="cl"><span class="n">DefaultTimeoutAbortSec</span> <span class="o">=</span> <span class="mi">3600</span> <span class="c1"># officially it none (usually larget than StopSec)</span>
</span></span><span class="line"><span class="cl"><span class="n">DefaultMaximumTimeout</span> <span class="o">=</span> <span class="mi">200</span>   <span class="c1"># overrides all other</span>
</span></span><span class="line"><span class="cl"><span class="n">DefaultRestartSec</span> <span class="o">=</span> <span class="mf">0.1</span>       <span class="c1"># official value of 100ms</span>
</span></span><span class="line"><span class="cl"><span class="n">DefaultStartLimitIntervalSec</span> <span class="o">=</span> <span class="mi">10</span> <span class="c1"># official value</span>
</span></span><span class="line"><span class="cl"><span class="n">DefaultStartLimitBurst</span> <span class="o">=</span> <span class="mi">5</span>        <span class="c1"># official value</span>
</span></span><span class="line"><span class="cl"><span class="n">InitLoopSleep</span> <span class="o">=</span> <span class="mi">5</span>
</span></span><span class="line"><span class="cl"><span class="n">MaxLockWait</span> <span class="o">=</span> <span class="mi">0</span> <span class="c1"># equals DefaultMaximumTimeout</span>
</span></span><span class="line"><span class="cl"><span class="n">DefaultPath</span> <span class="o">=</span> <span class="s2">&#34;/usr/local/sbin:/usr/local/bin:/usr/sbin:/usr/bin:/sbin:/bin&#34;</span>
</span></span><span class="line"><span class="cl"><span class="n">ResetLocale</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&#34;LANG&#34;</span><span class="p">,</span> <span class="s2">&#34;LANGUAGE&#34;</span><span class="p">,</span> <span class="s2">&#34;LC_CTYPE&#34;</span><span class="p">,</span> <span class="s2">&#34;LC_NUMERIC&#34;</span><span class="p">,</span> <span class="s2">&#34;LC_TIME&#34;</span><span class="p">,</span> <span class="s2">&#34;LC_COLLATE&#34;</span><span class="p">,</span> <span class="s2">&#34;LC_MONETARY&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">               <span class="s2">&#34;LC_MESSAGES&#34;</span><span class="p">,</span> <span class="s2">&#34;LC_PAPER&#34;</span><span class="p">,</span> <span class="s2">&#34;LC_NAME&#34;</span><span class="p">,</span> <span class="s2">&#34;LC_ADDRESS&#34;</span><span class="p">,</span> <span class="s2">&#34;LC_TELEPHONE&#34;</span><span class="p">,</span> <span class="s2">&#34;LC_MEASUREMENT&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">               <span class="s2">&#34;LC_IDENTIFICATION&#34;</span><span class="p">,</span> <span class="s2">&#34;LC_ALL&#34;</span><span class="p">]</span>
</span></span><span class="line"><span class="cl"><span class="n">LocaleConf</span><span class="o">=</span><span class="s2">&#34;/etc/locale.conf&#34;</span>
</span></span><span class="line"><span class="cl"><span class="n">DefaultListenBacklog</span><span class="o">=</span><span class="mi">2</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">ExitWhenNoMoreServices</span> <span class="o">=</span> <span class="kc">False</span>
</span></span><span class="line"><span class="cl"><span class="n">ExitWhenNoMoreProcs</span> <span class="o">=</span> <span class="kc">False</span>
</span></span><span class="line"><span class="cl"><span class="n">DefaultUnit</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&#34;SYSTEMD_DEFAULT_UNIT&#34;</span><span class="p">,</span> <span class="s2">&#34;default.target&#34;</span><span class="p">)</span> <span class="c1"># systemd.exe --unit=default.target</span>
</span></span><span class="line"><span class="cl"><span class="n">DefaultTarget</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&#34;SYSTEMD_DEFAULT_TARGET&#34;</span><span class="p">,</span> <span class="s2">&#34;multi-user.target&#34;</span><span class="p">)</span> <span class="c1"># DefaultUnit fallback</span>
</span></span><span class="line"><span class="cl"><span class="c1"># LogLevel = os.environ.get(&#34;SYSTEMD_LOG_LEVEL&#34;, &#34;info&#34;) # systemd.exe --log-level</span>
</span></span><span class="line"><span class="cl"><span class="c1"># LogTarget = os.environ.get(&#34;SYSTEMD_LOG_TARGET&#34;, &#34;journal-or-kmsg&#34;) # systemd.exe --log-target</span>
</span></span><span class="line"><span class="cl"><span class="c1"># LogLocation = os.environ.get(&#34;SYSTEMD_LOG_LOCATION&#34;, &#34;no&#34;) # systemd.exe --log-location</span>
</span></span><span class="line"><span class="cl"><span class="c1"># ShowStatus = os.environ.get(&#34;SYSTEMD_SHOW_STATUS&#34;, &#34;auto&#34;) # systemd.exe --show-status</span>
</span></span><span class="line"><span class="cl"><span class="n">DefaultStandardInput</span><span class="o">=</span><span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&#34;SYSTEMD_STANDARD_INPUT&#34;</span><span class="p">,</span> <span class="s2">&#34;null&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">DefaultStandardOutput</span><span class="o">=</span><span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&#34;SYSTEMD_STANDARD_OUTPUT&#34;</span><span class="p">,</span> <span class="s2">&#34;journal&#34;</span><span class="p">)</span> <span class="c1"># systemd.exe --default-standard-output</span>
</span></span><span class="line"><span class="cl"><span class="n">DefaultStandardError</span><span class="o">=</span><span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&#34;SYSTEMD_STANDARD_ERROR&#34;</span><span class="p">,</span> <span class="s2">&#34;inherit&#34;</span><span class="p">)</span> <span class="c1"># systemd.exe --default-standard-error</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">EXEC_SPAWN</span> <span class="o">=</span> <span class="kc">False</span>
</span></span><span class="line"><span class="cl"><span class="n">EXEC_DUP2</span> <span class="o">=</span> <span class="kc">True</span>
</span></span><span class="line"><span class="cl"><span class="n">REMOVE_LOCK_FILE</span> <span class="o">=</span> <span class="kc">False</span>
</span></span><span class="line"><span class="cl"><span class="n">BOOT_PID_MIN</span> <span class="o">=</span> <span class="mi">0</span>
</span></span><span class="line"><span class="cl"><span class="n">BOOT_PID_MAX</span> <span class="o">=</span> <span class="o">-</span><span class="mi">9</span>
</span></span><span class="line"><span class="cl"><span class="n">PROC_MAX_DEPTH</span> <span class="o">=</span> <span class="mi">100</span>
</span></span><span class="line"><span class="cl"><span class="n">EXPAND_VARS_MAXDEPTH</span> <span class="o">=</span> <span class="mi">20</span>
</span></span><span class="line"><span class="cl"><span class="n">EXPAND_KEEP_VARS</span> <span class="o">=</span> <span class="kc">True</span>
</span></span><span class="line"><span class="cl"><span class="n">RESTART_FAILED_UNITS</span> <span class="o">=</span> <span class="kc">True</span>
</span></span><span class="line"><span class="cl"><span class="n">ACTIVE_IF_ENABLED</span><span class="o">=</span><span class="kc">False</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">TAIL_CMDS</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&#34;/bin/tail&#34;</span><span class="p">,</span> <span class="s2">&#34;/usr/bin/tail&#34;</span><span class="p">,</span> <span class="s2">&#34;/usr/local/bin/tail&#34;</span><span class="p">]</span>
</span></span><span class="line"><span class="cl"><span class="n">LESS_CMDS</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&#34;/bin/less&#34;</span><span class="p">,</span> <span class="s2">&#34;/usr/bin/less&#34;</span><span class="p">,</span> <span class="s2">&#34;/usr/local/bin/less&#34;</span><span class="p">]</span>
</span></span><span class="line"><span class="cl"><span class="n">CAT_CMDS</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&#34;/bin/cat&#34;</span><span class="p">,</span> <span class="s2">&#34;/usr/bin/cat&#34;</span><span class="p">,</span> <span class="s2">&#34;/usr/local/bin/cat&#34;</span><span class="p">]</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># The systemd default was NOTIFY_SOCKET=&#34;/var/run/systemd/notify&#34;</span>
</span></span><span class="line"><span class="cl"><span class="n">_notify_socket_folder</span> <span class="o">=</span> <span class="s2">&#34;</span><span class="si">{RUN}</span><span class="s2">/systemd&#34;</span> <span class="c1"># alias /run/systemd</span>
</span></span><span class="line"><span class="cl"><span class="n">_journal_log_folder</span> <span class="o">=</span> <span class="s2">&#34;</span><span class="si">{LOG}</span><span class="s2">/journal&#34;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">SYSTEMCTL_DEBUG_LOG</span> <span class="o">=</span> <span class="s2">&#34;</span><span class="si">{LOG}</span><span class="s2">/systemctl.debug.log&#34;</span>
</span></span><span class="line"><span class="cl"><span class="n">SYSTEMCTL_EXTRA_LOG</span> <span class="o">=</span> <span class="s2">&#34;</span><span class="si">{LOG}</span><span class="s2">/systemctl.log&#34;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">_default_targets</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&#34;poweroff.target&#34;</span><span class="p">,</span> <span class="s2">&#34;rescue.target&#34;</span><span class="p">,</span> <span class="s2">&#34;sysinit.target&#34;</span><span class="p">,</span> <span class="s2">&#34;basic.target&#34;</span><span class="p">,</span> <span class="s2">&#34;multi-user.target&#34;</span><span class="p">,</span> <span class="s2">&#34;graphical.target&#34;</span><span class="p">,</span> <span class="s2">&#34;reboot.target&#34;</span><span class="p">]</span>
</span></span><span class="line"><span class="cl"><span class="n">_feature_targets</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&#34;network.target&#34;</span><span class="p">,</span> <span class="s2">&#34;remote-fs.target&#34;</span><span class="p">,</span> <span class="s2">&#34;local-fs.target&#34;</span><span class="p">,</span> <span class="s2">&#34;timers.target&#34;</span><span class="p">,</span> <span class="s2">&#34;nfs-client.target&#34;</span><span class="p">]</span>
</span></span><span class="line"><span class="cl"><span class="n">_all_common_targets</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&#34;default.target&#34;</span><span class="p">]</span> <span class="o">+</span> <span class="n">_default_targets</span> <span class="o">+</span> <span class="n">_feature_targets</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># inside a docker we pretend the following</span>
</span></span><span class="line"><span class="cl"><span class="n">_all_common_enabled</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&#34;default.target&#34;</span><span class="p">,</span> <span class="s2">&#34;multi-user.target&#34;</span><span class="p">,</span> <span class="s2">&#34;remote-fs.target&#34;</span><span class="p">]</span>
</span></span><span class="line"><span class="cl"><span class="n">_all_common_disabled</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&#34;graphical.target&#34;</span><span class="p">,</span> <span class="s2">&#34;resue.target&#34;</span><span class="p">,</span> <span class="s2">&#34;nfs-client.target&#34;</span><span class="p">]</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">target_requires</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&#34;graphical.target&#34;</span><span class="p">:</span> <span class="s2">&#34;multi-user.target&#34;</span><span class="p">,</span> <span class="s2">&#34;multi-user.target&#34;</span><span class="p">:</span> <span class="s2">&#34;basic.target&#34;</span><span class="p">,</span> <span class="s2">&#34;basic.target&#34;</span><span class="p">:</span> <span class="s2">&#34;sockets.target&#34;</span><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">_runlevel_mappings</span> <span class="o">=</span> <span class="p">{}</span> <span class="c1"># the official list</span>
</span></span><span class="line"><span class="cl"><span class="n">_runlevel_mappings</span><span class="p">[</span><span class="s2">&#34;0&#34;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&#34;poweroff.target&#34;</span>
</span></span><span class="line"><span class="cl"><span class="n">_runlevel_mappings</span><span class="p">[</span><span class="s2">&#34;1&#34;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&#34;rescue.target&#34;</span>
</span></span><span class="line"><span class="cl"><span class="n">_runlevel_mappings</span><span class="p">[</span><span class="s2">&#34;2&#34;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&#34;multi-user.target&#34;</span>
</span></span><span class="line"><span class="cl"><span class="n">_runlevel_mappings</span><span class="p">[</span><span class="s2">&#34;3&#34;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&#34;multi-user.target&#34;</span>
</span></span><span class="line"><span class="cl"><span class="n">_runlevel_mappings</span><span class="p">[</span><span class="s2">&#34;4&#34;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&#34;multi-user.target&#34;</span>
</span></span><span class="line"><span class="cl"><span class="n">_runlevel_mappings</span><span class="p">[</span><span class="s2">&#34;5&#34;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&#34;graphical.target&#34;</span>
</span></span><span class="line"><span class="cl"><span class="n">_runlevel_mappings</span><span class="p">[</span><span class="s2">&#34;6&#34;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&#34;reboot.target&#34;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">_sysv_mappings</span> <span class="o">=</span> <span class="p">{}</span> <span class="c1"># by rule of thumb</span>
</span></span><span class="line"><span class="cl"><span class="n">_sysv_mappings</span><span class="p">[</span><span class="s2">&#34;$local_fs&#34;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&#34;local-fs.target&#34;</span>
</span></span><span class="line"><span class="cl"><span class="n">_sysv_mappings</span><span class="p">[</span><span class="s2">&#34;$network&#34;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&#34;network.target&#34;</span>
</span></span><span class="line"><span class="cl"><span class="n">_sysv_mappings</span><span class="p">[</span><span class="s2">&#34;$remote_fs&#34;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&#34;remote-fs.target&#34;</span>
</span></span><span class="line"><span class="cl"><span class="n">_sysv_mappings</span><span class="p">[</span><span class="s2">&#34;$timer&#34;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&#34;timers.target&#34;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># sections from conf</span>
</span></span><span class="line"><span class="cl"><span class="n">Unit</span> <span class="o">=</span> <span class="s2">&#34;Unit&#34;</span>
</span></span><span class="line"><span class="cl"><span class="n">Service</span> <span class="o">=</span> <span class="s2">&#34;Service&#34;</span>
</span></span><span class="line"><span class="cl"><span class="n">Socket</span> <span class="o">=</span> <span class="s2">&#34;Socket&#34;</span>
</span></span><span class="line"><span class="cl"><span class="n">Install</span> <span class="o">=</span> <span class="s2">&#34;Install&#34;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># https://tldp.org/LDP/abs/html/exitcodes.html</span>
</span></span><span class="line"><span class="cl"><span class="c1"># https://freedesktop.org/software/systemd/man/systemd.exec.html#id-1.20.8</span>
</span></span><span class="line"><span class="cl"><span class="n">EXIT_SUCCESS</span> <span class="o">=</span> <span class="mi">0</span>
</span></span><span class="line"><span class="cl"><span class="n">EXIT_FAILURE</span> <span class="o">=</span> <span class="mi">1</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">def</span> <span class="nf">strINET</span><span class="p">(</span><span class="n">value</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="n">value</span> <span class="o">==</span> <span class="n">socket</span><span class="o">.</span><span class="n">SOCK_DGRAM</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="s2">&#34;UDP&#34;</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="n">value</span> <span class="o">==</span> <span class="n">socket</span><span class="o">.</span><span class="n">SOCK_STREAM</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="s2">&#34;TCP&#34;</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="n">value</span> <span class="o">==</span> <span class="n">socket</span><span class="o">.</span><span class="n">SOCK_RAW</span><span class="p">:</span> <span class="c1"># pragma: no cover</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="s2">&#34;RAW&#34;</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="n">value</span> <span class="o">==</span> <span class="n">socket</span><span class="o">.</span><span class="n">SOCK_RDM</span><span class="p">:</span> <span class="c1"># pragma: no cover</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="s2">&#34;RDM&#34;</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="n">value</span> <span class="o">==</span> <span class="n">socket</span><span class="o">.</span><span class="n">SOCK_SEQPACKET</span><span class="p">:</span> <span class="c1"># pragma: no cover</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="s2">&#34;SEQ&#34;</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="s2">&#34;&lt;?&gt;&#34;</span> <span class="c1"># pragma: no cover</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">def</span> <span class="nf">strYes</span><span class="p">(</span><span class="n">value</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="n">value</span> <span class="ow">is</span> <span class="kc">True</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="s2">&#34;yes&#34;</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="ow">not</span> <span class="n">value</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="s2">&#34;no&#34;</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="nb">str</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="k">def</span> <span class="nf">strE</span><span class="p">(</span><span class="n">part</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="ow">not</span> <span class="n">part</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="s2">&#34;&#34;</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="nb">str</span><span class="p">(</span><span class="n">part</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="k">def</span> <span class="nf">strQ</span><span class="p">(</span><span class="n">part</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="n">part</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="s2">&#34;&#34;</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">part</span><span class="p">,</span> <span class="nb">int</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="nb">str</span><span class="p">(</span><span class="n">part</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="s2">&#34;&#39;</span><span class="si">%s</span><span class="s2">&#39;&#34;</span> <span class="o">%</span> <span class="n">part</span>
</span></span><span class="line"><span class="cl"><span class="k">def</span> <span class="nf">shell_cmd</span><span class="p">(</span><span class="n">cmd</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="s2">&#34; &#34;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="n">strQ</span><span class="p">(</span><span class="n">part</span><span class="p">)</span> <span class="k">for</span> <span class="n">part</span> <span class="ow">in</span> <span class="n">cmd</span><span class="p">])</span>
</span></span><span class="line"><span class="cl"><span class="k">def</span> <span class="nf">to_intN</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="n">default</span> <span class="o">=</span> <span class="kc">None</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="ow">not</span> <span class="n">value</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="n">default</span>
</span></span><span class="line"><span class="cl">    <span class="k">try</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="nb">int</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="k">except</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="n">default</span>
</span></span><span class="line"><span class="cl"><span class="k">def</span> <span class="nf">to_int</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="n">default</span> <span class="o">=</span> <span class="mi">0</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">    <span class="k">try</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="nb">int</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="k">except</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="n">default</span>
</span></span><span class="line"><span class="cl"><span class="k">def</span> <span class="nf">to_list</span><span class="p">(</span><span class="n">value</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="ow">not</span> <span class="n">value</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="p">[]</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="nb">list</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="n">value</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="nb">tuple</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="nb">list</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="nb">str</span><span class="p">(</span><span class="n">value</span> <span class="ow">or</span> <span class="s2">&#34;&#34;</span><span class="p">)</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&#34;,&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="k">def</span> <span class="nf">commalist</span><span class="p">(</span><span class="n">value</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="nb">list</span><span class="p">(</span><span class="n">_commalist</span><span class="p">(</span><span class="n">value</span><span class="p">))</span>
</span></span><span class="line"><span class="cl"><span class="k">def</span> <span class="nf">_commalist</span><span class="p">(</span><span class="n">value</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">    <span class="k">for</span> <span class="n">val</span> <span class="ow">in</span> <span class="n">value</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="ow">not</span> <span class="n">val</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">            <span class="k">continue</span>
</span></span><span class="line"><span class="cl">        <span class="k">for</span> <span class="n">elem</span> <span class="ow">in</span> <span class="n">val</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&#34;,&#34;</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">            <span class="k">yield</span> <span class="n">elem</span>
</span></span><span class="line"><span class="cl"><span class="k">def</span> <span class="nf">int_mode</span><span class="p">(</span><span class="n">value</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">    <span class="k">try</span><span class="p">:</span> <span class="k">return</span> <span class="nb">int</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="mi">8</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="k">except</span><span class="p">:</span> <span class="k">return</span> <span class="kc">None</span> <span class="c1"># pragma: no cover</span>
</span></span><span class="line"><span class="cl"><span class="k">def</span> <span class="nf">unit_of</span><span class="p">(</span><span class="n">module</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="s2">&#34;.&#34;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">module</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="n">module</span> <span class="o">+</span> <span class="s2">&#34;.service&#34;</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="n">module</span>
</span></span><span class="line"><span class="cl"><span class="k">def</span> <span class="nf">o22</span><span class="p">(</span><span class="n">part</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">part</span><span class="p">,</span> <span class="n">basestring</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">part</span><span class="p">)</span> <span class="o">&lt;=</span> <span class="mi">22</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">            <span class="k">return</span> <span class="n">part</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="n">part</span><span class="p">[:</span><span class="mi">5</span><span class="p">]</span> <span class="o">+</span> <span class="s2">&#34;...&#34;</span> <span class="o">+</span> <span class="n">part</span><span class="p">[</span><span class="o">-</span><span class="mi">14</span><span class="p">:]</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="n">part</span> <span class="c1"># pragma: no cover (is always str)</span>
</span></span><span class="line"><span class="cl"><span class="k">def</span> <span class="nf">o44</span><span class="p">(</span><span class="n">part</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">part</span><span class="p">,</span> <span class="n">basestring</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">part</span><span class="p">)</span> <span class="o">&lt;=</span> <span class="mi">44</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">            <span class="k">return</span> <span class="n">part</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="n">part</span><span class="p">[:</span><span class="mi">10</span><span class="p">]</span> <span class="o">+</span> <span class="s2">&#34;...&#34;</span> <span class="o">+</span> <span class="n">part</span><span class="p">[</span><span class="o">-</span><span class="mi">31</span><span class="p">:]</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="n">part</span> <span class="c1"># pragma: no cover (is always str)</span>
</span></span><span class="line"><span class="cl"><span class="k">def</span> <span class="nf">o77</span><span class="p">(</span><span class="n">part</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">part</span><span class="p">,</span> <span class="n">basestring</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">part</span><span class="p">)</span> <span class="o">&lt;=</span> <span class="mi">77</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">            <span class="k">return</span> <span class="n">part</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="n">part</span><span class="p">[:</span><span class="mi">20</span><span class="p">]</span> <span class="o">+</span> <span class="s2">&#34;...&#34;</span> <span class="o">+</span> <span class="n">part</span><span class="p">[</span><span class="o">-</span><span class="mi">54</span><span class="p">:]</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="n">part</span> <span class="c1"># pragma: no cover (is always str)</span>
</span></span><span class="line"><span class="cl"><span class="k">def</span> <span class="nf">path44</span><span class="p">(</span><span class="n">filename</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="ow">not</span> <span class="n">filename</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="s2">&#34;&lt;none&gt;&#34;</span>
</span></span><span class="line"><span class="cl">    <span class="n">x</span> <span class="o">=</span> <span class="n">filename</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="s2">&#34;/&#34;</span><span class="p">,</span> <span class="mi">8</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">filename</span><span class="p">)</span> <span class="o">&lt;=</span> <span class="mi">40</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="s2">&#34;/&#34;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">filename</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">            <span class="k">return</span> <span class="s2">&#34;.../&#34;</span> <span class="o">+</span> <span class="n">filename</span>
</span></span><span class="line"><span class="cl">    <span class="k">elif</span> <span class="nb">len</span><span class="p">(</span><span class="n">filename</span><span class="p">)</span> <span class="o">&lt;=</span> <span class="mi">44</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="n">filename</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="mi">0</span> <span class="o">&lt;</span> <span class="n">x</span> <span class="ow">and</span> <span class="n">x</span> <span class="o">&lt;</span> <span class="mi">14</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">        <span class="n">out</span> <span class="o">=</span> <span class="n">filename</span><span class="p">[:</span><span class="n">x</span><span class="o">+</span><span class="mi">1</span><span class="p">]</span>
</span></span><span class="line"><span class="cl">        <span class="n">out</span> <span class="o">+=</span> <span class="s2">&#34;...&#34;</span>
</span></span><span class="line"><span class="cl">    <span class="k">else</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">        <span class="n">out</span> <span class="o">=</span> <span class="n">filename</span><span class="p">[:</span><span class="mi">10</span><span class="p">]</span>
</span></span><span class="line"><span class="cl">        <span class="n">out</span> <span class="o">+=</span> <span class="s2">&#34;...&#34;</span>
</span></span><span class="line"><span class="cl">    <span class="n">remain</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">filename</span><span class="p">)</span> <span class="o">-</span> <span class="nb">len</span><span class="p">(</span><span class="n">out</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="n">y</span> <span class="o">=</span> <span class="n">filename</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="s2">&#34;/&#34;</span><span class="p">,</span> <span class="n">remain</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="mi">0</span> <span class="o">&lt;</span> <span class="n">y</span> <span class="ow">and</span> <span class="n">y</span> <span class="o">&lt;</span> <span class="n">remain</span><span class="o">+</span><span class="mi">5</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">        <span class="n">out</span> <span class="o">+=</span> <span class="n">filename</span><span class="p">[</span><span class="n">y</span><span class="p">:]</span>
</span></span><span class="line"><span class="cl">    <span class="k">else</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">        <span class="n">out</span> <span class="o">+=</span> <span class="n">filename</span><span class="p">[</span><span class="n">remain</span><span class="p">:]</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="n">out</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">def</span> <span class="nf">unit_name_escape</span><span class="p">(</span><span class="n">text</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">    <span class="c1"># https://www.freedesktop.org/software/systemd/man/systemd.unit.html#id-1.6</span>
</span></span><span class="line"><span class="cl">    <span class="n">esc</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">sub</span><span class="p">(</span><span class="s2">&#34;([^a-z-AZ.-/])&#34;</span><span class="p">,</span> <span class="k">lambda</span> <span class="n">m</span><span class="p">:</span> <span class="s2">&#34;</span><span class="se">\\</span><span class="s2">x</span><span class="si">%02x</span><span class="s2">&#34;</span> <span class="o">%</span> <span class="nb">ord</span><span class="p">(</span><span class="n">m</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">1</span><span class="p">)[</span><span class="mi">0</span><span class="p">]),</span> <span class="n">text</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="n">esc</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&#34;/&#34;</span><span class="p">,</span> <span class="s2">&#34;-&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="k">def</span> <span class="nf">unit_name_unescape</span><span class="p">(</span><span class="n">text</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">    <span class="n">esc</span> <span class="o">=</span> <span class="n">text</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&#34;-&#34;</span><span class="p">,</span> <span class="s2">&#34;/&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="n">re</span><span class="o">.</span><span class="n">sub</span><span class="p">(</span><span class="s2">&#34;</span><span class="se">\\\\</span><span class="s2">x(..)&#34;</span><span class="p">,</span> <span class="k">lambda</span> <span class="n">m</span><span class="p">:</span> <span class="s2">&#34;</span><span class="si">%c</span><span class="s2">&#34;</span> <span class="o">%</span> <span class="nb">chr</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">m</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">1</span><span class="p">),</span> <span class="mi">16</span><span class="p">)),</span> <span class="n">esc</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">def</span> <span class="nf">is_good_root</span><span class="p">(</span><span class="n">root</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="ow">not</span> <span class="n">root</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="kc">True</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="n">root</span><span class="o">.</span><span class="n">strip</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">sep</span><span class="p">)</span><span class="o">.</span><span class="n">count</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">sep</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span>
</span></span><span class="line"><span class="cl"><span class="k">def</span> <span class="nf">os_path</span><span class="p">(</span><span class="n">root</span><span class="p">,</span> <span class="n">path</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="ow">not</span> <span class="n">root</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="n">path</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="ow">not</span> <span class="n">path</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="n">path</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="n">is_good_root</span><span class="p">(</span><span class="n">root</span><span class="p">)</span> <span class="ow">and</span> <span class="n">path</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="n">root</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="n">path</span>
</span></span><span class="line"><span class="cl">    <span class="k">while</span> <span class="n">path</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">sep</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">        <span class="n">path</span> <span class="o">=</span> <span class="n">path</span><span class="p">[</span><span class="mi">1</span><span class="p">:]</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">root</span><span class="p">,</span> <span class="n">path</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="k">def</span> <span class="nf">path_replace_extension</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="n">old</span><span class="p">,</span> <span class="n">new</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="n">path</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="n">old</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">        <span class="n">path</span> <span class="o">=</span> <span class="n">path</span><span class="p">[:</span><span class="o">-</span><span class="nb">len</span><span class="p">(</span><span class="n">old</span><span class="p">)]</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="n">path</span> <span class="o">+</span> <span class="n">new</span>
</span></span><span class="line"><span class="cl"><span class="k">def</span> <span class="nf">get_exist_path</span><span class="p">(</span><span class="n">paths</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">    <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">paths</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">p</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">            <span class="k">return</span> <span class="n">p</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="kc">None</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">def</span> <span class="nf">get_PAGER</span><span class="p">():</span>
</span></span><span class="line"><span class="cl">    <span class="n">PAGER</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&#34;PAGER&#34;</span><span class="p">,</span> <span class="s2">&#34;less&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="n">pager</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&#34;SYSTEMD_PAGER&#34;</span><span class="p">,</span> <span class="s2">&#34;</span><span class="si">{PAGER}</span><span class="s2">&#34;</span><span class="p">)</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="o">**</span><span class="nb">locals</span><span class="p">())</span>
</span></span><span class="line"><span class="cl">    <span class="n">options</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&#34;SYSTEMD_LESS&#34;</span><span class="p">,</span> <span class="s2">&#34;FRSXMK&#34;</span><span class="p">)</span> <span class="c1"># see &#39;man timedatectl&#39;</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="ow">not</span> <span class="n">pager</span><span class="p">:</span> <span class="n">pager</span> <span class="o">=</span> <span class="s2">&#34;cat&#34;</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="s2">&#34;less&#34;</span> <span class="ow">in</span> <span class="n">pager</span> <span class="ow">and</span> <span class="n">options</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="p">[</span><span class="n">pager</span><span class="p">,</span> <span class="s2">&#34;-&#34;</span> <span class="o">+</span> <span class="n">options</span><span class="p">]</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="p">[</span><span class="n">pager</span><span class="p">]</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">def</span> <span class="nf">os_getlogin</span><span class="p">():</span>
</span></span><span class="line"><span class="cl">    <span class="s2">&#34;&#34;&#34; NOT using os.getlogin() &#34;&#34;&#34;</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="n">pwd</span><span class="o">.</span><span class="n">getpwuid</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">geteuid</span><span class="p">())</span><span class="o">.</span><span class="n">pw_name</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">def</span> <span class="nf">get_runtime_dir</span><span class="p">():</span>
</span></span><span class="line"><span class="cl">    <span class="n">explicit</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&#34;XDG_RUNTIME_DIR&#34;</span><span class="p">,</span> <span class="s2">&#34;&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="n">explicit</span><span class="p">:</span> <span class="k">return</span> <span class="n">explicit</span>
</span></span><span class="line"><span class="cl">    <span class="n">user</span> <span class="o">=</span> <span class="n">os_getlogin</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="s2">&#34;/tmp/run-&#34;</span><span class="o">+</span><span class="n">user</span>
</span></span><span class="line"><span class="cl"><span class="k">def</span> <span class="nf">get_RUN</span><span class="p">(</span><span class="n">root</span> <span class="o">=</span> <span class="kc">False</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">    <span class="n">tmp_var</span> <span class="o">=</span> <span class="n">get_TMP</span><span class="p">(</span><span class="n">root</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="n">_root</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">        <span class="n">tmp_var</span> <span class="o">=</span> <span class="n">_root</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="n">root</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">        <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="p">(</span><span class="s2">&#34;/run&#34;</span><span class="p">,</span> <span class="s2">&#34;/var/run&#34;</span><span class="p">,</span> <span class="s2">&#34;</span><span class="si">{tmp_var}</span><span class="s2">/run&#34;</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">            <span class="n">path</span> <span class="o">=</span> <span class="n">p</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="o">**</span><span class="nb">locals</span><span class="p">())</span>
</span></span><span class="line"><span class="cl">            <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isdir</span><span class="p">(</span><span class="n">path</span><span class="p">)</span> <span class="ow">and</span> <span class="n">os</span><span class="o">.</span><span class="n">access</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="n">os</span><span class="o">.</span><span class="n">W_OK</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">                <span class="k">return</span> <span class="n">path</span>
</span></span><span class="line"><span class="cl">        <span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="n">path</span><span class="p">)</span> <span class="c1"># &#34;/tmp/run&#34;</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="n">path</span>
</span></span><span class="line"><span class="cl">    <span class="k">else</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">        <span class="n">uid</span> <span class="o">=</span> <span class="n">get_USER_ID</span><span class="p">(</span><span class="n">root</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="p">(</span><span class="s2">&#34;/run/user/</span><span class="si">{uid}</span><span class="s2">&#34;</span><span class="p">,</span> <span class="s2">&#34;/var/run/user/</span><span class="si">{uid}</span><span class="s2">&#34;</span><span class="p">,</span> <span class="s2">&#34;</span><span class="si">{tmp_var}</span><span class="s2">/run-</span><span class="si">{uid}</span><span class="s2">&#34;</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">            <span class="n">path</span> <span class="o">=</span> <span class="n">p</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="o">**</span><span class="nb">locals</span><span class="p">())</span>
</span></span><span class="line"><span class="cl">            <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isdir</span><span class="p">(</span><span class="n">path</span><span class="p">)</span> <span class="ow">and</span> <span class="n">os</span><span class="o">.</span><span class="n">access</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="n">os</span><span class="o">.</span><span class="n">W_OK</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">                <span class="k">return</span> <span class="n">path</span>
</span></span><span class="line"><span class="cl">        <span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="mo">0o700</span><span class="p">)</span> <span class="c1"># &#34;/tmp/run/user/{uid}&#34;</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="n">path</span>
</span></span><span class="line"><span class="cl"><span class="k">def</span> <span class="nf">get_PID_DIR</span><span class="p">(</span><span class="n">root</span> <span class="o">=</span> <span class="kc">False</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="n">root</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="n">get_RUN</span><span class="p">(</span><span class="n">root</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="k">else</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">get_RUN</span><span class="p">(</span><span class="n">root</span><span class="p">),</span> <span class="s2">&#34;run&#34;</span><span class="p">)</span> <span class="c1"># compat with older systemctl.py</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">def</span> <span class="nf">get_home</span><span class="p">():</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="kc">False</span><span class="p">:</span> <span class="c1"># pragma: no cover</span>
</span></span><span class="line"><span class="cl">        <span class="n">explicit</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&#34;HOME&#34;</span><span class="p">,</span> <span class="s2">&#34;&#34;</span><span class="p">)</span>   <span class="c1"># &gt;&gt; On Unix, an initial ~ (tilde) is replaced by the</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="n">explicit</span><span class="p">:</span> <span class="k">return</span> <span class="n">explicit</span>            <span class="c1"># environment variable HOME if it is set; otherwise</span>
</span></span><span class="line"><span class="cl">        <span class="n">uid</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">geteuid</span><span class="p">()</span>                      <span class="c1"># the current users home directory is looked up in the</span>
</span></span><span class="line"><span class="cl">        <span class="c1">#                                       # password directory through the built-in module pwd.</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="n">pwd</span><span class="o">.</span><span class="n">getpwuid</span><span class="p">(</span><span class="n">uid</span><span class="p">)</span><span class="o">.</span><span class="n">pw_name</span>        <span class="c1"># An initial ~user i looked up directly in the</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">expanduser</span><span class="p">(</span><span class="s2">&#34;~&#34;</span><span class="p">)</span>              <span class="c1"># password directory. &lt;&lt; from docs(os.path.expanduser)</span>
</span></span><span class="line"><span class="cl"><span class="k">def</span> <span class="nf">get_HOME</span><span class="p">(</span><span class="n">root</span> <span class="o">=</span> <span class="kc">False</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="n">root</span><span class="p">:</span> <span class="k">return</span> <span class="s2">&#34;/root&#34;</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="n">get_home</span><span class="p">()</span>
</span></span><span class="line"><span class="cl"><span class="k">def</span> <span class="nf">get_USER_ID</span><span class="p">(</span><span class="n">root</span> <span class="o">=</span> <span class="kc">False</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">    <span class="n">ID</span> <span class="o">=</span> <span class="mi">0</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="n">root</span><span class="p">:</span> <span class="k">return</span> <span class="n">ID</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="n">os</span><span class="o">.</span><span class="n">geteuid</span><span class="p">()</span>
</span></span><span class="line"><span class="cl"><span class="k">def</span> <span class="nf">get_USER</span><span class="p">(</span><span class="n">root</span> <span class="o">=</span> <span class="kc">False</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="n">root</span><span class="p">:</span> <span class="k">return</span> <span class="s2">&#34;root&#34;</span>
</span></span><span class="line"><span class="cl">    <span class="n">uid</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">geteuid</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="n">pwd</span><span class="o">.</span><span class="n">getpwuid</span><span class="p">(</span><span class="n">uid</span><span class="p">)</span><span class="o">.</span><span class="n">pw_name</span>
</span></span><span class="line"><span class="cl"><span class="k">def</span> <span class="nf">get_GROUP_ID</span><span class="p">(</span><span class="n">root</span> <span class="o">=</span> <span class="kc">False</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">    <span class="n">ID</span> <span class="o">=</span> <span class="mi">0</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="n">root</span><span class="p">:</span> <span class="k">return</span> <span class="n">ID</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="n">os</span><span class="o">.</span><span class="n">getegid</span><span class="p">()</span>
</span></span><span class="line"><span class="cl"><span class="k">def</span> <span class="nf">get_GROUP</span><span class="p">(</span><span class="n">root</span> <span class="o">=</span> <span class="kc">False</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="n">root</span><span class="p">:</span> <span class="k">return</span> <span class="s2">&#34;root&#34;</span>
</span></span><span class="line"><span class="cl">    <span class="n">gid</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">getegid</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="n">grp</span><span class="o">.</span><span class="n">getgrgid</span><span class="p">(</span><span class="n">gid</span><span class="p">)</span><span class="o">.</span><span class="n">gr_name</span>
</span></span><span class="line"><span class="cl"><span class="k">def</span> <span class="nf">get_TMP</span><span class="p">(</span><span class="n">root</span> <span class="o">=</span> <span class="kc">False</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">    <span class="n">TMP</span> <span class="o">=</span> <span class="s2">&#34;/tmp&#34;</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="n">root</span><span class="p">:</span> <span class="k">return</span> <span class="n">TMP</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&#34;TMPDIR&#34;</span><span class="p">,</span> <span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&#34;TEMP&#34;</span><span class="p">,</span> <span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&#34;TMP&#34;</span><span class="p">,</span> <span class="n">TMP</span><span class="p">)))</span>
</span></span><span class="line"><span class="cl"><span class="k">def</span> <span class="nf">get_VARTMP</span><span class="p">(</span><span class="n">root</span> <span class="o">=</span> <span class="kc">False</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">    <span class="n">VARTMP</span> <span class="o">=</span> <span class="s2">&#34;/var/tmp&#34;</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="n">root</span><span class="p">:</span> <span class="k">return</span> <span class="n">VARTMP</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&#34;TMPDIR&#34;</span><span class="p">,</span> <span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&#34;TEMP&#34;</span><span class="p">,</span> <span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&#34;TMP&#34;</span><span class="p">,</span> <span class="n">VARTMP</span><span class="p">)))</span>
</span></span><span class="line"><span class="cl"><span class="k">def</span> <span class="nf">get_SHELL</span><span class="p">(</span><span class="n">root</span> <span class="o">=</span> <span class="kc">False</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">    <span class="n">SHELL</span> <span class="o">=</span> <span class="s2">&#34;/bin/sh&#34;</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="n">root</span><span class="p">:</span> <span class="k">return</span> <span class="n">SHELL</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&#34;SHELL&#34;</span><span class="p">,</span> <span class="n">SHELL</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="k">def</span> <span class="nf">get_RUNTIME_DIR</span><span class="p">(</span><span class="n">root</span> <span class="o">=</span> <span class="kc">False</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">    <span class="n">RUN</span> <span class="o">=</span> <span class="s2">&#34;/run&#34;</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="n">root</span><span class="p">:</span> <span class="k">return</span> <span class="n">RUN</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&#34;XDG_RUNTIME_DIR&#34;</span><span class="p">,</span> <span class="n">get_runtime_dir</span><span class="p">())</span>
</span></span><span class="line"><span class="cl"><span class="k">def</span> <span class="nf">get_CONFIG_HOME</span><span class="p">(</span><span class="n">root</span> <span class="o">=</span> <span class="kc">False</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">    <span class="n">CONFIG</span> <span class="o">=</span> <span class="s2">&#34;/etc&#34;</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="n">root</span><span class="p">:</span> <span class="k">return</span> <span class="n">CONFIG</span>
</span></span><span class="line"><span class="cl">    <span class="n">HOME</span> <span class="o">=</span> <span class="n">get_HOME</span><span class="p">(</span><span class="n">root</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&#34;XDG_CONFIG_HOME&#34;</span><span class="p">,</span> <span class="n">HOME</span> <span class="o">+</span> <span class="s2">&#34;/.config&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="k">def</span> <span class="nf">get_CACHE_HOME</span><span class="p">(</span><span class="n">root</span> <span class="o">=</span> <span class="kc">False</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">    <span class="n">CACHE</span> <span class="o">=</span> <span class="s2">&#34;/var/cache&#34;</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="n">root</span><span class="p">:</span> <span class="k">return</span> <span class="n">CACHE</span>
</span></span><span class="line"><span class="cl">    <span class="n">HOME</span> <span class="o">=</span> <span class="n">get_HOME</span><span class="p">(</span><span class="n">root</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&#34;XDG_CACHE_HOME&#34;</span><span class="p">,</span> <span class="n">HOME</span> <span class="o">+</span> <span class="s2">&#34;/.cache&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="k">def</span> <span class="nf">get_DATA_HOME</span><span class="p">(</span><span class="n">root</span> <span class="o">=</span> <span class="kc">False</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">    <span class="n">SHARE</span> <span class="o">=</span> <span class="s2">&#34;/usr/share&#34;</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="n">root</span><span class="p">:</span> <span class="k">return</span> <span class="n">SHARE</span>
</span></span><span class="line"><span class="cl">    <span class="n">HOME</span> <span class="o">=</span> <span class="n">get_HOME</span><span class="p">(</span><span class="n">root</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&#34;XDG_DATA_HOME&#34;</span><span class="p">,</span> <span class="n">HOME</span> <span class="o">+</span> <span class="s2">&#34;/.local/share&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="k">def</span> <span class="nf">get_LOG_DIR</span><span class="p">(</span><span class="n">root</span> <span class="o">=</span> <span class="kc">False</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">    <span class="n">LOGDIR</span> <span class="o">=</span> <span class="s2">&#34;/var/log&#34;</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="n">root</span><span class="p">:</span> <span class="k">return</span> <span class="n">LOGDIR</span>
</span></span><span class="line"><span class="cl">    <span class="n">CONFIG</span> <span class="o">=</span> <span class="n">get_CONFIG_HOME</span><span class="p">(</span><span class="n">root</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">CONFIG</span><span class="p">,</span> <span class="s2">&#34;log&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="k">def</span> <span class="nf">get_VARLIB_HOME</span><span class="p">(</span><span class="n">root</span> <span class="o">=</span> <span class="kc">False</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">    <span class="n">VARLIB</span> <span class="o">=</span> <span class="s2">&#34;/var/lib&#34;</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="n">root</span><span class="p">:</span> <span class="k">return</span> <span class="n">VARLIB</span>
</span></span><span class="line"><span class="cl">    <span class="n">CONFIG</span> <span class="o">=</span> <span class="n">get_CONFIG_HOME</span><span class="p">(</span><span class="n">root</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="n">CONFIG</span>
</span></span><span class="line"><span class="cl"><span class="k">def</span> <span class="nf">expand_path</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="n">root</span> <span class="o">=</span> <span class="kc">False</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">    <span class="n">HOME</span> <span class="o">=</span> <span class="n">get_HOME</span><span class="p">(</span><span class="n">root</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="n">RUN</span> <span class="o">=</span> <span class="n">get_RUN</span><span class="p">(</span><span class="n">root</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="n">LOG</span> <span class="o">=</span> <span class="n">get_LOG_DIR</span><span class="p">(</span><span class="n">root</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="n">XDG_DATA_HOME</span><span class="o">=</span><span class="n">get_DATA_HOME</span><span class="p">(</span><span class="n">root</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="n">XDG_CONFIG_HOME</span><span class="o">=</span><span class="n">get_CONFIG_HOME</span><span class="p">(</span><span class="n">root</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="n">XDG_RUNTIME_DIR</span><span class="o">=</span><span class="n">get_RUNTIME_DIR</span><span class="p">(</span><span class="n">root</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">expanduser</span><span class="p">(</span><span class="n">path</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&#34;${&#34;</span><span class="p">,</span> <span class="s2">&#34;{&#34;</span><span class="p">)</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="o">**</span><span class="nb">locals</span><span class="p">()))</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">def</span> <span class="nf">shutil_chown</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="n">user</span><span class="p">,</span> <span class="n">group</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="n">user</span> <span class="ow">or</span> <span class="n">group</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">        <span class="n">uid</span><span class="p">,</span> <span class="n">gid</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="n">user</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">            <span class="n">uid</span> <span class="o">=</span> <span class="n">pwd</span><span class="o">.</span><span class="n">getpwnam</span><span class="p">(</span><span class="n">user</span><span class="p">)</span><span class="o">.</span><span class="n">pw_uid</span>
</span></span><span class="line"><span class="cl">            <span class="n">gid</span> <span class="o">=</span> <span class="n">pwd</span><span class="o">.</span><span class="n">getpwnam</span><span class="p">(</span><span class="n">user</span><span class="p">)</span><span class="o">.</span><span class="n">pw_gid</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="n">group</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">            <span class="n">gid</span> <span class="o">=</span> <span class="n">grp</span><span class="o">.</span><span class="n">getgrnam</span><span class="p">(</span><span class="n">group</span><span class="p">)</span><span class="o">.</span><span class="n">gr_gid</span>
</span></span><span class="line"><span class="cl">        <span class="n">os</span><span class="o">.</span><span class="n">chown</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="n">uid</span><span class="p">,</span> <span class="n">gid</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="k">def</span> <span class="nf">shutil_fchown</span><span class="p">(</span><span class="n">fileno</span><span class="p">,</span> <span class="n">user</span><span class="p">,</span> <span class="n">group</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="n">user</span> <span class="ow">or</span> <span class="n">group</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">        <span class="n">uid</span><span class="p">,</span> <span class="n">gid</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="n">user</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">            <span class="n">uid</span> <span class="o">=</span> <span class="n">pwd</span><span class="o">.</span><span class="n">getpwnam</span><span class="p">(</span><span class="n">user</span><span class="p">)</span><span class="o">.</span><span class="n">pw_uid</span>
</span></span><span class="line"><span class="cl">            <span class="n">gid</span> <span class="o">=</span> <span class="n">pwd</span><span class="o">.</span><span class="n">getpwnam</span><span class="p">(</span><span class="n">user</span><span class="p">)</span><span class="o">.</span><span class="n">pw_gid</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="n">group</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">            <span class="n">gid</span> <span class="o">=</span> <span class="n">grp</span><span class="o">.</span><span class="n">getgrnam</span><span class="p">(</span><span class="n">group</span><span class="p">)</span><span class="o">.</span><span class="n">gr_gid</span>
</span></span><span class="line"><span class="cl">        <span class="n">os</span><span class="o">.</span><span class="n">fchown</span><span class="p">(</span><span class="n">fileno</span><span class="p">,</span> <span class="n">uid</span><span class="p">,</span> <span class="n">gid</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="k">def</span> <span class="nf">shutil_setuid</span><span class="p">(</span><span class="n">user</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">group</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">xgroups</span> <span class="o">=</span> <span class="kc">None</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">    <span class="s2">&#34;&#34;&#34; set fork-child uid/gid (returns pw-info env-settings)&#34;&#34;&#34;</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="n">group</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">        <span class="n">gid</span> <span class="o">=</span> <span class="n">grp</span><span class="o">.</span><span class="n">getgrnam</span><span class="p">(</span><span class="n">group</span><span class="p">)</span><span class="o">.</span><span class="n">gr_gid</span>
</span></span><span class="line"><span class="cl">        <span class="n">os</span><span class="o">.</span><span class="n">setgid</span><span class="p">(</span><span class="n">gid</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="n">logg</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&#34;setgid </span><span class="si">%s</span><span class="s2"> for </span><span class="si">%s</span><span class="s2">&#34;</span><span class="p">,</span> <span class="n">gid</span><span class="p">,</span> <span class="n">strQ</span><span class="p">(</span><span class="n">group</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">        <span class="n">groups</span> <span class="o">=</span> <span class="p">[</span><span class="n">gid</span><span class="p">]</span>
</span></span><span class="line"><span class="cl">        <span class="k">try</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">            <span class="n">os</span><span class="o">.</span><span class="n">setgroups</span><span class="p">(</span><span class="n">groups</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">            <span class="n">logg</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&#34;setgroups </span><span class="si">%s</span><span class="s2"> &lt; (</span><span class="si">%s</span><span class="s2">)&#34;</span><span class="p">,</span> <span class="n">groups</span><span class="p">,</span> <span class="n">group</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="k">except</span> <span class="ne">OSError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span> <span class="c1"># pragma: no cover (it will occur in non-root mode anyway)</span>
</span></span><span class="line"><span class="cl">            <span class="n">logg</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&#34;setgroups </span><span class="si">%s</span><span class="s2"> &lt; (</span><span class="si">%s</span><span class="s2">) : </span><span class="si">%s</span><span class="s2">&#34;</span><span class="p">,</span> <span class="n">groups</span><span class="p">,</span> <span class="n">group</span><span class="p">,</span> <span class="n">e</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="n">user</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">        <span class="n">pw</span> <span class="o">=</span> <span class="n">pwd</span><span class="o">.</span><span class="n">getpwnam</span><span class="p">(</span><span class="n">user</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="n">gid</span> <span class="o">=</span> <span class="n">pw</span><span class="o">.</span><span class="n">pw_gid</span>
</span></span><span class="line"><span class="cl">        <span class="n">gname</span> <span class="o">=</span> <span class="n">grp</span><span class="o">.</span><span class="n">getgrgid</span><span class="p">(</span><span class="n">gid</span><span class="p">)</span><span class="o">.</span><span class="n">gr_name</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="ow">not</span> <span class="n">group</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">            <span class="n">os</span><span class="o">.</span><span class="n">setgid</span><span class="p">(</span><span class="n">gid</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">            <span class="n">logg</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&#34;setgid </span><span class="si">%s</span><span class="s2"> for user </span><span class="si">%s</span><span class="s2">&#34;</span><span class="p">,</span> <span class="n">gid</span><span class="p">,</span> <span class="n">strQ</span><span class="p">(</span><span class="n">user</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">        <span class="n">groupnames</span> <span class="o">=</span> <span class="p">[</span><span class="n">g</span><span class="o">.</span><span class="n">gr_name</span> <span class="k">for</span> <span class="n">g</span> <span class="ow">in</span> <span class="n">grp</span><span class="o">.</span><span class="n">getgrall</span><span class="p">()</span> <span class="k">if</span> <span class="n">user</span> <span class="ow">in</span> <span class="n">g</span><span class="o">.</span><span class="n">gr_mem</span><span class="p">]</span>
</span></span><span class="line"><span class="cl">        <span class="n">groups</span> <span class="o">=</span> <span class="p">[</span><span class="n">g</span><span class="o">.</span><span class="n">gr_gid</span> <span class="k">for</span> <span class="n">g</span> <span class="ow">in</span> <span class="n">grp</span><span class="o">.</span><span class="n">getgrall</span><span class="p">()</span> <span class="k">if</span> <span class="n">user</span> <span class="ow">in</span> <span class="n">g</span><span class="o">.</span><span class="n">gr_mem</span><span class="p">]</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="n">xgroups</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">            <span class="n">groups</span> <span class="o">+=</span> <span class="p">[</span><span class="n">g</span><span class="o">.</span><span class="n">gr_gid</span> <span class="k">for</span> <span class="n">g</span> <span class="ow">in</span> <span class="n">grp</span><span class="o">.</span><span class="n">getgrall</span><span class="p">()</span> <span class="k">if</span> <span class="n">g</span><span class="o">.</span><span class="n">gr_name</span> <span class="ow">in</span> <span class="n">xgroups</span> <span class="ow">and</span> <span class="n">g</span><span class="o">.</span><span class="n">gr_gid</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">groups</span><span class="p">]</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="ow">not</span> <span class="n">groups</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">            <span class="k">if</span> <span class="n">group</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">                <span class="n">gid</span> <span class="o">=</span> <span class="n">grp</span><span class="o">.</span><span class="n">getgrnam</span><span class="p">(</span><span class="n">group</span><span class="p">)</span><span class="o">.</span><span class="n">gr_gid</span>
</span></span><span class="line"><span class="cl">            <span class="n">groups</span> <span class="o">=</span> <span class="p">[</span><span class="n">gid</span><span class="p">]</span>
</span></span><span class="line"><span class="cl">        <span class="k">try</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">            <span class="n">os</span><span class="o">.</span><span class="n">setgroups</span><span class="p">(</span><span class="n">groups</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">            <span class="n">logg</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&#34;setgroups </span><span class="si">%s</span><span class="s2"> &gt; </span><span class="si">%s</span><span class="s2"> &#34;</span><span class="p">,</span> <span class="n">groups</span><span class="p">,</span> <span class="n">groupnames</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="k">except</span> <span class="ne">OSError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span> <span class="c1"># pragma: no cover (it will occur in non-root mode anyway)</span>
</span></span><span class="line"><span class="cl">            <span class="n">logg</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&#34;setgroups </span><span class="si">%s</span><span class="s2"> &gt; </span><span class="si">%s</span><span class="s2"> : </span><span class="si">%s</span><span class="s2">&#34;</span><span class="p">,</span> <span class="n">groups</span><span class="p">,</span> <span class="n">groupnames</span><span class="p">,</span> <span class="n">e</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="n">uid</span> <span class="o">=</span> <span class="n">pw</span><span class="o">.</span><span class="n">pw_uid</span>
</span></span><span class="line"><span class="cl">        <span class="n">os</span><span class="o">.</span><span class="n">setuid</span><span class="p">(</span><span class="n">uid</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="n">logg</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&#34;setuid </span><span class="si">%s</span><span class="s2"> for user </span><span class="si">%s</span><span class="s2">&#34;</span><span class="p">,</span> <span class="n">uid</span><span class="p">,</span> <span class="n">strQ</span><span class="p">(</span><span class="n">user</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">        <span class="n">home</span> <span class="o">=</span> <span class="n">pw</span><span class="o">.</span><span class="n">pw_dir</span>
</span></span><span class="line"><span class="cl">        <span class="n">shell</span> <span class="o">=</span> <span class="n">pw</span><span class="o">.</span><span class="n">pw_shell</span>
</span></span><span class="line"><span class="cl">        <span class="n">logname</span> <span class="o">=</span> <span class="n">pw</span><span class="o">.</span><span class="n">pw_name</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="p">{</span><span class="s2">&#34;USER&#34;</span><span class="p">:</span> <span class="n">user</span><span class="p">,</span> <span class="s2">&#34;LOGNAME&#34;</span><span class="p">:</span> <span class="n">logname</span><span class="p">,</span> <span class="s2">&#34;HOME&#34;</span><span class="p">:</span> <span class="n">home</span><span class="p">,</span> <span class="s2">&#34;SHELL&#34;</span><span class="p">:</span> <span class="n">shell</span><span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="p">{}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">def</span> <span class="nf">shutil_truncate</span><span class="p">(</span><span class="n">filename</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">    <span class="s2">&#34;&#34;&#34; truncates the file (or creates a new empty file)&#34;&#34;&#34;</span>
</span></span><span class="line"><span class="cl">    <span class="n">filedir</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="n">filename</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isdir</span><span class="p">(</span><span class="n">filedir</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">        <span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="n">filedir</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="s2">&#34;w&#34;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">        <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&#34;&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># http://stackoverflow.com/questions/568271/how-to-check-if-there-exists-a-process-with-a-given-pid</span>
</span></span><span class="line"><span class="cl"><span class="k">def</span> <span class="nf">pid_exists</span><span class="p">(</span><span class="n">pid</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">    <span class="s2">&#34;&#34;&#34;Check whether pid exists in the current process table.&#34;&#34;&#34;</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="n">pid</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span> <span class="c1"># pragma: no cover (is never null)</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="kc">False</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="n">_pid_exists</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">pid</span><span class="p">))</span>
</span></span><span class="line"><span class="cl"><span class="k">def</span> <span class="nf">_pid_exists</span><span class="p">(</span><span class="n">pid</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">    <span class="s2">&#34;&#34;&#34;Check whether pid exists in the current process table.
</span></span></span><span class="line"><span class="cl"><span class="s2">    UNIX only.
</span></span></span><span class="line"><span class="cl"><span class="s2">    &#34;&#34;&#34;</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="n">pid</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="kc">False</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="n">pid</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">        <span class="c1"># According to &#34;man 2 kill&#34; PID 0 refers to every process</span>
</span></span><span class="line"><span class="cl">        <span class="c1"># in the process group of the calling process.</span>
</span></span><span class="line"><span class="cl">        <span class="c1"># On certain systems 0 is a valid PID but we have no way</span>
</span></span><span class="line"><span class="cl">        <span class="c1"># to know that in a portable fashion.</span>
</span></span><span class="line"><span class="cl">        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;invalid PID 0&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="k">try</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">        <span class="n">os</span><span class="o">.</span><span class="n">kill</span><span class="p">(</span><span class="n">pid</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="k">except</span> <span class="ne">OSError</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="n">err</span><span class="o">.</span><span class="n">errno</span> <span class="o">==</span> <span class="n">errno</span><span class="o">.</span><span class="n">ESRCH</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">            <span class="c1"># ESRCH == No such process</span>
</span></span><span class="line"><span class="cl">            <span class="k">return</span> <span class="kc">False</span>
</span></span><span class="line"><span class="cl">        <span class="k">elif</span> <span class="n">err</span><span class="o">.</span><span class="n">errno</span> <span class="o">==</span> <span class="n">errno</span><span class="o">.</span><span class="n">EPERM</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">            <span class="c1"># EPERM clearly means there&#39;s a process to deny access to</span>
</span></span><span class="line"><span class="cl">            <span class="k">return</span> <span class="kc">True</span>
</span></span><span class="line"><span class="cl">        <span class="k">else</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">            <span class="c1"># According to &#34;man 2 kill&#34; possible error values are</span>
</span></span><span class="line"><span class="cl">            <span class="c1"># (EINVAL, EPERM, ESRCH)</span>
</span></span><span class="line"><span class="cl">            <span class="k">raise</span>
</span></span><span class="line"><span class="cl">    <span class="k">else</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="kc">True</span>
</span></span><span class="line"><span class="cl"><span class="k">def</span> <span class="nf">pid_zombie</span><span class="p">(</span><span class="n">pid</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">    <span class="s2">&#34;&#34;&#34; may be a pid exists but it is only a zombie &#34;&#34;&#34;</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="n">pid</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="kc">False</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="n">_pid_zombie</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">pid</span><span class="p">))</span>
</span></span><span class="line"><span class="cl"><span class="k">def</span> <span class="nf">_pid_zombie</span><span class="p">(</span><span class="n">pid</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">    <span class="s2">&#34;&#34;&#34; may be a pid exists but it is only a zombie &#34;&#34;&#34;</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="n">pid</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="kc">False</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="n">pid</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">        <span class="c1"># According to &#34;man 2 kill&#34; PID 0 refers to every process</span>
</span></span><span class="line"><span class="cl">        <span class="c1"># in the process group of the calling process.</span>
</span></span><span class="line"><span class="cl">        <span class="c1"># On certain systems 0 is a valid PID but we have no way</span>
</span></span><span class="line"><span class="cl">        <span class="c1"># to know that in a portable fashion.</span>
</span></span><span class="line"><span class="cl">        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;invalid PID 0&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="n">check</span> <span class="o">=</span> <span class="n">_proc_pid_status</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="o">**</span><span class="nb">locals</span><span class="p">())</span>
</span></span><span class="line"><span class="cl">    <span class="k">try</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">check</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">            <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">f</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">                <span class="k">if</span> <span class="n">line</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s2">&#34;State:&#34;</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">                    <span class="k">return</span> <span class="s2">&#34;Z&#34;</span> <span class="ow">in</span> <span class="n">line</span>
</span></span><span class="line"><span class="cl">    <span class="k">except</span> <span class="ne">IOError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="n">e</span><span class="o">.</span><span class="n">errno</span> <span class="o">!=</span> <span class="n">errno</span><span class="o">.</span><span class="n">ENOENT</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">            <span class="n">logg</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&#34;</span><span class="si">%s</span><span class="s2"> (</span><span class="si">%s</span><span class="s2">): </span><span class="si">%s</span><span class="s2">&#34;</span><span class="p">,</span> <span class="n">check</span><span class="p">,</span> <span class="n">e</span><span class="o">.</span><span class="n">errno</span><span class="p">,</span> <span class="n">e</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="kc">False</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="kc">False</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">def</span> <span class="nf">checkprefix</span><span class="p">(</span><span class="n">cmd</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">    <span class="n">prefix</span> <span class="o">=</span> <span class="s2">&#34;&#34;</span>
</span></span><span class="line"><span class="cl">    <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">c</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">cmd</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="n">c</span> <span class="ow">in</span> <span class="s2">&#34;-+!@:&#34;</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">            <span class="n">prefix</span> <span class="o">=</span> <span class="n">prefix</span> <span class="o">+</span> <span class="n">c</span>
</span></span><span class="line"><span class="cl">        <span class="k">else</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">            <span class="n">newcmd</span> <span class="o">=</span> <span class="n">cmd</span><span class="p">[</span><span class="n">i</span><span class="p">:]</span>
</span></span><span class="line"><span class="cl">            <span class="k">return</span> <span class="n">prefix</span><span class="p">,</span> <span class="n">newcmd</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="n">prefix</span><span class="p">,</span> <span class="s2">&#34;&#34;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">ExecMode</span> <span class="o">=</span> <span class="n">collections</span><span class="o">.</span><span class="n">namedtuple</span><span class="p">(</span><span class="s2">&#34;ExecMode&#34;</span><span class="p">,</span> <span class="p">[</span><span class="s2">&#34;mode&#34;</span><span class="p">,</span> <span class="s2">&#34;check&#34;</span><span class="p">,</span> <span class="s2">&#34;nouser&#34;</span><span class="p">,</span> <span class="s2">&#34;noexpand&#34;</span><span class="p">,</span> <span class="s2">&#34;argv0&#34;</span><span class="p">])</span>
</span></span><span class="line"><span class="cl"><span class="k">def</span> <span class="nf">exec_path</span><span class="p">(</span><span class="n">cmd</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">    <span class="s2">&#34;&#34;&#34; Hint: exec_path values are usually not moved by --root (while load_path are)&#34;&#34;&#34;</span>
</span></span><span class="line"><span class="cl">    <span class="n">prefix</span><span class="p">,</span> <span class="n">newcmd</span> <span class="o">=</span> <span class="n">checkprefix</span><span class="p">(</span><span class="n">cmd</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="n">check</span> <span class="o">=</span> <span class="s2">&#34;-&#34;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">prefix</span>
</span></span><span class="line"><span class="cl">    <span class="n">nouser</span> <span class="o">=</span> <span class="s2">&#34;+&#34;</span> <span class="ow">in</span> <span class="n">prefix</span> <span class="ow">or</span> <span class="s2">&#34;!&#34;</span> <span class="ow">in</span> <span class="n">prefix</span>
</span></span><span class="line"><span class="cl">    <span class="n">noexpand</span> <span class="o">=</span> <span class="s2">&#34;:&#34;</span> <span class="ow">in</span> <span class="n">prefix</span>
</span></span><span class="line"><span class="cl">    <span class="n">argv0</span> <span class="o">=</span> <span class="s2">&#34;@&#34;</span> <span class="ow">in</span> <span class="n">prefix</span>
</span></span><span class="line"><span class="cl">    <span class="n">mode</span> <span class="o">=</span> <span class="n">ExecMode</span><span class="p">(</span><span class="n">prefix</span><span class="p">,</span> <span class="n">check</span><span class="p">,</span> <span class="n">nouser</span><span class="p">,</span> <span class="n">noexpand</span><span class="p">,</span> <span class="n">argv0</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="n">mode</span><span class="p">,</span> <span class="n">newcmd</span>
</span></span><span class="line"><span class="cl"><span class="n">LoadMode</span> <span class="o">=</span> <span class="n">collections</span><span class="o">.</span><span class="n">namedtuple</span><span class="p">(</span><span class="s2">&#34;LoadMode&#34;</span><span class="p">,</span> <span class="p">[</span><span class="s2">&#34;mode&#34;</span><span class="p">,</span> <span class="s2">&#34;check&#34;</span><span class="p">])</span>
</span></span><span class="line"><span class="cl"><span class="k">def</span> <span class="nf">load_path</span><span class="p">(</span><span class="n">ref</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">    <span class="s2">&#34;&#34;&#34; Hint: load_path values are usually moved by --root (while exec_path are not)&#34;&#34;&#34;</span>
</span></span><span class="line"><span class="cl">    <span class="n">prefix</span><span class="p">,</span> <span class="n">filename</span> <span class="o">=</span> <span class="s2">&#34;&#34;</span><span class="p">,</span> <span class="n">ref</span>
</span></span><span class="line"><span class="cl">    <span class="k">while</span> <span class="n">filename</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s2">&#34;-&#34;</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">        <span class="n">prefix</span> <span class="o">=</span> <span class="n">prefix</span> <span class="o">+</span> <span class="n">filename</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
</span></span><span class="line"><span class="cl">        <span class="n">filename</span> <span class="o">=</span> <span class="n">filename</span><span class="p">[</span><span class="mi">1</span><span class="p">:]</span>
</span></span><span class="line"><span class="cl">    <span class="n">check</span> <span class="o">=</span> <span class="s2">&#34;-&#34;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">prefix</span>
</span></span><span class="line"><span class="cl">    <span class="n">mode</span> <span class="o">=</span> <span class="n">LoadMode</span><span class="p">(</span><span class="n">prefix</span><span class="p">,</span> <span class="n">check</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="n">mode</span><span class="p">,</span> <span class="n">filename</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># https://github.com/phusion/baseimage-docker/blob/rel-0.9.16/image/bin/my_init</span>
</span></span><span class="line"><span class="cl"><span class="k">def</span> <span class="nf">ignore_signals_and_raise_keyboard_interrupt</span><span class="p">(</span><span class="n">signame</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">    <span class="n">signal</span><span class="o">.</span><span class="n">signal</span><span class="p">(</span><span class="n">signal</span><span class="o">.</span><span class="n">SIGTERM</span><span class="p">,</span> <span class="n">signal</span><span class="o">.</span><span class="n">SIG_IGN</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="n">signal</span><span class="o">.</span><span class="n">signal</span><span class="p">(</span><span class="n">signal</span><span class="o">.</span><span class="n">SIGINT</span><span class="p">,</span> <span class="n">signal</span><span class="o">.</span><span class="n">SIG_IGN</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="k">raise</span> <span class="ne">KeyboardInterrupt</span><span class="p">(</span><span class="n">signame</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">_default_dict_type</span> <span class="o">=</span> <span class="n">collections</span><span class="o">.</span><span class="n">OrderedDict</span>
</span></span><span class="line"><span class="cl"><span class="n">_default_conf_type</span> <span class="o">=</span> <span class="n">collections</span><span class="o">.</span><span class="n">OrderedDict</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">class</span> <span class="nc">SystemctlConfData</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">    <span class="s2">&#34;&#34;&#34; A *.service files has a structure similar to an *.ini file so
</span></span></span><span class="line"><span class="cl"><span class="s2">        that data is structured in sections and values. Actually the
</span></span></span><span class="line"><span class="cl"><span class="s2">        values are lists - the raw data is in .getlist(). Otherwise
</span></span></span><span class="line"><span class="cl"><span class="s2">        .get() will return the first line that was encountered. &#34;&#34;&#34;</span>
</span></span><span class="line"><span class="cl">    <span class="c1"># |</span>
</span></span><span class="line"><span class="cl">    <span class="c1"># |</span>
</span></span><span class="line"><span class="cl">    <span class="c1"># |</span>
</span></span><span class="line"><span class="cl">    <span class="c1"># |</span>
</span></span><span class="line"><span class="cl">    <span class="c1"># |</span>
</span></span><span class="line"><span class="cl">    <span class="c1"># |</span>
</span></span><span class="line"><span class="cl">    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">defaults</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">dict_type</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">conf_type</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">allow_no_value</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">        <span class="bp">self</span><span class="o">.</span><span class="n">_defaults</span> <span class="o">=</span> <span class="n">defaults</span> <span class="ow">or</span> <span class="p">{}</span>
</span></span><span class="line"><span class="cl">        <span class="bp">self</span><span class="o">.</span><span class="n">_conf_type</span> <span class="o">=</span> <span class="n">conf_type</span> <span class="ow">or</span> <span class="n">_default_conf_type</span>
</span></span><span class="line"><span class="cl">        <span class="bp">self</span><span class="o">.</span><span class="n">_dict_type</span> <span class="o">=</span> <span class="n">dict_type</span> <span class="ow">or</span> <span class="n">_default_dict_type</span>
</span></span><span class="line"><span class="cl">        <span class="bp">self</span><span class="o">.</span><span class="n">_allow_no_value</span> <span class="o">=</span> <span class="n">allow_no_value</span>
</span></span><span class="line"><span class="cl">        <span class="bp">self</span><span class="o">.</span><span class="n">_conf</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_conf_type</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">        <span class="bp">self</span><span class="o">.</span><span class="n">_files</span> <span class="o">=</span> <span class="p">[]</span>
</span></span><span class="line"><span class="cl">    <span class="k">def</span> <span class="nf">defaults</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_defaults</span>
</span></span><span class="line"><span class="cl">    <span class="k">def</span> <span class="nf">sections</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_conf</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>
</span></span><span class="line"><span class="cl">    <span class="k">def</span> <span class="nf">add_section</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">section</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="n">section</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_conf</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">            <span class="bp">self</span><span class="o">.</span><span class="n">_conf</span><span class="p">[</span><span class="n">section</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_dict_type</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">    <span class="k">def</span> <span class="nf">has_section</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">section</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="n">section</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_conf</span>
</span></span><span class="line"><span class="cl">    <span class="k">def</span> <span class="nf">has_option</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">section</span><span class="p">,</span> <span class="n">option</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="n">section</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_conf</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">            <span class="k">return</span> <span class="kc">False</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="n">option</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_conf</span><span class="p">[</span><span class="n">section</span><span class="p">]</span>
</span></span><span class="line"><span class="cl">    <span class="k">def</span> <span class="nf">set</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">section</span><span class="p">,</span> <span class="n">option</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="n">section</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_conf</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">            <span class="bp">self</span><span class="o">.</span><span class="n">_conf</span><span class="p">[</span><span class="n">section</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_dict_type</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="n">value</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">            <span class="bp">self</span><span class="o">.</span><span class="n">_conf</span><span class="p">[</span><span class="n">section</span><span class="p">][</span><span class="n">option</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
</span></span><span class="line"><span class="cl">        <span class="k">elif</span> <span class="n">option</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_conf</span><span class="p">[</span><span class="n">section</span><span class="p">]:</span>
</span></span><span class="line"><span class="cl">            <span class="bp">self</span><span class="o">.</span><span class="n">_conf</span><span class="p">[</span><span class="n">section</span><span class="p">][</span><span class="n">option</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="n">value</span><span class="p">]</span>
</span></span><span class="line"><span class="cl">        <span class="k">else</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">            <span class="bp">self</span><span class="o">.</span><span class="n">_conf</span><span class="p">[</span><span class="n">section</span><span class="p">][</span><span class="n">option</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="k">def</span> <span class="nf">getstr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">section</span><span class="p">,</span> <span class="n">option</span><span class="p">,</span> <span class="n">default</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">allow_no_value</span> <span class="o">=</span> <span class="kc">False</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">        <span class="n">done</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">section</span><span class="p">,</span> <span class="n">option</span><span class="p">,</span> <span class="n">strE</span><span class="p">(</span><span class="n">default</span><span class="p">),</span> <span class="n">allow_no_value</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="n">done</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span> <span class="k">return</span> <span class="n">strE</span><span class="p">(</span><span class="n">default</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="n">done</span>
</span></span><span class="line"><span class="cl">    <span class="k">def</span> <span class="nf">get</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">section</span><span class="p">,</span> <span class="n">option</span><span class="p">,</span> <span class="n">default</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">allow_no_value</span> <span class="o">=</span> <span class="kc">False</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">        <span class="n">allow_no_value</span> <span class="o">=</span> <span class="n">allow_no_value</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">_allow_no_value</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="n">section</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_conf</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">            <span class="k">if</span> <span class="n">default</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">                <span class="k">return</span> <span class="n">default</span>
</span></span><span class="line"><span class="cl">            <span class="k">if</span> <span class="n">allow_no_value</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">                <span class="k">return</span> <span class="kc">None</span>
</span></span><span class="line"><span class="cl">            <span class="n">logg</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&#34;section </span><span class="si">{}</span><span class="s2"> does not exist&#34;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">section</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">            <span class="n">logg</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&#34;  have </span><span class="si">{}</span><span class="s2">&#34;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">sections</span><span class="p">()))</span>
</span></span><span class="line"><span class="cl">            <span class="k">raise</span> <span class="ne">AttributeError</span><span class="p">(</span><span class="s2">&#34;section </span><span class="si">{}</span><span class="s2"> does not exist&#34;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">section</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="n">option</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_conf</span><span class="p">[</span><span class="n">section</span><span class="p">]:</span>
</span></span><span class="line"><span class="cl">            <span class="k">if</span> <span class="n">default</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">                <span class="k">return</span> <span class="n">default</span>
</span></span><span class="line"><span class="cl">            <span class="k">if</span> <span class="n">allow_no_value</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">                <span class="k">return</span> <span class="kc">None</span>
</span></span><span class="line"><span class="cl">            <span class="k">raise</span> <span class="ne">AttributeError</span><span class="p">(</span><span class="s2">&#34;option </span><span class="si">{}</span><span class="s2"> in </span><span class="si">{}</span><span class="s2"> does not exist&#34;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">option</span><span class="p">,</span> <span class="n">section</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_conf</span><span class="p">[</span><span class="n">section</span><span class="p">][</span><span class="n">option</span><span class="p">]:</span> <span class="c1"># i.e. an empty list</span>
</span></span><span class="line"><span class="cl">            <span class="k">if</span> <span class="n">default</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">                <span class="k">return</span> <span class="n">default</span>
</span></span><span class="line"><span class="cl">            <span class="k">if</span> <span class="n">allow_no_value</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">                <span class="k">return</span> <span class="kc">None</span>
</span></span><span class="line"><span class="cl">            <span class="k">raise</span> <span class="ne">AttributeError</span><span class="p">(</span><span class="s2">&#34;option </span><span class="si">{}</span><span class="s2"> in </span><span class="si">{}</span><span class="s2"> is None&#34;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">option</span><span class="p">,</span> <span class="n">section</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_conf</span><span class="p">[</span><span class="n">section</span><span class="p">][</span><span class="n">option</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> <span class="c1"># the first line in the list of configs</span>
</span></span><span class="line"><span class="cl">    <span class="k">def</span> <span class="nf">getlist</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">section</span><span class="p">,</span> <span class="n">option</span><span class="p">,</span> <span class="n">default</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">allow_no_value</span> <span class="o">=</span> <span class="kc">False</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">        <span class="n">allow_no_value</span> <span class="o">=</span> <span class="n">allow_no_value</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">_allow_no_value</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="n">section</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_conf</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">            <span class="k">if</span> <span class="n">default</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">                <span class="k">return</span> <span class="n">default</span>
</span></span><span class="line"><span class="cl">            <span class="k">if</span> <span class="n">allow_no_value</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">                <span class="k">return</span> <span class="p">[]</span>
</span></span><span class="line"><span class="cl">            <span class="n">logg</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&#34;section </span><span class="si">{}</span><span class="s2"> does not exist&#34;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">section</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">            <span class="n">logg</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&#34;  have </span><span class="si">{}</span><span class="s2">&#34;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">sections</span><span class="p">()))</span>
</span></span><span class="line"><span class="cl">            <span class="k">raise</span> <span class="ne">AttributeError</span><span class="p">(</span><span class="s2">&#34;section </span><span class="si">{}</span><span class="s2"> does not exist&#34;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">section</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="n">option</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_conf</span><span class="p">[</span><span class="n">section</span><span class="p">]:</span>
</span></span><span class="line"><span class="cl">            <span class="k">if</span> <span class="n">default</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">                <span class="k">return</span> <span class="n">default</span>
</span></span><span class="line"><span class="cl">            <span class="k">if</span> <span class="n">allow_no_value</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">                <span class="k">return</span> <span class="p">[]</span>
</span></span><span class="line"><span class="cl">            <span class="k">raise</span> <span class="ne">AttributeError</span><span class="p">(</span><span class="s2">&#34;option </span><span class="si">{}</span><span class="s2"> in </span><span class="si">{}</span><span class="s2"> does not exist&#34;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">option</span><span class="p">,</span> <span class="n">section</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_conf</span><span class="p">[</span><span class="n">section</span><span class="p">][</span><span class="n">option</span><span class="p">]</span> <span class="c1"># returns a list, possibly empty</span>
</span></span><span class="line"><span class="cl">    <span class="k">def</span> <span class="nf">filenames</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_files</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">class</span> <span class="nc">SystemctlConfigParser</span><span class="p">(</span><span class="n">SystemctlConfData</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">    <span class="s2">&#34;&#34;&#34; A *.service files has a structure similar to an *.ini file but it is
</span></span></span><span class="line"><span class="cl"><span class="s2">        actually not like it. Settings may occur multiple times in each section
</span></span></span><span class="line"><span class="cl"><span class="s2">        and they create an implicit list. In reality all the settings are
</span></span></span><span class="line"><span class="cl"><span class="s2">        globally uniqute, so that an &#39;environment&#39; can be printed without
</span></span></span><span class="line"><span class="cl"><span class="s2">        adding prefixes. Settings are continued with a backslash at the end
</span></span></span><span class="line"><span class="cl"><span class="s2">        of the line.  &#34;&#34;&#34;</span>
</span></span><span class="line"><span class="cl">    <span class="c1"># def __init__(self, defaults=None, dict_type=None, allow_no_value=False):</span>
</span></span><span class="line"><span class="cl">    <span class="c1">#   SystemctlConfData.__init__(self, defaults, dict_type, allow_no_value)</span>
</span></span><span class="line"><span class="cl">    <span class="k">def</span> <span class="nf">read</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">filename</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">read_sysd</span><span class="p">(</span><span class="n">filename</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="k">def</span> <span class="nf">read_sysd</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">filename</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">        <span class="n">initscript</span> <span class="o">=</span> <span class="kc">False</span>
</span></span><span class="line"><span class="cl">        <span class="n">initinfo</span> <span class="o">=</span> <span class="kc">False</span>
</span></span><span class="line"><span class="cl">        <span class="n">section</span> <span class="o">=</span> <span class="s2">&#34;GLOBAL&#34;</span>
</span></span><span class="line"><span class="cl">        <span class="n">nextline</span> <span class="o">=</span> <span class="kc">False</span>
</span></span><span class="line"><span class="cl">        <span class="n">name</span><span class="p">,</span> <span class="n">text</span> <span class="o">=</span> <span class="s2">&#34;&#34;</span><span class="p">,</span> <span class="s2">&#34;&#34;</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isfile</span><span class="p">(</span><span class="n">filename</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">            <span class="bp">self</span><span class="o">.</span><span class="n">_files</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">filename</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">filename</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">            <span class="k">for</span> <span class="n">orig_line</span> <span class="ow">in</span> <span class="n">f</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">                <span class="k">if</span> <span class="n">nextline</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">                    <span class="n">text</span> <span class="o">+=</span> <span class="n">orig_line</span>
</span></span><span class="line"><span class="cl">                    <span class="k">if</span> <span class="n">text</span><span class="o">.</span><span class="n">rstrip</span><span class="p">()</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s2">&#34;</span><span class="se">\\</span><span class="s2">&#34;</span><span class="p">)</span> <span class="ow">or</span> <span class="n">text</span><span class="o">.</span><span class="n">rstrip</span><span class="p">()</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s2">&#34;</span><span class="se">\\\n</span><span class="s2">&#34;</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">                        <span class="n">text</span> <span class="o">=</span> <span class="n">text</span><span class="o">.</span><span class="n">rstrip</span><span class="p">()</span> <span class="o">+</span> <span class="s2">&#34;</span><span class="se">\n</span><span class="s2">&#34;</span>
</span></span><span class="line"><span class="cl">                    <span class="k">else</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">                        <span class="bp">self</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="n">section</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">text</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">                        <span class="n">nextline</span> <span class="o">=</span> <span class="kc">False</span>
</span></span><span class="line"><span class="cl">                    <span class="k">continue</span>
</span></span><span class="line"><span class="cl">                <span class="n">line</span> <span class="o">=</span> <span class="n">orig_line</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">                <span class="k">if</span> <span class="ow">not</span> <span class="n">line</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">                    <span class="k">continue</span>
</span></span><span class="line"><span class="cl">                <span class="k">if</span> <span class="n">line</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s2">&#34;#&#34;</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">                    <span class="k">continue</span>
</span></span><span class="line"><span class="cl">                <span class="k">if</span> <span class="n">line</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s2">&#34;;&#34;</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">                    <span class="k">continue</span>
</span></span><span class="line"><span class="cl">                <span class="k">if</span> <span class="n">line</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s2">&#34;.include&#34;</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">                    <span class="n">logg</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&#34;the &#39;.include&#39; syntax is deprecated. Use x.service.d/ drop-in files!&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">                    <span class="n">includefile</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">sub</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;^\.include[ ]*&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="n">line</span><span class="p">)</span><span class="o">.</span><span class="n">rstrip</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">                    <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isfile</span><span class="p">(</span><span class="n">includefile</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">                        <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s2">&#34;tried to include file that doesn&#39;t exist: </span><span class="si">%s</span><span class="s2">&#34;</span> <span class="o">%</span> <span class="n">includefile</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">                    <span class="bp">self</span><span class="o">.</span><span class="n">read_sysd</span><span class="p">(</span><span class="n">includefile</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">                    <span class="k">continue</span>
</span></span><span class="line"><span class="cl">                <span class="k">if</span> <span class="n">line</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s2">&#34;[&#34;</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">                    <span class="n">x</span> <span class="o">=</span> <span class="n">line</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="s2">&#34;]&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">                    <span class="k">if</span> <span class="n">x</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">                        <span class="n">section</span> <span class="o">=</span> <span class="n">line</span><span class="p">[</span><span class="mi">1</span><span class="p">:</span><span class="n">x</span><span class="p">]</span>
</span></span><span class="line"><span class="cl">                        <span class="bp">self</span><span class="o">.</span><span class="n">add_section</span><span class="p">(</span><span class="n">section</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">                    <span class="k">continue</span>
</span></span><span class="line"><span class="cl">                <span class="n">m</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="k">match</span><span class="p">(</span><span class="sa">r</span><span class="s2">&#34;(\w+) *=(.*)&#34;</span><span class="p">,</span> <span class="n">line</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">                <span class="k">if</span> <span class="ow">not</span> <span class="n">m</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">                    <span class="n">logg</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&#34;bad ini line: </span><span class="si">%s</span><span class="s2">&#34;</span><span class="p">,</span> <span class="n">line</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">                    <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s2">&#34;bad ini line&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">                <span class="n">name</span><span class="p">,</span> <span class="n">text</span> <span class="o">=</span> <span class="n">m</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">1</span><span class="p">),</span> <span class="n">m</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">                <span class="k">if</span> <span class="n">text</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s2">&#34;</span><span class="se">\\</span><span class="s2">&#34;</span><span class="p">)</span> <span class="ow">or</span> <span class="n">text</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s2">&#34;</span><span class="se">\\\n</span><span class="s2">&#34;</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">                    <span class="n">nextline</span> <span class="o">=</span> <span class="kc">True</span>
</span></span><span class="line"><span class="cl">                    <span class="n">text</span> <span class="o">=</span> <span class="n">text</span> <span class="o">+</span> <span class="s2">&#34;</span><span class="se">\n</span><span class="s2">&#34;</span>
</span></span><span class="line"><span class="cl">                <span class="k">else</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">                    <span class="c1"># hint: an empty line shall reset the value-list</span>
</span></span><span class="line"><span class="cl">                    <span class="bp">self</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="n">section</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">text</span> <span class="ow">and</span> <span class="n">text</span> <span class="ow">or</span> <span class="kc">None</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">            <span class="k">if</span> <span class="n">nextline</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">                <span class="bp">self</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="n">section</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">text</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="bp">self</span>
</span></span><span class="line"><span class="cl">    <span class="k">def</span> <span class="nf">read_sysv</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">filename</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">        <span class="s2">&#34;&#34;&#34; an LSB header is scanned and converted to (almost)
</span></span></span><span class="line"><span class="cl"><span class="s2">            equivalent settings of a SystemD ini-style input &#34;&#34;&#34;</span>
</span></span><span class="line"><span class="cl">        <span class="n">initscript</span> <span class="o">=</span> <span class="kc">False</span>
</span></span><span class="line"><span class="cl">        <span class="n">initinfo</span> <span class="o">=</span> <span class="kc">False</span>
</span></span><span class="line"><span class="cl">        <span class="n">section</span> <span class="o">=</span> <span class="s2">&#34;GLOBAL&#34;</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isfile</span><span class="p">(</span><span class="n">filename</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">            <span class="bp">self</span><span class="o">.</span><span class="n">_files</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">filename</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">filename</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">            <span class="k">for</span> <span class="n">orig_line</span> <span class="ow">in</span> <span class="n">f</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">                <span class="n">line</span> <span class="o">=</span> <span class="n">orig_line</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">                <span class="k">if</span> <span class="n">line</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s2">&#34;#&#34;</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">                    <span class="k">if</span> <span class="s2">&#34; BEGIN INIT INFO&#34;</span> <span class="ow">in</span> <span class="n">line</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">                        <span class="n">initinfo</span> <span class="o">=</span> <span class="kc">True</span>
</span></span><span class="line"><span class="cl">                        <span class="n">section</span> <span class="o">=</span> <span class="s2">&#34;init.d&#34;</span>
</span></span><span class="line"><span class="cl">                    <span class="k">if</span> <span class="s2">&#34; END INIT INFO&#34;</span> <span class="ow">in</span> <span class="n">line</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">                        <span class="n">initinfo</span> <span class="o">=</span> <span class="kc">False</span>
</span></span><span class="line"><span class="cl">                    <span class="k">if</span> <span class="n">initinfo</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">                        <span class="n">m</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="k">match</span><span class="p">(</span><span class="sa">r</span><span class="s2">&#34;\S+\s*(\w[\w_-]*):(.*)&#34;</span><span class="p">,</span> <span class="n">line</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">                        <span class="k">if</span> <span class="n">m</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">                            <span class="n">key</span><span class="p">,</span> <span class="n">val</span> <span class="o">=</span> <span class="n">m</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">1</span><span class="p">),</span> <span class="n">m</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">                            <span class="bp">self</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="n">section</span><span class="p">,</span> <span class="n">key</span><span class="p">,</span> <span class="n">val</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">                    <span class="k">continue</span>
</span></span><span class="line"><span class="cl">        <span class="bp">self</span><span class="o">.</span><span class="n">systemd_sysv_generator</span><span class="p">(</span><span class="n">filename</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="bp">self</span>
</span></span><span class="line"><span class="cl">    <span class="k">def</span> <span class="nf">systemd_sysv_generator</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">filename</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">        <span class="s2">&#34;&#34;&#34; see systemd-sysv-generator(8) &#34;&#34;&#34;</span>
</span></span><span class="line"><span class="cl">        <span class="bp">self</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="n">Unit</span><span class="p">,</span> <span class="s2">&#34;SourcePath&#34;</span><span class="p">,</span> <span class="n">filename</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="n">description</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&#34;init.d&#34;</span><span class="p">,</span> <span class="s2">&#34;Description&#34;</span><span class="p">,</span> <span class="s2">&#34;&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="n">description</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">            <span class="bp">self</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="n">Unit</span><span class="p">,</span> <span class="s2">&#34;Description&#34;</span><span class="p">,</span> <span class="n">description</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="n">check</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&#34;init.d&#34;</span><span class="p">,</span> <span class="s2">&#34;Required-Start&#34;</span><span class="p">,</span> <span class="s2">&#34;&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="n">check</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">            <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">check</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&#34; &#34;</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">                <span class="k">if</span> <span class="n">item</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span> <span class="ow">in</span> <span class="n">_sysv_mappings</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">                    <span class="bp">self</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="n">Unit</span><span class="p">,</span> <span class="s2">&#34;Requires&#34;</span><span class="p">,</span> <span class="n">_sysv_mappings</span><span class="p">[</span><span class="n">item</span><span class="o">.</span><span class="n">strip</span><span class="p">()])</span>
</span></span><span class="line"><span class="cl">        <span class="n">provides</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&#34;init.d&#34;</span><span class="p">,</span> <span class="s2">&#34;Provides&#34;</span><span class="p">,</span> <span class="s2">&#34;&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="n">provides</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">            <span class="bp">self</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="n">Install</span><span class="p">,</span> <span class="s2">&#34;Alias&#34;</span><span class="p">,</span> <span class="n">provides</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="c1"># if already in multi-user.target then start it there.</span>
</span></span><span class="line"><span class="cl">        <span class="n">runlevels</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">getstr</span><span class="p">(</span><span class="s2">&#34;init.d&#34;</span><span class="p">,</span> <span class="s2">&#34;Default-Start&#34;</span><span class="p">,</span> <span class="s2">&#34;3 5&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">runlevels</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&#34; &#34;</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">            <span class="k">if</span> <span class="n">item</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span> <span class="ow">in</span> <span class="n">_runlevel_mappings</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">                <span class="bp">self</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="n">Install</span><span class="p">,</span> <span class="s2">&#34;WantedBy&#34;</span><span class="p">,</span> <span class="n">_runlevel_mappings</span><span class="p">[</span><span class="n">item</span><span class="o">.</span><span class="n">strip</span><span class="p">()])</span>
</span></span><span class="line"><span class="cl">        <span class="bp">self</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="n">Service</span><span class="p">,</span> <span class="s2">&#34;Restart&#34;</span><span class="p">,</span> <span class="s2">&#34;no&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="bp">self</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="n">Service</span><span class="p">,</span> <span class="s2">&#34;TimeoutSec&#34;</span><span class="p">,</span> <span class="n">strE</span><span class="p">(</span><span class="n">DefaultMaximumTimeout</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">        <span class="bp">self</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="n">Service</span><span class="p">,</span> <span class="s2">&#34;KillMode&#34;</span><span class="p">,</span> <span class="s2">&#34;process&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="bp">self</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="n">Service</span><span class="p">,</span> <span class="s2">&#34;GuessMainPID&#34;</span><span class="p">,</span> <span class="s2">&#34;no&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="c1"># self.set(Service, &#34;RemainAfterExit&#34;, &#34;yes&#34;)</span>
</span></span><span class="line"><span class="cl">        <span class="c1"># self.set(Service, &#34;SuccessExitStatus&#34;, &#34;5 6&#34;)</span>
</span></span><span class="line"><span class="cl">        <span class="bp">self</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="n">Service</span><span class="p">,</span> <span class="s2">&#34;ExecStart&#34;</span><span class="p">,</span> <span class="n">filename</span> <span class="o">+</span> <span class="s2">&#34; start&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="bp">self</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="n">Service</span><span class="p">,</span> <span class="s2">&#34;ExecStop&#34;</span><span class="p">,</span> <span class="n">filename</span> <span class="o">+</span> <span class="s2">&#34; stop&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="n">description</span><span class="p">:</span> <span class="c1"># LSB style initscript</span>
</span></span><span class="line"><span class="cl">            <span class="bp">self</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="n">Service</span><span class="p">,</span> <span class="s2">&#34;ExecReload&#34;</span><span class="p">,</span> <span class="n">filename</span> <span class="o">+</span> <span class="s2">&#34; reload&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="bp">self</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="n">Service</span><span class="p">,</span> <span class="s2">&#34;Type&#34;</span><span class="p">,</span> <span class="s2">&#34;forking&#34;</span><span class="p">)</span> <span class="c1"># not &#34;sysv&#34; anymore</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># UnitConfParser = ConfigParser.RawConfigParser</span>
</span></span><span class="line"><span class="cl"><span class="n">UnitConfParser</span> <span class="o">=</span> <span class="n">SystemctlConfigParser</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">class</span> <span class="nc">SystemctlSocket</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">conf</span><span class="p">,</span> <span class="n">sock</span><span class="p">,</span> <span class="n">skip</span> <span class="o">=</span> <span class="kc">False</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">        <span class="bp">self</span><span class="o">.</span><span class="n">conf</span> <span class="o">=</span> <span class="n">conf</span>
</span></span><span class="line"><span class="cl">        <span class="bp">self</span><span class="o">.</span><span class="n">sock</span> <span class="o">=</span> <span class="n">sock</span>
</span></span><span class="line"><span class="cl">        <span class="bp">self</span><span class="o">.</span><span class="n">skip</span> <span class="o">=</span> <span class="n">skip</span>
</span></span><span class="line"><span class="cl">    <span class="k">def</span> <span class="nf">fileno</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">sock</span><span class="o">.</span><span class="n">fileno</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">    <span class="k">def</span> <span class="nf">listen</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">backlog</span> <span class="o">=</span> <span class="kc">None</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="n">backlog</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">            <span class="n">backlog</span> <span class="o">=</span> <span class="n">DefaultListenBacklog</span>
</span></span><span class="line"><span class="cl">        <span class="n">dgram</span> <span class="o">=</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">sock</span><span class="o">.</span><span class="n">type</span> <span class="o">==</span> <span class="n">socket</span><span class="o">.</span><span class="n">SOCK_DGRAM</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="ow">not</span> <span class="n">dgram</span> <span class="ow">and</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">skip</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">            <span class="bp">self</span><span class="o">.</span><span class="n">sock</span><span class="o">.</span><span class="n">listen</span><span class="p">(</span><span class="n">backlog</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="k">def</span> <span class="nf">name</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">conf</span><span class="o">.</span><span class="n">name</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">    <span class="k">def</span> <span class="nf">addr</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">        <span class="n">stream</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">conf</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">Socket</span><span class="p">,</span> <span class="s2">&#34;ListenStream&#34;</span><span class="p">,</span> <span class="s2">&#34;&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="n">dgram</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">conf</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">Socket</span><span class="p">,</span> <span class="s2">&#34;ListenDatagram&#34;</span><span class="p">,</span> <span class="s2">&#34;&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="n">stream</span> <span class="ow">or</span> <span class="n">dgram</span>
</span></span><span class="line"><span class="cl">    <span class="k">def</span> <span class="nf">close</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">        <span class="bp">self</span><span class="o">.</span><span class="n">sock</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">class</span> <span class="nc">SystemctlConf</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">    <span class="c1"># |</span>
</span></span><span class="line"><span class="cl">    <span class="c1"># |</span>
</span></span><span class="line"><span class="cl">    <span class="c1"># |</span>
</span></span><span class="line"><span class="cl">    <span class="c1"># |</span>
</span></span><span class="line"><span class="cl">    <span class="c1"># |</span>
</span></span><span class="line"><span class="cl">    <span class="c1"># |</span>
</span></span><span class="line"><span class="cl">    <span class="c1"># |</span>
</span></span><span class="line"><span class="cl">    <span class="c1"># |</span>
</span></span><span class="line"><span class="cl">    <span class="c1"># |</span>
</span></span><span class="line"><span class="cl">    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">data</span><span class="p">,</span> <span class="n">module</span> <span class="o">=</span> <span class="kc">None</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">        <span class="bp">self</span><span class="o">.</span><span class="n">data</span> <span class="o">=</span> <span class="n">data</span> <span class="c1"># UnitConfParser</span>
</span></span><span class="line"><span class="cl">        <span class="bp">self</span><span class="o">.</span><span class="n">env</span> <span class="o">=</span> <span class="p">{}</span>
</span></span><span class="line"><span class="cl">        <span class="bp">self</span><span class="o">.</span><span class="n">status</span> <span class="o">=</span> <span class="kc">None</span>
</span></span><span class="line"><span class="cl">        <span class="bp">self</span><span class="o">.</span><span class="n">masked</span> <span class="o">=</span> <span class="kc">None</span>
</span></span><span class="line"><span class="cl">        <span class="bp">self</span><span class="o">.</span><span class="n">module</span> <span class="o">=</span> <span class="n">module</span>
</span></span><span class="line"><span class="cl">        <span class="bp">self</span><span class="o">.</span><span class="n">nonloaded_path</span> <span class="o">=</span> <span class="s2">&#34;&#34;</span>
</span></span><span class="line"><span class="cl">        <span class="bp">self</span><span class="o">.</span><span class="n">drop_in_files</span> <span class="o">=</span> <span class="p">{}</span>
</span></span><span class="line"><span class="cl">        <span class="bp">self</span><span class="o">.</span><span class="n">_root</span> <span class="o">=</span> <span class="n">_root</span>
</span></span><span class="line"><span class="cl">        <span class="bp">self</span><span class="o">.</span><span class="n">_user_mode</span> <span class="o">=</span> <span class="n">_user_mode</span>
</span></span><span class="line"><span class="cl">    <span class="k">def</span> <span class="nf">root_mode</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_user_mode</span>
</span></span><span class="line"><span class="cl">    <span class="k">def</span> <span class="nf">loaded</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">        <span class="n">files</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">filenames</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">masked</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">            <span class="k">return</span> <span class="s2">&#34;masked&#34;</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">files</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">            <span class="k">return</span> <span class="s2">&#34;loaded&#34;</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="s2">&#34;&#34;</span>
</span></span><span class="line"><span class="cl">    <span class="k">def</span> <span class="nf">filename</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">        <span class="s2">&#34;&#34;&#34; returns the last filename that was parsed &#34;&#34;&#34;</span>
</span></span><span class="line"><span class="cl">        <span class="n">files</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">filenames</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="n">files</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">            <span class="k">return</span> <span class="n">files</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="kc">None</span>
</span></span><span class="line"><span class="cl">    <span class="k">def</span> <span class="nf">overrides</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">        <span class="s2">&#34;&#34;&#34; drop-in files are loaded alphabetically by name, not by full path &#34;&#34;&#34;</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">drop_in_files</span><span class="p">[</span><span class="n">name</span><span class="p">]</span> <span class="k">for</span> <span class="n">name</span> <span class="ow">in</span> <span class="nb">sorted</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">drop_in_files</span><span class="p">)]</span>
</span></span><span class="line"><span class="cl">    <span class="k">def</span> <span class="nf">name</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">        <span class="s2">&#34;&#34;&#34; the unit id or defaults to the file name &#34;&#34;&#34;</span>
</span></span><span class="line"><span class="cl">        <span class="n">name</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">module</span> <span class="ow">or</span> <span class="s2">&#34;&#34;</span>
</span></span><span class="line"><span class="cl">        <span class="n">filename</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">filename</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="n">filename</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">            <span class="n">name</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">basename</span><span class="p">(</span><span class="n">filename</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">module</span> <span class="ow">or</span> <span class="n">name</span>
</span></span><span class="line"><span class="cl">    <span class="k">def</span> <span class="nf">set</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">section</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="n">section</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">value</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="k">def</span> <span class="nf">get</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">section</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">default</span><span class="p">,</span> <span class="n">allow_no_value</span> <span class="o">=</span> <span class="kc">False</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">getstr</span><span class="p">(</span><span class="n">section</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">default</span><span class="p">,</span> <span class="n">allow_no_value</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="k">def</span> <span class="nf">getlist</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">section</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">default</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">allow_no_value</span> <span class="o">=</span> <span class="kc">False</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">getlist</span><span class="p">(</span><span class="n">section</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">default</span> <span class="ow">or</span> <span class="p">[],</span> <span class="n">allow_no_value</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="k">def</span> <span class="nf">getbool</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">section</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">default</span> <span class="o">=</span> <span class="kc">None</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">        <span class="n">value</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">section</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">default</span> <span class="ow">or</span> <span class="s2">&#34;no&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="n">value</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">            <span class="k">if</span> <span class="n">value</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="ow">in</span> <span class="s2">&#34;TtYy123456789&#34;</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">                <span class="k">return</span> <span class="kc">True</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="kc">False</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">class</span> <span class="nc">PresetFile</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">    <span class="c1"># |</span>
</span></span><span class="line"><span class="cl">    <span class="c1"># |</span>
</span></span><span class="line"><span class="cl">    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">        <span class="bp">self</span><span class="o">.</span><span class="n">_files</span> <span class="o">=</span> <span class="p">[]</span>
</span></span><span class="line"><span class="cl">        <span class="bp">self</span><span class="o">.</span><span class="n">_lines</span> <span class="o">=</span> <span class="p">[]</span>
</span></span><span class="line"><span class="cl">    <span class="k">def</span> <span class="nf">filename</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">        <span class="s2">&#34;&#34;&#34; returns the last filename that was parsed &#34;&#34;&#34;</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_files</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_files</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="kc">None</span>
</span></span><span class="line"><span class="cl">    <span class="k">def</span> <span class="nf">read</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">filename</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">        <span class="bp">self</span><span class="o">.</span><span class="n">_files</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">filename</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">filename</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">            <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">f</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">                <span class="bp">self</span><span class="o">.</span><span class="n">_lines</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">line</span><span class="o">.</span><span class="n">strip</span><span class="p">())</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="bp">self</span>
</span></span><span class="line"><span class="cl">    <span class="k">def</span> <span class="nf">get_preset</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">unit</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">        <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_lines</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">            <span class="n">m</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="k">match</span><span class="p">(</span><span class="sa">r</span><span class="s2">&#34;(enable|disable)\s+(\S+)&#34;</span><span class="p">,</span> <span class="n">line</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">            <span class="k">if</span> <span class="n">m</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">                <span class="n">status</span><span class="p">,</span> <span class="n">pattern</span> <span class="o">=</span> <span class="n">m</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">1</span><span class="p">),</span> <span class="n">m</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">                <span class="k">if</span> <span class="n">fnmatch</span><span class="o">.</span><span class="n">fnmatchcase</span><span class="p">(</span><span class="n">unit</span><span class="p">,</span> <span class="n">pattern</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">                    <span class="n">logg</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&#34;</span><span class="si">%s</span><span class="s2"> </span><span class="si">%s</span><span class="s2"> =&gt; </span><span class="si">%s</span><span class="s2"> </span><span class="si">%s</span><span class="s2">&#34;</span><span class="p">,</span> <span class="n">status</span><span class="p">,</span> <span class="n">pattern</span><span class="p">,</span> <span class="n">unit</span><span class="p">,</span> <span class="n">strQ</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">filename</span><span class="p">()))</span>
</span></span><span class="line"><span class="cl">                    <span class="k">return</span> <span class="n">status</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="kc">None</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1">## with waitlock(conf): self.start()</span>
</span></span><span class="line"><span class="cl"><span class="k">class</span> <span class="nc">waitlock</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">    <span class="c1"># |</span>
</span></span><span class="line"><span class="cl">    <span class="c1"># |</span>
</span></span><span class="line"><span class="cl">    <span class="c1"># |</span>
</span></span><span class="line"><span class="cl">    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">conf</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">        <span class="bp">self</span><span class="o">.</span><span class="n">conf</span> <span class="o">=</span> <span class="n">conf</span> <span class="c1"># currently unused</span>
</span></span><span class="line"><span class="cl">        <span class="bp">self</span><span class="o">.</span><span class="n">opened</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span>
</span></span><span class="line"><span class="cl">        <span class="bp">self</span><span class="o">.</span><span class="n">lockfolder</span> <span class="o">=</span> <span class="n">expand_path</span><span class="p">(</span><span class="n">_notify_socket_folder</span><span class="p">,</span> <span class="n">conf</span><span class="o">.</span><span class="n">root_mode</span><span class="p">())</span>
</span></span><span class="line"><span class="cl">        <span class="k">try</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">            <span class="n">folder</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">lockfolder</span>
</span></span><span class="line"><span class="cl">            <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isdir</span><span class="p">(</span><span class="n">folder</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">                <span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="n">folder</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">            <span class="n">logg</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&#34;oops, </span><span class="si">%s</span><span class="s2">&#34;</span><span class="p">,</span> <span class="n">e</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="k">def</span> <span class="nf">lockfile</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">        <span class="n">unit</span> <span class="o">=</span> <span class="s2">&#34;&#34;</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">conf</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">            <span class="n">unit</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">conf</span><span class="o">.</span><span class="n">name</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">lockfolder</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">unit</span> <span class="ow">or</span> <span class="s2">&#34;global&#34;</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&#34;.lock&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="k">def</span> <span class="fm">__enter__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">        <span class="k">try</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">            <span class="n">lockfile</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">lockfile</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">            <span class="n">lockname</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">basename</span><span class="p">(</span><span class="n">lockfile</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">            <span class="bp">self</span><span class="o">.</span><span class="n">opened</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">lockfile</span><span class="p">,</span> <span class="n">os</span><span class="o">.</span><span class="n">O_RDWR</span> <span class="o">|</span> <span class="n">os</span><span class="o">.</span><span class="n">O_CREAT</span><span class="p">,</span> <span class="mo">0o600</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">            <span class="k">for</span> <span class="n">attempt</span> <span class="ow">in</span> <span class="n">xrange</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">MaxLockWait</span> <span class="ow">or</span> <span class="n">DefaultMaximumTimeout</span><span class="p">)):</span>
</span></span><span class="line"><span class="cl">                <span class="k">try</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">                    <span class="n">logg_debug_flock</span><span class="p">(</span><span class="s2">&#34;[</span><span class="si">%s</span><span class="s2">] </span><span class="si">%s</span><span class="s2">. trying </span><span class="si">%s</span><span class="s2"> _______ &#34;</span><span class="p">,</span> <span class="n">os</span><span class="o">.</span><span class="n">getpid</span><span class="p">(),</span> <span class="n">attempt</span><span class="p">,</span> <span class="n">lockname</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">                    <span class="n">fcntl</span><span class="o">.</span><span class="n">flock</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">opened</span><span class="p">,</span> <span class="n">fcntl</span><span class="o">.</span><span class="n">LOCK_EX</span> <span class="o">|</span> <span class="n">fcntl</span><span class="o">.</span><span class="n">LOCK_NB</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">                    <span class="n">st</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">fstat</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">opened</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">                    <span class="k">if</span> <span class="ow">not</span> <span class="n">st</span><span class="o">.</span><span class="n">st_nlink</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">                        <span class="n">logg_debug_flock</span><span class="p">(</span><span class="s2">&#34;[</span><span class="si">%s</span><span class="s2">] </span><span class="si">%s</span><span class="s2">. </span><span class="si">%s</span><span class="s2"> got deleted, trying again&#34;</span><span class="p">,</span> <span class="n">os</span><span class="o">.</span><span class="n">getpid</span><span class="p">(),</span> <span class="n">attempt</span><span class="p">,</span> <span class="n">lockname</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">                        <span class="n">os</span><span class="o">.</span><span class="n">close</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">opened</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">                        <span class="bp">self</span><span class="o">.</span><span class="n">opened</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">lockfile</span><span class="p">,</span> <span class="n">os</span><span class="o">.</span><span class="n">O_RDWR</span> <span class="o">|</span> <span class="n">os</span><span class="o">.</span><span class="n">O_CREAT</span><span class="p">,</span> <span class="mo">0o600</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">                        <span class="k">continue</span>
</span></span><span class="line"><span class="cl">                    <span class="n">content</span> <span class="o">=</span> <span class="s2">&#34;{ &#39;systemctl&#39;: </span><span class="si">%s</span><span class="s2">, &#39;lock&#39;: &#39;</span><span class="si">%s</span><span class="s2">&#39; }</span><span class="se">\n</span><span class="s2">&#34;</span> <span class="o">%</span> <span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">getpid</span><span class="p">(),</span> <span class="n">lockname</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">                    <span class="n">os</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">opened</span><span class="p">,</span> <span class="n">content</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="s2">&#34;utf-8&#34;</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">                    <span class="n">logg_debug_flock</span><span class="p">(</span><span class="s2">&#34;[</span><span class="si">%s</span><span class="s2">] </span><span class="si">%s</span><span class="s2">. holding lock on </span><span class="si">%s</span><span class="s2">&#34;</span><span class="p">,</span> <span class="n">os</span><span class="o">.</span><span class="n">getpid</span><span class="p">(),</span> <span class="n">attempt</span><span class="p">,</span> <span class="n">lockname</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">                    <span class="k">return</span> <span class="kc">True</span>
</span></span><span class="line"><span class="cl">                <span class="k">except</span> <span class="ne">IOError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">                    <span class="n">whom</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">opened</span><span class="p">,</span> <span class="mi">4096</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">                    <span class="n">os</span><span class="o">.</span><span class="n">lseek</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">opened</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">os</span><span class="o">.</span><span class="n">SEEK_SET</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">                    <span class="n">logg</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&#34;[</span><span class="si">%s</span><span class="s2">] </span><span class="si">%s</span><span class="s2">. systemctl locked by </span><span class="si">%s</span><span class="s2">&#34;</span><span class="p">,</span> <span class="n">os</span><span class="o">.</span><span class="n">getpid</span><span class="p">(),</span> <span class="n">attempt</span><span class="p">,</span> <span class="n">whom</span><span class="o">.</span><span class="n">rstrip</span><span class="p">())</span>
</span></span><span class="line"><span class="cl">                    <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="c1"># until MaxLockWait</span>
</span></span><span class="line"><span class="cl">                    <span class="k">continue</span>
</span></span><span class="line"><span class="cl">            <span class="n">logg</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&#34;[</span><span class="si">%s</span><span class="s2">] not able to get the lock to </span><span class="si">%s</span><span class="s2">&#34;</span><span class="p">,</span> <span class="n">os</span><span class="o">.</span><span class="n">getpid</span><span class="p">(),</span> <span class="n">lockname</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">            <span class="n">logg</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&#34;[</span><span class="si">%s</span><span class="s2">] oops </span><span class="si">%s</span><span class="s2">, </span><span class="si">%s</span><span class="s2">&#34;</span><span class="p">,</span> <span class="n">os</span><span class="o">.</span><span class="n">getpid</span><span class="p">(),</span> <span class="nb">str</span><span class="p">(</span><span class="nb">type</span><span class="p">(</span><span class="n">e</span><span class="p">)),</span> <span class="n">e</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="c1"># TODO# raise Exception(&#34;no lock for %s&#34;, self.unit or &#34;global&#34;)</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="kc">False</span>
</span></span><span class="line"><span class="cl">    <span class="k">def</span> <span class="fm">__exit__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="nb">type</span><span class="p">,</span> <span class="n">value</span><span class="p">,</span> <span class="n">traceback</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">        <span class="k">try</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">            <span class="n">os</span><span class="o">.</span><span class="n">lseek</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">opened</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">os</span><span class="o">.</span><span class="n">SEEK_SET</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">            <span class="n">os</span><span class="o">.</span><span class="n">ftruncate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">opened</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">            <span class="k">if</span> <span class="n">REMOVE_LOCK_FILE</span><span class="p">:</span> <span class="c1"># an optional implementation</span>
</span></span><span class="line"><span class="cl">                <span class="n">lockfile</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">lockfile</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">                <span class="n">lockname</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">basename</span><span class="p">(</span><span class="n">lockfile</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">                <span class="n">os</span><span class="o">.</span><span class="n">unlink</span><span class="p">(</span><span class="n">lockfile</span><span class="p">)</span> <span class="c1"># ino is kept allocated because opened by this process</span>
</span></span><span class="line"><span class="cl">                <span class="n">logg</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&#34;[</span><span class="si">%s</span><span class="s2">] lockfile removed for </span><span class="si">%s</span><span class="s2">&#34;</span><span class="p">,</span> <span class="n">os</span><span class="o">.</span><span class="n">getpid</span><span class="p">(),</span> <span class="n">lockname</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">            <span class="n">fcntl</span><span class="o">.</span><span class="n">flock</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">opened</span><span class="p">,</span> <span class="n">fcntl</span><span class="o">.</span><span class="n">LOCK_UN</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">            <span class="n">os</span><span class="o">.</span><span class="n">close</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">opened</span><span class="p">)</span> <span class="c1"># implies an unlock but that has happend like 6 seconds later</span>
</span></span><span class="line"><span class="cl">            <span class="bp">self</span><span class="o">.</span><span class="n">opened</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span>
</span></span><span class="line"><span class="cl">        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">            <span class="n">logg</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&#34;oops, </span><span class="si">%s</span><span class="s2">&#34;</span><span class="p">,</span> <span class="n">e</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">SystemctlWaitPID</span> <span class="o">=</span> <span class="n">collections</span><span class="o">.</span><span class="n">namedtuple</span><span class="p">(</span><span class="s2">&#34;SystemctlWaitPID&#34;</span><span class="p">,</span> <span class="p">[</span><span class="s2">&#34;pid&#34;</span><span class="p">,</span> <span class="s2">&#34;returncode&#34;</span><span class="p">,</span> <span class="s2">&#34;signal&#34;</span><span class="p">])</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">def</span> <span class="nf">must_have_failed</span><span class="p">(</span><span class="n">waitpid</span><span class="p">,</span> <span class="n">cmd</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">    <span class="c1"># found to be needed on ubuntu:16.04 to match test result from ubuntu:18.04 and other distros</span>
</span></span><span class="line"><span class="cl">    <span class="c1"># .... I have tracked it down that python&#39;s os.waitpid() returns an exitcode==0 even when the</span>
</span></span><span class="line"><span class="cl">    <span class="c1"># .... underlying process has actually failed with an exitcode&lt;&gt;0. It is unknown where that</span>
</span></span><span class="line"><span class="cl">    <span class="c1"># .... bug comes from but it seems a bit serious to trash some very basic unix functionality.</span>
</span></span><span class="line"><span class="cl">    <span class="c1"># .... Essentially a parent process does not get the correct exitcode from its own children.</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="n">cmd</span> <span class="ow">and</span> <span class="n">cmd</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&#34;/bin/kill&#34;</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">        <span class="n">pid</span> <span class="o">=</span> <span class="kc">None</span>
</span></span><span class="line"><span class="cl">        <span class="k">for</span> <span class="n">arg</span> <span class="ow">in</span> <span class="n">cmd</span><span class="p">[</span><span class="mi">1</span><span class="p">:]:</span>
</span></span><span class="line"><span class="cl">            <span class="k">if</span> <span class="ow">not</span> <span class="n">arg</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s2">&#34;-&#34;</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">                <span class="n">pid</span> <span class="o">=</span> <span class="n">arg</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="n">pid</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span> <span class="c1"># unknown $MAINPID</span>
</span></span><span class="line"><span class="cl">            <span class="k">if</span> <span class="ow">not</span> <span class="n">waitpid</span><span class="o">.</span><span class="n">returncode</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">                <span class="n">logg</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&#34;waitpid </span><span class="si">%s</span><span class="s2"> did return </span><span class="si">%s</span><span class="s2"> =&gt; correcting as 11&#34;</span><span class="p">,</span> <span class="n">cmd</span><span class="p">,</span> <span class="n">waitpid</span><span class="o">.</span><span class="n">returncode</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">            <span class="n">waitpid</span> <span class="o">=</span> <span class="n">SystemctlWaitPID</span><span class="p">(</span><span class="n">waitpid</span><span class="o">.</span><span class="n">pid</span><span class="p">,</span> <span class="mi">11</span><span class="p">,</span> <span class="n">waitpid</span><span class="o">.</span><span class="n">signal</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="n">waitpid</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">def</span> <span class="nf">subprocess_waitpid</span><span class="p">(</span><span class="n">pid</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">    <span class="n">run_pid</span><span class="p">,</span> <span class="n">run_stat</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">waitpid</span><span class="p">(</span><span class="n">pid</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="n">SystemctlWaitPID</span><span class="p">(</span><span class="n">run_pid</span><span class="p">,</span> <span class="n">os</span><span class="o">.</span><span class="n">WEXITSTATUS</span><span class="p">(</span><span class="n">run_stat</span><span class="p">),</span> <span class="n">os</span><span class="o">.</span><span class="n">WTERMSIG</span><span class="p">(</span><span class="n">run_stat</span><span class="p">))</span>
</span></span><span class="line"><span class="cl"><span class="k">def</span> <span class="nf">subprocess_testpid</span><span class="p">(</span><span class="n">pid</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">    <span class="n">run_pid</span><span class="p">,</span> <span class="n">run_stat</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">waitpid</span><span class="p">(</span><span class="n">pid</span><span class="p">,</span> <span class="n">os</span><span class="o">.</span><span class="n">WNOHANG</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="n">run_pid</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="n">SystemctlWaitPID</span><span class="p">(</span><span class="n">run_pid</span><span class="p">,</span> <span class="n">os</span><span class="o">.</span><span class="n">WEXITSTATUS</span><span class="p">(</span><span class="n">run_stat</span><span class="p">),</span> <span class="n">os</span><span class="o">.</span><span class="n">WTERMSIG</span><span class="p">(</span><span class="n">run_stat</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">    <span class="k">else</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="n">SystemctlWaitPID</span><span class="p">(</span><span class="n">pid</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">SystemctlUnitName</span> <span class="o">=</span> <span class="n">collections</span><span class="o">.</span><span class="n">namedtuple</span><span class="p">(</span><span class="s2">&#34;SystemctlUnitName&#34;</span><span class="p">,</span> <span class="p">[</span><span class="s2">&#34;fullname&#34;</span><span class="p">,</span> <span class="s2">&#34;name&#34;</span><span class="p">,</span> <span class="s2">&#34;prefix&#34;</span><span class="p">,</span> <span class="s2">&#34;instance&#34;</span><span class="p">,</span> <span class="s2">&#34;suffix&#34;</span><span class="p">,</span> <span class="s2">&#34;component&#34;</span><span class="p">])</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">def</span> <span class="nf">parse_unit</span><span class="p">(</span><span class="n">fullname</span><span class="p">):</span> <span class="c1"># -&gt; object(prefix, instance, suffix, ...., name, component)</span>
</span></span><span class="line"><span class="cl">    <span class="n">name</span><span class="p">,</span> <span class="n">suffix</span> <span class="o">=</span> <span class="n">fullname</span><span class="p">,</span> <span class="s2">&#34;&#34;</span>
</span></span><span class="line"><span class="cl">    <span class="n">has_suffix</span> <span class="o">=</span> <span class="n">fullname</span><span class="o">.</span><span class="n">rfind</span><span class="p">(</span><span class="s2">&#34;.&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="n">has_suffix</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">        <span class="n">name</span> <span class="o">=</span> <span class="n">fullname</span><span class="p">[:</span><span class="n">has_suffix</span><span class="p">]</span>
</span></span><span class="line"><span class="cl">        <span class="n">suffix</span> <span class="o">=</span> <span class="n">fullname</span><span class="p">[</span><span class="n">has_suffix</span><span class="o">+</span><span class="mi">1</span><span class="p">:]</span>
</span></span><span class="line"><span class="cl">    <span class="n">prefix</span><span class="p">,</span> <span class="n">instance</span> <span class="o">=</span> <span class="n">name</span><span class="p">,</span> <span class="s2">&#34;&#34;</span>
</span></span><span class="line"><span class="cl">    <span class="n">has_instance</span> <span class="o">=</span> <span class="n">name</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="s2">&#34;@&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="n">has_instance</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">        <span class="n">prefix</span> <span class="o">=</span> <span class="n">name</span><span class="p">[:</span><span class="n">has_instance</span><span class="p">]</span>
</span></span><span class="line"><span class="cl">        <span class="n">instance</span> <span class="o">=</span> <span class="n">name</span><span class="p">[</span><span class="n">has_instance</span><span class="o">+</span><span class="mi">1</span><span class="p">:]</span>
</span></span><span class="line"><span class="cl">    <span class="n">component</span> <span class="o">=</span> <span class="s2">&#34;&#34;</span>
</span></span><span class="line"><span class="cl">    <span class="n">has_component</span> <span class="o">=</span> <span class="n">prefix</span><span class="o">.</span><span class="n">rfind</span><span class="p">(</span><span class="s2">&#34;-&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="n">has_component</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">        <span class="n">component</span> <span class="o">=</span> <span class="n">prefix</span><span class="p">[</span><span class="n">has_component</span><span class="o">+</span><span class="mi">1</span><span class="p">:]</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="n">SystemctlUnitName</span><span class="p">(</span><span class="n">fullname</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">prefix</span><span class="p">,</span> <span class="n">instance</span><span class="p">,</span> <span class="n">suffix</span><span class="p">,</span> <span class="n">component</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">def</span> <span class="nf">time_to_seconds</span><span class="p">(</span><span class="n">text</span><span class="p">,</span> <span class="n">maximum</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">    <span class="n">value</span> <span class="o">=</span> <span class="mf">0.</span>
</span></span><span class="line"><span class="cl">    <span class="k">for</span> <span class="n">part</span> <span class="ow">in</span> <span class="nb">str</span><span class="p">(</span><span class="n">text</span><span class="p">)</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&#34; &#34;</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">        <span class="n">item</span> <span class="o">=</span> <span class="n">part</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="n">item</span> <span class="o">==</span> <span class="s2">&#34;infinity&#34;</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">            <span class="k">return</span> <span class="n">maximum</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="n">item</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s2">&#34;m&#34;</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">            <span class="k">try</span><span class="p">:</span> <span class="n">value</span> <span class="o">+=</span> <span class="mi">60</span> <span class="o">*</span> <span class="nb">int</span><span class="p">(</span><span class="n">item</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>
</span></span><span class="line"><span class="cl">            <span class="k">except</span><span class="p">:</span> <span class="k">pass</span> <span class="c1"># pragma: no cover</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="n">item</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s2">&#34;min&#34;</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">            <span class="k">try</span><span class="p">:</span> <span class="n">value</span> <span class="o">+=</span> <span class="mi">60</span> <span class="o">*</span> <span class="nb">int</span><span class="p">(</span><span class="n">item</span><span class="p">[:</span><span class="o">-</span><span class="mi">3</span><span class="p">])</span>
</span></span><span class="line"><span class="cl">            <span class="k">except</span><span class="p">:</span> <span class="k">pass</span> <span class="c1"># pragma: no cover</span>
</span></span><span class="line"><span class="cl">        <span class="k">elif</span> <span class="n">item</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s2">&#34;ms&#34;</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">            <span class="k">try</span><span class="p">:</span> <span class="n">value</span> <span class="o">+=</span> <span class="nb">int</span><span class="p">(</span><span class="n">item</span><span class="p">[:</span><span class="o">-</span><span class="mi">2</span><span class="p">])</span> <span class="o">/</span> <span class="mf">1000.</span>
</span></span><span class="line"><span class="cl">            <span class="k">except</span><span class="p">:</span> <span class="k">pass</span> <span class="c1"># pragma: no cover</span>
</span></span><span class="line"><span class="cl">        <span class="k">elif</span> <span class="n">item</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s2">&#34;s&#34;</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">            <span class="k">try</span><span class="p">:</span> <span class="n">value</span> <span class="o">+=</span> <span class="nb">int</span><span class="p">(</span><span class="n">item</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>
</span></span><span class="line"><span class="cl">            <span class="k">except</span><span class="p">:</span> <span class="k">pass</span> <span class="c1"># pragma: no cover</span>
</span></span><span class="line"><span class="cl">        <span class="k">elif</span> <span class="n">item</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">            <span class="k">try</span><span class="p">:</span> <span class="n">value</span> <span class="o">+=</span> <span class="nb">int</span><span class="p">(</span><span class="n">item</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">            <span class="k">except</span><span class="p">:</span> <span class="k">pass</span> <span class="c1"># pragma: no cover</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="n">value</span> <span class="o">&gt;</span> <span class="n">maximum</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="n">maximum</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="ow">not</span> <span class="n">value</span> <span class="ow">and</span> <span class="n">text</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span> <span class="o">==</span> <span class="s2">&#34;0&#34;</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="mf">0.</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="ow">not</span> <span class="n">value</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="mf">1.</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="n">value</span>
</span></span><span class="line"><span class="cl"><span class="k">def</span> <span class="nf">seconds_to_time</span><span class="p">(</span><span class="n">seconds</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">    <span class="n">seconds</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">seconds</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="n">mins</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">seconds</span><span class="p">)</span> <span class="o">/</span> <span class="mi">60</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="n">secs</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">seconds</span><span class="p">)</span> <span class="o">-</span> <span class="p">(</span><span class="n">mins</span> <span class="o">*</span> <span class="mi">60</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">    <span class="n">msecs</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">seconds</span> <span class="o">*</span> <span class="mi">1000</span><span class="p">)</span> <span class="o">-</span> <span class="p">(</span><span class="n">secs</span> <span class="o">*</span> <span class="mi">1000</span> <span class="o">+</span> <span class="n">mins</span> <span class="o">*</span> <span class="mi">60000</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="n">mins</span> <span class="ow">and</span> <span class="n">secs</span> <span class="ow">and</span> <span class="n">msecs</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="s2">&#34;</span><span class="si">%s</span><span class="s2">min </span><span class="si">%s</span><span class="s2">s </span><span class="si">%s</span><span class="s2">ms&#34;</span> <span class="o">%</span> <span class="p">(</span><span class="n">mins</span><span class="p">,</span> <span class="n">secs</span><span class="p">,</span> <span class="n">msecs</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="k">elif</span> <span class="n">mins</span> <span class="ow">and</span> <span class="n">secs</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="s2">&#34;</span><span class="si">%s</span><span class="s2">min </span><span class="si">%s</span><span class="s2">s&#34;</span> <span class="o">%</span> <span class="p">(</span><span class="n">mins</span><span class="p">,</span> <span class="n">secs</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="k">elif</span> <span class="n">secs</span> <span class="ow">and</span> <span class="n">msecs</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="s2">&#34;</span><span class="si">%s</span><span class="s2">s </span><span class="si">%s</span><span class="s2">ms&#34;</span> <span class="o">%</span> <span class="p">(</span><span class="n">secs</span><span class="p">,</span> <span class="n">msecs</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="k">elif</span> <span class="n">mins</span> <span class="ow">and</span> <span class="n">msecs</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="s2">&#34;</span><span class="si">%s</span><span class="s2">min </span><span class="si">%s</span><span class="s2">ms&#34;</span> <span class="o">%</span> <span class="p">(</span><span class="n">mins</span><span class="p">,</span> <span class="n">msecs</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="k">elif</span> <span class="n">mins</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="s2">&#34;</span><span class="si">%s</span><span class="s2">min&#34;</span> <span class="o">%</span> <span class="p">(</span><span class="n">mins</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="k">else</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="s2">&#34;</span><span class="si">%s</span><span class="s2">s&#34;</span> <span class="o">%</span> <span class="p">(</span><span class="n">secs</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">def</span> <span class="nf">getBefore</span><span class="p">(</span><span class="n">conf</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">    <span class="n">result</span> <span class="o">=</span> <span class="p">[]</span>
</span></span><span class="line"><span class="cl">    <span class="n">beforelist</span> <span class="o">=</span> <span class="n">conf</span><span class="o">.</span><span class="n">getlist</span><span class="p">(</span><span class="n">Unit</span><span class="p">,</span> <span class="s2">&#34;Before&#34;</span><span class="p">,</span> <span class="p">[])</span>
</span></span><span class="line"><span class="cl">    <span class="k">for</span> <span class="n">befores</span> <span class="ow">in</span> <span class="n">beforelist</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">        <span class="k">for</span> <span class="n">before</span> <span class="ow">in</span> <span class="n">befores</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&#34; &#34;</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">            <span class="n">name</span> <span class="o">=</span> <span class="n">before</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">            <span class="k">if</span> <span class="n">name</span> <span class="ow">and</span> <span class="n">name</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">result</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">                <span class="n">result</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">name</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="n">result</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">def</span> <span class="nf">getAfter</span><span class="p">(</span><span class="n">conf</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">    <span class="n">result</span> <span class="o">=</span> <span class="p">[]</span>
</span></span><span class="line"><span class="cl">    <span class="n">afterlist</span> <span class="o">=</span> <span class="n">conf</span><span class="o">.</span><span class="n">getlist</span><span class="p">(</span><span class="n">Unit</span><span class="p">,</span> <span class="s2">&#34;After&#34;</span><span class="p">,</span> <span class="p">[])</span>
</span></span><span class="line"><span class="cl">    <span class="k">for</span> <span class="n">afters</span> <span class="ow">in</span> <span class="n">afterlist</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">        <span class="k">for</span> <span class="n">after</span> <span class="ow">in</span> <span class="n">afters</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&#34; &#34;</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">            <span class="n">name</span> <span class="o">=</span> <span class="n">after</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">            <span class="k">if</span> <span class="n">name</span> <span class="ow">and</span> <span class="n">name</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">result</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">                <span class="n">result</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">name</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="n">result</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">def</span> <span class="nf">compareAfter</span><span class="p">(</span><span class="n">confA</span><span class="p">,</span> <span class="n">confB</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">    <span class="n">idA</span> <span class="o">=</span> <span class="n">confA</span><span class="o">.</span><span class="n">name</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">    <span class="n">idB</span> <span class="o">=</span> <span class="n">confB</span><span class="o">.</span><span class="n">name</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">    <span class="k">for</span> <span class="n">after</span> <span class="ow">in</span> <span class="n">getAfter</span><span class="p">(</span><span class="n">confA</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="n">after</span> <span class="o">==</span> <span class="n">idB</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">            <span class="n">logg</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&#34;</span><span class="si">%s</span><span class="s2"> After </span><span class="si">%s</span><span class="s2">&#34;</span><span class="p">,</span> <span class="n">idA</span><span class="p">,</span> <span class="n">idB</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">            <span class="k">return</span> <span class="o">-</span><span class="mi">1</span>
</span></span><span class="line"><span class="cl">    <span class="k">for</span> <span class="n">after</span> <span class="ow">in</span> <span class="n">getAfter</span><span class="p">(</span><span class="n">confB</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="n">after</span> <span class="o">==</span> <span class="n">idA</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">            <span class="n">logg</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&#34;</span><span class="si">%s</span><span class="s2"> After </span><span class="si">%s</span><span class="s2">&#34;</span><span class="p">,</span> <span class="n">idB</span><span class="p">,</span> <span class="n">idA</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">            <span class="k">return</span> <span class="mi">1</span>
</span></span><span class="line"><span class="cl">    <span class="k">for</span> <span class="n">before</span> <span class="ow">in</span> <span class="n">getBefore</span><span class="p">(</span><span class="n">confA</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="n">before</span> <span class="o">==</span> <span class="n">idB</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">            <span class="n">logg</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&#34;</span><span class="si">%s</span><span class="s2"> Before </span><span class="si">%s</span><span class="s2">&#34;</span><span class="p">,</span> <span class="n">idA</span><span class="p">,</span> <span class="n">idB</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">            <span class="k">return</span> <span class="mi">1</span>
</span></span><span class="line"><span class="cl">    <span class="k">for</span> <span class="n">before</span> <span class="ow">in</span> <span class="n">getBefore</span><span class="p">(</span><span class="n">confB</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="n">before</span> <span class="o">==</span> <span class="n">idA</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">            <span class="n">logg</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&#34;</span><span class="si">%s</span><span class="s2"> Before </span><span class="si">%s</span><span class="s2">&#34;</span><span class="p">,</span> <span class="n">idB</span><span class="p">,</span> <span class="n">idA</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">            <span class="k">return</span> <span class="o">-</span><span class="mi">1</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="mi">0</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">def</span> <span class="nf">conf_sortedAfter</span><span class="p">(</span><span class="n">conflist</span><span class="p">,</span> <span class="n">cmp</span> <span class="o">=</span> <span class="n">compareAfter</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">    <span class="c1"># the normal sorted() does only look at two items</span>
</span></span><span class="line"><span class="cl">    <span class="c1"># so if &#34;A after C&#34; and a list [A, B, C] then</span>
</span></span><span class="line"><span class="cl">    <span class="c1"># it will see &#34;A = B&#34; and &#34;B = C&#34; assuming that</span>
</span></span><span class="line"><span class="cl">    <span class="c1"># &#34;A = C&#34; and the list is already sorted.</span>
</span></span><span class="line"><span class="cl">    <span class="c1">#</span>
</span></span><span class="line"><span class="cl">    <span class="c1"># To make a totalsorted we have to create a marker</span>
</span></span><span class="line"><span class="cl">    <span class="c1"># that informs sorted() that also B has a relation.</span>
</span></span><span class="line"><span class="cl">    <span class="c1"># It only works when &#39;after&#39; has a direction, so</span>
</span></span><span class="line"><span class="cl">    <span class="c1"># anything without &#39;before&#39; is a &#39;after&#39;. In that</span>
</span></span><span class="line"><span class="cl">    <span class="c1"># case we find that &#34;B after C&#34;.</span>
</span></span><span class="line"><span class="cl">    <span class="k">class</span> <span class="nc">SortTuple</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">        <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">rank</span><span class="p">,</span> <span class="n">conf</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">            <span class="bp">self</span><span class="o">.</span><span class="n">rank</span> <span class="o">=</span> <span class="n">rank</span>
</span></span><span class="line"><span class="cl">            <span class="bp">self</span><span class="o">.</span><span class="n">conf</span> <span class="o">=</span> <span class="n">conf</span>
</span></span><span class="line"><span class="cl">    <span class="n">sortlist</span> <span class="o">=</span> <span class="p">[</span><span class="n">SortTuple</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">conf</span><span class="p">)</span> <span class="k">for</span> <span class="n">conf</span> <span class="ow">in</span> <span class="n">conflist</span><span class="p">]</span>
</span></span><span class="line"><span class="cl">    <span class="k">for</span> <span class="n">check</span> <span class="ow">in</span> <span class="n">xrange</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">sortlist</span><span class="p">)):</span> <span class="c1"># maxrank = len(sortlist)</span>
</span></span><span class="line"><span class="cl">        <span class="n">changed</span> <span class="o">=</span> <span class="mi">0</span>
</span></span><span class="line"><span class="cl">        <span class="k">for</span> <span class="n">A</span> <span class="ow">in</span> <span class="n">xrange</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">sortlist</span><span class="p">)):</span>
</span></span><span class="line"><span class="cl">            <span class="k">for</span> <span class="n">B</span> <span class="ow">in</span> <span class="n">xrange</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">sortlist</span><span class="p">)):</span>
</span></span><span class="line"><span class="cl">                <span class="k">if</span> <span class="n">A</span> <span class="o">!=</span> <span class="n">B</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">                    <span class="n">itemA</span> <span class="o">=</span> <span class="n">sortlist</span><span class="p">[</span><span class="n">A</span><span class="p">]</span>
</span></span><span class="line"><span class="cl">                    <span class="n">itemB</span> <span class="o">=</span> <span class="n">sortlist</span><span class="p">[</span><span class="n">B</span><span class="p">]</span>
</span></span><span class="line"><span class="cl">                    <span class="n">before</span> <span class="o">=</span> <span class="n">compareAfter</span><span class="p">(</span><span class="n">itemA</span><span class="o">.</span><span class="n">conf</span><span class="p">,</span> <span class="n">itemB</span><span class="o">.</span><span class="n">conf</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">                    <span class="k">if</span> <span class="n">before</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="ow">and</span> <span class="n">itemA</span><span class="o">.</span><span class="n">rank</span> <span class="o">&lt;=</span> <span class="n">itemB</span><span class="o">.</span><span class="n">rank</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">                        <span class="n">logg_debug_after</span><span class="p">(</span><span class="s2">&#34;  </span><span class="si">%-30s</span><span class="s2"> before </span><span class="si">%s</span><span class="s2">&#34;</span><span class="p">,</span> <span class="n">itemA</span><span class="o">.</span><span class="n">conf</span><span class="o">.</span><span class="n">name</span><span class="p">(),</span> <span class="n">itemB</span><span class="o">.</span><span class="n">conf</span><span class="o">.</span><span class="n">name</span><span class="p">())</span>
</span></span><span class="line"><span class="cl">                        <span class="n">itemA</span><span class="o">.</span><span class="n">rank</span> <span class="o">=</span> <span class="n">itemB</span><span class="o">.</span><span class="n">rank</span> <span class="o">+</span> <span class="mi">1</span>
</span></span><span class="line"><span class="cl">                        <span class="n">changed</span> <span class="o">+=</span> <span class="mi">1</span>
</span></span><span class="line"><span class="cl">                    <span class="k">if</span> <span class="n">before</span> <span class="o">&lt;</span> <span class="mi">0</span> <span class="ow">and</span> <span class="n">itemB</span><span class="o">.</span><span class="n">rank</span> <span class="o">&lt;=</span> <span class="n">itemA</span><span class="o">.</span><span class="n">rank</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">                        <span class="n">logg_debug_after</span><span class="p">(</span><span class="s2">&#34;  </span><span class="si">%-30s</span><span class="s2"> before </span><span class="si">%s</span><span class="s2">&#34;</span><span class="p">,</span> <span class="n">itemB</span><span class="o">.</span><span class="n">conf</span><span class="o">.</span><span class="n">name</span><span class="p">(),</span> <span class="n">itemA</span><span class="o">.</span><span class="n">conf</span><span class="o">.</span><span class="n">name</span><span class="p">())</span>
</span></span><span class="line"><span class="cl">                        <span class="n">itemB</span><span class="o">.</span><span class="n">rank</span> <span class="o">=</span> <span class="n">itemA</span><span class="o">.</span><span class="n">rank</span> <span class="o">+</span> <span class="mi">1</span>
</span></span><span class="line"><span class="cl">                        <span class="n">changed</span> <span class="o">+=</span> <span class="mi">1</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="ow">not</span> <span class="n">changed</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">            <span class="n">logg_debug_after</span><span class="p">(</span><span class="s2">&#34;done in check </span><span class="si">%s</span><span class="s2"> of </span><span class="si">%s</span><span class="s2">&#34;</span><span class="p">,</span> <span class="n">check</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">sortlist</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">            <span class="k">break</span>
</span></span><span class="line"><span class="cl">            <span class="c1"># because Requires is almost always the same as the After clauses</span>
</span></span><span class="line"><span class="cl">            <span class="c1"># we are mostly done in round 1 as the list is in required order</span>
</span></span><span class="line"><span class="cl">    <span class="k">for</span> <span class="n">conf</span> <span class="ow">in</span> <span class="n">conflist</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">        <span class="n">logg_debug_after</span><span class="p">(</span><span class="s2">&#34;.. </span><span class="si">%s</span><span class="s2">&#34;</span><span class="p">,</span> <span class="n">conf</span><span class="o">.</span><span class="n">name</span><span class="p">())</span>
</span></span><span class="line"><span class="cl">    <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">sortlist</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">        <span class="n">logg_debug_after</span><span class="p">(</span><span class="s2">&#34;(</span><span class="si">%s</span><span class="s2">) </span><span class="si">%s</span><span class="s2">&#34;</span><span class="p">,</span> <span class="n">item</span><span class="o">.</span><span class="n">rank</span><span class="p">,</span> <span class="n">item</span><span class="o">.</span><span class="n">conf</span><span class="o">.</span><span class="n">name</span><span class="p">())</span>
</span></span><span class="line"><span class="cl">    <span class="n">sortedlist</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">sortlist</span><span class="p">,</span> <span class="n">key</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">item</span><span class="p">:</span> <span class="o">-</span><span class="n">item</span><span class="o">.</span><span class="n">rank</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">sortedlist</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">        <span class="n">logg_debug_after</span><span class="p">(</span><span class="s2">&#34;[</span><span class="si">%s</span><span class="s2">] </span><span class="si">%s</span><span class="s2">&#34;</span><span class="p">,</span> <span class="n">item</span><span class="o">.</span><span class="n">rank</span><span class="p">,</span> <span class="n">item</span><span class="o">.</span><span class="n">conf</span><span class="o">.</span><span class="n">name</span><span class="p">())</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="p">[</span><span class="n">item</span><span class="o">.</span><span class="n">conf</span> <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">sortedlist</span><span class="p">]</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">class</span> <span class="nc">SystemctlListenThread</span><span class="p">(</span><span class="n">threading</span><span class="o">.</span><span class="n">Thread</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">systemctl</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">        <span class="n">threading</span><span class="o">.</span><span class="n">Thread</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s2">&#34;listen&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="bp">self</span><span class="o">.</span><span class="n">systemctl</span> <span class="o">=</span> <span class="n">systemctl</span>
</span></span><span class="line"><span class="cl">        <span class="bp">self</span><span class="o">.</span><span class="n">stopped</span> <span class="o">=</span> <span class="n">threading</span><span class="o">.</span><span class="n">Event</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">    <span class="k">def</span> <span class="nf">stop</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">        <span class="bp">self</span><span class="o">.</span><span class="n">stopped</span><span class="o">.</span><span class="n">set</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">    <span class="k">def</span> <span class="nf">run</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">        <span class="n">READ_ONLY</span> <span class="o">=</span> <span class="n">select</span><span class="o">.</span><span class="n">POLLIN</span> <span class="o">|</span> <span class="n">select</span><span class="o">.</span><span class="n">POLLPRI</span> <span class="o">|</span> <span class="n">select</span><span class="o">.</span><span class="n">POLLHUP</span> <span class="o">|</span> <span class="n">select</span><span class="o">.</span><span class="n">POLLERR</span>
</span></span><span class="line"><span class="cl">        <span class="n">READ_WRITE</span> <span class="o">=</span> <span class="n">READ_ONLY</span> <span class="o">|</span> <span class="n">select</span><span class="o">.</span><span class="n">POLLOUT</span>
</span></span><span class="line"><span class="cl">        <span class="n">me</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">getpid</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="n">DEBUG_INITLOOP</span><span class="p">:</span> <span class="c1"># pragma: no cover</span>
</span></span><span class="line"><span class="cl">            <span class="n">logg</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&#34;[</span><span class="si">%s</span><span class="s2">] listen: new thread&#34;</span><span class="p">,</span> <span class="n">me</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">systemctl</span><span class="o">.</span><span class="n">_sockets</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">            <span class="k">return</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="n">DEBUG_INITLOOP</span><span class="p">:</span> <span class="c1"># pragma: no cover</span>
</span></span><span class="line"><span class="cl">            <span class="n">logg</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&#34;[</span><span class="si">%s</span><span class="s2">] listen: start thread&#34;</span><span class="p">,</span> <span class="n">me</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="n">listen</span> <span class="o">=</span> <span class="n">select</span><span class="o">.</span><span class="n">poll</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">        <span class="k">for</span> <span class="n">sock</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">systemctl</span><span class="o">.</span><span class="n">_sockets</span><span class="o">.</span><span class="n">values</span><span class="p">():</span>
</span></span><span class="line"><span class="cl">            <span class="n">listen</span><span class="o">.</span><span class="n">register</span><span class="p">(</span><span class="n">sock</span><span class="p">,</span> <span class="n">READ_ONLY</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">            <span class="n">sock</span><span class="o">.</span><span class="n">listen</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">            <span class="n">logg</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&#34;[</span><span class="si">%s</span><span class="s2">] listen: </span><span class="si">%s</span><span class="s2"> :</span><span class="si">%s</span><span class="s2">&#34;</span><span class="p">,</span> <span class="n">me</span><span class="p">,</span> <span class="n">sock</span><span class="o">.</span><span class="n">name</span><span class="p">(),</span> <span class="n">sock</span><span class="o">.</span><span class="n">addr</span><span class="p">())</span>
</span></span><span class="line"><span class="cl">        <span class="n">timestamp</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">        <span class="k">while</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">stopped</span><span class="o">.</span><span class="n">is_set</span><span class="p">():</span>
</span></span><span class="line"><span class="cl">            <span class="k">try</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">                <span class="n">sleep_sec</span> <span class="o">=</span> <span class="n">InitLoopSleep</span> <span class="o">-</span> <span class="p">(</span><span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span> <span class="o">-</span> <span class="n">timestamp</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">                <span class="k">if</span> <span class="n">sleep_sec</span> <span class="o">&lt;</span> <span class="n">MinimumYield</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">                    <span class="n">sleep_sec</span> <span class="o">=</span> <span class="n">MinimumYield</span>
</span></span><span class="line"><span class="cl">                <span class="n">sleeping</span> <span class="o">=</span> <span class="n">sleep_sec</span>
</span></span><span class="line"><span class="cl">                <span class="k">while</span> <span class="n">sleeping</span> <span class="o">&gt;</span> <span class="mi">2</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">                    <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="c1"># accept signals atleast every second</span>
</span></span><span class="line"><span class="cl">                    <span class="n">sleeping</span> <span class="o">=</span> <span class="n">InitLoopSleep</span> <span class="o">-</span> <span class="p">(</span><span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span> <span class="o">-</span> <span class="n">timestamp</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">                    <span class="k">if</span> <span class="n">sleeping</span> <span class="o">&lt;</span> <span class="n">MinimumYield</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">                        <span class="n">sleeping</span> <span class="o">=</span> <span class="n">MinimumYield</span>
</span></span><span class="line"><span class="cl">                        <span class="k">break</span>
</span></span><span class="line"><span class="cl">                <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="n">sleeping</span><span class="p">)</span> <span class="c1"># remainder waits less that 2 seconds</span>
</span></span><span class="line"><span class="cl">                <span class="k">if</span> <span class="n">DEBUG_INITLOOP</span><span class="p">:</span> <span class="c1"># pragma: no cover</span>
</span></span><span class="line"><span class="cl">                    <span class="n">logg</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&#34;[</span><span class="si">%s</span><span class="s2">] listen: poll&#34;</span><span class="p">,</span> <span class="n">me</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">                <span class="n">accepting</span> <span class="o">=</span> <span class="n">listen</span><span class="o">.</span><span class="n">poll</span><span class="p">(</span><span class="mi">100</span><span class="p">)</span> <span class="c1"># milliseconds</span>
</span></span><span class="line"><span class="cl">                <span class="k">if</span> <span class="n">DEBUG_INITLOOP</span><span class="p">:</span> <span class="c1"># pragma: no cover</span>
</span></span><span class="line"><span class="cl">                    <span class="n">logg</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&#34;[</span><span class="si">%s</span><span class="s2">] listen: poll (</span><span class="si">%s</span><span class="s2">)&#34;</span><span class="p">,</span> <span class="n">me</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">accepting</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">                <span class="k">for</span> <span class="n">sock_fileno</span><span class="p">,</span> <span class="n">event</span> <span class="ow">in</span> <span class="n">accepting</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">                    <span class="k">for</span> <span class="n">sock</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">systemctl</span><span class="o">.</span><span class="n">_sockets</span><span class="o">.</span><span class="n">values</span><span class="p">():</span>
</span></span><span class="line"><span class="cl">                        <span class="k">if</span> <span class="n">sock</span><span class="o">.</span><span class="n">fileno</span><span class="p">()</span> <span class="o">==</span> <span class="n">sock_fileno</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">                            <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">stopped</span><span class="o">.</span><span class="n">is_set</span><span class="p">():</span>
</span></span><span class="line"><span class="cl">                                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">systemctl</span><span class="o">.</span><span class="n">loop</span><span class="o">.</span><span class="n">acquire</span><span class="p">():</span>
</span></span><span class="line"><span class="cl">                                    <span class="n">logg</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&#34;[</span><span class="si">%s</span><span class="s2">] listen: accept </span><span class="si">%s</span><span class="s2"> :</span><span class="si">%s</span><span class="s2">&#34;</span><span class="p">,</span> <span class="n">me</span><span class="p">,</span> <span class="n">sock</span><span class="o">.</span><span class="n">name</span><span class="p">(),</span> <span class="n">sock_fileno</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">                                    <span class="bp">self</span><span class="o">.</span><span class="n">systemctl</span><span class="o">.</span><span class="n">do_accept_socket_from</span><span class="p">(</span><span class="n">sock</span><span class="o">.</span><span class="n">conf</span><span class="p">,</span> <span class="n">sock</span><span class="o">.</span><span class="n">sock</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">            <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">                <span class="n">logg</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&#34;[</span><span class="si">%s</span><span class="s2">] listen: interrupted - exception </span><span class="si">%s</span><span class="s2">&#34;</span><span class="p">,</span> <span class="n">me</span><span class="p">,</span> <span class="n">e</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">                <span class="k">raise</span>
</span></span><span class="line"><span class="cl">        <span class="k">for</span> <span class="n">sock</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">systemctl</span><span class="o">.</span><span class="n">_sockets</span><span class="o">.</span><span class="n">values</span><span class="p">():</span>
</span></span><span class="line"><span class="cl">            <span class="k">try</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">                <span class="n">listen</span><span class="o">.</span><span class="n">unregister</span><span class="p">(</span><span class="n">sock</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">                <span class="n">sock</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">            <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">                <span class="n">logg</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&#34;[</span><span class="si">%s</span><span class="s2">] listen: close socket: </span><span class="si">%s</span><span class="s2">&#34;</span><span class="p">,</span> <span class="n">me</span><span class="p">,</span> <span class="n">e</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">class</span> <span class="nc">Systemctl</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">    <span class="c1"># |</span>
</span></span><span class="line"><span class="cl">    <span class="c1"># |</span>
</span></span><span class="line"><span class="cl">    <span class="c1"># |</span>
</span></span><span class="line"><span class="cl">    <span class="c1"># |</span>
</span></span><span class="line"><span class="cl">    <span class="c1"># |</span>
</span></span><span class="line"><span class="cl">    <span class="c1"># |</span>
</span></span><span class="line"><span class="cl">    <span class="c1"># |</span>
</span></span><span class="line"><span class="cl">    <span class="c1"># |</span>
</span></span><span class="line"><span class="cl">    <span class="c1"># |</span>
</span></span><span class="line"><span class="cl">    <span class="c1"># |</span>
</span></span><span class="line"><span class="cl">    <span class="c1"># |</span>
</span></span><span class="line"><span class="cl">    <span class="c1"># |</span>
</span></span><span class="line"><span class="cl">    <span class="c1"># |</span>
</span></span><span class="line"><span class="cl">    <span class="c1"># |</span>
</span></span><span class="line"><span class="cl">    <span class="c1"># |</span>
</span></span><span class="line"><span class="cl">    <span class="c1"># |</span>
</span></span><span class="line"><span class="cl">    <span class="c1"># |</span>
</span></span><span class="line"><span class="cl">    <span class="c1"># |</span>
</span></span><span class="line"><span class="cl">    <span class="c1"># |</span>
</span></span><span class="line"><span class="cl">    <span class="c1"># |</span>
</span></span><span class="line"><span class="cl">    <span class="c1"># |</span>
</span></span><span class="line"><span class="cl">    <span class="c1"># |</span>
</span></span><span class="line"><span class="cl">    <span class="c1"># |</span>
</span></span><span class="line"><span class="cl">    <span class="c1"># |</span>
</span></span><span class="line"><span class="cl">    <span class="c1"># |</span>
</span></span><span class="line"><span class="cl">    <span class="c1"># |</span>
</span></span><span class="line"><span class="cl">    <span class="c1"># |</span>
</span></span><span class="line"><span class="cl">    <span class="c1"># |</span>
</span></span><span class="line"><span class="cl">    <span class="c1"># |</span>
</span></span><span class="line"><span class="cl">    <span class="c1"># |</span>
</span></span><span class="line"><span class="cl">    <span class="c1"># |</span>
</span></span><span class="line"><span class="cl">    <span class="c1"># |</span>
</span></span><span class="line"><span class="cl">    <span class="c1"># |</span>
</span></span><span class="line"><span class="cl">    <span class="c1"># |</span>
</span></span><span class="line"><span class="cl">    <span class="c1"># |</span>
</span></span><span class="line"><span class="cl">    <span class="c1"># |</span>
</span></span><span class="line"><span class="cl">    <span class="c1"># |</span>
</span></span><span class="line"><span class="cl">    <span class="c1"># |</span>
</span></span><span class="line"><span class="cl">    <span class="c1"># |</span>
</span></span><span class="line"><span class="cl">    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">        <span class="bp">self</span><span class="o">.</span><span class="n">error</span> <span class="o">=</span> <span class="n">NOT_A_PROBLEM</span> <span class="c1"># program exitcode or process returncode</span>
</span></span><span class="line"><span class="cl">        <span class="c1"># from command line options or the defaults</span>
</span></span><span class="line"><span class="cl">        <span class="bp">self</span><span class="o">.</span><span class="n">_extra_vars</span> <span class="o">=</span> <span class="n">_extra_vars</span>
</span></span><span class="line"><span class="cl">        <span class="bp">self</span><span class="o">.</span><span class="n">_force</span> <span class="o">=</span> <span class="n">_force</span>
</span></span><span class="line"><span class="cl">        <span class="bp">self</span><span class="o">.</span><span class="n">_full</span> <span class="o">=</span> <span class="n">_full</span>
</span></span><span class="line"><span class="cl">        <span class="bp">self</span><span class="o">.</span><span class="n">_init</span> <span class="o">=</span> <span class="n">_init</span>
</span></span><span class="line"><span class="cl">        <span class="bp">self</span><span class="o">.</span><span class="n">_no_ask_password</span> <span class="o">=</span> <span class="n">_no_ask_password</span>
</span></span><span class="line"><span class="cl">        <span class="bp">self</span><span class="o">.</span><span class="n">_no_legend</span> <span class="o">=</span> <span class="n">_no_legend</span>
</span></span><span class="line"><span class="cl">        <span class="bp">self</span><span class="o">.</span><span class="n">_now</span> <span class="o">=</span> <span class="n">_now</span>
</span></span><span class="line"><span class="cl">        <span class="bp">self</span><span class="o">.</span><span class="n">_preset_mode</span> <span class="o">=</span> <span class="n">_preset_mode</span>
</span></span><span class="line"><span class="cl">        <span class="bp">self</span><span class="o">.</span><span class="n">_quiet</span> <span class="o">=</span> <span class="n">_quiet</span>
</span></span><span class="line"><span class="cl">        <span class="bp">self</span><span class="o">.</span><span class="n">_root</span> <span class="o">=</span> <span class="n">_root</span>
</span></span><span class="line"><span class="cl">        <span class="bp">self</span><span class="o">.</span><span class="n">_show_all</span> <span class="o">=</span> <span class="n">_show_all</span>
</span></span><span class="line"><span class="cl">        <span class="bp">self</span><span class="o">.</span><span class="n">_only_what</span> <span class="o">=</span> <span class="n">commalist</span><span class="p">(</span><span class="n">_only_what</span><span class="p">)</span> <span class="ow">or</span> <span class="p">[</span><span class="s2">&#34;&#34;</span><span class="p">]</span>
</span></span><span class="line"><span class="cl">        <span class="bp">self</span><span class="o">.</span><span class="n">_only_property</span> <span class="o">=</span> <span class="n">commalist</span><span class="p">(</span><span class="n">_only_property</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="bp">self</span><span class="o">.</span><span class="n">_only_state</span> <span class="o">=</span> <span class="n">commalist</span><span class="p">(</span><span class="n">_only_state</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="bp">self</span><span class="o">.</span><span class="n">_only_type</span> <span class="o">=</span> <span class="n">commalist</span><span class="p">(</span><span class="n">_only_type</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="c1"># some common constants that may be changed</span>
</span></span><span class="line"><span class="cl">        <span class="bp">self</span><span class="o">.</span><span class="n">_systemd_version</span> <span class="o">=</span> <span class="n">SystemCompatibilityVersion</span>
</span></span><span class="line"><span class="cl">        <span class="bp">self</span><span class="o">.</span><span class="n">_journal_log_folder</span> <span class="o">=</span> <span class="n">_journal_log_folder</span>
</span></span><span class="line"><span class="cl">        <span class="c1"># and the actual internal runtime state</span>
</span></span><span class="line"><span class="cl">        <span class="bp">self</span><span class="o">.</span><span class="n">_loaded_file_sysv</span> <span class="o">=</span> <span class="p">{}</span> <span class="c1"># /etc/init.d/name =&gt; config data</span>
</span></span><span class="line"><span class="cl">        <span class="bp">self</span><span class="o">.</span><span class="n">_loaded_file_sysd</span> <span class="o">=</span> <span class="p">{}</span> <span class="c1"># /etc/systemd/system/name.service =&gt; config data</span>
</span></span><span class="line"><span class="cl">        <span class="bp">self</span><span class="o">.</span><span class="n">_file_for_unit_sysv</span> <span class="o">=</span> <span class="kc">None</span> <span class="c1"># name.service =&gt; /etc/init.d/name</span>
</span></span><span class="line"><span class="cl">        <span class="bp">self</span><span class="o">.</span><span class="n">_file_for_unit_sysd</span> <span class="o">=</span> <span class="kc">None</span> <span class="c1"># name.service =&gt; /etc/systemd/system/name.service</span>
</span></span><span class="line"><span class="cl">        <span class="bp">self</span><span class="o">.</span><span class="n">_preset_file_list</span> <span class="o">=</span> <span class="kc">None</span> <span class="c1"># /etc/systemd/system-preset/* =&gt; file content</span>
</span></span><span class="line"><span class="cl">        <span class="bp">self</span><span class="o">.</span><span class="n">_default_target</span> <span class="o">=</span> <span class="n">DefaultTarget</span>
</span></span><span class="line"><span class="cl">        <span class="bp">self</span><span class="o">.</span><span class="n">_sysinit_target</span> <span class="o">=</span> <span class="kc">None</span> <span class="c1"># stores a UnitConf()</span>
</span></span><span class="line"><span class="cl">        <span class="bp">self</span><span class="o">.</span><span class="n">doExitWhenNoMoreProcs</span> <span class="o">=</span> <span class="n">ExitWhenNoMoreProcs</span> <span class="ow">or</span> <span class="kc">False</span>
</span></span><span class="line"><span class="cl">        <span class="bp">self</span><span class="o">.</span><span class="n">doExitWhenNoMoreServices</span> <span class="o">=</span> <span class="n">ExitWhenNoMoreServices</span> <span class="ow">or</span> <span class="kc">False</span>
</span></span><span class="line"><span class="cl">        <span class="bp">self</span><span class="o">.</span><span class="n">_user_mode</span> <span class="o">=</span> <span class="n">_user_mode</span>
</span></span><span class="line"><span class="cl">        <span class="bp">self</span><span class="o">.</span><span class="n">_user_getlogin</span> <span class="o">=</span> <span class="n">os_getlogin</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">        <span class="bp">self</span><span class="o">.</span><span class="n">_log_file</span> <span class="o">=</span> <span class="p">{}</span> <span class="c1"># init-loop</span>
</span></span><span class="line"><span class="cl">        <span class="bp">self</span><span class="o">.</span><span class="n">_log_hold</span> <span class="o">=</span> <span class="p">{}</span> <span class="c1"># init-loop</span>
</span></span><span class="line"><span class="cl">        <span class="bp">self</span><span class="o">.</span><span class="n">_boottime</span> <span class="o">=</span> <span class="kc">None</span> <span class="c1"># cache self.get_boottime()</span>
</span></span><span class="line"><span class="cl">        <span class="bp">self</span><span class="o">.</span><span class="n">_SYSTEMD_UNIT_PATH</span> <span class="o">=</span> <span class="kc">None</span>
</span></span><span class="line"><span class="cl">        <span class="bp">self</span><span class="o">.</span><span class="n">_SYSTEMD_SYSVINIT_PATH</span> <span class="o">=</span> <span class="kc">None</span>
</span></span><span class="line"><span class="cl">        <span class="bp">self</span><span class="o">.</span><span class="n">_SYSTEMD_PRESET_PATH</span> <span class="o">=</span> <span class="kc">None</span>
</span></span><span class="line"><span class="cl">        <span class="bp">self</span><span class="o">.</span><span class="n">_restarted_unit</span> <span class="o">=</span> <span class="p">{}</span>
</span></span><span class="line"><span class="cl">        <span class="bp">self</span><span class="o">.</span><span class="n">_restart_failed_units</span> <span class="o">=</span> <span class="p">{}</span>
</span></span><span class="line"><span class="cl">        <span class="bp">self</span><span class="o">.</span><span class="n">_sockets</span> <span class="o">=</span> <span class="p">{}</span>
</span></span><span class="line"><span class="cl">        <span class="bp">self</span><span class="o">.</span><span class="n">loop</span> <span class="o">=</span> <span class="n">threading</span><span class="o">.</span><span class="n">Lock</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">    <span class="k">def</span> <span class="nf">user</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_user_getlogin</span>
</span></span><span class="line"><span class="cl">    <span class="k">def</span> <span class="nf">user_mode</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_user_mode</span>
</span></span><span class="line"><span class="cl">    <span class="k">def</span> <span class="nf">user_folder</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">        <span class="k">for</span> <span class="n">folder</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">user_folders</span><span class="p">():</span>
</span></span><span class="line"><span class="cl">            <span class="k">if</span> <span class="n">folder</span><span class="p">:</span> <span class="k">return</span> <span class="n">folder</span>
</span></span><span class="line"><span class="cl">        <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s2">&#34;did not find any systemd/user folder&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="k">def</span> <span class="nf">system_folder</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">        <span class="k">for</span> <span class="n">folder</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">system_folders</span><span class="p">():</span>
</span></span><span class="line"><span class="cl">            <span class="k">if</span> <span class="n">folder</span><span class="p">:</span> <span class="k">return</span> <span class="n">folder</span>
</span></span><span class="line"><span class="cl">        <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s2">&#34;did not find any systemd/system folder&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="k">def</span> <span class="nf">preset_folders</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">        <span class="n">SYSTEMD_PRESET_PATH</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_SYSTEMD_PRESET_PATH</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">        <span class="k">for</span> <span class="n">path</span> <span class="ow">in</span> <span class="n">SYSTEMD_PRESET_PATH</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&#34;:&#34;</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">            <span class="k">if</span> <span class="n">path</span><span class="o">.</span><span class="n">strip</span><span class="p">():</span> <span class="k">yield</span> <span class="n">expand_path</span><span class="p">(</span><span class="n">path</span><span class="o">.</span><span class="n">strip</span><span class="p">())</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="n">SYSTEMD_PRESET_PATH</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s2">&#34;:&#34;</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">            <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">_preset_folders</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">                <span class="k">yield</span> <span class="n">expand_path</span><span class="p">(</span><span class="n">p</span><span class="o">.</span><span class="n">strip</span><span class="p">())</span>
</span></span><span class="line"><span class="cl">    <span class="k">def</span> <span class="nf">init_folders</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">        <span class="n">SYSTEMD_SYSVINIT_PATH</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_SYSTEMD_SYSVINIT_PATH</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">        <span class="k">for</span> <span class="n">path</span> <span class="ow">in</span> <span class="n">SYSTEMD_SYSVINIT_PATH</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&#34;:&#34;</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">            <span class="k">if</span> <span class="n">path</span><span class="o">.</span><span class="n">strip</span><span class="p">():</span> <span class="k">yield</span> <span class="n">expand_path</span><span class="p">(</span><span class="n">path</span><span class="o">.</span><span class="n">strip</span><span class="p">())</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="n">SYSTEMD_SYSVINIT_PATH</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s2">&#34;:&#34;</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">            <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">_init_folders</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">                <span class="k">yield</span> <span class="n">expand_path</span><span class="p">(</span><span class="n">p</span><span class="o">.</span><span class="n">strip</span><span class="p">())</span>
</span></span><span class="line"><span class="cl">    <span class="k">def</span> <span class="nf">user_folders</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">        <span class="n">SYSTEMD_UNIT_PATH</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_SYSTEMD_UNIT_PATH</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">        <span class="k">for</span> <span class="n">path</span> <span class="ow">in</span> <span class="n">SYSTEMD_UNIT_PATH</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&#34;:&#34;</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">            <span class="k">if</span> <span class="n">path</span><span class="o">.</span><span class="n">strip</span><span class="p">():</span> <span class="k">yield</span> <span class="n">expand_path</span><span class="p">(</span><span class="n">path</span><span class="o">.</span><span class="n">strip</span><span class="p">())</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="n">SYSTEMD_UNIT_PATH</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s2">&#34;:&#34;</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">            <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">_user_folders</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">                <span class="k">yield</span> <span class="n">expand_path</span><span class="p">(</span><span class="n">p</span><span class="o">.</span><span class="n">strip</span><span class="p">())</span>
</span></span><span class="line"><span class="cl">    <span class="k">def</span> <span class="nf">system_folders</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">        <span class="n">SYSTEMD_UNIT_PATH</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_SYSTEMD_UNIT_PATH</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">        <span class="k">for</span> <span class="n">path</span> <span class="ow">in</span> <span class="n">SYSTEMD_UNIT_PATH</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&#34;:&#34;</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">            <span class="k">if</span> <span class="n">path</span><span class="o">.</span><span class="n">strip</span><span class="p">():</span> <span class="k">yield</span> <span class="n">expand_path</span><span class="p">(</span><span class="n">path</span><span class="o">.</span><span class="n">strip</span><span class="p">())</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="n">SYSTEMD_UNIT_PATH</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s2">&#34;:&#34;</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">            <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">_system_folders</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">                <span class="k">yield</span> <span class="n">expand_path</span><span class="p">(</span><span class="n">p</span><span class="o">.</span><span class="n">strip</span><span class="p">())</span>
</span></span><span class="line"><span class="cl">    <span class="k">def</span> <span class="nf">get_SYSTEMD_UNIT_PATH</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_SYSTEMD_UNIT_PATH</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">            <span class="bp">self</span><span class="o">.</span><span class="n">_SYSTEMD_UNIT_PATH</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&#34;SYSTEMD_UNIT_PATH&#34;</span><span class="p">,</span> <span class="s2">&#34;:&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="k">assert</span> <span class="bp">self</span><span class="o">.</span><span class="n">_SYSTEMD_UNIT_PATH</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_SYSTEMD_UNIT_PATH</span>
</span></span><span class="line"><span class="cl">    <span class="k">def</span> <span class="nf">get_SYSTEMD_SYSVINIT_PATH</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_SYSTEMD_SYSVINIT_PATH</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">            <span class="bp">self</span><span class="o">.</span><span class="n">_SYSTEMD_SYSVINIT_PATH</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&#34;SYSTEMD_SYSVINIT_PATH&#34;</span><span class="p">,</span> <span class="s2">&#34;:&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="k">assert</span> <span class="bp">self</span><span class="o">.</span><span class="n">_SYSTEMD_SYSVINIT_PATH</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_SYSTEMD_SYSVINIT_PATH</span>
</span></span><span class="line"><span class="cl">    <span class="k">def</span> <span class="nf">get_SYSTEMD_PRESET_PATH</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_SYSTEMD_PRESET_PATH</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">            <span class="bp">self</span><span class="o">.</span><span class="n">_SYSTEMD_PRESET_PATH</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&#34;SYSTEMD_PRESET_PATH&#34;</span><span class="p">,</span> <span class="s2">&#34;:&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="k">assert</span> <span class="bp">self</span><span class="o">.</span><span class="n">_SYSTEMD_PRESET_PATH</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_SYSTEMD_PRESET_PATH</span>
</span></span><span class="line"><span class="cl">    <span class="k">def</span> <span class="nf">sysd_folders</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">        <span class="s2">&#34;&#34;&#34; if --user then these folders are preferred &#34;&#34;&#34;</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">user_mode</span><span class="p">():</span>
</span></span><span class="line"><span class="cl">            <span class="k">for</span> <span class="n">folder</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">user_folders</span><span class="p">():</span>
</span></span><span class="line"><span class="cl">                <span class="k">yield</span> <span class="n">folder</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="kc">True</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">            <span class="k">for</span> <span class="n">folder</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">system_folders</span><span class="p">():</span>
</span></span><span class="line"><span class="cl">                <span class="k">yield</span> <span class="n">folder</span>
</span></span><span class="line"><span class="cl">    <span class="k">def</span> <span class="nf">scan_unit_sysd_files</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">module</span> <span class="o">=</span> <span class="kc">None</span><span class="p">):</span> <span class="c1"># -&gt; [ unit-names,... ]</span>
</span></span><span class="line"><span class="cl">        <span class="s2">&#34;&#34;&#34; reads all unit files, returns the first filename for the unit given &#34;&#34;&#34;</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_file_for_unit_sysd</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">            <span class="bp">self</span><span class="o">.</span><span class="n">_file_for_unit_sysd</span> <span class="o">=</span> <span class="p">{}</span>
</span></span><span class="line"><span class="cl">            <span class="k">for</span> <span class="n">folder</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">sysd_folders</span><span class="p">():</span>
</span></span><span class="line"><span class="cl">                <span class="k">if</span> <span class="ow">not</span> <span class="n">folder</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">                    <span class="k">continue</span>
</span></span><span class="line"><span class="cl">                <span class="n">folder</span> <span class="o">=</span> <span class="n">os_path</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_root</span><span class="p">,</span> <span class="n">folder</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">                <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isdir</span><span class="p">(</span><span class="n">folder</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">                    <span class="k">continue</span>
</span></span><span class="line"><span class="cl">                <span class="k">for</span> <span class="n">name</span> <span class="ow">in</span> <span class="n">os</span><span class="o">.</span><span class="n">listdir</span><span class="p">(</span><span class="n">folder</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">                    <span class="n">path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">folder</span><span class="p">,</span> <span class="n">name</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">                    <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isdir</span><span class="p">(</span><span class="n">path</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">                        <span class="k">continue</span>
</span></span><span class="line"><span class="cl">                    <span class="n">service_name</span> <span class="o">=</span> <span class="n">name</span>
</span></span><span class="line"><span class="cl">                    <span class="k">if</span> <span class="n">service_name</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_file_for_unit_sysd</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">                        <span class="bp">self</span><span class="o">.</span><span class="n">_file_for_unit_sysd</span><span class="p">[</span><span class="n">service_name</span><span class="p">]</span> <span class="o">=</span> <span class="n">path</span>
</span></span><span class="line"><span class="cl">            <span class="n">logg</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&#34;found </span><span class="si">%s</span><span class="s2"> sysd files&#34;</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_file_for_unit_sysd</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_file_for_unit_sysd</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>
</span></span><span class="line"><span class="cl">    <span class="k">def</span> <span class="nf">scan_unit_sysv_files</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">module</span> <span class="o">=</span> <span class="kc">None</span><span class="p">):</span> <span class="c1"># -&gt; [ unit-names,... ]</span>
</span></span><span class="line"><span class="cl">        <span class="s2">&#34;&#34;&#34; reads all init.d files, returns the first filename when unit is a &#39;.service&#39; &#34;&#34;&#34;</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_file_for_unit_sysv</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">            <span class="bp">self</span><span class="o">.</span><span class="n">_file_for_unit_sysv</span> <span class="o">=</span> <span class="p">{}</span>
</span></span><span class="line"><span class="cl">            <span class="k">for</span> <span class="n">folder</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">init_folders</span><span class="p">():</span>
</span></span><span class="line"><span class="cl">                <span class="k">if</span> <span class="ow">not</span> <span class="n">folder</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">                    <span class="k">continue</span>
</span></span><span class="line"><span class="cl">                <span class="n">folder</span> <span class="o">=</span> <span class="n">os_path</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_root</span><span class="p">,</span> <span class="n">folder</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">                <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isdir</span><span class="p">(</span><span class="n">folder</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">                    <span class="k">continue</span>
</span></span><span class="line"><span class="cl">                <span class="k">for</span> <span class="n">name</span> <span class="ow">in</span> <span class="n">os</span><span class="o">.</span><span class="n">listdir</span><span class="p">(</span><span class="n">folder</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">                    <span class="n">path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">folder</span><span class="p">,</span> <span class="n">name</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">                    <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isdir</span><span class="p">(</span><span class="n">path</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">                        <span class="k">continue</span>
</span></span><span class="line"><span class="cl">                    <span class="n">service_name</span> <span class="o">=</span> <span class="n">name</span> <span class="o">+</span> <span class="s2">&#34;.service&#34;</span> <span class="c1"># simulate systemd</span>
</span></span><span class="line"><span class="cl">                    <span class="k">if</span> <span class="n">service_name</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_file_for_unit_sysv</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">                        <span class="bp">self</span><span class="o">.</span><span class="n">_file_for_unit_sysv</span><span class="p">[</span><span class="n">service_name</span><span class="p">]</span> <span class="o">=</span> <span class="n">path</span>
</span></span><span class="line"><span class="cl">            <span class="n">logg</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&#34;found </span><span class="si">%s</span><span class="s2"> sysv files&#34;</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_file_for_unit_sysv</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_file_for_unit_sysv</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>
</span></span><span class="line"><span class="cl">    <span class="k">def</span> <span class="nf">unit_sysd_file</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">module</span> <span class="o">=</span> <span class="kc">None</span><span class="p">):</span> <span class="c1"># -&gt; filename?</span>
</span></span><span class="line"><span class="cl">        <span class="s2">&#34;&#34;&#34; file path for the given module (systemd) &#34;&#34;&#34;</span>
</span></span><span class="line"><span class="cl">        <span class="bp">self</span><span class="o">.</span><span class="n">scan_unit_sysd_files</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">        <span class="k">assert</span> <span class="bp">self</span><span class="o">.</span><span class="n">_file_for_unit_sysd</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="n">module</span> <span class="ow">and</span> <span class="n">module</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_file_for_unit_sysd</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_file_for_unit_sysd</span><span class="p">[</span><span class="n">module</span><span class="p">]</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="n">module</span> <span class="ow">and</span> <span class="n">unit_of</span><span class="p">(</span><span class="n">module</span><span class="p">)</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_file_for_unit_sysd</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_file_for_unit_sysd</span><span class="p">[</span><span class="n">unit_of</span><span class="p">(</span><span class="n">module</span><span class="p">)]</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="kc">None</span>
</span></span><span class="line"><span class="cl">    <span class="k">def</span> <span class="nf">unit_sysv_file</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">module</span> <span class="o">=</span> <span class="kc">None</span><span class="p">):</span> <span class="c1"># -&gt; filename?</span>
</span></span><span class="line"><span class="cl">        <span class="s2">&#34;&#34;&#34; file path for the given module (sysv) &#34;&#34;&#34;</span>
</span></span><span class="line"><span class="cl">        <span class="bp">self</span><span class="o">.</span><span class="n">scan_unit_sysv_files</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">        <span class="k">assert</span> <span class="bp">self</span><span class="o">.</span><span class="n">_file_for_unit_sysv</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="n">module</span> <span class="ow">and</span> <span class="n">module</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_file_for_unit_sysv</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_file_for_unit_sysv</span><span class="p">[</span><span class="n">module</span><span class="p">]</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="n">module</span> <span class="ow">and</span> <span class="n">unit_of</span><span class="p">(</span><span class="n">module</span><span class="p">)</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_file_for_unit_sysv</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_file_for_unit_sysv</span><span class="p">[</span><span class="n">unit_of</span><span class="p">(</span><span class="n">module</span><span class="p">)]</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="kc">None</span>
</span></span><span class="line"><span class="cl">    <span class="k">def</span> <span class="nf">unit_file</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">module</span> <span class="o">=</span> <span class="kc">None</span><span class="p">):</span> <span class="c1"># -&gt; filename?</span>
</span></span><span class="line"><span class="cl">        <span class="s2">&#34;&#34;&#34; file path for the given module (sysv or systemd) &#34;&#34;&#34;</span>
</span></span><span class="line"><span class="cl">        <span class="n">path</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">unit_sysd_file</span><span class="p">(</span><span class="n">module</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="n">path</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span> <span class="k">return</span> <span class="n">path</span>
</span></span><span class="line"><span class="cl">        <span class="n">path</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">unit_sysv_file</span><span class="p">(</span><span class="n">module</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="n">path</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span> <span class="k">return</span> <span class="n">path</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="kc">None</span>
</span></span><span class="line"><span class="cl">    <span class="k">def</span> <span class="nf">is_sysv_file</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">filename</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">        <span class="s2">&#34;&#34;&#34; for routines that have a special treatment for init.d services &#34;&#34;&#34;</span>
</span></span><span class="line"><span class="cl">        <span class="bp">self</span><span class="o">.</span><span class="n">unit_file</span><span class="p">()</span> <span class="c1"># scan all</span>
</span></span><span class="line"><span class="cl">        <span class="k">assert</span> <span class="bp">self</span><span class="o">.</span><span class="n">_file_for_unit_sysd</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>
</span></span><span class="line"><span class="cl">        <span class="k">assert</span> <span class="bp">self</span><span class="o">.</span><span class="n">_file_for_unit_sysv</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="ow">not</span> <span class="n">filename</span><span class="p">:</span> <span class="k">return</span> <span class="kc">None</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="n">filename</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_file_for_unit_sysd</span><span class="o">.</span><span class="n">values</span><span class="p">():</span> <span class="k">return</span> <span class="kc">False</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="n">filename</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_file_for_unit_sysv</span><span class="o">.</span><span class="n">values</span><span class="p">():</span> <span class="k">return</span> <span class="kc">True</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="kc">None</span> <span class="c1"># not True</span>
</span></span><span class="line"><span class="cl">    <span class="k">def</span> <span class="nf">is_user_conf</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">conf</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="ow">not</span> <span class="n">conf</span><span class="p">:</span> <span class="c1"># pragma: no cover (is never null)</span>
</span></span><span class="line"><span class="cl">            <span class="k">return</span> <span class="kc">False</span>
</span></span><span class="line"><span class="cl">        <span class="n">filename</span> <span class="o">=</span> <span class="n">conf</span><span class="o">.</span><span class="n">nonloaded_path</span> <span class="ow">or</span> <span class="n">conf</span><span class="o">.</span><span class="n">filename</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="n">filename</span> <span class="ow">and</span> <span class="s2">&#34;/user/&#34;</span> <span class="ow">in</span> <span class="n">filename</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">            <span class="k">return</span> <span class="kc">True</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="kc">False</span>
</span></span><span class="line"><span class="cl">    <span class="k">def</span> <span class="nf">not_user_conf</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">conf</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">        <span class="s2">&#34;&#34;&#34; conf can not be started as user service (when --user)&#34;&#34;&#34;</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="n">conf</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span> <span class="c1"># pragma: no cover (is never null)</span>
</span></span><span class="line"><span class="cl">            <span class="k">return</span> <span class="kc">True</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">user_mode</span><span class="p">():</span>
</span></span><span class="line"><span class="cl">            <span class="n">logg</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&#34;</span><span class="si">%s</span><span class="s2"> no --user mode &gt;&gt; accept&#34;</span><span class="p">,</span> <span class="n">strQ</span><span class="p">(</span><span class="n">conf</span><span class="o">.</span><span class="n">filename</span><span class="p">()))</span>
</span></span><span class="line"><span class="cl">            <span class="k">return</span> <span class="kc">False</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">is_user_conf</span><span class="p">(</span><span class="n">conf</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">            <span class="n">logg</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&#34;</span><span class="si">%s</span><span class="s2"> is /user/ conf &gt;&gt; accept&#34;</span><span class="p">,</span> <span class="n">strQ</span><span class="p">(</span><span class="n">conf</span><span class="o">.</span><span class="n">filename</span><span class="p">()))</span>
</span></span><span class="line"><span class="cl">            <span class="k">return</span> <span class="kc">False</span>
</span></span><span class="line"><span class="cl">        <span class="c1"># to allow for &#39;docker run -u user&#39; with system services</span>
</span></span><span class="line"><span class="cl">        <span class="n">user</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_User</span><span class="p">(</span><span class="n">conf</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="n">user</span> <span class="ow">and</span> <span class="n">user</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">user</span><span class="p">():</span>
</span></span><span class="line"><span class="cl">            <span class="n">logg</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&#34;</span><span class="si">%s</span><span class="s2"> with User=</span><span class="si">%s</span><span class="s2"> &gt;&gt; accept&#34;</span><span class="p">,</span> <span class="n">strQ</span><span class="p">(</span><span class="n">conf</span><span class="o">.</span><span class="n">filename</span><span class="p">()),</span> <span class="n">user</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">            <span class="k">return</span> <span class="kc">False</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="kc">True</span>
</span></span><span class="line"><span class="cl">    <span class="k">def</span> <span class="nf">find_drop_in_files</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">unit</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">        <span class="s2">&#34;&#34;&#34; search for some.service.d/extra.conf files &#34;&#34;&#34;</span>
</span></span><span class="line"><span class="cl">        <span class="n">result</span> <span class="o">=</span> <span class="p">{}</span>
</span></span><span class="line"><span class="cl">        <span class="n">basename_d</span> <span class="o">=</span> <span class="n">unit</span> <span class="o">+</span> <span class="s2">&#34;.d&#34;</span>
</span></span><span class="line"><span class="cl">        <span class="k">for</span> <span class="n">folder</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">sysd_folders</span><span class="p">():</span>
</span></span><span class="line"><span class="cl">            <span class="k">if</span> <span class="ow">not</span> <span class="n">folder</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">                <span class="k">continue</span>
</span></span><span class="line"><span class="cl">            <span class="n">folder</span> <span class="o">=</span> <span class="n">os_path</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_root</span><span class="p">,</span> <span class="n">folder</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">            <span class="n">override_d</span> <span class="o">=</span> <span class="n">os_path</span><span class="p">(</span><span class="n">folder</span><span class="p">,</span> <span class="n">basename_d</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">            <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isdir</span><span class="p">(</span><span class="n">override_d</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">                <span class="k">continue</span>
</span></span><span class="line"><span class="cl">            <span class="k">for</span> <span class="n">name</span> <span class="ow">in</span> <span class="n">os</span><span class="o">.</span><span class="n">listdir</span><span class="p">(</span><span class="n">override_d</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">                <span class="n">path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">override_d</span><span class="p">,</span> <span class="n">name</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">                <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isdir</span><span class="p">(</span><span class="n">path</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">                    <span class="k">continue</span>
</span></span><span class="line"><span class="cl">                <span class="k">if</span> <span class="ow">not</span> <span class="n">path</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s2">&#34;.conf&#34;</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">                    <span class="k">continue</span>
</span></span><span class="line"><span class="cl">                <span class="k">if</span> <span class="n">name</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">result</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">                    <span class="n">result</span><span class="p">[</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="n">path</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="n">result</span>
</span></span><span class="line"><span class="cl">    <span class="k">def</span> <span class="nf">load_sysd_template_conf</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">module</span><span class="p">):</span> <span class="c1"># -&gt; conf?</span>
</span></span><span class="line"><span class="cl">        <span class="s2">&#34;&#34;&#34; read the unit template with a UnitConfParser (systemd) &#34;&#34;&#34;</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="n">module</span> <span class="ow">and</span> <span class="s2">&#34;@&#34;</span> <span class="ow">in</span> <span class="n">module</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">            <span class="n">unit</span> <span class="o">=</span> <span class="n">parse_unit</span><span class="p">(</span><span class="n">module</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">            <span class="n">service</span> <span class="o">=</span> <span class="s2">&#34;</span><span class="si">%s</span><span class="s2">@.service&#34;</span> <span class="o">%</span> <span class="n">unit</span><span class="o">.</span><span class="n">prefix</span>
</span></span><span class="line"><span class="cl">            <span class="n">conf</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">load_sysd_unit_conf</span><span class="p">(</span><span class="n">service</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">            <span class="k">if</span> <span class="n">conf</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">                <span class="n">conf</span><span class="o">.</span><span class="n">module</span> <span class="o">=</span> <span class="n">module</span>
</span></span><span class="line"><span class="cl">            <span class="k">return</span> <span class="n">conf</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="kc">None</span>
</span></span><span class="line"><span class="cl">    <span class="k">def</span> <span class="nf">load_sysd_unit_conf</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">module</span><span class="p">):</span> <span class="c1"># -&gt; conf?</span>
</span></span><span class="line"><span class="cl">        <span class="s2">&#34;&#34;&#34; read the unit file with a UnitConfParser (systemd) &#34;&#34;&#34;</span>
</span></span><span class="line"><span class="cl">        <span class="n">path</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">unit_sysd_file</span><span class="p">(</span><span class="n">module</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="ow">not</span> <span class="n">path</span><span class="p">:</span> <span class="k">return</span> <span class="kc">None</span>
</span></span><span class="line"><span class="cl">        <span class="k">assert</span> <span class="bp">self</span><span class="o">.</span><span class="n">_loaded_file_sysd</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="n">path</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_loaded_file_sysd</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_loaded_file_sysd</span><span class="p">[</span><span class="n">path</span><span class="p">]</span>
</span></span><span class="line"><span class="cl">        <span class="n">masked</span> <span class="o">=</span> <span class="kc">None</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">islink</span><span class="p">(</span><span class="n">path</span><span class="p">)</span> <span class="ow">and</span> <span class="n">os</span><span class="o">.</span><span class="n">readlink</span><span class="p">(</span><span class="n">path</span><span class="p">)</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s2">&#34;/dev&#34;</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">            <span class="n">masked</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">readlink</span><span class="p">(</span><span class="n">path</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="n">drop_in_files</span> <span class="o">=</span> <span class="p">{}</span>
</span></span><span class="line"><span class="cl">        <span class="n">data</span> <span class="o">=</span> <span class="n">UnitConfParser</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="ow">not</span> <span class="n">masked</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">            <span class="n">data</span><span class="o">.</span><span class="n">read_sysd</span><span class="p">(</span><span class="n">path</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">            <span class="n">drop_in_files</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">find_drop_in_files</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">basename</span><span class="p">(</span><span class="n">path</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">            <span class="c1"># load in alphabetic order, irrespective of location</span>
</span></span><span class="line"><span class="cl">            <span class="k">for</span> <span class="n">name</span> <span class="ow">in</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">drop_in_files</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">                <span class="n">path</span> <span class="o">=</span> <span class="n">drop_in_files</span><span class="p">[</span><span class="n">name</span><span class="p">]</span>
</span></span><span class="line"><span class="cl">                <span class="n">data</span><span class="o">.</span><span class="n">read_sysd</span><span class="p">(</span><span class="n">path</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="n">conf</span> <span class="o">=</span> <span class="n">SystemctlConf</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">module</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="n">conf</span><span class="o">.</span><span class="n">masked</span> <span class="o">=</span> <span class="n">masked</span>
</span></span><span class="line"><span class="cl">        <span class="n">conf</span><span class="o">.</span><span class="n">nonloaded_path</span> <span class="o">=</span> <span class="n">path</span> <span class="c1"># if masked</span>
</span></span><span class="line"><span class="cl">        <span class="n">conf</span><span class="o">.</span><span class="n">drop_in_files</span> <span class="o">=</span> <span class="n">drop_in_files</span>
</span></span><span class="line"><span class="cl">        <span class="n">conf</span><span class="o">.</span><span class="n">_root</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_root</span>
</span></span><span class="line"><span class="cl">        <span class="bp">self</span><span class="o">.</span><span class="n">_loaded_file_sysd</span><span class="p">[</span><span class="n">path</span><span class="p">]</span> <span class="o">=</span> <span class="n">conf</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="n">conf</span>
</span></span><span class="line"><span class="cl">    <span class="k">def</span> <span class="nf">load_sysv_unit_conf</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">module</span><span class="p">):</span> <span class="c1"># -&gt; conf?</span>
</span></span><span class="line"><span class="cl">        <span class="s2">&#34;&#34;&#34; read the unit file with a UnitConfParser (sysv) &#34;&#34;&#34;</span>
</span></span><span class="line"><span class="cl">        <span class="n">path</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">unit_sysv_file</span><span class="p">(</span><span class="n">module</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="ow">not</span> <span class="n">path</span><span class="p">:</span> <span class="k">return</span> <span class="kc">None</span>
</span></span><span class="line"><span class="cl">        <span class="k">assert</span> <span class="bp">self</span><span class="o">.</span><span class="n">_loaded_file_sysv</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="n">path</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_loaded_file_sysv</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_loaded_file_sysv</span><span class="p">[</span><span class="n">path</span><span class="p">]</span>
</span></span><span class="line"><span class="cl">        <span class="n">data</span> <span class="o">=</span> <span class="n">UnitConfParser</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">        <span class="n">data</span><span class="o">.</span><span class="n">read_sysv</span><span class="p">(</span><span class="n">path</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="n">conf</span> <span class="o">=</span> <span class="n">SystemctlConf</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">module</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="n">conf</span><span class="o">.</span><span class="n">_root</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_root</span>
</span></span><span class="line"><span class="cl">        <span class="bp">self</span><span class="o">.</span><span class="n">_loaded_file_sysv</span><span class="p">[</span><span class="n">path</span><span class="p">]</span> <span class="o">=</span> <span class="n">conf</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="n">conf</span>
</span></span><span class="line"><span class="cl">    <span class="k">def</span> <span class="nf">load_unit_conf</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">module</span><span class="p">):</span> <span class="c1"># -&gt; conf | None(not-found)</span>
</span></span><span class="line"><span class="cl">        <span class="s2">&#34;&#34;&#34; read the unit file with a UnitConfParser (sysv or systemd) &#34;&#34;&#34;</span>
</span></span><span class="line"><span class="cl">        <span class="k">try</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">            <span class="n">conf</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">load_sysd_unit_conf</span><span class="p">(</span><span class="n">module</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">            <span class="k">if</span> <span class="n">conf</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">                <span class="k">return</span> <span class="n">conf</span>
</span></span><span class="line"><span class="cl">            <span class="n">conf</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">load_sysd_template_conf</span><span class="p">(</span><span class="n">module</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">            <span class="k">if</span> <span class="n">conf</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">                <span class="k">return</span> <span class="n">conf</span>
</span></span><span class="line"><span class="cl">            <span class="n">conf</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">load_sysv_unit_conf</span><span class="p">(</span><span class="n">module</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">            <span class="k">if</span> <span class="n">conf</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">                <span class="k">return</span> <span class="n">conf</span>
</span></span><span class="line"><span class="cl">        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">            <span class="n">logg</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&#34;</span><span class="si">%s</span><span class="s2"> not loaded: </span><span class="si">%s</span><span class="s2">&#34;</span><span class="p">,</span> <span class="n">module</span><span class="p">,</span> <span class="n">e</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="kc">None</span>
</span></span><span class="line"><span class="cl">    <span class="k">def</span> <span class="nf">default_unit_conf</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">module</span><span class="p">,</span> <span class="n">description</span> <span class="o">=</span> <span class="kc">None</span><span class="p">):</span> <span class="c1"># -&gt; conf</span>
</span></span><span class="line"><span class="cl">        <span class="s2">&#34;&#34;&#34; a unit conf that can be printed to the user where
</span></span></span><span class="line"><span class="cl"><span class="s2">            attributes are empty and loaded() is False &#34;&#34;&#34;</span>
</span></span><span class="line"><span class="cl">        <span class="n">data</span> <span class="o">=</span> <span class="n">UnitConfParser</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">        <span class="n">data</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="n">Unit</span><span class="p">,</span> <span class="s2">&#34;Description&#34;</span><span class="p">,</span> <span class="n">description</span> <span class="ow">or</span> <span class="p">(</span><span class="s2">&#34;NOT-FOUND &#34;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">module</span><span class="p">)))</span>
</span></span><span class="line"><span class="cl">        <span class="c1"># assert(not data.loaded())</span>
</span></span><span class="line"><span class="cl">        <span class="n">conf</span> <span class="o">=</span> <span class="n">SystemctlConf</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">module</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="n">conf</span><span class="o">.</span><span class="n">_root</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_root</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="n">conf</span>
</span></span><span class="line"><span class="cl">    <span class="k">def</span> <span class="nf">get_unit_conf</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">module</span><span class="p">):</span> <span class="c1"># -&gt; conf (conf | default-conf)</span>
</span></span><span class="line"><span class="cl">        <span class="s2">&#34;&#34;&#34; accept that a unit does not exist
</span></span></span><span class="line"><span class="cl"><span class="s2">            and return a unit conf that says &#39;not-loaded&#39; &#34;&#34;&#34;</span>
</span></span><span class="line"><span class="cl">        <span class="n">conf</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">load_unit_conf</span><span class="p">(</span><span class="n">module</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="n">conf</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">            <span class="k">return</span> <span class="n">conf</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">default_unit_conf</span><span class="p">(</span><span class="n">module</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="k">def</span> <span class="nf">get_unit_type</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">module</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">        <span class="n">name</span><span class="p">,</span> <span class="n">ext</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">splitext</span><span class="p">(</span><span class="n">module</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="n">ext</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&#34;.service&#34;</span><span class="p">,</span> <span class="s2">&#34;.socket&#34;</span><span class="p">,</span> <span class="s2">&#34;.target&#34;</span><span class="p">]:</span>
</span></span><span class="line"><span class="cl">            <span class="k">return</span> <span class="n">ext</span><span class="p">[</span><span class="mi">1</span><span class="p">:]</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="kc">None</span>
</span></span><span class="line"><span class="cl">    <span class="k">def</span> <span class="nf">get_unit_section</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">module</span><span class="p">,</span> <span class="n">default</span> <span class="o">=</span> <span class="n">Service</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="n">string</span><span class="o">.</span><span class="n">capwords</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">get_unit_type</span><span class="p">(</span><span class="n">module</span><span class="p">)</span> <span class="ow">or</span> <span class="n">default</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="k">def</span> <span class="nf">get_unit_section_from</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">conf</span><span class="p">,</span> <span class="n">default</span> <span class="o">=</span> <span class="n">Service</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_unit_section</span><span class="p">(</span><span class="n">conf</span><span class="o">.</span><span class="n">name</span><span class="p">(),</span> <span class="n">default</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="k">def</span> <span class="nf">match_sysd_templates</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">modules</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">suffix</span><span class="o">=</span><span class="s2">&#34;.service&#34;</span><span class="p">):</span> <span class="c1"># -&gt; generate[ unit ]</span>
</span></span><span class="line"><span class="cl">        <span class="s2">&#34;&#34;&#34; make a file glob on all known template units (systemd areas).
</span></span></span><span class="line"><span class="cl"><span class="s2">            It returns no modules (!!) if no modules pattern were given.
</span></span></span><span class="line"><span class="cl"><span class="s2">            The module string should contain an instance name already. &#34;&#34;&#34;</span>
</span></span><span class="line"><span class="cl">        <span class="n">modules</span> <span class="o">=</span> <span class="n">to_list</span><span class="p">(</span><span class="n">modules</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="ow">not</span> <span class="n">modules</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">            <span class="k">return</span>
</span></span><span class="line"><span class="cl">        <span class="bp">self</span><span class="o">.</span><span class="n">scan_unit_sysd_files</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">        <span class="k">assert</span> <span class="bp">self</span><span class="o">.</span><span class="n">_file_for_unit_sysd</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>
</span></span><span class="line"><span class="cl">        <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="nb">sorted</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_file_for_unit_sysd</span><span class="o">.</span><span class="n">keys</span><span class="p">()):</span>
</span></span><span class="line"><span class="cl">            <span class="k">if</span> <span class="s2">&#34;@&#34;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">item</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">                <span class="k">continue</span>
</span></span><span class="line"><span class="cl">            <span class="n">service_unit</span> <span class="o">=</span> <span class="n">parse_unit</span><span class="p">(</span><span class="n">item</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">            <span class="k">for</span> <span class="n">module</span> <span class="ow">in</span> <span class="n">modules</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">                <span class="k">if</span> <span class="s2">&#34;@&#34;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">module</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">                    <span class="k">continue</span>
</span></span><span class="line"><span class="cl">                <span class="n">module_unit</span> <span class="o">=</span> <span class="n">parse_unit</span><span class="p">(</span><span class="n">module</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">                <span class="k">if</span> <span class="n">service_unit</span><span class="o">.</span><span class="n">prefix</span> <span class="o">==</span> <span class="n">module_unit</span><span class="o">.</span><span class="n">prefix</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">                    <span class="k">yield</span> <span class="s2">&#34;</span><span class="si">%s</span><span class="s2">@</span><span class="si">%s</span><span class="s2">.</span><span class="si">%s</span><span class="s2">&#34;</span> <span class="o">%</span> <span class="p">(</span><span class="n">service_unit</span><span class="o">.</span><span class="n">prefix</span><span class="p">,</span> <span class="n">module_unit</span><span class="o">.</span><span class="n">instance</span><span class="p">,</span> <span class="n">service_unit</span><span class="o">.</span><span class="n">suffix</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="k">def</span> <span class="nf">match_sysd_units</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">modules</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">suffix</span><span class="o">=</span><span class="s2">&#34;.service&#34;</span><span class="p">):</span> <span class="c1"># -&gt; generate[ unit ]</span>
</span></span><span class="line"><span class="cl">        <span class="s2">&#34;&#34;&#34; make a file glob on all known units (systemd areas).
</span></span></span><span class="line"><span class="cl"><span class="s2">            It returns all modules if no modules pattern were given.
</span></span></span><span class="line"><span class="cl"><span class="s2">            Also a single string as one module pattern may be given. &#34;&#34;&#34;</span>
</span></span><span class="line"><span class="cl">        <span class="n">modules</span> <span class="o">=</span> <span class="n">to_list</span><span class="p">(</span><span class="n">modules</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="bp">self</span><span class="o">.</span><span class="n">scan_unit_sysd_files</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">        <span class="k">assert</span> <span class="bp">self</span><span class="o">.</span><span class="n">_file_for_unit_sysd</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>
</span></span><span class="line"><span class="cl">        <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="nb">sorted</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_file_for_unit_sysd</span><span class="o">.</span><span class="n">keys</span><span class="p">()):</span>
</span></span><span class="line"><span class="cl">            <span class="k">if</span> <span class="s2">&#34;.&#34;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">item</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">                <span class="k">pass</span>
</span></span><span class="line"><span class="cl">            <span class="k">elif</span> <span class="ow">not</span> <span class="n">modules</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">                <span class="k">yield</span> <span class="n">item</span>
</span></span><span class="line"><span class="cl">            <span class="k">elif</span> <span class="p">[</span><span class="n">module</span> <span class="k">for</span> <span class="n">module</span> <span class="ow">in</span> <span class="n">modules</span> <span class="k">if</span> <span class="n">fnmatch</span><span class="o">.</span><span class="n">fnmatchcase</span><span class="p">(</span><span class="n">item</span><span class="p">,</span> <span class="n">module</span><span class="p">)]:</span>
</span></span><span class="line"><span class="cl">                <span class="k">yield</span> <span class="n">item</span>
</span></span><span class="line"><span class="cl">            <span class="k">elif</span> <span class="p">[</span><span class="n">module</span> <span class="k">for</span> <span class="n">module</span> <span class="ow">in</span> <span class="n">modules</span> <span class="k">if</span> <span class="n">module</span><span class="o">+</span><span class="n">suffix</span> <span class="o">==</span> <span class="n">item</span><span class="p">]:</span>
</span></span><span class="line"><span class="cl">                <span class="k">yield</span> <span class="n">item</span>
</span></span><span class="line"><span class="cl">    <span class="k">def</span> <span class="nf">match_sysv_units</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">modules</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">suffix</span><span class="o">=</span><span class="s2">&#34;.service&#34;</span><span class="p">):</span> <span class="c1"># -&gt; generate[ unit ]</span>
</span></span><span class="line"><span class="cl">        <span class="s2">&#34;&#34;&#34; make a file glob on all known units (sysv areas).
</span></span></span><span class="line"><span class="cl"><span class="s2">            It returns all modules if no modules pattern were given.
</span></span></span><span class="line"><span class="cl"><span class="s2">            Also a single string as one module pattern may be given. &#34;&#34;&#34;</span>
</span></span><span class="line"><span class="cl">        <span class="n">modules</span> <span class="o">=</span> <span class="n">to_list</span><span class="p">(</span><span class="n">modules</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="bp">self</span><span class="o">.</span><span class="n">scan_unit_sysv_files</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">        <span class="k">assert</span> <span class="bp">self</span><span class="o">.</span><span class="n">_file_for_unit_sysv</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>
</span></span><span class="line"><span class="cl">        <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="nb">sorted</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_file_for_unit_sysv</span><span class="o">.</span><span class="n">keys</span><span class="p">()):</span>
</span></span><span class="line"><span class="cl">            <span class="k">if</span> <span class="ow">not</span> <span class="n">modules</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">                <span class="k">yield</span> <span class="n">item</span>
</span></span><span class="line"><span class="cl">            <span class="k">elif</span> <span class="p">[</span><span class="n">module</span> <span class="k">for</span> <span class="n">module</span> <span class="ow">in</span> <span class="n">modules</span> <span class="k">if</span> <span class="n">fnmatch</span><span class="o">.</span><span class="n">fnmatchcase</span><span class="p">(</span><span class="n">item</span><span class="p">,</span> <span class="n">module</span><span class="p">)]:</span>
</span></span><span class="line"><span class="cl">                <span class="k">yield</span> <span class="n">item</span>
</span></span><span class="line"><span class="cl">            <span class="k">elif</span> <span class="p">[</span><span class="n">module</span> <span class="k">for</span> <span class="n">module</span> <span class="ow">in</span> <span class="n">modules</span> <span class="k">if</span> <span class="n">module</span><span class="o">+</span><span class="n">suffix</span> <span class="o">==</span> <span class="n">item</span><span class="p">]:</span>
</span></span><span class="line"><span class="cl">                <span class="k">yield</span> <span class="n">item</span>
</span></span><span class="line"><span class="cl">    <span class="k">def</span> <span class="nf">match_units</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">modules</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">suffix</span><span class="o">=</span><span class="s2">&#34;.service&#34;</span><span class="p">):</span> <span class="c1"># -&gt; [ units,.. ]</span>
</span></span><span class="line"><span class="cl">        <span class="s2">&#34;&#34;&#34; Helper for about any command with multiple units which can
</span></span></span><span class="line"><span class="cl"><span class="s2">            actually be glob patterns on their respective unit name.
</span></span></span><span class="line"><span class="cl"><span class="s2">            It returns all modules if no modules pattern were given.
</span></span></span><span class="line"><span class="cl"><span class="s2">            Also a single string as one module pattern may be given. &#34;&#34;&#34;</span>
</span></span><span class="line"><span class="cl">        <span class="n">found</span> <span class="o">=</span> <span class="p">[]</span>
</span></span><span class="line"><span class="cl">        <span class="k">for</span> <span class="n">unit</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">match_sysd_units</span><span class="p">(</span><span class="n">modules</span><span class="p">,</span> <span class="n">suffix</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">            <span class="k">if</span> <span class="n">unit</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">found</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">                <span class="n">found</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">unit</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="k">for</span> <span class="n">unit</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">match_sysd_templates</span><span class="p">(</span><span class="n">modules</span><span class="p">,</span> <span class="n">suffix</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">            <span class="k">if</span> <span class="n">unit</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">found</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">                <span class="n">found</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">unit</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="k">for</span> <span class="n">unit</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">match_sysv_units</span><span class="p">(</span><span class="n">modules</span><span class="p">,</span> <span class="n">suffix</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">            <span class="k">if</span> <span class="n">unit</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">found</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">                <span class="n">found</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">unit</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="n">found</span>
</span></span><span class="line"><span class="cl">    <span class="k">def</span> <span class="nf">list_service_unit_basics</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">        <span class="s2">&#34;&#34;&#34; show all the basic loading state of services &#34;&#34;&#34;</span>
</span></span><span class="line"><span class="cl">        <span class="n">filename</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">unit_file</span><span class="p">()</span> <span class="c1"># scan all</span>
</span></span><span class="line"><span class="cl">        <span class="k">assert</span> <span class="bp">self</span><span class="o">.</span><span class="n">_file_for_unit_sysd</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>
</span></span><span class="line"><span class="cl">        <span class="k">assert</span> <span class="bp">self</span><span class="o">.</span><span class="n">_file_for_unit_sysv</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>
</span></span><span class="line"><span class="cl">        <span class="n">result</span> <span class="o">=</span> <span class="p">[]</span>
</span></span><span class="line"><span class="cl">        <span class="k">for</span> <span class="n">name</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_file_for_unit_sysd</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
</span></span><span class="line"><span class="cl">            <span class="n">result</span> <span class="o">+=</span> <span class="p">[(</span><span class="n">name</span><span class="p">,</span> <span class="s2">&#34;SysD&#34;</span><span class="p">,</span> <span class="n">value</span><span class="p">)]</span>
</span></span><span class="line"><span class="cl">        <span class="k">for</span> <span class="n">name</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_file_for_unit_sysv</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
</span></span><span class="line"><span class="cl">            <span class="n">result</span> <span class="o">+=</span> <span class="p">[(</span><span class="n">name</span><span class="p">,</span> <span class="s2">&#34;SysV&#34;</span><span class="p">,</span> <span class="n">value</span><span class="p">)]</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="n">result</span>
</span></span><span class="line"><span class="cl">    <span class="k">def</span> <span class="nf">list_service_units</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">modules</span><span class="p">):</span> <span class="c1"># -&gt; [ (unit,loaded+active+substate,description) ]</span>
</span></span><span class="line"><span class="cl">        <span class="s2">&#34;&#34;&#34; show all the service units &#34;&#34;&#34;</span>
</span></span><span class="line"><span class="cl">        <span class="n">result</span> <span class="o">=</span> <span class="p">{}</span>
</span></span><span class="line"><span class="cl">        <span class="n">active</span> <span class="o">=</span> <span class="p">{}</span>
</span></span><span class="line"><span class="cl">        <span class="n">substate</span> <span class="o">=</span> <span class="p">{}</span>
</span></span><span class="line"><span class="cl">        <span class="n">description</span> <span class="o">=</span> <span class="p">{}</span>
</span></span><span class="line"><span class="cl">        <span class="k">for</span> <span class="n">unit</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">match_units</span><span class="p">(</span><span class="n">to_list</span><span class="p">(</span><span class="n">modules</span><span class="p">)):</span>
</span></span><span class="line"><span class="cl">            <span class="n">result</span><span class="p">[</span><span class="n">unit</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&#34;not-found&#34;</span>
</span></span><span class="line"><span class="cl">            <span class="n">active</span><span class="p">[</span><span class="n">unit</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&#34;inactive&#34;</span>
</span></span><span class="line"><span class="cl">            <span class="n">substate</span><span class="p">[</span><span class="n">unit</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&#34;dead&#34;</span>
</span></span><span class="line"><span class="cl">            <span class="n">description</span><span class="p">[</span><span class="n">unit</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&#34;&#34;</span>
</span></span><span class="line"><span class="cl">            <span class="k">try</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">                <span class="n">conf</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_unit_conf</span><span class="p">(</span><span class="n">unit</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">                <span class="n">result</span><span class="p">[</span><span class="n">unit</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&#34;loaded&#34;</span>
</span></span><span class="line"><span class="cl">                <span class="n">description</span><span class="p">[</span><span class="n">unit</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_description_from</span><span class="p">(</span><span class="n">conf</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">                <span class="n">active</span><span class="p">[</span><span class="n">unit</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_active_from</span><span class="p">(</span><span class="n">conf</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">                <span class="n">substate</span><span class="p">[</span><span class="n">unit</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_substate_from</span><span class="p">(</span><span class="n">conf</span><span class="p">)</span> <span class="ow">or</span> <span class="s2">&#34;unknown&#34;</span>
</span></span><span class="line"><span class="cl">            <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">                <span class="n">logg</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&#34;list-units: </span><span class="si">%s</span><span class="s2">&#34;</span><span class="p">,</span> <span class="n">e</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_only_state</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">                <span class="k">if</span> <span class="n">result</span><span class="p">[</span><span class="n">unit</span><span class="p">]</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_only_state</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">                    <span class="k">pass</span>
</span></span><span class="line"><span class="cl">                <span class="k">elif</span> <span class="n">active</span><span class="p">[</span><span class="n">unit</span><span class="p">]</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_only_state</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">                    <span class="k">pass</span>
</span></span><span class="line"><span class="cl">                <span class="k">elif</span> <span class="n">substate</span><span class="p">[</span><span class="n">unit</span><span class="p">]</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_only_state</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">                    <span class="k">pass</span>
</span></span><span class="line"><span class="cl">                <span class="k">else</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">                    <span class="k">del</span> <span class="n">result</span><span class="p">[</span><span class="n">unit</span><span class="p">]</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="p">[(</span><span class="n">unit</span><span class="p">,</span> <span class="n">result</span><span class="p">[</span><span class="n">unit</span><span class="p">]</span> <span class="o">+</span> <span class="s2">&#34; &#34;</span> <span class="o">+</span> <span class="n">active</span><span class="p">[</span><span class="n">unit</span><span class="p">]</span> <span class="o">+</span> <span class="s2">&#34; &#34;</span> <span class="o">+</span> <span class="n">substate</span><span class="p">[</span><span class="n">unit</span><span class="p">],</span> <span class="n">description</span><span class="p">[</span><span class="n">unit</span><span class="p">])</span> <span class="k">for</span> <span class="n">unit</span> <span class="ow">in</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">result</span><span class="p">)]</span>
</span></span><span class="line"><span class="cl">    <span class="k">def</span> <span class="nf">list_units_modules</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">modules</span><span class="p">):</span> <span class="c1"># -&gt; [ (unit,loaded,description) ]</span>
</span></span><span class="line"><span class="cl">        <span class="s2">&#34;&#34;&#34; [PATTERN]... -- List loaded units.
</span></span></span><span class="line"><span class="cl"><span class="s2">        If one or more PATTERNs are specified, only units matching one of
</span></span></span><span class="line"><span class="cl"><span class="s2">        them are shown. NOTE: This is the default command.&#34;&#34;&#34;</span>
</span></span><span class="line"><span class="cl">        <span class="n">hint</span> <span class="o">=</span> <span class="s2">&#34;To show all installed unit files use &#39;systemctl list-unit-files&#39;.&#34;</span>
</span></span><span class="line"><span class="cl">        <span class="n">result</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">list_service_units</span><span class="p">(</span><span class="o">*</span><span class="n">modules</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_no_legend</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">            <span class="k">return</span> <span class="n">result</span>
</span></span><span class="line"><span class="cl">        <span class="n">found</span> <span class="o">=</span> <span class="s2">&#34;</span><span class="si">%s</span><span class="s2"> loaded units listed.&#34;</span> <span class="o">%</span> <span class="nb">len</span><span class="p">(</span><span class="n">result</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="n">result</span> <span class="o">+</span> <span class="p">[(</span><span class="s2">&#34;&#34;</span><span class="p">,</span> <span class="s2">&#34;&#34;</span><span class="p">,</span> <span class="s2">&#34;&#34;</span><span class="p">),</span> <span class="p">(</span><span class="n">found</span><span class="p">,</span> <span class="s2">&#34;&#34;</span><span class="p">,</span> <span class="s2">&#34;&#34;</span><span class="p">),</span> <span class="p">(</span><span class="n">hint</span><span class="p">,</span> <span class="s2">&#34;&#34;</span><span class="p">,</span> <span class="s2">&#34;&#34;</span><span class="p">)]</span>
</span></span><span class="line"><span class="cl">    <span class="k">def</span> <span class="nf">list_service_unit_files</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">modules</span><span class="p">):</span> <span class="c1"># -&gt; [ (unit,enabled) ]</span>
</span></span><span class="line"><span class="cl">        <span class="s2">&#34;&#34;&#34; show all the service units and the enabled status&#34;&#34;&#34;</span>
</span></span><span class="line"><span class="cl">        <span class="n">logg</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&#34;list service unit files for </span><span class="si">%s</span><span class="s2">&#34;</span><span class="p">,</span> <span class="n">modules</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="n">result</span> <span class="o">=</span> <span class="p">{}</span>
</span></span><span class="line"><span class="cl">        <span class="n">enabled</span> <span class="o">=</span> <span class="p">{}</span>
</span></span><span class="line"><span class="cl">        <span class="k">for</span> <span class="n">unit</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">match_units</span><span class="p">(</span><span class="n">to_list</span><span class="p">(</span><span class="n">modules</span><span class="p">)):</span>
</span></span><span class="line"><span class="cl">            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_only_type</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_unit_type</span><span class="p">(</span><span class="n">unit</span><span class="p">)</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_only_type</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">                <span class="k">continue</span>
</span></span><span class="line"><span class="cl">            <span class="n">result</span><span class="p">[</span><span class="n">unit</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
</span></span><span class="line"><span class="cl">            <span class="n">enabled</span><span class="p">[</span><span class="n">unit</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&#34;&#34;</span>
</span></span><span class="line"><span class="cl">            <span class="k">try</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">                <span class="n">conf</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_unit_conf</span><span class="p">(</span><span class="n">unit</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">not_user_conf</span><span class="p">(</span><span class="n">conf</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">                    <span class="n">result</span><span class="p">[</span><span class="n">unit</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
</span></span><span class="line"><span class="cl">                    <span class="k">continue</span>
</span></span><span class="line"><span class="cl">                <span class="n">result</span><span class="p">[</span><span class="n">unit</span><span class="p">]</span> <span class="o">=</span> <span class="n">conf</span>
</span></span><span class="line"><span class="cl">                <span class="n">enabled</span><span class="p">[</span><span class="n">unit</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">enabled_from</span><span class="p">(</span><span class="n">conf</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">            <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">                <span class="n">logg</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&#34;list-units: </span><span class="si">%s</span><span class="s2">&#34;</span><span class="p">,</span> <span class="n">e</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="p">[(</span><span class="n">unit</span><span class="p">,</span> <span class="n">enabled</span><span class="p">[</span><span class="n">unit</span><span class="p">])</span> <span class="k">for</span> <span class="n">unit</span> <span class="ow">in</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">result</span><span class="p">)</span> <span class="k">if</span> <span class="n">result</span><span class="p">[</span><span class="n">unit</span><span class="p">]]</span>
</span></span><span class="line"><span class="cl">    <span class="k">def</span> <span class="nf">each_target_file</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">        <span class="n">folders</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">system_folders</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">user_mode</span><span class="p">():</span>
</span></span><span class="line"><span class="cl">            <span class="n">folders</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">user_folders</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">        <span class="k">for</span> <span class="n">folder1</span> <span class="ow">in</span> <span class="n">folders</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">            <span class="n">folder</span> <span class="o">=</span> <span class="n">os_path</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_root</span><span class="p">,</span> <span class="n">folder1</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">            <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isdir</span><span class="p">(</span><span class="n">folder</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">                <span class="k">continue</span>
</span></span><span class="line"><span class="cl">            <span class="k">for</span> <span class="n">filename</span> <span class="ow">in</span> <span class="n">os</span><span class="o">.</span><span class="n">listdir</span><span class="p">(</span><span class="n">folder</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">                <span class="k">if</span> <span class="n">filename</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s2">&#34;.target&#34;</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">                    <span class="k">yield</span> <span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">folder</span><span class="p">,</span> <span class="n">filename</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">    <span class="k">def</span> <span class="nf">list_target_unit_files</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">modules</span><span class="p">):</span> <span class="c1"># -&gt; [ (unit,enabled) ]</span>
</span></span><span class="line"><span class="cl">        <span class="s2">&#34;&#34;&#34; show all the target units and the enabled status&#34;&#34;&#34;</span>
</span></span><span class="line"><span class="cl">        <span class="n">enabled</span> <span class="o">=</span> <span class="p">{}</span>
</span></span><span class="line"><span class="cl">        <span class="n">targets</span> <span class="o">=</span> <span class="p">{}</span>
</span></span><span class="line"><span class="cl">        <span class="k">for</span> <span class="n">target</span><span class="p">,</span> <span class="n">filepath</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">each_target_file</span><span class="p">():</span>
</span></span><span class="line"><span class="cl">            <span class="n">logg</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&#34;target </span><span class="si">%s</span><span class="s2">&#34;</span><span class="p">,</span> <span class="n">filepath</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">            <span class="n">targets</span><span class="p">[</span><span class="n">target</span><span class="p">]</span> <span class="o">=</span> <span class="n">filepath</span>
</span></span><span class="line"><span class="cl">            <span class="n">enabled</span><span class="p">[</span><span class="n">target</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&#34;static&#34;</span>
</span></span><span class="line"><span class="cl">        <span class="k">for</span> <span class="n">unit</span> <span class="ow">in</span> <span class="n">_all_common_targets</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">            <span class="n">targets</span><span class="p">[</span><span class="n">unit</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
</span></span><span class="line"><span class="cl">            <span class="n">enabled</span><span class="p">[</span><span class="n">unit</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&#34;static&#34;</span>
</span></span><span class="line"><span class="cl">            <span class="k">if</span> <span class="n">unit</span> <span class="ow">in</span> <span class="n">_all_common_enabled</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">                <span class="n">enabled</span><span class="p">[</span><span class="n">unit</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&#34;enabled&#34;</span>
</span></span><span class="line"><span class="cl">            <span class="k">if</span> <span class="n">unit</span> <span class="ow">in</span> <span class="n">_all_common_disabled</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">                <span class="n">enabled</span><span class="p">[</span><span class="n">unit</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&#34;disabled&#34;</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="p">[(</span><span class="n">unit</span><span class="p">,</span> <span class="n">enabled</span><span class="p">[</span><span class="n">unit</span><span class="p">])</span> <span class="k">for</span> <span class="n">unit</span> <span class="ow">in</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">targets</span><span class="p">)]</span>
</span></span><span class="line"><span class="cl">    <span class="k">def</span> <span class="nf">list_unit_files_modules</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">modules</span><span class="p">):</span> <span class="c1"># -&gt; [ (unit,enabled) ]</span>
</span></span><span class="line"><span class="cl">        <span class="s2">&#34;&#34;&#34;[PATTERN]... -- List installed unit files
</span></span></span><span class="line"><span class="cl"><span class="s2">        List installed unit files and their enablement state (as reported
</span></span></span><span class="line"><span class="cl"><span class="s2">        by is-enabled). If one or more PATTERNs are specified, only units
</span></span></span><span class="line"><span class="cl"><span class="s2">        whose filename (just the last component of the path) matches one of
</span></span></span><span class="line"><span class="cl"><span class="s2">        them are shown. This command reacts to limitations of --type being
</span></span></span><span class="line"><span class="cl"><span class="s2">        --type=service or --type=target (and --now for some basics).&#34;&#34;&#34;</span>
</span></span><span class="line"><span class="cl">        <span class="n">result</span> <span class="o">=</span> <span class="p">[]</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_now</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">            <span class="n">basics</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">list_service_unit_basics</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">            <span class="n">result</span> <span class="o">=</span> <span class="p">[(</span><span class="n">name</span><span class="p">,</span> <span class="n">sysv</span> <span class="o">+</span> <span class="s2">&#34; &#34;</span> <span class="o">+</span> <span class="n">filename</span><span class="p">)</span> <span class="k">for</span> <span class="n">name</span><span class="p">,</span> <span class="n">sysv</span><span class="p">,</span> <span class="n">filename</span> <span class="ow">in</span> <span class="n">basics</span><span class="p">]</span>
</span></span><span class="line"><span class="cl">        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">_only_type</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">            <span class="k">if</span> <span class="s2">&#34;target&#34;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_only_type</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">                <span class="n">result</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">list_target_unit_files</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">            <span class="k">if</span> <span class="s2">&#34;service&#34;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_only_type</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">                <span class="n">result</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">list_service_unit_files</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">        <span class="k">else</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">            <span class="n">result</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">list_target_unit_files</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">            <span class="n">result</span> <span class="o">+=</span> <span class="bp">self</span><span class="o">.</span><span class="n">list_service_unit_files</span><span class="p">(</span><span class="o">*</span><span class="n">modules</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_no_legend</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">            <span class="k">return</span> <span class="n">result</span>
</span></span><span class="line"><span class="cl">        <span class="n">found</span> <span class="o">=</span> <span class="s2">&#34;</span><span class="si">%s</span><span class="s2"> unit files listed.&#34;</span> <span class="o">%</span> <span class="nb">len</span><span class="p">(</span><span class="n">result</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="p">[(</span><span class="s2">&#34;UNIT FILE&#34;</span><span class="p">,</span> <span class="s2">&#34;STATE&#34;</span><span class="p">)]</span> <span class="o">+</span> <span class="n">result</span> <span class="o">+</span> <span class="p">[(</span><span class="s2">&#34;&#34;</span><span class="p">,</span> <span class="s2">&#34;&#34;</span><span class="p">),</span> <span class="p">(</span><span class="n">found</span><span class="p">,</span> <span class="s2">&#34;&#34;</span><span class="p">)]</span>
</span></span><span class="line"><span class="cl">    <span class="c1">##</span>
</span></span><span class="line"><span class="cl">    <span class="c1">##</span>
</span></span><span class="line"><span class="cl">    <span class="k">def</span> <span class="nf">get_description</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">unit</span><span class="p">,</span> <span class="n">default</span> <span class="o">=</span> <span class="kc">None</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_description_from</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">load_unit_conf</span><span class="p">(</span><span class="n">unit</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">    <span class="k">def</span> <span class="nf">get_description_from</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">conf</span><span class="p">,</span> <span class="n">default</span> <span class="o">=</span> <span class="kc">None</span><span class="p">):</span> <span class="c1"># -&gt; text</span>
</span></span><span class="line"><span class="cl">        <span class="s2">&#34;&#34;&#34; Unit.Description could be empty sometimes &#34;&#34;&#34;</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="ow">not</span> <span class="n">conf</span><span class="p">:</span> <span class="k">return</span> <span class="n">default</span> <span class="ow">or</span> <span class="s2">&#34;&#34;</span>
</span></span><span class="line"><span class="cl">        <span class="n">description</span> <span class="o">=</span> <span class="n">conf</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">Unit</span><span class="p">,</span> <span class="s2">&#34;Description&#34;</span><span class="p">,</span> <span class="n">default</span> <span class="ow">or</span> <span class="s2">&#34;&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">expand_special</span><span class="p">(</span><span class="n">description</span><span class="p">,</span> <span class="n">conf</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="k">def</span> <span class="nf">read_pid_file</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">pid_file</span><span class="p">,</span> <span class="n">default</span> <span class="o">=</span> <span class="kc">None</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">        <span class="n">pid</span> <span class="o">=</span> <span class="n">default</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="ow">not</span> <span class="n">pid_file</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">            <span class="k">return</span> <span class="n">default</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isfile</span><span class="p">(</span><span class="n">pid_file</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">            <span class="k">return</span> <span class="n">default</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">truncate_old</span><span class="p">(</span><span class="n">pid_file</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">            <span class="k">return</span> <span class="n">default</span>
</span></span><span class="line"><span class="cl">        <span class="k">try</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">            <span class="c1"># some pid-files from applications contain multiple lines</span>
</span></span><span class="line"><span class="cl">            <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">pid_file</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">                <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">f</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">                    <span class="k">if</span> <span class="n">line</span><span class="o">.</span><span class="n">strip</span><span class="p">():</span>
</span></span><span class="line"><span class="cl">                        <span class="n">pid</span> <span class="o">=</span> <span class="n">to_intN</span><span class="p">(</span><span class="n">line</span><span class="o">.</span><span class="n">strip</span><span class="p">())</span>
</span></span><span class="line"><span class="cl">                        <span class="k">break</span>
</span></span><span class="line"><span class="cl">        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">            <span class="n">logg</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&#34;bad read of pid file &#39;</span><span class="si">%s</span><span class="s2">&#39;: </span><span class="si">%s</span><span class="s2">&#34;</span><span class="p">,</span> <span class="n">pid_file</span><span class="p">,</span> <span class="n">e</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="n">pid</span>
</span></span><span class="line"><span class="cl">    <span class="k">def</span> <span class="nf">wait_pid_file</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">pid_file</span><span class="p">,</span> <span class="n">timeout</span> <span class="o">=</span> <span class="kc">None</span><span class="p">):</span> <span class="c1"># -&gt; pid?</span>
</span></span><span class="line"><span class="cl">        <span class="s2">&#34;&#34;&#34; wait some seconds for the pid file to appear and return the pid &#34;&#34;&#34;</span>
</span></span><span class="line"><span class="cl">        <span class="n">timeout</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">timeout</span> <span class="ow">or</span> <span class="p">(</span><span class="n">DefaultTimeoutStartSec</span><span class="o">/</span><span class="mi">2</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">        <span class="n">timeout</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">timeout</span><span class="p">,</span> <span class="p">(</span><span class="n">MinimumTimeoutStartSec</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">        <span class="n">dirpath</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">abspath</span><span class="p">(</span><span class="n">pid_file</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">        <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">xrange</span><span class="p">(</span><span class="n">timeout</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">            <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isdir</span><span class="p">(</span><span class="n">dirpath</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">                <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="c1"># until TimeoutStartSec/2</span>
</span></span><span class="line"><span class="cl">                <span class="k">continue</span>
</span></span><span class="line"><span class="cl">            <span class="n">pid</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">read_pid_file</span><span class="p">(</span><span class="n">pid_file</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">            <span class="k">if</span> <span class="ow">not</span> <span class="n">pid</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">                <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="c1"># until TimeoutStartSec/2</span>
</span></span><span class="line"><span class="cl">                <span class="k">continue</span>
</span></span><span class="line"><span class="cl">            <span class="k">if</span> <span class="ow">not</span> <span class="n">pid_exists</span><span class="p">(</span><span class="n">pid</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">                <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="c1"># until TimeoutStartSec/2</span>
</span></span><span class="line"><span class="cl">                <span class="k">continue</span>
</span></span><span class="line"><span class="cl">            <span class="k">return</span> <span class="n">pid</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="kc">None</span>
</span></span><span class="line"><span class="cl">    <span class="k">def</span> <span class="nf">get_status_pid_file</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">unit</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">        <span class="s2">&#34;&#34;&#34; actual file path of pid file (internal) &#34;&#34;&#34;</span>
</span></span><span class="line"><span class="cl">        <span class="n">conf</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_unit_conf</span><span class="p">(</span><span class="n">unit</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">pid_file_from</span><span class="p">(</span><span class="n">conf</span><span class="p">)</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_status_file_from</span><span class="p">(</span><span class="n">conf</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="k">def</span> <span class="nf">pid_file_from</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">conf</span><span class="p">,</span> <span class="n">default</span> <span class="o">=</span> <span class="s2">&#34;&#34;</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">        <span class="s2">&#34;&#34;&#34; get the specified pid file path (not a computed default) &#34;&#34;&#34;</span>
</span></span><span class="line"><span class="cl">        <span class="n">pid_file</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_pid_file</span><span class="p">(</span><span class="n">conf</span><span class="p">)</span> <span class="ow">or</span> <span class="n">default</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="n">os_path</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_root</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">expand_special</span><span class="p">(</span><span class="n">pid_file</span><span class="p">,</span> <span class="n">conf</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">    <span class="k">def</span> <span class="nf">get_pid_file</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">conf</span><span class="p">,</span> <span class="n">default</span> <span class="o">=</span> <span class="kc">None</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="n">conf</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">Service</span><span class="p">,</span> <span class="s2">&#34;PIDFile&#34;</span><span class="p">,</span> <span class="n">default</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="k">def</span> <span class="nf">read_mainpid_from</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">conf</span><span class="p">,</span> <span class="n">default</span> <span class="o">=</span> <span class="kc">None</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">        <span class="s2">&#34;&#34;&#34; MAINPID is either the PIDFile content written from the application
</span></span></span><span class="line"><span class="cl"><span class="s2">            or it is the value in the status file written by this systemctl.py code &#34;&#34;&#34;</span>
</span></span><span class="line"><span class="cl">        <span class="n">pid_file</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">pid_file_from</span><span class="p">(</span><span class="n">conf</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="n">pid_file</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">read_pid_file</span><span class="p">(</span><span class="n">pid_file</span><span class="p">,</span> <span class="n">default</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="n">status</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">read_status_from</span><span class="p">(</span><span class="n">conf</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="s2">&#34;MainPID&#34;</span> <span class="ow">in</span> <span class="n">status</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">            <span class="k">return</span> <span class="n">to_intN</span><span class="p">(</span><span class="n">status</span><span class="p">[</span><span class="s2">&#34;MainPID&#34;</span><span class="p">],</span> <span class="n">default</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="n">default</span>
</span></span><span class="line"><span class="cl">    <span class="k">def</span> <span class="nf">clean_pid_file_from</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">conf</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">        <span class="n">pid_file</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">pid_file_from</span><span class="p">(</span><span class="n">conf</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="n">pid_file</span> <span class="ow">and</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isfile</span><span class="p">(</span><span class="n">pid_file</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">            <span class="k">try</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">                <span class="n">os</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">pid_file</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">            <span class="k">except</span> <span class="ne">OSError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">                <span class="n">logg</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&#34;while rm </span><span class="si">%s</span><span class="s2">: </span><span class="si">%s</span><span class="s2">&#34;</span><span class="p">,</span> <span class="n">pid_file</span><span class="p">,</span> <span class="n">e</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="bp">self</span><span class="o">.</span><span class="n">write_status_from</span><span class="p">(</span><span class="n">conf</span><span class="p">,</span> <span class="n">MainPID</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="k">def</span> <span class="nf">get_status_file</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">unit</span><span class="p">):</span> <span class="c1"># for testing</span>
</span></span><span class="line"><span class="cl">        <span class="n">conf</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_unit_conf</span><span class="p">(</span><span class="n">unit</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_status_file_from</span><span class="p">(</span><span class="n">conf</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="k">def</span> <span class="nf">get_status_file_from</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">conf</span><span class="p">,</span> <span class="n">default</span> <span class="o">=</span> <span class="kc">None</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">        <span class="n">status_file</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_StatusFile</span><span class="p">(</span><span class="n">conf</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="c1"># this not a real setting, but do the expand_special anyway</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="n">os_path</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_root</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">expand_special</span><span class="p">(</span><span class="n">status_file</span><span class="p">,</span> <span class="n">conf</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">    <span class="k">def</span> <span class="nf">get_StatusFile</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">conf</span><span class="p">,</span> <span class="n">default</span> <span class="o">=</span> <span class="kc">None</span><span class="p">):</span> <span class="c1"># -&gt; text</span>
</span></span><span class="line"><span class="cl">        <span class="s2">&#34;&#34;&#34; file where to store a status mark &#34;&#34;&#34;</span>
</span></span><span class="line"><span class="cl">        <span class="n">status_file</span> <span class="o">=</span> <span class="n">conf</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">Service</span><span class="p">,</span> <span class="s2">&#34;StatusFile&#34;</span><span class="p">,</span> <span class="n">default</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="n">status_file</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">            <span class="k">return</span> <span class="n">status_file</span>
</span></span><span class="line"><span class="cl">        <span class="n">root</span> <span class="o">=</span> <span class="n">conf</span><span class="o">.</span><span class="n">root_mode</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">        <span class="n">folder</span> <span class="o">=</span> <span class="n">get_PID_DIR</span><span class="p">(</span><span class="n">root</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="n">name</span> <span class="o">=</span> <span class="s2">&#34;</span><span class="si">%s</span><span class="s2">.status&#34;</span> <span class="o">%</span> <span class="n">conf</span><span class="o">.</span><span class="n">name</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">folder</span><span class="p">,</span> <span class="n">name</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="k">def</span> <span class="nf">clean_status_from</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">conf</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">        <span class="n">status_file</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_status_file_from</span><span class="p">(</span><span class="n">conf</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">status_file</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">            <span class="n">os</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">status_file</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="n">conf</span><span class="o">.</span><span class="n">status</span> <span class="o">=</span> <span class="p">{}</span>
</span></span><span class="line"><span class="cl">    <span class="k">def</span> <span class="nf">write_status_from</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">conf</span><span class="p">,</span> <span class="o">**</span><span class="n">status</span><span class="p">):</span> <span class="c1"># -&gt; bool(written)</span>
</span></span><span class="line"><span class="cl">        <span class="s2">&#34;&#34;&#34; if a status_file is known then path is created and the
</span></span></span><span class="line"><span class="cl"><span class="s2">            give status is written as the only content. &#34;&#34;&#34;</span>
</span></span><span class="line"><span class="cl">        <span class="n">status_file</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_status_file_from</span><span class="p">(</span><span class="n">conf</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="c1"># if not status_file: return False</span>
</span></span><span class="line"><span class="cl">        <span class="n">dirpath</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">abspath</span><span class="p">(</span><span class="n">status_file</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isdir</span><span class="p">(</span><span class="n">dirpath</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">            <span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="n">dirpath</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="n">conf</span><span class="o">.</span><span class="n">status</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">            <span class="n">conf</span><span class="o">.</span><span class="n">status</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">read_status_from</span><span class="p">(</span><span class="n">conf</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="kc">True</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">            <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">status</span><span class="o">.</span><span class="n">keys</span><span class="p">()):</span>
</span></span><span class="line"><span class="cl">                <span class="n">value</span> <span class="o">=</span> <span class="n">status</span><span class="p">[</span><span class="n">key</span><span class="p">]</span>
</span></span><span class="line"><span class="cl">                <span class="k">if</span> <span class="n">key</span><span class="o">.</span><span class="n">upper</span><span class="p">()</span> <span class="o">==</span> <span class="s2">&#34;AS&#34;</span><span class="p">:</span> <span class="n">key</span> <span class="o">=</span> <span class="s2">&#34;ActiveState&#34;</span>
</span></span><span class="line"><span class="cl">                <span class="k">if</span> <span class="n">key</span><span class="o">.</span><span class="n">upper</span><span class="p">()</span> <span class="o">==</span> <span class="s2">&#34;EXIT&#34;</span><span class="p">:</span> <span class="n">key</span> <span class="o">=</span> <span class="s2">&#34;ExecMainCode&#34;</span>
</span></span><span class="line"><span class="cl">                <span class="k">if</span> <span class="n">value</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">                    <span class="k">try</span><span class="p">:</span> <span class="k">del</span> <span class="n">conf</span><span class="o">.</span><span class="n">status</span><span class="p">[</span><span class="n">key</span><span class="p">]</span>
</span></span><span class="line"><span class="cl">                    <span class="k">except</span> <span class="ne">KeyError</span><span class="p">:</span> <span class="k">pass</span>
</span></span><span class="line"><span class="cl">                <span class="k">else</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">                    <span class="n">conf</span><span class="o">.</span><span class="n">status</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">strE</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="k">try</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">            <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">status_file</span><span class="p">,</span> <span class="s2">&#34;w&#34;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">                <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">conf</span><span class="o">.</span><span class="n">status</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">                    <span class="n">value</span> <span class="o">=</span> <span class="n">conf</span><span class="o">.</span><span class="n">status</span><span class="p">[</span><span class="n">key</span><span class="p">]</span>
</span></span><span class="line"><span class="cl">                    <span class="k">if</span> <span class="n">key</span> <span class="o">==</span> <span class="s2">&#34;MainPID&#34;</span> <span class="ow">and</span> <span class="nb">str</span><span class="p">(</span><span class="n">value</span><span class="p">)</span> <span class="o">==</span> <span class="s2">&#34;0&#34;</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">                        <span class="n">logg</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&#34;ignore writing MainPID=0&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">                        <span class="k">continue</span>
</span></span><span class="line"><span class="cl">                    <span class="n">content</span> <span class="o">=</span> <span class="s2">&#34;</span><span class="si">{}</span><span class="s2">=</span><span class="si">{}</span><span class="se">\n</span><span class="s2">&#34;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">value</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">                    <span class="n">logg</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&#34;writing to </span><span class="si">%s</span><span class="se">\n\t</span><span class="si">%s</span><span class="s2">&#34;</span><span class="p">,</span> <span class="n">status_file</span><span class="p">,</span> <span class="n">content</span><span class="o">.</span><span class="n">strip</span><span class="p">())</span>
</span></span><span class="line"><span class="cl">                    <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">content</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="k">except</span> <span class="ne">IOError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">            <span class="n">logg</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&#34;writing STATUS </span><span class="si">%s</span><span class="s2">: </span><span class="si">%s</span><span class="se">\n\t</span><span class="s2"> to status file </span><span class="si">%s</span><span class="s2">&#34;</span><span class="p">,</span> <span class="n">status</span><span class="p">,</span> <span class="n">e</span><span class="p">,</span> <span class="n">status_file</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="kc">True</span>
</span></span><span class="line"><span class="cl">    <span class="k">def</span> <span class="nf">read_status_from</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">conf</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">        <span class="n">status_file</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_status_file_from</span><span class="p">(</span><span class="n">conf</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="n">status</span> <span class="o">=</span> <span class="p">{}</span>
</span></span><span class="line"><span class="cl">        <span class="c1"># if not status_file: return status</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isfile</span><span class="p">(</span><span class="n">status_file</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">            <span class="k">if</span> <span class="n">DEBUG_STATUS</span><span class="p">:</span> <span class="n">logg</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&#34;no status file: </span><span class="si">%s</span><span class="se">\n</span><span class="s2"> returning </span><span class="si">%s</span><span class="s2">&#34;</span><span class="p">,</span> <span class="n">status_file</span><span class="p">,</span> <span class="n">status</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">            <span class="k">return</span> <span class="n">status</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">truncate_old</span><span class="p">(</span><span class="n">status_file</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">            <span class="k">if</span> <span class="n">DEBUG_STATUS</span><span class="p">:</span> <span class="n">logg</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&#34;old status file: </span><span class="si">%s</span><span class="se">\n</span><span class="s2"> returning </span><span class="si">%s</span><span class="s2">&#34;</span><span class="p">,</span> <span class="n">status_file</span><span class="p">,</span> <span class="n">status</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">            <span class="k">return</span> <span class="n">status</span>
</span></span><span class="line"><span class="cl">        <span class="k">try</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">            <span class="k">if</span> <span class="n">DEBUG_STATUS</span><span class="p">:</span> <span class="n">logg</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&#34;reading </span><span class="si">%s</span><span class="s2">&#34;</span><span class="p">,</span> <span class="n">status_file</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">            <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">status_file</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">                <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">f</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">                    <span class="k">if</span> <span class="n">line</span><span class="o">.</span><span class="n">strip</span><span class="p">():</span>
</span></span><span class="line"><span class="cl">                        <span class="n">m</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="k">match</span><span class="p">(</span><span class="sa">r</span><span class="s2">&#34;(\w+)[:=](.*)&#34;</span><span class="p">,</span> <span class="n">line</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">                        <span class="k">if</span> <span class="n">m</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">                            <span class="n">key</span><span class="p">,</span> <span class="n">value</span> <span class="o">=</span> <span class="n">m</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">1</span><span class="p">),</span> <span class="n">m</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">                            <span class="k">if</span> <span class="n">key</span><span class="o">.</span><span class="n">strip</span><span class="p">():</span>
</span></span><span class="line"><span class="cl">                                <span class="n">status</span><span class="p">[</span><span class="n">key</span><span class="o">.</span><span class="n">strip</span><span class="p">()]</span> <span class="o">=</span> <span class="n">value</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">                        <span class="k">else</span><span class="p">:</span>  <span class="c1"># pragma: no cover</span>
</span></span><span class="line"><span class="cl">                            <span class="n">logg</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&#34;ignored </span><span class="si">%s</span><span class="s2">&#34;</span><span class="p">,</span> <span class="n">line</span><span class="o">.</span><span class="n">strip</span><span class="p">())</span>
</span></span><span class="line"><span class="cl">        <span class="k">except</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">            <span class="n">logg</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&#34;bad read of status file &#39;</span><span class="si">%s</span><span class="s2">&#39;&#34;</span><span class="p">,</span> <span class="n">status_file</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="n">status</span>
</span></span><span class="line"><span class="cl">    <span class="k">def</span> <span class="nf">get_status_from</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">conf</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">default</span> <span class="o">=</span> <span class="kc">None</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="n">conf</span><span class="o">.</span><span class="n">status</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">            <span class="n">conf</span><span class="o">.</span><span class="n">status</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">read_status_from</span><span class="p">(</span><span class="n">conf</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="n">conf</span><span class="o">.</span><span class="n">status</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">default</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="k">def</span> <span class="nf">set_status_from</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">conf</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="n">conf</span><span class="o">.</span><span class="n">status</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">            <span class="n">conf</span><span class="o">.</span><span class="n">status</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">read_status_from</span><span class="p">(</span><span class="n">conf</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="n">value</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">            <span class="k">try</span><span class="p">:</span> <span class="k">del</span> <span class="n">conf</span><span class="o">.</span><span class="n">status</span><span class="p">[</span><span class="n">name</span><span class="p">]</span>
</span></span><span class="line"><span class="cl">            <span class="k">except</span> <span class="ne">KeyError</span><span class="p">:</span> <span class="k">pass</span>
</span></span><span class="line"><span class="cl">        <span class="k">else</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">            <span class="n">conf</span><span class="o">.</span><span class="n">status</span><span class="p">[</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="n">value</span>
</span></span><span class="line"><span class="cl">    <span class="c1">#</span>
</span></span><span class="line"><span class="cl">    <span class="k">def</span> <span class="nf">get_boottime</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">        <span class="s2">&#34;&#34;&#34; detects the boot time of the container - in general the start time of PID 1 &#34;&#34;&#34;</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_boottime</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">            <span class="bp">self</span><span class="o">.</span><span class="n">_boottime</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_boottime_from_proc</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">        <span class="k">assert</span> <span class="bp">self</span><span class="o">.</span><span class="n">_boottime</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_boottime</span>
</span></span><span class="line"><span class="cl">    <span class="k">def</span> <span class="nf">get_boottime_from_proc</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">        <span class="s2">&#34;&#34;&#34; detects the latest boot time by looking at the start time of available process&#34;&#34;&#34;</span>
</span></span><span class="line"><span class="cl">        <span class="n">pid1</span> <span class="o">=</span> <span class="n">BOOT_PID_MIN</span> <span class="ow">or</span> <span class="mi">0</span>
</span></span><span class="line"><span class="cl">        <span class="n">pid_max</span> <span class="o">=</span> <span class="n">BOOT_PID_MAX</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="n">pid_max</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">            <span class="n">pid_max</span> <span class="o">=</span> <span class="n">pid1</span> <span class="o">-</span> <span class="n">pid_max</span>
</span></span><span class="line"><span class="cl">        <span class="k">for</span> <span class="n">pid</span> <span class="ow">in</span> <span class="n">xrange</span><span class="p">(</span><span class="n">pid1</span><span class="p">,</span> <span class="n">pid_max</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">            <span class="n">proc</span> <span class="o">=</span> <span class="n">_proc_pid_stat</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="o">**</span><span class="nb">locals</span><span class="p">())</span>
</span></span><span class="line"><span class="cl">            <span class="k">try</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">                <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">proc</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">                    <span class="c1"># return os.path.getmtime(proc) # did sometimes change</span>
</span></span><span class="line"><span class="cl">                    <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">path_proc_started</span><span class="p">(</span><span class="n">proc</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">            <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span> <span class="c1"># pragma: no cover</span>
</span></span><span class="line"><span class="cl">                <span class="n">logg</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&#34;boottime - could not access </span><span class="si">%s</span><span class="s2">: </span><span class="si">%s</span><span class="s2">&#34;</span><span class="p">,</span> <span class="n">proc</span><span class="p">,</span> <span class="n">e</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="n">DEBUG_BOOTTIME</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">            <span class="n">logg</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&#34; boottime from the oldest entry in /proc [nothing in </span><span class="si">%s</span><span class="s2">..</span><span class="si">%s</span><span class="s2">]&#34;</span><span class="p">,</span> <span class="n">pid1</span><span class="p">,</span> <span class="n">pid_max</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_boottime_from_old_proc</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">    <span class="k">def</span> <span class="nf">get_boottime_from_old_proc</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">        <span class="n">booted</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">        <span class="k">for</span> <span class="n">pid</span> <span class="ow">in</span> <span class="n">os</span><span class="o">.</span><span class="n">listdir</span><span class="p">(</span><span class="n">_proc_pid_dir</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">            <span class="n">proc</span> <span class="o">=</span> <span class="n">_proc_pid_stat</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="o">**</span><span class="nb">locals</span><span class="p">())</span>
</span></span><span class="line"><span class="cl">            <span class="k">try</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">                <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">proc</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">                    <span class="c1"># ctime = os.path.getmtime(proc)</span>
</span></span><span class="line"><span class="cl">                    <span class="n">ctime</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">path_proc_started</span><span class="p">(</span><span class="n">proc</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">                    <span class="k">if</span> <span class="n">ctime</span> <span class="o">&lt;</span> <span class="n">booted</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">                        <span class="n">booted</span> <span class="o">=</span> <span class="n">ctime</span>
</span></span><span class="line"><span class="cl">            <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span> <span class="c1"># pragma: no cover</span>
</span></span><span class="line"><span class="cl">                <span class="n">logg</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&#34;could not access </span><span class="si">%s</span><span class="s2">: </span><span class="si">%s</span><span class="s2">&#34;</span><span class="p">,</span> <span class="n">proc</span><span class="p">,</span> <span class="n">e</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="n">booted</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1"># Use uptime, time process running in ticks, and current time to determine process boot time</span>
</span></span><span class="line"><span class="cl">    <span class="c1"># You can&#39;t use the modified timestamp of the status file because it isn&#39;t static.</span>
</span></span><span class="line"><span class="cl">    <span class="c1"># ... using clock ticks it is known to be a linear time on Linux</span>
</span></span><span class="line"><span class="cl">    <span class="k">def</span> <span class="nf">path_proc_started</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">proc</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">        <span class="c1"># get time process started after boot in clock ticks</span>
</span></span><span class="line"><span class="cl">        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">proc</span><span class="p">)</span> <span class="k">as</span> <span class="n">file_stat</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">            <span class="n">data_stat</span> <span class="o">=</span> <span class="n">file_stat</span><span class="o">.</span><span class="n">readline</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">        <span class="n">file_stat</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">        <span class="n">stat_data</span> <span class="o">=</span> <span class="n">data_stat</span><span class="o">.</span><span class="n">split</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">        <span class="n">started_ticks</span> <span class="o">=</span> <span class="n">stat_data</span><span class="p">[</span><span class="mi">21</span><span class="p">]</span>
</span></span><span class="line"><span class="cl">        <span class="c1"># man proc(5): &#34;(22) starttime = The time the process started after system boot.&#34;</span>
</span></span><span class="line"><span class="cl">        <span class="c1">#    &#34;.. the value is expressed in clock ticks (divide by sysconf(_SC_CLK_TCK)).&#34;</span>
</span></span><span class="line"><span class="cl">        <span class="c1"># NOTE: for containers the start time is related to the boot time of host system.</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="n">clkTickInt</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">sysconf_names</span><span class="p">[</span><span class="s1">&#39;SC_CLK_TCK&#39;</span><span class="p">]</span>
</span></span><span class="line"><span class="cl">        <span class="n">clockTicksPerSec</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">sysconf</span><span class="p">(</span><span class="n">clkTickInt</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="n">started_secs</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">started_ticks</span><span class="p">)</span> <span class="o">/</span> <span class="n">clockTicksPerSec</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="n">DEBUG_BOOTTIME</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">            <span class="n">logg</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&#34;  BOOT .. Proc started time:  </span><span class="si">%.3f</span><span class="s2"> (</span><span class="si">%s</span><span class="s2">)&#34;</span><span class="p">,</span> <span class="n">started_secs</span><span class="p">,</span> <span class="n">proc</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="c1"># this value is the start time from the host system</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="c1"># Variant 1:</span>
</span></span><span class="line"><span class="cl">        <span class="n">system_uptime</span> <span class="o">=</span> <span class="n">_proc_sys_uptime</span>
</span></span><span class="line"><span class="cl">        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">system_uptime</span><span class="p">,</span> <span class="s2">&#34;rb&#34;</span><span class="p">)</span> <span class="k">as</span> <span class="n">file_uptime</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">            <span class="n">data_uptime</span> <span class="o">=</span> <span class="n">file_uptime</span><span class="o">.</span><span class="n">readline</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">        <span class="n">file_uptime</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">        <span class="n">uptime_data</span> <span class="o">=</span> <span class="n">data_uptime</span><span class="o">.</span><span class="n">decode</span><span class="p">()</span><span class="o">.</span><span class="n">split</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">        <span class="n">uptime_secs</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">uptime_data</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="n">DEBUG_BOOTTIME</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">            <span class="n">logg</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&#34;  BOOT 1. System uptime secs: </span><span class="si">%.3f</span><span class="s2"> (</span><span class="si">%s</span><span class="s2">)&#34;</span><span class="p">,</span> <span class="n">uptime_secs</span><span class="p">,</span> <span class="n">system_uptime</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="c1"># get time now</span>
</span></span><span class="line"><span class="cl">        <span class="n">now</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">        <span class="n">started_time</span> <span class="o">=</span> <span class="n">now</span> <span class="o">-</span> <span class="p">(</span><span class="n">uptime_secs</span> <span class="o">-</span> <span class="n">started_secs</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="n">DEBUG_BOOTTIME</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">            <span class="n">logg</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&#34;  BOOT 1. Proc has been running since: </span><span class="si">%s</span><span class="s2">&#34;</span> <span class="o">%</span> <span class="p">(</span><span class="n">datetime</span><span class="o">.</span><span class="n">datetime</span><span class="o">.</span><span class="n">fromtimestamp</span><span class="p">(</span><span class="n">started_time</span><span class="p">)))</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="c1"># Variant 2:</span>
</span></span><span class="line"><span class="cl">        <span class="n">system_stat</span> <span class="o">=</span> <span class="n">_proc_sys_stat</span>
</span></span><span class="line"><span class="cl">        <span class="n">system_btime</span> <span class="o">=</span> <span class="mf">0.</span>
</span></span><span class="line"><span class="cl">        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">system_stat</span><span class="p">,</span> <span class="s2">&#34;rb&#34;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">            <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">f</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">                <span class="k">assert</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">line</span><span class="p">,</span> <span class="nb">bytes</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">                <span class="k">if</span> <span class="n">line</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="sa">b</span><span class="s2">&#34;btime&#34;</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">                    <span class="n">system_btime</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">line</span><span class="o">.</span><span class="n">decode</span><span class="p">()</span><span class="o">.</span><span class="n">split</span><span class="p">()[</span><span class="mi">1</span><span class="p">])</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="n">DEBUG_BOOTTIME</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">            <span class="n">logg</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&#34;  BOOT 2. System btime secs: </span><span class="si">%.3f</span><span class="s2"> (</span><span class="si">%s</span><span class="s2">)&#34;</span><span class="p">,</span> <span class="n">system_btime</span><span class="p">,</span> <span class="n">system_stat</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="n">started_btime</span> <span class="o">=</span> <span class="n">system_btime</span> <span class="o">+</span> <span class="n">started_secs</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="n">DEBUG_BOOTTIME</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">            <span class="n">logg</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&#34;  BOOT 2. Proc has been running since: </span><span class="si">%s</span><span class="s2">&#34;</span> <span class="o">%</span> <span class="p">(</span><span class="n">datetime</span><span class="o">.</span><span class="n">datetime</span><span class="o">.</span><span class="n">fromtimestamp</span><span class="p">(</span><span class="n">started_btime</span><span class="p">)))</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="c1"># return started_time</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="n">started_btime</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">def</span> <span class="nf">get_filetime</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">filename</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">getmtime</span><span class="p">(</span><span class="n">filename</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="k">def</span> <span class="nf">truncate_old</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">filename</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">        <span class="n">filetime</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_filetime</span><span class="p">(</span><span class="n">filename</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="n">boottime</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_boottime</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="n">filetime</span> <span class="o">&gt;=</span> <span class="n">boottime</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">            <span class="k">if</span> <span class="n">DEBUG_BOOTTIME</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">                <span class="n">logg</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&#34;  file time: </span><span class="si">%s</span><span class="s2"> (</span><span class="si">%s</span><span class="s2">)&#34;</span><span class="p">,</span> <span class="n">datetime</span><span class="o">.</span><span class="n">datetime</span><span class="o">.</span><span class="n">fromtimestamp</span><span class="p">(</span><span class="n">filetime</span><span class="p">),</span> <span class="n">o22</span><span class="p">(</span><span class="n">filename</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">                <span class="n">logg</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&#34;  boot time: </span><span class="si">%s</span><span class="s2"> (</span><span class="si">%s</span><span class="s2">)&#34;</span><span class="p">,</span> <span class="n">datetime</span><span class="o">.</span><span class="n">datetime</span><span class="o">.</span><span class="n">fromtimestamp</span><span class="p">(</span><span class="n">boottime</span><span class="p">),</span> <span class="s2">&#34;status modified later&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">            <span class="k">return</span> <span class="kc">False</span> <span class="c1"># OK</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="n">DEBUG_BOOTTIME</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">            <span class="n">logg</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&#34;  file time: </span><span class="si">%s</span><span class="s2"> (</span><span class="si">%s</span><span class="s2">)&#34;</span><span class="p">,</span> <span class="n">datetime</span><span class="o">.</span><span class="n">datetime</span><span class="o">.</span><span class="n">fromtimestamp</span><span class="p">(</span><span class="n">filetime</span><span class="p">),</span> <span class="n">o22</span><span class="p">(</span><span class="n">filename</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">            <span class="n">logg</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&#34;  boot time: </span><span class="si">%s</span><span class="s2"> (</span><span class="si">%s</span><span class="s2">)&#34;</span><span class="p">,</span> <span class="n">datetime</span><span class="o">.</span><span class="n">datetime</span><span class="o">.</span><span class="n">fromtimestamp</span><span class="p">(</span><span class="n">boottime</span><span class="p">),</span> <span class="s2">&#34;status TRUNCATED NOW&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="k">try</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">            <span class="n">shutil_truncate</span><span class="p">(</span><span class="n">filename</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">            <span class="n">logg</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&#34;while truncating: </span><span class="si">%s</span><span class="s2">&#34;</span><span class="p">,</span> <span class="n">e</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="kc">True</span> <span class="c1"># truncated</span>
</span></span><span class="line"><span class="cl">    <span class="k">def</span> <span class="nf">getsize</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">filename</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="n">filename</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span> <span class="c1"># pragma: no cover (is never null)</span>
</span></span><span class="line"><span class="cl">            <span class="k">return</span> <span class="mi">0</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isfile</span><span class="p">(</span><span class="n">filename</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">            <span class="k">return</span> <span class="mi">0</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">truncate_old</span><span class="p">(</span><span class="n">filename</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">            <span class="k">return</span> <span class="mi">0</span>
</span></span><span class="line"><span class="cl">        <span class="k">try</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">            <span class="k">return</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">getsize</span><span class="p">(</span><span class="n">filename</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">            <span class="n">logg</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&#34;while reading file size: </span><span class="si">%s</span><span class="se">\n</span><span class="s2"> of </span><span class="si">%s</span><span class="s2">&#34;</span><span class="p">,</span> <span class="n">e</span><span class="p">,</span> <span class="n">filename</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">            <span class="k">return</span> <span class="mi">0</span>
</span></span><span class="line"><span class="cl">    <span class="c1">#</span>
</span></span><span class="line"><span class="cl">    <span class="k">def</span> <span class="nf">read_env_file</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">env_file</span><span class="p">):</span> <span class="c1"># -&gt; generate[ (name,value) ]</span>
</span></span><span class="line"><span class="cl">        <span class="s2">&#34;&#34;&#34; EnvironmentFile=&lt;name&gt; is being scanned &#34;&#34;&#34;</span>
</span></span><span class="line"><span class="cl">        <span class="n">mode</span><span class="p">,</span> <span class="n">env_file</span> <span class="o">=</span> <span class="n">load_path</span><span class="p">(</span><span class="n">env_file</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="n">real_file</span> <span class="o">=</span> <span class="n">os_path</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_root</span><span class="p">,</span> <span class="n">env_file</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">real_file</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">            <span class="k">if</span> <span class="n">mode</span><span class="o">.</span><span class="n">check</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">                <span class="n">logg</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&#34;file does not exist: </span><span class="si">%s</span><span class="s2">&#34;</span><span class="p">,</span> <span class="n">real_file</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">            <span class="k">else</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">                <span class="n">logg</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&#34;file does not exist: </span><span class="si">%s</span><span class="s2">&#34;</span><span class="p">,</span> <span class="n">real_file</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">            <span class="k">return</span>
</span></span><span class="line"><span class="cl">        <span class="k">try</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">            <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">os_path</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_root</span><span class="p">,</span> <span class="n">env_file</span><span class="p">))</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">                <span class="k">for</span> <span class="n">real_line</span> <span class="ow">in</span> <span class="n">f</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">                    <span class="n">line</span> <span class="o">=</span> <span class="n">real_line</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">                    <span class="k">if</span> <span class="ow">not</span> <span class="n">line</span> <span class="ow">or</span> <span class="n">line</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s2">&#34;#&#34;</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">                        <span class="k">continue</span>
</span></span><span class="line"><span class="cl">                    <span class="n">m</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="k">match</span><span class="p">(</span><span class="sa">r</span><span class="s2">&#34;(?:export +)?([\w_]+)[=]&#39;([^&#39;]*)&#39;&#34;</span><span class="p">,</span> <span class="n">line</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">                    <span class="k">if</span> <span class="n">m</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">                        <span class="k">yield</span> <span class="n">m</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">1</span><span class="p">),</span> <span class="n">m</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">                        <span class="k">continue</span>
</span></span><span class="line"><span class="cl">                    <span class="n">m</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="k">match</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;(?:export +)?([\w_]+)[=]&#34;([^&#34;]*)&#34;&#39;</span><span class="p">,</span> <span class="n">line</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">                    <span class="k">if</span> <span class="n">m</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">                        <span class="k">yield</span> <span class="n">m</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">1</span><span class="p">),</span> <span class="n">m</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">                        <span class="k">continue</span>
</span></span><span class="line"><span class="cl">                    <span class="n">m</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="k">match</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;(?:export +)?([\w_]+)[=](.*)&#39;</span><span class="p">,</span> <span class="n">line</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">                    <span class="k">if</span> <span class="n">m</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">                        <span class="k">yield</span> <span class="n">m</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">1</span><span class="p">),</span> <span class="n">m</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">                        <span class="k">continue</span>
</span></span><span class="line"><span class="cl">        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">            <span class="n">logg</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&#34;while reading </span><span class="si">%s</span><span class="s2">: </span><span class="si">%s</span><span class="s2">&#34;</span><span class="p">,</span> <span class="n">env_file</span><span class="p">,</span> <span class="n">e</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="k">def</span> <span class="nf">read_env_part</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">env_part</span><span class="p">):</span> <span class="c1"># -&gt; generate[ (name, value) ]</span>
</span></span><span class="line"><span class="cl">        <span class="s2">&#34;&#34;&#34; Environment=&lt;name&gt;=&lt;value&gt; is being scanned &#34;&#34;&#34;</span>
</span></span><span class="line"><span class="cl">        <span class="c1"># systemd Environment= spec says it is a space-separated list of</span>
</span></span><span class="line"><span class="cl">        <span class="c1"># assignments. In order to use a space or an equals sign in a value</span>
</span></span><span class="line"><span class="cl">        <span class="c1"># one should enclose the whole assignment with double quotes:</span>
</span></span><span class="line"><span class="cl">        <span class="c1"># Environment=&#34;VAR1=word word&#34; VAR2=word3 &#34;VAR3=$word 5 6&#34;</span>
</span></span><span class="line"><span class="cl">        <span class="c1"># and the $word is not expanded by other environment variables.</span>
</span></span><span class="line"><span class="cl">        <span class="k">try</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">            <span class="k">for</span> <span class="n">real_line</span> <span class="ow">in</span> <span class="n">env_part</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&#34;</span><span class="se">\n</span><span class="s2">&#34;</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">                <span class="n">line</span> <span class="o">=</span> <span class="n">real_line</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">                <span class="k">for</span> <span class="n">found</span> <span class="ow">in</span> <span class="n">re</span><span class="o">.</span><span class="n">finditer</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;\s*(&#34;[\w_]+=[^&#34;]*&#34;|[\w_]+=\S*)&#39;</span><span class="p">,</span> <span class="n">line</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">                    <span class="n">part</span> <span class="o">=</span> <span class="n">found</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">                    <span class="k">if</span> <span class="n">part</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s1">&#39;&#34;&#39;</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">                        <span class="n">part</span> <span class="o">=</span> <span class="n">part</span><span class="p">[</span><span class="mi">1</span><span class="p">:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
</span></span><span class="line"><span class="cl">                    <span class="n">name</span><span class="p">,</span> <span class="n">value</span> <span class="o">=</span> <span class="n">part</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&#34;=&#34;</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">                    <span class="k">yield</span> <span class="n">name</span><span class="p">,</span> <span class="n">value</span>
</span></span><span class="line"><span class="cl">        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">            <span class="n">logg</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&#34;while reading </span><span class="si">%s</span><span class="s2">: </span><span class="si">%s</span><span class="s2">&#34;</span><span class="p">,</span> <span class="n">env_part</span><span class="p">,</span> <span class="n">e</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="k">def</span> <span class="nf">command_of_unit</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">unit</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">        <span class="s2">&#34;&#34;&#34; [UNIT]. -- show service settings (experimental)
</span></span></span><span class="line"><span class="cl"><span class="s2">            or use -p VarName to show another property than &#39;ExecStart&#39; &#34;&#34;&#34;</span>
</span></span><span class="line"><span class="cl">        <span class="n">conf</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">load_unit_conf</span><span class="p">(</span><span class="n">unit</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="n">conf</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">            <span class="n">logg</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&#34;Unit </span><span class="si">%s</span><span class="s2"> could not be found.&#34;</span><span class="p">,</span> <span class="n">unit</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">            <span class="bp">self</span><span class="o">.</span><span class="n">error</span> <span class="o">|=</span> <span class="n">NOT_FOUND</span>
</span></span><span class="line"><span class="cl">            <span class="k">return</span> <span class="kc">None</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_only_property</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">            <span class="n">found</span> <span class="o">=</span> <span class="p">[]</span>
</span></span><span class="line"><span class="cl">            <span class="k">for</span> <span class="n">prop</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_only_property</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">                <span class="n">found</span> <span class="o">+=</span> <span class="n">conf</span><span class="o">.</span><span class="n">getlist</span><span class="p">(</span><span class="n">Service</span><span class="p">,</span> <span class="n">prop</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">            <span class="k">return</span> <span class="n">found</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="n">conf</span><span class="o">.</span><span class="n">getlist</span><span class="p">(</span><span class="n">Service</span><span class="p">,</span> <span class="s2">&#34;ExecStart&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="k">def</span> <span class="nf">environment_of_unit</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">unit</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">        <span class="s2">&#34;&#34;&#34; [UNIT]. -- show environment parts &#34;&#34;&#34;</span>
</span></span><span class="line"><span class="cl">        <span class="n">conf</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">load_unit_conf</span><span class="p">(</span><span class="n">unit</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="n">conf</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">            <span class="n">logg</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&#34;Unit </span><span class="si">%s</span><span class="s2"> could not be found.&#34;</span><span class="p">,</span> <span class="n">unit</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">            <span class="bp">self</span><span class="o">.</span><span class="n">error</span> <span class="o">|=</span> <span class="n">NOT_FOUND</span>
</span></span><span class="line"><span class="cl">            <span class="k">return</span> <span class="kc">None</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_env</span><span class="p">(</span><span class="n">conf</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="k">def</span> <span class="nf">extra_vars</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_extra_vars</span> <span class="c1"># from command line</span>
</span></span><span class="line"><span class="cl">    <span class="k">def</span> <span class="nf">get_env</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">conf</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">        <span class="n">env</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">        <span class="k">for</span> <span class="n">env_part</span> <span class="ow">in</span> <span class="n">conf</span><span class="o">.</span><span class="n">getlist</span><span class="p">(</span><span class="n">Service</span><span class="p">,</span> <span class="s2">&#34;Environment&#34;</span><span class="p">,</span> <span class="p">[]):</span>
</span></span><span class="line"><span class="cl">            <span class="k">for</span> <span class="n">name</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">read_env_part</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">expand_special</span><span class="p">(</span><span class="n">env_part</span><span class="p">,</span> <span class="n">conf</span><span class="p">)):</span>
</span></span><span class="line"><span class="cl">                <span class="n">env</span><span class="p">[</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="n">value</span> <span class="c1"># a &#39;$word&#39; is not special here (lazy expansion)</span>
</span></span><span class="line"><span class="cl">        <span class="k">for</span> <span class="n">env_file</span> <span class="ow">in</span> <span class="n">conf</span><span class="o">.</span><span class="n">getlist</span><span class="p">(</span><span class="n">Service</span><span class="p">,</span> <span class="s2">&#34;EnvironmentFile&#34;</span><span class="p">,</span> <span class="p">[]):</span>
</span></span><span class="line"><span class="cl">            <span class="k">for</span> <span class="n">name</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">read_env_file</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">expand_special</span><span class="p">(</span><span class="n">env_file</span><span class="p">,</span> <span class="n">conf</span><span class="p">)):</span>
</span></span><span class="line"><span class="cl">                <span class="n">env</span><span class="p">[</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">expand_env</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="n">env</span><span class="p">)</span> <span class="c1"># but nonlazy expansion here</span>
</span></span><span class="line"><span class="cl">        <span class="n">logg</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&#34;extra-vars </span><span class="si">%s</span><span class="s2">&#34;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">extra_vars</span><span class="p">())</span>
</span></span><span class="line"><span class="cl">        <span class="k">for</span> <span class="n">extra</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">extra_vars</span><span class="p">():</span>
</span></span><span class="line"><span class="cl">            <span class="k">if</span> <span class="n">extra</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s2">&#34;@&#34;</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">                <span class="k">for</span> <span class="n">name</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">read_env_file</span><span class="p">(</span><span class="n">extra</span><span class="p">[</span><span class="mi">1</span><span class="p">:]):</span>
</span></span><span class="line"><span class="cl">                    <span class="n">logg</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&#34;override </span><span class="si">%s</span><span class="s2">=</span><span class="si">%s</span><span class="s2">&#34;</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">value</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">                    <span class="n">env</span><span class="p">[</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">expand_env</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="n">env</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">            <span class="k">else</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">                <span class="k">for</span> <span class="n">name</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">read_env_part</span><span class="p">(</span><span class="n">extra</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">                    <span class="n">logg</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&#34;override </span><span class="si">%s</span><span class="s2">=</span><span class="si">%s</span><span class="s2">&#34;</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">value</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">                    <span class="n">env</span><span class="p">[</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="n">value</span> <span class="c1"># a &#39;$word&#39; is not special here</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="n">env</span>
</span></span><span class="line"><span class="cl">    <span class="k">def</span> <span class="nf">expand_env</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">cmd</span><span class="p">,</span> <span class="n">env</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">        <span class="k">def</span> <span class="nf">get_env1</span><span class="p">(</span><span class="n">m</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">            <span class="n">name</span> <span class="o">=</span> <span class="n">m</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">            <span class="k">if</span> <span class="n">name</span> <span class="ow">in</span> <span class="n">env</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">                <span class="k">return</span> <span class="n">env</span><span class="p">[</span><span class="n">name</span><span class="p">]</span>
</span></span><span class="line"><span class="cl">            <span class="n">namevar</span> <span class="o">=</span> <span class="s2">&#34;$</span><span class="si">%s</span><span class="s2">&#34;</span> <span class="o">%</span> <span class="n">name</span>
</span></span><span class="line"><span class="cl">            <span class="n">logg</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&#34;can not expand </span><span class="si">%s</span><span class="s2">&#34;</span><span class="p">,</span> <span class="n">namevar</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">            <span class="k">return</span> <span class="p">(</span><span class="n">EXPAND_KEEP_VARS</span> <span class="ow">and</span> <span class="n">namevar</span> <span class="ow">or</span> <span class="s2">&#34;&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="k">def</span> <span class="nf">get_env2</span><span class="p">(</span><span class="n">m</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">            <span class="n">name</span> <span class="o">=</span> <span class="n">m</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">            <span class="k">if</span> <span class="n">name</span> <span class="ow">in</span> <span class="n">env</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">                <span class="k">return</span> <span class="n">env</span><span class="p">[</span><span class="n">name</span><span class="p">]</span>
</span></span><span class="line"><span class="cl">            <span class="n">namevar</span> <span class="o">=</span> <span class="s2">&#34;${</span><span class="si">%s</span><span class="s2">}&#34;</span> <span class="o">%</span> <span class="n">name</span>
</span></span><span class="line"><span class="cl">            <span class="n">logg</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&#34;can not expand </span><span class="si">%s</span><span class="s2">&#34;</span><span class="p">,</span> <span class="n">namevar</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">            <span class="k">return</span> <span class="p">(</span><span class="n">EXPAND_KEEP_VARS</span> <span class="ow">and</span> <span class="n">namevar</span> <span class="ow">or</span> <span class="s2">&#34;&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="c1">#</span>
</span></span><span class="line"><span class="cl">        <span class="n">maxdepth</span> <span class="o">=</span> <span class="n">EXPAND_VARS_MAXDEPTH</span>
</span></span><span class="line"><span class="cl">        <span class="n">expanded</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">sub</span><span class="p">(</span><span class="sa">r</span><span class="s2">&#34;[$](\w+)&#34;</span><span class="p">,</span> <span class="k">lambda</span> <span class="n">m</span><span class="p">:</span> <span class="n">get_env1</span><span class="p">(</span><span class="n">m</span><span class="p">),</span> <span class="n">cmd</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&#34;</span><span class="se">\\\n</span><span class="s2">&#34;</span><span class="p">,</span> <span class="s2">&#34;&#34;</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">        <span class="k">for</span> <span class="n">depth</span> <span class="ow">in</span> <span class="n">xrange</span><span class="p">(</span><span class="n">maxdepth</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">            <span class="n">new_text</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">sub</span><span class="p">(</span><span class="sa">r</span><span class="s2">&#34;[$][{](\w+)[}]&#34;</span><span class="p">,</span> <span class="k">lambda</span> <span class="n">m</span><span class="p">:</span> <span class="n">get_env2</span><span class="p">(</span><span class="n">m</span><span class="p">),</span> <span class="n">expanded</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">            <span class="k">if</span> <span class="n">new_text</span> <span class="o">==</span> <span class="n">expanded</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">                <span class="k">return</span> <span class="n">expanded</span>
</span></span><span class="line"><span class="cl">            <span class="n">expanded</span> <span class="o">=</span> <span class="n">new_text</span>
</span></span><span class="line"><span class="cl">        <span class="n">logg</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&#34;shell variable expansion exceeded maxdepth </span><span class="si">%s</span><span class="s2">&#34;</span><span class="p">,</span> <span class="n">maxdepth</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="n">expanded</span>
</span></span><span class="line"><span class="cl">    <span class="k">def</span> <span class="nf">expand_special</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">cmd</span><span class="p">,</span> <span class="n">conf</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">        <span class="s2">&#34;&#34;&#34; expand </span><span class="si">%i</span><span class="s2"> %t and similar special vars. They are being expanded
</span></span></span><span class="line"><span class="cl"><span class="s2">            before any other expand_env takes place which handles shell-style
</span></span></span><span class="line"><span class="cl"><span class="s2">            $HOME references. &#34;&#34;&#34;</span>
</span></span><span class="line"><span class="cl">        <span class="k">def</span> <span class="nf">xx</span><span class="p">(</span><span class="n">arg</span><span class="p">):</span> <span class="k">return</span> <span class="n">unit_name_unescape</span><span class="p">(</span><span class="n">arg</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="k">def</span> <span class="nf">yy</span><span class="p">(</span><span class="n">arg</span><span class="p">):</span> <span class="k">return</span> <span class="n">arg</span>
</span></span><span class="line"><span class="cl">        <span class="k">def</span> <span class="nf">get_confs</span><span class="p">(</span><span class="n">conf</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">            <span class="n">confs</span><span class="o">=</span><span class="p">{</span><span class="s2">&#34;%&#34;</span><span class="p">:</span> <span class="s2">&#34;%&#34;</span><span class="p">}</span>
</span></span><span class="line"><span class="cl">            <span class="k">if</span> <span class="n">conf</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span> <span class="c1"># pragma: no cover (is never null)</span>
</span></span><span class="line"><span class="cl">                <span class="k">return</span> <span class="n">confs</span>
</span></span><span class="line"><span class="cl">            <span class="n">unit</span> <span class="o">=</span> <span class="n">parse_unit</span><span class="p">(</span><span class="n">conf</span><span class="o">.</span><span class="n">name</span><span class="p">())</span>
</span></span><span class="line"><span class="cl">            <span class="c1">#</span>
</span></span><span class="line"><span class="cl">            <span class="n">root</span> <span class="o">=</span> <span class="n">conf</span><span class="o">.</span><span class="n">root_mode</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">            <span class="n">VARTMP</span> <span class="o">=</span> <span class="n">get_VARTMP</span><span class="p">(</span><span class="n">root</span><span class="p">)</span>     <span class="c1"># $TMPDIR              # &#34;/var/tmp&#34;</span>
</span></span><span class="line"><span class="cl">            <span class="n">TMP</span> <span class="o">=</span> <span class="n">get_TMP</span><span class="p">(</span><span class="n">root</span><span class="p">)</span>           <span class="c1"># $TMPDIR              # &#34;/tmp&#34;</span>
</span></span><span class="line"><span class="cl">            <span class="n">RUN</span> <span class="o">=</span> <span class="n">get_RUNTIME_DIR</span><span class="p">(</span><span class="n">root</span><span class="p">)</span>   <span class="c1"># $XDG_RUNTIME_DIR     # &#34;/run&#34;</span>
</span></span><span class="line"><span class="cl">            <span class="n">ETC</span> <span class="o">=</span> <span class="n">get_CONFIG_HOME</span><span class="p">(</span><span class="n">root</span><span class="p">)</span>   <span class="c1"># $XDG_CONFIG_HOME     # &#34;/etc&#34;</span>
</span></span><span class="line"><span class="cl">            <span class="n">DAT</span> <span class="o">=</span> <span class="n">get_VARLIB_HOME</span><span class="p">(</span><span class="n">root</span><span class="p">)</span>   <span class="c1"># $XDG_CONFIG_HOME     # &#34;/var/lib&#34;</span>
</span></span><span class="line"><span class="cl">            <span class="n">LOG</span> <span class="o">=</span> <span class="n">get_LOG_DIR</span><span class="p">(</span><span class="n">root</span><span class="p">)</span>       <span class="c1"># $XDG_CONFIG_HOME/log # &#34;/var/log&#34;</span>
</span></span><span class="line"><span class="cl">            <span class="n">CACHE</span> <span class="o">=</span> <span class="n">get_CACHE_HOME</span><span class="p">(</span><span class="n">root</span><span class="p">)</span>  <span class="c1"># $XDG_CACHE_HOME      # &#34;/var/cache&#34;</span>
</span></span><span class="line"><span class="cl">            <span class="n">HOME</span> <span class="o">=</span> <span class="n">get_HOME</span><span class="p">(</span><span class="n">root</span><span class="p">)</span>         <span class="c1"># $HOME or ~           # &#34;/root&#34;</span>
</span></span><span class="line"><span class="cl">            <span class="n">USER</span> <span class="o">=</span> <span class="n">get_USER</span><span class="p">(</span><span class="n">root</span><span class="p">)</span>         <span class="c1"># geteuid().pw_name    # &#34;root&#34;</span>
</span></span><span class="line"><span class="cl">            <span class="n">USER_ID</span> <span class="o">=</span> <span class="n">get_USER_ID</span><span class="p">(</span><span class="n">root</span><span class="p">)</span>   <span class="c1"># geteuid()            # 0</span>
</span></span><span class="line"><span class="cl">            <span class="n">GROUP</span> <span class="o">=</span> <span class="n">get_GROUP</span><span class="p">(</span><span class="n">root</span><span class="p">)</span>       <span class="c1"># getegid().gr_name    # &#34;root&#34;</span>
</span></span><span class="line"><span class="cl">            <span class="n">GROUP_ID</span> <span class="o">=</span> <span class="n">get_GROUP_ID</span><span class="p">(</span><span class="n">root</span><span class="p">)</span> <span class="c1"># getegid()            # 0</span>
</span></span><span class="line"><span class="cl">            <span class="n">SHELL</span> <span class="o">=</span> <span class="n">get_SHELL</span><span class="p">(</span><span class="n">root</span><span class="p">)</span>       <span class="c1"># $SHELL               # &#34;/bin/sh&#34;</span>
</span></span><span class="line"><span class="cl">            <span class="c1"># confs[&#34;b&#34;] = boot_ID</span>
</span></span><span class="line"><span class="cl">            <span class="n">confs</span><span class="p">[</span><span class="s2">&#34;C&#34;</span><span class="p">]</span> <span class="o">=</span> <span class="n">os_path</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_root</span><span class="p">,</span> <span class="n">CACHE</span><span class="p">)</span> <span class="c1"># Cache directory root</span>
</span></span><span class="line"><span class="cl">            <span class="n">confs</span><span class="p">[</span><span class="s2">&#34;E&#34;</span><span class="p">]</span> <span class="o">=</span> <span class="n">os_path</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_root</span><span class="p">,</span> <span class="n">ETC</span><span class="p">)</span>   <span class="c1"># Configuration directory root</span>
</span></span><span class="line"><span class="cl">            <span class="n">confs</span><span class="p">[</span><span class="s2">&#34;F&#34;</span><span class="p">]</span> <span class="o">=</span> <span class="n">strE</span><span class="p">(</span><span class="n">conf</span><span class="o">.</span><span class="n">filename</span><span class="p">())</span>      <span class="c1"># EXTRA</span>
</span></span><span class="line"><span class="cl">            <span class="n">confs</span><span class="p">[</span><span class="s2">&#34;f&#34;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&#34;/</span><span class="si">%s</span><span class="s2">&#34;</span> <span class="o">%</span> <span class="n">xx</span><span class="p">(</span><span class="n">unit</span><span class="o">.</span><span class="n">instance</span> <span class="ow">or</span> <span class="n">unit</span><span class="o">.</span><span class="n">prefix</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">            <span class="n">confs</span><span class="p">[</span><span class="s2">&#34;h&#34;</span><span class="p">]</span> <span class="o">=</span> <span class="n">HOME</span>                       <span class="c1"># User home directory</span>
</span></span><span class="line"><span class="cl">            <span class="c1"># confs[&#34;H&#34;] = host_NAME</span>
</span></span><span class="line"><span class="cl">            <span class="n">confs</span><span class="p">[</span><span class="s2">&#34;i&#34;</span><span class="p">]</span> <span class="o">=</span> <span class="n">yy</span><span class="p">(</span><span class="n">unit</span><span class="o">.</span><span class="n">instance</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">            <span class="n">confs</span><span class="p">[</span><span class="s2">&#34;I&#34;</span><span class="p">]</span> <span class="o">=</span> <span class="n">xx</span><span class="p">(</span><span class="n">unit</span><span class="o">.</span><span class="n">instance</span><span class="p">)</span>       <span class="c1"># same as %i but escaping undone</span>
</span></span><span class="line"><span class="cl">            <span class="n">confs</span><span class="p">[</span><span class="s2">&#34;j&#34;</span><span class="p">]</span> <span class="o">=</span> <span class="n">yy</span><span class="p">(</span><span class="n">unit</span><span class="o">.</span><span class="n">component</span><span class="p">)</span>      <span class="c1"># final component of the prefix</span>
</span></span><span class="line"><span class="cl">            <span class="n">confs</span><span class="p">[</span><span class="s2">&#34;J&#34;</span><span class="p">]</span> <span class="o">=</span> <span class="n">xx</span><span class="p">(</span><span class="n">unit</span><span class="o">.</span><span class="n">component</span><span class="p">)</span>      <span class="c1"># unescaped final component</span>
</span></span><span class="line"><span class="cl">            <span class="n">confs</span><span class="p">[</span><span class="s2">&#34;L&#34;</span><span class="p">]</span> <span class="o">=</span> <span class="n">os_path</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_root</span><span class="p">,</span> <span class="n">LOG</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">            <span class="c1"># confs[&#34;m&#34;] = machine_ID</span>
</span></span><span class="line"><span class="cl">            <span class="n">confs</span><span class="p">[</span><span class="s2">&#34;n&#34;</span><span class="p">]</span> <span class="o">=</span> <span class="n">yy</span><span class="p">(</span><span class="n">unit</span><span class="o">.</span><span class="n">fullname</span><span class="p">)</span>         <span class="c1"># Full unit name</span>
</span></span><span class="line"><span class="cl">            <span class="n">confs</span><span class="p">[</span><span class="s2">&#34;N&#34;</span><span class="p">]</span> <span class="o">=</span> <span class="n">yy</span><span class="p">(</span><span class="n">unit</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>             <span class="c1"># Same as &#34;%n&#34;, but with the type suffix removed.</span>
</span></span><span class="line"><span class="cl">            <span class="n">confs</span><span class="p">[</span><span class="s2">&#34;p&#34;</span><span class="p">]</span> <span class="o">=</span> <span class="n">yy</span><span class="p">(</span><span class="n">unit</span><span class="o">.</span><span class="n">prefix</span><span class="p">)</span>           <span class="c1"># before the first &#34;@&#34; or same as %n</span>
</span></span><span class="line"><span class="cl">            <span class="n">confs</span><span class="p">[</span><span class="s2">&#34;P&#34;</span><span class="p">]</span> <span class="o">=</span> <span class="n">xx</span><span class="p">(</span><span class="n">unit</span><span class="o">.</span><span class="n">prefix</span><span class="p">)</span>           <span class="c1"># same as %p but escaping undone</span>
</span></span><span class="line"><span class="cl">            <span class="n">confs</span><span class="p">[</span><span class="s2">&#34;s&#34;</span><span class="p">]</span> <span class="o">=</span> <span class="n">SHELL</span>
</span></span><span class="line"><span class="cl">            <span class="n">confs</span><span class="p">[</span><span class="s2">&#34;S&#34;</span><span class="p">]</span> <span class="o">=</span> <span class="n">os_path</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_root</span><span class="p">,</span> <span class="n">DAT</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">            <span class="n">confs</span><span class="p">[</span><span class="s2">&#34;t&#34;</span><span class="p">]</span> <span class="o">=</span> <span class="n">os_path</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_root</span><span class="p">,</span> <span class="n">RUN</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">            <span class="n">confs</span><span class="p">[</span><span class="s2">&#34;T&#34;</span><span class="p">]</span> <span class="o">=</span> <span class="n">os_path</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_root</span><span class="p">,</span> <span class="n">TMP</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">            <span class="n">confs</span><span class="p">[</span><span class="s2">&#34;g&#34;</span><span class="p">]</span> <span class="o">=</span> <span class="n">GROUP</span>
</span></span><span class="line"><span class="cl">            <span class="n">confs</span><span class="p">[</span><span class="s2">&#34;G&#34;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">GROUP_ID</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">            <span class="n">confs</span><span class="p">[</span><span class="s2">&#34;u&#34;</span><span class="p">]</span> <span class="o">=</span> <span class="n">USER</span>
</span></span><span class="line"><span class="cl">            <span class="n">confs</span><span class="p">[</span><span class="s2">&#34;U&#34;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">USER_ID</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">            <span class="n">confs</span><span class="p">[</span><span class="s2">&#34;V&#34;</span><span class="p">]</span> <span class="o">=</span> <span class="n">os_path</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_root</span><span class="p">,</span> <span class="n">VARTMP</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">            <span class="k">return</span> <span class="n">confs</span>
</span></span><span class="line"><span class="cl">        <span class="k">def</span> <span class="nf">get_conf1</span><span class="p">(</span><span class="n">m</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">            <span class="n">confs</span> <span class="o">=</span> <span class="n">get_confs</span><span class="p">(</span><span class="n">conf</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">            <span class="k">if</span> <span class="n">m</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="ow">in</span> <span class="n">confs</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">                <span class="k">return</span> <span class="n">confs</span><span class="p">[</span><span class="n">m</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">1</span><span class="p">)]</span>
</span></span><span class="line"><span class="cl">            <span class="n">logg</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&#34;can not expand </span><span class="si">%%%s</span><span class="s2">&#34;</span><span class="p">,</span> <span class="n">m</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">1</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">            <span class="k">return</span> <span class="s2">&#34;&#34;</span>
</span></span><span class="line"><span class="cl">        <span class="n">result</span> <span class="o">=</span> <span class="s2">&#34;&#34;</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="n">cmd</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">            <span class="n">result</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">sub</span><span class="p">(</span><span class="s2">&#34;[%](.)&#34;</span><span class="p">,</span> <span class="k">lambda</span> <span class="n">m</span><span class="p">:</span> <span class="n">get_conf1</span><span class="p">(</span><span class="n">m</span><span class="p">),</span> <span class="n">cmd</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">            <span class="c1"># ++# logg.info(&#34;expanded =&gt; %s&#34;, result)</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="n">result</span>
</span></span><span class="line"><span class="cl">    <span class="k">def</span> <span class="nf">exec_newcmd</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">cmd</span><span class="p">,</span> <span class="n">env</span><span class="p">,</span> <span class="n">conf</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">        <span class="n">mode</span><span class="p">,</span> <span class="n">exe</span> <span class="o">=</span> <span class="n">exec_path</span><span class="p">(</span><span class="n">cmd</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="n">mode</span><span class="o">.</span><span class="n">noexpand</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">            <span class="n">newcmd</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">split_cmd</span><span class="p">(</span><span class="n">exe</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="k">else</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">            <span class="n">newcmd</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">expand_cmd</span><span class="p">(</span><span class="n">exe</span><span class="p">,</span> <span class="n">env</span><span class="p">,</span> <span class="n">conf</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="n">mode</span><span class="o">.</span><span class="n">argv0</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">newcmd</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">                <span class="k">del</span> <span class="n">newcmd</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="c1"># TODO: keep but allow execve calls to pick it up</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="n">mode</span><span class="p">,</span> <span class="n">newcmd</span>
</span></span><span class="line"><span class="cl">    <span class="k">def</span> <span class="nf">split_cmd</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">cmd</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">        <span class="n">cmd2</span> <span class="o">=</span> <span class="n">cmd</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&#34;</span><span class="se">\\\n</span><span class="s2">&#34;</span><span class="p">,</span> <span class="s2">&#34;&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="n">newcmd</span> <span class="o">=</span> <span class="p">[]</span>
</span></span><span class="line"><span class="cl">        <span class="k">for</span> <span class="n">part</span> <span class="ow">in</span> <span class="n">shlex</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="n">cmd2</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">            <span class="n">newcmd</span> <span class="o">+=</span> <span class="p">[</span><span class="n">part</span><span class="p">]</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="n">newcmd</span>
</span></span><span class="line"><span class="cl">    <span class="k">def</span> <span class="nf">expand_cmd</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">cmd</span><span class="p">,</span> <span class="n">env</span><span class="p">,</span> <span class="n">conf</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">        <span class="s2">&#34;&#34;&#34; expand ExecCmd statements including </span><span class="si">%i</span><span class="s2"> and $MAINPID &#34;&#34;&#34;</span>
</span></span><span class="line"><span class="cl">        <span class="n">cmd2</span> <span class="o">=</span> <span class="n">cmd</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&#34;</span><span class="se">\\\n</span><span class="s2">&#34;</span><span class="p">,</span> <span class="s2">&#34;&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="c1"># according to documentation, when bar=&#34;one two&#34; then the expansion</span>
</span></span><span class="line"><span class="cl">        <span class="c1"># of &#39;$bar&#39; is [&#34;one&#34;,&#34;two&#34;] and &#39;${bar}&#39; becomes [&#34;one two&#34;]. We</span>
</span></span><span class="line"><span class="cl">        <span class="c1"># tackle that by expand $bar before shlex, and the rest thereafter.</span>
</span></span><span class="line"><span class="cl">        <span class="k">def</span> <span class="nf">get_env1</span><span class="p">(</span><span class="n">m</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">            <span class="n">name</span> <span class="o">=</span> <span class="n">m</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">            <span class="k">if</span> <span class="n">name</span> <span class="ow">in</span> <span class="n">env</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">                <span class="k">return</span> <span class="n">env</span><span class="p">[</span><span class="n">name</span><span class="p">]</span>
</span></span><span class="line"><span class="cl">            <span class="n">logg</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&#34;can not expand $</span><span class="si">%s</span><span class="s2">&#34;</span><span class="p">,</span> <span class="n">name</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">            <span class="k">return</span> <span class="s2">&#34;&#34;</span>  <span class="c1"># empty string</span>
</span></span><span class="line"><span class="cl">        <span class="k">def</span> <span class="nf">get_env2</span><span class="p">(</span><span class="n">m</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">            <span class="n">name</span> <span class="o">=</span> <span class="n">m</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">            <span class="k">if</span> <span class="n">name</span> <span class="ow">in</span> <span class="n">env</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">                <span class="k">return</span> <span class="n">env</span><span class="p">[</span><span class="n">name</span><span class="p">]</span>
</span></span><span class="line"><span class="cl">            <span class="n">logg</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&#34;can not expand $</span><span class="si">%s</span><span class="s2">}}&#34;</span><span class="p">,</span> <span class="n">name</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">            <span class="k">return</span> <span class="s2">&#34;&#34;</span>  <span class="c1"># empty string</span>
</span></span><span class="line"><span class="cl">        <span class="n">cmd3</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">sub</span><span class="p">(</span><span class="sa">r</span><span class="s2">&#34;[$](\w+)&#34;</span><span class="p">,</span> <span class="k">lambda</span> <span class="n">m</span><span class="p">:</span> <span class="n">get_env1</span><span class="p">(</span><span class="n">m</span><span class="p">),</span> <span class="n">cmd2</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="n">newcmd</span> <span class="o">=</span> <span class="p">[]</span>
</span></span><span class="line"><span class="cl">        <span class="k">for</span> <span class="n">part</span> <span class="ow">in</span> <span class="n">shlex</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="n">cmd3</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">            <span class="n">part2</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">expand_special</span><span class="p">(</span><span class="n">part</span><span class="p">,</span> <span class="n">conf</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">            <span class="n">newcmd</span> <span class="o">+=</span> <span class="p">[</span><span class="n">re</span><span class="o">.</span><span class="n">sub</span><span class="p">(</span><span class="sa">r</span><span class="s2">&#34;[$][{](\w+)[}]&#34;</span><span class="p">,</span> <span class="k">lambda</span> <span class="n">m</span><span class="p">:</span> <span class="n">get_env2</span><span class="p">(</span><span class="n">m</span><span class="p">),</span> <span class="n">part2</span><span class="p">)]</span> <span class="c1"># type: ignore[arg-type]</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="n">newcmd</span>
</span></span><span class="line"><span class="cl">    <span class="k">def</span> <span class="nf">remove_service_directories</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">conf</span><span class="p">,</span> <span class="n">section</span> <span class="o">=</span> <span class="n">Service</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">        <span class="c1"># |</span>
</span></span><span class="line"><span class="cl">        <span class="n">ok</span> <span class="o">=</span> <span class="kc">True</span>
</span></span><span class="line"><span class="cl">        <span class="n">nameRuntimeDirectory</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_RuntimeDirectory</span><span class="p">(</span><span class="n">conf</span><span class="p">,</span> <span class="n">section</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="n">keepRuntimeDirectory</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_RuntimeDirectoryPreserve</span><span class="p">(</span><span class="n">conf</span><span class="p">,</span> <span class="n">section</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="ow">not</span> <span class="n">keepRuntimeDirectory</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">            <span class="n">root</span> <span class="o">=</span> <span class="n">conf</span><span class="o">.</span><span class="n">root_mode</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">            <span class="k">for</span> <span class="n">name</span> <span class="ow">in</span> <span class="n">nameRuntimeDirectory</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&#34; &#34;</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">                <span class="k">if</span> <span class="ow">not</span> <span class="n">name</span><span class="o">.</span><span class="n">strip</span><span class="p">():</span> <span class="k">continue</span>
</span></span><span class="line"><span class="cl">                <span class="n">RUN</span> <span class="o">=</span> <span class="n">get_RUNTIME_DIR</span><span class="p">(</span><span class="n">root</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">                <span class="n">path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">RUN</span><span class="p">,</span> <span class="n">name</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">                <span class="n">dirpath</span> <span class="o">=</span> <span class="n">os_path</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_root</span><span class="p">,</span> <span class="n">path</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">                <span class="n">ok</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">do_rm_tree</span><span class="p">(</span><span class="n">dirpath</span><span class="p">)</span> <span class="ow">and</span> <span class="n">ok</span>
</span></span><span class="line"><span class="cl">                <span class="k">if</span> <span class="n">RUN</span> <span class="o">==</span> <span class="s2">&#34;/run&#34;</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">                    <span class="k">for</span> <span class="n">var_run</span> <span class="ow">in</span> <span class="p">(</span><span class="s2">&#34;/var/run&#34;</span><span class="p">,</span> <span class="s2">&#34;/tmp/run&#34;</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">                        <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isdir</span><span class="p">(</span><span class="n">var_run</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">                            <span class="n">var_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">var_run</span><span class="p">,</span> <span class="n">name</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">                            <span class="n">var_dirpath</span> <span class="o">=</span> <span class="n">os_path</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_root</span><span class="p">,</span> <span class="n">var_path</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">                            <span class="bp">self</span><span class="o">.</span><span class="n">do_rm_tree</span><span class="p">(</span><span class="n">var_dirpath</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="ow">not</span> <span class="n">ok</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">            <span class="n">logg</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&#34;could not fully remove service directory </span><span class="si">%s</span><span class="s2">&#34;</span><span class="p">,</span> <span class="n">path</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="n">ok</span>
</span></span><span class="line"><span class="cl">    <span class="k">def</span> <span class="nf">do_rm_tree</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">path</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">        <span class="n">ok</span> <span class="o">=</span> <span class="kc">True</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isdir</span><span class="p">(</span><span class="n">path</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">            <span class="k">for</span> <span class="n">dirpath</span><span class="p">,</span> <span class="n">dirnames</span><span class="p">,</span> <span class="n">filenames</span> <span class="ow">in</span> <span class="n">os</span><span class="o">.</span><span class="n">walk</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="n">topdown</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">                <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">filenames</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">                    <span class="n">filepath</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">dirpath</span><span class="p">,</span> <span class="n">item</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">                    <span class="k">try</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">                        <span class="n">os</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">filepath</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">                    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span> <span class="c1"># pragma: no cover</span>
</span></span><span class="line"><span class="cl">                        <span class="n">logg</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&#34;not removed file: </span><span class="si">%s</span><span class="s2"> (</span><span class="si">%s</span><span class="s2">)&#34;</span><span class="p">,</span> <span class="n">filepath</span><span class="p">,</span> <span class="n">e</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">                        <span class="n">ok</span> <span class="o">=</span> <span class="kc">False</span>
</span></span><span class="line"><span class="cl">                <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">dirnames</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">                    <span class="n">dir_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">dirpath</span><span class="p">,</span> <span class="n">item</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">                    <span class="k">try</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">                        <span class="n">os</span><span class="o">.</span><span class="n">rmdir</span><span class="p">(</span><span class="n">dir_path</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">                    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span> <span class="c1"># pragma: no cover</span>
</span></span><span class="line"><span class="cl">                        <span class="n">logg</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&#34;not removed dir: </span><span class="si">%s</span><span class="s2"> (</span><span class="si">%s</span><span class="s2">)&#34;</span><span class="p">,</span> <span class="n">dir_path</span><span class="p">,</span> <span class="n">e</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">                        <span class="n">ok</span> <span class="o">=</span> <span class="kc">False</span>
</span></span><span class="line"><span class="cl">            <span class="k">try</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">                <span class="n">os</span><span class="o">.</span><span class="n">rmdir</span><span class="p">(</span><span class="n">path</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">            <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">                <span class="n">logg</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&#34;not removed top dir: </span><span class="si">%s</span><span class="s2"> (</span><span class="si">%s</span><span class="s2">)&#34;</span><span class="p">,</span> <span class="n">path</span><span class="p">,</span> <span class="n">e</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">                <span class="n">ok</span> <span class="o">=</span> <span class="kc">False</span> <span class="c1"># pragma: no cover</span>
</span></span><span class="line"><span class="cl">        <span class="n">logg</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&#34;</span><span class="si">%s</span><span class="s2"> rm_tree </span><span class="si">%s</span><span class="s2">&#34;</span><span class="p">,</span> <span class="n">ok</span> <span class="ow">and</span> <span class="s2">&#34;done&#34;</span> <span class="ow">or</span> <span class="s2">&#34;fail&#34;</span><span class="p">,</span> <span class="n">path</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="n">ok</span>
</span></span><span class="line"><span class="cl">    <span class="k">def</span> <span class="nf">get_RuntimeDirectoryPreserve</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">conf</span><span class="p">,</span> <span class="n">section</span> <span class="o">=</span> <span class="n">Service</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="n">conf</span><span class="o">.</span><span class="n">getbool</span><span class="p">(</span><span class="n">section</span><span class="p">,</span> <span class="s2">&#34;RuntimeDirectoryPreserve&#34;</span><span class="p">,</span> <span class="s2">&#34;no&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="k">def</span> <span class="nf">get_RuntimeDirectory</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">conf</span><span class="p">,</span> <span class="n">section</span> <span class="o">=</span> <span class="n">Service</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">expand_special</span><span class="p">(</span><span class="n">conf</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">section</span><span class="p">,</span> <span class="s2">&#34;RuntimeDirectory&#34;</span><span class="p">,</span> <span class="s2">&#34;&#34;</span><span class="p">),</span> <span class="n">conf</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="k">def</span> <span class="nf">get_StateDirectory</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">conf</span><span class="p">,</span> <span class="n">section</span> <span class="o">=</span> <span class="n">Service</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">expand_special</span><span class="p">(</span><span class="n">conf</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">section</span><span class="p">,</span> <span class="s2">&#34;StateDirectory&#34;</span><span class="p">,</span> <span class="s2">&#34;&#34;</span><span class="p">),</span> <span class="n">conf</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="k">def</span> <span class="nf">get_CacheDirectory</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">conf</span><span class="p">,</span> <span class="n">section</span> <span class="o">=</span> <span class="n">Service</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">expand_special</span><span class="p">(</span><span class="n">conf</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">section</span><span class="p">,</span> <span class="s2">&#34;CacheDirectory&#34;</span><span class="p">,</span> <span class="s2">&#34;&#34;</span><span class="p">),</span> <span class="n">conf</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="k">def</span> <span class="nf">get_LogsDirectory</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">conf</span><span class="p">,</span> <span class="n">section</span> <span class="o">=</span> <span class="n">Service</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">expand_special</span><span class="p">(</span><span class="n">conf</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">section</span><span class="p">,</span> <span class="s2">&#34;LogsDirectory&#34;</span><span class="p">,</span> <span class="s2">&#34;&#34;</span><span class="p">),</span> <span class="n">conf</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="k">def</span> <span class="nf">get_ConfigurationDirectory</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">conf</span><span class="p">,</span> <span class="n">section</span> <span class="o">=</span> <span class="n">Service</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">expand_special</span><span class="p">(</span><span class="n">conf</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">section</span><span class="p">,</span> <span class="s2">&#34;ConfigurationDirectory&#34;</span><span class="p">,</span> <span class="s2">&#34;&#34;</span><span class="p">),</span> <span class="n">conf</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="k">def</span> <span class="nf">get_RuntimeDirectoryMode</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">conf</span><span class="p">,</span> <span class="n">section</span> <span class="o">=</span> <span class="n">Service</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="n">conf</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">section</span><span class="p">,</span> <span class="s2">&#34;RuntimeDirectoryMode&#34;</span><span class="p">,</span> <span class="s2">&#34;&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="k">def</span> <span class="nf">get_StateDirectoryMode</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">conf</span><span class="p">,</span> <span class="n">section</span> <span class="o">=</span> <span class="n">Service</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="n">conf</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">section</span><span class="p">,</span> <span class="s2">&#34;StateDirectoryMode&#34;</span><span class="p">,</span> <span class="s2">&#34;&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="k">def</span> <span class="nf">get_CacheDirectoryMode</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">conf</span><span class="p">,</span> <span class="n">section</span> <span class="o">=</span> <span class="n">Service</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="n">conf</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">section</span><span class="p">,</span> <span class="s2">&#34;CacheDirectoryMode&#34;</span><span class="p">,</span> <span class="s2">&#34;&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="k">def</span> <span class="nf">get_LogsDirectoryMode</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">conf</span><span class="p">,</span> <span class="n">section</span> <span class="o">=</span> <span class="n">Service</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="n">conf</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">section</span><span class="p">,</span> <span class="s2">&#34;LogsDirectoryMode&#34;</span><span class="p">,</span> <span class="s2">&#34;&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="k">def</span> <span class="nf">get_ConfigurationDirectoryMode</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">conf</span><span class="p">,</span> <span class="n">section</span> <span class="o">=</span> <span class="n">Service</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="n">conf</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">section</span><span class="p">,</span> <span class="s2">&#34;ConfigurationDirectoryMode&#34;</span><span class="p">,</span> <span class="s2">&#34;&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="k">def</span> <span class="nf">clean_service_directories</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">conf</span><span class="p">,</span> <span class="n">which</span> <span class="o">=</span> <span class="s2">&#34;&#34;</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">        <span class="n">ok</span> <span class="o">=</span> <span class="kc">True</span>
</span></span><span class="line"><span class="cl">        <span class="n">section</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_unit_section_from</span><span class="p">(</span><span class="n">conf</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="n">nameRuntimeDirectory</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_RuntimeDirectory</span><span class="p">(</span><span class="n">conf</span><span class="p">,</span> <span class="n">section</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="n">nameStateDirectory</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_StateDirectory</span><span class="p">(</span><span class="n">conf</span><span class="p">,</span> <span class="n">section</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="n">nameCacheDirectory</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_CacheDirectory</span><span class="p">(</span><span class="n">conf</span><span class="p">,</span> <span class="n">section</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="n">nameLogsDirectory</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_LogsDirectory</span><span class="p">(</span><span class="n">conf</span><span class="p">,</span> <span class="n">section</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="n">nameConfigurationDirectory</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_ConfigurationDirectory</span><span class="p">(</span><span class="n">conf</span><span class="p">,</span> <span class="n">section</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="n">root</span> <span class="o">=</span> <span class="n">conf</span><span class="o">.</span><span class="n">root_mode</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">        <span class="k">for</span> <span class="n">name</span> <span class="ow">in</span> <span class="n">nameRuntimeDirectory</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&#34; &#34;</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">            <span class="k">if</span> <span class="ow">not</span> <span class="n">name</span><span class="o">.</span><span class="n">strip</span><span class="p">():</span> <span class="k">continue</span>
</span></span><span class="line"><span class="cl">            <span class="n">RUN</span> <span class="o">=</span> <span class="n">get_RUNTIME_DIR</span><span class="p">(</span><span class="n">root</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">            <span class="n">path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">RUN</span><span class="p">,</span> <span class="n">name</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">            <span class="k">if</span> <span class="n">which</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&#34;all&#34;</span><span class="p">,</span> <span class="s2">&#34;runtime&#34;</span><span class="p">,</span> <span class="s2">&#34;&#34;</span><span class="p">]:</span>
</span></span><span class="line"><span class="cl">                <span class="n">dirpath</span> <span class="o">=</span> <span class="n">os_path</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_root</span><span class="p">,</span> <span class="n">path</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">                <span class="n">ok</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">do_rm_tree</span><span class="p">(</span><span class="n">dirpath</span><span class="p">)</span> <span class="ow">and</span> <span class="n">ok</span>
</span></span><span class="line"><span class="cl">                <span class="k">if</span> <span class="n">RUN</span> <span class="o">==</span> <span class="s2">&#34;/run&#34;</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">                    <span class="k">for</span> <span class="n">var_run</span> <span class="ow">in</span> <span class="p">(</span><span class="s2">&#34;/var/run&#34;</span><span class="p">,</span> <span class="s2">&#34;/tmp/run&#34;</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">                        <span class="n">var_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">var_run</span><span class="p">,</span> <span class="n">name</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">                        <span class="n">var_dirpath</span> <span class="o">=</span> <span class="n">os_path</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_root</span><span class="p">,</span> <span class="n">var_path</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">                        <span class="bp">self</span><span class="o">.</span><span class="n">do_rm_tree</span><span class="p">(</span><span class="n">var_dirpath</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="k">for</span> <span class="n">name</span> <span class="ow">in</span> <span class="n">nameStateDirectory</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&#34; &#34;</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">            <span class="k">if</span> <span class="ow">not</span> <span class="n">name</span><span class="o">.</span><span class="n">strip</span><span class="p">():</span> <span class="k">continue</span>
</span></span><span class="line"><span class="cl">            <span class="n">DAT</span> <span class="o">=</span> <span class="n">get_VARLIB_HOME</span><span class="p">(</span><span class="n">root</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">            <span class="n">path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">DAT</span><span class="p">,</span> <span class="n">name</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">            <span class="k">if</span> <span class="n">which</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&#34;all&#34;</span><span class="p">,</span> <span class="s2">&#34;state&#34;</span><span class="p">]:</span>
</span></span><span class="line"><span class="cl">                <span class="n">dirpath</span> <span class="o">=</span> <span class="n">os_path</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_root</span><span class="p">,</span> <span class="n">path</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">                <span class="n">ok</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">do_rm_tree</span><span class="p">(</span><span class="n">dirpath</span><span class="p">)</span> <span class="ow">and</span> <span class="n">ok</span>
</span></span><span class="line"><span class="cl">        <span class="k">for</span> <span class="n">name</span> <span class="ow">in</span> <span class="n">nameCacheDirectory</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&#34; &#34;</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">            <span class="k">if</span> <span class="ow">not</span> <span class="n">name</span><span class="o">.</span><span class="n">strip</span><span class="p">():</span> <span class="k">continue</span>
</span></span><span class="line"><span class="cl">            <span class="n">CACHE</span> <span class="o">=</span> <span class="n">get_CACHE_HOME</span><span class="p">(</span><span class="n">root</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">            <span class="n">path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">CACHE</span><span class="p">,</span> <span class="n">name</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">            <span class="k">if</span> <span class="n">which</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&#34;all&#34;</span><span class="p">,</span> <span class="s2">&#34;cache&#34;</span><span class="p">,</span> <span class="s2">&#34;&#34;</span><span class="p">]:</span>
</span></span><span class="line"><span class="cl">                <span class="n">dirpath</span> <span class="o">=</span> <span class="n">os_path</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_root</span><span class="p">,</span> <span class="n">path</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">                <span class="n">ok</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">do_rm_tree</span><span class="p">(</span><span class="n">dirpath</span><span class="p">)</span> <span class="ow">and</span> <span class="n">ok</span>
</span></span><span class="line"><span class="cl">        <span class="k">for</span> <span class="n">name</span> <span class="ow">in</span> <span class="n">nameLogsDirectory</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&#34; &#34;</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">            <span class="k">if</span> <span class="ow">not</span> <span class="n">name</span><span class="o">.</span><span class="n">strip</span><span class="p">():</span> <span class="k">continue</span>
</span></span><span class="line"><span class="cl">            <span class="n">LOGS</span> <span class="o">=</span> <span class="n">get_LOG_DIR</span><span class="p">(</span><span class="n">root</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">            <span class="n">path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">LOGS</span><span class="p">,</span> <span class="n">name</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">            <span class="k">if</span> <span class="n">which</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&#34;all&#34;</span><span class="p">,</span> <span class="s2">&#34;logs&#34;</span><span class="p">]:</span>
</span></span><span class="line"><span class="cl">                <span class="n">dirpath</span> <span class="o">=</span> <span class="n">os_path</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_root</span><span class="p">,</span> <span class="n">path</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">                <span class="n">ok</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">do_rm_tree</span><span class="p">(</span><span class="n">dirpath</span><span class="p">)</span> <span class="ow">and</span> <span class="n">ok</span>
</span></span><span class="line"><span class="cl">        <span class="k">for</span> <span class="n">name</span> <span class="ow">in</span> <span class="n">nameConfigurationDirectory</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&#34; &#34;</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">            <span class="k">if</span> <span class="ow">not</span> <span class="n">name</span><span class="o">.</span><span class="n">strip</span><span class="p">():</span> <span class="k">continue</span>
</span></span><span class="line"><span class="cl">            <span class="n">CONFIG</span> <span class="o">=</span> <span class="n">get_CONFIG_HOME</span><span class="p">(</span><span class="n">root</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">            <span class="n">path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">CONFIG</span><span class="p">,</span> <span class="n">name</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">            <span class="k">if</span> <span class="n">which</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&#34;all&#34;</span><span class="p">,</span> <span class="s2">&#34;configuration&#34;</span><span class="p">,</span> <span class="s2">&#34;&#34;</span><span class="p">]:</span>
</span></span><span class="line"><span class="cl">                <span class="n">dirpath</span> <span class="o">=</span> <span class="n">os_path</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_root</span><span class="p">,</span> <span class="n">path</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">                <span class="n">ok</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">do_rm_tree</span><span class="p">(</span><span class="n">dirpath</span><span class="p">)</span> <span class="ow">and</span> <span class="n">ok</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="n">ok</span>
</span></span><span class="line"><span class="cl">    <span class="k">def</span> <span class="nf">env_service_directories</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">conf</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">        <span class="n">envs</span> <span class="o">=</span> <span class="p">{}</span>
</span></span><span class="line"><span class="cl">        <span class="n">section</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_unit_section_from</span><span class="p">(</span><span class="n">conf</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="n">nameRuntimeDirectory</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_RuntimeDirectory</span><span class="p">(</span><span class="n">conf</span><span class="p">,</span> <span class="n">section</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="n">nameStateDirectory</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_StateDirectory</span><span class="p">(</span><span class="n">conf</span><span class="p">,</span> <span class="n">section</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="n">nameCacheDirectory</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_CacheDirectory</span><span class="p">(</span><span class="n">conf</span><span class="p">,</span> <span class="n">section</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="n">nameLogsDirectory</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_LogsDirectory</span><span class="p">(</span><span class="n">conf</span><span class="p">,</span> <span class="n">section</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="n">nameConfigurationDirectory</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_ConfigurationDirectory</span><span class="p">(</span><span class="n">conf</span><span class="p">,</span> <span class="n">section</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="n">root</span> <span class="o">=</span> <span class="n">conf</span><span class="o">.</span><span class="n">root_mode</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">        <span class="k">for</span> <span class="n">name</span> <span class="ow">in</span> <span class="n">nameRuntimeDirectory</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&#34; &#34;</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">            <span class="k">if</span> <span class="ow">not</span> <span class="n">name</span><span class="o">.</span><span class="n">strip</span><span class="p">():</span> <span class="k">continue</span>
</span></span><span class="line"><span class="cl">            <span class="n">RUN</span> <span class="o">=</span> <span class="n">get_RUNTIME_DIR</span><span class="p">(</span><span class="n">root</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">            <span class="n">path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">RUN</span><span class="p">,</span> <span class="n">name</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">            <span class="n">envs</span><span class="p">[</span><span class="s2">&#34;RUNTIME_DIRECTORY&#34;</span><span class="p">]</span> <span class="o">=</span> <span class="n">path</span>
</span></span><span class="line"><span class="cl">        <span class="k">for</span> <span class="n">name</span> <span class="ow">in</span> <span class="n">nameStateDirectory</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&#34; &#34;</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">            <span class="k">if</span> <span class="ow">not</span> <span class="n">name</span><span class="o">.</span><span class="n">strip</span><span class="p">():</span> <span class="k">continue</span>
</span></span><span class="line"><span class="cl">            <span class="n">DAT</span> <span class="o">=</span> <span class="n">get_VARLIB_HOME</span><span class="p">(</span><span class="n">root</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">            <span class="n">path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">DAT</span><span class="p">,</span> <span class="n">name</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">            <span class="n">envs</span><span class="p">[</span><span class="s2">&#34;STATE_DIRECTORY&#34;</span><span class="p">]</span> <span class="o">=</span> <span class="n">path</span>
</span></span><span class="line"><span class="cl">        <span class="k">for</span> <span class="n">name</span> <span class="ow">in</span> <span class="n">nameCacheDirectory</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&#34; &#34;</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">            <span class="k">if</span> <span class="ow">not</span> <span class="n">name</span><span class="o">.</span><span class="n">strip</span><span class="p">():</span> <span class="k">continue</span>
</span></span><span class="line"><span class="cl">            <span class="n">CACHE</span> <span class="o">=</span> <span class="n">get_CACHE_HOME</span><span class="p">(</span><span class="n">root</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">            <span class="n">path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">CACHE</span><span class="p">,</span> <span class="n">name</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">            <span class="n">envs</span><span class="p">[</span><span class="s2">&#34;CACHE_DIRECTORY&#34;</span><span class="p">]</span> <span class="o">=</span> <span class="n">path</span>
</span></span><span class="line"><span class="cl">        <span class="k">for</span> <span class="n">name</span> <span class="ow">in</span> <span class="n">nameLogsDirectory</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&#34; &#34;</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">            <span class="k">if</span> <span class="ow">not</span> <span class="n">name</span><span class="o">.</span><span class="n">strip</span><span class="p">():</span> <span class="k">continue</span>
</span></span><span class="line"><span class="cl">            <span class="n">LOGS</span> <span class="o">=</span> <span class="n">get_LOG_DIR</span><span class="p">(</span><span class="n">root</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">            <span class="n">path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">LOGS</span><span class="p">,</span> <span class="n">name</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">            <span class="n">envs</span><span class="p">[</span><span class="s2">&#34;LOGS_DIRECTORY&#34;</span><span class="p">]</span> <span class="o">=</span> <span class="n">path</span>
</span></span><span class="line"><span class="cl">        <span class="k">for</span> <span class="n">name</span> <span class="ow">in</span> <span class="n">nameConfigurationDirectory</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&#34; &#34;</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">            <span class="k">if</span> <span class="ow">not</span> <span class="n">name</span><span class="o">.</span><span class="n">strip</span><span class="p">():</span> <span class="k">continue</span>
</span></span><span class="line"><span class="cl">            <span class="n">CONFIG</span> <span class="o">=</span> <span class="n">get_CONFIG_HOME</span><span class="p">(</span><span class="n">root</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">            <span class="n">path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">CONFIG</span><span class="p">,</span> <span class="n">name</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">            <span class="n">envs</span><span class="p">[</span><span class="s2">&#34;CONFIGURATION_DIRECTORY&#34;</span><span class="p">]</span> <span class="o">=</span> <span class="n">path</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="n">envs</span>
</span></span><span class="line"><span class="cl">    <span class="k">def</span> <span class="nf">create_service_directories</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">conf</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">        <span class="n">envs</span> <span class="o">=</span> <span class="p">{}</span>
</span></span><span class="line"><span class="cl">        <span class="n">section</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_unit_section_from</span><span class="p">(</span><span class="n">conf</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="n">nameRuntimeDirectory</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_RuntimeDirectory</span><span class="p">(</span><span class="n">conf</span><span class="p">,</span> <span class="n">section</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="n">modeRuntimeDirectory</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_RuntimeDirectoryMode</span><span class="p">(</span><span class="n">conf</span><span class="p">,</span> <span class="n">section</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="n">nameStateDirectory</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_StateDirectory</span><span class="p">(</span><span class="n">conf</span><span class="p">,</span> <span class="n">section</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="n">modeStateDirectory</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_StateDirectoryMode</span><span class="p">(</span><span class="n">conf</span><span class="p">,</span> <span class="n">section</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="n">nameCacheDirectory</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_CacheDirectory</span><span class="p">(</span><span class="n">conf</span><span class="p">,</span> <span class="n">section</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="n">modeCacheDirectory</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_CacheDirectoryMode</span><span class="p">(</span><span class="n">conf</span><span class="p">,</span> <span class="n">section</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="n">nameLogsDirectory</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_LogsDirectory</span><span class="p">(</span><span class="n">conf</span><span class="p">,</span> <span class="n">section</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="n">modeLogsDirectory</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_LogsDirectoryMode</span><span class="p">(</span><span class="n">conf</span><span class="p">,</span> <span class="n">section</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="n">nameConfigurationDirectory</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_ConfigurationDirectory</span><span class="p">(</span><span class="n">conf</span><span class="p">,</span> <span class="n">section</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="n">modeConfigurationDirectory</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_ConfigurationDirectoryMode</span><span class="p">(</span><span class="n">conf</span><span class="p">,</span> <span class="n">section</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="n">root</span> <span class="o">=</span> <span class="n">conf</span><span class="o">.</span><span class="n">root_mode</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">        <span class="n">user</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_User</span><span class="p">(</span><span class="n">conf</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="n">group</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_Group</span><span class="p">(</span><span class="n">conf</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="k">for</span> <span class="n">name</span> <span class="ow">in</span> <span class="n">nameRuntimeDirectory</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&#34; &#34;</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">            <span class="k">if</span> <span class="ow">not</span> <span class="n">name</span><span class="o">.</span><span class="n">strip</span><span class="p">():</span> <span class="k">continue</span>
</span></span><span class="line"><span class="cl">            <span class="n">RUN</span> <span class="o">=</span> <span class="n">get_RUNTIME_DIR</span><span class="p">(</span><span class="n">root</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">            <span class="n">path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">RUN</span><span class="p">,</span> <span class="n">name</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">            <span class="n">logg</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&#34;RuntimeDirectory </span><span class="si">%s</span><span class="s2">&#34;</span><span class="p">,</span> <span class="n">path</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">            <span class="bp">self</span><span class="o">.</span><span class="n">make_service_directory</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="n">modeRuntimeDirectory</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">            <span class="bp">self</span><span class="o">.</span><span class="n">chown_service_directory</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="n">user</span><span class="p">,</span> <span class="n">group</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">            <span class="n">envs</span><span class="p">[</span><span class="s2">&#34;RUNTIME_DIRECTORY&#34;</span><span class="p">]</span> <span class="o">=</span> <span class="n">path</span>
</span></span><span class="line"><span class="cl">            <span class="k">if</span> <span class="n">RUN</span> <span class="o">==</span> <span class="s2">&#34;/run&#34;</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">                <span class="k">for</span> <span class="n">var_run</span> <span class="ow">in</span> <span class="p">(</span><span class="s2">&#34;/var/run&#34;</span><span class="p">,</span> <span class="s2">&#34;/tmp/run&#34;</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">                    <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isdir</span><span class="p">(</span><span class="n">var_run</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">                        <span class="n">var_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">var_run</span><span class="p">,</span> <span class="n">name</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">                        <span class="n">var_dirpath</span> <span class="o">=</span> <span class="n">os_path</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_root</span><span class="p">,</span> <span class="n">var_path</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">                        <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isdir</span><span class="p">(</span><span class="n">var_dirpath</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">                            <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">islink</span><span class="p">(</span><span class="n">var_dirpath</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">                                <span class="n">logg</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&#34;not a symlink: </span><span class="si">%s</span><span class="s2">&#34;</span><span class="p">,</span> <span class="n">var_dirpath</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">                            <span class="k">continue</span>
</span></span><span class="line"><span class="cl">                        <span class="n">dirpath</span> <span class="o">=</span> <span class="n">os_path</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_root</span><span class="p">,</span> <span class="n">path</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">                        <span class="n">basepath</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="n">var_dirpath</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">                        <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isdir</span><span class="p">(</span><span class="n">basepath</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">                            <span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="n">basepath</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">                        <span class="k">try</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">                            <span class="n">os</span><span class="o">.</span><span class="n">symlink</span><span class="p">(</span><span class="n">dirpath</span><span class="p">,</span> <span class="n">var_dirpath</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">                        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">                            <span class="n">logg</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&#34;var symlink </span><span class="si">%s</span><span class="se">\n\t</span><span class="si">%s</span><span class="s2">&#34;</span><span class="p">,</span> <span class="n">var_dirpath</span><span class="p">,</span> <span class="n">e</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="k">for</span> <span class="n">name</span> <span class="ow">in</span> <span class="n">nameStateDirectory</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&#34; &#34;</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">            <span class="k">if</span> <span class="ow">not</span> <span class="n">name</span><span class="o">.</span><span class="n">strip</span><span class="p">():</span> <span class="k">continue</span>
</span></span><span class="line"><span class="cl">            <span class="n">DAT</span> <span class="o">=</span> <span class="n">get_VARLIB_HOME</span><span class="p">(</span><span class="n">root</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">            <span class="n">path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">DAT</span><span class="p">,</span> <span class="n">name</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">            <span class="n">logg</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&#34;StateDirectory </span><span class="si">%s</span><span class="s2">&#34;</span><span class="p">,</span> <span class="n">path</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">            <span class="bp">self</span><span class="o">.</span><span class="n">make_service_directory</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="n">modeStateDirectory</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">            <span class="bp">self</span><span class="o">.</span><span class="n">chown_service_directory</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="n">user</span><span class="p">,</span> <span class="n">group</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">            <span class="n">envs</span><span class="p">[</span><span class="s2">&#34;STATE_DIRECTORY&#34;</span><span class="p">]</span> <span class="o">=</span> <span class="n">path</span>
</span></span><span class="line"><span class="cl">        <span class="k">for</span> <span class="n">name</span> <span class="ow">in</span> <span class="n">nameCacheDirectory</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&#34; &#34;</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">            <span class="k">if</span> <span class="ow">not</span> <span class="n">name</span><span class="o">.</span><span class="n">strip</span><span class="p">():</span> <span class="k">continue</span>
</span></span><span class="line"><span class="cl">            <span class="n">CACHE</span> <span class="o">=</span> <span class="n">get_CACHE_HOME</span><span class="p">(</span><span class="n">root</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">            <span class="n">path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">CACHE</span><span class="p">,</span> <span class="n">name</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">            <span class="n">logg</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&#34;CacheDirectory </span><span class="si">%s</span><span class="s2">&#34;</span><span class="p">,</span> <span class="n">path</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">            <span class="bp">self</span><span class="o">.</span><span class="n">make_service_directory</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="n">modeCacheDirectory</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">            <span class="bp">self</span><span class="o">.</span><span class="n">chown_service_directory</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="n">user</span><span class="p">,</span> <span class="n">group</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">            <span class="n">envs</span><span class="p">[</span><span class="s2">&#34;CACHE_DIRECTORY&#34;</span><span class="p">]</span> <span class="o">=</span> <span class="n">path</span>
</span></span><span class="line"><span class="cl">        <span class="k">for</span> <span class="n">name</span> <span class="ow">in</span> <span class="n">nameLogsDirectory</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&#34; &#34;</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">            <span class="k">if</span> <span class="ow">not</span> <span class="n">name</span><span class="o">.</span><span class="n">strip</span><span class="p">():</span> <span class="k">continue</span>
</span></span><span class="line"><span class="cl">            <span class="n">LOGS</span> <span class="o">=</span> <span class="n">get_LOG_DIR</span><span class="p">(</span><span class="n">root</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">            <span class="n">path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">LOGS</span><span class="p">,</span> <span class="n">name</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">            <span class="n">logg</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&#34;LogsDirectory </span><span class="si">%s</span><span class="s2">&#34;</span><span class="p">,</span> <span class="n">path</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">            <span class="bp">self</span><span class="o">.</span><span class="n">make_service_directory</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="n">modeLogsDirectory</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">            <span class="bp">self</span><span class="o">.</span><span class="n">chown_service_directory</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="n">user</span><span class="p">,</span> <span class="n">group</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">            <span class="n">envs</span><span class="p">[</span><span class="s2">&#34;LOGS_DIRECTORY&#34;</span><span class="p">]</span> <span class="o">=</span> <span class="n">path</span>
</span></span><span class="line"><span class="cl">        <span class="k">for</span> <span class="n">name</span> <span class="ow">in</span> <span class="n">nameConfigurationDirectory</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&#34; &#34;</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">            <span class="k">if</span> <span class="ow">not</span> <span class="n">name</span><span class="o">.</span><span class="n">strip</span><span class="p">():</span> <span class="k">continue</span>
</span></span><span class="line"><span class="cl">            <span class="n">CONFIG</span> <span class="o">=</span> <span class="n">get_CONFIG_HOME</span><span class="p">(</span><span class="n">root</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">            <span class="n">path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">CONFIG</span><span class="p">,</span> <span class="n">name</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">            <span class="n">logg</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&#34;ConfigurationDirectory </span><span class="si">%s</span><span class="s2">&#34;</span><span class="p">,</span> <span class="n">path</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">            <span class="bp">self</span><span class="o">.</span><span class="n">make_service_directory</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="n">modeConfigurationDirectory</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">            <span class="c1"># not done according the standard</span>
</span></span><span class="line"><span class="cl">            <span class="c1"># self.chown_service_directory(path, user, group)</span>
</span></span><span class="line"><span class="cl">            <span class="n">envs</span><span class="p">[</span><span class="s2">&#34;CONFIGURATION_DIRECTORY&#34;</span><span class="p">]</span> <span class="o">=</span> <span class="n">path</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="n">envs</span>
</span></span><span class="line"><span class="cl">    <span class="k">def</span> <span class="nf">make_service_directory</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">path</span><span class="p">,</span> <span class="n">mode</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">        <span class="n">ok</span> <span class="o">=</span> <span class="kc">True</span>
</span></span><span class="line"><span class="cl">        <span class="n">dirpath</span> <span class="o">=</span> <span class="n">os_path</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_root</span><span class="p">,</span> <span class="n">path</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isdir</span><span class="p">(</span><span class="n">dirpath</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">            <span class="k">try</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">                <span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="n">dirpath</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">                <span class="n">logg</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&#34;created directory path: </span><span class="si">%s</span><span class="s2">&#34;</span><span class="p">,</span> <span class="n">dirpath</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">            <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span> <span class="c1"># pragma: no cover</span>
</span></span><span class="line"><span class="cl">                <span class="n">logg</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&#34;errors directory path: </span><span class="si">%s</span><span class="se">\n\t</span><span class="si">%s</span><span class="s2">&#34;</span><span class="p">,</span> <span class="n">dirpath</span><span class="p">,</span> <span class="n">e</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">                <span class="n">ok</span> <span class="o">=</span> <span class="kc">False</span>
</span></span><span class="line"><span class="cl">            <span class="n">filemode</span> <span class="o">=</span> <span class="n">int_mode</span><span class="p">(</span><span class="n">mode</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">            <span class="k">if</span> <span class="n">filemode</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">                <span class="k">try</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">                    <span class="n">os</span><span class="o">.</span><span class="n">chmod</span><span class="p">(</span><span class="n">dirpath</span><span class="p">,</span> <span class="n">filemode</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">                <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span> <span class="c1"># pragma: no cover</span>
</span></span><span class="line"><span class="cl">                    <span class="n">logg</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&#34;errors directory path: </span><span class="si">%s</span><span class="se">\n\t</span><span class="si">%s</span><span class="s2">&#34;</span><span class="p">,</span> <span class="n">dirpath</span><span class="p">,</span> <span class="n">e</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">                    <span class="n">ok</span> <span class="o">=</span> <span class="kc">False</span>
</span></span><span class="line"><span class="cl">        <span class="k">else</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">            <span class="n">logg</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&#34;path did already exist: </span><span class="si">%s</span><span class="s2">&#34;</span><span class="p">,</span> <span class="n">dirpath</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="ow">not</span> <span class="n">ok</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">            <span class="n">logg</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&#34;could not fully create service directory </span><span class="si">%s</span><span class="s2">&#34;</span><span class="p">,</span> <span class="n">path</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="n">ok</span>
</span></span><span class="line"><span class="cl">    <span class="k">def</span> <span class="nf">chown_service_directory</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">path</span><span class="p">,</span> <span class="n">user</span><span class="p">,</span> <span class="n">group</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">        <span class="c1"># the standard defines an optimization so that if the parent</span>
</span></span><span class="line"><span class="cl">        <span class="c1"># directory does have the correct user and group then there</span>
</span></span><span class="line"><span class="cl">        <span class="c1"># is no other chown on files and subdirectories to be done.</span>
</span></span><span class="line"><span class="cl">        <span class="n">dirpath</span> <span class="o">=</span> <span class="n">os_path</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_root</span><span class="p">,</span> <span class="n">path</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isdir</span><span class="p">(</span><span class="n">dirpath</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">            <span class="n">logg</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&#34;chown did not find </span><span class="si">%s</span><span class="s2">&#34;</span><span class="p">,</span> <span class="n">dirpath</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">            <span class="k">return</span> <span class="kc">True</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="n">user</span> <span class="ow">or</span> <span class="n">group</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">            <span class="n">st</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">stat</span><span class="p">(</span><span class="n">dirpath</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">            <span class="n">st_user</span> <span class="o">=</span> <span class="n">pwd</span><span class="o">.</span><span class="n">getpwuid</span><span class="p">(</span><span class="n">st</span><span class="o">.</span><span class="n">st_uid</span><span class="p">)</span><span class="o">.</span><span class="n">pw_name</span>
</span></span><span class="line"><span class="cl">            <span class="n">st_group</span> <span class="o">=</span> <span class="n">grp</span><span class="o">.</span><span class="n">getgrgid</span><span class="p">(</span><span class="n">st</span><span class="o">.</span><span class="n">st_gid</span><span class="p">)</span><span class="o">.</span><span class="n">gr_name</span>
</span></span><span class="line"><span class="cl">            <span class="n">change</span> <span class="o">=</span> <span class="kc">False</span>
</span></span><span class="line"><span class="cl">            <span class="k">if</span> <span class="n">user</span> <span class="ow">and</span> <span class="p">(</span><span class="n">user</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span> <span class="o">!=</span> <span class="n">st_user</span> <span class="ow">and</span> <span class="n">user</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span> <span class="o">!=</span> <span class="nb">str</span><span class="p">(</span><span class="n">st</span><span class="o">.</span><span class="n">st_uid</span><span class="p">)):</span>
</span></span><span class="line"><span class="cl">                <span class="n">change</span> <span class="o">=</span> <span class="kc">True</span>
</span></span><span class="line"><span class="cl">            <span class="k">if</span> <span class="n">group</span> <span class="ow">and</span> <span class="p">(</span><span class="n">group</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span> <span class="o">!=</span> <span class="n">st_group</span> <span class="ow">and</span> <span class="n">group</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span> <span class="o">!=</span> <span class="nb">str</span><span class="p">(</span><span class="n">st</span><span class="o">.</span><span class="n">st_gid</span><span class="p">)):</span>
</span></span><span class="line"><span class="cl">                <span class="n">change</span> <span class="o">=</span> <span class="kc">True</span>
</span></span><span class="line"><span class="cl">            <span class="k">if</span> <span class="n">change</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">                <span class="n">logg</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&#34;do chown </span><span class="si">%s</span><span class="s2">&#34;</span><span class="p">,</span> <span class="n">dirpath</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">                <span class="k">try</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">                    <span class="n">ok</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">do_chown_tree</span><span class="p">(</span><span class="n">dirpath</span><span class="p">,</span> <span class="n">user</span><span class="p">,</span> <span class="n">group</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">                    <span class="n">logg</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&#34;changed </span><span class="si">%s</span><span class="s2">:</span><span class="si">%s</span><span class="s2"> </span><span class="si">%s</span><span class="s2">&#34;</span><span class="p">,</span> <span class="n">user</span><span class="p">,</span> <span class="n">group</span><span class="p">,</span> <span class="n">ok</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">                    <span class="k">return</span> <span class="n">ok</span>
</span></span><span class="line"><span class="cl">                <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">                    <span class="n">logg</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&#34;oops </span><span class="si">%s</span><span class="se">\n\t</span><span class="si">%s</span><span class="s2">&#34;</span><span class="p">,</span> <span class="n">dirpath</span><span class="p">,</span> <span class="n">e</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">            <span class="k">else</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">                <span class="n">logg</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&#34;untouched </span><span class="si">%s</span><span class="s2">&#34;</span><span class="p">,</span> <span class="n">dirpath</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="kc">True</span>
</span></span><span class="line"><span class="cl">    <span class="k">def</span> <span class="nf">do_chown_tree</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">path</span><span class="p">,</span> <span class="n">user</span><span class="p">,</span> <span class="n">group</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">        <span class="n">ok</span> <span class="o">=</span> <span class="kc">True</span>
</span></span><span class="line"><span class="cl">        <span class="n">uid</span><span class="p">,</span> <span class="n">gid</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="n">user</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">            <span class="n">uid</span> <span class="o">=</span> <span class="n">pwd</span><span class="o">.</span><span class="n">getpwnam</span><span class="p">(</span><span class="n">user</span><span class="p">)</span><span class="o">.</span><span class="n">pw_uid</span>
</span></span><span class="line"><span class="cl">            <span class="n">gid</span> <span class="o">=</span> <span class="n">pwd</span><span class="o">.</span><span class="n">getpwnam</span><span class="p">(</span><span class="n">user</span><span class="p">)</span><span class="o">.</span><span class="n">pw_gid</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="n">group</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">            <span class="n">gid</span> <span class="o">=</span> <span class="n">grp</span><span class="o">.</span><span class="n">getgrnam</span><span class="p">(</span><span class="n">group</span><span class="p">)</span><span class="o">.</span><span class="n">gr_gid</span>
</span></span><span class="line"><span class="cl">        <span class="k">for</span> <span class="n">dirpath</span><span class="p">,</span> <span class="n">dirnames</span><span class="p">,</span> <span class="n">filenames</span> <span class="ow">in</span> <span class="n">os</span><span class="o">.</span><span class="n">walk</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="n">topdown</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">            <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">filenames</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">                <span class="n">filepath</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">dirpath</span><span class="p">,</span> <span class="n">item</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">                <span class="k">try</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">                    <span class="n">os</span><span class="o">.</span><span class="n">chown</span><span class="p">(</span><span class="n">filepath</span><span class="p">,</span> <span class="n">uid</span><span class="p">,</span> <span class="n">gid</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">                <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span> <span class="c1"># pragma: no cover</span>
</span></span><span class="line"><span class="cl">                    <span class="n">logg</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&#34;could not set </span><span class="si">%s</span><span class="s2">:</span><span class="si">%s</span><span class="s2"> on </span><span class="si">%s</span><span class="se">\n\t</span><span class="si">%s</span><span class="s2">&#34;</span><span class="p">,</span> <span class="n">user</span><span class="p">,</span> <span class="n">group</span><span class="p">,</span> <span class="n">filepath</span><span class="p">,</span> <span class="n">e</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">                    <span class="n">ok</span> <span class="o">=</span> <span class="kc">False</span>
</span></span><span class="line"><span class="cl">            <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">dirnames</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">                <span class="n">dir_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">dirpath</span><span class="p">,</span> <span class="n">item</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">                <span class="k">try</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">                    <span class="n">os</span><span class="o">.</span><span class="n">chown</span><span class="p">(</span><span class="n">dir_path</span><span class="p">,</span> <span class="n">uid</span><span class="p">,</span> <span class="n">gid</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">                <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span> <span class="c1"># pragma: no cover</span>
</span></span><span class="line"><span class="cl">                    <span class="n">logg</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&#34;could not set </span><span class="si">%s</span><span class="s2">:</span><span class="si">%s</span><span class="s2"> on </span><span class="si">%s</span><span class="se">\n\t</span><span class="si">%s</span><span class="s2">&#34;</span><span class="p">,</span> <span class="n">user</span><span class="p">,</span> <span class="n">group</span><span class="p">,</span> <span class="n">dir_path</span><span class="p">,</span> <span class="n">e</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">                    <span class="n">ok</span> <span class="o">=</span> <span class="kc">False</span>
</span></span><span class="line"><span class="cl">        <span class="k">try</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">            <span class="n">os</span><span class="o">.</span><span class="n">chown</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="n">uid</span><span class="p">,</span> <span class="n">gid</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span> <span class="c1"># pragma: no cover</span>
</span></span><span class="line"><span class="cl">            <span class="n">logg</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&#34;could not set </span><span class="si">%s</span><span class="s2">:</span><span class="si">%s</span><span class="s2"> on </span><span class="si">%s</span><span class="se">\n\t</span><span class="si">%s</span><span class="s2">&#34;</span><span class="p">,</span> <span class="n">user</span><span class="p">,</span> <span class="n">group</span><span class="p">,</span> <span class="n">path</span><span class="p">,</span> <span class="n">e</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">            <span class="n">ok</span> <span class="o">=</span> <span class="kc">False</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="ow">not</span> <span class="n">ok</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">            <span class="n">logg</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&#34;could not chown </span><span class="si">%s</span><span class="s2">:</span><span class="si">%s</span><span class="s2"> service directory </span><span class="si">%s</span><span class="s2">&#34;</span><span class="p">,</span> <span class="n">user</span><span class="p">,</span> <span class="n">group</span><span class="p">,</span> <span class="n">path</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="n">ok</span>
</span></span><span class="line"><span class="cl">    <span class="k">def</span> <span class="nf">clean_modules</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">modules</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">        <span class="s2">&#34;&#34;&#34; [UNIT]... -- remove the state directories
</span></span></span><span class="line"><span class="cl"><span class="s2">        /// it recognizes --what=all or any of configuration, state, cache, logs, runtime
</span></span></span><span class="line"><span class="cl"><span class="s2">            while an empty value (the default) removes cache and runtime directories&#34;&#34;&#34;</span>
</span></span><span class="line"><span class="cl">        <span class="n">found_all</span> <span class="o">=</span> <span class="kc">True</span>
</span></span><span class="line"><span class="cl">        <span class="n">units</span> <span class="o">=</span> <span class="p">[]</span>
</span></span><span class="line"><span class="cl">        <span class="k">for</span> <span class="n">module</span> <span class="ow">in</span> <span class="n">modules</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">            <span class="n">matched</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">match_units</span><span class="p">(</span><span class="n">to_list</span><span class="p">(</span><span class="n">module</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">            <span class="k">if</span> <span class="ow">not</span> <span class="n">matched</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">                <span class="n">logg</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&#34;Unit </span><span class="si">%s</span><span class="s2"> not found.&#34;</span><span class="p">,</span> <span class="n">unit_of</span><span class="p">(</span><span class="n">module</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">                <span class="bp">self</span><span class="o">.</span><span class="n">error</span> <span class="o">|=</span> <span class="n">NOT_FOUND</span>
</span></span><span class="line"><span class="cl">                <span class="n">found_all</span> <span class="o">=</span> <span class="kc">False</span>
</span></span><span class="line"><span class="cl">                <span class="k">continue</span>
</span></span><span class="line"><span class="cl">            <span class="k">for</span> <span class="n">unit</span> <span class="ow">in</span> <span class="n">matched</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">                <span class="k">if</span> <span class="n">unit</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">units</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">                    <span class="n">units</span> <span class="o">+=</span> <span class="p">[</span><span class="n">unit</span><span class="p">]</span>
</span></span><span class="line"><span class="cl">        <span class="n">lines</span> <span class="o">=</span> <span class="n">_log_lines</span>
</span></span><span class="line"><span class="cl">        <span class="n">follow</span> <span class="o">=</span> <span class="n">_force</span>
</span></span><span class="line"><span class="cl">        <span class="n">ok</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">clean_units</span><span class="p">(</span><span class="n">units</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="n">ok</span> <span class="ow">and</span> <span class="n">found_all</span>
</span></span><span class="line"><span class="cl">    <span class="k">def</span> <span class="nf">clean_units</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">units</span><span class="p">,</span> <span class="n">what</span> <span class="o">=</span> <span class="s2">&#34;&#34;</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="ow">not</span> <span class="n">what</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">            <span class="n">what</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_only_what</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
</span></span><span class="line"><span class="cl">        <span class="n">ok</span> <span class="o">=</span> <span class="kc">True</span>
</span></span><span class="line"><span class="cl">        <span class="k">for</span> <span class="n">unit</span> <span class="ow">in</span> <span class="n">units</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">            <span class="n">ok</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">clean_unit</span><span class="p">(</span><span class="n">unit</span><span class="p">,</span> <span class="n">what</span><span class="p">)</span> <span class="ow">and</span> <span class="n">ok</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="n">ok</span>
</span></span><span class="line"><span class="cl">    <span class="k">def</span> <span class="nf">clean_unit</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">unit</span><span class="p">,</span> <span class="n">what</span> <span class="o">=</span> <span class="s2">&#34;&#34;</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">        <span class="n">conf</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">load_unit_conf</span><span class="p">(</span><span class="n">unit</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="ow">not</span> <span class="n">conf</span><span class="p">:</span> <span class="k">return</span> <span class="kc">False</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">clean_unit_from</span><span class="p">(</span><span class="n">conf</span><span class="p">,</span> <span class="n">what</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="k">def</span> <span class="nf">clean_unit_from</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">conf</span><span class="p">,</span> <span class="n">what</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">is_active_from</span><span class="p">(</span><span class="n">conf</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">            <span class="n">logg</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&#34;can not clean active unit: </span><span class="si">%s</span><span class="s2">&#34;</span><span class="p">,</span> <span class="n">conf</span><span class="o">.</span><span class="n">name</span><span class="p">())</span>
</span></span><span class="line"><span class="cl">            <span class="k">return</span> <span class="kc">False</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">clean_service_directories</span><span class="p">(</span><span class="n">conf</span><span class="p">,</span> <span class="n">what</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="k">def</span> <span class="nf">log_modules</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">modules</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">        <span class="s2">&#34;&#34;&#34; [UNIT]... -- start &#39;less&#39; on the log files for the services
</span></span></span><span class="line"><span class="cl"><span class="s2">        /// use &#39;-f&#39; to follow and &#39;-n lines&#39; to limit output using &#39;tail&#39;,
</span></span></span><span class="line"><span class="cl"><span class="s2">            using &#39;--no-pager&#39; just does a full &#39;cat&#39;&#34;&#34;&#34;</span>
</span></span><span class="line"><span class="cl">        <span class="n">found_all</span> <span class="o">=</span> <span class="kc">True</span>
</span></span><span class="line"><span class="cl">        <span class="n">units</span> <span class="o">=</span> <span class="p">[]</span>
</span></span><span class="line"><span class="cl">        <span class="k">for</span> <span class="n">module</span> <span class="ow">in</span> <span class="n">modules</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">            <span class="n">matched</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">match_units</span><span class="p">(</span><span class="n">to_list</span><span class="p">(</span><span class="n">module</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">            <span class="k">if</span> <span class="ow">not</span> <span class="n">matched</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">                <span class="n">logg</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&#34;Unit </span><span class="si">%s</span><span class="s2"> not found.&#34;</span><span class="p">,</span> <span class="n">unit_of</span><span class="p">(</span><span class="n">module</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">                <span class="bp">self</span><span class="o">.</span><span class="n">error</span> <span class="o">|=</span> <span class="n">NOT_FOUND</span>
</span></span><span class="line"><span class="cl">                <span class="n">found_all</span> <span class="o">=</span> <span class="kc">False</span>
</span></span><span class="line"><span class="cl">                <span class="k">continue</span>
</span></span><span class="line"><span class="cl">            <span class="k">for</span> <span class="n">unit</span> <span class="ow">in</span> <span class="n">matched</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">                <span class="k">if</span> <span class="n">unit</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">units</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">                    <span class="n">units</span> <span class="o">+=</span> <span class="p">[</span><span class="n">unit</span><span class="p">]</span>
</span></span><span class="line"><span class="cl">        <span class="n">lines</span> <span class="o">=</span> <span class="n">_log_lines</span>
</span></span><span class="line"><span class="cl">        <span class="n">follow</span> <span class="o">=</span> <span class="n">_force</span>
</span></span><span class="line"><span class="cl">        <span class="n">result</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">log_units</span><span class="p">(</span><span class="n">units</span><span class="p">,</span> <span class="n">lines</span><span class="p">,</span> <span class="n">follow</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="n">result</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">            <span class="bp">self</span><span class="o">.</span><span class="n">error</span> <span class="o">=</span> <span class="n">result</span>
</span></span><span class="line"><span class="cl">            <span class="k">return</span> <span class="kc">False</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="n">found_all</span>
</span></span><span class="line"><span class="cl">    <span class="k">def</span> <span class="nf">log_units</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">units</span><span class="p">,</span> <span class="n">lines</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">follow</span> <span class="o">=</span> <span class="kc">False</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">        <span class="n">result</span> <span class="o">=</span> <span class="mi">0</span>
</span></span><span class="line"><span class="cl">        <span class="k">for</span> <span class="n">unit</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">sortedAfter</span><span class="p">(</span><span class="n">units</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">            <span class="n">exitcode</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">log_unit</span><span class="p">(</span><span class="n">unit</span><span class="p">,</span> <span class="n">lines</span><span class="p">,</span> <span class="n">follow</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">            <span class="k">if</span> <span class="n">exitcode</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">                <span class="k">return</span> <span class="n">exitcode</span>
</span></span><span class="line"><span class="cl">            <span class="k">if</span> <span class="n">exitcode</span> <span class="o">&gt;</span> <span class="n">result</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">                <span class="n">result</span> <span class="o">=</span> <span class="n">exitcode</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="n">result</span>
</span></span><span class="line"><span class="cl">    <span class="k">def</span> <span class="nf">log_unit</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">unit</span><span class="p">,</span> <span class="n">lines</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">follow</span> <span class="o">=</span> <span class="kc">False</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">        <span class="n">conf</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">load_unit_conf</span><span class="p">(</span><span class="n">unit</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="ow">not</span> <span class="n">conf</span><span class="p">:</span> <span class="k">return</span> <span class="o">-</span><span class="mi">1</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">log_unit_from</span><span class="p">(</span><span class="n">conf</span><span class="p">,</span> <span class="n">lines</span><span class="p">,</span> <span class="n">follow</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="k">def</span> <span class="nf">log_unit_from</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">conf</span><span class="p">,</span> <span class="n">lines</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">follow</span> <span class="o">=</span> <span class="kc">False</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">        <span class="n">cmd_args</span> <span class="o">=</span> <span class="p">[]</span>
</span></span><span class="line"><span class="cl">        <span class="n">log_path</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_journal_log_from</span><span class="p">(</span><span class="n">conf</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="n">follow</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">            <span class="n">tail_cmd</span> <span class="o">=</span> <span class="n">get_exist_path</span><span class="p">(</span><span class="n">TAIL_CMDS</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">            <span class="k">if</span> <span class="n">tail_cmd</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">                <span class="nb">print</span><span class="p">(</span><span class="s2">&#34;tail command not found&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">                <span class="k">return</span> <span class="mi">1</span>
</span></span><span class="line"><span class="cl">            <span class="n">cmd</span> <span class="o">=</span> <span class="p">[</span><span class="n">tail_cmd</span><span class="p">,</span> <span class="s2">&#34;-n&#34;</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">lines</span> <span class="ow">or</span> <span class="mi">10</span><span class="p">),</span> <span class="s2">&#34;-F&#34;</span><span class="p">,</span> <span class="n">log_path</span><span class="p">]</span>
</span></span><span class="line"><span class="cl">            <span class="n">logg</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&#34;journalctl </span><span class="si">%s</span><span class="s2"> -&gt; </span><span class="si">%s</span><span class="s2">&#34;</span><span class="p">,</span> <span class="n">conf</span><span class="o">.</span><span class="n">name</span><span class="p">(),</span> <span class="n">cmd</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">            <span class="n">cmd_args</span> <span class="o">=</span> <span class="p">[</span><span class="n">arg</span> <span class="k">for</span> <span class="n">arg</span> <span class="ow">in</span> <span class="n">cmd</span><span class="p">]</span> <span class="c1"># satisfy mypy</span>
</span></span><span class="line"><span class="cl">            <span class="k">return</span> <span class="n">os</span><span class="o">.</span><span class="n">execvp</span><span class="p">(</span><span class="n">cmd_args</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">cmd_args</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="k">elif</span> <span class="n">lines</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">            <span class="n">tail_cmd</span> <span class="o">=</span> <span class="n">get_exist_path</span><span class="p">(</span><span class="n">TAIL_CMDS</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">            <span class="k">if</span> <span class="n">tail_cmd</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">                <span class="nb">print</span><span class="p">(</span><span class="s2">&#34;tail command not found&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">                <span class="k">return</span> <span class="mi">1</span>
</span></span><span class="line"><span class="cl">            <span class="n">cmd</span> <span class="o">=</span> <span class="p">[</span><span class="n">tail_cmd</span><span class="p">,</span> <span class="s2">&#34;-n&#34;</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">lines</span> <span class="ow">or</span> <span class="mi">10</span><span class="p">),</span> <span class="n">log_path</span><span class="p">]</span>
</span></span><span class="line"><span class="cl">            <span class="n">logg</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&#34;journalctl </span><span class="si">%s</span><span class="s2"> -&gt; </span><span class="si">%s</span><span class="s2">&#34;</span><span class="p">,</span> <span class="n">conf</span><span class="o">.</span><span class="n">name</span><span class="p">(),</span> <span class="n">cmd</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">            <span class="n">cmd_args</span> <span class="o">=</span> <span class="p">[</span><span class="n">arg</span> <span class="k">for</span> <span class="n">arg</span> <span class="ow">in</span> <span class="n">cmd</span><span class="p">]</span> <span class="c1"># satisfy mypy</span>
</span></span><span class="line"><span class="cl">            <span class="k">return</span> <span class="n">os</span><span class="o">.</span><span class="n">execvp</span><span class="p">(</span><span class="n">cmd_args</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">cmd_args</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="k">elif</span> <span class="n">_no_pager</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">            <span class="n">cat_cmd</span> <span class="o">=</span> <span class="n">get_exist_path</span><span class="p">(</span><span class="n">CAT_CMDS</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">            <span class="k">if</span> <span class="n">cat_cmd</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">                <span class="nb">print</span><span class="p">(</span><span class="s2">&#34;cat command not found&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">                <span class="k">return</span> <span class="mi">1</span>
</span></span><span class="line"><span class="cl">            <span class="n">cmd</span> <span class="o">=</span> <span class="p">[</span><span class="n">cat_cmd</span><span class="p">,</span> <span class="n">log_path</span><span class="p">]</span>
</span></span><span class="line"><span class="cl">            <span class="n">logg</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&#34;journalctl </span><span class="si">%s</span><span class="s2"> -&gt; </span><span class="si">%s</span><span class="s2">&#34;</span><span class="p">,</span> <span class="n">conf</span><span class="o">.</span><span class="n">name</span><span class="p">(),</span> <span class="n">cmd</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">            <span class="n">cmd_args</span> <span class="o">=</span> <span class="p">[</span><span class="n">arg</span> <span class="k">for</span> <span class="n">arg</span> <span class="ow">in</span> <span class="n">cmd</span><span class="p">]</span> <span class="c1"># satisfy mypy</span>
</span></span><span class="line"><span class="cl">            <span class="k">return</span> <span class="n">os</span><span class="o">.</span><span class="n">execvp</span><span class="p">(</span><span class="n">cmd_args</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">cmd_args</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="k">else</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">            <span class="n">less_cmd</span> <span class="o">=</span> <span class="n">get_exist_path</span><span class="p">(</span><span class="n">LESS_CMDS</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">            <span class="k">if</span> <span class="n">less_cmd</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">                <span class="nb">print</span><span class="p">(</span><span class="s2">&#34;less command not found&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">                <span class="k">return</span> <span class="mi">1</span>
</span></span><span class="line"><span class="cl">            <span class="n">cmd</span> <span class="o">=</span> <span class="p">[</span><span class="n">less_cmd</span><span class="p">,</span> <span class="n">log_path</span><span class="p">]</span>
</span></span><span class="line"><span class="cl">            <span class="n">logg</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&#34;journalctl </span><span class="si">%s</span><span class="s2"> -&gt; </span><span class="si">%s</span><span class="s2">&#34;</span><span class="p">,</span> <span class="n">conf</span><span class="o">.</span><span class="n">name</span><span class="p">(),</span> <span class="n">cmd</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">            <span class="n">cmd_args</span> <span class="o">=</span> <span class="p">[</span><span class="n">arg</span> <span class="k">for</span> <span class="n">arg</span> <span class="ow">in</span> <span class="n">cmd</span><span class="p">]</span> <span class="c1"># satisfy mypy</span>
</span></span><span class="line"><span class="cl">            <span class="k">return</span> <span class="n">os</span><span class="o">.</span><span class="n">execvp</span><span class="p">(</span><span class="n">cmd_args</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">cmd_args</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="k">def</span> <span class="nf">get_journal_log_from</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">conf</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="n">os_path</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_root</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_journal_log</span><span class="p">(</span><span class="n">conf</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">    <span class="k">def</span> <span class="nf">get_journal_log</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">conf</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">        <span class="s2">&#34;&#34;&#34; /var/log/zzz.service.log or /var/log/default.unit.log &#34;&#34;&#34;</span>
</span></span><span class="line"><span class="cl">        <span class="n">filename</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">basename</span><span class="p">(</span><span class="n">strE</span><span class="p">(</span><span class="n">conf</span><span class="o">.</span><span class="n">filename</span><span class="p">()))</span>
</span></span><span class="line"><span class="cl">        <span class="n">unitname</span> <span class="o">=</span> <span class="p">(</span><span class="n">conf</span><span class="o">.</span><span class="n">name</span><span class="p">()</span> <span class="ow">or</span> <span class="s2">&#34;default&#34;</span><span class="p">)</span><span class="o">+</span><span class="s2">&#34;.unit&#34;</span>
</span></span><span class="line"><span class="cl">        <span class="n">name</span> <span class="o">=</span> <span class="n">filename</span> <span class="ow">or</span> <span class="n">unitname</span>
</span></span><span class="line"><span class="cl">        <span class="n">log_folder</span> <span class="o">=</span> <span class="n">expand_path</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_journal_log_folder</span><span class="p">,</span> <span class="n">conf</span><span class="o">.</span><span class="n">root_mode</span><span class="p">())</span>
</span></span><span class="line"><span class="cl">        <span class="n">log_file</span> <span class="o">=</span> <span class="n">name</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">sep</span><span class="p">,</span> <span class="s2">&#34;.&#34;</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&#34;.log&#34;</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="n">log_file</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s2">&#34;.&#34;</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">            <span class="n">log_file</span> <span class="o">=</span> <span class="s2">&#34;dot.&#34;</span><span class="o">+</span><span class="n">log_file</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">log_folder</span><span class="p">,</span> <span class="n">log_file</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="k">def</span> <span class="nf">open_journal_log</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">conf</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">        <span class="n">log_file</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_journal_log_from</span><span class="p">(</span><span class="n">conf</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="n">log_folder</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="n">log_file</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isdir</span><span class="p">(</span><span class="n">log_folder</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">            <span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="n">log_folder</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="nb">open</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">log_file</span><span class="p">),</span> <span class="s2">&#34;a&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="k">def</span> <span class="nf">get_WorkingDirectory</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">conf</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="n">conf</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">Service</span><span class="p">,</span> <span class="s2">&#34;WorkingDirectory&#34;</span><span class="p">,</span> <span class="s2">&#34;&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="k">def</span> <span class="nf">chdir_workingdir</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">conf</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">        <span class="s2">&#34;&#34;&#34; if specified then change the working directory &#34;&#34;&#34;</span>
</span></span><span class="line"><span class="cl">        <span class="c1"># the original systemd will start in &#39;/&#39; even if User= is given</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_root</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">            <span class="n">os</span><span class="o">.</span><span class="n">chdir</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_root</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="n">workingdir</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_WorkingDirectory</span><span class="p">(</span><span class="n">conf</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="n">mode</span><span class="p">,</span> <span class="n">workingdir</span> <span class="o">=</span> <span class="n">load_path</span><span class="p">(</span><span class="n">workingdir</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="n">workingdir</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">            <span class="n">into</span> <span class="o">=</span> <span class="n">os_path</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_root</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">expand_special</span><span class="p">(</span><span class="n">workingdir</span><span class="p">,</span> <span class="n">conf</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">            <span class="k">try</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">                <span class="n">logg</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&#34;chdir workingdir &#39;</span><span class="si">%s</span><span class="s2">&#39;&#34;</span><span class="p">,</span> <span class="n">into</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">                <span class="n">os</span><span class="o">.</span><span class="n">chdir</span><span class="p">(</span><span class="n">into</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">                <span class="k">return</span> <span class="kc">False</span>
</span></span><span class="line"><span class="cl">            <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">                <span class="k">if</span> <span class="n">mode</span><span class="o">.</span><span class="n">check</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">                    <span class="n">logg</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&#34;chdir workingdir &#39;</span><span class="si">%s</span><span class="s2">&#39;: </span><span class="si">%s</span><span class="s2">&#34;</span><span class="p">,</span> <span class="n">into</span><span class="p">,</span> <span class="n">e</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">                    <span class="k">return</span> <span class="n">into</span>
</span></span><span class="line"><span class="cl">                <span class="k">else</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">                    <span class="n">logg</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&#34;chdir workingdir &#39;</span><span class="si">%s</span><span class="s2">&#39;: </span><span class="si">%s</span><span class="s2">&#34;</span><span class="p">,</span> <span class="n">into</span><span class="p">,</span> <span class="n">e</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">                    <span class="k">return</span> <span class="kc">None</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="kc">None</span>
</span></span><span class="line"><span class="cl">    <span class="n">NotifySocket</span> <span class="o">=</span> <span class="n">collections</span><span class="o">.</span><span class="n">namedtuple</span><span class="p">(</span><span class="s2">&#34;NotifySocket&#34;</span><span class="p">,</span> <span class="p">[</span><span class="s2">&#34;socket&#34;</span><span class="p">,</span> <span class="s2">&#34;socketfile&#34;</span><span class="p">])</span>
</span></span><span class="line"><span class="cl">    <span class="k">def</span> <span class="nf">get_notify_socket_from</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">conf</span><span class="p">,</span> <span class="n">socketfile</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">debug</span> <span class="o">=</span> <span class="kc">False</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">        <span class="s2">&#34;&#34;&#34; creates a notify-socket for the (non-privileged) user &#34;&#34;&#34;</span>
</span></span><span class="line"><span class="cl">        <span class="n">notify_socket_folder</span> <span class="o">=</span> <span class="n">expand_path</span><span class="p">(</span><span class="n">_notify_socket_folder</span><span class="p">,</span> <span class="n">conf</span><span class="o">.</span><span class="n">root_mode</span><span class="p">())</span>
</span></span><span class="line"><span class="cl">        <span class="n">notify_folder</span> <span class="o">=</span> <span class="n">os_path</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_root</span><span class="p">,</span> <span class="n">notify_socket_folder</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="n">notify_name</span> <span class="o">=</span> <span class="s2">&#34;notify.&#34;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">conf</span><span class="o">.</span><span class="n">name</span><span class="p">()</span> <span class="ow">or</span> <span class="s2">&#34;systemctl&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="n">notify_socket</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">notify_folder</span><span class="p">,</span> <span class="n">notify_name</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="n">socketfile</span> <span class="o">=</span> <span class="n">socketfile</span> <span class="ow">or</span> <span class="n">notify_socket</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">socketfile</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">100</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">            <span class="c1"># occurs during testsuite.py for ~user/test.tmp/root path</span>
</span></span><span class="line"><span class="cl">            <span class="k">if</span> <span class="n">debug</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">                <span class="n">logg</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&#34;https://unix.stackexchange.com/questions/367008/</span><span class="si">%s</span><span class="s2">&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                           <span class="s2">&#34;why-is-socket-path-length-limited-to-a-hundred-chars&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">                <span class="n">logg</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&#34;old notify socketfile (</span><span class="si">%s</span><span class="s2">) = </span><span class="si">%s</span><span class="s2">&#34;</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">socketfile</span><span class="p">),</span> <span class="n">socketfile</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">            <span class="n">notify_name44</span> <span class="o">=</span> <span class="n">o44</span><span class="p">(</span><span class="n">notify_name</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">            <span class="n">notify_name77</span> <span class="o">=</span> <span class="n">o77</span><span class="p">(</span><span class="n">notify_name</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">            <span class="n">socketfile</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">notify_folder</span><span class="p">,</span> <span class="n">notify_name77</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">socketfile</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">100</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">                <span class="n">socketfile</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">notify_folder</span><span class="p">,</span> <span class="n">notify_name44</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">            <span class="n">pref</span> <span class="o">=</span> <span class="s2">&#34;zz.</span><span class="si">%i</span><span class="s2">.</span><span class="si">%s</span><span class="s2">&#34;</span> <span class="o">%</span> <span class="p">(</span><span class="n">get_USER_ID</span><span class="p">(),</span> <span class="n">o22</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">basename</span><span class="p">(</span><span class="n">notify_socket_folder</span><span class="p">)))</span>
</span></span><span class="line"><span class="cl">            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">socketfile</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">100</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">                <span class="n">socketfile</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">get_TMP</span><span class="p">(),</span> <span class="n">pref</span><span class="p">,</span> <span class="n">notify_name</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">socketfile</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">100</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">                <span class="n">socketfile</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">get_TMP</span><span class="p">(),</span> <span class="n">pref</span><span class="p">,</span> <span class="n">notify_name77</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">socketfile</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">100</span><span class="p">:</span> <span class="c1"># pragma: no cover</span>
</span></span><span class="line"><span class="cl">                <span class="n">socketfile</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">get_TMP</span><span class="p">(),</span> <span class="n">pref</span><span class="p">,</span> <span class="n">notify_name44</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">socketfile</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">100</span><span class="p">:</span> <span class="c1"># pragma: no cover</span>
</span></span><span class="line"><span class="cl">                <span class="n">socketfile</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">get_TMP</span><span class="p">(),</span> <span class="n">notify_name44</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">            <span class="k">if</span> <span class="n">debug</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">                <span class="n">logg</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&#34;new notify socketfile (</span><span class="si">%s</span><span class="s2">) = </span><span class="si">%s</span><span class="s2">&#34;</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">socketfile</span><span class="p">),</span> <span class="n">socketfile</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="n">socketfile</span>
</span></span><span class="line"><span class="cl">    <span class="k">def</span> <span class="nf">notify_socket_from</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">conf</span><span class="p">,</span> <span class="n">socketfile</span> <span class="o">=</span> <span class="kc">None</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">        <span class="n">socketfile</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_notify_socket_from</span><span class="p">(</span><span class="n">conf</span><span class="p">,</span> <span class="n">socketfile</span><span class="p">,</span> <span class="n">debug</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="k">try</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">            <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isdir</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="n">socketfile</span><span class="p">)):</span>
</span></span><span class="line"><span class="cl">                <span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="n">socketfile</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">            <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">socketfile</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">                <span class="n">os</span><span class="o">.</span><span class="n">unlink</span><span class="p">(</span><span class="n">socketfile</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">            <span class="n">logg</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&#34;error </span><span class="si">%s</span><span class="s2">: </span><span class="si">%s</span><span class="s2">&#34;</span><span class="p">,</span> <span class="n">socketfile</span><span class="p">,</span> <span class="n">e</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="n">sock</span> <span class="o">=</span> <span class="n">socket</span><span class="o">.</span><span class="n">socket</span><span class="p">(</span><span class="n">socket</span><span class="o">.</span><span class="n">AF_UNIX</span><span class="p">,</span> <span class="n">socket</span><span class="o">.</span><span class="n">SOCK_DGRAM</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="n">sock</span><span class="o">.</span><span class="n">bind</span><span class="p">(</span><span class="n">socketfile</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="n">os</span><span class="o">.</span><span class="n">chmod</span><span class="p">(</span><span class="n">socketfile</span><span class="p">,</span> <span class="mo">0o777</span><span class="p">)</span> <span class="c1"># the service my run under some User=setting</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="n">Systemctl</span><span class="o">.</span><span class="n">NotifySocket</span><span class="p">(</span><span class="n">sock</span><span class="p">,</span> <span class="n">socketfile</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="k">def</span> <span class="nf">read_notify_socket</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">notify</span><span class="p">,</span> <span class="n">timeout</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">        <span class="n">notify</span><span class="o">.</span><span class="n">socket</span><span class="o">.</span><span class="n">settimeout</span><span class="p">(</span><span class="n">timeout</span> <span class="ow">or</span> <span class="n">DefaultMaximumTimeout</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="n">result</span> <span class="o">=</span> <span class="s2">&#34;&#34;</span>
</span></span><span class="line"><span class="cl">        <span class="k">try</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">            <span class="n">result</span><span class="p">,</span> <span class="n">client_address</span> <span class="o">=</span> <span class="n">notify</span><span class="o">.</span><span class="n">socket</span><span class="o">.</span><span class="n">recvfrom</span><span class="p">(</span><span class="mi">4096</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">            <span class="k">assert</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">result</span><span class="p">,</span> <span class="nb">bytes</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">            <span class="k">if</span> <span class="n">result</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">                <span class="n">result</span> <span class="o">=</span> <span class="n">result</span><span class="o">.</span><span class="n">decode</span><span class="p">(</span><span class="s2">&#34;utf-8&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">                <span class="n">result_txt</span> <span class="o">=</span> <span class="n">result</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&#34;</span><span class="se">\n</span><span class="s2">&#34;</span><span class="p">,</span> <span class="s2">&#34;|&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">                <span class="n">result_len</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">result</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">                <span class="n">logg</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&#34;read_notify_socket(</span><span class="si">%s</span><span class="s2">):</span><span class="si">%s</span><span class="s2">&#34;</span><span class="p">,</span> <span class="n">result_len</span><span class="p">,</span> <span class="n">result_txt</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="k">except</span> <span class="n">socket</span><span class="o">.</span><span class="n">timeout</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">            <span class="k">if</span> <span class="n">timeout</span> <span class="o">&gt;</span> <span class="mi">2</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">                <span class="n">logg</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&#34;socket.timeout </span><span class="si">%s</span><span class="s2">&#34;</span><span class="p">,</span> <span class="n">e</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="n">result</span>
</span></span><span class="line"><span class="cl">    <span class="k">def</span> <span class="nf">wait_notify_socket</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">notify</span><span class="p">,</span> <span class="n">timeout</span><span class="p">,</span> <span class="n">pid</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">pid_file</span> <span class="o">=</span> <span class="kc">None</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">notify</span><span class="o">.</span><span class="n">socketfile</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">            <span class="n">logg</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&#34;no $NOTIFY_SOCKET exists&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">            <span class="k">return</span> <span class="p">{}</span>
</span></span><span class="line"><span class="cl">        <span class="c1">#</span>
</span></span><span class="line"><span class="cl">        <span class="n">lapseTimeout</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="nb">int</span><span class="p">(</span><span class="n">timeout</span> <span class="o">/</span> <span class="mi">100</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">        <span class="n">mainpidTimeout</span> <span class="o">=</span> <span class="n">lapseTimeout</span> <span class="c1"># Apache sends READY before MAINPID</span>
</span></span><span class="line"><span class="cl">        <span class="n">status</span> <span class="o">=</span> <span class="s2">&#34;&#34;</span>
</span></span><span class="line"><span class="cl">        <span class="n">logg</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&#34;wait $NOTIFY_SOCKET, timeout </span><span class="si">%s</span><span class="s2"> (lapse </span><span class="si">%s</span><span class="s2">)&#34;</span><span class="p">,</span> <span class="n">timeout</span><span class="p">,</span> <span class="n">lapseTimeout</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="n">waiting</span> <span class="o">=</span> <span class="s2">&#34; ---&#34;</span>
</span></span><span class="line"><span class="cl">        <span class="n">results</span> <span class="o">=</span> <span class="p">{}</span>
</span></span><span class="line"><span class="cl">        <span class="k">for</span> <span class="n">attempt</span> <span class="ow">in</span> <span class="n">xrange</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">timeout</span><span class="p">)</span><span class="o">+</span><span class="mi">1</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">            <span class="k">if</span> <span class="n">pid</span> <span class="ow">and</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">is_active_pid</span><span class="p">(</span><span class="n">pid</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">                <span class="n">logg</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&#34;seen dead PID </span><span class="si">%s</span><span class="s2">&#34;</span><span class="p">,</span> <span class="n">pid</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">                <span class="k">return</span> <span class="n">results</span>
</span></span><span class="line"><span class="cl">            <span class="k">if</span> <span class="ow">not</span> <span class="n">attempt</span><span class="p">:</span> <span class="c1"># first one</span>
</span></span><span class="line"><span class="cl">                <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="c1"># until TimeoutStartSec</span>
</span></span><span class="line"><span class="cl">                <span class="k">continue</span>
</span></span><span class="line"><span class="cl">            <span class="n">result</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">read_notify_socket</span><span class="p">(</span><span class="n">notify</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span> <span class="c1"># sleep max 1 second</span>
</span></span><span class="line"><span class="cl">            <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">result</span><span class="o">.</span><span class="n">splitlines</span><span class="p">():</span>
</span></span><span class="line"><span class="cl">                <span class="c1"># for name, value in self.read_env_part(line)</span>
</span></span><span class="line"><span class="cl">                <span class="k">if</span> <span class="s2">&#34;=&#34;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">line</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">                    <span class="k">continue</span>
</span></span><span class="line"><span class="cl">                <span class="n">name</span><span class="p">,</span> <span class="n">value</span> <span class="o">=</span> <span class="n">line</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&#34;=&#34;</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">                <span class="n">results</span><span class="p">[</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="n">value</span>
</span></span><span class="line"><span class="cl">                <span class="k">if</span> <span class="n">name</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&#34;STATUS&#34;</span><span class="p">,</span> <span class="s2">&#34;ACTIVESTATE&#34;</span><span class="p">,</span> <span class="s2">&#34;MAINPID&#34;</span><span class="p">,</span> <span class="s2">&#34;READY&#34;</span><span class="p">]:</span>
</span></span><span class="line"><span class="cl">                    <span class="n">hint</span><span class="o">=</span><span class="s2">&#34;seen notify </span><span class="si">%s</span><span class="s2">     &#34;</span> <span class="o">%</span> <span class="p">(</span><span class="n">waiting</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">                    <span class="n">logg</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&#34;</span><span class="si">%s</span><span class="s2"> :</span><span class="si">%s</span><span class="s2">=</span><span class="si">%s</span><span class="s2">&#34;</span><span class="p">,</span> <span class="n">hint</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">value</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">            <span class="k">if</span> <span class="n">status</span> <span class="o">!=</span> <span class="n">results</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&#34;STATUS&#34;</span><span class="p">,</span> <span class="s2">&#34;&#34;</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">                <span class="n">mainpidTimeout</span> <span class="o">=</span> <span class="n">lapseTimeout</span>
</span></span><span class="line"><span class="cl">                <span class="n">status</span> <span class="o">=</span> <span class="n">results</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&#34;STATUS&#34;</span><span class="p">,</span> <span class="s2">&#34;&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">            <span class="k">if</span> <span class="s2">&#34;READY&#34;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">results</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">                <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="c1"># until TimeoutStart</span>
</span></span><span class="line"><span class="cl">                <span class="k">continue</span>
</span></span><span class="line"><span class="cl">            <span class="k">if</span> <span class="s2">&#34;MAINPID&#34;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">results</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">pid_file</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">                <span class="n">mainpidTimeout</span> <span class="o">-=</span> <span class="mi">1</span>
</span></span><span class="line"><span class="cl">                <span class="k">if</span> <span class="n">mainpidTimeout</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">                    <span class="n">waiting</span> <span class="o">=</span> <span class="s2">&#34;</span><span class="si">%4i</span><span class="s2">&#34;</span> <span class="o">%</span> <span class="p">(</span><span class="o">-</span><span class="n">mainpidTimeout</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">                    <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="c1"># until TimeoutStart</span>
</span></span><span class="line"><span class="cl">                    <span class="k">continue</span>
</span></span><span class="line"><span class="cl">            <span class="k">break</span> <span class="c1"># READY and MAINPID</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="s2">&#34;READY&#34;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">results</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">            <span class="n">logg</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&#34;.... timeout while waiting for &#39;READY=1&#39; status on $NOTIFY_SOCKET&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="k">elif</span> <span class="s2">&#34;MAINPID&#34;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">results</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">            <span class="n">logg</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&#34;.... seen &#39;READY=1&#39; but no MAINPID update status on $NOTIFY_SOCKET&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="n">logg</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&#34;notify = </span><span class="si">%s</span><span class="s2">&#34;</span><span class="p">,</span> <span class="n">results</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="k">try</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">            <span class="n">notify</span><span class="o">.</span><span class="n">socket</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">            <span class="n">logg</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&#34;socket.close </span><span class="si">%s</span><span class="s2">&#34;</span><span class="p">,</span> <span class="n">e</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="n">results</span>
</span></span><span class="line"><span class="cl">    <span class="k">def</span> <span class="nf">start_modules</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">modules</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">        <span class="s2">&#34;&#34;&#34; [UNIT]... -- start these units
</span></span></span><span class="line"><span class="cl"><span class="s2">        /// SPECIAL: with --now or --init it will
</span></span></span><span class="line"><span class="cl"><span class="s2">            run the init-loop and stop the units afterwards &#34;&#34;&#34;</span>
</span></span><span class="line"><span class="cl">        <span class="n">found_all</span> <span class="o">=</span> <span class="kc">True</span>
</span></span><span class="line"><span class="cl">        <span class="n">units</span> <span class="o">=</span> <span class="p">[]</span>
</span></span><span class="line"><span class="cl">        <span class="k">for</span> <span class="n">module</span> <span class="ow">in</span> <span class="n">modules</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">            <span class="n">matched</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">match_units</span><span class="p">(</span><span class="n">to_list</span><span class="p">(</span><span class="n">module</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">            <span class="k">if</span> <span class="ow">not</span> <span class="n">matched</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">                <span class="n">logg</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&#34;Unit </span><span class="si">%s</span><span class="s2"> not found.&#34;</span><span class="p">,</span> <span class="n">unit_of</span><span class="p">(</span><span class="n">module</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">                <span class="bp">self</span><span class="o">.</span><span class="n">error</span> <span class="o">|=</span> <span class="n">NOT_FOUND</span>
</span></span><span class="line"><span class="cl">                <span class="n">found_all</span> <span class="o">=</span> <span class="kc">False</span>
</span></span><span class="line"><span class="cl">                <span class="k">continue</span>
</span></span><span class="line"><span class="cl">            <span class="k">for</span> <span class="n">unit</span> <span class="ow">in</span> <span class="n">matched</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">                <span class="k">if</span> <span class="n">unit</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">units</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">                    <span class="n">units</span> <span class="o">+=</span> <span class="p">[</span><span class="n">unit</span><span class="p">]</span>
</span></span><span class="line"><span class="cl">        <span class="n">init</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_now</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">_init</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">start_units</span><span class="p">(</span><span class="n">units</span><span class="p">,</span> <span class="n">init</span><span class="p">)</span> <span class="ow">and</span> <span class="n">found_all</span>
</span></span><span class="line"><span class="cl">    <span class="k">def</span> <span class="nf">start_units</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">units</span><span class="p">,</span> <span class="n">init</span> <span class="o">=</span> <span class="kc">None</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">        <span class="s2">&#34;&#34;&#34; fails if any unit does not start
</span></span></span><span class="line"><span class="cl"><span class="s2">        /// SPECIAL: may run the init-loop and
</span></span></span><span class="line"><span class="cl"><span class="s2">            stop the named units afterwards &#34;&#34;&#34;</span>
</span></span><span class="line"><span class="cl">        <span class="bp">self</span><span class="o">.</span><span class="n">wait_system</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">        <span class="n">done</span> <span class="o">=</span> <span class="kc">True</span>
</span></span><span class="line"><span class="cl">        <span class="n">started_units</span> <span class="o">=</span> <span class="p">[]</span>
</span></span><span class="line"><span class="cl">        <span class="k">for</span> <span class="n">unit</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">sortedAfter</span><span class="p">(</span><span class="n">units</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">            <span class="n">started_units</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">unit</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">            <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">start_unit</span><span class="p">(</span><span class="n">unit</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">                <span class="n">done</span> <span class="o">=</span> <span class="kc">False</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="n">init</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">            <span class="n">logg</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&#34;init-loop start&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">            <span class="n">sig</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">init_loop_until_stop</span><span class="p">(</span><span class="n">started_units</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">            <span class="n">logg</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&#34;init-loop </span><span class="si">%s</span><span class="s2">&#34;</span><span class="p">,</span> <span class="n">sig</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">            <span class="k">for</span> <span class="n">unit</span> <span class="ow">in</span> <span class="nb">reversed</span><span class="p">(</span><span class="n">started_units</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">                <span class="bp">self</span><span class="o">.</span><span class="n">stop_unit</span><span class="p">(</span><span class="n">unit</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="n">done</span>
</span></span><span class="line"><span class="cl">    <span class="k">def</span> <span class="nf">start_unit</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">unit</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">        <span class="n">conf</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">load_unit_conf</span><span class="p">(</span><span class="n">unit</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="n">conf</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">            <span class="n">logg</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&#34;unit could not be loaded (</span><span class="si">%s</span><span class="s2">)&#34;</span><span class="p">,</span> <span class="n">unit</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">            <span class="n">logg</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&#34;Unit </span><span class="si">%s</span><span class="s2"> not found.&#34;</span><span class="p">,</span> <span class="n">unit</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">            <span class="k">return</span> <span class="kc">False</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">not_user_conf</span><span class="p">(</span><span class="n">conf</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">            <span class="n">logg</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&#34;Unit </span><span class="si">%s</span><span class="s2"> not for --user mode&#34;</span><span class="p">,</span> <span class="n">unit</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">            <span class="k">return</span> <span class="kc">False</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">start_unit_from</span><span class="p">(</span><span class="n">conf</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="k">def</span> <span class="nf">get_TimeoutStartSec</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">conf</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">        <span class="n">timeout</span> <span class="o">=</span> <span class="n">conf</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">Service</span><span class="p">,</span> <span class="s2">&#34;TimeoutSec&#34;</span><span class="p">,</span> <span class="n">strE</span><span class="p">(</span><span class="n">DefaultTimeoutStartSec</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">        <span class="n">timeout</span> <span class="o">=</span> <span class="n">conf</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">Service</span><span class="p">,</span> <span class="s2">&#34;TimeoutStartSec&#34;</span><span class="p">,</span> <span class="n">timeout</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="n">time_to_seconds</span><span class="p">(</span><span class="n">timeout</span><span class="p">,</span> <span class="n">DefaultMaximumTimeout</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="k">def</span> <span class="nf">get_SocketTimeoutSec</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">conf</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">        <span class="n">timeout</span> <span class="o">=</span> <span class="n">conf</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">Socket</span><span class="p">,</span> <span class="s2">&#34;TimeoutSec&#34;</span><span class="p">,</span> <span class="n">strE</span><span class="p">(</span><span class="n">DefaultTimeoutStartSec</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="n">time_to_seconds</span><span class="p">(</span><span class="n">timeout</span><span class="p">,</span> <span class="n">DefaultMaximumTimeout</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="k">def</span> <span class="nf">get_RemainAfterExit</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">conf</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="n">conf</span><span class="o">.</span><span class="n">getbool</span><span class="p">(</span><span class="n">Service</span><span class="p">,</span> <span class="s2">&#34;RemainAfterExit&#34;</span><span class="p">,</span> <span class="s2">&#34;no&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="k">def</span> <span class="nf">start_unit_from</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">conf</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="ow">not</span> <span class="n">conf</span><span class="p">:</span> <span class="k">return</span> <span class="kc">False</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">syntax_check</span><span class="p">(</span><span class="n">conf</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">100</span><span class="p">:</span> <span class="k">return</span> <span class="kc">False</span>
</span></span><span class="line"><span class="cl">        <span class="k">with</span> <span class="n">waitlock</span><span class="p">(</span><span class="n">conf</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">            <span class="n">logg</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&#34; start unit </span><span class="si">%s</span><span class="s2"> =&gt; </span><span class="si">%s</span><span class="s2">&#34;</span><span class="p">,</span> <span class="n">conf</span><span class="o">.</span><span class="n">name</span><span class="p">(),</span> <span class="n">strQ</span><span class="p">(</span><span class="n">conf</span><span class="o">.</span><span class="n">filename</span><span class="p">()))</span>
</span></span><span class="line"><span class="cl">            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">do_start_unit_from</span><span class="p">(</span><span class="n">conf</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="k">def</span> <span class="nf">do_start_unit_from</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">conf</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="n">conf</span><span class="o">.</span><span class="n">name</span><span class="p">()</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s2">&#34;.service&#34;</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">do_start_service_from</span><span class="p">(</span><span class="n">conf</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="k">elif</span> <span class="n">conf</span><span class="o">.</span><span class="n">name</span><span class="p">()</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s2">&#34;.socket&#34;</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">do_start_socket_from</span><span class="p">(</span><span class="n">conf</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="k">elif</span> <span class="n">conf</span><span class="o">.</span><span class="n">name</span><span class="p">()</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s2">&#34;.target&#34;</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">do_start_target_from</span><span class="p">(</span><span class="n">conf</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="k">else</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">            <span class="n">logg</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&#34;start not implemented for unit type: </span><span class="si">%s</span><span class="s2">&#34;</span><span class="p">,</span> <span class="n">conf</span><span class="o">.</span><span class="n">name</span><span class="p">())</span>
</span></span><span class="line"><span class="cl">            <span class="k">return</span> <span class="kc">False</span>
</span></span><span class="line"><span class="cl">    <span class="k">def</span> <span class="nf">do_start_service_from</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">conf</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">        <span class="n">timeout</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_TimeoutStartSec</span><span class="p">(</span><span class="n">conf</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="n">doRemainAfterExit</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_RemainAfterExit</span><span class="p">(</span><span class="n">conf</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="n">runs</span> <span class="o">=</span> <span class="n">conf</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">Service</span><span class="p">,</span> <span class="s2">&#34;Type&#34;</span><span class="p">,</span> <span class="s2">&#34;simple&#34;</span><span class="p">)</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">        <span class="n">env</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_env</span><span class="p">(</span><span class="n">conf</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_quiet</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">            <span class="n">okee</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">exec_check_unit</span><span class="p">(</span><span class="n">conf</span><span class="p">,</span> <span class="n">env</span><span class="p">,</span> <span class="n">Service</span><span class="p">,</span> <span class="s2">&#34;Exec&#34;</span><span class="p">)</span> <span class="c1"># all...</span>
</span></span><span class="line"><span class="cl">            <span class="k">if</span> <span class="ow">not</span> <span class="n">okee</span> <span class="ow">and</span> <span class="n">_no_reload</span><span class="p">:</span> <span class="k">return</span> <span class="kc">False</span>
</span></span><span class="line"><span class="cl">        <span class="n">service_directories</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">create_service_directories</span><span class="p">(</span><span class="n">conf</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="n">env</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">service_directories</span><span class="p">)</span> <span class="c1"># atleast sshd did check for /run/sshd</span>
</span></span><span class="line"><span class="cl">        <span class="c1"># for StopPost on failure:</span>
</span></span><span class="line"><span class="cl">        <span class="n">returncode</span> <span class="o">=</span> <span class="mi">0</span>
</span></span><span class="line"><span class="cl">        <span class="n">service_result</span> <span class="o">=</span> <span class="s2">&#34;success&#34;</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="kc">True</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">            <span class="k">if</span> <span class="n">runs</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&#34;simple&#34;</span><span class="p">,</span> <span class="s2">&#34;exec&#34;</span><span class="p">,</span> <span class="s2">&#34;forking&#34;</span><span class="p">,</span> <span class="s2">&#34;notify&#34;</span><span class="p">,</span> <span class="s2">&#34;idle&#34;</span><span class="p">]:</span>
</span></span><span class="line"><span class="cl">                <span class="n">env</span><span class="p">[</span><span class="s2">&#34;MAINPID&#34;</span><span class="p">]</span> <span class="o">=</span> <span class="n">strE</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">read_mainpid_from</span><span class="p">(</span><span class="n">conf</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">            <span class="k">for</span> <span class="n">cmd</span> <span class="ow">in</span> <span class="n">conf</span><span class="o">.</span><span class="n">getlist</span><span class="p">(</span><span class="n">Service</span><span class="p">,</span> <span class="s2">&#34;ExecStartPre&#34;</span><span class="p">,</span> <span class="p">[]):</span>
</span></span><span class="line"><span class="cl">                <span class="n">exe</span><span class="p">,</span> <span class="n">newcmd</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">exec_newcmd</span><span class="p">(</span><span class="n">cmd</span><span class="p">,</span> <span class="n">env</span><span class="p">,</span> <span class="n">conf</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">                <span class="n">logg</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&#34; pre-start </span><span class="si">%s</span><span class="s2">&#34;</span><span class="p">,</span> <span class="n">shell_cmd</span><span class="p">(</span><span class="n">newcmd</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">                <span class="n">forkpid</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">fork</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">                <span class="k">if</span> <span class="ow">not</span> <span class="n">forkpid</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">                    <span class="bp">self</span><span class="o">.</span><span class="n">execve_from</span><span class="p">(</span><span class="n">conf</span><span class="p">,</span> <span class="n">newcmd</span><span class="p">,</span> <span class="n">env</span><span class="p">)</span> <span class="c1"># pragma: no cover</span>
</span></span><span class="line"><span class="cl">                <span class="n">run</span> <span class="o">=</span> <span class="n">subprocess_waitpid</span><span class="p">(</span><span class="n">forkpid</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">                <span class="n">logg</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&#34; pre-start done (</span><span class="si">%s</span><span class="s2">) &lt;-</span><span class="si">%s</span><span class="s2">&gt;&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                           <span class="n">run</span><span class="o">.</span><span class="n">returncode</span> <span class="ow">or</span> <span class="s2">&#34;OK&#34;</span><span class="p">,</span> <span class="n">run</span><span class="o">.</span><span class="n">signal</span> <span class="ow">or</span> <span class="s2">&#34;&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">                <span class="k">if</span> <span class="n">run</span><span class="o">.</span><span class="n">returncode</span> <span class="ow">and</span> <span class="n">exe</span><span class="o">.</span><span class="n">check</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">                    <span class="n">logg</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&#34;the ExecStartPre control process exited with error code&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">                    <span class="n">active</span> <span class="o">=</span> <span class="s2">&#34;failed&#34;</span>
</span></span><span class="line"><span class="cl">                    <span class="bp">self</span><span class="o">.</span><span class="n">write_status_from</span><span class="p">(</span><span class="n">conf</span><span class="p">,</span> <span class="n">AS</span><span class="o">=</span><span class="n">active</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">                    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_only_what</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&#34;none&#34;</span><span class="p">,</span> <span class="s2">&#34;keep&#34;</span><span class="p">]:</span>
</span></span><span class="line"><span class="cl">                        <span class="bp">self</span><span class="o">.</span><span class="n">remove_service_directories</span><span class="p">(</span><span class="n">conf</span><span class="p">)</span> <span class="c1"># cleanup that /run/sshd</span>
</span></span><span class="line"><span class="cl">                    <span class="k">return</span> <span class="kc">False</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="n">runs</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&#34;oneshot&#34;</span><span class="p">]:</span>
</span></span><span class="line"><span class="cl">            <span class="n">status_file</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_status_file_from</span><span class="p">(</span><span class="n">conf</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_status_from</span><span class="p">(</span><span class="n">conf</span><span class="p">,</span> <span class="s2">&#34;ActiveState&#34;</span><span class="p">,</span> <span class="s2">&#34;unknown&#34;</span><span class="p">)</span> <span class="o">==</span> <span class="s2">&#34;active&#34;</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">                <span class="n">logg</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&#34;the service was already up once&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">                <span class="k">return</span> <span class="kc">True</span>
</span></span><span class="line"><span class="cl">            <span class="k">for</span> <span class="n">cmd</span> <span class="ow">in</span> <span class="n">conf</span><span class="o">.</span><span class="n">getlist</span><span class="p">(</span><span class="n">Service</span><span class="p">,</span> <span class="s2">&#34;ExecStart&#34;</span><span class="p">,</span> <span class="p">[]):</span>
</span></span><span class="line"><span class="cl">                <span class="n">exe</span><span class="p">,</span> <span class="n">newcmd</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">exec_newcmd</span><span class="p">(</span><span class="n">cmd</span><span class="p">,</span> <span class="n">env</span><span class="p">,</span> <span class="n">conf</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">                <span class="n">logg</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&#34;</span><span class="si">%s</span><span class="s2"> start </span><span class="si">%s</span><span class="s2">&#34;</span><span class="p">,</span> <span class="n">runs</span><span class="p">,</span> <span class="n">shell_cmd</span><span class="p">(</span><span class="n">newcmd</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">                <span class="n">forkpid</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">fork</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">                <span class="k">if</span> <span class="ow">not</span> <span class="n">forkpid</span><span class="p">:</span> <span class="c1"># pragma: no cover</span>
</span></span><span class="line"><span class="cl">                    <span class="n">os</span><span class="o">.</span><span class="n">setsid</span><span class="p">()</span> <span class="c1"># detach child process from parent</span>
</span></span><span class="line"><span class="cl">                    <span class="bp">self</span><span class="o">.</span><span class="n">execve_from</span><span class="p">(</span><span class="n">conf</span><span class="p">,</span> <span class="n">newcmd</span><span class="p">,</span> <span class="n">env</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">                <span class="n">run</span> <span class="o">=</span> <span class="n">subprocess_waitpid</span><span class="p">(</span><span class="n">forkpid</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">                <span class="k">if</span> <span class="n">run</span><span class="o">.</span><span class="n">returncode</span> <span class="ow">and</span> <span class="n">exe</span><span class="o">.</span><span class="n">check</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">                    <span class="n">returncode</span> <span class="o">=</span> <span class="n">run</span><span class="o">.</span><span class="n">returncode</span>
</span></span><span class="line"><span class="cl">                    <span class="n">service_result</span> <span class="o">=</span> <span class="s2">&#34;failed&#34;</span>
</span></span><span class="line"><span class="cl">                    <span class="n">logg</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&#34;</span><span class="si">%s</span><span class="s2"> start </span><span class="si">%s</span><span class="s2"> (</span><span class="si">%s</span><span class="s2">) &lt;-</span><span class="si">%s</span><span class="s2">&gt;&#34;</span><span class="p">,</span> <span class="n">runs</span><span class="p">,</span> <span class="n">service_result</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                               <span class="n">run</span><span class="o">.</span><span class="n">returncode</span> <span class="ow">or</span> <span class="s2">&#34;OK&#34;</span><span class="p">,</span> <span class="n">run</span><span class="o">.</span><span class="n">signal</span> <span class="ow">or</span> <span class="s2">&#34;&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">                    <span class="k">break</span>
</span></span><span class="line"><span class="cl">                <span class="n">logg</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&#34;</span><span class="si">%s</span><span class="s2"> start done (</span><span class="si">%s</span><span class="s2">) &lt;-</span><span class="si">%s</span><span class="s2">&gt;&#34;</span><span class="p">,</span> <span class="n">runs</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                          <span class="n">run</span><span class="o">.</span><span class="n">returncode</span> <span class="ow">or</span> <span class="s2">&#34;OK&#34;</span><span class="p">,</span> <span class="n">run</span><span class="o">.</span><span class="n">signal</span> <span class="ow">or</span> <span class="s2">&#34;&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">            <span class="k">if</span> <span class="kc">True</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">                <span class="bp">self</span><span class="o">.</span><span class="n">set_status_from</span><span class="p">(</span><span class="n">conf</span><span class="p">,</span> <span class="s2">&#34;ExecMainCode&#34;</span><span class="p">,</span> <span class="n">strE</span><span class="p">(</span><span class="n">returncode</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">                <span class="n">active</span> <span class="o">=</span> <span class="n">returncode</span> <span class="ow">and</span> <span class="s2">&#34;failed&#34;</span> <span class="ow">or</span> <span class="s2">&#34;active&#34;</span>
</span></span><span class="line"><span class="cl">                <span class="bp">self</span><span class="o">.</span><span class="n">write_status_from</span><span class="p">(</span><span class="n">conf</span><span class="p">,</span> <span class="n">AS</span><span class="o">=</span><span class="n">active</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="k">elif</span> <span class="n">runs</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&#34;simple&#34;</span><span class="p">,</span> <span class="s2">&#34;exec&#34;</span><span class="p">,</span> <span class="s2">&#34;idle&#34;</span><span class="p">]:</span>
</span></span><span class="line"><span class="cl">            <span class="n">status_file</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_status_file_from</span><span class="p">(</span><span class="n">conf</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">            <span class="n">pid</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">read_mainpid_from</span><span class="p">(</span><span class="n">conf</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">is_active_pid</span><span class="p">(</span><span class="n">pid</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">                <span class="n">logg</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&#34;the service is already running on PID </span><span class="si">%s</span><span class="s2">&#34;</span><span class="p">,</span> <span class="n">pid</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">                <span class="k">return</span> <span class="kc">True</span>
</span></span><span class="line"><span class="cl">            <span class="k">if</span> <span class="n">doRemainAfterExit</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">                <span class="n">logg</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&#34;</span><span class="si">%s</span><span class="s2"> RemainAfterExit -&gt; AS=active&#34;</span><span class="p">,</span> <span class="n">runs</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">                <span class="bp">self</span><span class="o">.</span><span class="n">write_status_from</span><span class="p">(</span><span class="n">conf</span><span class="p">,</span> <span class="n">AS</span><span class="o">=</span><span class="s2">&#34;active&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">            <span class="n">cmdlist</span> <span class="o">=</span> <span class="n">conf</span><span class="o">.</span><span class="n">getlist</span><span class="p">(</span><span class="n">Service</span><span class="p">,</span> <span class="s2">&#34;ExecStart&#34;</span><span class="p">,</span> <span class="p">[])</span>
</span></span><span class="line"><span class="cl">            <span class="k">for</span> <span class="n">idx</span><span class="p">,</span> <span class="n">cmd</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">cmdlist</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">                <span class="n">logg</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&#34;ExecStart[</span><span class="si">%s</span><span class="s2">]: </span><span class="si">%s</span><span class="s2">&#34;</span><span class="p">,</span> <span class="n">idx</span><span class="p">,</span> <span class="n">cmd</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">            <span class="k">for</span> <span class="n">cmd</span> <span class="ow">in</span> <span class="n">cmdlist</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">                <span class="n">pid</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">read_mainpid_from</span><span class="p">(</span><span class="n">conf</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">                <span class="n">env</span><span class="p">[</span><span class="s2">&#34;MAINPID&#34;</span><span class="p">]</span> <span class="o">=</span> <span class="n">strE</span><span class="p">(</span><span class="n">pid</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">                <span class="n">exe</span><span class="p">,</span> <span class="n">newcmd</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">exec_newcmd</span><span class="p">(</span><span class="n">cmd</span><span class="p">,</span> <span class="n">env</span><span class="p">,</span> <span class="n">conf</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">                <span class="n">logg</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&#34;</span><span class="si">%s</span><span class="s2"> start </span><span class="si">%s</span><span class="s2">&#34;</span><span class="p">,</span> <span class="n">runs</span><span class="p">,</span> <span class="n">shell_cmd</span><span class="p">(</span><span class="n">newcmd</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">                <span class="n">forkpid</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">fork</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">                <span class="k">if</span> <span class="ow">not</span> <span class="n">forkpid</span><span class="p">:</span> <span class="c1"># pragma: no cover</span>
</span></span><span class="line"><span class="cl">                    <span class="n">os</span><span class="o">.</span><span class="n">setsid</span><span class="p">()</span> <span class="c1"># detach child process from parent</span>
</span></span><span class="line"><span class="cl">                    <span class="bp">self</span><span class="o">.</span><span class="n">execve_from</span><span class="p">(</span><span class="n">conf</span><span class="p">,</span> <span class="n">newcmd</span><span class="p">,</span> <span class="n">env</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">                <span class="bp">self</span><span class="o">.</span><span class="n">write_status_from</span><span class="p">(</span><span class="n">conf</span><span class="p">,</span> <span class="n">MainPID</span><span class="o">=</span><span class="n">forkpid</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">                <span class="n">logg</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&#34;</span><span class="si">%s</span><span class="s2"> started PID </span><span class="si">%s</span><span class="s2">&#34;</span><span class="p">,</span> <span class="n">runs</span><span class="p">,</span> <span class="n">forkpid</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">                <span class="n">env</span><span class="p">[</span><span class="s2">&#34;MAINPID&#34;</span><span class="p">]</span> <span class="o">=</span> <span class="n">strE</span><span class="p">(</span><span class="n">forkpid</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">                <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="n">MinimumYield</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">                <span class="n">run</span> <span class="o">=</span> <span class="n">subprocess_testpid</span><span class="p">(</span><span class="n">forkpid</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">                <span class="k">if</span> <span class="n">run</span><span class="o">.</span><span class="n">returncode</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">                    <span class="n">logg</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&#34;</span><span class="si">%s</span><span class="s2"> stopped PID </span><span class="si">%s</span><span class="s2"> (</span><span class="si">%s</span><span class="s2">) &lt;-</span><span class="si">%s</span><span class="s2">&gt;&#34;</span><span class="p">,</span> <span class="n">runs</span><span class="p">,</span> <span class="n">run</span><span class="o">.</span><span class="n">pid</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                              <span class="n">run</span><span class="o">.</span><span class="n">returncode</span> <span class="ow">or</span> <span class="s2">&#34;OK&#34;</span><span class="p">,</span> <span class="n">run</span><span class="o">.</span><span class="n">signal</span> <span class="ow">or</span> <span class="s2">&#34;&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">                    <span class="k">if</span> <span class="n">doRemainAfterExit</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">                        <span class="bp">self</span><span class="o">.</span><span class="n">set_status_from</span><span class="p">(</span><span class="n">conf</span><span class="p">,</span> <span class="s2">&#34;ExecMainCode&#34;</span><span class="p">,</span> <span class="n">strE</span><span class="p">(</span><span class="n">run</span><span class="o">.</span><span class="n">returncode</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">                        <span class="n">active</span> <span class="o">=</span> <span class="n">run</span><span class="o">.</span><span class="n">returncode</span> <span class="ow">and</span> <span class="s2">&#34;failed&#34;</span> <span class="ow">or</span> <span class="s2">&#34;active&#34;</span>
</span></span><span class="line"><span class="cl">                        <span class="bp">self</span><span class="o">.</span><span class="n">write_status_from</span><span class="p">(</span><span class="n">conf</span><span class="p">,</span> <span class="n">AS</span><span class="o">=</span><span class="n">active</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">                    <span class="k">if</span> <span class="n">run</span><span class="o">.</span><span class="n">returncode</span> <span class="ow">and</span> <span class="n">exe</span><span class="o">.</span><span class="n">check</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">                        <span class="n">service_result</span> <span class="o">=</span> <span class="s2">&#34;failed&#34;</span>
</span></span><span class="line"><span class="cl">                        <span class="k">break</span>
</span></span><span class="line"><span class="cl">        <span class="k">elif</span> <span class="n">runs</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&#34;notify&#34;</span><span class="p">]:</span>
</span></span><span class="line"><span class="cl">            <span class="c1"># &#34;notify&#34; is the same as &#34;simple&#34; but we create a $NOTIFY_SOCKET</span>
</span></span><span class="line"><span class="cl">            <span class="c1"># and wait for startup completion by checking the socket messages</span>
</span></span><span class="line"><span class="cl">            <span class="n">pid_file</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">pid_file_from</span><span class="p">(</span><span class="n">conf</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">            <span class="n">pid</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">read_mainpid_from</span><span class="p">(</span><span class="n">conf</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">is_active_pid</span><span class="p">(</span><span class="n">pid</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">                <span class="n">logg</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&#34;the service is already running on PID </span><span class="si">%s</span><span class="s2">&#34;</span><span class="p">,</span> <span class="n">pid</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">                <span class="k">return</span> <span class="kc">False</span>
</span></span><span class="line"><span class="cl">            <span class="n">notify</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">notify_socket_from</span><span class="p">(</span><span class="n">conf</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">            <span class="k">if</span> <span class="n">notify</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">                <span class="n">env</span><span class="p">[</span><span class="s2">&#34;NOTIFY_SOCKET&#34;</span><span class="p">]</span> <span class="o">=</span> <span class="n">notify</span><span class="o">.</span><span class="n">socketfile</span>
</span></span><span class="line"><span class="cl">                <span class="n">logg</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&#34;use NOTIFY_SOCKET=</span><span class="si">%s</span><span class="s2">&#34;</span><span class="p">,</span> <span class="n">notify</span><span class="o">.</span><span class="n">socketfile</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">            <span class="k">if</span> <span class="n">doRemainAfterExit</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">                <span class="n">logg</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&#34;</span><span class="si">%s</span><span class="s2"> RemainAfterExit -&gt; AS=active&#34;</span><span class="p">,</span> <span class="n">runs</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">                <span class="bp">self</span><span class="o">.</span><span class="n">write_status_from</span><span class="p">(</span><span class="n">conf</span><span class="p">,</span> <span class="n">AS</span><span class="o">=</span><span class="s2">&#34;active&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">            <span class="n">cmdlist</span> <span class="o">=</span> <span class="n">conf</span><span class="o">.</span><span class="n">getlist</span><span class="p">(</span><span class="n">Service</span><span class="p">,</span> <span class="s2">&#34;ExecStart&#34;</span><span class="p">,</span> <span class="p">[])</span>
</span></span><span class="line"><span class="cl">            <span class="k">for</span> <span class="n">idx</span><span class="p">,</span> <span class="n">cmd</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">cmdlist</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">                <span class="n">logg</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&#34;ExecStart[</span><span class="si">%s</span><span class="s2">]: </span><span class="si">%s</span><span class="s2">&#34;</span><span class="p">,</span> <span class="n">idx</span><span class="p">,</span> <span class="n">cmd</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">            <span class="n">mainpid</span> <span class="o">=</span> <span class="kc">None</span>
</span></span><span class="line"><span class="cl">            <span class="k">for</span> <span class="n">cmd</span> <span class="ow">in</span> <span class="n">cmdlist</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">                <span class="n">mainpid</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">read_mainpid_from</span><span class="p">(</span><span class="n">conf</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">                <span class="n">env</span><span class="p">[</span><span class="s2">&#34;MAINPID&#34;</span><span class="p">]</span> <span class="o">=</span> <span class="n">strE</span><span class="p">(</span><span class="n">mainpid</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">                <span class="n">exe</span><span class="p">,</span> <span class="n">newcmd</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">exec_newcmd</span><span class="p">(</span><span class="n">cmd</span><span class="p">,</span> <span class="n">env</span><span class="p">,</span> <span class="n">conf</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">                <span class="n">logg</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&#34;</span><span class="si">%s</span><span class="s2"> start </span><span class="si">%s</span><span class="s2">&#34;</span><span class="p">,</span> <span class="n">runs</span><span class="p">,</span> <span class="n">shell_cmd</span><span class="p">(</span><span class="n">newcmd</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">                <span class="n">forkpid</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">fork</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">                <span class="k">if</span> <span class="ow">not</span> <span class="n">forkpid</span><span class="p">:</span> <span class="c1"># pragma: no cover</span>
</span></span><span class="line"><span class="cl">                    <span class="n">os</span><span class="o">.</span><span class="n">setsid</span><span class="p">()</span> <span class="c1"># detach child process from parent</span>
</span></span><span class="line"><span class="cl">                    <span class="bp">self</span><span class="o">.</span><span class="n">execve_from</span><span class="p">(</span><span class="n">conf</span><span class="p">,</span> <span class="n">newcmd</span><span class="p">,</span> <span class="n">env</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">                <span class="c1"># via NOTIFY # self.write_status_from(conf, MainPID=forkpid)</span>
</span></span><span class="line"><span class="cl">                <span class="n">logg</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&#34;</span><span class="si">%s</span><span class="s2"> started PID </span><span class="si">%s</span><span class="s2">&#34;</span><span class="p">,</span> <span class="n">runs</span><span class="p">,</span> <span class="n">forkpid</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">                <span class="n">mainpid</span> <span class="o">=</span> <span class="n">forkpid</span>
</span></span><span class="line"><span class="cl">                <span class="bp">self</span><span class="o">.</span><span class="n">write_status_from</span><span class="p">(</span><span class="n">conf</span><span class="p">,</span> <span class="n">MainPID</span><span class="o">=</span><span class="n">mainpid</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">                <span class="n">env</span><span class="p">[</span><span class="s2">&#34;MAINPID&#34;</span><span class="p">]</span> <span class="o">=</span> <span class="n">strE</span><span class="p">(</span><span class="n">mainpid</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">                <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="n">MinimumYield</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">                <span class="n">run</span> <span class="o">=</span> <span class="n">subprocess_testpid</span><span class="p">(</span><span class="n">forkpid</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">                <span class="k">if</span> <span class="n">run</span><span class="o">.</span><span class="n">returncode</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">                    <span class="n">logg</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&#34;</span><span class="si">%s</span><span class="s2"> stopped PID </span><span class="si">%s</span><span class="s2"> (</span><span class="si">%s</span><span class="s2">) &lt;-</span><span class="si">%s</span><span class="s2">&gt;&#34;</span><span class="p">,</span> <span class="n">runs</span><span class="p">,</span> <span class="n">run</span><span class="o">.</span><span class="n">pid</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                              <span class="n">run</span><span class="o">.</span><span class="n">returncode</span> <span class="ow">or</span> <span class="s2">&#34;OK&#34;</span><span class="p">,</span> <span class="n">run</span><span class="o">.</span><span class="n">signal</span> <span class="ow">or</span> <span class="s2">&#34;&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">                    <span class="k">if</span> <span class="n">doRemainAfterExit</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">                        <span class="bp">self</span><span class="o">.</span><span class="n">set_status_from</span><span class="p">(</span><span class="n">conf</span><span class="p">,</span> <span class="s2">&#34;ExecMainCode&#34;</span><span class="p">,</span> <span class="n">strE</span><span class="p">(</span><span class="n">run</span><span class="o">.</span><span class="n">returncode</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">                        <span class="n">active</span> <span class="o">=</span> <span class="n">run</span><span class="o">.</span><span class="n">returncode</span> <span class="ow">and</span> <span class="s2">&#34;failed&#34;</span> <span class="ow">or</span> <span class="s2">&#34;active&#34;</span>
</span></span><span class="line"><span class="cl">                        <span class="bp">self</span><span class="o">.</span><span class="n">write_status_from</span><span class="p">(</span><span class="n">conf</span><span class="p">,</span> <span class="n">AS</span><span class="o">=</span><span class="n">active</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">                    <span class="k">if</span> <span class="n">run</span><span class="o">.</span><span class="n">returncode</span> <span class="ow">and</span> <span class="n">exe</span><span class="o">.</span><span class="n">check</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">                        <span class="n">service_result</span> <span class="o">=</span> <span class="s2">&#34;failed&#34;</span>
</span></span><span class="line"><span class="cl">                        <span class="k">break</span>
</span></span><span class="line"><span class="cl">            <span class="k">if</span> <span class="n">service_result</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&#34;success&#34;</span><span class="p">]</span> <span class="ow">and</span> <span class="n">mainpid</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">                <span class="n">logg</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&#34;okay, waiting on socket for </span><span class="si">%s</span><span class="s2">s&#34;</span><span class="p">,</span> <span class="n">timeout</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">                <span class="n">results</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">wait_notify_socket</span><span class="p">(</span><span class="n">notify</span><span class="p">,</span> <span class="n">timeout</span><span class="p">,</span> <span class="n">mainpid</span><span class="p">,</span> <span class="n">pid_file</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">                <span class="k">if</span> <span class="s2">&#34;MAINPID&#34;</span> <span class="ow">in</span> <span class="n">results</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">                    <span class="n">new_pid</span> <span class="o">=</span> <span class="n">to_intN</span><span class="p">(</span><span class="n">results</span><span class="p">[</span><span class="s2">&#34;MAINPID&#34;</span><span class="p">])</span>
</span></span><span class="line"><span class="cl">                    <span class="k">if</span> <span class="n">new_pid</span> <span class="ow">and</span> <span class="n">new_pid</span> <span class="o">!=</span> <span class="n">mainpid</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">                        <span class="n">logg</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&#34;NEW PID </span><span class="si">%s</span><span class="s2"> from sd_notify (was PID </span><span class="si">%s</span><span class="s2">)&#34;</span><span class="p">,</span> <span class="n">new_pid</span><span class="p">,</span> <span class="n">mainpid</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">                        <span class="bp">self</span><span class="o">.</span><span class="n">write_status_from</span><span class="p">(</span><span class="n">conf</span><span class="p">,</span> <span class="n">MainPID</span><span class="o">=</span><span class="n">new_pid</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">                        <span class="n">mainpid</span> <span class="o">=</span> <span class="n">new_pid</span>
</span></span><span class="line"><span class="cl">                <span class="n">logg</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&#34;</span><span class="si">%s</span><span class="s2"> start done </span><span class="si">%s</span><span class="s2">&#34;</span><span class="p">,</span> <span class="n">runs</span><span class="p">,</span> <span class="n">mainpid</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">                <span class="n">pid</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">read_mainpid_from</span><span class="p">(</span><span class="n">conf</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">                <span class="k">if</span> <span class="n">pid</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">                    <span class="n">env</span><span class="p">[</span><span class="s2">&#34;MAINPID&#34;</span><span class="p">]</span> <span class="o">=</span> <span class="n">strE</span><span class="p">(</span><span class="n">pid</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">                <span class="k">else</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">                    <span class="n">service_result</span> <span class="o">=</span> <span class="s2">&#34;timeout&#34;</span> <span class="c1"># &#34;could not start service&#34;</span>
</span></span><span class="line"><span class="cl">        <span class="k">elif</span> <span class="n">runs</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&#34;forking&#34;</span><span class="p">]:</span>
</span></span><span class="line"><span class="cl">            <span class="n">pid_file</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">pid_file_from</span><span class="p">(</span><span class="n">conf</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">            <span class="k">for</span> <span class="n">cmd</span> <span class="ow">in</span> <span class="n">conf</span><span class="o">.</span><span class="n">getlist</span><span class="p">(</span><span class="n">Service</span><span class="p">,</span> <span class="s2">&#34;ExecStart&#34;</span><span class="p">,</span> <span class="p">[]):</span>
</span></span><span class="line"><span class="cl">                <span class="n">exe</span><span class="p">,</span> <span class="n">newcmd</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">exec_newcmd</span><span class="p">(</span><span class="n">cmd</span><span class="p">,</span> <span class="n">env</span><span class="p">,</span> <span class="n">conf</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">                <span class="k">if</span> <span class="ow">not</span> <span class="n">newcmd</span><span class="p">:</span> <span class="k">continue</span>
</span></span><span class="line"><span class="cl">                <span class="n">logg</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&#34;</span><span class="si">%s</span><span class="s2"> start </span><span class="si">%s</span><span class="s2">&#34;</span><span class="p">,</span> <span class="n">runs</span><span class="p">,</span> <span class="n">shell_cmd</span><span class="p">(</span><span class="n">newcmd</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">                <span class="n">forkpid</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">fork</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">                <span class="k">if</span> <span class="ow">not</span> <span class="n">forkpid</span><span class="p">:</span> <span class="c1"># pragma: no cover</span>
</span></span><span class="line"><span class="cl">                    <span class="n">os</span><span class="o">.</span><span class="n">setsid</span><span class="p">()</span> <span class="c1"># detach child process from parent</span>
</span></span><span class="line"><span class="cl">                    <span class="bp">self</span><span class="o">.</span><span class="n">execve_from</span><span class="p">(</span><span class="n">conf</span><span class="p">,</span> <span class="n">newcmd</span><span class="p">,</span> <span class="n">env</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">                <span class="n">logg</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&#34;</span><span class="si">%s</span><span class="s2"> started PID </span><span class="si">%s</span><span class="s2">&#34;</span><span class="p">,</span> <span class="n">runs</span><span class="p">,</span> <span class="n">forkpid</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">                <span class="n">run</span> <span class="o">=</span> <span class="n">subprocess_waitpid</span><span class="p">(</span><span class="n">forkpid</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">                <span class="k">if</span> <span class="n">run</span><span class="o">.</span><span class="n">returncode</span> <span class="ow">and</span> <span class="n">exe</span><span class="o">.</span><span class="n">check</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">                    <span class="n">returncode</span> <span class="o">=</span> <span class="n">run</span><span class="o">.</span><span class="n">returncode</span>
</span></span><span class="line"><span class="cl">                    <span class="n">service_result</span> <span class="o">=</span> <span class="s2">&#34;failed&#34;</span>
</span></span><span class="line"><span class="cl">                <span class="n">logg</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&#34;</span><span class="si">%s</span><span class="s2"> stopped PID </span><span class="si">%s</span><span class="s2"> (</span><span class="si">%s</span><span class="s2">) &lt;-</span><span class="si">%s</span><span class="s2">&gt;&#34;</span><span class="p">,</span> <span class="n">runs</span><span class="p">,</span> <span class="n">run</span><span class="o">.</span><span class="n">pid</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                          <span class="n">run</span><span class="o">.</span><span class="n">returncode</span> <span class="ow">or</span> <span class="s2">&#34;OK&#34;</span><span class="p">,</span> <span class="n">run</span><span class="o">.</span><span class="n">signal</span> <span class="ow">or</span> <span class="s2">&#34;&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">            <span class="k">if</span> <span class="n">pid_file</span> <span class="ow">and</span> <span class="n">service_result</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&#34;success&#34;</span><span class="p">]:</span>
</span></span><span class="line"><span class="cl">                <span class="n">pid</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">wait_pid_file</span><span class="p">(</span><span class="n">pid_file</span><span class="p">)</span> <span class="c1"># application PIDFile</span>
</span></span><span class="line"><span class="cl">                <span class="n">logg</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&#34;</span><span class="si">%s</span><span class="s2"> start done PID </span><span class="si">%s</span><span class="s2"> [</span><span class="si">%s</span><span class="s2">]&#34;</span><span class="p">,</span> <span class="n">runs</span><span class="p">,</span> <span class="n">pid</span><span class="p">,</span> <span class="n">pid_file</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">                <span class="k">if</span> <span class="n">pid</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">                    <span class="n">env</span><span class="p">[</span><span class="s2">&#34;MAINPID&#34;</span><span class="p">]</span> <span class="o">=</span> <span class="n">strE</span><span class="p">(</span><span class="n">pid</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">            <span class="k">if</span> <span class="ow">not</span> <span class="n">pid_file</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">                <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="n">MinimumTimeoutStartSec</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">                <span class="n">logg</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&#34;No PIDFile for forking </span><span class="si">%s</span><span class="s2">&#34;</span><span class="p">,</span> <span class="n">strQ</span><span class="p">(</span><span class="n">conf</span><span class="o">.</span><span class="n">filename</span><span class="p">()))</span>
</span></span><span class="line"><span class="cl">                <span class="n">status_file</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_status_file_from</span><span class="p">(</span><span class="n">conf</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">                <span class="bp">self</span><span class="o">.</span><span class="n">set_status_from</span><span class="p">(</span><span class="n">conf</span><span class="p">,</span> <span class="s2">&#34;ExecMainCode&#34;</span><span class="p">,</span> <span class="n">strE</span><span class="p">(</span><span class="n">returncode</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">                <span class="n">active</span> <span class="o">=</span> <span class="n">returncode</span> <span class="ow">and</span> <span class="s2">&#34;failed&#34;</span> <span class="ow">or</span> <span class="s2">&#34;active&#34;</span>
</span></span><span class="line"><span class="cl">                <span class="bp">self</span><span class="o">.</span><span class="n">write_status_from</span><span class="p">(</span><span class="n">conf</span><span class="p">,</span> <span class="n">AS</span><span class="o">=</span><span class="n">active</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="k">else</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">            <span class="n">logg</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&#34;unsupported run type &#39;</span><span class="si">%s</span><span class="s2">&#39;&#34;</span><span class="p">,</span> <span class="n">runs</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">            <span class="k">return</span> <span class="kc">False</span>
</span></span><span class="line"><span class="cl">        <span class="c1"># POST sequence</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">is_active_from</span><span class="p">(</span><span class="n">conf</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">            <span class="n">logg</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&#34;</span><span class="si">%s</span><span class="s2"> start not active&#34;</span><span class="p">,</span> <span class="n">runs</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">            <span class="c1"># according to the systemd documentation, a failed start-sequence</span>
</span></span><span class="line"><span class="cl">            <span class="c1"># should execute the ExecStopPost sequence allowing some cleanup.</span>
</span></span><span class="line"><span class="cl">            <span class="n">env</span><span class="p">[</span><span class="s2">&#34;SERVICE_RESULT&#34;</span><span class="p">]</span> <span class="o">=</span> <span class="n">service_result</span>
</span></span><span class="line"><span class="cl">            <span class="k">for</span> <span class="n">cmd</span> <span class="ow">in</span> <span class="n">conf</span><span class="o">.</span><span class="n">getlist</span><span class="p">(</span><span class="n">Service</span><span class="p">,</span> <span class="s2">&#34;ExecStopPost&#34;</span><span class="p">,</span> <span class="p">[]):</span>
</span></span><span class="line"><span class="cl">                <span class="n">exe</span><span class="p">,</span> <span class="n">newcmd</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">exec_newcmd</span><span class="p">(</span><span class="n">cmd</span><span class="p">,</span> <span class="n">env</span><span class="p">,</span> <span class="n">conf</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">                <span class="n">logg</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&#34;post-fail </span><span class="si">%s</span><span class="s2">&#34;</span><span class="p">,</span> <span class="n">shell_cmd</span><span class="p">(</span><span class="n">newcmd</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">                <span class="n">forkpid</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">fork</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">                <span class="k">if</span> <span class="ow">not</span> <span class="n">forkpid</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">                    <span class="bp">self</span><span class="o">.</span><span class="n">execve_from</span><span class="p">(</span><span class="n">conf</span><span class="p">,</span> <span class="n">newcmd</span><span class="p">,</span> <span class="n">env</span><span class="p">)</span> <span class="c1"># pragma: no cover</span>
</span></span><span class="line"><span class="cl">                <span class="n">run</span> <span class="o">=</span> <span class="n">subprocess_waitpid</span><span class="p">(</span><span class="n">forkpid</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">                <span class="n">logg</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&#34;post-fail done (</span><span class="si">%s</span><span class="s2">) &lt;-</span><span class="si">%s</span><span class="s2">&gt;&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                           <span class="n">run</span><span class="o">.</span><span class="n">returncode</span> <span class="ow">or</span> <span class="s2">&#34;OK&#34;</span><span class="p">,</span> <span class="n">run</span><span class="o">.</span><span class="n">signal</span> <span class="ow">or</span> <span class="s2">&#34;&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_only_what</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&#34;none&#34;</span><span class="p">,</span> <span class="s2">&#34;keep&#34;</span><span class="p">]:</span>
</span></span><span class="line"><span class="cl">                <span class="bp">self</span><span class="o">.</span><span class="n">remove_service_directories</span><span class="p">(</span><span class="n">conf</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">            <span class="k">return</span> <span class="kc">False</span>
</span></span><span class="line"><span class="cl">        <span class="k">else</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">            <span class="k">for</span> <span class="n">cmd</span> <span class="ow">in</span> <span class="n">conf</span><span class="o">.</span><span class="n">getlist</span><span class="p">(</span><span class="n">Service</span><span class="p">,</span> <span class="s2">&#34;ExecStartPost&#34;</span><span class="p">,</span> <span class="p">[]):</span>
</span></span><span class="line"><span class="cl">                <span class="n">exe</span><span class="p">,</span> <span class="n">newcmd</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">exec_newcmd</span><span class="p">(</span><span class="n">cmd</span><span class="p">,</span> <span class="n">env</span><span class="p">,</span> <span class="n">conf</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">                <span class="n">logg</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&#34;post-start </span><span class="si">%s</span><span class="s2">&#34;</span><span class="p">,</span> <span class="n">shell_cmd</span><span class="p">(</span><span class="n">newcmd</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">                <span class="n">forkpid</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">fork</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">                <span class="k">if</span> <span class="ow">not</span> <span class="n">forkpid</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">                    <span class="bp">self</span><span class="o">.</span><span class="n">execve_from</span><span class="p">(</span><span class="n">conf</span><span class="p">,</span> <span class="n">newcmd</span><span class="p">,</span> <span class="n">env</span><span class="p">)</span> <span class="c1"># pragma: no cover</span>
</span></span><span class="line"><span class="cl">                <span class="n">run</span> <span class="o">=</span> <span class="n">subprocess_waitpid</span><span class="p">(</span><span class="n">forkpid</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">                <span class="n">logg</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&#34;post-start done (</span><span class="si">%s</span><span class="s2">) &lt;-</span><span class="si">%s</span><span class="s2">&gt;&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                           <span class="n">run</span><span class="o">.</span><span class="n">returncode</span> <span class="ow">or</span> <span class="s2">&#34;OK&#34;</span><span class="p">,</span> <span class="n">run</span><span class="o">.</span><span class="n">signal</span> <span class="ow">or</span> <span class="s2">&#34;&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">            <span class="k">return</span> <span class="kc">True</span>
</span></span><span class="line"><span class="cl">    <span class="k">def</span> <span class="nf">listen_modules</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">modules</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">        <span class="s2">&#34;&#34;&#34; [UNIT]... -- listen socket units&#34;&#34;&#34;</span>
</span></span><span class="line"><span class="cl">        <span class="n">found_all</span> <span class="o">=</span> <span class="kc">True</span>
</span></span><span class="line"><span class="cl">        <span class="n">units</span> <span class="o">=</span> <span class="p">[]</span>
</span></span><span class="line"><span class="cl">        <span class="k">for</span> <span class="n">module</span> <span class="ow">in</span> <span class="n">modules</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">            <span class="n">matched</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">match_units</span><span class="p">(</span><span class="n">to_list</span><span class="p">(</span><span class="n">module</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">            <span class="k">if</span> <span class="ow">not</span> <span class="n">matched</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">                <span class="n">logg</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&#34;Unit </span><span class="si">%s</span><span class="s2"> not found.&#34;</span><span class="p">,</span> <span class="n">unit_of</span><span class="p">(</span><span class="n">module</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">                <span class="bp">self</span><span class="o">.</span><span class="n">error</span> <span class="o">|=</span> <span class="n">NOT_FOUND</span>
</span></span><span class="line"><span class="cl">                <span class="n">found_all</span> <span class="o">=</span> <span class="kc">False</span>
</span></span><span class="line"><span class="cl">                <span class="k">continue</span>
</span></span><span class="line"><span class="cl">            <span class="k">for</span> <span class="n">unit</span> <span class="ow">in</span> <span class="n">matched</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">                <span class="k">if</span> <span class="n">unit</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">units</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">                    <span class="n">units</span> <span class="o">+=</span> <span class="p">[</span><span class="n">unit</span><span class="p">]</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">listen_units</span><span class="p">(</span><span class="n">units</span><span class="p">)</span> <span class="ow">and</span> <span class="n">found_all</span>
</span></span><span class="line"><span class="cl">    <span class="k">def</span> <span class="nf">listen_units</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">units</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">        <span class="s2">&#34;&#34;&#34; fails if any socket does not start &#34;&#34;&#34;</span>
</span></span><span class="line"><span class="cl">        <span class="bp">self</span><span class="o">.</span><span class="n">wait_system</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">        <span class="n">done</span> <span class="o">=</span> <span class="kc">True</span>
</span></span><span class="line"><span class="cl">        <span class="n">started_units</span> <span class="o">=</span> <span class="p">[]</span>
</span></span><span class="line"><span class="cl">        <span class="n">active_units</span> <span class="o">=</span> <span class="p">[]</span>
</span></span><span class="line"><span class="cl">        <span class="k">for</span> <span class="n">unit</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">sortedAfter</span><span class="p">(</span><span class="n">units</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">            <span class="n">started_units</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">unit</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">            <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">listen_unit</span><span class="p">(</span><span class="n">unit</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">                <span class="n">done</span> <span class="o">=</span> <span class="kc">False</span>
</span></span><span class="line"><span class="cl">            <span class="k">else</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">                <span class="n">active_units</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">unit</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="n">active_units</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">            <span class="n">logg</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&#34;init-loop start&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">            <span class="n">sig</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">init_loop_until_stop</span><span class="p">(</span><span class="n">started_units</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">            <span class="n">logg</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&#34;init-loop </span><span class="si">%s</span><span class="s2">&#34;</span><span class="p">,</span> <span class="n">sig</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="k">for</span> <span class="n">unit</span> <span class="ow">in</span> <span class="nb">reversed</span><span class="p">(</span><span class="n">started_units</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">            <span class="k">pass</span> <span class="c1"># self.stop_unit(unit)</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="n">done</span>
</span></span><span class="line"><span class="cl">    <span class="k">def</span> <span class="nf">listen_unit</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">unit</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">        <span class="n">conf</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">load_unit_conf</span><span class="p">(</span><span class="n">unit</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="n">conf</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">            <span class="n">logg</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&#34;unit could not be loaded (</span><span class="si">%s</span><span class="s2">)&#34;</span><span class="p">,</span> <span class="n">unit</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">            <span class="n">logg</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&#34;Unit </span><span class="si">%s</span><span class="s2"> not found.&#34;</span><span class="p">,</span> <span class="n">unit</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">            <span class="k">return</span> <span class="kc">False</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">not_user_conf</span><span class="p">(</span><span class="n">conf</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">            <span class="n">logg</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&#34;Unit </span><span class="si">%s</span><span class="s2"> not for --user mode&#34;</span><span class="p">,</span> <span class="n">unit</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">            <span class="k">return</span> <span class="kc">False</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">listen_unit_from</span><span class="p">(</span><span class="n">conf</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="k">def</span> <span class="nf">listen_unit_from</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">conf</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="ow">not</span> <span class="n">conf</span><span class="p">:</span> <span class="k">return</span> <span class="kc">False</span>
</span></span><span class="line"><span class="cl">        <span class="k">with</span> <span class="n">waitlock</span><span class="p">(</span><span class="n">conf</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">            <span class="n">logg</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&#34; listen unit </span><span class="si">%s</span><span class="s2"> =&gt; </span><span class="si">%s</span><span class="s2">&#34;</span><span class="p">,</span> <span class="n">conf</span><span class="o">.</span><span class="n">name</span><span class="p">(),</span> <span class="n">strQ</span><span class="p">(</span><span class="n">conf</span><span class="o">.</span><span class="n">filename</span><span class="p">()))</span>
</span></span><span class="line"><span class="cl">            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">do_listen_unit_from</span><span class="p">(</span><span class="n">conf</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="k">def</span> <span class="nf">do_listen_unit_from</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">conf</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="n">conf</span><span class="o">.</span><span class="n">name</span><span class="p">()</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s2">&#34;.socket&#34;</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">do_start_socket_from</span><span class="p">(</span><span class="n">conf</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="k">else</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">            <span class="n">logg</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&#34;listen not implemented for unit type: </span><span class="si">%s</span><span class="s2">&#34;</span><span class="p">,</span> <span class="n">conf</span><span class="o">.</span><span class="n">name</span><span class="p">())</span>
</span></span><span class="line"><span class="cl">            <span class="k">return</span> <span class="kc">False</span>
</span></span><span class="line"><span class="cl">    <span class="k">def</span> <span class="nf">do_accept_socket_from</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">conf</span><span class="p">,</span> <span class="n">sock</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">        <span class="n">logg</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&#34;</span><span class="si">%s</span><span class="s2">: accepting </span><span class="si">%s</span><span class="s2">&#34;</span><span class="p">,</span> <span class="n">conf</span><span class="o">.</span><span class="n">name</span><span class="p">(),</span> <span class="n">sock</span><span class="o">.</span><span class="n">fileno</span><span class="p">())</span>
</span></span><span class="line"><span class="cl">        <span class="n">service_unit</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_socket_service_from</span><span class="p">(</span><span class="n">conf</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="n">service_conf</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">load_unit_conf</span><span class="p">(</span><span class="n">service_unit</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="n">service_conf</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="n">TestAccept</span><span class="p">:</span>  <span class="c1"># pragma: no cover</span>
</span></span><span class="line"><span class="cl">            <span class="k">if</span> <span class="n">sock</span><span class="o">.</span><span class="n">type</span> <span class="o">==</span> <span class="n">socket</span><span class="o">.</span><span class="n">SOCK_STREAM</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">                <span class="n">conn</span><span class="p">,</span> <span class="n">addr</span> <span class="o">=</span> <span class="n">sock</span><span class="o">.</span><span class="n">accept</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">                <span class="n">data</span> <span class="o">=</span> <span class="n">conn</span><span class="o">.</span><span class="n">recv</span><span class="p">(</span><span class="mi">1024</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">                <span class="n">logg</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&#34;</span><span class="si">%s</span><span class="s2">: &#39;</span><span class="si">%s</span><span class="s2">&#39;&#34;</span><span class="p">,</span> <span class="n">conf</span><span class="o">.</span><span class="n">name</span><span class="p">(),</span> <span class="n">data</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">                <span class="n">conn</span><span class="o">.</span><span class="n">send</span><span class="p">(</span><span class="sa">b</span><span class="s2">&#34;ERROR: &#34;</span><span class="o">+</span><span class="n">data</span><span class="o">.</span><span class="n">upper</span><span class="p">())</span>
</span></span><span class="line"><span class="cl">                <span class="n">conn</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">                <span class="k">return</span> <span class="kc">False</span>
</span></span><span class="line"><span class="cl">            <span class="k">if</span> <span class="n">sock</span><span class="o">.</span><span class="n">type</span> <span class="o">==</span> <span class="n">socket</span><span class="o">.</span><span class="n">SOCK_DGRAM</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">                <span class="n">data</span><span class="p">,</span> <span class="n">sender</span> <span class="o">=</span> <span class="n">sock</span><span class="o">.</span><span class="n">recvfrom</span><span class="p">(</span><span class="mi">1024</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">                <span class="n">logg</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&#34;</span><span class="si">%s</span><span class="s2">: &#39;</span><span class="si">%s</span><span class="s2">&#39;&#34;</span><span class="p">,</span> <span class="n">conf</span><span class="o">.</span><span class="n">name</span><span class="p">(),</span> <span class="n">data</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">                <span class="n">sock</span><span class="o">.</span><span class="n">sendto</span><span class="p">(</span><span class="sa">b</span><span class="s2">&#34;ERROR: &#34;</span><span class="o">+</span><span class="n">data</span><span class="o">.</span><span class="n">upper</span><span class="p">(),</span> <span class="n">sender</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">                <span class="k">return</span> <span class="kc">False</span>
</span></span><span class="line"><span class="cl">            <span class="n">logg</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&#34;can not accept socket type </span><span class="si">%s</span><span class="s2">&#34;</span><span class="p">,</span> <span class="n">strINET</span><span class="p">(</span><span class="n">sock</span><span class="o">.</span><span class="n">type</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">            <span class="k">return</span> <span class="kc">False</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">do_start_service_from</span><span class="p">(</span><span class="n">service_conf</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="k">def</span> <span class="nf">get_socket_service_from</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">conf</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">        <span class="n">socket_unit</span> <span class="o">=</span> <span class="n">conf</span><span class="o">.</span><span class="n">name</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">        <span class="n">accept</span> <span class="o">=</span> <span class="n">conf</span><span class="o">.</span><span class="n">getbool</span><span class="p">(</span><span class="n">Socket</span><span class="p">,</span> <span class="s2">&#34;Accept&#34;</span><span class="p">,</span> <span class="s2">&#34;no&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="n">service_type</span> <span class="o">=</span> <span class="n">accept</span> <span class="ow">and</span> <span class="s2">&#34;@.service&#34;</span> <span class="ow">or</span> <span class="s2">&#34;.service&#34;</span>
</span></span><span class="line"><span class="cl">        <span class="n">service_name</span> <span class="o">=</span> <span class="n">path_replace_extension</span><span class="p">(</span><span class="n">socket_unit</span><span class="p">,</span> <span class="s2">&#34;.socket&#34;</span><span class="p">,</span> <span class="n">service_type</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="n">service_unit</span> <span class="o">=</span> <span class="n">conf</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">Socket</span><span class="p">,</span> <span class="n">Service</span><span class="p">,</span> <span class="n">service_name</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="n">logg</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&#34;socket </span><span class="si">%s</span><span class="s2"> -&gt; service </span><span class="si">%s</span><span class="s2">&#34;</span><span class="p">,</span> <span class="n">socket_unit</span><span class="p">,</span> <span class="n">service_unit</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="n">service_unit</span>
</span></span><span class="line"><span class="cl">    <span class="k">def</span> <span class="nf">do_start_socket_from</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">conf</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">        <span class="n">runs</span> <span class="o">=</span> <span class="s2">&#34;socket&#34;</span>
</span></span><span class="line"><span class="cl">        <span class="n">timeout</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_SocketTimeoutSec</span><span class="p">(</span><span class="n">conf</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="n">accept</span> <span class="o">=</span> <span class="n">conf</span><span class="o">.</span><span class="n">getbool</span><span class="p">(</span><span class="n">Socket</span><span class="p">,</span> <span class="s2">&#34;Accept&#34;</span><span class="p">,</span> <span class="s2">&#34;no&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="n">stream</span> <span class="o">=</span> <span class="n">conf</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">Socket</span><span class="p">,</span> <span class="s2">&#34;ListenStream&#34;</span><span class="p">,</span> <span class="s2">&#34;&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="n">service_unit</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_socket_service_from</span><span class="p">(</span><span class="n">conf</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="n">service_conf</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">load_unit_conf</span><span class="p">(</span><span class="n">service_unit</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="n">service_conf</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">            <span class="n">logg</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&#34;unit could not be loaded (</span><span class="si">%s</span><span class="s2">)&#34;</span><span class="p">,</span> <span class="n">service_unit</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">            <span class="n">logg</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&#34;Unit </span><span class="si">%s</span><span class="s2"> not found.&#34;</span><span class="p">,</span> <span class="n">service_unit</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">            <span class="k">return</span> <span class="kc">False</span>
</span></span><span class="line"><span class="cl">        <span class="n">env</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_env</span><span class="p">(</span><span class="n">conf</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_quiet</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">            <span class="n">okee</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">exec_check_unit</span><span class="p">(</span><span class="n">conf</span><span class="p">,</span> <span class="n">env</span><span class="p">,</span> <span class="n">Socket</span><span class="p">,</span> <span class="s2">&#34;Exec&#34;</span><span class="p">)</span> <span class="c1"># all...</span>
</span></span><span class="line"><span class="cl">            <span class="k">if</span> <span class="ow">not</span> <span class="n">okee</span> <span class="ow">and</span> <span class="n">_no_reload</span><span class="p">:</span> <span class="k">return</span> <span class="kc">False</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="kc">True</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">            <span class="k">for</span> <span class="n">cmd</span> <span class="ow">in</span> <span class="n">conf</span><span class="o">.</span><span class="n">getlist</span><span class="p">(</span><span class="n">Socket</span><span class="p">,</span> <span class="s2">&#34;ExecStartPre&#34;</span><span class="p">,</span> <span class="p">[]):</span>
</span></span><span class="line"><span class="cl">                <span class="n">exe</span><span class="p">,</span> <span class="n">newcmd</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">exec_newcmd</span><span class="p">(</span><span class="n">cmd</span><span class="p">,</span> <span class="n">env</span><span class="p">,</span> <span class="n">conf</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">                <span class="n">logg</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&#34; pre-start </span><span class="si">%s</span><span class="s2">&#34;</span><span class="p">,</span> <span class="n">shell_cmd</span><span class="p">(</span><span class="n">newcmd</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">                <span class="n">forkpid</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">fork</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">                <span class="k">if</span> <span class="ow">not</span> <span class="n">forkpid</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">                    <span class="bp">self</span><span class="o">.</span><span class="n">execve_from</span><span class="p">(</span><span class="n">conf</span><span class="p">,</span> <span class="n">newcmd</span><span class="p">,</span> <span class="n">env</span><span class="p">)</span> <span class="c1"># pragma: no cover</span>
</span></span><span class="line"><span class="cl">                <span class="n">run</span> <span class="o">=</span> <span class="n">subprocess_waitpid</span><span class="p">(</span><span class="n">forkpid</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">                <span class="n">logg</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&#34; pre-start done (</span><span class="si">%s</span><span class="s2">) &lt;-</span><span class="si">%s</span><span class="s2">&gt;&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                           <span class="n">run</span><span class="o">.</span><span class="n">returncode</span> <span class="ow">or</span> <span class="s2">&#34;OK&#34;</span><span class="p">,</span> <span class="n">run</span><span class="o">.</span><span class="n">signal</span> <span class="ow">or</span> <span class="s2">&#34;&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">                <span class="k">if</span> <span class="n">run</span><span class="o">.</span><span class="n">returncode</span> <span class="ow">and</span> <span class="n">exe</span><span class="o">.</span><span class="n">check</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">                    <span class="n">logg</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&#34;the ExecStartPre control process exited with error code&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">                    <span class="n">active</span> <span class="o">=</span> <span class="s2">&#34;failed&#34;</span>
</span></span><span class="line"><span class="cl">                    <span class="bp">self</span><span class="o">.</span><span class="n">write_status_from</span><span class="p">(</span><span class="n">conf</span><span class="p">,</span> <span class="n">AS</span><span class="o">=</span><span class="n">active</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">                    <span class="k">return</span> <span class="kc">False</span>
</span></span><span class="line"><span class="cl">        <span class="c1"># service_directories = self.create_service_directories(conf)</span>
</span></span><span class="line"><span class="cl">        <span class="c1"># env.update(service_directories)</span>
</span></span><span class="line"><span class="cl">        <span class="n">listening</span><span class="o">=</span><span class="kc">False</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="ow">not</span> <span class="n">accept</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">            <span class="n">sock</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">create_socket</span><span class="p">(</span><span class="n">conf</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">            <span class="k">if</span> <span class="n">sock</span> <span class="ow">and</span> <span class="n">TestListen</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">                <span class="n">listening</span><span class="o">=</span><span class="kc">True</span>
</span></span><span class="line"><span class="cl">                <span class="bp">self</span><span class="o">.</span><span class="n">_sockets</span><span class="p">[</span><span class="n">conf</span><span class="o">.</span><span class="n">name</span><span class="p">()]</span> <span class="o">=</span> <span class="n">SystemctlSocket</span><span class="p">(</span><span class="n">conf</span><span class="p">,</span> <span class="n">sock</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">                <span class="n">service_result</span> <span class="o">=</span> <span class="s2">&#34;success&#34;</span>
</span></span><span class="line"><span class="cl">                <span class="n">state</span> <span class="o">=</span> <span class="n">sock</span> <span class="ow">and</span> <span class="s2">&#34;active&#34;</span> <span class="ow">or</span> <span class="s2">&#34;failed&#34;</span>
</span></span><span class="line"><span class="cl">                <span class="bp">self</span><span class="o">.</span><span class="n">write_status_from</span><span class="p">(</span><span class="n">conf</span><span class="p">,</span> <span class="n">AS</span><span class="o">=</span><span class="n">state</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="ow">not</span> <span class="n">listening</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">            <span class="c1"># we do not listen but have the service started right away</span>
</span></span><span class="line"><span class="cl">            <span class="n">done</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">do_start_service_from</span><span class="p">(</span><span class="n">service_conf</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">            <span class="n">service_result</span> <span class="o">=</span> <span class="n">done</span> <span class="ow">and</span> <span class="s2">&#34;success&#34;</span> <span class="ow">or</span> <span class="s2">&#34;failed&#34;</span>
</span></span><span class="line"><span class="cl">            <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">is_active_from</span><span class="p">(</span><span class="n">service_conf</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">                <span class="n">service_result</span> <span class="o">=</span> <span class="s2">&#34;failed&#34;</span>
</span></span><span class="line"><span class="cl">            <span class="n">state</span> <span class="o">=</span> <span class="n">service_result</span>
</span></span><span class="line"><span class="cl">            <span class="k">if</span> <span class="n">service_result</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&#34;success&#34;</span><span class="p">]:</span>
</span></span><span class="line"><span class="cl">                <span class="n">state</span> <span class="o">=</span> <span class="s2">&#34;active&#34;</span>
</span></span><span class="line"><span class="cl">            <span class="bp">self</span><span class="o">.</span><span class="n">write_status_from</span><span class="p">(</span><span class="n">conf</span><span class="p">,</span> <span class="n">AS</span><span class="o">=</span><span class="n">state</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="c1"># POST sequence</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="n">service_result</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&#34;failed&#34;</span><span class="p">]:</span>
</span></span><span class="line"><span class="cl">            <span class="c1"># according to the systemd documentation, a failed start-sequence</span>
</span></span><span class="line"><span class="cl">            <span class="c1"># should execute the ExecStopPost sequence allowing some cleanup.</span>
</span></span><span class="line"><span class="cl">            <span class="n">env</span><span class="p">[</span><span class="s2">&#34;SERVICE_RESULT&#34;</span><span class="p">]</span> <span class="o">=</span> <span class="n">service_result</span>
</span></span><span class="line"><span class="cl">            <span class="k">for</span> <span class="n">cmd</span> <span class="ow">in</span> <span class="n">conf</span><span class="o">.</span><span class="n">getlist</span><span class="p">(</span><span class="n">Socket</span><span class="p">,</span> <span class="s2">&#34;ExecStopPost&#34;</span><span class="p">,</span> <span class="p">[]):</span>
</span></span><span class="line"><span class="cl">                <span class="n">exe</span><span class="p">,</span> <span class="n">newcmd</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">exec_newcmd</span><span class="p">(</span><span class="n">cmd</span><span class="p">,</span> <span class="n">env</span><span class="p">,</span> <span class="n">conf</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">                <span class="n">logg</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&#34;post-fail </span><span class="si">%s</span><span class="s2">&#34;</span><span class="p">,</span> <span class="n">shell_cmd</span><span class="p">(</span><span class="n">newcmd</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">                <span class="n">forkpid</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">fork</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">                <span class="k">if</span> <span class="ow">not</span> <span class="n">forkpid</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">                    <span class="bp">self</span><span class="o">.</span><span class="n">execve_from</span><span class="p">(</span><span class="n">conf</span><span class="p">,</span> <span class="n">newcmd</span><span class="p">,</span> <span class="n">env</span><span class="p">)</span> <span class="c1"># pragma: no cover</span>
</span></span><span class="line"><span class="cl">                <span class="n">run</span> <span class="o">=</span> <span class="n">subprocess_waitpid</span><span class="p">(</span><span class="n">forkpid</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">                <span class="n">logg</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&#34;post-fail done (</span><span class="si">%s</span><span class="s2">) &lt;-</span><span class="si">%s</span><span class="s2">&gt;&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                           <span class="n">run</span><span class="o">.</span><span class="n">returncode</span> <span class="ow">or</span> <span class="s2">&#34;OK&#34;</span><span class="p">,</span> <span class="n">run</span><span class="o">.</span><span class="n">signal</span> <span class="ow">or</span> <span class="s2">&#34;&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">            <span class="k">return</span> <span class="kc">False</span>
</span></span><span class="line"><span class="cl">        <span class="k">else</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">            <span class="k">for</span> <span class="n">cmd</span> <span class="ow">in</span> <span class="n">conf</span><span class="o">.</span><span class="n">getlist</span><span class="p">(</span><span class="n">Socket</span><span class="p">,</span> <span class="s2">&#34;ExecStartPost&#34;</span><span class="p">,</span> <span class="p">[]):</span>
</span></span><span class="line"><span class="cl">                <span class="n">exe</span><span class="p">,</span> <span class="n">newcmd</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">exec_newcmd</span><span class="p">(</span><span class="n">cmd</span><span class="p">,</span> <span class="n">env</span><span class="p">,</span> <span class="n">conf</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">                <span class="n">logg</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&#34;post-start </span><span class="si">%s</span><span class="s2">&#34;</span><span class="p">,</span> <span class="n">shell_cmd</span><span class="p">(</span><span class="n">newcmd</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">                <span class="n">forkpid</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">fork</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">                <span class="k">if</span> <span class="ow">not</span> <span class="n">forkpid</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">                    <span class="bp">self</span><span class="o">.</span><span class="n">execve_from</span><span class="p">(</span><span class="n">conf</span><span class="p">,</span> <span class="n">newcmd</span><span class="p">,</span> <span class="n">env</span><span class="p">)</span> <span class="c1"># pragma: no cover</span>
</span></span><span class="line"><span class="cl">                <span class="n">run</span> <span class="o">=</span> <span class="n">subprocess_waitpid</span><span class="p">(</span><span class="n">forkpid</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">                <span class="n">logg</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&#34;post-start done (</span><span class="si">%s</span><span class="s2">) &lt;-</span><span class="si">%s</span><span class="s2">&gt;&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                           <span class="n">run</span><span class="o">.</span><span class="n">returncode</span> <span class="ow">or</span> <span class="s2">&#34;OK&#34;</span><span class="p">,</span> <span class="n">run</span><span class="o">.</span><span class="n">signal</span> <span class="ow">or</span> <span class="s2">&#34;&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">            <span class="k">return</span> <span class="kc">True</span>
</span></span><span class="line"><span class="cl">    <span class="k">def</span> <span class="nf">create_socket</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">conf</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">        <span class="n">unsupported</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&#34;ListenUSBFunction&#34;</span><span class="p">,</span> <span class="s2">&#34;ListenMessageQueue&#34;</span><span class="p">,</span> <span class="s2">&#34;ListenNetlink&#34;</span><span class="p">]</span>
</span></span><span class="line"><span class="cl">        <span class="n">unsupported</span> <span class="o">+=</span> <span class="p">[</span><span class="s2">&#34;ListenSpecial&#34;</span><span class="p">,</span> <span class="s2">&#34;ListenFIFO&#34;</span><span class="p">,</span> <span class="s2">&#34;ListenSequentialPacket&#34;</span><span class="p">]</span>
</span></span><span class="line"><span class="cl">        <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">unsupported</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">            <span class="k">if</span> <span class="n">conf</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">Socket</span><span class="p">,</span> <span class="n">item</span><span class="p">,</span> <span class="s2">&#34;&#34;</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">                <span class="n">logg</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&#34;</span><span class="si">%s</span><span class="s2">: </span><span class="si">%s</span><span class="s2"> sockets are not implemented&#34;</span><span class="p">,</span> <span class="n">conf</span><span class="o">.</span><span class="n">name</span><span class="p">(),</span> <span class="n">item</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">                <span class="bp">self</span><span class="o">.</span><span class="n">error</span> <span class="o">|=</span> <span class="n">NOT_OK</span>
</span></span><span class="line"><span class="cl">                <span class="k">return</span> <span class="kc">None</span>
</span></span><span class="line"><span class="cl">        <span class="n">vListenDatagram</span> <span class="o">=</span> <span class="n">conf</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">Socket</span><span class="p">,</span> <span class="s2">&#34;ListenDatagram&#34;</span><span class="p">,</span> <span class="s2">&#34;&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="n">vListenStream</span> <span class="o">=</span> <span class="n">conf</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">Socket</span><span class="p">,</span> <span class="s2">&#34;ListenStream&#34;</span><span class="p">,</span> <span class="s2">&#34;&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="n">address</span> <span class="o">=</span> <span class="n">vListenStream</span> <span class="ow">or</span> <span class="n">vListenDatagram</span>
</span></span><span class="line"><span class="cl">        <span class="n">m</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="k">match</span><span class="p">(</span><span class="sa">r</span><span class="s2">&#34;(/.*)&#34;</span><span class="p">,</span> <span class="n">address</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="n">m</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">            <span class="n">path</span> <span class="o">=</span> <span class="n">m</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">            <span class="n">sock</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">create_unix_socket</span><span class="p">(</span><span class="n">conf</span><span class="p">,</span> <span class="n">path</span><span class="p">,</span> <span class="ow">not</span> <span class="n">vListenStream</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">            <span class="bp">self</span><span class="o">.</span><span class="n">set_status_from</span><span class="p">(</span><span class="n">conf</span><span class="p">,</span> <span class="s2">&#34;path&#34;</span><span class="p">,</span> <span class="n">path</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">            <span class="k">return</span> <span class="n">sock</span>
</span></span><span class="line"><span class="cl">        <span class="n">m</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="k">match</span><span class="p">(</span><span class="sa">r</span><span class="s2">&#34;(\d+[.]\d*[.]\d*[.]\d+):(\d+)&#34;</span><span class="p">,</span> <span class="n">address</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="n">m</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">            <span class="n">addr</span><span class="p">,</span> <span class="n">port</span> <span class="o">=</span> <span class="n">m</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">1</span><span class="p">),</span> <span class="n">m</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">            <span class="n">sock</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">create_port_ipv4_socket</span><span class="p">(</span><span class="n">conf</span><span class="p">,</span> <span class="n">addr</span><span class="p">,</span> <span class="n">port</span><span class="p">,</span> <span class="ow">not</span> <span class="n">vListenStream</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">            <span class="bp">self</span><span class="o">.</span><span class="n">set_status_from</span><span class="p">(</span><span class="n">conf</span><span class="p">,</span> <span class="s2">&#34;port&#34;</span><span class="p">,</span> <span class="n">port</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">            <span class="bp">self</span><span class="o">.</span><span class="n">set_status_from</span><span class="p">(</span><span class="n">conf</span><span class="p">,</span> <span class="s2">&#34;addr&#34;</span><span class="p">,</span> <span class="n">addr</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">            <span class="k">return</span> <span class="n">sock</span>
</span></span><span class="line"><span class="cl">        <span class="n">m</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="k">match</span><span class="p">(</span><span class="sa">r</span><span class="s2">&#34;\[([0-9a-fA-F:]*)\]:(\d+)&#34;</span><span class="p">,</span> <span class="n">address</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="n">m</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">            <span class="n">addr</span><span class="p">,</span> <span class="n">port</span> <span class="o">=</span> <span class="n">m</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">1</span><span class="p">),</span> <span class="n">m</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">            <span class="n">sock</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">create_port_ipv6_socket</span><span class="p">(</span><span class="n">conf</span><span class="p">,</span> <span class="n">addr</span><span class="p">,</span> <span class="n">port</span><span class="p">,</span> <span class="ow">not</span> <span class="n">vListenStream</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">            <span class="bp">self</span><span class="o">.</span><span class="n">set_status_from</span><span class="p">(</span><span class="n">conf</span><span class="p">,</span> <span class="s2">&#34;port&#34;</span><span class="p">,</span> <span class="n">port</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">            <span class="bp">self</span><span class="o">.</span><span class="n">set_status_from</span><span class="p">(</span><span class="n">conf</span><span class="p">,</span> <span class="s2">&#34;addr&#34;</span><span class="p">,</span> <span class="n">addr</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">            <span class="k">return</span> <span class="n">sock</span>
</span></span><span class="line"><span class="cl">        <span class="n">m</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="k">match</span><span class="p">(</span><span class="sa">r</span><span class="s2">&#34;(\d+)$&#34;</span><span class="p">,</span> <span class="n">address</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="n">m</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">            <span class="n">port</span> <span class="o">=</span> <span class="n">m</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">            <span class="n">sock</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">create_port_socket</span><span class="p">(</span><span class="n">conf</span><span class="p">,</span> <span class="n">port</span><span class="p">,</span> <span class="ow">not</span> <span class="n">vListenStream</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">            <span class="bp">self</span><span class="o">.</span><span class="n">set_status_from</span><span class="p">(</span><span class="n">conf</span><span class="p">,</span> <span class="s2">&#34;port&#34;</span><span class="p">,</span> <span class="n">port</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">            <span class="k">return</span> <span class="n">sock</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="n">re</span><span class="o">.</span><span class="k">match</span><span class="p">(</span><span class="s2">&#34;@.*&#34;</span><span class="p">,</span> <span class="n">address</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">            <span class="n">logg</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&#34;</span><span class="si">%s</span><span class="s2">: abstract namespace socket not implemented (</span><span class="si">%s</span><span class="s2">)&#34;</span><span class="p">,</span> <span class="n">conf</span><span class="o">.</span><span class="n">name</span><span class="p">(),</span> <span class="n">address</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">            <span class="k">return</span> <span class="kc">None</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="n">re</span><span class="o">.</span><span class="k">match</span><span class="p">(</span><span class="s2">&#34;vsock:.*&#34;</span><span class="p">,</span> <span class="n">address</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">            <span class="n">logg</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&#34;</span><span class="si">%s</span><span class="s2">: virtual machine socket not implemented (</span><span class="si">%s</span><span class="s2">)&#34;</span><span class="p">,</span> <span class="n">conf</span><span class="o">.</span><span class="n">name</span><span class="p">(),</span> <span class="n">address</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">            <span class="k">return</span> <span class="kc">None</span>
</span></span><span class="line"><span class="cl">        <span class="n">logg</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&#34;</span><span class="si">%s</span><span class="s2">: unknown socket address type (</span><span class="si">%s</span><span class="s2">)&#34;</span><span class="p">,</span> <span class="n">conf</span><span class="o">.</span><span class="n">name</span><span class="p">(),</span> <span class="n">address</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="kc">None</span>
</span></span><span class="line"><span class="cl">    <span class="k">def</span> <span class="nf">create_unix_socket</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">conf</span><span class="p">,</span> <span class="n">path</span><span class="p">,</span> <span class="n">dgram</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">        <span class="n">sock_stream</span> <span class="o">=</span> <span class="n">dgram</span> <span class="ow">and</span> <span class="n">socket</span><span class="o">.</span><span class="n">SOCK_DGRAM</span> <span class="ow">or</span> <span class="n">socket</span><span class="o">.</span><span class="n">SOCK_STREAM</span>
</span></span><span class="line"><span class="cl">        <span class="n">sock</span> <span class="o">=</span> <span class="n">socket</span><span class="o">.</span><span class="n">socket</span><span class="p">(</span><span class="n">socket</span><span class="o">.</span><span class="n">AF_UNIX</span><span class="p">,</span> <span class="n">sock_stream</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="k">try</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">            <span class="n">dirmode</span> <span class="o">=</span> <span class="n">conf</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">Socket</span><span class="p">,</span> <span class="s2">&#34;DirectoryMode&#34;</span><span class="p">,</span> <span class="s2">&#34;0755&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">            <span class="n">mode</span> <span class="o">=</span> <span class="n">conf</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">Socket</span><span class="p">,</span> <span class="s2">&#34;SocketMode&#34;</span><span class="p">,</span> <span class="s2">&#34;0666&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">            <span class="n">user</span> <span class="o">=</span> <span class="n">conf</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">Socket</span><span class="p">,</span> <span class="s2">&#34;SocketUser&#34;</span><span class="p">,</span> <span class="s2">&#34;&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">            <span class="n">group</span> <span class="o">=</span> <span class="n">conf</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">Socket</span><span class="p">,</span> <span class="s2">&#34;SocketGroup&#34;</span><span class="p">,</span> <span class="s2">&#34;&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">            <span class="n">symlinks</span> <span class="o">=</span> <span class="n">conf</span><span class="o">.</span><span class="n">getlist</span><span class="p">(</span><span class="n">Socket</span><span class="p">,</span> <span class="s2">&#34;SymLinks&#34;</span><span class="p">,</span> <span class="p">[])</span>
</span></span><span class="line"><span class="cl">            <span class="n">dirpath</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="n">path</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">            <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isdir</span><span class="p">(</span><span class="n">dirpath</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">                <span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="n">dirpath</span><span class="p">,</span> <span class="nb">int</span><span class="p">(</span><span class="n">dirmode</span><span class="p">,</span> <span class="mi">8</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">            <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">path</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">                <span class="n">os</span><span class="o">.</span><span class="n">unlink</span><span class="p">(</span><span class="n">path</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">            <span class="n">sock</span><span class="o">.</span><span class="n">bind</span><span class="p">(</span><span class="n">path</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">            <span class="n">os</span><span class="o">.</span><span class="n">fchmod</span><span class="p">(</span><span class="n">sock</span><span class="o">.</span><span class="n">fileno</span><span class="p">(),</span> <span class="nb">int</span><span class="p">(</span><span class="n">mode</span><span class="p">,</span> <span class="mi">8</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">            <span class="n">shutil_fchown</span><span class="p">(</span><span class="n">sock</span><span class="o">.</span><span class="n">fileno</span><span class="p">(),</span> <span class="n">user</span><span class="p">,</span> <span class="n">group</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">            <span class="k">if</span> <span class="n">symlinks</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">                <span class="n">logg</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&#34;</span><span class="si">%s</span><span class="s2">: symlinks for socket not implemented (</span><span class="si">%s</span><span class="s2">)&#34;</span><span class="p">,</span> <span class="n">conf</span><span class="o">.</span><span class="n">name</span><span class="p">(),</span> <span class="n">path</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">            <span class="n">logg</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&#34;</span><span class="si">%s</span><span class="s2">: create socket failed [</span><span class="si">%s</span><span class="s2">]: </span><span class="si">%s</span><span class="s2">&#34;</span><span class="p">,</span> <span class="n">conf</span><span class="o">.</span><span class="n">name</span><span class="p">(),</span> <span class="n">path</span><span class="p">,</span> <span class="n">e</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">            <span class="n">sock</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">            <span class="k">return</span> <span class="kc">None</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="n">sock</span>
</span></span><span class="line"><span class="cl">    <span class="k">def</span> <span class="nf">create_port_socket</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">conf</span><span class="p">,</span> <span class="n">port</span><span class="p">,</span> <span class="n">dgram</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">        <span class="n">inet</span> <span class="o">=</span> <span class="n">dgram</span> <span class="ow">and</span> <span class="n">socket</span><span class="o">.</span><span class="n">SOCK_DGRAM</span> <span class="ow">or</span> <span class="n">socket</span><span class="o">.</span><span class="n">SOCK_STREAM</span>
</span></span><span class="line"><span class="cl">        <span class="n">sock</span> <span class="o">=</span> <span class="n">socket</span><span class="o">.</span><span class="n">socket</span><span class="p">(</span><span class="n">socket</span><span class="o">.</span><span class="n">AF_INET</span><span class="p">,</span> <span class="n">inet</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="k">try</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">            <span class="n">sock</span><span class="o">.</span><span class="n">bind</span><span class="p">((</span><span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="nb">int</span><span class="p">(</span><span class="n">port</span><span class="p">)))</span>
</span></span><span class="line"><span class="cl">            <span class="n">logg</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&#34;</span><span class="si">%s</span><span class="s2">: bound socket at </span><span class="si">%s</span><span class="s2"> </span><span class="si">%s</span><span class="s2">:</span><span class="si">%s</span><span class="s2">&#34;</span><span class="p">,</span> <span class="n">conf</span><span class="o">.</span><span class="n">name</span><span class="p">(),</span> <span class="n">strINET</span><span class="p">(</span><span class="n">inet</span><span class="p">),</span> <span class="s2">&#34;*&#34;</span><span class="p">,</span> <span class="n">port</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">            <span class="n">logg</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&#34;</span><span class="si">%s</span><span class="s2">: create socket failed (</span><span class="si">%s</span><span class="s2">:</span><span class="si">%s</span><span class="s2">): </span><span class="si">%s</span><span class="s2">&#34;</span><span class="p">,</span> <span class="n">conf</span><span class="o">.</span><span class="n">name</span><span class="p">(),</span> <span class="s2">&#34;*&#34;</span><span class="p">,</span> <span class="n">port</span><span class="p">,</span> <span class="n">e</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">            <span class="n">sock</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">            <span class="k">return</span> <span class="kc">None</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="n">sock</span>
</span></span><span class="line"><span class="cl">    <span class="k">def</span> <span class="nf">create_port_ipv4_socket</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">conf</span><span class="p">,</span> <span class="n">addr</span><span class="p">,</span> <span class="n">port</span><span class="p">,</span> <span class="n">dgram</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">        <span class="n">inet</span> <span class="o">=</span> <span class="n">dgram</span> <span class="ow">and</span> <span class="n">socket</span><span class="o">.</span><span class="n">SOCK_DGRAM</span> <span class="ow">or</span> <span class="n">socket</span><span class="o">.</span><span class="n">SOCK_STREAM</span>
</span></span><span class="line"><span class="cl">        <span class="n">sock</span> <span class="o">=</span> <span class="n">socket</span><span class="o">.</span><span class="n">socket</span><span class="p">(</span><span class="n">socket</span><span class="o">.</span><span class="n">AF_INET</span><span class="p">,</span> <span class="n">inet</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="k">try</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">            <span class="n">sock</span><span class="o">.</span><span class="n">bind</span><span class="p">((</span><span class="n">addr</span><span class="p">,</span> <span class="nb">int</span><span class="p">(</span><span class="n">port</span><span class="p">)))</span>
</span></span><span class="line"><span class="cl">            <span class="n">logg</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&#34;</span><span class="si">%s</span><span class="s2">: bound socket at </span><span class="si">%s</span><span class="s2"> </span><span class="si">%s</span><span class="s2">:</span><span class="si">%s</span><span class="s2">&#34;</span><span class="p">,</span> <span class="n">conf</span><span class="o">.</span><span class="n">name</span><span class="p">(),</span> <span class="n">strINET</span><span class="p">(</span><span class="n">inet</span><span class="p">),</span> <span class="n">addr</span><span class="p">,</span> <span class="n">port</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">            <span class="n">logg</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&#34;</span><span class="si">%s</span><span class="s2">: create socket failed (</span><span class="si">%s</span><span class="s2">:</span><span class="si">%s</span><span class="s2">): </span><span class="si">%s</span><span class="s2">&#34;</span><span class="p">,</span> <span class="n">conf</span><span class="o">.</span><span class="n">name</span><span class="p">(),</span> <span class="n">addr</span><span class="p">,</span> <span class="n">port</span><span class="p">,</span> <span class="n">e</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">            <span class="n">sock</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">            <span class="k">return</span> <span class="kc">None</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="n">sock</span>
</span></span><span class="line"><span class="cl">    <span class="k">def</span> <span class="nf">create_port_ipv6_socket</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">conf</span><span class="p">,</span> <span class="n">addr</span><span class="p">,</span> <span class="n">port</span><span class="p">,</span> <span class="n">dgram</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">        <span class="n">inet</span> <span class="o">=</span> <span class="n">dgram</span> <span class="ow">and</span> <span class="n">socket</span><span class="o">.</span><span class="n">SOCK_DGRAM</span> <span class="ow">or</span> <span class="n">socket</span><span class="o">.</span><span class="n">SOCK_STREAM</span>
</span></span><span class="line"><span class="cl">        <span class="n">sock</span> <span class="o">=</span> <span class="n">socket</span><span class="o">.</span><span class="n">socket</span><span class="p">(</span><span class="n">socket</span><span class="o">.</span><span class="n">AF_INET6</span><span class="p">,</span> <span class="n">inet</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="k">try</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">            <span class="n">sock</span><span class="o">.</span><span class="n">bind</span><span class="p">((</span><span class="n">addr</span><span class="p">,</span> <span class="nb">int</span><span class="p">(</span><span class="n">port</span><span class="p">)))</span>
</span></span><span class="line"><span class="cl">            <span class="n">logg</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&#34;</span><span class="si">%s</span><span class="s2">: bound socket at </span><span class="si">%s</span><span class="s2"> [</span><span class="si">%s</span><span class="s2">]:</span><span class="si">%s</span><span class="s2">&#34;</span><span class="p">,</span> <span class="n">conf</span><span class="o">.</span><span class="n">name</span><span class="p">(),</span> <span class="n">strINET</span><span class="p">(</span><span class="n">inet</span><span class="p">),</span> <span class="n">addr</span><span class="p">,</span> <span class="n">port</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">            <span class="n">logg</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&#34;</span><span class="si">%s</span><span class="s2">: create socket failed ([</span><span class="si">%s</span><span class="s2">]:</span><span class="si">%s</span><span class="s2">): </span><span class="si">%s</span><span class="s2">&#34;</span><span class="p">,</span> <span class="n">conf</span><span class="o">.</span><span class="n">name</span><span class="p">(),</span> <span class="n">addr</span><span class="p">,</span> <span class="n">port</span><span class="p">,</span> <span class="n">e</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">            <span class="n">sock</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">            <span class="k">return</span> <span class="kc">None</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="n">sock</span>
</span></span><span class="line"><span class="cl">    <span class="k">def</span> <span class="nf">extend_exec_env</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">env</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">        <span class="n">env</span> <span class="o">=</span> <span class="n">env</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">        <span class="c1"># implant DefaultPath into $PATH</span>
</span></span><span class="line"><span class="cl">        <span class="n">path</span> <span class="o">=</span> <span class="n">env</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&#34;PATH&#34;</span><span class="p">,</span> <span class="n">DefaultPath</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="n">parts</span> <span class="o">=</span> <span class="n">path</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">pathsep</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="k">for</span> <span class="n">part</span> <span class="ow">in</span> <span class="n">DefaultPath</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">pathsep</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">            <span class="k">if</span> <span class="n">part</span> <span class="ow">and</span> <span class="n">part</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">parts</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">                <span class="n">parts</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">part</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="n">env</span><span class="p">[</span><span class="s2">&#34;PATH&#34;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">pathsep</span><span class="p">)</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">parts</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="c1"># reset locale to system default</span>
</span></span><span class="line"><span class="cl">        <span class="k">for</span> <span class="n">name</span> <span class="ow">in</span> <span class="n">ResetLocale</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">            <span class="k">if</span> <span class="n">name</span> <span class="ow">in</span> <span class="n">env</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">                <span class="k">del</span> <span class="n">env</span><span class="p">[</span><span class="n">name</span><span class="p">]</span>
</span></span><span class="line"><span class="cl">        <span class="n">locale</span> <span class="o">=</span> <span class="p">{}</span>
</span></span><span class="line"><span class="cl">        <span class="n">path</span> <span class="o">=</span> <span class="n">env</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&#34;LOCALE_CONF&#34;</span><span class="p">,</span> <span class="n">LocaleConf</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="n">parts</span> <span class="o">=</span> <span class="n">path</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">pathsep</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="k">for</span> <span class="n">part</span> <span class="ow">in</span> <span class="n">parts</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">            <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isfile</span><span class="p">(</span><span class="n">part</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">                <span class="k">for</span> <span class="n">var</span><span class="p">,</span> <span class="n">val</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">read_env_file</span><span class="p">(</span><span class="s2">&#34;-&#34;</span><span class="o">+</span><span class="n">part</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">                    <span class="n">locale</span><span class="p">[</span><span class="n">var</span><span class="p">]</span> <span class="o">=</span> <span class="n">val</span>
</span></span><span class="line"><span class="cl">                    <span class="n">env</span><span class="p">[</span><span class="n">var</span><span class="p">]</span> <span class="o">=</span> <span class="n">val</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="s2">&#34;LANG&#34;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">locale</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">            <span class="n">env</span><span class="p">[</span><span class="s2">&#34;LANG&#34;</span><span class="p">]</span> <span class="o">=</span> <span class="n">locale</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&#34;LANGUAGE&#34;</span><span class="p">,</span> <span class="n">locale</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&#34;LC_CTYPE&#34;</span><span class="p">,</span> <span class="s2">&#34;C&#34;</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="n">env</span>
</span></span><span class="line"><span class="cl">    <span class="k">def</span> <span class="nf">expand_list</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">group_lines</span><span class="p">,</span> <span class="n">conf</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">        <span class="n">result</span> <span class="o">=</span> <span class="p">[]</span>
</span></span><span class="line"><span class="cl">        <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">group_lines</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">            <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">line</span><span class="o">.</span><span class="n">split</span><span class="p">():</span>
</span></span><span class="line"><span class="cl">                <span class="k">if</span> <span class="n">item</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">                    <span class="n">result</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">expand_special</span><span class="p">(</span><span class="n">item</span><span class="p">,</span> <span class="n">conf</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="n">result</span>
</span></span><span class="line"><span class="cl">    <span class="k">def</span> <span class="nf">get_User</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">conf</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">expand_special</span><span class="p">(</span><span class="n">conf</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">Service</span><span class="p">,</span> <span class="s2">&#34;User&#34;</span><span class="p">,</span> <span class="s2">&#34;&#34;</span><span class="p">),</span> <span class="n">conf</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="k">def</span> <span class="nf">get_Group</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">conf</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">expand_special</span><span class="p">(</span><span class="n">conf</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">Service</span><span class="p">,</span> <span class="s2">&#34;Group&#34;</span><span class="p">,</span> <span class="s2">&#34;&#34;</span><span class="p">),</span> <span class="n">conf</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="k">def</span> <span class="nf">get_SupplementaryGroups</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">conf</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">expand_list</span><span class="p">(</span><span class="n">conf</span><span class="o">.</span><span class="n">getlist</span><span class="p">(</span><span class="n">Service</span><span class="p">,</span> <span class="s2">&#34;SupplementaryGroups&#34;</span><span class="p">,</span> <span class="p">[]),</span> <span class="n">conf</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="k">def</span> <span class="nf">skip_journal_log</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">conf</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_unit_type</span><span class="p">(</span><span class="n">conf</span><span class="o">.</span><span class="n">name</span><span class="p">())</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&#34;service&#34;</span><span class="p">]:</span>
</span></span><span class="line"><span class="cl">            <span class="k">return</span> <span class="kc">True</span>
</span></span><span class="line"><span class="cl">        <span class="n">std_out</span> <span class="o">=</span> <span class="n">conf</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">Service</span><span class="p">,</span> <span class="s2">&#34;StandardOutput&#34;</span><span class="p">,</span> <span class="n">DefaultStandardOutput</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="n">std_err</span> <span class="o">=</span> <span class="n">conf</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">Service</span><span class="p">,</span> <span class="s2">&#34;StandardError&#34;</span><span class="p">,</span> <span class="n">DefaultStandardError</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="n">out</span><span class="p">,</span> <span class="n">err</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span> <span class="kc">False</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="n">std_out</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&#34;null&#34;</span><span class="p">]:</span> <span class="n">out</span> <span class="o">=</span> <span class="kc">True</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="n">std_out</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s2">&#34;file:&#34;</span><span class="p">):</span> <span class="n">out</span> <span class="o">=</span> <span class="kc">True</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="n">std_err</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&#34;inherit&#34;</span><span class="p">]:</span> <span class="n">std_err</span> <span class="o">=</span> <span class="n">std_out</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="n">std_err</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&#34;null&#34;</span><span class="p">]:</span> <span class="n">err</span> <span class="o">=</span> <span class="kc">True</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="n">std_err</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s2">&#34;file:&#34;</span><span class="p">):</span> <span class="n">err</span> <span class="o">=</span> <span class="kc">True</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="n">std_err</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s2">&#34;append:&#34;</span><span class="p">):</span> <span class="n">err</span> <span class="o">=</span> <span class="kc">True</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="n">out</span> <span class="ow">and</span> <span class="n">err</span>
</span></span><span class="line"><span class="cl">    <span class="k">def</span> <span class="nf">dup2_journal_log</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">conf</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">        <span class="n">msg</span> <span class="o">=</span> <span class="s2">&#34;&#34;</span>
</span></span><span class="line"><span class="cl">        <span class="n">std_inp</span> <span class="o">=</span> <span class="n">conf</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">Service</span><span class="p">,</span> <span class="s2">&#34;StandardInput&#34;</span><span class="p">,</span> <span class="n">DefaultStandardInput</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="n">std_out</span> <span class="o">=</span> <span class="n">conf</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">Service</span><span class="p">,</span> <span class="s2">&#34;StandardOutput&#34;</span><span class="p">,</span> <span class="n">DefaultStandardOutput</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="n">std_err</span> <span class="o">=</span> <span class="n">conf</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">Service</span><span class="p">,</span> <span class="s2">&#34;StandardError&#34;</span><span class="p">,</span> <span class="n">DefaultStandardError</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="n">inp</span><span class="p">,</span> <span class="n">out</span><span class="p">,</span> <span class="n">err</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="n">std_inp</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&#34;null&#34;</span><span class="p">]:</span>
</span></span><span class="line"><span class="cl">            <span class="n">inp</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="n">_dev_null</span><span class="p">,</span> <span class="s2">&#34;r&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="k">elif</span> <span class="n">std_inp</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s2">&#34;file:&#34;</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">            <span class="n">fname</span> <span class="o">=</span> <span class="n">std_inp</span><span class="p">[</span><span class="nb">len</span><span class="p">(</span><span class="s2">&#34;file:&#34;</span><span class="p">):]</span>
</span></span><span class="line"><span class="cl">            <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">fname</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">                <span class="n">inp</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="n">fname</span><span class="p">,</span> <span class="s2">&#34;r&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">            <span class="k">else</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">                <span class="n">inp</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="n">_dev_zero</span><span class="p">,</span> <span class="s2">&#34;r&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="k">else</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">            <span class="n">inp</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="n">_dev_zero</span><span class="p">,</span> <span class="s2">&#34;r&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="k">assert</span> <span class="n">inp</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>
</span></span><span class="line"><span class="cl">        <span class="k">try</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">            <span class="k">if</span> <span class="n">std_out</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&#34;null&#34;</span><span class="p">]:</span>
</span></span><span class="line"><span class="cl">                <span class="n">out</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="n">_dev_null</span><span class="p">,</span> <span class="s2">&#34;w&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">            <span class="k">elif</span> <span class="n">std_out</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s2">&#34;file:&#34;</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">                <span class="n">fname</span> <span class="o">=</span> <span class="n">std_out</span><span class="p">[</span><span class="nb">len</span><span class="p">(</span><span class="s2">&#34;file:&#34;</span><span class="p">):]</span>
</span></span><span class="line"><span class="cl">                <span class="n">fdir</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="n">fname</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">                <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">fdir</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">                    <span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="n">fdir</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">                <span class="n">out</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="n">fname</span><span class="p">,</span> <span class="s2">&#34;w&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">            <span class="k">elif</span> <span class="n">std_out</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s2">&#34;append:&#34;</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">                <span class="n">fname</span> <span class="o">=</span> <span class="n">std_out</span><span class="p">[</span><span class="nb">len</span><span class="p">(</span><span class="s2">&#34;append:&#34;</span><span class="p">):]</span>
</span></span><span class="line"><span class="cl">                <span class="n">fdir</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="n">fname</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">                <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">fdir</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">                    <span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="n">fdir</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">                <span class="n">out</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="n">fname</span><span class="p">,</span> <span class="s2">&#34;a&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">            <span class="n">msg</span> <span class="o">+=</span> <span class="s2">&#34;</span><span class="se">\n</span><span class="si">%s</span><span class="s2">: </span><span class="si">%s</span><span class="s2">&#34;</span> <span class="o">%</span> <span class="p">(</span><span class="n">fname</span><span class="p">,</span> <span class="n">e</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="n">out</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">            <span class="n">out</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">open_journal_log</span><span class="p">(</span><span class="n">conf</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">            <span class="n">err</span> <span class="o">=</span> <span class="n">out</span>
</span></span><span class="line"><span class="cl">        <span class="k">assert</span> <span class="n">out</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>
</span></span><span class="line"><span class="cl">        <span class="k">try</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">            <span class="k">if</span> <span class="n">std_err</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&#34;inherit&#34;</span><span class="p">]:</span>
</span></span><span class="line"><span class="cl">                <span class="n">err</span> <span class="o">=</span> <span class="n">out</span>
</span></span><span class="line"><span class="cl">            <span class="k">elif</span> <span class="n">std_err</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&#34;null&#34;</span><span class="p">]:</span>
</span></span><span class="line"><span class="cl">                <span class="n">err</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="n">_dev_null</span><span class="p">,</span> <span class="s2">&#34;w&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">            <span class="k">elif</span> <span class="n">std_err</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s2">&#34;file:&#34;</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">                <span class="n">fname</span> <span class="o">=</span> <span class="n">std_err</span><span class="p">[</span><span class="nb">len</span><span class="p">(</span><span class="s2">&#34;file:&#34;</span><span class="p">):]</span>
</span></span><span class="line"><span class="cl">                <span class="n">fdir</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="n">fname</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">                <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">fdir</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">                    <span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="n">fdir</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">                <span class="n">err</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="n">fname</span><span class="p">,</span> <span class="s2">&#34;w&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">            <span class="k">elif</span> <span class="n">std_err</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s2">&#34;append:&#34;</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">                <span class="n">fname</span> <span class="o">=</span> <span class="n">std_err</span><span class="p">[</span><span class="nb">len</span><span class="p">(</span><span class="s2">&#34;append:&#34;</span><span class="p">):]</span>
</span></span><span class="line"><span class="cl">                <span class="n">fdir</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="n">fname</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">                <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">fdir</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">                    <span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="n">fdir</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">                <span class="n">err</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="n">fname</span><span class="p">,</span> <span class="s2">&#34;a&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">            <span class="n">msg</span> <span class="o">+=</span> <span class="s2">&#34;</span><span class="se">\n</span><span class="si">%s</span><span class="s2">: </span><span class="si">%s</span><span class="s2">&#34;</span> <span class="o">%</span> <span class="p">(</span><span class="n">fname</span><span class="p">,</span> <span class="n">e</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="n">err</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">            <span class="n">err</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">open_journal_log</span><span class="p">(</span><span class="n">conf</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="k">assert</span> <span class="n">err</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="n">msg</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">            <span class="n">err</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&#34;ERROR:&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">            <span class="n">err</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">msg</span><span class="o">.</span><span class="n">strip</span><span class="p">())</span>
</span></span><span class="line"><span class="cl">            <span class="n">err</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&#34;</span><span class="se">\n</span><span class="s2">&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="n">EXEC_DUP2</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">            <span class="n">os</span><span class="o">.</span><span class="n">dup2</span><span class="p">(</span><span class="n">inp</span><span class="o">.</span><span class="n">fileno</span><span class="p">(),</span> <span class="n">sys</span><span class="o">.</span><span class="n">stdin</span><span class="o">.</span><span class="n">fileno</span><span class="p">())</span>
</span></span><span class="line"><span class="cl">            <span class="n">os</span><span class="o">.</span><span class="n">dup2</span><span class="p">(</span><span class="n">out</span><span class="o">.</span><span class="n">fileno</span><span class="p">(),</span> <span class="n">sys</span><span class="o">.</span><span class="n">stdout</span><span class="o">.</span><span class="n">fileno</span><span class="p">())</span>
</span></span><span class="line"><span class="cl">            <span class="n">os</span><span class="o">.</span><span class="n">dup2</span><span class="p">(</span><span class="n">err</span><span class="o">.</span><span class="n">fileno</span><span class="p">(),</span> <span class="n">sys</span><span class="o">.</span><span class="n">stderr</span><span class="o">.</span><span class="n">fileno</span><span class="p">())</span>
</span></span><span class="line"><span class="cl">    <span class="k">def</span> <span class="nf">execve_from</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">conf</span><span class="p">,</span> <span class="n">cmd</span><span class="p">,</span> <span class="n">env</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">        <span class="s2">&#34;&#34;&#34; this code is commonly run in a child process // returns exit-code&#34;&#34;&#34;</span>
</span></span><span class="line"><span class="cl">        <span class="c1"># |</span>
</span></span><span class="line"><span class="cl">        <span class="n">runs</span> <span class="o">=</span> <span class="n">conf</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">Service</span><span class="p">,</span> <span class="s2">&#34;Type&#34;</span><span class="p">,</span> <span class="s2">&#34;simple&#34;</span><span class="p">)</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">        <span class="c1"># logg.debug(&#34;%s process for %s =&gt; %s&#34;, runs, strE(conf.name()), strQ(conf.filename()))</span>
</span></span><span class="line"><span class="cl">        <span class="bp">self</span><span class="o">.</span><span class="n">dup2_journal_log</span><span class="p">(</span><span class="n">conf</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="n">cmd_args</span> <span class="o">=</span> <span class="p">[]</span>
</span></span><span class="line"><span class="cl">        <span class="c1">#</span>
</span></span><span class="line"><span class="cl">        <span class="n">runuser</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_User</span><span class="p">(</span><span class="n">conf</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="n">rungroup</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_Group</span><span class="p">(</span><span class="n">conf</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="n">xgroups</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_SupplementaryGroups</span><span class="p">(</span><span class="n">conf</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="n">envs</span> <span class="o">=</span> <span class="n">shutil_setuid</span><span class="p">(</span><span class="n">runuser</span><span class="p">,</span> <span class="n">rungroup</span><span class="p">,</span> <span class="n">xgroups</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="n">badpath</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">chdir_workingdir</span><span class="p">(</span><span class="n">conf</span><span class="p">)</span> <span class="c1"># some dirs need setuid before</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="n">badpath</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">            <span class="n">logg</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&#34;(</span><span class="si">%s</span><span class="s2">): bad workingdir: &#39;</span><span class="si">%s</span><span class="s2">&#39;&#34;</span><span class="p">,</span> <span class="n">shell_cmd</span><span class="p">(</span><span class="n">cmd</span><span class="p">),</span> <span class="n">badpath</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">            <span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="n">env</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">extend_exec_env</span><span class="p">(</span><span class="n">env</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="n">env</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">envs</span><span class="p">)</span> <span class="c1"># set $HOME to ~$USER</span>
</span></span><span class="line"><span class="cl">        <span class="k">try</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">            <span class="k">if</span> <span class="n">EXEC_SPAWN</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">                <span class="n">cmd_args</span> <span class="o">=</span> <span class="p">[</span><span class="n">arg</span> <span class="k">for</span> <span class="n">arg</span> <span class="ow">in</span> <span class="n">cmd</span><span class="p">]</span> <span class="c1"># satisfy mypy</span>
</span></span><span class="line"><span class="cl">                <span class="n">exitcode</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">spawnvpe</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">P_WAIT</span><span class="p">,</span> <span class="n">cmd</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">cmd_args</span><span class="p">,</span> <span class="n">env</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">                <span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">(</span><span class="n">exitcode</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">            <span class="k">else</span><span class="p">:</span> <span class="c1"># pragma: no cover</span>
</span></span><span class="line"><span class="cl">                <span class="n">os</span><span class="o">.</span><span class="n">execve</span><span class="p">(</span><span class="n">cmd</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">cmd</span><span class="p">,</span> <span class="n">env</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">                <span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">(</span><span class="mi">11</span><span class="p">)</span> <span class="c1"># pragma: no cover (can not be reached / bug like mypy#8401)</span>
</span></span><span class="line"><span class="cl">        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">            <span class="n">logg</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&#34;(</span><span class="si">%s</span><span class="s2">): </span><span class="si">%s</span><span class="s2">&#34;</span><span class="p">,</span> <span class="n">shell_cmd</span><span class="p">(</span><span class="n">cmd</span><span class="p">),</span> <span class="n">e</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">            <span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="k">def</span> <span class="nf">test_start_unit</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">unit</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">        <span class="s2">&#34;&#34;&#34; helper function to test the code that is normally forked off &#34;&#34;&#34;</span>
</span></span><span class="line"><span class="cl">        <span class="n">conf</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">load_unit_conf</span><span class="p">(</span><span class="n">unit</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="ow">not</span> <span class="n">conf</span><span class="p">:</span> <span class="k">return</span> <span class="kc">None</span>
</span></span><span class="line"><span class="cl">        <span class="n">env</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_env</span><span class="p">(</span><span class="n">conf</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="k">for</span> <span class="n">cmd</span> <span class="ow">in</span> <span class="n">conf</span><span class="o">.</span><span class="n">getlist</span><span class="p">(</span><span class="n">Service</span><span class="p">,</span> <span class="s2">&#34;ExecStart&#34;</span><span class="p">,</span> <span class="p">[]):</span>
</span></span><span class="line"><span class="cl">            <span class="n">exe</span><span class="p">,</span> <span class="n">newcmd</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">exec_newcmd</span><span class="p">(</span><span class="n">cmd</span><span class="p">,</span> <span class="n">env</span><span class="p">,</span> <span class="n">conf</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">            <span class="bp">self</span><span class="o">.</span><span class="n">execve_from</span><span class="p">(</span><span class="n">conf</span><span class="p">,</span> <span class="n">newcmd</span><span class="p">,</span> <span class="n">env</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="kc">None</span>
</span></span><span class="line"><span class="cl">    <span class="k">def</span> <span class="nf">stop_modules</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">modules</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">        <span class="s2">&#34;&#34;&#34; [UNIT]... -- stop these units &#34;&#34;&#34;</span>
</span></span><span class="line"><span class="cl">        <span class="n">found_all</span> <span class="o">=</span> <span class="kc">True</span>
</span></span><span class="line"><span class="cl">        <span class="n">units</span> <span class="o">=</span> <span class="p">[]</span>
</span></span><span class="line"><span class="cl">        <span class="k">for</span> <span class="n">module</span> <span class="ow">in</span> <span class="n">modules</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">            <span class="n">matched</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">match_units</span><span class="p">(</span><span class="n">to_list</span><span class="p">(</span><span class="n">module</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">            <span class="k">if</span> <span class="ow">not</span> <span class="n">matched</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">                <span class="n">logg</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&#34;Unit </span><span class="si">%s</span><span class="s2"> not found.&#34;</span><span class="p">,</span> <span class="n">unit_of</span><span class="p">(</span><span class="n">module</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">                <span class="bp">self</span><span class="o">.</span><span class="n">error</span> <span class="o">|=</span> <span class="n">NOT_FOUND</span>
</span></span><span class="line"><span class="cl">                <span class="n">found_all</span> <span class="o">=</span> <span class="kc">False</span>
</span></span><span class="line"><span class="cl">                <span class="k">continue</span>
</span></span><span class="line"><span class="cl">            <span class="k">for</span> <span class="n">unit</span> <span class="ow">in</span> <span class="n">matched</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">                <span class="k">if</span> <span class="n">unit</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">units</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">                    <span class="n">units</span> <span class="o">+=</span> <span class="p">[</span><span class="n">unit</span><span class="p">]</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">stop_units</span><span class="p">(</span><span class="n">units</span><span class="p">)</span> <span class="ow">and</span> <span class="n">found_all</span>
</span></span><span class="line"><span class="cl">    <span class="k">def</span> <span class="nf">stop_units</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">units</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">        <span class="s2">&#34;&#34;&#34; fails if any unit fails to stop &#34;&#34;&#34;</span>
</span></span><span class="line"><span class="cl">        <span class="bp">self</span><span class="o">.</span><span class="n">wait_system</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">        <span class="n">done</span> <span class="o">=</span> <span class="kc">True</span>
</span></span><span class="line"><span class="cl">        <span class="k">for</span> <span class="n">unit</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">sortedBefore</span><span class="p">(</span><span class="n">units</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">            <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">stop_unit</span><span class="p">(</span><span class="n">unit</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">                <span class="n">done</span> <span class="o">=</span> <span class="kc">False</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="n">done</span>
</span></span><span class="line"><span class="cl">    <span class="k">def</span> <span class="nf">stop_unit</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">unit</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">        <span class="n">conf</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">load_unit_conf</span><span class="p">(</span><span class="n">unit</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="n">conf</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">            <span class="n">logg</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&#34;Unit </span><span class="si">%s</span><span class="s2"> not found.&#34;</span><span class="p">,</span> <span class="n">unit</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">            <span class="k">return</span> <span class="kc">False</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">not_user_conf</span><span class="p">(</span><span class="n">conf</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">            <span class="n">logg</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&#34;Unit </span><span class="si">%s</span><span class="s2"> not for --user mode&#34;</span><span class="p">,</span> <span class="n">unit</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">            <span class="k">return</span> <span class="kc">False</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">stop_unit_from</span><span class="p">(</span><span class="n">conf</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">def</span> <span class="nf">get_TimeoutStopSec</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">conf</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">        <span class="n">timeout</span> <span class="o">=</span> <span class="n">conf</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">Service</span><span class="p">,</span> <span class="s2">&#34;TimeoutSec&#34;</span><span class="p">,</span> <span class="n">strE</span><span class="p">(</span><span class="n">DefaultTimeoutStartSec</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">        <span class="n">timeout</span> <span class="o">=</span> <span class="n">conf</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">Service</span><span class="p">,</span> <span class="s2">&#34;TimeoutStopSec&#34;</span><span class="p">,</span> <span class="n">timeout</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="n">time_to_seconds</span><span class="p">(</span><span class="n">timeout</span><span class="p">,</span> <span class="n">DefaultMaximumTimeout</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="k">def</span> <span class="nf">stop_unit_from</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">conf</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="ow">not</span> <span class="n">conf</span><span class="p">:</span> <span class="k">return</span> <span class="kc">False</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">syntax_check</span><span class="p">(</span><span class="n">conf</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">100</span><span class="p">:</span> <span class="k">return</span> <span class="kc">False</span>
</span></span><span class="line"><span class="cl">        <span class="k">with</span> <span class="n">waitlock</span><span class="p">(</span><span class="n">conf</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">            <span class="n">logg</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&#34; stop unit </span><span class="si">%s</span><span class="s2"> =&gt; </span><span class="si">%s</span><span class="s2">&#34;</span><span class="p">,</span> <span class="n">conf</span><span class="o">.</span><span class="n">name</span><span class="p">(),</span> <span class="n">strQ</span><span class="p">(</span><span class="n">conf</span><span class="o">.</span><span class="n">filename</span><span class="p">()))</span>
</span></span><span class="line"><span class="cl">            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">do_stop_unit_from</span><span class="p">(</span><span class="n">conf</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="k">def</span> <span class="nf">do_stop_unit_from</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">conf</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="n">conf</span><span class="o">.</span><span class="n">name</span><span class="p">()</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s2">&#34;.service&#34;</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">do_stop_service_from</span><span class="p">(</span><span class="n">conf</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="k">elif</span> <span class="n">conf</span><span class="o">.</span><span class="n">name</span><span class="p">()</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s2">&#34;.socket&#34;</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">do_stop_socket_from</span><span class="p">(</span><span class="n">conf</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="k">elif</span> <span class="n">conf</span><span class="o">.</span><span class="n">name</span><span class="p">()</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s2">&#34;.target&#34;</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">do_stop_target_from</span><span class="p">(</span><span class="n">conf</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="k">else</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">            <span class="n">logg</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&#34;stop not implemented for unit type: </span><span class="si">%s</span><span class="s2">&#34;</span><span class="p">,</span> <span class="n">conf</span><span class="o">.</span><span class="n">name</span><span class="p">())</span>
</span></span><span class="line"><span class="cl">            <span class="k">return</span> <span class="kc">False</span>
</span></span><span class="line"><span class="cl">    <span class="k">def</span> <span class="nf">do_stop_service_from</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">conf</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">        <span class="c1"># |</span>
</span></span><span class="line"><span class="cl">        <span class="n">timeout</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_TimeoutStopSec</span><span class="p">(</span><span class="n">conf</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="n">runs</span> <span class="o">=</span> <span class="n">conf</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">Service</span><span class="p">,</span> <span class="s2">&#34;Type&#34;</span><span class="p">,</span> <span class="s2">&#34;simple&#34;</span><span class="p">)</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">        <span class="n">env</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_env</span><span class="p">(</span><span class="n">conf</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_quiet</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">            <span class="n">okee</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">exec_check_unit</span><span class="p">(</span><span class="n">conf</span><span class="p">,</span> <span class="n">env</span><span class="p">,</span> <span class="n">Service</span><span class="p">,</span> <span class="s2">&#34;ExecStop&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">            <span class="k">if</span> <span class="ow">not</span> <span class="n">okee</span> <span class="ow">and</span> <span class="n">_no_reload</span><span class="p">:</span> <span class="k">return</span> <span class="kc">False</span>
</span></span><span class="line"><span class="cl">        <span class="n">service_directories</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">env_service_directories</span><span class="p">(</span><span class="n">conf</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="n">env</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">service_directories</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="n">returncode</span> <span class="o">=</span> <span class="mi">0</span>
</span></span><span class="line"><span class="cl">        <span class="n">service_result</span> <span class="o">=</span> <span class="s2">&#34;success&#34;</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="n">runs</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&#34;oneshot&#34;</span><span class="p">]:</span>
</span></span><span class="line"><span class="cl">            <span class="n">status_file</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_status_file_from</span><span class="p">(</span><span class="n">conf</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_status_from</span><span class="p">(</span><span class="n">conf</span><span class="p">,</span> <span class="s2">&#34;ActiveState&#34;</span><span class="p">,</span> <span class="s2">&#34;unknown&#34;</span><span class="p">)</span> <span class="o">==</span> <span class="s2">&#34;inactive&#34;</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">                <span class="n">logg</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&#34;the service is already down once&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">                <span class="k">return</span> <span class="kc">True</span>
</span></span><span class="line"><span class="cl">            <span class="k">for</span> <span class="n">cmd</span> <span class="ow">in</span> <span class="n">conf</span><span class="o">.</span><span class="n">getlist</span><span class="p">(</span><span class="n">Service</span><span class="p">,</span> <span class="s2">&#34;ExecStop&#34;</span><span class="p">,</span> <span class="p">[]):</span>
</span></span><span class="line"><span class="cl">                <span class="n">exe</span><span class="p">,</span> <span class="n">newcmd</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">exec_newcmd</span><span class="p">(</span><span class="n">cmd</span><span class="p">,</span> <span class="n">env</span><span class="p">,</span> <span class="n">conf</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">                <span class="n">logg</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&#34;</span><span class="si">%s</span><span class="s2"> stop </span><span class="si">%s</span><span class="s2">&#34;</span><span class="p">,</span> <span class="n">runs</span><span class="p">,</span> <span class="n">shell_cmd</span><span class="p">(</span><span class="n">newcmd</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">                <span class="n">forkpid</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">fork</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">                <span class="k">if</span> <span class="ow">not</span> <span class="n">forkpid</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">                    <span class="bp">self</span><span class="o">.</span><span class="n">execve_from</span><span class="p">(</span><span class="n">conf</span><span class="p">,</span> <span class="n">newcmd</span><span class="p">,</span> <span class="n">env</span><span class="p">)</span> <span class="c1"># pragma: no cover</span>
</span></span><span class="line"><span class="cl">                <span class="n">run</span> <span class="o">=</span> <span class="n">subprocess_waitpid</span><span class="p">(</span><span class="n">forkpid</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">                <span class="k">if</span> <span class="n">run</span><span class="o">.</span><span class="n">returncode</span> <span class="ow">and</span> <span class="n">exe</span><span class="o">.</span><span class="n">check</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">                    <span class="n">returncode</span> <span class="o">=</span> <span class="n">run</span><span class="o">.</span><span class="n">returncode</span>
</span></span><span class="line"><span class="cl">                    <span class="n">service_result</span> <span class="o">=</span> <span class="s2">&#34;failed&#34;</span>
</span></span><span class="line"><span class="cl">                    <span class="k">break</span>
</span></span><span class="line"><span class="cl">            <span class="k">if</span> <span class="kc">True</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">                <span class="k">if</span> <span class="n">returncode</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">                    <span class="bp">self</span><span class="o">.</span><span class="n">set_status_from</span><span class="p">(</span><span class="n">conf</span><span class="p">,</span> <span class="s2">&#34;ExecStopCode&#34;</span><span class="p">,</span> <span class="n">strE</span><span class="p">(</span><span class="n">returncode</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">                    <span class="bp">self</span><span class="o">.</span><span class="n">write_status_from</span><span class="p">(</span><span class="n">conf</span><span class="p">,</span> <span class="n">AS</span><span class="o">=</span><span class="s2">&#34;failed&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">                <span class="k">else</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">                    <span class="bp">self</span><span class="o">.</span><span class="n">clean_status_from</span><span class="p">(</span><span class="n">conf</span><span class="p">)</span> <span class="c1"># &#34;inactive&#34;</span>
</span></span><span class="line"><span class="cl">        <span class="c1"># fallback Stop =&gt; Kill for [&#34;simple&#34;,&#34;notify&#34;,&#34;forking&#34;]</span>
</span></span><span class="line"><span class="cl">        <span class="k">elif</span> <span class="ow">not</span> <span class="n">conf</span><span class="o">.</span><span class="n">getlist</span><span class="p">(</span><span class="n">Service</span><span class="p">,</span> <span class="s2">&#34;ExecStop&#34;</span><span class="p">,</span> <span class="p">[]):</span>
</span></span><span class="line"><span class="cl">            <span class="n">logg</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&#34;no ExecStop =&gt; systemctl kill&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">            <span class="k">if</span> <span class="kc">True</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">                <span class="bp">self</span><span class="o">.</span><span class="n">do_kill_unit_from</span><span class="p">(</span><span class="n">conf</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">                <span class="bp">self</span><span class="o">.</span><span class="n">clean_pid_file_from</span><span class="p">(</span><span class="n">conf</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">                <span class="bp">self</span><span class="o">.</span><span class="n">clean_status_from</span><span class="p">(</span><span class="n">conf</span><span class="p">)</span> <span class="c1"># &#34;inactive&#34;</span>
</span></span><span class="line"><span class="cl">        <span class="k">elif</span> <span class="n">runs</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&#34;simple&#34;</span><span class="p">,</span> <span class="s2">&#34;exec&#34;</span><span class="p">,</span> <span class="s2">&#34;notify&#34;</span><span class="p">,</span> <span class="s2">&#34;idle&#34;</span><span class="p">]:</span>
</span></span><span class="line"><span class="cl">            <span class="n">status_file</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_status_file_from</span><span class="p">(</span><span class="n">conf</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">            <span class="n">size</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">status_file</span><span class="p">)</span> <span class="ow">and</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">getsize</span><span class="p">(</span><span class="n">status_file</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">            <span class="n">logg</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&#34;STATUS </span><span class="si">%s</span><span class="s2"> </span><span class="si">%s</span><span class="s2">&#34;</span><span class="p">,</span> <span class="n">status_file</span><span class="p">,</span> <span class="n">size</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">            <span class="n">pid</span> <span class="o">=</span> <span class="mi">0</span>
</span></span><span class="line"><span class="cl">            <span class="k">for</span> <span class="n">cmd</span> <span class="ow">in</span> <span class="n">conf</span><span class="o">.</span><span class="n">getlist</span><span class="p">(</span><span class="n">Service</span><span class="p">,</span> <span class="s2">&#34;ExecStop&#34;</span><span class="p">,</span> <span class="p">[]):</span>
</span></span><span class="line"><span class="cl">                <span class="n">env</span><span class="p">[</span><span class="s2">&#34;MAINPID&#34;</span><span class="p">]</span> <span class="o">=</span> <span class="n">strE</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">read_mainpid_from</span><span class="p">(</span><span class="n">conf</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">                <span class="n">exe</span><span class="p">,</span> <span class="n">newcmd</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">exec_newcmd</span><span class="p">(</span><span class="n">cmd</span><span class="p">,</span> <span class="n">env</span><span class="p">,</span> <span class="n">conf</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">                <span class="n">logg</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&#34;</span><span class="si">%s</span><span class="s2"> stop </span><span class="si">%s</span><span class="s2">&#34;</span><span class="p">,</span> <span class="n">runs</span><span class="p">,</span> <span class="n">shell_cmd</span><span class="p">(</span><span class="n">newcmd</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">                <span class="n">forkpid</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">fork</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">                <span class="k">if</span> <span class="ow">not</span> <span class="n">forkpid</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">                    <span class="bp">self</span><span class="o">.</span><span class="n">execve_from</span><span class="p">(</span><span class="n">conf</span><span class="p">,</span> <span class="n">newcmd</span><span class="p">,</span> <span class="n">env</span><span class="p">)</span> <span class="c1"># pragma: no cover</span>
</span></span><span class="line"><span class="cl">                <span class="n">run</span> <span class="o">=</span> <span class="n">subprocess_waitpid</span><span class="p">(</span><span class="n">forkpid</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">                <span class="n">run</span> <span class="o">=</span> <span class="n">must_have_failed</span><span class="p">(</span><span class="n">run</span><span class="p">,</span> <span class="n">newcmd</span><span class="p">)</span> <span class="c1"># TODO: a workaround</span>
</span></span><span class="line"><span class="cl">                <span class="c1"># self.write_status_from(conf, MainPID=run.pid) # no ExecStop</span>
</span></span><span class="line"><span class="cl">                <span class="k">if</span> <span class="n">run</span><span class="o">.</span><span class="n">returncode</span> <span class="ow">and</span> <span class="n">exe</span><span class="o">.</span><span class="n">check</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">                    <span class="n">returncode</span> <span class="o">=</span> <span class="n">run</span><span class="o">.</span><span class="n">returncode</span>
</span></span><span class="line"><span class="cl">                    <span class="n">service_result</span> <span class="o">=</span> <span class="s2">&#34;failed&#34;</span>
</span></span><span class="line"><span class="cl">                    <span class="k">break</span>
</span></span><span class="line"><span class="cl">            <span class="n">pid</span> <span class="o">=</span> <span class="n">to_intN</span><span class="p">(</span><span class="n">env</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&#34;MAINPID&#34;</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">            <span class="k">if</span> <span class="n">pid</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">wait_vanished_pid</span><span class="p">(</span><span class="n">pid</span><span class="p">,</span> <span class="n">timeout</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">                    <span class="bp">self</span><span class="o">.</span><span class="n">clean_pid_file_from</span><span class="p">(</span><span class="n">conf</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">                    <span class="bp">self</span><span class="o">.</span><span class="n">clean_status_from</span><span class="p">(</span><span class="n">conf</span><span class="p">)</span> <span class="c1"># &#34;inactive&#34;</span>
</span></span><span class="line"><span class="cl">            <span class="k">else</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">                <span class="n">logg</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&#34;</span><span class="si">%s</span><span class="s2"> sleep as no PID was found on Stop&#34;</span><span class="p">,</span> <span class="n">runs</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">                <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="n">MinimumTimeoutStopSec</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">                <span class="n">pid</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">read_mainpid_from</span><span class="p">(</span><span class="n">conf</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">                <span class="k">if</span> <span class="ow">not</span> <span class="n">pid</span> <span class="ow">or</span> <span class="ow">not</span> <span class="n">pid_exists</span><span class="p">(</span><span class="n">pid</span><span class="p">)</span> <span class="ow">or</span> <span class="n">pid_zombie</span><span class="p">(</span><span class="n">pid</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">                    <span class="bp">self</span><span class="o">.</span><span class="n">clean_pid_file_from</span><span class="p">(</span><span class="n">conf</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">                <span class="bp">self</span><span class="o">.</span><span class="n">clean_status_from</span><span class="p">(</span><span class="n">conf</span><span class="p">)</span> <span class="c1"># &#34;inactive&#34;</span>
</span></span><span class="line"><span class="cl">        <span class="k">elif</span> <span class="n">runs</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&#34;forking&#34;</span><span class="p">]:</span>
</span></span><span class="line"><span class="cl">            <span class="n">status_file</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_status_file_from</span><span class="p">(</span><span class="n">conf</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">            <span class="n">pid_file</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">pid_file_from</span><span class="p">(</span><span class="n">conf</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">            <span class="k">for</span> <span class="n">cmd</span> <span class="ow">in</span> <span class="n">conf</span><span class="o">.</span><span class="n">getlist</span><span class="p">(</span><span class="n">Service</span><span class="p">,</span> <span class="s2">&#34;ExecStop&#34;</span><span class="p">,</span> <span class="p">[]):</span>
</span></span><span class="line"><span class="cl">                <span class="c1"># active = self.is_active_from(conf)</span>
</span></span><span class="line"><span class="cl">                <span class="k">if</span> <span class="n">pid_file</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">                    <span class="n">new_pid</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">read_mainpid_from</span><span class="p">(</span><span class="n">conf</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">                    <span class="k">if</span> <span class="n">new_pid</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">                        <span class="n">env</span><span class="p">[</span><span class="s2">&#34;MAINPID&#34;</span><span class="p">]</span> <span class="o">=</span> <span class="n">strE</span><span class="p">(</span><span class="n">new_pid</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">                <span class="n">exe</span><span class="p">,</span> <span class="n">newcmd</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">exec_newcmd</span><span class="p">(</span><span class="n">cmd</span><span class="p">,</span> <span class="n">env</span><span class="p">,</span> <span class="n">conf</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">                <span class="n">logg</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&#34;fork stop </span><span class="si">%s</span><span class="s2">&#34;</span><span class="p">,</span> <span class="n">shell_cmd</span><span class="p">(</span><span class="n">newcmd</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">                <span class="n">forkpid</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">fork</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">                <span class="k">if</span> <span class="ow">not</span> <span class="n">forkpid</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">                    <span class="bp">self</span><span class="o">.</span><span class="n">execve_from</span><span class="p">(</span><span class="n">conf</span><span class="p">,</span> <span class="n">newcmd</span><span class="p">,</span> <span class="n">env</span><span class="p">)</span> <span class="c1"># pragma: no cover</span>
</span></span><span class="line"><span class="cl">                <span class="n">run</span> <span class="o">=</span> <span class="n">subprocess_waitpid</span><span class="p">(</span><span class="n">forkpid</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">                <span class="k">if</span> <span class="n">run</span><span class="o">.</span><span class="n">returncode</span> <span class="ow">and</span> <span class="n">exe</span><span class="o">.</span><span class="n">check</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">                    <span class="n">returncode</span> <span class="o">=</span> <span class="n">run</span><span class="o">.</span><span class="n">returncode</span>
</span></span><span class="line"><span class="cl">                    <span class="n">service_result</span> <span class="o">=</span> <span class="s2">&#34;failed&#34;</span>
</span></span><span class="line"><span class="cl">                    <span class="k">break</span>
</span></span><span class="line"><span class="cl">            <span class="n">pid</span> <span class="o">=</span> <span class="n">to_intN</span><span class="p">(</span><span class="n">env</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&#34;MAINPID&#34;</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">            <span class="k">if</span> <span class="n">pid</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">wait_vanished_pid</span><span class="p">(</span><span class="n">pid</span><span class="p">,</span> <span class="n">timeout</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">                    <span class="bp">self</span><span class="o">.</span><span class="n">clean_pid_file_from</span><span class="p">(</span><span class="n">conf</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">            <span class="k">else</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">                <span class="n">logg</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&#34;</span><span class="si">%s</span><span class="s2"> sleep as no PID was found on Stop&#34;</span><span class="p">,</span> <span class="n">runs</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">                <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="n">MinimumTimeoutStopSec</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">                <span class="n">pid</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">read_mainpid_from</span><span class="p">(</span><span class="n">conf</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">                <span class="k">if</span> <span class="ow">not</span> <span class="n">pid</span> <span class="ow">or</span> <span class="ow">not</span> <span class="n">pid_exists</span><span class="p">(</span><span class="n">pid</span><span class="p">)</span> <span class="ow">or</span> <span class="n">pid_zombie</span><span class="p">(</span><span class="n">pid</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">                    <span class="bp">self</span><span class="o">.</span><span class="n">clean_pid_file_from</span><span class="p">(</span><span class="n">conf</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">            <span class="k">if</span> <span class="n">returncode</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">                <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isfile</span><span class="p">(</span><span class="n">status_file</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">                    <span class="bp">self</span><span class="o">.</span><span class="n">set_status_from</span><span class="p">(</span><span class="n">conf</span><span class="p">,</span> <span class="s2">&#34;ExecStopCode&#34;</span><span class="p">,</span> <span class="n">strE</span><span class="p">(</span><span class="n">returncode</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">                    <span class="bp">self</span><span class="o">.</span><span class="n">write_status_from</span><span class="p">(</span><span class="n">conf</span><span class="p">,</span> <span class="n">AS</span><span class="o">=</span><span class="s2">&#34;failed&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">            <span class="k">else</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">                <span class="bp">self</span><span class="o">.</span><span class="n">clean_status_from</span><span class="p">(</span><span class="n">conf</span><span class="p">)</span> <span class="c1"># &#34;inactive&#34;</span>
</span></span><span class="line"><span class="cl">        <span class="k">else</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">            <span class="n">logg</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&#34;unsupported run type &#39;</span><span class="si">%s</span><span class="s2">&#39;&#34;</span><span class="p">,</span> <span class="n">runs</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">            <span class="k">return</span> <span class="kc">False</span>
</span></span><span class="line"><span class="cl">        <span class="c1"># POST sequence</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">is_active_from</span><span class="p">(</span><span class="n">conf</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">            <span class="n">env</span><span class="p">[</span><span class="s2">&#34;SERVICE_RESULT&#34;</span><span class="p">]</span> <span class="o">=</span> <span class="n">service_result</span>
</span></span><span class="line"><span class="cl">            <span class="k">for</span> <span class="n">cmd</span> <span class="ow">in</span> <span class="n">conf</span><span class="o">.</span><span class="n">getlist</span><span class="p">(</span><span class="n">Service</span><span class="p">,</span> <span class="s2">&#34;ExecStopPost&#34;</span><span class="p">,</span> <span class="p">[]):</span>
</span></span><span class="line"><span class="cl">                <span class="n">exe</span><span class="p">,</span> <span class="n">newcmd</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">exec_newcmd</span><span class="p">(</span><span class="n">cmd</span><span class="p">,</span> <span class="n">env</span><span class="p">,</span> <span class="n">conf</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">                <span class="n">logg</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&#34;post-stop </span><span class="si">%s</span><span class="s2">&#34;</span><span class="p">,</span> <span class="n">shell_cmd</span><span class="p">(</span><span class="n">newcmd</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">                <span class="n">forkpid</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">fork</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">                <span class="k">if</span> <span class="ow">not</span> <span class="n">forkpid</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">                    <span class="bp">self</span><span class="o">.</span><span class="n">execve_from</span><span class="p">(</span><span class="n">conf</span><span class="p">,</span> <span class="n">newcmd</span><span class="p">,</span> <span class="n">env</span><span class="p">)</span> <span class="c1"># pragma: no cover</span>
</span></span><span class="line"><span class="cl">                <span class="n">run</span> <span class="o">=</span> <span class="n">subprocess_waitpid</span><span class="p">(</span><span class="n">forkpid</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">                <span class="n">logg</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&#34;post-stop done (</span><span class="si">%s</span><span class="s2">) &lt;-</span><span class="si">%s</span><span class="s2">&gt;&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                           <span class="n">run</span><span class="o">.</span><span class="n">returncode</span> <span class="ow">or</span> <span class="s2">&#34;OK&#34;</span><span class="p">,</span> <span class="n">run</span><span class="o">.</span><span class="n">signal</span> <span class="ow">or</span> <span class="s2">&#34;&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_only_what</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&#34;none&#34;</span><span class="p">,</span> <span class="s2">&#34;keep&#34;</span><span class="p">]:</span>
</span></span><span class="line"><span class="cl">            <span class="bp">self</span><span class="o">.</span><span class="n">remove_service_directories</span><span class="p">(</span><span class="n">conf</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="n">service_result</span> <span class="o">==</span> <span class="s2">&#34;success&#34;</span>
</span></span><span class="line"><span class="cl">    <span class="k">def</span> <span class="nf">do_stop_socket_from</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">conf</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">        <span class="n">runs</span> <span class="o">=</span> <span class="s2">&#34;socket&#34;</span>
</span></span><span class="line"><span class="cl">        <span class="n">timeout</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_SocketTimeoutSec</span><span class="p">(</span><span class="n">conf</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="n">accept</span> <span class="o">=</span> <span class="n">conf</span><span class="o">.</span><span class="n">getbool</span><span class="p">(</span><span class="n">Socket</span><span class="p">,</span> <span class="s2">&#34;Accept&#34;</span><span class="p">,</span> <span class="s2">&#34;no&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="n">service_unit</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_socket_service_from</span><span class="p">(</span><span class="n">conf</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="n">service_conf</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">load_unit_conf</span><span class="p">(</span><span class="n">service_unit</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="n">service_conf</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">            <span class="n">logg</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&#34;unit could not be loaded (</span><span class="si">%s</span><span class="s2">)&#34;</span><span class="p">,</span> <span class="n">service_unit</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">            <span class="n">logg</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&#34;Unit </span><span class="si">%s</span><span class="s2"> not found.&#34;</span><span class="p">,</span> <span class="n">service_unit</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">            <span class="k">return</span> <span class="kc">False</span>
</span></span><span class="line"><span class="cl">        <span class="n">env</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_env</span><span class="p">(</span><span class="n">conf</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_quiet</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">            <span class="n">okee</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">exec_check_unit</span><span class="p">(</span><span class="n">conf</span><span class="p">,</span> <span class="n">env</span><span class="p">,</span> <span class="n">Socket</span><span class="p">,</span> <span class="s2">&#34;ExecStop&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">            <span class="k">if</span> <span class="ow">not</span> <span class="n">okee</span> <span class="ow">and</span> <span class="n">_no_reload</span><span class="p">:</span> <span class="k">return</span> <span class="kc">False</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="ow">not</span> <span class="n">accept</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">            <span class="c1"># we do not listen but have the service started right away</span>
</span></span><span class="line"><span class="cl">            <span class="n">done</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">do_stop_service_from</span><span class="p">(</span><span class="n">service_conf</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">            <span class="n">service_result</span> <span class="o">=</span> <span class="n">done</span> <span class="ow">and</span> <span class="s2">&#34;success&#34;</span> <span class="ow">or</span> <span class="s2">&#34;failed&#34;</span>
</span></span><span class="line"><span class="cl">        <span class="k">else</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">            <span class="n">done</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">do_stop_service_from</span><span class="p">(</span><span class="n">service_conf</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">            <span class="n">service_result</span> <span class="o">=</span> <span class="n">done</span> <span class="ow">and</span> <span class="s2">&#34;success&#34;</span> <span class="ow">or</span> <span class="s2">&#34;failed&#34;</span>
</span></span><span class="line"><span class="cl">        <span class="c1"># service_directories = self.env_service_directories(conf)</span>
</span></span><span class="line"><span class="cl">        <span class="c1"># env.update(service_directories)</span>
</span></span><span class="line"><span class="cl">        <span class="c1"># POST sequence</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">is_active_from</span><span class="p">(</span><span class="n">conf</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">            <span class="n">env</span><span class="p">[</span><span class="s2">&#34;SERVICE_RESULT&#34;</span><span class="p">]</span> <span class="o">=</span> <span class="n">service_result</span>
</span></span><span class="line"><span class="cl">            <span class="k">for</span> <span class="n">cmd</span> <span class="ow">in</span> <span class="n">conf</span><span class="o">.</span><span class="n">getlist</span><span class="p">(</span><span class="n">Socket</span><span class="p">,</span> <span class="s2">&#34;ExecStopPost&#34;</span><span class="p">,</span> <span class="p">[]):</span>
</span></span><span class="line"><span class="cl">                <span class="n">exe</span><span class="p">,</span> <span class="n">newcmd</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">exec_newcmd</span><span class="p">(</span><span class="n">cmd</span><span class="p">,</span> <span class="n">env</span><span class="p">,</span> <span class="n">conf</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">                <span class="n">logg</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&#34;post-stop </span><span class="si">%s</span><span class="s2">&#34;</span><span class="p">,</span> <span class="n">shell_cmd</span><span class="p">(</span><span class="n">newcmd</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">                <span class="n">forkpid</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">fork</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">                <span class="k">if</span> <span class="ow">not</span> <span class="n">forkpid</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">                    <span class="bp">self</span><span class="o">.</span><span class="n">execve_from</span><span class="p">(</span><span class="n">conf</span><span class="p">,</span> <span class="n">newcmd</span><span class="p">,</span> <span class="n">env</span><span class="p">)</span> <span class="c1"># pragma: no cover</span>
</span></span><span class="line"><span class="cl">                <span class="n">run</span> <span class="o">=</span> <span class="n">subprocess_waitpid</span><span class="p">(</span><span class="n">forkpid</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">                <span class="n">logg</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&#34;post-stop done (</span><span class="si">%s</span><span class="s2">) &lt;-</span><span class="si">%s</span><span class="s2">&gt;&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                           <span class="n">run</span><span class="o">.</span><span class="n">returncode</span> <span class="ow">or</span> <span class="s2">&#34;OK&#34;</span><span class="p">,</span> <span class="n">run</span><span class="o">.</span><span class="n">signal</span> <span class="ow">or</span> <span class="s2">&#34;&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="n">service_result</span> <span class="o">==</span> <span class="s2">&#34;success&#34;</span>
</span></span><span class="line"><span class="cl">    <span class="k">def</span> <span class="nf">wait_vanished_pid</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">pid</span><span class="p">,</span> <span class="n">timeout</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="ow">not</span> <span class="n">pid</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">            <span class="k">return</span> <span class="kc">True</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">is_active_pid</span><span class="p">(</span><span class="n">pid</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">            <span class="k">return</span> <span class="kc">True</span>
</span></span><span class="line"><span class="cl">        <span class="n">logg</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&#34;wait for PID </span><span class="si">%s</span><span class="s2"> to vanish (</span><span class="si">%s</span><span class="s2">s)&#34;</span><span class="p">,</span> <span class="n">pid</span><span class="p">,</span> <span class="n">timeout</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">xrange</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">timeout</span><span class="p">)):</span>
</span></span><span class="line"><span class="cl">            <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="c1"># until TimeoutStopSec</span>
</span></span><span class="line"><span class="cl">            <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">is_active_pid</span><span class="p">(</span><span class="n">pid</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">                <span class="n">logg</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&#34;wait for PID </span><span class="si">%s</span><span class="s2"> is done (</span><span class="si">%s</span><span class="s2">.)&#34;</span><span class="p">,</span> <span class="n">pid</span><span class="p">,</span> <span class="n">x</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">                <span class="k">return</span> <span class="kc">True</span>
</span></span><span class="line"><span class="cl">        <span class="n">logg</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&#34;wait for PID </span><span class="si">%s</span><span class="s2"> failed (</span><span class="si">%s</span><span class="s2">.)&#34;</span><span class="p">,</span> <span class="n">pid</span><span class="p">,</span> <span class="n">timeout</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="kc">False</span>
</span></span><span class="line"><span class="cl">    <span class="k">def</span> <span class="nf">reload_modules</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">modules</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">        <span class="s2">&#34;&#34;&#34; [UNIT]... -- reload these units &#34;&#34;&#34;</span>
</span></span><span class="line"><span class="cl">        <span class="bp">self</span><span class="o">.</span><span class="n">wait_system</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">        <span class="n">found_all</span> <span class="o">=</span> <span class="kc">True</span>
</span></span><span class="line"><span class="cl">        <span class="n">units</span> <span class="o">=</span> <span class="p">[]</span>
</span></span><span class="line"><span class="cl">        <span class="k">for</span> <span class="n">module</span> <span class="ow">in</span> <span class="n">modules</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">            <span class="n">matched</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">match_units</span><span class="p">(</span><span class="n">to_list</span><span class="p">(</span><span class="n">module</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">            <span class="k">if</span> <span class="ow">not</span> <span class="n">matched</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">                <span class="n">logg</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&#34;Unit </span><span class="si">%s</span><span class="s2"> not found.&#34;</span><span class="p">,</span> <span class="n">unit_of</span><span class="p">(</span><span class="n">module</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">                <span class="bp">self</span><span class="o">.</span><span class="n">error</span> <span class="o">|=</span> <span class="n">NOT_FOUND</span>
</span></span><span class="line"><span class="cl">                <span class="n">found_all</span> <span class="o">=</span> <span class="kc">False</span>
</span></span><span class="line"><span class="cl">                <span class="k">continue</span>
</span></span><span class="line"><span class="cl">            <span class="k">for</span> <span class="n">unit</span> <span class="ow">in</span> <span class="n">matched</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">                <span class="k">if</span> <span class="n">unit</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">units</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">                    <span class="n">units</span> <span class="o">+=</span> <span class="p">[</span><span class="n">unit</span><span class="p">]</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">reload_units</span><span class="p">(</span><span class="n">units</span><span class="p">)</span> <span class="ow">and</span> <span class="n">found_all</span>
</span></span><span class="line"><span class="cl">    <span class="k">def</span> <span class="nf">reload_units</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">units</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">        <span class="s2">&#34;&#34;&#34; fails if any unit fails to reload &#34;&#34;&#34;</span>
</span></span><span class="line"><span class="cl">        <span class="bp">self</span><span class="o">.</span><span class="n">wait_system</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">        <span class="n">done</span> <span class="o">=</span> <span class="kc">True</span>
</span></span><span class="line"><span class="cl">        <span class="k">for</span> <span class="n">unit</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">sortedAfter</span><span class="p">(</span><span class="n">units</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">            <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">reload_unit</span><span class="p">(</span><span class="n">unit</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">                <span class="n">done</span> <span class="o">=</span> <span class="kc">False</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="n">done</span>
</span></span><span class="line"><span class="cl">    <span class="k">def</span> <span class="nf">reload_unit</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">unit</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">        <span class="n">conf</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">load_unit_conf</span><span class="p">(</span><span class="n">unit</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="n">conf</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">            <span class="n">logg</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&#34;Unit </span><span class="si">%s</span><span class="s2"> not found.&#34;</span><span class="p">,</span> <span class="n">unit</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">            <span class="k">return</span> <span class="kc">False</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">not_user_conf</span><span class="p">(</span><span class="n">conf</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">            <span class="n">logg</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&#34;Unit </span><span class="si">%s</span><span class="s2"> not for --user mode&#34;</span><span class="p">,</span> <span class="n">unit</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">            <span class="k">return</span> <span class="kc">False</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">reload_unit_from</span><span class="p">(</span><span class="n">conf</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="k">def</span> <span class="nf">reload_unit_from</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">conf</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="ow">not</span> <span class="n">conf</span><span class="p">:</span> <span class="k">return</span> <span class="kc">False</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">syntax_check</span><span class="p">(</span><span class="n">conf</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">100</span><span class="p">:</span> <span class="k">return</span> <span class="kc">False</span>
</span></span><span class="line"><span class="cl">        <span class="k">with</span> <span class="n">waitlock</span><span class="p">(</span><span class="n">conf</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">            <span class="n">logg</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&#34; reload unit </span><span class="si">%s</span><span class="s2"> =&gt; </span><span class="si">%s</span><span class="s2">&#34;</span><span class="p">,</span> <span class="n">conf</span><span class="o">.</span><span class="n">name</span><span class="p">(),</span> <span class="n">strQ</span><span class="p">(</span><span class="n">conf</span><span class="o">.</span><span class="n">filename</span><span class="p">()))</span>
</span></span><span class="line"><span class="cl">            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">do_reload_unit_from</span><span class="p">(</span><span class="n">conf</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="k">def</span> <span class="nf">do_reload_unit_from</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">conf</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="n">conf</span><span class="o">.</span><span class="n">name</span><span class="p">()</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s2">&#34;.service&#34;</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">do_reload_service_from</span><span class="p">(</span><span class="n">conf</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="k">elif</span> <span class="n">conf</span><span class="o">.</span><span class="n">name</span><span class="p">()</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s2">&#34;.socket&#34;</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">            <span class="n">service_unit</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_socket_service_from</span><span class="p">(</span><span class="n">conf</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">            <span class="n">service_conf</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">load_unit_conf</span><span class="p">(</span><span class="n">service_unit</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">            <span class="k">if</span> <span class="n">service_conf</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">                <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">do_reload_service_from</span><span class="p">(</span><span class="n">service_conf</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">            <span class="k">else</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">                <span class="n">logg</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&#34;no </span><span class="si">%s</span><span class="s2"> found for unit type: </span><span class="si">%s</span><span class="s2">&#34;</span><span class="p">,</span> <span class="n">service_unit</span><span class="p">,</span> <span class="n">conf</span><span class="o">.</span><span class="n">name</span><span class="p">())</span>
</span></span><span class="line"><span class="cl">                <span class="k">return</span> <span class="kc">False</span>
</span></span><span class="line"><span class="cl">        <span class="k">elif</span> <span class="n">conf</span><span class="o">.</span><span class="n">name</span><span class="p">()</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s2">&#34;.target&#34;</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">do_reload_target_from</span><span class="p">(</span><span class="n">conf</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="k">else</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">            <span class="n">logg</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&#34;reload not implemented for unit type: </span><span class="si">%s</span><span class="s2">&#34;</span><span class="p">,</span> <span class="n">conf</span><span class="o">.</span><span class="n">name</span><span class="p">())</span>
</span></span><span class="line"><span class="cl">            <span class="k">return</span> <span class="kc">False</span>
</span></span><span class="line"><span class="cl">    <span class="k">def</span> <span class="nf">do_reload_service_from</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">conf</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">        <span class="n">runs</span> <span class="o">=</span> <span class="n">conf</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">Service</span><span class="p">,</span> <span class="s2">&#34;Type&#34;</span><span class="p">,</span> <span class="s2">&#34;simple&#34;</span><span class="p">)</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">        <span class="n">env</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_env</span><span class="p">(</span><span class="n">conf</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_quiet</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">            <span class="n">okee</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">exec_check_unit</span><span class="p">(</span><span class="n">conf</span><span class="p">,</span> <span class="n">env</span><span class="p">,</span> <span class="n">Service</span><span class="p">,</span> <span class="s2">&#34;ExecReload&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">            <span class="k">if</span> <span class="ow">not</span> <span class="n">okee</span> <span class="ow">and</span> <span class="n">_no_reload</span><span class="p">:</span> <span class="k">return</span> <span class="kc">False</span>
</span></span><span class="line"><span class="cl">        <span class="n">initscript</span> <span class="o">=</span> <span class="n">conf</span><span class="o">.</span><span class="n">filename</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">is_sysv_file</span><span class="p">(</span><span class="n">initscript</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">            <span class="n">status_file</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_status_file_from</span><span class="p">(</span><span class="n">conf</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">            <span class="k">if</span> <span class="n">initscript</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">                <span class="n">newcmd</span> <span class="o">=</span> <span class="p">[</span><span class="n">initscript</span><span class="p">,</span> <span class="s2">&#34;reload&#34;</span><span class="p">]</span>
</span></span><span class="line"><span class="cl">                <span class="n">env</span><span class="p">[</span><span class="s2">&#34;SYSTEMCTL_SKIP_REDIRECT&#34;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&#34;yes&#34;</span>
</span></span><span class="line"><span class="cl">                <span class="n">logg</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&#34;</span><span class="si">%s</span><span class="s2"> reload </span><span class="si">%s</span><span class="s2">&#34;</span><span class="p">,</span> <span class="n">runs</span><span class="p">,</span> <span class="n">shell_cmd</span><span class="p">(</span><span class="n">newcmd</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">                <span class="n">forkpid</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">fork</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">                <span class="k">if</span> <span class="ow">not</span> <span class="n">forkpid</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">                    <span class="bp">self</span><span class="o">.</span><span class="n">execve_from</span><span class="p">(</span><span class="n">conf</span><span class="p">,</span> <span class="n">newcmd</span><span class="p">,</span> <span class="n">env</span><span class="p">)</span> <span class="c1"># pragma: nocover</span>
</span></span><span class="line"><span class="cl">                <span class="n">run</span> <span class="o">=</span> <span class="n">subprocess_waitpid</span><span class="p">(</span><span class="n">forkpid</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">                <span class="bp">self</span><span class="o">.</span><span class="n">set_status_from</span><span class="p">(</span><span class="n">conf</span><span class="p">,</span> <span class="s2">&#34;ExecReloadCode&#34;</span><span class="p">,</span> <span class="n">run</span><span class="o">.</span><span class="n">returncode</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">                <span class="k">if</span> <span class="n">run</span><span class="o">.</span><span class="n">returncode</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">                    <span class="bp">self</span><span class="o">.</span><span class="n">write_status_from</span><span class="p">(</span><span class="n">conf</span><span class="p">,</span> <span class="n">AS</span><span class="o">=</span><span class="s2">&#34;failed&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">                    <span class="k">return</span> <span class="kc">False</span>
</span></span><span class="line"><span class="cl">                <span class="k">else</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">                    <span class="bp">self</span><span class="o">.</span><span class="n">write_status_from</span><span class="p">(</span><span class="n">conf</span><span class="p">,</span> <span class="n">AS</span><span class="o">=</span><span class="s2">&#34;active&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">                    <span class="k">return</span> <span class="kc">True</span>
</span></span><span class="line"><span class="cl">        <span class="n">service_directories</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">env_service_directories</span><span class="p">(</span><span class="n">conf</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="n">env</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">service_directories</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="n">runs</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&#34;simple&#34;</span><span class="p">,</span> <span class="s2">&#34;exec&#34;</span><span class="p">,</span> <span class="s2">&#34;notify&#34;</span><span class="p">,</span> <span class="s2">&#34;forking&#34;</span><span class="p">,</span> <span class="s2">&#34;idle&#34;</span><span class="p">]:</span>
</span></span><span class="line"><span class="cl">            <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">is_active_from</span><span class="p">(</span><span class="n">conf</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">                <span class="n">logg</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&#34;no reload on inactive service </span><span class="si">%s</span><span class="s2">&#34;</span><span class="p">,</span> <span class="n">conf</span><span class="o">.</span><span class="n">name</span><span class="p">())</span>
</span></span><span class="line"><span class="cl">                <span class="k">return</span> <span class="kc">True</span>
</span></span><span class="line"><span class="cl">            <span class="k">for</span> <span class="n">cmd</span> <span class="ow">in</span> <span class="n">conf</span><span class="o">.</span><span class="n">getlist</span><span class="p">(</span><span class="n">Service</span><span class="p">,</span> <span class="s2">&#34;ExecReload&#34;</span><span class="p">,</span> <span class="p">[]):</span>
</span></span><span class="line"><span class="cl">                <span class="n">env</span><span class="p">[</span><span class="s2">&#34;MAINPID&#34;</span><span class="p">]</span> <span class="o">=</span> <span class="n">strE</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">read_mainpid_from</span><span class="p">(</span><span class="n">conf</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">                <span class="n">exe</span><span class="p">,</span> <span class="n">newcmd</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">exec_newcmd</span><span class="p">(</span><span class="n">cmd</span><span class="p">,</span> <span class="n">env</span><span class="p">,</span> <span class="n">conf</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">                <span class="n">logg</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&#34;</span><span class="si">%s</span><span class="s2"> reload </span><span class="si">%s</span><span class="s2">&#34;</span><span class="p">,</span> <span class="n">runs</span><span class="p">,</span> <span class="n">shell_cmd</span><span class="p">(</span><span class="n">newcmd</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">                <span class="n">forkpid</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">fork</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">                <span class="k">if</span> <span class="ow">not</span> <span class="n">forkpid</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">                    <span class="bp">self</span><span class="o">.</span><span class="n">execve_from</span><span class="p">(</span><span class="n">conf</span><span class="p">,</span> <span class="n">newcmd</span><span class="p">,</span> <span class="n">env</span><span class="p">)</span> <span class="c1"># pragma: no cover</span>
</span></span><span class="line"><span class="cl">                <span class="n">run</span> <span class="o">=</span> <span class="n">subprocess_waitpid</span><span class="p">(</span><span class="n">forkpid</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">                <span class="k">if</span> <span class="n">run</span><span class="o">.</span><span class="n">returncode</span> <span class="ow">and</span> <span class="n">exe</span><span class="o">.</span><span class="n">check</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">                    <span class="n">logg</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&#34;Job for </span><span class="si">%s</span><span class="s2"> failed because the control process exited with error code. (</span><span class="si">%s</span><span class="s2">)&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                               <span class="n">conf</span><span class="o">.</span><span class="n">name</span><span class="p">(),</span> <span class="n">run</span><span class="o">.</span><span class="n">returncode</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">                    <span class="k">return</span> <span class="kc">False</span>
</span></span><span class="line"><span class="cl">            <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="n">MinimumYield</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">            <span class="k">return</span> <span class="kc">True</span>
</span></span><span class="line"><span class="cl">        <span class="k">elif</span> <span class="n">runs</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&#34;oneshot&#34;</span><span class="p">]:</span>
</span></span><span class="line"><span class="cl">            <span class="n">logg</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&#34;ignored run type &#39;</span><span class="si">%s</span><span class="s2">&#39; for reload&#34;</span><span class="p">,</span> <span class="n">runs</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">            <span class="k">return</span> <span class="kc">True</span>
</span></span><span class="line"><span class="cl">        <span class="k">else</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">            <span class="n">logg</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&#34;unsupported run type &#39;</span><span class="si">%s</span><span class="s2">&#39;&#34;</span><span class="p">,</span> <span class="n">runs</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">            <span class="k">return</span> <span class="kc">False</span>
</span></span><span class="line"><span class="cl">    <span class="k">def</span> <span class="nf">restart_modules</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">modules</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">        <span class="s2">&#34;&#34;&#34; [UNIT]... -- restart these units &#34;&#34;&#34;</span>
</span></span><span class="line"><span class="cl">        <span class="n">found_all</span> <span class="o">=</span> <span class="kc">True</span>
</span></span><span class="line"><span class="cl">        <span class="n">units</span> <span class="o">=</span> <span class="p">[]</span>
</span></span><span class="line"><span class="cl">        <span class="k">for</span> <span class="n">module</span> <span class="ow">in</span> <span class="n">modules</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">            <span class="n">matched</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">match_units</span><span class="p">(</span><span class="n">to_list</span><span class="p">(</span><span class="n">module</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">            <span class="k">if</span> <span class="ow">not</span> <span class="n">matched</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">                <span class="n">logg</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&#34;Unit </span><span class="si">%s</span><span class="s2"> not found.&#34;</span><span class="p">,</span> <span class="n">unit_of</span><span class="p">(</span><span class="n">module</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">                <span class="bp">self</span><span class="o">.</span><span class="n">error</span> <span class="o">|=</span> <span class="n">NOT_FOUND</span>
</span></span><span class="line"><span class="cl">                <span class="n">found_all</span> <span class="o">=</span> <span class="kc">False</span>
</span></span><span class="line"><span class="cl">                <span class="k">continue</span>
</span></span><span class="line"><span class="cl">            <span class="k">for</span> <span class="n">unit</span> <span class="ow">in</span> <span class="n">matched</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">                <span class="k">if</span> <span class="n">unit</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">units</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">                    <span class="n">units</span> <span class="o">+=</span> <span class="p">[</span><span class="n">unit</span><span class="p">]</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">restart_units</span><span class="p">(</span><span class="n">units</span><span class="p">)</span> <span class="ow">and</span> <span class="n">found_all</span>
</span></span><span class="line"><span class="cl">    <span class="k">def</span> <span class="nf">restart_units</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">units</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">        <span class="s2">&#34;&#34;&#34; fails if any unit fails to restart &#34;&#34;&#34;</span>
</span></span><span class="line"><span class="cl">        <span class="bp">self</span><span class="o">.</span><span class="n">wait_system</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">        <span class="n">done</span> <span class="o">=</span> <span class="kc">True</span>
</span></span><span class="line"><span class="cl">        <span class="k">for</span> <span class="n">unit</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">sortedAfter</span><span class="p">(</span><span class="n">units</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">            <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">restart_unit</span><span class="p">(</span><span class="n">unit</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">                <span class="n">done</span> <span class="o">=</span> <span class="kc">False</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="n">done</span>
</span></span><span class="line"><span class="cl">    <span class="k">def</span> <span class="nf">restart_unit</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">unit</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">        <span class="n">conf</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">load_unit_conf</span><span class="p">(</span><span class="n">unit</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="n">conf</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">            <span class="n">logg</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&#34;Unit </span><span class="si">%s</span><span class="s2"> not found.&#34;</span><span class="p">,</span> <span class="n">unit</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">            <span class="k">return</span> <span class="kc">False</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">not_user_conf</span><span class="p">(</span><span class="n">conf</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">            <span class="n">logg</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&#34;Unit </span><span class="si">%s</span><span class="s2"> not for --user mode&#34;</span><span class="p">,</span> <span class="n">unit</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">            <span class="k">return</span> <span class="kc">False</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">restart_unit_from</span><span class="p">(</span><span class="n">conf</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="k">def</span> <span class="nf">restart_unit_from</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">conf</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="ow">not</span> <span class="n">conf</span><span class="p">:</span> <span class="k">return</span> <span class="kc">False</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">syntax_check</span><span class="p">(</span><span class="n">conf</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">100</span><span class="p">:</span> <span class="k">return</span> <span class="kc">False</span>
</span></span><span class="line"><span class="cl">        <span class="k">with</span> <span class="n">waitlock</span><span class="p">(</span><span class="n">conf</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">            <span class="k">if</span> <span class="n">conf</span><span class="o">.</span><span class="n">name</span><span class="p">()</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s2">&#34;.service&#34;</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">                <span class="n">logg</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&#34; restart service </span><span class="si">%s</span><span class="s2"> =&gt; </span><span class="si">%s</span><span class="s2">&#34;</span><span class="p">,</span> <span class="n">conf</span><span class="o">.</span><span class="n">name</span><span class="p">(),</span> <span class="n">strQ</span><span class="p">(</span><span class="n">conf</span><span class="o">.</span><span class="n">filename</span><span class="p">()))</span>
</span></span><span class="line"><span class="cl">                <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">is_active_from</span><span class="p">(</span><span class="n">conf</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">                    <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">do_start_unit_from</span><span class="p">(</span><span class="n">conf</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">                <span class="k">else</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">                    <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">do_restart_unit_from</span><span class="p">(</span><span class="n">conf</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">            <span class="k">else</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">                <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">do_restart_unit_from</span><span class="p">(</span><span class="n">conf</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="k">def</span> <span class="nf">do_restart_unit_from</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">conf</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">        <span class="n">logg</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&#34;(restart) =&gt; stop/start </span><span class="si">%s</span><span class="s2">&#34;</span><span class="p">,</span> <span class="n">conf</span><span class="o">.</span><span class="n">name</span><span class="p">())</span>
</span></span><span class="line"><span class="cl">        <span class="bp">self</span><span class="o">.</span><span class="n">do_stop_unit_from</span><span class="p">(</span><span class="n">conf</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">do_start_unit_from</span><span class="p">(</span><span class="n">conf</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="k">def</span> <span class="nf">try_restart_modules</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">modules</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">        <span class="s2">&#34;&#34;&#34; [UNIT]... -- try-restart these units &#34;&#34;&#34;</span>
</span></span><span class="line"><span class="cl">        <span class="n">found_all</span> <span class="o">=</span> <span class="kc">True</span>
</span></span><span class="line"><span class="cl">        <span class="n">units</span> <span class="o">=</span> <span class="p">[]</span>
</span></span><span class="line"><span class="cl">        <span class="k">for</span> <span class="n">module</span> <span class="ow">in</span> <span class="n">modules</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">            <span class="n">matched</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">match_units</span><span class="p">(</span><span class="n">to_list</span><span class="p">(</span><span class="n">module</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">            <span class="k">if</span> <span class="ow">not</span> <span class="n">matched</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">                <span class="n">logg</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&#34;Unit </span><span class="si">%s</span><span class="s2"> not found.&#34;</span><span class="p">,</span> <span class="n">unit_of</span><span class="p">(</span><span class="n">module</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">                <span class="bp">self</span><span class="o">.</span><span class="n">error</span> <span class="o">|=</span> <span class="n">NOT_FOUND</span>
</span></span><span class="line"><span class="cl">                <span class="n">found_all</span> <span class="o">=</span> <span class="kc">False</span>
</span></span><span class="line"><span class="cl">                <span class="k">continue</span>
</span></span><span class="line"><span class="cl">            <span class="k">for</span> <span class="n">unit</span> <span class="ow">in</span> <span class="n">matched</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">                <span class="k">if</span> <span class="n">unit</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">units</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">                    <span class="n">units</span> <span class="o">+=</span> <span class="p">[</span><span class="n">unit</span><span class="p">]</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">try_restart_units</span><span class="p">(</span><span class="n">units</span><span class="p">)</span> <span class="ow">and</span> <span class="n">found_all</span>
</span></span><span class="line"><span class="cl">    <span class="k">def</span> <span class="nf">try_restart_units</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">units</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">        <span class="s2">&#34;&#34;&#34; fails if any module fails to try-restart &#34;&#34;&#34;</span>
</span></span><span class="line"><span class="cl">        <span class="bp">self</span><span class="o">.</span><span class="n">wait_system</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">        <span class="n">done</span> <span class="o">=</span> <span class="kc">True</span>
</span></span><span class="line"><span class="cl">        <span class="k">for</span> <span class="n">unit</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">sortedAfter</span><span class="p">(</span><span class="n">units</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">            <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">try_restart_unit</span><span class="p">(</span><span class="n">unit</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">                <span class="n">done</span> <span class="o">=</span> <span class="kc">False</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="n">done</span>
</span></span><span class="line"><span class="cl">    <span class="k">def</span> <span class="nf">try_restart_unit</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">unit</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">        <span class="s2">&#34;&#34;&#34; only do &#39;restart&#39; if &#39;active&#39; &#34;&#34;&#34;</span>
</span></span><span class="line"><span class="cl">        <span class="n">conf</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">load_unit_conf</span><span class="p">(</span><span class="n">unit</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="n">conf</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">            <span class="n">logg</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&#34;Unit </span><span class="si">%s</span><span class="s2"> not found.&#34;</span><span class="p">,</span> <span class="n">unit</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">            <span class="k">return</span> <span class="kc">False</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">not_user_conf</span><span class="p">(</span><span class="n">conf</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">            <span class="n">logg</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&#34;Unit </span><span class="si">%s</span><span class="s2"> not for --user mode&#34;</span><span class="p">,</span> <span class="n">unit</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">            <span class="k">return</span> <span class="kc">False</span>
</span></span><span class="line"><span class="cl">        <span class="k">with</span> <span class="n">waitlock</span><span class="p">(</span><span class="n">conf</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">            <span class="n">logg</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&#34; try-restart unit </span><span class="si">%s</span><span class="s2"> =&gt; </span><span class="si">%s</span><span class="s2">&#34;</span><span class="p">,</span> <span class="n">conf</span><span class="o">.</span><span class="n">name</span><span class="p">(),</span> <span class="n">strQ</span><span class="p">(</span><span class="n">conf</span><span class="o">.</span><span class="n">filename</span><span class="p">()))</span>
</span></span><span class="line"><span class="cl">            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">is_active_from</span><span class="p">(</span><span class="n">conf</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">                <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">do_restart_unit_from</span><span class="p">(</span><span class="n">conf</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="kc">True</span>
</span></span><span class="line"><span class="cl">    <span class="k">def</span> <span class="nf">reload_or_restart_modules</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">modules</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">        <span class="s2">&#34;&#34;&#34; [UNIT]... -- reload-or-restart these units &#34;&#34;&#34;</span>
</span></span><span class="line"><span class="cl">        <span class="n">found_all</span> <span class="o">=</span> <span class="kc">True</span>
</span></span><span class="line"><span class="cl">        <span class="n">units</span> <span class="o">=</span> <span class="p">[]</span>
</span></span><span class="line"><span class="cl">        <span class="k">for</span> <span class="n">module</span> <span class="ow">in</span> <span class="n">modules</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">            <span class="n">matched</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">match_units</span><span class="p">(</span><span class="n">to_list</span><span class="p">(</span><span class="n">module</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">            <span class="k">if</span> <span class="ow">not</span> <span class="n">matched</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">                <span class="n">logg</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&#34;Unit </span><span class="si">%s</span><span class="s2"> not found.&#34;</span><span class="p">,</span> <span class="n">unit_of</span><span class="p">(</span><span class="n">module</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">                <span class="bp">self</span><span class="o">.</span><span class="n">error</span> <span class="o">|=</span> <span class="n">NOT_FOUND</span>
</span></span><span class="line"><span class="cl">                <span class="n">found_all</span> <span class="o">=</span> <span class="kc">False</span>
</span></span><span class="line"><span class="cl">                <span class="k">continue</span>
</span></span><span class="line"><span class="cl">            <span class="k">for</span> <span class="n">unit</span> <span class="ow">in</span> <span class="n">matched</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">                <span class="k">if</span> <span class="n">unit</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">units</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">                    <span class="n">units</span> <span class="o">+=</span> <span class="p">[</span><span class="n">unit</span><span class="p">]</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">reload_or_restart_units</span><span class="p">(</span><span class="n">units</span><span class="p">)</span> <span class="ow">and</span> <span class="n">found_all</span>
</span></span><span class="line"><span class="cl">    <span class="k">def</span> <span class="nf">reload_or_restart_units</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">units</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">        <span class="s2">&#34;&#34;&#34; fails if any unit does not reload-or-restart &#34;&#34;&#34;</span>
</span></span><span class="line"><span class="cl">        <span class="bp">self</span><span class="o">.</span><span class="n">wait_system</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">        <span class="n">done</span> <span class="o">=</span> <span class="kc">True</span>
</span></span><span class="line"><span class="cl">        <span class="k">for</span> <span class="n">unit</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">sortedAfter</span><span class="p">(</span><span class="n">units</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">            <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">reload_or_restart_unit</span><span class="p">(</span><span class="n">unit</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">                <span class="n">done</span> <span class="o">=</span> <span class="kc">False</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="n">done</span>
</span></span><span class="line"><span class="cl">    <span class="k">def</span> <span class="nf">reload_or_restart_unit</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">unit</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">        <span class="s2">&#34;&#34;&#34; do &#39;reload&#39; if specified, otherwise do &#39;restart&#39; &#34;&#34;&#34;</span>
</span></span><span class="line"><span class="cl">        <span class="n">conf</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">load_unit_conf</span><span class="p">(</span><span class="n">unit</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="n">conf</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">            <span class="n">logg</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&#34;Unit </span><span class="si">%s</span><span class="s2"> not found.&#34;</span><span class="p">,</span> <span class="n">unit</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">            <span class="k">return</span> <span class="kc">False</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">not_user_conf</span><span class="p">(</span><span class="n">conf</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">            <span class="n">logg</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&#34;Unit </span><span class="si">%s</span><span class="s2"> not for --user mode&#34;</span><span class="p">,</span> <span class="n">unit</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">            <span class="k">return</span> <span class="kc">False</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">reload_or_restart_unit_from</span><span class="p">(</span><span class="n">conf</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="k">def</span> <span class="nf">reload_or_restart_unit_from</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">conf</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">        <span class="s2">&#34;&#34;&#34; do &#39;reload&#39; if specified, otherwise do &#39;restart&#39; &#34;&#34;&#34;</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="ow">not</span> <span class="n">conf</span><span class="p">:</span> <span class="k">return</span> <span class="kc">False</span>
</span></span><span class="line"><span class="cl">        <span class="k">with</span> <span class="n">waitlock</span><span class="p">(</span><span class="n">conf</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">            <span class="n">logg</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&#34; reload-or-restart unit </span><span class="si">%s</span><span class="s2"> =&gt; </span><span class="si">%s</span><span class="s2">&#34;</span><span class="p">,</span> <span class="n">conf</span><span class="o">.</span><span class="n">name</span><span class="p">(),</span> <span class="n">strQ</span><span class="p">(</span><span class="n">conf</span><span class="o">.</span><span class="n">filename</span><span class="p">()))</span>
</span></span><span class="line"><span class="cl">            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">do_reload_or_restart_unit_from</span><span class="p">(</span><span class="n">conf</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="k">def</span> <span class="nf">do_reload_or_restart_unit_from</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">conf</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">is_active_from</span><span class="p">(</span><span class="n">conf</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">            <span class="c1"># try: self.stop_unit_from(conf)</span>
</span></span><span class="line"><span class="cl">            <span class="c1"># except Exception as e: pass</span>
</span></span><span class="line"><span class="cl">            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">do_start_unit_from</span><span class="p">(</span><span class="n">conf</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="k">elif</span> <span class="n">conf</span><span class="o">.</span><span class="n">getlist</span><span class="p">(</span><span class="n">Service</span><span class="p">,</span> <span class="s2">&#34;ExecReload&#34;</span><span class="p">,</span> <span class="p">[]):</span>
</span></span><span class="line"><span class="cl">            <span class="n">logg</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&#34;found service to have ExecReload -&gt; &#39;reload&#39;&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">do_reload_unit_from</span><span class="p">(</span><span class="n">conf</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="k">else</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">            <span class="n">logg</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&#34;found service without ExecReload -&gt; &#39;restart&#39;&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">do_restart_unit_from</span><span class="p">(</span><span class="n">conf</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="k">def</span> <span class="nf">reload_or_try_restart_modules</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">modules</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">        <span class="s2">&#34;&#34;&#34; [UNIT]... -- reload-or-try-restart these units &#34;&#34;&#34;</span>
</span></span><span class="line"><span class="cl">        <span class="n">found_all</span> <span class="o">=</span> <span class="kc">True</span>
</span></span><span class="line"><span class="cl">        <span class="n">units</span> <span class="o">=</span> <span class="p">[]</span>
</span></span><span class="line"><span class="cl">        <span class="k">for</span> <span class="n">module</span> <span class="ow">in</span> <span class="n">modules</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">            <span class="n">matched</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">match_units</span><span class="p">(</span><span class="n">to_list</span><span class="p">(</span><span class="n">module</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">            <span class="k">if</span> <span class="ow">not</span> <span class="n">matched</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">                <span class="n">logg</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&#34;Unit </span><span class="si">%s</span><span class="s2"> not found.&#34;</span><span class="p">,</span> <span class="n">unit_of</span><span class="p">(</span><span class="n">module</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">                <span class="bp">self</span><span class="o">.</span><span class="n">error</span> <span class="o">|=</span> <span class="n">NOT_FOUND</span>
</span></span><span class="line"><span class="cl">                <span class="n">found_all</span> <span class="o">=</span> <span class="kc">False</span>
</span></span><span class="line"><span class="cl">                <span class="k">continue</span>
</span></span><span class="line"><span class="cl">            <span class="k">for</span> <span class="n">unit</span> <span class="ow">in</span> <span class="n">matched</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">                <span class="k">if</span> <span class="n">unit</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">units</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">                    <span class="n">units</span> <span class="o">+=</span> <span class="p">[</span><span class="n">unit</span><span class="p">]</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">reload_or_try_restart_units</span><span class="p">(</span><span class="n">units</span><span class="p">)</span> <span class="ow">and</span> <span class="n">found_all</span>
</span></span><span class="line"><span class="cl">    <span class="k">def</span> <span class="nf">reload_or_try_restart_units</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">units</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">        <span class="s2">&#34;&#34;&#34; fails if any unit fails to reload-or-try-restart &#34;&#34;&#34;</span>
</span></span><span class="line"><span class="cl">        <span class="bp">self</span><span class="o">.</span><span class="n">wait_system</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">        <span class="n">done</span> <span class="o">=</span> <span class="kc">True</span>
</span></span><span class="line"><span class="cl">        <span class="k">for</span> <span class="n">unit</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">sortedAfter</span><span class="p">(</span><span class="n">units</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">            <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">reload_or_try_restart_unit</span><span class="p">(</span><span class="n">unit</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">                <span class="n">done</span> <span class="o">=</span> <span class="kc">False</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="n">done</span>
</span></span><span class="line"><span class="cl">    <span class="k">def</span> <span class="nf">reload_or_try_restart_unit</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">unit</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">        <span class="n">conf</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">load_unit_conf</span><span class="p">(</span><span class="n">unit</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="n">conf</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">            <span class="n">logg</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&#34;Unit </span><span class="si">%s</span><span class="s2"> not found.&#34;</span><span class="p">,</span> <span class="n">unit</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">            <span class="k">return</span> <span class="kc">False</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">not_user_conf</span><span class="p">(</span><span class="n">conf</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">            <span class="n">logg</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&#34;Unit </span><span class="si">%s</span><span class="s2"> not for --user mode&#34;</span><span class="p">,</span> <span class="n">unit</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">            <span class="k">return</span> <span class="kc">False</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">reload_or_try_restart_unit_from</span><span class="p">(</span><span class="n">conf</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="k">def</span> <span class="nf">reload_or_try_restart_unit_from</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">conf</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">        <span class="k">with</span> <span class="n">waitlock</span><span class="p">(</span><span class="n">conf</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">            <span class="n">logg</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&#34; reload-or-try-restart unit </span><span class="si">%s</span><span class="s2"> =&gt; </span><span class="si">%s</span><span class="s2">&#34;</span><span class="p">,</span> <span class="n">conf</span><span class="o">.</span><span class="n">name</span><span class="p">(),</span> <span class="n">strQ</span><span class="p">(</span><span class="n">conf</span><span class="o">.</span><span class="n">filename</span><span class="p">()))</span>
</span></span><span class="line"><span class="cl">            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">do_reload_or_try_restart_unit_from</span><span class="p">(</span><span class="n">conf</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="k">def</span> <span class="nf">do_reload_or_try_restart_unit_from</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">conf</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="n">conf</span><span class="o">.</span><span class="n">getlist</span><span class="p">(</span><span class="n">Service</span><span class="p">,</span> <span class="s2">&#34;ExecReload&#34;</span><span class="p">,</span> <span class="p">[]):</span>
</span></span><span class="line"><span class="cl">            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">do_reload_unit_from</span><span class="p">(</span><span class="n">conf</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="k">elif</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">is_active_from</span><span class="p">(</span><span class="n">conf</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">            <span class="k">return</span> <span class="kc">True</span>
</span></span><span class="line"><span class="cl">        <span class="k">else</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">do_restart_unit_from</span><span class="p">(</span><span class="n">conf</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="k">def</span> <span class="nf">kill_modules</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">modules</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">        <span class="s2">&#34;&#34;&#34; [UNIT]... -- kill these units &#34;&#34;&#34;</span>
</span></span><span class="line"><span class="cl">        <span class="n">found_all</span> <span class="o">=</span> <span class="kc">True</span>
</span></span><span class="line"><span class="cl">        <span class="n">units</span> <span class="o">=</span> <span class="p">[]</span>
</span></span><span class="line"><span class="cl">        <span class="k">for</span> <span class="n">module</span> <span class="ow">in</span> <span class="n">modules</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">            <span class="n">matched</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">match_units</span><span class="p">(</span><span class="n">to_list</span><span class="p">(</span><span class="n">module</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">            <span class="k">if</span> <span class="ow">not</span> <span class="n">matched</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">                <span class="n">logg</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&#34;Unit </span><span class="si">%s</span><span class="s2"> not found.&#34;</span><span class="p">,</span> <span class="n">unit_of</span><span class="p">(</span><span class="n">module</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">                <span class="c1"># self.error |= NOT_FOUND</span>
</span></span><span class="line"><span class="cl">                <span class="n">found_all</span> <span class="o">=</span> <span class="kc">False</span>
</span></span><span class="line"><span class="cl">                <span class="k">continue</span>
</span></span><span class="line"><span class="cl">            <span class="k">for</span> <span class="n">unit</span> <span class="ow">in</span> <span class="n">matched</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">                <span class="k">if</span> <span class="n">unit</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">units</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">                    <span class="n">units</span> <span class="o">+=</span> <span class="p">[</span><span class="n">unit</span><span class="p">]</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">kill_units</span><span class="p">(</span><span class="n">units</span><span class="p">)</span> <span class="ow">and</span> <span class="n">found_all</span>
</span></span><span class="line"><span class="cl">    <span class="k">def</span> <span class="nf">kill_units</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">units</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">        <span class="s2">&#34;&#34;&#34; fails if any unit could not be killed &#34;&#34;&#34;</span>
</span></span><span class="line"><span class="cl">        <span class="bp">self</span><span class="o">.</span><span class="n">wait_system</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">        <span class="n">done</span> <span class="o">=</span> <span class="kc">True</span>
</span></span><span class="line"><span class="cl">        <span class="k">for</span> <span class="n">unit</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">sortedBefore</span><span class="p">(</span><span class="n">units</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">            <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">kill_unit</span><span class="p">(</span><span class="n">unit</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">                <span class="n">done</span> <span class="o">=</span> <span class="kc">False</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="n">done</span>
</span></span><span class="line"><span class="cl">    <span class="k">def</span> <span class="nf">kill_unit</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">unit</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">        <span class="n">conf</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">load_unit_conf</span><span class="p">(</span><span class="n">unit</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="n">conf</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">            <span class="n">logg</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&#34;Unit </span><span class="si">%s</span><span class="s2"> not found.&#34;</span><span class="p">,</span> <span class="n">unit</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">            <span class="k">return</span> <span class="kc">False</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">not_user_conf</span><span class="p">(</span><span class="n">conf</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">            <span class="n">logg</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&#34;Unit </span><span class="si">%s</span><span class="s2"> not for --user mode&#34;</span><span class="p">,</span> <span class="n">unit</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">            <span class="k">return</span> <span class="kc">False</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">kill_unit_from</span><span class="p">(</span><span class="n">conf</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="k">def</span> <span class="nf">kill_unit_from</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">conf</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="ow">not</span> <span class="n">conf</span><span class="p">:</span> <span class="k">return</span> <span class="kc">False</span>
</span></span><span class="line"><span class="cl">        <span class="k">with</span> <span class="n">waitlock</span><span class="p">(</span><span class="n">conf</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">            <span class="n">logg</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&#34; kill unit </span><span class="si">%s</span><span class="s2"> =&gt; </span><span class="si">%s</span><span class="s2">&#34;</span><span class="p">,</span> <span class="n">conf</span><span class="o">.</span><span class="n">name</span><span class="p">(),</span> <span class="n">strQ</span><span class="p">(</span><span class="n">conf</span><span class="o">.</span><span class="n">filename</span><span class="p">()))</span>
</span></span><span class="line"><span class="cl">            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">do_kill_unit_from</span><span class="p">(</span><span class="n">conf</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="k">def</span> <span class="nf">do_kill_unit_from</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">conf</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">        <span class="n">started</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">        <span class="n">doSendSIGKILL</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_SendSIGKILL</span><span class="p">(</span><span class="n">conf</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="n">doSendSIGHUP</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_SendSIGHUP</span><span class="p">(</span><span class="n">conf</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="n">useKillMode</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_KillMode</span><span class="p">(</span><span class="n">conf</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="n">useKillSignal</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_KillSignal</span><span class="p">(</span><span class="n">conf</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="n">kill_signal</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">signal</span><span class="p">,</span> <span class="n">useKillSignal</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="n">timeout</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_TimeoutStopSec</span><span class="p">(</span><span class="n">conf</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="n">status_file</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_status_file_from</span><span class="p">(</span><span class="n">conf</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="n">size</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">status_file</span><span class="p">)</span> <span class="ow">and</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">getsize</span><span class="p">(</span><span class="n">status_file</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="n">logg</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&#34;STATUS </span><span class="si">%s</span><span class="s2"> </span><span class="si">%s</span><span class="s2">&#34;</span><span class="p">,</span> <span class="n">status_file</span><span class="p">,</span> <span class="n">size</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="n">mainpid</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">read_mainpid_from</span><span class="p">(</span><span class="n">conf</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="bp">self</span><span class="o">.</span><span class="n">clean_status_from</span><span class="p">(</span><span class="n">conf</span><span class="p">)</span> <span class="c1"># clear RemainAfterExit and TimeoutStartSec</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="ow">not</span> <span class="n">mainpid</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">            <span class="k">if</span> <span class="n">useKillMode</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&#34;control-group&#34;</span><span class="p">]:</span>
</span></span><span class="line"><span class="cl">                <span class="n">logg</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&#34;no main PID </span><span class="si">%s</span><span class="s2">&#34;</span><span class="p">,</span> <span class="n">strQ</span><span class="p">(</span><span class="n">conf</span><span class="o">.</span><span class="n">filename</span><span class="p">()))</span>
</span></span><span class="line"><span class="cl">                <span class="n">logg</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&#34;and there is no control-group here&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">            <span class="k">else</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">                <span class="n">logg</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&#34;no main PID </span><span class="si">%s</span><span class="s2">&#34;</span><span class="p">,</span> <span class="n">strQ</span><span class="p">(</span><span class="n">conf</span><span class="o">.</span><span class="n">filename</span><span class="p">()))</span>
</span></span><span class="line"><span class="cl">            <span class="k">return</span> <span class="kc">False</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="ow">not</span> <span class="n">pid_exists</span><span class="p">(</span><span class="n">mainpid</span><span class="p">)</span> <span class="ow">or</span> <span class="n">pid_zombie</span><span class="p">(</span><span class="n">mainpid</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">            <span class="n">logg</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&#34;ignoring children when mainpid is already dead&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">            <span class="c1"># because we list child processes, not processes in control-group</span>
</span></span><span class="line"><span class="cl">            <span class="k">return</span> <span class="kc">True</span>
</span></span><span class="line"><span class="cl">        <span class="n">pidlist</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">pidlist_of</span><span class="p">(</span><span class="n">mainpid</span><span class="p">)</span> <span class="c1"># here</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="n">pid_exists</span><span class="p">(</span><span class="n">mainpid</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">            <span class="n">logg</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&#34;stop kill PID </span><span class="si">%s</span><span class="s2">&#34;</span><span class="p">,</span> <span class="n">mainpid</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">            <span class="bp">self</span><span class="o">.</span><span class="n">_kill_pid</span><span class="p">(</span><span class="n">mainpid</span><span class="p">,</span> <span class="n">kill_signal</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="n">useKillMode</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&#34;control-group&#34;</span><span class="p">]:</span>
</span></span><span class="line"><span class="cl">            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">pidlist</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">                <span class="n">logg</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&#34;stop control-group PIDs </span><span class="si">%s</span><span class="s2">&#34;</span><span class="p">,</span> <span class="n">pidlist</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">            <span class="k">for</span> <span class="n">pid</span> <span class="ow">in</span> <span class="n">pidlist</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">                <span class="k">if</span> <span class="n">pid</span> <span class="o">!=</span> <span class="n">mainpid</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">                    <span class="bp">self</span><span class="o">.</span><span class="n">_kill_pid</span><span class="p">(</span><span class="n">pid</span><span class="p">,</span> <span class="n">kill_signal</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="n">doSendSIGHUP</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">            <span class="n">logg</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&#34;stop SendSIGHUP to PIDs </span><span class="si">%s</span><span class="s2">&#34;</span><span class="p">,</span> <span class="n">pidlist</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">            <span class="k">for</span> <span class="n">pid</span> <span class="ow">in</span> <span class="n">pidlist</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">                <span class="bp">self</span><span class="o">.</span><span class="n">_kill_pid</span><span class="p">(</span><span class="n">pid</span><span class="p">,</span> <span class="n">signal</span><span class="o">.</span><span class="n">SIGHUP</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="c1"># wait for the processes to have exited</span>
</span></span><span class="line"><span class="cl">        <span class="k">while</span> <span class="kc">True</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">            <span class="n">dead</span> <span class="o">=</span> <span class="kc">True</span>
</span></span><span class="line"><span class="cl">            <span class="k">for</span> <span class="n">pid</span> <span class="ow">in</span> <span class="n">pidlist</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">                <span class="k">if</span> <span class="n">pid_exists</span><span class="p">(</span><span class="n">pid</span><span class="p">)</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">pid_zombie</span><span class="p">(</span><span class="n">pid</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">                    <span class="n">dead</span> <span class="o">=</span> <span class="kc">False</span>
</span></span><span class="line"><span class="cl">                    <span class="k">break</span>
</span></span><span class="line"><span class="cl">            <span class="k">if</span> <span class="n">dead</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">                <span class="k">break</span>
</span></span><span class="line"><span class="cl">            <span class="k">if</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span> <span class="o">&gt;</span> <span class="n">started</span> <span class="o">+</span> <span class="n">timeout</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">                <span class="n">logg</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&#34;service PIDs not stopped after </span><span class="si">%s</span><span class="s2">&#34;</span><span class="p">,</span> <span class="n">timeout</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">                <span class="k">break</span>
</span></span><span class="line"><span class="cl">            <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="c1"># until TimeoutStopSec</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="n">dead</span> <span class="ow">or</span> <span class="ow">not</span> <span class="n">doSendSIGKILL</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">            <span class="n">logg</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&#34;done kill PID </span><span class="si">%s</span><span class="s2"> </span><span class="si">%s</span><span class="s2">&#34;</span><span class="p">,</span> <span class="n">mainpid</span><span class="p">,</span> <span class="n">dead</span> <span class="ow">and</span> <span class="s2">&#34;OK&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">            <span class="k">return</span> <span class="n">dead</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="n">useKillMode</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&#34;control-group&#34;</span><span class="p">,</span> <span class="s2">&#34;mixed&#34;</span><span class="p">]:</span>
</span></span><span class="line"><span class="cl">            <span class="n">logg</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&#34;hard kill PIDs </span><span class="si">%s</span><span class="s2">&#34;</span><span class="p">,</span> <span class="n">pidlist</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">            <span class="k">for</span> <span class="n">pid</span> <span class="ow">in</span> <span class="n">pidlist</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">                <span class="k">if</span> <span class="n">pid</span> <span class="o">!=</span> <span class="n">mainpid</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">                    <span class="bp">self</span><span class="o">.</span><span class="n">_kill_pid</span><span class="p">(</span><span class="n">pid</span><span class="p">,</span> <span class="n">signal</span><span class="o">.</span><span class="n">SIGKILL</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">            <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="n">MinimumYield</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="c1"># useKillMode in [ &#34;control-group&#34;, &#34;mixed&#34;, &#34;process&#34; ]</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="n">pid_exists</span><span class="p">(</span><span class="n">mainpid</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">            <span class="n">logg</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&#34;hard kill PID </span><span class="si">%s</span><span class="s2">&#34;</span><span class="p">,</span> <span class="n">mainpid</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">            <span class="bp">self</span><span class="o">.</span><span class="n">_kill_pid</span><span class="p">(</span><span class="n">mainpid</span><span class="p">,</span> <span class="n">signal</span><span class="o">.</span><span class="n">SIGKILL</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">            <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="n">MinimumYield</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="n">dead</span> <span class="o">=</span> <span class="ow">not</span> <span class="n">pid_exists</span><span class="p">(</span><span class="n">mainpid</span><span class="p">)</span> <span class="ow">or</span> <span class="n">pid_zombie</span><span class="p">(</span><span class="n">mainpid</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="n">logg</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&#34;done hard kill PID </span><span class="si">%s</span><span class="s2"> </span><span class="si">%s</span><span class="s2">&#34;</span><span class="p">,</span> <span class="n">mainpid</span><span class="p">,</span> <span class="n">dead</span> <span class="ow">and</span> <span class="s2">&#34;OK&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="n">dead</span>
</span></span><span class="line"><span class="cl">    <span class="k">def</span> <span class="nf">_kill_pid</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">pid</span><span class="p">,</span> <span class="n">kill_signal</span> <span class="o">=</span> <span class="kc">None</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">        <span class="k">try</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">            <span class="n">sig</span> <span class="o">=</span> <span class="n">kill_signal</span> <span class="ow">or</span> <span class="n">signal</span><span class="o">.</span><span class="n">SIGTERM</span>
</span></span><span class="line"><span class="cl">            <span class="n">os</span><span class="o">.</span><span class="n">kill</span><span class="p">(</span><span class="n">pid</span><span class="p">,</span> <span class="n">sig</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="k">except</span> <span class="ne">OSError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">            <span class="k">if</span> <span class="n">e</span><span class="o">.</span><span class="n">errno</span> <span class="o">==</span> <span class="n">errno</span><span class="o">.</span><span class="n">ESRCH</span> <span class="ow">or</span> <span class="n">e</span><span class="o">.</span><span class="n">errno</span> <span class="o">==</span> <span class="n">errno</span><span class="o">.</span><span class="n">ENOENT</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">                <span class="n">logg</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&#34;kill PID </span><span class="si">%s</span><span class="s2"> =&gt; No such process&#34;</span><span class="p">,</span> <span class="n">pid</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">                <span class="k">return</span> <span class="kc">True</span>
</span></span><span class="line"><span class="cl">            <span class="k">else</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">                <span class="n">logg</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&#34;kill PID </span><span class="si">%s</span><span class="s2"> =&gt; </span><span class="si">%s</span><span class="s2">&#34;</span><span class="p">,</span> <span class="n">pid</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">                <span class="k">return</span> <span class="kc">False</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="ow">not</span> <span class="n">pid_exists</span><span class="p">(</span><span class="n">pid</span><span class="p">)</span> <span class="ow">or</span> <span class="n">pid_zombie</span><span class="p">(</span><span class="n">pid</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="k">def</span> <span class="nf">is_active_modules</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">modules</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">        <span class="s2">&#34;&#34;&#34; [UNIT].. -- check if these units are in active state
</span></span></span><span class="line"><span class="cl"><span class="s2">        implements True if all is-active = True &#34;&#34;&#34;</span>
</span></span><span class="line"><span class="cl">        <span class="c1"># systemctl returns multiple lines, one for each argument</span>
</span></span><span class="line"><span class="cl">        <span class="c1">#   &#34;active&#34; when is_active</span>
</span></span><span class="line"><span class="cl">        <span class="c1">#   &#34;inactive&#34; when not is_active</span>
</span></span><span class="line"><span class="cl">        <span class="c1">#   &#34;unknown&#34; when not enabled</span>
</span></span><span class="line"><span class="cl">        <span class="c1"># The return code is set to</span>
</span></span><span class="line"><span class="cl">        <span class="c1">#   0 when &#34;active&#34;</span>
</span></span><span class="line"><span class="cl">        <span class="c1">#   1 when unit is not found</span>
</span></span><span class="line"><span class="cl">        <span class="c1">#   3 when any &#34;inactive&#34; or &#34;unknown&#34;</span>
</span></span><span class="line"><span class="cl">        <span class="c1"># However: # TODO! BUG in original systemctl!</span>
</span></span><span class="line"><span class="cl">        <span class="c1">#   documentation says &#34; exit code 0 if at least one is active&#34;</span>
</span></span><span class="line"><span class="cl">        <span class="c1">#   and &#34;Unless --quiet is specified, print the unit state&#34;</span>
</span></span><span class="line"><span class="cl">        <span class="c1"># |</span>
</span></span><span class="line"><span class="cl">        <span class="n">units</span> <span class="o">=</span> <span class="p">[]</span>
</span></span><span class="line"><span class="cl">        <span class="n">results</span> <span class="o">=</span> <span class="p">[]</span>
</span></span><span class="line"><span class="cl">        <span class="k">for</span> <span class="n">module</span> <span class="ow">in</span> <span class="n">modules</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">            <span class="n">units</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">match_units</span><span class="p">(</span><span class="n">to_list</span><span class="p">(</span><span class="n">module</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">            <span class="k">if</span> <span class="ow">not</span> <span class="n">units</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">                <span class="n">logg</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&#34;Unit </span><span class="si">%s</span><span class="s2"> not found.&#34;</span><span class="p">,</span> <span class="n">unit_of</span><span class="p">(</span><span class="n">module</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">                <span class="c1"># self.error |= NOT_FOUND</span>
</span></span><span class="line"><span class="cl">                <span class="bp">self</span><span class="o">.</span><span class="n">error</span> <span class="o">|=</span> <span class="n">NOT_ACTIVE</span>
</span></span><span class="line"><span class="cl">                <span class="n">results</span> <span class="o">+=</span> <span class="p">[</span><span class="s2">&#34;inactive&#34;</span><span class="p">]</span>
</span></span><span class="line"><span class="cl">                <span class="k">continue</span>
</span></span><span class="line"><span class="cl">            <span class="k">for</span> <span class="n">unit</span> <span class="ow">in</span> <span class="n">units</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">                <span class="n">active</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_active_unit</span><span class="p">(</span><span class="n">unit</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">                <span class="n">enabled</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">enabled_unit</span><span class="p">(</span><span class="n">unit</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">                <span class="k">if</span> <span class="n">enabled</span> <span class="o">!=</span> <span class="s2">&#34;enabled&#34;</span> <span class="ow">and</span> <span class="n">ACTIVE_IF_ENABLED</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">                    <span class="n">active</span> <span class="o">=</span> <span class="s2">&#34;inactive&#34;</span> <span class="c1"># &#34;unknown&#34;</span>
</span></span><span class="line"><span class="cl">                <span class="n">results</span> <span class="o">+=</span> <span class="p">[</span><span class="n">active</span><span class="p">]</span>
</span></span><span class="line"><span class="cl">                <span class="k">break</span>
</span></span><span class="line"><span class="cl">        <span class="c1"># how it should work:</span>
</span></span><span class="line"><span class="cl">        <span class="n">status</span> <span class="o">=</span> <span class="s2">&#34;active&#34;</span> <span class="ow">in</span> <span class="n">results</span>
</span></span><span class="line"><span class="cl">        <span class="c1"># how &#39;systemctl&#39; works:</span>
</span></span><span class="line"><span class="cl">        <span class="n">non_active</span> <span class="o">=</span> <span class="p">[</span><span class="n">result</span> <span class="k">for</span> <span class="n">result</span> <span class="ow">in</span> <span class="n">results</span> <span class="k">if</span> <span class="n">result</span> <span class="o">!=</span> <span class="s2">&#34;active&#34;</span><span class="p">]</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="n">non_active</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">            <span class="bp">self</span><span class="o">.</span><span class="n">error</span> <span class="o">|=</span> <span class="n">NOT_ACTIVE</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="n">non_active</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">            <span class="bp">self</span><span class="o">.</span><span class="n">error</span> <span class="o">|=</span> <span class="n">NOT_OK</span> <span class="c1"># status</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="n">_quiet</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">            <span class="k">return</span> <span class="p">[]</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="n">results</span>
</span></span><span class="line"><span class="cl">    <span class="k">def</span> <span class="nf">is_active_from</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">conf</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">        <span class="s2">&#34;&#34;&#34; used in try-restart/other commands to check if needed. &#34;&#34;&#34;</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="ow">not</span> <span class="n">conf</span><span class="p">:</span> <span class="k">return</span> <span class="kc">False</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_active_from</span><span class="p">(</span><span class="n">conf</span><span class="p">)</span> <span class="o">==</span> <span class="s2">&#34;active&#34;</span>
</span></span><span class="line"><span class="cl">    <span class="k">def</span> <span class="nf">active_pid_from</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">conf</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="ow">not</span> <span class="n">conf</span><span class="p">:</span> <span class="k">return</span> <span class="kc">False</span>
</span></span><span class="line"><span class="cl">        <span class="n">pid</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">read_mainpid_from</span><span class="p">(</span><span class="n">conf</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">is_active_pid</span><span class="p">(</span><span class="n">pid</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="k">def</span> <span class="nf">is_active_pid</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">pid</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">        <span class="s2">&#34;&#34;&#34; returns pid if the pid is still an active process &#34;&#34;&#34;</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="n">pid</span> <span class="ow">and</span> <span class="n">pid_exists</span><span class="p">(</span><span class="n">pid</span><span class="p">)</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">pid_zombie</span><span class="p">(</span><span class="n">pid</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">            <span class="k">return</span> <span class="n">pid</span> <span class="c1"># usually a string (not null)</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="kc">None</span>
</span></span><span class="line"><span class="cl">    <span class="k">def</span> <span class="nf">get_active_unit</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">unit</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">        <span class="s2">&#34;&#34;&#34; returns &#39;active&#39; &#39;inactive&#39; &#39;failed&#39; &#39;unknown&#39; &#34;&#34;&#34;</span>
</span></span><span class="line"><span class="cl">        <span class="n">conf</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">load_unit_conf</span><span class="p">(</span><span class="n">unit</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="ow">not</span> <span class="n">conf</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">            <span class="n">logg</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&#34;Unit </span><span class="si">%s</span><span class="s2"> not found.&#34;</span><span class="p">,</span> <span class="n">unit</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">            <span class="k">return</span> <span class="s2">&#34;unknown&#34;</span>
</span></span><span class="line"><span class="cl">        <span class="k">else</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_active_from</span><span class="p">(</span><span class="n">conf</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="k">def</span> <span class="nf">get_active_from</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">conf</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="n">conf</span><span class="o">.</span><span class="n">name</span><span class="p">()</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s2">&#34;.service&#34;</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_active_service_from</span><span class="p">(</span><span class="n">conf</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="k">elif</span> <span class="n">conf</span><span class="o">.</span><span class="n">name</span><span class="p">()</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s2">&#34;.socket&#34;</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">            <span class="n">service_unit</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_socket_service_from</span><span class="p">(</span><span class="n">conf</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">            <span class="n">service_conf</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">load_unit_conf</span><span class="p">(</span><span class="n">service_unit</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_active_service_from</span><span class="p">(</span><span class="n">service_conf</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="k">elif</span> <span class="n">conf</span><span class="o">.</span><span class="n">name</span><span class="p">()</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s2">&#34;.target&#34;</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_active_target_from</span><span class="p">(</span><span class="n">conf</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="k">else</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">            <span class="n">logg</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&#34;is-active not implemented for unit type: </span><span class="si">%s</span><span class="s2">&#34;</span><span class="p">,</span> <span class="n">conf</span><span class="o">.</span><span class="n">name</span><span class="p">())</span>
</span></span><span class="line"><span class="cl">            <span class="k">return</span> <span class="s2">&#34;unknown&#34;</span> <span class="c1"># TODO: &#34;inactive&#34; ?</span>
</span></span><span class="line"><span class="cl">    <span class="k">def</span> <span class="nf">get_active_service_from</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">conf</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">        <span class="s2">&#34;&#34;&#34; returns &#39;active&#39; &#39;inactive&#39; &#39;failed&#39; &#39;unknown&#39; &#34;&#34;&#34;</span>
</span></span><span class="line"><span class="cl">        <span class="c1"># used in try-restart/other commands to check if needed.</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="ow">not</span> <span class="n">conf</span><span class="p">:</span> <span class="k">return</span> <span class="s2">&#34;unknown&#34;</span>
</span></span><span class="line"><span class="cl">        <span class="n">pid_file</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">pid_file_from</span><span class="p">(</span><span class="n">conf</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="n">pid_file</span><span class="p">:</span> <span class="c1"># application PIDFile</span>
</span></span><span class="line"><span class="cl">            <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">pid_file</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">                <span class="k">return</span> <span class="s2">&#34;inactive&#34;</span>
</span></span><span class="line"><span class="cl">        <span class="n">status_file</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_status_file_from</span><span class="p">(</span><span class="n">conf</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">getsize</span><span class="p">(</span><span class="n">status_file</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">            <span class="n">state</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_status_from</span><span class="p">(</span><span class="n">conf</span><span class="p">,</span> <span class="s2">&#34;ActiveState&#34;</span><span class="p">,</span> <span class="s2">&#34;&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">            <span class="k">if</span> <span class="n">state</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">                <span class="k">if</span> <span class="n">DEBUG_STATUS</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">                    <span class="n">logg</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&#34;get_status_from </span><span class="si">%s</span><span class="s2"> =&gt; </span><span class="si">%s</span><span class="s2">&#34;</span><span class="p">,</span> <span class="n">conf</span><span class="o">.</span><span class="n">name</span><span class="p">(),</span> <span class="n">state</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">                <span class="k">return</span> <span class="n">state</span>
</span></span><span class="line"><span class="cl">        <span class="n">pid</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">read_mainpid_from</span><span class="p">(</span><span class="n">conf</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="n">DEBUG_STATUS</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">            <span class="n">logg</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&#34;pid_file &#39;</span><span class="si">%s</span><span class="s2">&#39; =&gt; PID </span><span class="si">%s</span><span class="s2">&#34;</span><span class="p">,</span> <span class="n">pid_file</span> <span class="ow">or</span> <span class="n">status_file</span><span class="p">,</span> <span class="n">strE</span><span class="p">(</span><span class="n">pid</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="n">pid</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">            <span class="k">if</span> <span class="ow">not</span> <span class="n">pid_exists</span><span class="p">(</span><span class="n">pid</span><span class="p">)</span> <span class="ow">or</span> <span class="n">pid_zombie</span><span class="p">(</span><span class="n">pid</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">                <span class="k">return</span> <span class="s2">&#34;failed&#34;</span>
</span></span><span class="line"><span class="cl">            <span class="k">return</span> <span class="s2">&#34;active&#34;</span>
</span></span><span class="line"><span class="cl">        <span class="k">else</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">            <span class="k">return</span> <span class="s2">&#34;inactive&#34;</span>
</span></span><span class="line"><span class="cl">    <span class="k">def</span> <span class="nf">get_active_target_from</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">conf</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">        <span class="s2">&#34;&#34;&#34; returns &#39;active&#39; &#39;inactive&#39; &#39;failed&#39; &#39;unknown&#39; &#34;&#34;&#34;</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_active_target</span><span class="p">(</span><span class="n">conf</span><span class="o">.</span><span class="n">name</span><span class="p">())</span>
</span></span><span class="line"><span class="cl">    <span class="k">def</span> <span class="nf">get_active_target</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">target</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">        <span class="s2">&#34;&#34;&#34; returns &#39;active&#39; &#39;inactive&#39; &#39;failed&#39; &#39;unknown&#39; &#34;&#34;&#34;</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="n">target</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_active_target_list</span><span class="p">():</span>
</span></span><span class="line"><span class="cl">            <span class="n">status</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">is_system_running</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">            <span class="k">if</span> <span class="n">status</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&#34;running&#34;</span><span class="p">]:</span>
</span></span><span class="line"><span class="cl">                <span class="k">return</span> <span class="s2">&#34;active&#34;</span>
</span></span><span class="line"><span class="cl">            <span class="k">return</span> <span class="s2">&#34;inactive&#34;</span>
</span></span><span class="line"><span class="cl">        <span class="k">else</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">            <span class="n">services</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">target_default_services</span><span class="p">(</span><span class="n">target</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">            <span class="n">result</span> <span class="o">=</span> <span class="s2">&#34;active&#34;</span>
</span></span><span class="line"><span class="cl">            <span class="k">for</span> <span class="n">service</span> <span class="ow">in</span> <span class="n">services</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">                <span class="n">conf</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">load_unit_conf</span><span class="p">(</span><span class="n">service</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">                <span class="k">if</span> <span class="n">conf</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">                    <span class="n">state</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_active_from</span><span class="p">(</span><span class="n">conf</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">                    <span class="k">if</span> <span class="n">state</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&#34;failed&#34;</span><span class="p">]:</span>
</span></span><span class="line"><span class="cl">                        <span class="n">result</span> <span class="o">=</span> <span class="n">state</span>
</span></span><span class="line"><span class="cl">                    <span class="k">elif</span> <span class="n">state</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&#34;active&#34;</span><span class="p">]:</span>
</span></span><span class="line"><span class="cl">                        <span class="n">result</span> <span class="o">=</span> <span class="n">state</span>
</span></span><span class="line"><span class="cl">            <span class="k">return</span> <span class="n">result</span>
</span></span><span class="line"><span class="cl">    <span class="k">def</span> <span class="nf">get_active_target_list</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">        <span class="n">current_target</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_default_target</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">        <span class="n">target_list</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_target_list</span><span class="p">(</span><span class="n">current_target</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="n">target_list</span> <span class="o">+=</span> <span class="p">[</span><span class="n">DefaultUnit</span><span class="p">]</span> <span class="c1"># upper end</span>
</span></span><span class="line"><span class="cl">        <span class="n">target_list</span> <span class="o">+=</span> <span class="p">[</span><span class="n">SysInitTarget</span><span class="p">]</span> <span class="c1"># lower end</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="n">target_list</span>
</span></span><span class="line"><span class="cl">    <span class="k">def</span> <span class="nf">get_substate_from</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">conf</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">        <span class="s2">&#34;&#34;&#34; returns &#39;running&#39; &#39;exited&#39; &#39;dead&#39; &#39;failed&#39; &#39;plugged&#39; &#39;mounted&#39; &#34;&#34;&#34;</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="ow">not</span> <span class="n">conf</span><span class="p">:</span> <span class="k">return</span> <span class="kc">None</span>
</span></span><span class="line"><span class="cl">        <span class="n">pid_file</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">pid_file_from</span><span class="p">(</span><span class="n">conf</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="n">pid_file</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">            <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">pid_file</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">                <span class="k">return</span> <span class="s2">&#34;dead&#34;</span>
</span></span><span class="line"><span class="cl">        <span class="n">status_file</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_status_file_from</span><span class="p">(</span><span class="n">conf</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">getsize</span><span class="p">(</span><span class="n">status_file</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">            <span class="n">state</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_status_from</span><span class="p">(</span><span class="n">conf</span><span class="p">,</span> <span class="s2">&#34;ActiveState&#34;</span><span class="p">,</span> <span class="s2">&#34;&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">            <span class="k">if</span> <span class="n">state</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">                <span class="k">if</span> <span class="n">state</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&#34;active&#34;</span><span class="p">]:</span>
</span></span><span class="line"><span class="cl">                    <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_status_from</span><span class="p">(</span><span class="n">conf</span><span class="p">,</span> <span class="s2">&#34;SubState&#34;</span><span class="p">,</span> <span class="s2">&#34;running&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">                <span class="k">else</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">                    <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_status_from</span><span class="p">(</span><span class="n">conf</span><span class="p">,</span> <span class="s2">&#34;SubState&#34;</span><span class="p">,</span> <span class="s2">&#34;dead&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="n">pid</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">read_mainpid_from</span><span class="p">(</span><span class="n">conf</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="n">DEBUG_STATUS</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">            <span class="n">logg</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&#34;pid_file &#39;</span><span class="si">%s</span><span class="s2">&#39; =&gt; PID </span><span class="si">%s</span><span class="s2">&#34;</span><span class="p">,</span> <span class="n">pid_file</span> <span class="ow">or</span> <span class="n">status_file</span><span class="p">,</span> <span class="n">strE</span><span class="p">(</span><span class="n">pid</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="n">pid</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">            <span class="k">if</span> <span class="ow">not</span> <span class="n">pid_exists</span><span class="p">(</span><span class="n">pid</span><span class="p">)</span> <span class="ow">or</span> <span class="n">pid_zombie</span><span class="p">(</span><span class="n">pid</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">                <span class="k">return</span> <span class="s2">&#34;failed&#34;</span>
</span></span><span class="line"><span class="cl">            <span class="k">return</span> <span class="s2">&#34;running&#34;</span>
</span></span><span class="line"><span class="cl">        <span class="k">else</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">            <span class="k">return</span> <span class="s2">&#34;dead&#34;</span>
</span></span><span class="line"><span class="cl">    <span class="k">def</span> <span class="nf">is_failed_modules</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">modules</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">        <span class="s2">&#34;&#34;&#34; [UNIT]... -- check if these units are in failes state
</span></span></span><span class="line"><span class="cl"><span class="s2">        implements True if any is-active = True &#34;&#34;&#34;</span>
</span></span><span class="line"><span class="cl">        <span class="n">units</span> <span class="o">=</span> <span class="p">[]</span>
</span></span><span class="line"><span class="cl">        <span class="n">results</span> <span class="o">=</span> <span class="p">[]</span>
</span></span><span class="line"><span class="cl">        <span class="k">for</span> <span class="n">module</span> <span class="ow">in</span> <span class="n">modules</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">            <span class="n">units</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">match_units</span><span class="p">(</span><span class="n">to_list</span><span class="p">(</span><span class="n">module</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">            <span class="k">if</span> <span class="ow">not</span> <span class="n">units</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">                <span class="n">logg</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&#34;Unit </span><span class="si">%s</span><span class="s2"> not found.&#34;</span><span class="p">,</span> <span class="n">unit_of</span><span class="p">(</span><span class="n">module</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">                <span class="c1"># self.error |= NOT_FOUND</span>
</span></span><span class="line"><span class="cl">                <span class="n">results</span> <span class="o">+=</span> <span class="p">[</span><span class="s2">&#34;inactive&#34;</span><span class="p">]</span>
</span></span><span class="line"><span class="cl">                <span class="k">continue</span>
</span></span><span class="line"><span class="cl">            <span class="k">for</span> <span class="n">unit</span> <span class="ow">in</span> <span class="n">units</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">                <span class="n">active</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_active_unit</span><span class="p">(</span><span class="n">unit</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">                <span class="n">enabled</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">enabled_unit</span><span class="p">(</span><span class="n">unit</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">                <span class="k">if</span> <span class="n">enabled</span> <span class="o">!=</span> <span class="s2">&#34;enabled&#34;</span> <span class="ow">and</span> <span class="n">ACTIVE_IF_ENABLED</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">                    <span class="n">active</span> <span class="o">=</span> <span class="s2">&#34;inactive&#34;</span>
</span></span><span class="line"><span class="cl">                <span class="n">results</span> <span class="o">+=</span> <span class="p">[</span><span class="n">active</span><span class="p">]</span>
</span></span><span class="line"><span class="cl">                <span class="k">break</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="s2">&#34;failed&#34;</span> <span class="ow">in</span> <span class="n">results</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">            <span class="bp">self</span><span class="o">.</span><span class="n">error</span> <span class="o">=</span> <span class="mi">0</span>
</span></span><span class="line"><span class="cl">        <span class="k">else</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">            <span class="bp">self</span><span class="o">.</span><span class="n">error</span> <span class="o">|=</span> <span class="n">NOT_OK</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="n">_quiet</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">            <span class="k">return</span> <span class="p">[]</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="n">results</span>
</span></span><span class="line"><span class="cl">    <span class="k">def</span> <span class="nf">is_failed_from</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">conf</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="n">conf</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span> <span class="k">return</span> <span class="kc">True</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_active_from</span><span class="p">(</span><span class="n">conf</span><span class="p">)</span> <span class="o">==</span> <span class="s2">&#34;failed&#34;</span>
</span></span><span class="line"><span class="cl">    <span class="k">def</span> <span class="nf">reset_failed_modules</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">modules</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">        <span class="s2">&#34;&#34;&#34; [UNIT]... -- Reset failed state for all, one, or more units &#34;&#34;&#34;</span>
</span></span><span class="line"><span class="cl">        <span class="n">units</span> <span class="o">=</span> <span class="p">[]</span>
</span></span><span class="line"><span class="cl">        <span class="n">status</span> <span class="o">=</span> <span class="kc">True</span>
</span></span><span class="line"><span class="cl">        <span class="k">for</span> <span class="n">module</span> <span class="ow">in</span> <span class="n">modules</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">            <span class="n">units</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">match_units</span><span class="p">(</span><span class="n">to_list</span><span class="p">(</span><span class="n">module</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">            <span class="k">if</span> <span class="ow">not</span> <span class="n">units</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">                <span class="n">logg</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&#34;Unit </span><span class="si">%s</span><span class="s2"> not found.&#34;</span><span class="p">,</span> <span class="n">unit_of</span><span class="p">(</span><span class="n">module</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">                <span class="c1"># self.error |= NOT_FOUND</span>
</span></span><span class="line"><span class="cl">                <span class="k">return</span> <span class="kc">False</span>
</span></span><span class="line"><span class="cl">            <span class="k">for</span> <span class="n">unit</span> <span class="ow">in</span> <span class="n">units</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">                <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">reset_failed_unit</span><span class="p">(</span><span class="n">unit</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">                    <span class="n">logg</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&#34;Unit </span><span class="si">%s</span><span class="s2"> could not be reset.&#34;</span><span class="p">,</span> <span class="n">unit_of</span><span class="p">(</span><span class="n">module</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">                    <span class="n">status</span> <span class="o">=</span> <span class="kc">False</span>
</span></span><span class="line"><span class="cl">                <span class="k">break</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="n">status</span>
</span></span><span class="line"><span class="cl">    <span class="k">def</span> <span class="nf">reset_failed_unit</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">unit</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">        <span class="n">conf</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">load_unit_conf</span><span class="p">(</span><span class="n">unit</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="ow">not</span> <span class="n">conf</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">            <span class="n">logg</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&#34;Unit </span><span class="si">%s</span><span class="s2"> not found.&#34;</span><span class="p">,</span> <span class="n">unit</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">            <span class="k">return</span> <span class="kc">False</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">not_user_conf</span><span class="p">(</span><span class="n">conf</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">            <span class="n">logg</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&#34;Unit </span><span class="si">%s</span><span class="s2"> not for --user mode&#34;</span><span class="p">,</span> <span class="n">unit</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">            <span class="k">return</span> <span class="kc">False</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">reset_failed_from</span><span class="p">(</span><span class="n">conf</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="k">def</span> <span class="nf">reset_failed_from</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">conf</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="n">conf</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span> <span class="k">return</span> <span class="kc">True</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">is_failed_from</span><span class="p">(</span><span class="n">conf</span><span class="p">):</span> <span class="k">return</span> <span class="kc">False</span>
</span></span><span class="line"><span class="cl">        <span class="n">done</span> <span class="o">=</span> <span class="kc">False</span>
</span></span><span class="line"><span class="cl">        <span class="n">status_file</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_status_file_from</span><span class="p">(</span><span class="n">conf</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="n">status_file</span> <span class="ow">and</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">status_file</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">            <span class="k">try</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">                <span class="n">os</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">status_file</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">                <span class="n">done</span> <span class="o">=</span> <span class="kc">True</span>
</span></span><span class="line"><span class="cl">                <span class="n">logg</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&#34;done rm </span><span class="si">%s</span><span class="s2">&#34;</span><span class="p">,</span> <span class="n">status_file</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">            <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">                <span class="n">logg</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&#34;while rm </span><span class="si">%s</span><span class="s2">: </span><span class="si">%s</span><span class="s2">&#34;</span><span class="p">,</span> <span class="n">status_file</span><span class="p">,</span> <span class="n">e</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="n">pid_file</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">pid_file_from</span><span class="p">(</span><span class="n">conf</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="n">pid_file</span> <span class="ow">and</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">pid_file</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">            <span class="k">try</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">                <span class="n">os</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">pid_file</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">                <span class="n">done</span> <span class="o">=</span> <span class="kc">True</span>
</span></span><span class="line"><span class="cl">                <span class="n">logg</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&#34;done rm </span><span class="si">%s</span><span class="s2">&#34;</span><span class="p">,</span> <span class="n">pid_file</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">            <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">                <span class="n">logg</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&#34;while rm </span><span class="si">%s</span><span class="s2">: </span><span class="si">%s</span><span class="s2">&#34;</span><span class="p">,</span> <span class="n">pid_file</span><span class="p">,</span> <span class="n">e</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="n">done</span>
</span></span><span class="line"><span class="cl">    <span class="k">def</span> <span class="nf">status_modules</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">modules</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">        <span class="s2">&#34;&#34;&#34; [UNIT]... check the status of these units.
</span></span></span><span class="line"><span class="cl"><span class="s2">        &#34;&#34;&#34;</span>
</span></span><span class="line"><span class="cl">        <span class="n">found_all</span> <span class="o">=</span> <span class="kc">True</span>
</span></span><span class="line"><span class="cl">        <span class="n">units</span> <span class="o">=</span> <span class="p">[]</span>
</span></span><span class="line"><span class="cl">        <span class="k">for</span> <span class="n">module</span> <span class="ow">in</span> <span class="n">modules</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">            <span class="n">matched</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">match_units</span><span class="p">(</span><span class="n">to_list</span><span class="p">(</span><span class="n">module</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">            <span class="k">if</span> <span class="ow">not</span> <span class="n">matched</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">                <span class="n">logg</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&#34;Unit </span><span class="si">%s</span><span class="s2"> could not be found.&#34;</span><span class="p">,</span> <span class="n">unit_of</span><span class="p">(</span><span class="n">module</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">                <span class="bp">self</span><span class="o">.</span><span class="n">error</span> <span class="o">|=</span> <span class="n">NOT_FOUND</span>
</span></span><span class="line"><span class="cl">                <span class="n">found_all</span> <span class="o">=</span> <span class="kc">False</span>
</span></span><span class="line"><span class="cl">                <span class="k">continue</span>
</span></span><span class="line"><span class="cl">            <span class="k">for</span> <span class="n">unit</span> <span class="ow">in</span> <span class="n">matched</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">                <span class="k">if</span> <span class="n">unit</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">units</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">                    <span class="n">units</span> <span class="o">+=</span> <span class="p">[</span><span class="n">unit</span><span class="p">]</span>
</span></span><span class="line"><span class="cl">        <span class="n">result</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">status_units</span><span class="p">(</span><span class="n">units</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="c1"># if not found_all:</span>
</span></span><span class="line"><span class="cl">        <span class="c1">#     self.error |= NOT_OK | NOT_ACTIVE # 3</span>
</span></span><span class="line"><span class="cl">        <span class="c1">#     # same as (dead) # original behaviour</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="n">result</span>
</span></span><span class="line"><span class="cl">    <span class="k">def</span> <span class="nf">status_units</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">units</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">        <span class="s2">&#34;&#34;&#34; concatenates the status output of all units
</span></span></span><span class="line"><span class="cl"><span class="s2">            and the last non-successful statuscode &#34;&#34;&#34;</span>
</span></span><span class="line"><span class="cl">        <span class="n">status</span> <span class="o">=</span> <span class="mi">0</span>
</span></span><span class="line"><span class="cl">        <span class="n">result</span> <span class="o">=</span> <span class="s2">&#34;&#34;</span>
</span></span><span class="line"><span class="cl">        <span class="k">for</span> <span class="n">unit</span> <span class="ow">in</span> <span class="n">units</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">            <span class="n">status1</span><span class="p">,</span> <span class="n">result1</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">status_unit</span><span class="p">(</span><span class="n">unit</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">            <span class="k">if</span> <span class="n">status1</span><span class="p">:</span> <span class="n">status</span> <span class="o">=</span> <span class="n">status1</span>
</span></span><span class="line"><span class="cl">            <span class="k">if</span> <span class="n">result</span><span class="p">:</span> <span class="n">result</span> <span class="o">+=</span> <span class="s2">&#34;</span><span class="se">\n\n</span><span class="s2">&#34;</span>
</span></span><span class="line"><span class="cl">            <span class="n">result</span> <span class="o">+=</span> <span class="n">result1</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="n">status</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">            <span class="bp">self</span><span class="o">.</span><span class="n">error</span> <span class="o">|=</span> <span class="n">NOT_OK</span> <span class="o">|</span> <span class="n">NOT_ACTIVE</span> <span class="c1"># 3</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="n">result</span>
</span></span><span class="line"><span class="cl">    <span class="k">def</span> <span class="nf">status_unit</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">unit</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">        <span class="n">conf</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_unit_conf</span><span class="p">(</span><span class="n">unit</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="n">result</span> <span class="o">=</span> <span class="s2">&#34;</span><span class="si">%s</span><span class="s2"> - </span><span class="si">%s</span><span class="s2">&#34;</span> <span class="o">%</span> <span class="p">(</span><span class="n">unit</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_description_from</span><span class="p">(</span><span class="n">conf</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">        <span class="n">loaded</span> <span class="o">=</span> <span class="n">conf</span><span class="o">.</span><span class="n">loaded</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="n">loaded</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">            <span class="n">filename</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">conf</span><span class="o">.</span><span class="n">filename</span><span class="p">())</span>
</span></span><span class="line"><span class="cl">            <span class="n">enabled</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">enabled_from</span><span class="p">(</span><span class="n">conf</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">            <span class="n">result</span> <span class="o">+=</span> <span class="s2">&#34;</span><span class="se">\n</span><span class="s2">    Loaded: </span><span class="si">{loaded}</span><span class="s2"> (</span><span class="si">{filename}</span><span class="s2">, </span><span class="si">{enabled}</span><span class="s2">)&#34;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="o">**</span><span class="nb">locals</span><span class="p">())</span>
</span></span><span class="line"><span class="cl">            <span class="k">for</span> <span class="n">path</span> <span class="ow">in</span> <span class="n">conf</span><span class="o">.</span><span class="n">overrides</span><span class="p">():</span>
</span></span><span class="line"><span class="cl">                <span class="n">result</span> <span class="o">+=</span> <span class="s2">&#34;</span><span class="se">\n</span><span class="s2">    Drop-In: </span><span class="si">{path}</span><span class="s2">&#34;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="o">**</span><span class="nb">locals</span><span class="p">())</span>
</span></span><span class="line"><span class="cl">        <span class="k">else</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">            <span class="n">result</span> <span class="o">+=</span> <span class="s2">&#34;</span><span class="se">\n</span><span class="s2">    Loaded: failed&#34;</span>
</span></span><span class="line"><span class="cl">            <span class="k">return</span> <span class="mi">3</span><span class="p">,</span> <span class="n">result</span>
</span></span><span class="line"><span class="cl">        <span class="n">active</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_active_from</span><span class="p">(</span><span class="n">conf</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="n">substate</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_substate_from</span><span class="p">(</span><span class="n">conf</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="n">result</span> <span class="o">+=</span> <span class="s2">&#34;</span><span class="se">\n</span><span class="s2">    Active: </span><span class="si">{}</span><span class="s2"> (</span><span class="si">{}</span><span class="s2">)&#34;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">active</span><span class="p">,</span> <span class="n">substate</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="n">active</span> <span class="o">==</span> <span class="s2">&#34;active&#34;</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">            <span class="k">return</span> <span class="mi">0</span><span class="p">,</span> <span class="n">result</span>
</span></span><span class="line"><span class="cl">        <span class="k">else</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">            <span class="k">return</span> <span class="mi">3</span><span class="p">,</span> <span class="n">result</span>
</span></span><span class="line"><span class="cl">    <span class="k">def</span> <span class="nf">cat_modules</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">modules</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">        <span class="s2">&#34;&#34;&#34; [UNIT]... show the *.system file for these&#34;
</span></span></span><span class="line"><span class="cl"><span class="s2">        &#34;&#34;&#34;</span>
</span></span><span class="line"><span class="cl">        <span class="n">found_all</span> <span class="o">=</span> <span class="kc">True</span>
</span></span><span class="line"><span class="cl">        <span class="n">units</span> <span class="o">=</span> <span class="p">[]</span>
</span></span><span class="line"><span class="cl">        <span class="k">for</span> <span class="n">module</span> <span class="ow">in</span> <span class="n">modules</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">            <span class="n">matched</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">match_units</span><span class="p">(</span><span class="n">to_list</span><span class="p">(</span><span class="n">module</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">            <span class="k">if</span> <span class="ow">not</span> <span class="n">matched</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">                <span class="n">logg</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&#34;Unit </span><span class="si">%s</span><span class="s2"> could not be found.&#34;</span><span class="p">,</span> <span class="n">unit_of</span><span class="p">(</span><span class="n">module</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">                <span class="c1"># self.error |= NOT_FOUND</span>
</span></span><span class="line"><span class="cl">                <span class="n">found_all</span> <span class="o">=</span> <span class="kc">False</span>
</span></span><span class="line"><span class="cl">                <span class="k">continue</span>
</span></span><span class="line"><span class="cl">            <span class="k">for</span> <span class="n">unit</span> <span class="ow">in</span> <span class="n">matched</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">                <span class="k">if</span> <span class="n">unit</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">units</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">                    <span class="n">units</span> <span class="o">+=</span> <span class="p">[</span><span class="n">unit</span><span class="p">]</span>
</span></span><span class="line"><span class="cl">        <span class="n">result</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">cat_units</span><span class="p">(</span><span class="n">units</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="ow">not</span> <span class="n">found_all</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">            <span class="bp">self</span><span class="o">.</span><span class="n">error</span> <span class="o">|=</span> <span class="n">NOT_OK</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="n">result</span>
</span></span><span class="line"><span class="cl">    <span class="k">def</span> <span class="nf">cat_units</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">units</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">        <span class="n">done</span> <span class="o">=</span> <span class="kc">True</span>
</span></span><span class="line"><span class="cl">        <span class="n">result</span> <span class="o">=</span> <span class="s2">&#34;&#34;</span>
</span></span><span class="line"><span class="cl">        <span class="k">for</span> <span class="n">unit</span> <span class="ow">in</span> <span class="n">units</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">            <span class="n">text</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">cat_unit</span><span class="p">(</span><span class="n">unit</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">            <span class="k">if</span> <span class="ow">not</span> <span class="n">text</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">                <span class="n">done</span> <span class="o">=</span> <span class="kc">False</span>
</span></span><span class="line"><span class="cl">            <span class="k">else</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">                <span class="k">if</span> <span class="n">result</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">                    <span class="n">result</span> <span class="o">+=</span> <span class="s2">&#34;</span><span class="se">\n\n</span><span class="s2">&#34;</span>
</span></span><span class="line"><span class="cl">                <span class="n">result</span> <span class="o">+=</span> <span class="n">text</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="ow">not</span> <span class="n">done</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">            <span class="bp">self</span><span class="o">.</span><span class="n">error</span> <span class="o">=</span> <span class="n">NOT_OK</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="n">result</span>
</span></span><span class="line"><span class="cl">    <span class="k">def</span> <span class="nf">cat_unit</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">unit</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">        <span class="k">try</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">            <span class="n">unit_file</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">unit_file</span><span class="p">(</span><span class="n">unit</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">            <span class="k">if</span> <span class="n">unit_file</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">                <span class="k">return</span> <span class="nb">open</span><span class="p">(</span><span class="n">unit_file</span><span class="p">)</span><span class="o">.</span><span class="n">read</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">            <span class="n">logg</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&#34;No files found for </span><span class="si">%s</span><span class="s2">&#34;</span><span class="p">,</span> <span class="n">unit</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">            <span class="nb">print</span><span class="p">(</span><span class="s2">&#34;Unit </span><span class="si">{}</span><span class="s2"> is not-loaded: </span><span class="si">{}</span><span class="s2">&#34;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">unit</span><span class="p">,</span> <span class="n">e</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">        <span class="bp">self</span><span class="o">.</span><span class="n">error</span> <span class="o">|=</span> <span class="n">NOT_OK</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="kc">None</span>
</span></span><span class="line"><span class="cl">    <span class="c1">##</span>
</span></span><span class="line"><span class="cl">    <span class="c1">##</span>
</span></span><span class="line"><span class="cl">    <span class="k">def</span> <span class="nf">load_preset_files</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">module</span> <span class="o">=</span> <span class="kc">None</span><span class="p">):</span> <span class="c1"># -&gt; [ preset-file-names,... ]</span>
</span></span><span class="line"><span class="cl">        <span class="s2">&#34;&#34;&#34; reads all preset files, returns the scanned files &#34;&#34;&#34;</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_preset_file_list</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">            <span class="bp">self</span><span class="o">.</span><span class="n">_preset_file_list</span> <span class="o">=</span> <span class="p">{}</span>
</span></span><span class="line"><span class="cl">            <span class="k">assert</span> <span class="bp">self</span><span class="o">.</span><span class="n">_preset_file_list</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>
</span></span><span class="line"><span class="cl">            <span class="k">for</span> <span class="n">folder</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">preset_folders</span><span class="p">():</span>
</span></span><span class="line"><span class="cl">                <span class="k">if</span> <span class="ow">not</span> <span class="n">folder</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">                    <span class="k">continue</span>
</span></span><span class="line"><span class="cl">                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_root</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">                    <span class="n">folder</span> <span class="o">=</span> <span class="n">os_path</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_root</span><span class="p">,</span> <span class="n">folder</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">                <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isdir</span><span class="p">(</span><span class="n">folder</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">                    <span class="k">continue</span>
</span></span><span class="line"><span class="cl">                <span class="k">for</span> <span class="n">name</span> <span class="ow">in</span> <span class="n">os</span><span class="o">.</span><span class="n">listdir</span><span class="p">(</span><span class="n">folder</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">                    <span class="k">if</span> <span class="ow">not</span> <span class="n">name</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s2">&#34;.preset&#34;</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">                        <span class="k">continue</span>
</span></span><span class="line"><span class="cl">                    <span class="k">if</span> <span class="n">name</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_preset_file_list</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">                        <span class="n">path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">folder</span><span class="p">,</span> <span class="n">name</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">                        <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isdir</span><span class="p">(</span><span class="n">path</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">                            <span class="k">continue</span>
</span></span><span class="line"><span class="cl">                        <span class="n">preset</span> <span class="o">=</span> <span class="n">PresetFile</span><span class="p">()</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="n">path</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">                        <span class="bp">self</span><span class="o">.</span><span class="n">_preset_file_list</span><span class="p">[</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="n">preset</span>
</span></span><span class="line"><span class="cl">            <span class="n">logg</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&#34;found </span><span class="si">%s</span><span class="s2"> preset files&#34;</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_preset_file_list</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="nb">sorted</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_preset_file_list</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>
</span></span><span class="line"><span class="cl">    <span class="k">def</span> <span class="nf">get_preset_of_unit</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">unit</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">        <span class="s2">&#34;&#34;&#34; [UNIT] check the *.preset of this unit
</span></span></span><span class="line"><span class="cl"><span class="s2">        &#34;&#34;&#34;</span>
</span></span><span class="line"><span class="cl">        <span class="bp">self</span><span class="o">.</span><span class="n">load_preset_files</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">        <span class="k">assert</span> <span class="bp">self</span><span class="o">.</span><span class="n">_preset_file_list</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>
</span></span><span class="line"><span class="cl">        <span class="k">for</span> <span class="n">filename</span> <span class="ow">in</span> <span class="nb">sorted</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_preset_file_list</span><span class="o">.</span><span class="n">keys</span><span class="p">()):</span>
</span></span><span class="line"><span class="cl">            <span class="n">preset</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_preset_file_list</span><span class="p">[</span><span class="n">filename</span><span class="p">]</span>
</span></span><span class="line"><span class="cl">            <span class="n">status</span> <span class="o">=</span> <span class="n">preset</span><span class="o">.</span><span class="n">get_preset</span><span class="p">(</span><span class="n">unit</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">            <span class="k">if</span> <span class="n">status</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">                <span class="k">return</span> <span class="n">status</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="kc">None</span>
</span></span><span class="line"><span class="cl">    <span class="k">def</span> <span class="nf">preset_modules</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">modules</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">        <span class="s2">&#34;&#34;&#34; [UNIT]... -- set &#39;enabled&#39; when in *.preset
</span></span></span><span class="line"><span class="cl"><span class="s2">        &#34;&#34;&#34;</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">user_mode</span><span class="p">():</span>
</span></span><span class="line"><span class="cl">            <span class="n">logg</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&#34;preset makes no sense in --user mode&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">            <span class="k">return</span> <span class="kc">True</span>
</span></span><span class="line"><span class="cl">        <span class="n">found_all</span> <span class="o">=</span> <span class="kc">True</span>
</span></span><span class="line"><span class="cl">        <span class="n">units</span> <span class="o">=</span> <span class="p">[]</span>
</span></span><span class="line"><span class="cl">        <span class="k">for</span> <span class="n">module</span> <span class="ow">in</span> <span class="n">modules</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">            <span class="n">matched</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">match_units</span><span class="p">(</span><span class="n">to_list</span><span class="p">(</span><span class="n">module</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">            <span class="k">if</span> <span class="ow">not</span> <span class="n">matched</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">                <span class="n">logg</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&#34;Unit </span><span class="si">%s</span><span class="s2"> could not be found.&#34;</span><span class="p">,</span> <span class="n">unit_of</span><span class="p">(</span><span class="n">module</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">                <span class="n">found_all</span> <span class="o">=</span> <span class="kc">False</span>
</span></span><span class="line"><span class="cl">                <span class="k">continue</span>
</span></span><span class="line"><span class="cl">            <span class="k">for</span> <span class="n">unit</span> <span class="ow">in</span> <span class="n">matched</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">                <span class="k">if</span> <span class="n">unit</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">units</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">                    <span class="n">units</span> <span class="o">+=</span> <span class="p">[</span><span class="n">unit</span><span class="p">]</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">preset_units</span><span class="p">(</span><span class="n">units</span><span class="p">)</span> <span class="ow">and</span> <span class="n">found_all</span>
</span></span><span class="line"><span class="cl">    <span class="k">def</span> <span class="nf">preset_units</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">units</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">        <span class="s2">&#34;&#34;&#34; fails if any unit could not be changed &#34;&#34;&#34;</span>
</span></span><span class="line"><span class="cl">        <span class="bp">self</span><span class="o">.</span><span class="n">wait_system</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">        <span class="n">fails</span> <span class="o">=</span> <span class="mi">0</span>
</span></span><span class="line"><span class="cl">        <span class="n">found</span> <span class="o">=</span> <span class="mi">0</span>
</span></span><span class="line"><span class="cl">        <span class="k">for</span> <span class="n">unit</span> <span class="ow">in</span> <span class="n">units</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">            <span class="n">status</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_preset_of_unit</span><span class="p">(</span><span class="n">unit</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">            <span class="k">if</span> <span class="ow">not</span> <span class="n">status</span><span class="p">:</span> <span class="k">continue</span>
</span></span><span class="line"><span class="cl">            <span class="n">found</span> <span class="o">+=</span> <span class="mi">1</span>
</span></span><span class="line"><span class="cl">            <span class="k">if</span> <span class="n">status</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s2">&#34;enable&#34;</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_preset_mode</span> <span class="o">==</span> <span class="s2">&#34;disable&#34;</span><span class="p">:</span> <span class="k">continue</span>
</span></span><span class="line"><span class="cl">                <span class="n">logg</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&#34;preset enable </span><span class="si">%s</span><span class="s2">&#34;</span><span class="p">,</span> <span class="n">unit</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">                <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">enable_unit</span><span class="p">(</span><span class="n">unit</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">                    <span class="n">logg</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&#34;failed to enable </span><span class="si">%s</span><span class="s2">&#34;</span><span class="p">,</span> <span class="n">unit</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">                    <span class="n">fails</span> <span class="o">+=</span> <span class="mi">1</span>
</span></span><span class="line"><span class="cl">            <span class="k">if</span> <span class="n">status</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s2">&#34;disable&#34;</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_preset_mode</span> <span class="o">==</span> <span class="s2">&#34;enable&#34;</span><span class="p">:</span> <span class="k">continue</span>
</span></span><span class="line"><span class="cl">                <span class="n">logg</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&#34;preset disable </span><span class="si">%s</span><span class="s2">&#34;</span><span class="p">,</span> <span class="n">unit</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">                <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">disable_unit</span><span class="p">(</span><span class="n">unit</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">                    <span class="n">logg</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&#34;failed to disable </span><span class="si">%s</span><span class="s2">&#34;</span><span class="p">,</span> <span class="n">unit</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">                    <span class="n">fails</span> <span class="o">+=</span> <span class="mi">1</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="ow">not</span> <span class="n">fails</span> <span class="ow">and</span> <span class="ow">not</span> <span class="ow">not</span> <span class="n">found</span>
</span></span><span class="line"><span class="cl">    <span class="k">def</span> <span class="nf">preset_all_modules</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">modules</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">        <span class="s2">&#34;&#34;&#34; &#39;preset&#39; all services
</span></span></span><span class="line"><span class="cl"><span class="s2">        enable or disable services according to *.preset files
</span></span></span><span class="line"><span class="cl"><span class="s2">        &#34;&#34;&#34;</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">user_mode</span><span class="p">():</span>
</span></span><span class="line"><span class="cl">            <span class="n">logg</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&#34;preset-all makes no sense in --user mode&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">            <span class="k">return</span> <span class="kc">True</span>
</span></span><span class="line"><span class="cl">        <span class="n">found_all</span> <span class="o">=</span> <span class="kc">True</span>
</span></span><span class="line"><span class="cl">        <span class="n">units</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">match_units</span><span class="p">()</span> <span class="c1"># TODO: how to handle module arguments</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">preset_units</span><span class="p">(</span><span class="n">units</span><span class="p">)</span> <span class="ow">and</span> <span class="n">found_all</span>
</span></span><span class="line"><span class="cl">    <span class="k">def</span> <span class="nf">wanted_from</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">conf</span><span class="p">,</span> <span class="n">default</span> <span class="o">=</span> <span class="kc">None</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="ow">not</span> <span class="n">conf</span><span class="p">:</span> <span class="k">return</span> <span class="n">default</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="n">conf</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">Install</span><span class="p">,</span> <span class="s2">&#34;WantedBy&#34;</span><span class="p">,</span> <span class="n">default</span><span class="p">,</span> <span class="kc">True</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="k">def</span> <span class="nf">enablefolders</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">wanted</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">user_mode</span><span class="p">():</span>
</span></span><span class="line"><span class="cl">            <span class="k">for</span> <span class="n">folder</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">user_folders</span><span class="p">():</span>
</span></span><span class="line"><span class="cl">                <span class="k">yield</span> <span class="bp">self</span><span class="o">.</span><span class="n">default_enablefolder</span><span class="p">(</span><span class="n">wanted</span><span class="p">,</span> <span class="n">folder</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="kc">True</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">            <span class="k">for</span> <span class="n">folder</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">system_folders</span><span class="p">():</span>
</span></span><span class="line"><span class="cl">                <span class="k">yield</span> <span class="bp">self</span><span class="o">.</span><span class="n">default_enablefolder</span><span class="p">(</span><span class="n">wanted</span><span class="p">,</span> <span class="n">folder</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="k">def</span> <span class="nf">enablefolder</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">wanted</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">user_mode</span><span class="p">():</span>
</span></span><span class="line"><span class="cl">            <span class="n">user_folder</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">user_folder</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">default_enablefolder</span><span class="p">(</span><span class="n">wanted</span><span class="p">,</span> <span class="n">user_folder</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="k">else</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">default_enablefolder</span><span class="p">(</span><span class="n">wanted</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="k">def</span> <span class="nf">default_enablefolder</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">wanted</span><span class="p">,</span> <span class="n">basefolder</span> <span class="o">=</span> <span class="kc">None</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">        <span class="n">basefolder</span> <span class="o">=</span> <span class="n">basefolder</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">system_folder</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="ow">not</span> <span class="n">wanted</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">            <span class="k">return</span> <span class="n">wanted</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="ow">not</span> <span class="n">wanted</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s2">&#34;.wants&#34;</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">            <span class="n">wanted</span> <span class="o">=</span> <span class="n">wanted</span> <span class="o">+</span> <span class="s2">&#34;.wants&#34;</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">basefolder</span><span class="p">,</span> <span class="n">wanted</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="k">def</span> <span class="nf">enable_modules</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">modules</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">        <span class="s2">&#34;&#34;&#34; [UNIT]... -- enable these units &#34;&#34;&#34;</span>
</span></span><span class="line"><span class="cl">        <span class="n">found_all</span> <span class="o">=</span> <span class="kc">True</span>
</span></span><span class="line"><span class="cl">        <span class="n">units</span> <span class="o">=</span> <span class="p">[]</span>
</span></span><span class="line"><span class="cl">        <span class="k">for</span> <span class="n">module</span> <span class="ow">in</span> <span class="n">modules</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">            <span class="n">matched</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">match_units</span><span class="p">(</span><span class="n">to_list</span><span class="p">(</span><span class="n">module</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">            <span class="k">if</span> <span class="ow">not</span> <span class="n">matched</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">                <span class="n">logg</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&#34;Unit </span><span class="si">%s</span><span class="s2"> not found.&#34;</span><span class="p">,</span> <span class="n">unit_of</span><span class="p">(</span><span class="n">module</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">                <span class="c1"># self.error |= NOT_FOUND</span>
</span></span><span class="line"><span class="cl">                <span class="n">found_all</span> <span class="o">=</span> <span class="kc">False</span>
</span></span><span class="line"><span class="cl">                <span class="k">continue</span>
</span></span><span class="line"><span class="cl">            <span class="k">for</span> <span class="n">unit</span> <span class="ow">in</span> <span class="n">matched</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">                <span class="n">logg</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&#34;matched </span><span class="si">%s</span><span class="s2">&#34;</span><span class="p">,</span> <span class="n">unit</span><span class="p">)</span>  <span class="c1"># ++</span>
</span></span><span class="line"><span class="cl">                <span class="k">if</span> <span class="n">unit</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">units</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">                    <span class="n">units</span> <span class="o">+=</span> <span class="p">[</span><span class="n">unit</span><span class="p">]</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">enable_units</span><span class="p">(</span><span class="n">units</span><span class="p">)</span> <span class="ow">and</span> <span class="n">found_all</span>
</span></span><span class="line"><span class="cl">    <span class="k">def</span> <span class="nf">enable_units</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">units</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">        <span class="bp">self</span><span class="o">.</span><span class="n">wait_system</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">        <span class="n">done</span> <span class="o">=</span> <span class="kc">True</span>
</span></span><span class="line"><span class="cl">        <span class="k">for</span> <span class="n">unit</span> <span class="ow">in</span> <span class="n">units</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">            <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">enable_unit</span><span class="p">(</span><span class="n">unit</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">                <span class="n">done</span> <span class="o">=</span> <span class="kc">False</span>
</span></span><span class="line"><span class="cl">            <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">_now</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">                <span class="bp">self</span><span class="o">.</span><span class="n">start_unit</span><span class="p">(</span><span class="n">unit</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="n">done</span>
</span></span><span class="line"><span class="cl">    <span class="k">def</span> <span class="nf">enable_unit</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">unit</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">        <span class="n">conf</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">load_unit_conf</span><span class="p">(</span><span class="n">unit</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="n">conf</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">            <span class="n">logg</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&#34;Unit </span><span class="si">%s</span><span class="s2"> not found.&#34;</span><span class="p">,</span> <span class="n">unit</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">            <span class="k">return</span> <span class="kc">False</span>
</span></span><span class="line"><span class="cl">        <span class="n">unit_file</span> <span class="o">=</span> <span class="n">conf</span><span class="o">.</span><span class="n">filename</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="n">unit_file</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">            <span class="n">logg</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&#34;Unit file </span><span class="si">%s</span><span class="s2"> not found.&#34;</span><span class="p">,</span> <span class="n">unit</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">            <span class="k">return</span> <span class="kc">False</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">is_sysv_file</span><span class="p">(</span><span class="n">unit_file</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">user_mode</span><span class="p">():</span>
</span></span><span class="line"><span class="cl">                <span class="n">logg</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&#34;Initscript </span><span class="si">%s</span><span class="s2"> not for --user mode&#34;</span><span class="p">,</span> <span class="n">unit</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">                <span class="k">return</span> <span class="kc">False</span>
</span></span><span class="line"><span class="cl">            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">enable_unit_sysv</span><span class="p">(</span><span class="n">unit_file</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">not_user_conf</span><span class="p">(</span><span class="n">conf</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">            <span class="n">logg</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&#34;Unit </span><span class="si">%s</span><span class="s2"> not for --user mode&#34;</span><span class="p">,</span> <span class="n">unit</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">            <span class="k">return</span> <span class="kc">False</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">enable_unit_from</span><span class="p">(</span><span class="n">conf</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="k">def</span> <span class="nf">enable_unit_from</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">conf</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">        <span class="n">wanted</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">wanted_from</span><span class="p">(</span><span class="n">conf</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="ow">not</span> <span class="n">wanted</span> <span class="ow">and</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_force</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">            <span class="n">logg</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&#34;</span><span class="si">%s</span><span class="s2"> has no target&#34;</span><span class="p">,</span> <span class="n">conf</span><span class="o">.</span><span class="n">name</span><span class="p">())</span>
</span></span><span class="line"><span class="cl">            <span class="k">return</span> <span class="kc">False</span> <span class="c1"># &#34;static&#34; is-enabled</span>
</span></span><span class="line"><span class="cl">        <span class="n">target</span> <span class="o">=</span> <span class="n">wanted</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_default_target</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">        <span class="n">folder</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">enablefolder</span><span class="p">(</span><span class="n">target</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_root</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">            <span class="n">folder</span> <span class="o">=</span> <span class="n">os_path</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_root</span><span class="p">,</span> <span class="n">folder</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isdir</span><span class="p">(</span><span class="n">folder</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">            <span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="n">folder</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="n">source</span> <span class="o">=</span> <span class="n">conf</span><span class="o">.</span><span class="n">filename</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="ow">not</span> <span class="n">source</span><span class="p">:</span> <span class="c1"># pragma: no cover (was checked before)</span>
</span></span><span class="line"><span class="cl">            <span class="n">logg</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&#34;</span><span class="si">%s</span><span class="s2"> has no real file&#34;</span><span class="p">,</span> <span class="n">conf</span><span class="o">.</span><span class="n">name</span><span class="p">())</span>
</span></span><span class="line"><span class="cl">            <span class="k">return</span> <span class="kc">False</span>
</span></span><span class="line"><span class="cl">        <span class="n">symlink</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">folder</span><span class="p">,</span> <span class="n">conf</span><span class="o">.</span><span class="n">name</span><span class="p">())</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="kc">True</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">            <span class="n">_f</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_force</span> <span class="ow">and</span> <span class="s2">&#34;-f&#34;</span> <span class="ow">or</span> <span class="s2">&#34;&#34;</span>
</span></span><span class="line"><span class="cl">            <span class="n">logg</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&#34;ln -s </span><span class="si">{_f}</span><span class="s2"> &#39;</span><span class="si">{source}</span><span class="s2">&#39; &#39;</span><span class="si">{symlink}</span><span class="s2">&#39;&#34;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="o">**</span><span class="nb">locals</span><span class="p">()))</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_force</span> <span class="ow">and</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">islink</span><span class="p">(</span><span class="n">symlink</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">            <span class="n">os</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">target</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">islink</span><span class="p">(</span><span class="n">symlink</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">            <span class="n">os</span><span class="o">.</span><span class="n">symlink</span><span class="p">(</span><span class="n">source</span><span class="p">,</span> <span class="n">symlink</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="kc">True</span>
</span></span><span class="line"><span class="cl">    <span class="k">def</span> <span class="nf">rc3_root_folder</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">        <span class="n">old_folder</span> <span class="o">=</span> <span class="n">os_path</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_root</span><span class="p">,</span> <span class="n">_rc3_boot_folder</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="n">new_folder</span> <span class="o">=</span> <span class="n">os_path</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_root</span><span class="p">,</span> <span class="n">_rc3_init_folder</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isdir</span><span class="p">(</span><span class="n">old_folder</span><span class="p">):</span> <span class="c1"># pragma: no cover</span>
</span></span><span class="line"><span class="cl">            <span class="k">return</span> <span class="n">old_folder</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="n">new_folder</span>
</span></span><span class="line"><span class="cl">    <span class="k">def</span> <span class="nf">rc5_root_folder</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">        <span class="n">old_folder</span> <span class="o">=</span> <span class="n">os_path</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_root</span><span class="p">,</span> <span class="n">_rc5_boot_folder</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="n">new_folder</span> <span class="o">=</span> <span class="n">os_path</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_root</span><span class="p">,</span> <span class="n">_rc5_init_folder</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isdir</span><span class="p">(</span><span class="n">old_folder</span><span class="p">):</span> <span class="c1"># pragma: no cover</span>
</span></span><span class="line"><span class="cl">            <span class="k">return</span> <span class="n">old_folder</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="n">new_folder</span>
</span></span><span class="line"><span class="cl">    <span class="k">def</span> <span class="nf">enable_unit_sysv</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">unit_file</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">        <span class="c1"># a &#34;multi-user.target&#34;/rc3 is also started in /rc5</span>
</span></span><span class="line"><span class="cl">        <span class="n">rc3</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_enable_unit_sysv</span><span class="p">(</span><span class="n">unit_file</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">rc3_root_folder</span><span class="p">())</span>
</span></span><span class="line"><span class="cl">        <span class="n">rc5</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_enable_unit_sysv</span><span class="p">(</span><span class="n">unit_file</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">rc5_root_folder</span><span class="p">())</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="n">rc3</span> <span class="ow">and</span> <span class="n">rc5</span>
</span></span><span class="line"><span class="cl">    <span class="k">def</span> <span class="nf">_enable_unit_sysv</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">unit_file</span><span class="p">,</span> <span class="n">rc_folder</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">        <span class="n">name</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">basename</span><span class="p">(</span><span class="n">unit_file</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="n">nameS</span> <span class="o">=</span> <span class="s2">&#34;S50&#34;</span><span class="o">+</span><span class="n">name</span>
</span></span><span class="line"><span class="cl">        <span class="n">nameK</span> <span class="o">=</span> <span class="s2">&#34;K50&#34;</span><span class="o">+</span><span class="n">name</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isdir</span><span class="p">(</span><span class="n">rc_folder</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">            <span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="n">rc_folder</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="c1"># do not double existing entries</span>
</span></span><span class="line"><span class="cl">        <span class="k">for</span> <span class="n">found</span> <span class="ow">in</span> <span class="n">os</span><span class="o">.</span><span class="n">listdir</span><span class="p">(</span><span class="n">rc_folder</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">            <span class="n">m</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="k">match</span><span class="p">(</span><span class="sa">r</span><span class="s2">&#34;S\d\d(.*)&#34;</span><span class="p">,</span> <span class="n">found</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">            <span class="k">if</span> <span class="n">m</span> <span class="ow">and</span> <span class="n">m</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="o">==</span> <span class="n">name</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">                <span class="n">nameS</span> <span class="o">=</span> <span class="n">found</span>
</span></span><span class="line"><span class="cl">            <span class="n">m</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="k">match</span><span class="p">(</span><span class="sa">r</span><span class="s2">&#34;K\d\d(.*)&#34;</span><span class="p">,</span> <span class="n">found</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">            <span class="k">if</span> <span class="n">m</span> <span class="ow">and</span> <span class="n">m</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="o">==</span> <span class="n">name</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">                <span class="n">nameK</span> <span class="o">=</span> <span class="n">found</span>
</span></span><span class="line"><span class="cl">        <span class="n">target</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">rc_folder</span><span class="p">,</span> <span class="n">nameS</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">target</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">            <span class="n">os</span><span class="o">.</span><span class="n">symlink</span><span class="p">(</span><span class="n">unit_file</span><span class="p">,</span> <span class="n">target</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="n">target</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">rc_folder</span><span class="p">,</span> <span class="n">nameK</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">target</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">            <span class="n">os</span><span class="o">.</span><span class="n">symlink</span><span class="p">(</span><span class="n">unit_file</span><span class="p">,</span> <span class="n">target</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="kc">True</span>
</span></span><span class="line"><span class="cl">    <span class="k">def</span> <span class="nf">disable_modules</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">modules</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">        <span class="s2">&#34;&#34;&#34; [UNIT]... -- disable these units &#34;&#34;&#34;</span>
</span></span><span class="line"><span class="cl">        <span class="n">found_all</span> <span class="o">=</span> <span class="kc">True</span>
</span></span><span class="line"><span class="cl">        <span class="n">units</span> <span class="o">=</span> <span class="p">[]</span>
</span></span><span class="line"><span class="cl">        <span class="k">for</span> <span class="n">module</span> <span class="ow">in</span> <span class="n">modules</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">            <span class="n">matched</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">match_units</span><span class="p">(</span><span class="n">to_list</span><span class="p">(</span><span class="n">module</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">            <span class="k">if</span> <span class="ow">not</span> <span class="n">matched</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">                <span class="n">logg</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&#34;Unit </span><span class="si">%s</span><span class="s2"> not found.&#34;</span><span class="p">,</span> <span class="n">unit_of</span><span class="p">(</span><span class="n">module</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">                <span class="c1"># self.error |= NOT_FOUND</span>
</span></span><span class="line"><span class="cl">                <span class="n">found_all</span> <span class="o">=</span> <span class="kc">False</span>
</span></span><span class="line"><span class="cl">                <span class="k">continue</span>
</span></span><span class="line"><span class="cl">            <span class="k">for</span> <span class="n">unit</span> <span class="ow">in</span> <span class="n">matched</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">                <span class="k">if</span> <span class="n">unit</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">units</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">                    <span class="n">units</span> <span class="o">+=</span> <span class="p">[</span><span class="n">unit</span><span class="p">]</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">disable_units</span><span class="p">(</span><span class="n">units</span><span class="p">)</span> <span class="ow">and</span> <span class="n">found_all</span>
</span></span><span class="line"><span class="cl">    <span class="k">def</span> <span class="nf">disable_units</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">units</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">        <span class="bp">self</span><span class="o">.</span><span class="n">wait_system</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">        <span class="n">done</span> <span class="o">=</span> <span class="kc">True</span>
</span></span><span class="line"><span class="cl">        <span class="k">for</span> <span class="n">unit</span> <span class="ow">in</span> <span class="n">units</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">            <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">disable_unit</span><span class="p">(</span><span class="n">unit</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">                <span class="n">done</span> <span class="o">=</span> <span class="kc">False</span>
</span></span><span class="line"><span class="cl">            <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">_now</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">                <span class="bp">self</span><span class="o">.</span><span class="n">stop_unit</span><span class="p">(</span><span class="n">unit</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="n">done</span>
</span></span><span class="line"><span class="cl">    <span class="k">def</span> <span class="nf">disable_unit</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">unit</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">        <span class="n">conf</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">load_unit_conf</span><span class="p">(</span><span class="n">unit</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="n">conf</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">            <span class="n">logg</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&#34;Unit </span><span class="si">%s</span><span class="s2"> not found.&#34;</span><span class="p">,</span> <span class="n">unit</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">            <span class="k">return</span> <span class="kc">False</span>
</span></span><span class="line"><span class="cl">        <span class="n">unit_file</span> <span class="o">=</span> <span class="n">conf</span><span class="o">.</span><span class="n">filename</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="n">unit_file</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">            <span class="n">logg</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&#34;Unit file </span><span class="si">%s</span><span class="s2"> not found.&#34;</span><span class="p">,</span> <span class="n">unit</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">            <span class="k">return</span> <span class="kc">False</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">is_sysv_file</span><span class="p">(</span><span class="n">unit_file</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">user_mode</span><span class="p">():</span>
</span></span><span class="line"><span class="cl">                <span class="n">logg</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&#34;Initscript </span><span class="si">%s</span><span class="s2"> not for --user mode&#34;</span><span class="p">,</span> <span class="n">unit</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">                <span class="k">return</span> <span class="kc">False</span>
</span></span><span class="line"><span class="cl">            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">disable_unit_sysv</span><span class="p">(</span><span class="n">unit_file</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">not_user_conf</span><span class="p">(</span><span class="n">conf</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">            <span class="n">logg</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&#34;Unit </span><span class="si">%s</span><span class="s2"> not for --user mode&#34;</span><span class="p">,</span> <span class="n">unit</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">            <span class="k">return</span> <span class="kc">False</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">disable_unit_from</span><span class="p">(</span><span class="n">conf</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="k">def</span> <span class="nf">disable_unit_from</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">conf</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">        <span class="n">wanted</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">wanted_from</span><span class="p">(</span><span class="n">conf</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="ow">not</span> <span class="n">wanted</span> <span class="ow">and</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_force</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">            <span class="n">logg</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&#34;</span><span class="si">%s</span><span class="s2"> has no target&#34;</span><span class="p">,</span> <span class="n">conf</span><span class="o">.</span><span class="n">name</span><span class="p">())</span>
</span></span><span class="line"><span class="cl">            <span class="k">return</span> <span class="kc">False</span> <span class="c1"># &#34;static&#34; is-enabled</span>
</span></span><span class="line"><span class="cl">        <span class="n">target</span> <span class="o">=</span> <span class="n">wanted</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_default_target</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">        <span class="k">for</span> <span class="n">folder</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">enablefolders</span><span class="p">(</span><span class="n">target</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_root</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">                <span class="n">folder</span> <span class="o">=</span> <span class="n">os_path</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_root</span><span class="p">,</span> <span class="n">folder</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">            <span class="n">symlink</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">folder</span><span class="p">,</span> <span class="n">conf</span><span class="o">.</span><span class="n">name</span><span class="p">())</span>
</span></span><span class="line"><span class="cl">            <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">symlink</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">                <span class="k">try</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">                    <span class="n">_f</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_force</span> <span class="ow">and</span> <span class="s2">&#34;-f&#34;</span> <span class="ow">or</span> <span class="s2">&#34;&#34;</span>
</span></span><span class="line"><span class="cl">                    <span class="n">logg</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&#34;rm </span><span class="si">{_f}</span><span class="s2"> &#39;</span><span class="si">{symlink}</span><span class="s2">&#39;&#34;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="o">**</span><span class="nb">locals</span><span class="p">()))</span>
</span></span><span class="line"><span class="cl">                    <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">islink</span><span class="p">(</span><span class="n">symlink</span><span class="p">)</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">_force</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">                        <span class="n">os</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">symlink</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">                <span class="k">except</span> <span class="ne">IOError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">                    <span class="n">logg</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&#34;disable </span><span class="si">%s</span><span class="s2">: </span><span class="si">%s</span><span class="s2">&#34;</span><span class="p">,</span> <span class="n">symlink</span><span class="p">,</span> <span class="n">e</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">                <span class="k">except</span> <span class="ne">OSError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">                    <span class="n">logg</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&#34;disable </span><span class="si">%s</span><span class="s2">: </span><span class="si">%s</span><span class="s2">&#34;</span><span class="p">,</span> <span class="n">symlink</span><span class="p">,</span> <span class="n">e</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="kc">True</span>
</span></span><span class="line"><span class="cl">    <span class="k">def</span> <span class="nf">disable_unit_sysv</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">unit_file</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">        <span class="n">rc3</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_disable_unit_sysv</span><span class="p">(</span><span class="n">unit_file</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">rc3_root_folder</span><span class="p">())</span>
</span></span><span class="line"><span class="cl">        <span class="n">rc5</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_disable_unit_sysv</span><span class="p">(</span><span class="n">unit_file</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">rc5_root_folder</span><span class="p">())</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="n">rc3</span> <span class="ow">and</span> <span class="n">rc5</span>
</span></span><span class="line"><span class="cl">    <span class="k">def</span> <span class="nf">_disable_unit_sysv</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">unit_file</span><span class="p">,</span> <span class="n">rc_folder</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">        <span class="c1"># a &#34;multi-user.target&#34;/rc3 is also started in /rc5</span>
</span></span><span class="line"><span class="cl">        <span class="n">name</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">basename</span><span class="p">(</span><span class="n">unit_file</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="n">nameS</span> <span class="o">=</span> <span class="s2">&#34;S50&#34;</span><span class="o">+</span><span class="n">name</span>
</span></span><span class="line"><span class="cl">        <span class="n">nameK</span> <span class="o">=</span> <span class="s2">&#34;K50&#34;</span><span class="o">+</span><span class="n">name</span>
</span></span><span class="line"><span class="cl">        <span class="c1"># do not forget the existing entries</span>
</span></span><span class="line"><span class="cl">        <span class="k">for</span> <span class="n">found</span> <span class="ow">in</span> <span class="n">os</span><span class="o">.</span><span class="n">listdir</span><span class="p">(</span><span class="n">rc_folder</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">            <span class="n">m</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="k">match</span><span class="p">(</span><span class="sa">r</span><span class="s2">&#34;S\d\d(.*)&#34;</span><span class="p">,</span> <span class="n">found</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">            <span class="k">if</span> <span class="n">m</span> <span class="ow">and</span> <span class="n">m</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="o">==</span> <span class="n">name</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">                <span class="n">nameS</span> <span class="o">=</span> <span class="n">found</span>
</span></span><span class="line"><span class="cl">            <span class="n">m</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="k">match</span><span class="p">(</span><span class="sa">r</span><span class="s2">&#34;K\d\d(.*)&#34;</span><span class="p">,</span> <span class="n">found</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">            <span class="k">if</span> <span class="n">m</span> <span class="ow">and</span> <span class="n">m</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="o">==</span> <span class="n">name</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">                <span class="n">nameK</span> <span class="o">=</span> <span class="n">found</span>
</span></span><span class="line"><span class="cl">        <span class="n">target</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">rc_folder</span><span class="p">,</span> <span class="n">nameS</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">target</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">            <span class="n">os</span><span class="o">.</span><span class="n">unlink</span><span class="p">(</span><span class="n">target</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="n">target</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">rc_folder</span><span class="p">,</span> <span class="n">nameK</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">target</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">            <span class="n">os</span><span class="o">.</span><span class="n">unlink</span><span class="p">(</span><span class="n">target</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="kc">True</span>
</span></span><span class="line"><span class="cl">    <span class="k">def</span> <span class="nf">is_enabled_sysv</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">unit_file</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">        <span class="n">name</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">basename</span><span class="p">(</span><span class="n">unit_file</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="n">target</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">rc3_root_folder</span><span class="p">(),</span> <span class="s2">&#34;S50</span><span class="si">%s</span><span class="s2">&#34;</span> <span class="o">%</span> <span class="n">name</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">target</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">            <span class="k">return</span> <span class="kc">True</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="kc">False</span>
</span></span><span class="line"><span class="cl">    <span class="k">def</span> <span class="nf">is_enabled_modules</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">modules</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">        <span class="s2">&#34;&#34;&#34; [UNIT]... -- check if these units are enabled
</span></span></span><span class="line"><span class="cl"><span class="s2">        returns True if any of them is enabled.&#34;&#34;&#34;</span>
</span></span><span class="line"><span class="cl">        <span class="n">found_all</span> <span class="o">=</span> <span class="kc">True</span>
</span></span><span class="line"><span class="cl">        <span class="n">units</span> <span class="o">=</span> <span class="p">[]</span>
</span></span><span class="line"><span class="cl">        <span class="k">for</span> <span class="n">module</span> <span class="ow">in</span> <span class="n">modules</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">            <span class="n">matched</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">match_units</span><span class="p">(</span><span class="n">to_list</span><span class="p">(</span><span class="n">module</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">            <span class="k">if</span> <span class="ow">not</span> <span class="n">matched</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">                <span class="n">logg</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&#34;Unit </span><span class="si">%s</span><span class="s2"> not found.&#34;</span><span class="p">,</span> <span class="n">unit_of</span><span class="p">(</span><span class="n">module</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">                <span class="c1"># self.error |= NOT_FOUND</span>
</span></span><span class="line"><span class="cl">                <span class="n">found_all</span> <span class="o">=</span> <span class="kc">False</span>
</span></span><span class="line"><span class="cl">                <span class="k">continue</span>
</span></span><span class="line"><span class="cl">            <span class="k">for</span> <span class="n">unit</span> <span class="ow">in</span> <span class="n">matched</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">                <span class="k">if</span> <span class="n">unit</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">units</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">                    <span class="n">units</span> <span class="o">+=</span> <span class="p">[</span><span class="n">unit</span><span class="p">]</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">is_enabled_units</span><span class="p">(</span><span class="n">units</span><span class="p">)</span> <span class="c1"># and found_all</span>
</span></span><span class="line"><span class="cl">    <span class="k">def</span> <span class="nf">is_enabled_units</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">units</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">        <span class="s2">&#34;&#34;&#34; true if any is enabled, and a list of infos &#34;&#34;&#34;</span>
</span></span><span class="line"><span class="cl">        <span class="n">result</span> <span class="o">=</span> <span class="kc">False</span>
</span></span><span class="line"><span class="cl">        <span class="n">infos</span> <span class="o">=</span> <span class="p">[]</span>
</span></span><span class="line"><span class="cl">        <span class="k">for</span> <span class="n">unit</span> <span class="ow">in</span> <span class="n">units</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">            <span class="n">infos</span> <span class="o">+=</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">enabled_unit</span><span class="p">(</span><span class="n">unit</span><span class="p">)]</span>
</span></span><span class="line"><span class="cl">            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">is_enabled</span><span class="p">(</span><span class="n">unit</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">                <span class="n">result</span> <span class="o">=</span> <span class="kc">True</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="ow">not</span> <span class="n">result</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">            <span class="bp">self</span><span class="o">.</span><span class="n">error</span> <span class="o">|=</span> <span class="n">NOT_OK</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="n">infos</span>
</span></span><span class="line"><span class="cl">    <span class="k">def</span> <span class="nf">is_enabled</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">unit</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">        <span class="n">conf</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">load_unit_conf</span><span class="p">(</span><span class="n">unit</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="n">conf</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">            <span class="n">logg</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&#34;Unit </span><span class="si">%s</span><span class="s2"> not found.&#34;</span><span class="p">,</span> <span class="n">unit</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">            <span class="k">return</span> <span class="kc">False</span>
</span></span><span class="line"><span class="cl">        <span class="n">unit_file</span> <span class="o">=</span> <span class="n">conf</span><span class="o">.</span><span class="n">filename</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="ow">not</span> <span class="n">unit_file</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">            <span class="n">logg</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&#34;Unit </span><span class="si">%s</span><span class="s2"> not found.&#34;</span><span class="p">,</span> <span class="n">unit</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">            <span class="k">return</span> <span class="kc">False</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">is_sysv_file</span><span class="p">(</span><span class="n">unit_file</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">is_enabled_sysv</span><span class="p">(</span><span class="n">unit_file</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="n">state</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_enabled_from</span><span class="p">(</span><span class="n">conf</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="n">state</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&#34;enabled&#34;</span><span class="p">,</span> <span class="s2">&#34;static&#34;</span><span class="p">]:</span>
</span></span><span class="line"><span class="cl">            <span class="k">return</span> <span class="kc">True</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="kc">False</span> <span class="c1"># [&#34;disabled&#34;, &#34;masked&#34;]</span>
</span></span><span class="line"><span class="cl">    <span class="k">def</span> <span class="nf">enabled_unit</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">unit</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">        <span class="n">conf</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_unit_conf</span><span class="p">(</span><span class="n">unit</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">enabled_from</span><span class="p">(</span><span class="n">conf</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="k">def</span> <span class="nf">enabled_from</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">conf</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">        <span class="n">unit_file</span> <span class="o">=</span> <span class="n">strE</span><span class="p">(</span><span class="n">conf</span><span class="o">.</span><span class="n">filename</span><span class="p">())</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">is_sysv_file</span><span class="p">(</span><span class="n">unit_file</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">            <span class="n">state</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">is_enabled_sysv</span><span class="p">(</span><span class="n">unit_file</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">            <span class="k">if</span> <span class="n">state</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">                <span class="k">return</span> <span class="s2">&#34;enabled&#34;</span>
</span></span><span class="line"><span class="cl">            <span class="k">return</span> <span class="s2">&#34;disabled&#34;</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_enabled_from</span><span class="p">(</span><span class="n">conf</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="k">def</span> <span class="nf">get_enabled_from</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">conf</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="n">conf</span><span class="o">.</span><span class="n">masked</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">            <span class="k">return</span> <span class="s2">&#34;masked&#34;</span>
</span></span><span class="line"><span class="cl">        <span class="n">wanted</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">wanted_from</span><span class="p">(</span><span class="n">conf</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="n">target</span> <span class="o">=</span> <span class="n">wanted</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_default_target</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">        <span class="k">for</span> <span class="n">folder</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">enablefolders</span><span class="p">(</span><span class="n">target</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_root</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">                <span class="n">folder</span> <span class="o">=</span> <span class="n">os_path</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_root</span><span class="p">,</span> <span class="n">folder</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">            <span class="n">target</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">folder</span><span class="p">,</span> <span class="n">conf</span><span class="o">.</span><span class="n">name</span><span class="p">())</span>
</span></span><span class="line"><span class="cl">            <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isfile</span><span class="p">(</span><span class="n">target</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">                <span class="k">return</span> <span class="s2">&#34;enabled&#34;</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="ow">not</span> <span class="n">wanted</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">            <span class="k">return</span> <span class="s2">&#34;static&#34;</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="s2">&#34;disabled&#34;</span>
</span></span><span class="line"><span class="cl">    <span class="k">def</span> <span class="nf">mask_modules</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">modules</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">        <span class="s2">&#34;&#34;&#34; [UNIT]... -- mask non-startable units &#34;&#34;&#34;</span>
</span></span><span class="line"><span class="cl">        <span class="n">found_all</span> <span class="o">=</span> <span class="kc">True</span>
</span></span><span class="line"><span class="cl">        <span class="n">units</span> <span class="o">=</span> <span class="p">[]</span>
</span></span><span class="line"><span class="cl">        <span class="k">for</span> <span class="n">module</span> <span class="ow">in</span> <span class="n">modules</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">            <span class="n">matched</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">match_units</span><span class="p">(</span><span class="n">to_list</span><span class="p">(</span><span class="n">module</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">            <span class="k">if</span> <span class="ow">not</span> <span class="n">matched</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">                <span class="n">logg</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&#34;Unit </span><span class="si">%s</span><span class="s2"> not found.&#34;</span><span class="p">,</span> <span class="n">unit_of</span><span class="p">(</span><span class="n">module</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">                <span class="bp">self</span><span class="o">.</span><span class="n">error</span> <span class="o">|=</span> <span class="n">NOT_FOUND</span>
</span></span><span class="line"><span class="cl">                <span class="n">found_all</span> <span class="o">=</span> <span class="kc">False</span>
</span></span><span class="line"><span class="cl">                <span class="k">continue</span>
</span></span><span class="line"><span class="cl">            <span class="k">for</span> <span class="n">unit</span> <span class="ow">in</span> <span class="n">matched</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">                <span class="k">if</span> <span class="n">unit</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">units</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">                    <span class="n">units</span> <span class="o">+=</span> <span class="p">[</span><span class="n">unit</span><span class="p">]</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">mask_units</span><span class="p">(</span><span class="n">units</span><span class="p">)</span> <span class="ow">and</span> <span class="n">found_all</span>
</span></span><span class="line"><span class="cl">    <span class="k">def</span> <span class="nf">mask_units</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">units</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">        <span class="bp">self</span><span class="o">.</span><span class="n">wait_system</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">        <span class="n">done</span> <span class="o">=</span> <span class="kc">True</span>
</span></span><span class="line"><span class="cl">        <span class="k">for</span> <span class="n">unit</span> <span class="ow">in</span> <span class="n">units</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">            <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">mask_unit</span><span class="p">(</span><span class="n">unit</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">                <span class="n">done</span> <span class="o">=</span> <span class="kc">False</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="n">done</span>
</span></span><span class="line"><span class="cl">    <span class="k">def</span> <span class="nf">mask_unit</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">unit</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">        <span class="n">unit_file</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">unit_file</span><span class="p">(</span><span class="n">unit</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="ow">not</span> <span class="n">unit_file</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">            <span class="n">logg</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&#34;Unit </span><span class="si">%s</span><span class="s2"> not found.&#34;</span><span class="p">,</span> <span class="n">unit</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">            <span class="k">return</span> <span class="kc">False</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">is_sysv_file</span><span class="p">(</span><span class="n">unit_file</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">            <span class="n">logg</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&#34;Initscript </span><span class="si">%s</span><span class="s2"> can not be masked&#34;</span><span class="p">,</span> <span class="n">unit</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">            <span class="k">return</span> <span class="kc">False</span>
</span></span><span class="line"><span class="cl">        <span class="n">conf</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_unit_conf</span><span class="p">(</span><span class="n">unit</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">not_user_conf</span><span class="p">(</span><span class="n">conf</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">            <span class="n">logg</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&#34;Unit </span><span class="si">%s</span><span class="s2"> not for --user mode&#34;</span><span class="p">,</span> <span class="n">unit</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">            <span class="k">return</span> <span class="kc">False</span>
</span></span><span class="line"><span class="cl">        <span class="n">folder</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">mask_folder</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_root</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">            <span class="n">folder</span> <span class="o">=</span> <span class="n">os_path</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_root</span><span class="p">,</span> <span class="n">folder</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isdir</span><span class="p">(</span><span class="n">folder</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">            <span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="n">folder</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="n">target</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">folder</span><span class="p">,</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">basename</span><span class="p">(</span><span class="n">unit_file</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">        <span class="n">dev_null</span> <span class="o">=</span> <span class="n">_dev_null</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="kc">True</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">            <span class="n">_f</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_force</span> <span class="ow">and</span> <span class="s2">&#34;-f&#34;</span> <span class="ow">or</span> <span class="s2">&#34;&#34;</span>
</span></span><span class="line"><span class="cl">            <span class="n">logg</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&#34;ln -s </span><span class="si">{_f}</span><span class="s2"> </span><span class="si">{dev_null}</span><span class="s2"> &#39;</span><span class="si">{target}</span><span class="s2">&#39;&#34;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="o">**</span><span class="nb">locals</span><span class="p">()))</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_force</span> <span class="ow">and</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">islink</span><span class="p">(</span><span class="n">target</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">            <span class="n">os</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">target</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">target</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">            <span class="n">os</span><span class="o">.</span><span class="n">symlink</span><span class="p">(</span><span class="n">dev_null</span><span class="p">,</span> <span class="n">target</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">            <span class="n">logg</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&#34;Created symlink </span><span class="si">{target}</span><span class="s2"> -&gt; </span><span class="si">{dev_null}</span><span class="s2">&#34;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="o">**</span><span class="nb">locals</span><span class="p">()))</span>
</span></span><span class="line"><span class="cl">            <span class="k">return</span> <span class="kc">True</span>
</span></span><span class="line"><span class="cl">        <span class="k">elif</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">islink</span><span class="p">(</span><span class="n">target</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">            <span class="n">logg</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&#34;mask symlink does already exist: </span><span class="si">%s</span><span class="s2">&#34;</span><span class="p">,</span> <span class="n">target</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">            <span class="k">return</span> <span class="kc">True</span>
</span></span><span class="line"><span class="cl">        <span class="k">else</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">            <span class="n">logg</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&#34;mask target does already exist: </span><span class="si">%s</span><span class="s2">&#34;</span><span class="p">,</span> <span class="n">target</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">            <span class="k">return</span> <span class="kc">False</span>
</span></span><span class="line"><span class="cl">    <span class="k">def</span> <span class="nf">mask_folder</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">        <span class="k">for</span> <span class="n">folder</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">mask_folders</span><span class="p">():</span>
</span></span><span class="line"><span class="cl">            <span class="k">if</span> <span class="n">folder</span><span class="p">:</span> <span class="k">return</span> <span class="n">folder</span>
</span></span><span class="line"><span class="cl">        <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s2">&#34;did not find any systemd/system folder&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="k">def</span> <span class="nf">mask_folders</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">user_mode</span><span class="p">():</span>
</span></span><span class="line"><span class="cl">            <span class="k">for</span> <span class="n">folder</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">user_folders</span><span class="p">():</span>
</span></span><span class="line"><span class="cl">                <span class="k">yield</span> <span class="n">folder</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="kc">True</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">            <span class="k">for</span> <span class="n">folder</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">system_folders</span><span class="p">():</span>
</span></span><span class="line"><span class="cl">                <span class="k">yield</span> <span class="n">folder</span>
</span></span><span class="line"><span class="cl">    <span class="k">def</span> <span class="nf">unmask_modules</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">modules</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">        <span class="s2">&#34;&#34;&#34; [UNIT]... -- unmask non-startable units &#34;&#34;&#34;</span>
</span></span><span class="line"><span class="cl">        <span class="n">found_all</span> <span class="o">=</span> <span class="kc">True</span>
</span></span><span class="line"><span class="cl">        <span class="n">units</span> <span class="o">=</span> <span class="p">[]</span>
</span></span><span class="line"><span class="cl">        <span class="k">for</span> <span class="n">module</span> <span class="ow">in</span> <span class="n">modules</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">            <span class="n">matched</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">match_units</span><span class="p">(</span><span class="n">to_list</span><span class="p">(</span><span class="n">module</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">            <span class="k">if</span> <span class="ow">not</span> <span class="n">matched</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">                <span class="n">logg</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&#34;Unit </span><span class="si">%s</span><span class="s2"> not found.&#34;</span><span class="p">,</span> <span class="n">unit_of</span><span class="p">(</span><span class="n">module</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">                <span class="bp">self</span><span class="o">.</span><span class="n">error</span> <span class="o">|=</span> <span class="n">NOT_FOUND</span>
</span></span><span class="line"><span class="cl">                <span class="n">found_all</span> <span class="o">=</span> <span class="kc">False</span>
</span></span><span class="line"><span class="cl">                <span class="k">continue</span>
</span></span><span class="line"><span class="cl">            <span class="k">for</span> <span class="n">unit</span> <span class="ow">in</span> <span class="n">matched</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">                <span class="k">if</span> <span class="n">unit</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">units</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">                    <span class="n">units</span> <span class="o">+=</span> <span class="p">[</span><span class="n">unit</span><span class="p">]</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">unmask_units</span><span class="p">(</span><span class="n">units</span><span class="p">)</span> <span class="ow">and</span> <span class="n">found_all</span>
</span></span><span class="line"><span class="cl">    <span class="k">def</span> <span class="nf">unmask_units</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">units</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">        <span class="bp">self</span><span class="o">.</span><span class="n">wait_system</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">        <span class="n">done</span> <span class="o">=</span> <span class="kc">True</span>
</span></span><span class="line"><span class="cl">        <span class="k">for</span> <span class="n">unit</span> <span class="ow">in</span> <span class="n">units</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">            <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">unmask_unit</span><span class="p">(</span><span class="n">unit</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">                <span class="n">done</span> <span class="o">=</span> <span class="kc">False</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="n">done</span>
</span></span><span class="line"><span class="cl">    <span class="k">def</span> <span class="nf">unmask_unit</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">unit</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">        <span class="n">unit_file</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">unit_file</span><span class="p">(</span><span class="n">unit</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="ow">not</span> <span class="n">unit_file</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">            <span class="n">logg</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&#34;Unit </span><span class="si">%s</span><span class="s2"> not found.&#34;</span><span class="p">,</span> <span class="n">unit</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">            <span class="k">return</span> <span class="kc">False</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">is_sysv_file</span><span class="p">(</span><span class="n">unit_file</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">            <span class="n">logg</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&#34;Initscript </span><span class="si">%s</span><span class="s2"> can not be un/masked&#34;</span><span class="p">,</span> <span class="n">unit</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">            <span class="k">return</span> <span class="kc">False</span>
</span></span><span class="line"><span class="cl">        <span class="n">conf</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_unit_conf</span><span class="p">(</span><span class="n">unit</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">not_user_conf</span><span class="p">(</span><span class="n">conf</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">            <span class="n">logg</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&#34;Unit </span><span class="si">%s</span><span class="s2"> not for --user mode&#34;</span><span class="p">,</span> <span class="n">unit</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">            <span class="k">return</span> <span class="kc">False</span>
</span></span><span class="line"><span class="cl">        <span class="n">folder</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">mask_folder</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_root</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">            <span class="n">folder</span> <span class="o">=</span> <span class="n">os_path</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_root</span><span class="p">,</span> <span class="n">folder</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="n">target</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">folder</span><span class="p">,</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">basename</span><span class="p">(</span><span class="n">unit_file</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="kc">True</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">            <span class="n">_f</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_force</span> <span class="ow">and</span> <span class="s2">&#34;-f&#34;</span> <span class="ow">or</span> <span class="s2">&#34;&#34;</span>
</span></span><span class="line"><span class="cl">            <span class="n">logg</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&#34;rm </span><span class="si">{_f}</span><span class="s2"> &#39;</span><span class="si">{target}</span><span class="s2">&#39;&#34;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="o">**</span><span class="nb">locals</span><span class="p">()))</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">islink</span><span class="p">(</span><span class="n">target</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">            <span class="n">os</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">target</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">            <span class="k">return</span> <span class="kc">True</span>
</span></span><span class="line"><span class="cl">        <span class="k">elif</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">target</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">            <span class="n">logg</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&#34;Symlink did not exist anymore: </span><span class="si">%s</span><span class="s2">&#34;</span><span class="p">,</span> <span class="n">target</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">            <span class="k">return</span> <span class="kc">True</span>
</span></span><span class="line"><span class="cl">        <span class="k">else</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">            <span class="n">logg</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&#34;target is not a symlink: </span><span class="si">%s</span><span class="s2">&#34;</span><span class="p">,</span> <span class="n">target</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">            <span class="k">return</span> <span class="kc">True</span>
</span></span><span class="line"><span class="cl">    <span class="k">def</span> <span class="nf">list_dependencies_modules</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">modules</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">        <span class="s2">&#34;&#34;&#34; [UNIT]... show the dependency tree&#34;
</span></span></span><span class="line"><span class="cl"><span class="s2">        &#34;&#34;&#34;</span>
</span></span><span class="line"><span class="cl">        <span class="n">found_all</span> <span class="o">=</span> <span class="kc">True</span>
</span></span><span class="line"><span class="cl">        <span class="n">units</span> <span class="o">=</span> <span class="p">[]</span>
</span></span><span class="line"><span class="cl">        <span class="k">for</span> <span class="n">module</span> <span class="ow">in</span> <span class="n">modules</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">            <span class="n">matched</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">match_units</span><span class="p">(</span><span class="n">to_list</span><span class="p">(</span><span class="n">module</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">            <span class="k">if</span> <span class="ow">not</span> <span class="n">matched</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">                <span class="n">logg</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&#34;Unit </span><span class="si">%s</span><span class="s2"> could not be found.&#34;</span><span class="p">,</span> <span class="n">unit_of</span><span class="p">(</span><span class="n">module</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">                <span class="n">found_all</span> <span class="o">=</span> <span class="kc">False</span>
</span></span><span class="line"><span class="cl">                <span class="k">continue</span>
</span></span><span class="line"><span class="cl">            <span class="k">for</span> <span class="n">unit</span> <span class="ow">in</span> <span class="n">matched</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">                <span class="k">if</span> <span class="n">unit</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">units</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">                    <span class="n">units</span> <span class="o">+=</span> <span class="p">[</span><span class="n">unit</span><span class="p">]</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">list_dependencies_units</span><span class="p">(</span><span class="n">units</span><span class="p">)</span> <span class="c1"># and found_all</span>
</span></span><span class="line"><span class="cl">    <span class="k">def</span> <span class="nf">list_dependencies_units</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">units</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">        <span class="n">result</span> <span class="o">=</span> <span class="p">[]</span>
</span></span><span class="line"><span class="cl">        <span class="k">for</span> <span class="n">unit</span> <span class="ow">in</span> <span class="n">units</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">            <span class="k">if</span> <span class="n">result</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">                <span class="n">result</span> <span class="o">+=</span> <span class="p">[</span><span class="s2">&#34;&#34;</span><span class="p">,</span> <span class="s2">&#34;&#34;</span><span class="p">]</span>
</span></span><span class="line"><span class="cl">            <span class="n">result</span> <span class="o">+=</span> <span class="bp">self</span><span class="o">.</span><span class="n">list_dependencies_unit</span><span class="p">(</span><span class="n">unit</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="n">result</span>
</span></span><span class="line"><span class="cl">    <span class="k">def</span> <span class="nf">list_dependencies_unit</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">unit</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">        <span class="n">result</span> <span class="o">=</span> <span class="p">[]</span>
</span></span><span class="line"><span class="cl">        <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">list_dependencies</span><span class="p">(</span><span class="n">unit</span><span class="p">,</span> <span class="s2">&#34;&#34;</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">            <span class="n">result</span> <span class="o">+=</span> <span class="p">[</span><span class="n">line</span><span class="p">]</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="n">result</span>
</span></span><span class="line"><span class="cl">    <span class="k">def</span> <span class="nf">list_dependencies</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">unit</span><span class="p">,</span> <span class="n">indent</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">mark</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">loop</span> <span class="o">=</span> <span class="p">[]):</span>
</span></span><span class="line"><span class="cl">        <span class="n">mapping</span> <span class="o">=</span> <span class="p">{}</span>
</span></span><span class="line"><span class="cl">        <span class="n">mapping</span><span class="p">[</span><span class="s2">&#34;Requires&#34;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&#34;required to start&#34;</span>
</span></span><span class="line"><span class="cl">        <span class="n">mapping</span><span class="p">[</span><span class="s2">&#34;Wants&#34;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&#34;wanted to start&#34;</span>
</span></span><span class="line"><span class="cl">        <span class="n">mapping</span><span class="p">[</span><span class="s2">&#34;Requisite&#34;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&#34;required started&#34;</span>
</span></span><span class="line"><span class="cl">        <span class="n">mapping</span><span class="p">[</span><span class="s2">&#34;Bindsto&#34;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&#34;binds to start&#34;</span>
</span></span><span class="line"><span class="cl">        <span class="n">mapping</span><span class="p">[</span><span class="s2">&#34;PartOf&#34;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&#34;part of started&#34;</span>
</span></span><span class="line"><span class="cl">        <span class="n">mapping</span><span class="p">[</span><span class="s2">&#34;.requires&#34;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&#34;.required to start&#34;</span>
</span></span><span class="line"><span class="cl">        <span class="n">mapping</span><span class="p">[</span><span class="s2">&#34;.wants&#34;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&#34;.wanted to start&#34;</span>
</span></span><span class="line"><span class="cl">        <span class="n">mapping</span><span class="p">[</span><span class="s2">&#34;PropagateReloadTo&#34;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&#34;(to be reloaded as well)&#34;</span>
</span></span><span class="line"><span class="cl">        <span class="n">mapping</span><span class="p">[</span><span class="s2">&#34;Conflicts&#34;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&#34;(to be stopped on conflict)&#34;</span>
</span></span><span class="line"><span class="cl">        <span class="n">restrict</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&#34;Requires&#34;</span><span class="p">,</span> <span class="s2">&#34;Requisite&#34;</span><span class="p">,</span> <span class="s2">&#34;ConsistsOf&#34;</span><span class="p">,</span> <span class="s2">&#34;Wants&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                    <span class="s2">&#34;BindsTo&#34;</span><span class="p">,</span> <span class="s2">&#34;.requires&#34;</span><span class="p">,</span> <span class="s2">&#34;.wants&#34;</span><span class="p">]</span>
</span></span><span class="line"><span class="cl">        <span class="n">indent</span> <span class="o">=</span> <span class="n">indent</span> <span class="ow">or</span> <span class="s2">&#34;&#34;</span>
</span></span><span class="line"><span class="cl">        <span class="n">mark</span> <span class="o">=</span> <span class="n">mark</span> <span class="ow">or</span> <span class="s2">&#34;&#34;</span>
</span></span><span class="line"><span class="cl">        <span class="n">deps</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_dependencies_unit</span><span class="p">(</span><span class="n">unit</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="n">conf</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_unit_conf</span><span class="p">(</span><span class="n">unit</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="ow">not</span> <span class="n">conf</span><span class="o">.</span><span class="n">loaded</span><span class="p">():</span>
</span></span><span class="line"><span class="cl">            <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_show_all</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">                <span class="k">return</span>
</span></span><span class="line"><span class="cl">            <span class="k">yield</span> <span class="s2">&#34;</span><span class="si">%s</span><span class="s2">(</span><span class="si">%s</span><span class="s2">): </span><span class="si">%s</span><span class="s2">&#34;</span> <span class="o">%</span> <span class="p">(</span><span class="n">indent</span><span class="p">,</span> <span class="n">unit</span><span class="p">,</span> <span class="n">mark</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="k">else</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">            <span class="k">yield</span> <span class="s2">&#34;</span><span class="si">%s%s</span><span class="s2">: </span><span class="si">%s</span><span class="s2">&#34;</span> <span class="o">%</span> <span class="p">(</span><span class="n">indent</span><span class="p">,</span> <span class="n">unit</span><span class="p">,</span> <span class="n">mark</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">            <span class="k">for</span> <span class="n">stop_recursion</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&#34;Conflict&#34;</span><span class="p">,</span> <span class="s2">&#34;conflict&#34;</span><span class="p">,</span> <span class="s2">&#34;reloaded&#34;</span><span class="p">,</span> <span class="s2">&#34;Propagate&#34;</span><span class="p">]:</span>
</span></span><span class="line"><span class="cl">                <span class="k">if</span> <span class="n">stop_recursion</span> <span class="ow">in</span> <span class="n">mark</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">                    <span class="k">return</span>
</span></span><span class="line"><span class="cl">            <span class="k">for</span> <span class="n">dep</span> <span class="ow">in</span> <span class="n">deps</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">                <span class="k">if</span> <span class="n">dep</span> <span class="ow">in</span> <span class="n">loop</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">                    <span class="n">logg</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&#34;detected loop at </span><span class="si">%s</span><span class="s2">&#34;</span><span class="p">,</span> <span class="n">dep</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">                    <span class="k">continue</span>
</span></span><span class="line"><span class="cl">                <span class="n">new_loop</span> <span class="o">=</span> <span class="n">loop</span> <span class="o">+</span> <span class="nb">list</span><span class="p">(</span><span class="n">deps</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>
</span></span><span class="line"><span class="cl">                <span class="n">new_indent</span> <span class="o">=</span> <span class="n">indent</span> <span class="o">+</span> <span class="s2">&#34;| &#34;</span>
</span></span><span class="line"><span class="cl">                <span class="n">new_mark</span> <span class="o">=</span> <span class="n">deps</span><span class="p">[</span><span class="n">dep</span><span class="p">]</span>
</span></span><span class="line"><span class="cl">                <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_show_all</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">                    <span class="k">if</span> <span class="n">new_mark</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">restrict</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">                        <span class="k">continue</span>
</span></span><span class="line"><span class="cl">                <span class="k">if</span> <span class="n">new_mark</span> <span class="ow">in</span> <span class="n">mapping</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">                    <span class="n">new_mark</span> <span class="o">=</span> <span class="n">mapping</span><span class="p">[</span><span class="n">new_mark</span><span class="p">]</span>
</span></span><span class="line"><span class="cl">                <span class="n">restrict</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&#34;Requires&#34;</span><span class="p">,</span> <span class="s2">&#34;Wants&#34;</span><span class="p">,</span> <span class="s2">&#34;Requisite&#34;</span><span class="p">,</span> <span class="s2">&#34;BindsTo&#34;</span><span class="p">,</span> <span class="s2">&#34;PartOf&#34;</span><span class="p">,</span> <span class="s2">&#34;ConsistsOf&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                            <span class="s2">&#34;.requires&#34;</span><span class="p">,</span> <span class="s2">&#34;.wants&#34;</span><span class="p">]</span>
</span></span><span class="line"><span class="cl">                <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">list_dependencies</span><span class="p">(</span><span class="n">dep</span><span class="p">,</span> <span class="n">new_indent</span><span class="p">,</span> <span class="n">new_mark</span><span class="p">,</span> <span class="n">new_loop</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">                    <span class="k">yield</span> <span class="n">line</span>
</span></span><span class="line"><span class="cl">    <span class="k">def</span> <span class="nf">get_dependencies_unit</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">unit</span><span class="p">,</span> <span class="n">styles</span> <span class="o">=</span> <span class="kc">None</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">        <span class="n">styles</span> <span class="o">=</span> <span class="n">styles</span> <span class="ow">or</span> <span class="p">[</span><span class="s2">&#34;Requires&#34;</span><span class="p">,</span> <span class="s2">&#34;Wants&#34;</span><span class="p">,</span> <span class="s2">&#34;Requisite&#34;</span><span class="p">,</span> <span class="s2">&#34;BindsTo&#34;</span><span class="p">,</span> <span class="s2">&#34;PartOf&#34;</span><span class="p">,</span> <span class="s2">&#34;ConsistsOf&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                            <span class="s2">&#34;.requires&#34;</span><span class="p">,</span> <span class="s2">&#34;.wants&#34;</span><span class="p">,</span> <span class="s2">&#34;PropagateReloadTo&#34;</span><span class="p">,</span> <span class="s2">&#34;Conflicts&#34;</span><span class="p">,</span> <span class="p">]</span>
</span></span><span class="line"><span class="cl">        <span class="n">conf</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_unit_conf</span><span class="p">(</span><span class="n">unit</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="n">deps</span> <span class="o">=</span> <span class="p">{}</span>
</span></span><span class="line"><span class="cl">        <span class="k">for</span> <span class="n">style</span> <span class="ow">in</span> <span class="n">styles</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">            <span class="k">if</span> <span class="n">style</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s2">&#34;.&#34;</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">                <span class="k">for</span> <span class="n">folder</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">sysd_folders</span><span class="p">():</span>
</span></span><span class="line"><span class="cl">                    <span class="k">if</span> <span class="ow">not</span> <span class="n">folder</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">                        <span class="k">continue</span>
</span></span><span class="line"><span class="cl">                    <span class="n">require_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">folder</span><span class="p">,</span> <span class="n">unit</span> <span class="o">+</span> <span class="n">style</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">                    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_root</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">                        <span class="n">require_path</span> <span class="o">=</span> <span class="n">os_path</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_root</span><span class="p">,</span> <span class="n">require_path</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">                    <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isdir</span><span class="p">(</span><span class="n">require_path</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">                        <span class="k">for</span> <span class="n">required</span> <span class="ow">in</span> <span class="n">os</span><span class="o">.</span><span class="n">listdir</span><span class="p">(</span><span class="n">require_path</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">                            <span class="k">if</span> <span class="n">required</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">deps</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">                                <span class="n">deps</span><span class="p">[</span><span class="n">required</span><span class="p">]</span> <span class="o">=</span> <span class="n">style</span>
</span></span><span class="line"><span class="cl">            <span class="k">else</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">                <span class="k">for</span> <span class="n">requirelist</span> <span class="ow">in</span> <span class="n">conf</span><span class="o">.</span><span class="n">getlist</span><span class="p">(</span><span class="n">Unit</span><span class="p">,</span> <span class="n">style</span><span class="p">,</span> <span class="p">[]):</span>
</span></span><span class="line"><span class="cl">                    <span class="k">for</span> <span class="n">required</span> <span class="ow">in</span> <span class="n">requirelist</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&#34; &#34;</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">                        <span class="n">deps</span><span class="p">[</span><span class="n">required</span><span class="o">.</span><span class="n">strip</span><span class="p">()]</span> <span class="o">=</span> <span class="n">style</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="n">deps</span>
</span></span><span class="line"><span class="cl">    <span class="k">def</span> <span class="nf">get_required_dependencies</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">unit</span><span class="p">,</span> <span class="n">styles</span> <span class="o">=</span> <span class="kc">None</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">        <span class="n">styles</span> <span class="o">=</span> <span class="n">styles</span> <span class="ow">or</span> <span class="p">[</span><span class="s2">&#34;Requires&#34;</span><span class="p">,</span> <span class="s2">&#34;Wants&#34;</span><span class="p">,</span> <span class="s2">&#34;Requisite&#34;</span><span class="p">,</span> <span class="s2">&#34;BindsTo&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                            <span class="s2">&#34;.requires&#34;</span><span class="p">,</span> <span class="s2">&#34;.wants&#34;</span><span class="p">]</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_dependencies_unit</span><span class="p">(</span><span class="n">unit</span><span class="p">,</span> <span class="n">styles</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="k">def</span> <span class="nf">get_start_dependencies</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">unit</span><span class="p">,</span> <span class="n">styles</span> <span class="o">=</span> <span class="kc">None</span><span class="p">):</span> <span class="c1"># pragma: no cover</span>
</span></span><span class="line"><span class="cl">        <span class="s2">&#34;&#34;&#34; the list of services to be started as well / TODO: unused &#34;&#34;&#34;</span>
</span></span><span class="line"><span class="cl">        <span class="n">styles</span> <span class="o">=</span> <span class="n">styles</span> <span class="ow">or</span> <span class="p">[</span><span class="s2">&#34;Requires&#34;</span><span class="p">,</span> <span class="s2">&#34;Wants&#34;</span><span class="p">,</span> <span class="s2">&#34;Requisite&#34;</span><span class="p">,</span> <span class="s2">&#34;BindsTo&#34;</span><span class="p">,</span> <span class="s2">&#34;PartOf&#34;</span><span class="p">,</span> <span class="s2">&#34;ConsistsOf&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                            <span class="s2">&#34;.requires&#34;</span><span class="p">,</span> <span class="s2">&#34;.wants&#34;</span><span class="p">]</span>
</span></span><span class="line"><span class="cl">        <span class="n">deps</span> <span class="o">=</span> <span class="p">{}</span>
</span></span><span class="line"><span class="cl">        <span class="n">unit_deps</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_dependencies_unit</span><span class="p">(</span><span class="n">unit</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="k">for</span> <span class="n">dep_unit</span><span class="p">,</span> <span class="n">dep_style</span> <span class="ow">in</span> <span class="n">unit_deps</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
</span></span><span class="line"><span class="cl">            <span class="k">if</span> <span class="n">dep_style</span> <span class="ow">in</span> <span class="n">styles</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">                <span class="k">if</span> <span class="n">dep_unit</span> <span class="ow">in</span> <span class="n">deps</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">                    <span class="k">if</span> <span class="n">dep_style</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">deps</span><span class="p">[</span><span class="n">dep_unit</span><span class="p">]:</span>
</span></span><span class="line"><span class="cl">                        <span class="n">deps</span><span class="p">[</span><span class="n">dep_unit</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">dep_style</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">                <span class="k">else</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">                    <span class="n">deps</span><span class="p">[</span><span class="n">dep_unit</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="n">dep_style</span><span class="p">]</span>
</span></span><span class="line"><span class="cl">                <span class="n">next_deps</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_start_dependencies</span><span class="p">(</span><span class="n">dep_unit</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">                <span class="k">for</span> <span class="n">dep</span><span class="p">,</span> <span class="n">styles</span> <span class="ow">in</span> <span class="n">next_deps</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
</span></span><span class="line"><span class="cl">                    <span class="k">for</span> <span class="n">style</span> <span class="ow">in</span> <span class="n">styles</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">                        <span class="k">if</span> <span class="n">dep</span> <span class="ow">in</span> <span class="n">deps</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">                            <span class="k">if</span> <span class="n">style</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">deps</span><span class="p">[</span><span class="n">dep</span><span class="p">]:</span>
</span></span><span class="line"><span class="cl">                                <span class="n">deps</span><span class="p">[</span><span class="n">dep</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">style</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">                        <span class="k">else</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">                            <span class="n">deps</span><span class="p">[</span><span class="n">dep</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="n">style</span><span class="p">]</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="n">deps</span>
</span></span><span class="line"><span class="cl">    <span class="k">def</span> <span class="nf">list_start_dependencies_modules</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">modules</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">        <span class="s2">&#34;&#34;&#34; [UNIT]... show the dependency tree (experimental)&#34;
</span></span></span><span class="line"><span class="cl"><span class="s2">        &#34;&#34;&#34;</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">list_start_dependencies_units</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="n">modules</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">    <span class="k">def</span> <span class="nf">list_start_dependencies_units</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">units</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">        <span class="n">unit_order</span> <span class="o">=</span> <span class="p">[]</span>
</span></span><span class="line"><span class="cl">        <span class="n">deps</span> <span class="o">=</span> <span class="p">{}</span>
</span></span><span class="line"><span class="cl">        <span class="k">for</span> <span class="n">unit</span> <span class="ow">in</span> <span class="n">units</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">            <span class="n">unit_order</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">unit</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">            <span class="c1"># unit_deps = self.get_start_dependencies(unit) # TODO</span>
</span></span><span class="line"><span class="cl">            <span class="n">unit_deps</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_dependencies_unit</span><span class="p">(</span><span class="n">unit</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">            <span class="k">for</span> <span class="n">dep_unit</span><span class="p">,</span> <span class="n">styles</span> <span class="ow">in</span> <span class="n">unit_deps</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
</span></span><span class="line"><span class="cl">                <span class="n">dep_styles</span> <span class="o">=</span> <span class="n">to_list</span><span class="p">(</span><span class="n">styles</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">                <span class="k">for</span> <span class="n">dep_style</span> <span class="ow">in</span> <span class="n">dep_styles</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">                    <span class="k">if</span> <span class="n">dep_unit</span> <span class="ow">in</span> <span class="n">deps</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">                        <span class="k">if</span> <span class="n">dep_style</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">deps</span><span class="p">[</span><span class="n">dep_unit</span><span class="p">]:</span>
</span></span><span class="line"><span class="cl">                            <span class="n">deps</span><span class="p">[</span><span class="n">dep_unit</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">dep_style</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">                    <span class="k">else</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">                        <span class="n">deps</span><span class="p">[</span><span class="n">dep_unit</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="n">dep_style</span><span class="p">]</span>
</span></span><span class="line"><span class="cl">        <span class="n">deps_conf</span> <span class="o">=</span> <span class="p">[]</span>
</span></span><span class="line"><span class="cl">        <span class="k">for</span> <span class="n">dep</span> <span class="ow">in</span> <span class="n">deps</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">            <span class="k">if</span> <span class="n">dep</span> <span class="ow">in</span> <span class="n">unit_order</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">                <span class="k">continue</span>
</span></span><span class="line"><span class="cl">            <span class="n">conf</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_unit_conf</span><span class="p">(</span><span class="n">dep</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">            <span class="k">if</span> <span class="n">conf</span><span class="o">.</span><span class="n">loaded</span><span class="p">():</span>
</span></span><span class="line"><span class="cl">                <span class="n">deps_conf</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">conf</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="k">for</span> <span class="n">unit</span> <span class="ow">in</span> <span class="n">unit_order</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">            <span class="n">deps</span><span class="p">[</span><span class="n">unit</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&#34;Requested&#34;</span><span class="p">]</span>
</span></span><span class="line"><span class="cl">            <span class="n">conf</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_unit_conf</span><span class="p">(</span><span class="n">unit</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">            <span class="k">if</span> <span class="n">conf</span><span class="o">.</span><span class="n">loaded</span><span class="p">():</span>
</span></span><span class="line"><span class="cl">                <span class="n">deps_conf</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">conf</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="n">result</span> <span class="o">=</span> <span class="p">[]</span>
</span></span><span class="line"><span class="cl">        <span class="n">sortlist</span> <span class="o">=</span> <span class="n">conf_sortedAfter</span><span class="p">(</span><span class="n">deps_conf</span><span class="p">,</span> <span class="n">cmp</span><span class="o">=</span><span class="n">compareAfter</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">sortlist</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">            <span class="n">line</span> <span class="o">=</span> <span class="p">(</span><span class="n">item</span><span class="o">.</span><span class="n">name</span><span class="p">(),</span> <span class="s2">&#34;(</span><span class="si">%s</span><span class="s2">)&#34;</span> <span class="o">%</span> <span class="p">(</span><span class="s2">&#34; &#34;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">deps</span><span class="p">[</span><span class="n">item</span><span class="o">.</span><span class="n">name</span><span class="p">()])))</span>
</span></span><span class="line"><span class="cl">            <span class="n">result</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">line</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="n">result</span>
</span></span><span class="line"><span class="cl">    <span class="k">def</span> <span class="nf">sortedAfter</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">unitlist</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">        <span class="s2">&#34;&#34;&#34; get correct start order for the unit list (ignoring masked units) &#34;&#34;&#34;</span>
</span></span><span class="line"><span class="cl">        <span class="n">conflist</span> <span class="o">=</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">get_unit_conf</span><span class="p">(</span><span class="n">unit</span><span class="p">)</span> <span class="k">for</span> <span class="n">unit</span> <span class="ow">in</span> <span class="n">unitlist</span><span class="p">]</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="kc">True</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">            <span class="n">conflist</span> <span class="o">=</span> <span class="p">[]</span>
</span></span><span class="line"><span class="cl">            <span class="k">for</span> <span class="n">unit</span> <span class="ow">in</span> <span class="n">unitlist</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">                <span class="n">conf</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_unit_conf</span><span class="p">(</span><span class="n">unit</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">                <span class="k">if</span> <span class="n">conf</span><span class="o">.</span><span class="n">masked</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">                    <span class="n">logg</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&#34;ignoring masked unit </span><span class="si">%s</span><span class="s2">&#34;</span><span class="p">,</span> <span class="n">unit</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">                    <span class="k">continue</span>
</span></span><span class="line"><span class="cl">                <span class="n">conflist</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">conf</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="n">sortlist</span> <span class="o">=</span> <span class="n">conf_sortedAfter</span><span class="p">(</span><span class="n">conflist</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="p">[</span><span class="n">item</span><span class="o">.</span><span class="n">name</span><span class="p">()</span> <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">sortlist</span><span class="p">]</span>
</span></span><span class="line"><span class="cl">    <span class="k">def</span> <span class="nf">sortedBefore</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">unitlist</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">        <span class="s2">&#34;&#34;&#34; get correct start order for the unit list (ignoring masked units) &#34;&#34;&#34;</span>
</span></span><span class="line"><span class="cl">        <span class="n">conflist</span> <span class="o">=</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">get_unit_conf</span><span class="p">(</span><span class="n">unit</span><span class="p">)</span> <span class="k">for</span> <span class="n">unit</span> <span class="ow">in</span> <span class="n">unitlist</span><span class="p">]</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="kc">True</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">            <span class="n">conflist</span> <span class="o">=</span> <span class="p">[]</span>
</span></span><span class="line"><span class="cl">            <span class="k">for</span> <span class="n">unit</span> <span class="ow">in</span> <span class="n">unitlist</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">                <span class="n">conf</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_unit_conf</span><span class="p">(</span><span class="n">unit</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">                <span class="k">if</span> <span class="n">conf</span><span class="o">.</span><span class="n">masked</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">                    <span class="n">logg</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&#34;ignoring masked unit </span><span class="si">%s</span><span class="s2">&#34;</span><span class="p">,</span> <span class="n">unit</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">                    <span class="k">continue</span>
</span></span><span class="line"><span class="cl">                <span class="n">conflist</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">conf</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="n">sortlist</span> <span class="o">=</span> <span class="n">conf_sortedAfter</span><span class="p">(</span><span class="nb">reversed</span><span class="p">(</span><span class="n">conflist</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="p">[</span><span class="n">item</span><span class="o">.</span><span class="n">name</span><span class="p">()</span> <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="nb">reversed</span><span class="p">(</span><span class="n">sortlist</span><span class="p">)]</span>
</span></span><span class="line"><span class="cl">    <span class="k">def</span> <span class="nf">daemon_reload_target</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">        <span class="s2">&#34;&#34;&#34; reload does will only check the service files here.
</span></span></span><span class="line"><span class="cl"><span class="s2">            The returncode will tell the number of warnings,
</span></span></span><span class="line"><span class="cl"><span class="s2">            and it is over 100 if it can not continue even
</span></span></span><span class="line"><span class="cl"><span class="s2">            for the relaxed systemctl.py style of execution. &#34;&#34;&#34;</span>
</span></span><span class="line"><span class="cl">        <span class="n">errors</span> <span class="o">=</span> <span class="mi">0</span>
</span></span><span class="line"><span class="cl">        <span class="k">for</span> <span class="n">unit</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">match_units</span><span class="p">():</span>
</span></span><span class="line"><span class="cl">            <span class="k">try</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">                <span class="n">conf</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_unit_conf</span><span class="p">(</span><span class="n">unit</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">            <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">                <span class="n">logg</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&#34;</span><span class="si">%s</span><span class="s2">: can not read unit file </span><span class="si">%s</span><span class="se">\n\t</span><span class="si">%s</span><span class="s2">&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                           <span class="n">unit</span><span class="p">,</span> <span class="n">strQ</span><span class="p">(</span><span class="n">conf</span><span class="o">.</span><span class="n">filename</span><span class="p">()),</span> <span class="n">e</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">                <span class="k">continue</span>
</span></span><span class="line"><span class="cl">            <span class="n">errors</span> <span class="o">+=</span> <span class="bp">self</span><span class="o">.</span><span class="n">syntax_check</span><span class="p">(</span><span class="n">conf</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="n">errors</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">            <span class="n">logg</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&#34; (</span><span class="si">%s</span><span class="s2">) found </span><span class="si">%s</span><span class="s2"> problems&#34;</span><span class="p">,</span> <span class="n">errors</span><span class="p">,</span> <span class="n">errors</span> <span class="o">%</span> <span class="mi">100</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="kc">True</span> <span class="c1"># errors</span>
</span></span><span class="line"><span class="cl">    <span class="k">def</span> <span class="nf">syntax_check</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">conf</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">        <span class="n">filename</span> <span class="o">=</span> <span class="n">conf</span><span class="o">.</span><span class="n">filename</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="n">filename</span> <span class="ow">and</span> <span class="n">filename</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s2">&#34;.service&#34;</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">syntax_check_service</span><span class="p">(</span><span class="n">conf</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="mi">0</span>
</span></span><span class="line"><span class="cl">    <span class="k">def</span> <span class="nf">syntax_check_service</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">conf</span><span class="p">,</span> <span class="n">section</span> <span class="o">=</span> <span class="n">Service</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">        <span class="n">unit</span> <span class="o">=</span> <span class="n">conf</span><span class="o">.</span><span class="n">name</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="ow">not</span> <span class="n">conf</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">has_section</span><span class="p">(</span><span class="n">Service</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">            <span class="n">logg</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&#34; </span><span class="si">%s</span><span class="s2">: a .service file without [Service] section&#34;</span><span class="p">,</span> <span class="n">unit</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">            <span class="k">return</span> <span class="mi">101</span>
</span></span><span class="line"><span class="cl">        <span class="n">errors</span> <span class="o">=</span> <span class="mi">0</span>
</span></span><span class="line"><span class="cl">        <span class="n">haveType</span> <span class="o">=</span> <span class="n">conf</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">section</span><span class="p">,</span> <span class="s2">&#34;Type&#34;</span><span class="p">,</span> <span class="s2">&#34;simple&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="n">haveExecStart</span> <span class="o">=</span> <span class="n">conf</span><span class="o">.</span><span class="n">getlist</span><span class="p">(</span><span class="n">section</span><span class="p">,</span> <span class="s2">&#34;ExecStart&#34;</span><span class="p">,</span> <span class="p">[])</span>
</span></span><span class="line"><span class="cl">        <span class="n">haveExecStop</span> <span class="o">=</span> <span class="n">conf</span><span class="o">.</span><span class="n">getlist</span><span class="p">(</span><span class="n">section</span><span class="p">,</span> <span class="s2">&#34;ExecStop&#34;</span><span class="p">,</span> <span class="p">[])</span>
</span></span><span class="line"><span class="cl">        <span class="n">haveExecReload</span> <span class="o">=</span> <span class="n">conf</span><span class="o">.</span><span class="n">getlist</span><span class="p">(</span><span class="n">section</span><span class="p">,</span> <span class="s2">&#34;ExecReload&#34;</span><span class="p">,</span> <span class="p">[])</span>
</span></span><span class="line"><span class="cl">        <span class="n">usedExecStart</span> <span class="o">=</span> <span class="p">[]</span>
</span></span><span class="line"><span class="cl">        <span class="n">usedExecStop</span> <span class="o">=</span> <span class="p">[]</span>
</span></span><span class="line"><span class="cl">        <span class="n">usedExecReload</span> <span class="o">=</span> <span class="p">[]</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="n">haveType</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&#34;simple&#34;</span><span class="p">,</span> <span class="s2">&#34;exec&#34;</span><span class="p">,</span> <span class="s2">&#34;forking&#34;</span><span class="p">,</span> <span class="s2">&#34;notify&#34;</span><span class="p">,</span> <span class="s2">&#34;oneshot&#34;</span><span class="p">,</span> <span class="s2">&#34;dbus&#34;</span><span class="p">,</span> <span class="s2">&#34;idle&#34;</span><span class="p">]:</span>
</span></span><span class="line"><span class="cl">            <span class="n">logg</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&#34; </span><span class="si">%s</span><span class="s2">: Failed to parse service type, ignoring: </span><span class="si">%s</span><span class="s2">&#34;</span><span class="p">,</span> <span class="n">unit</span><span class="p">,</span> <span class="n">haveType</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">            <span class="n">errors</span> <span class="o">+=</span> <span class="mi">100</span>
</span></span><span class="line"><span class="cl">        <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">haveExecStart</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">            <span class="n">mode</span><span class="p">,</span> <span class="n">exe</span> <span class="o">=</span> <span class="n">exec_path</span><span class="p">(</span><span class="n">line</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">            <span class="k">if</span> <span class="ow">not</span> <span class="n">exe</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s2">&#34;/&#34;</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">                <span class="k">if</span> <span class="n">mode</span><span class="o">.</span><span class="n">check</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">                    <span class="n">logg</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&#34;  </span><span class="si">%s</span><span class="s2">: </span><span class="si">%s</span><span class="s2"> Executable path is not absolute.&#34;</span><span class="p">,</span> <span class="n">unit</span><span class="p">,</span> <span class="n">section</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">                <span class="k">else</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">                    <span class="n">logg</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&#34;</span><span class="si">%s</span><span class="s2">: </span><span class="si">%s</span><span class="s2"> Executable path is not absolute.&#34;</span><span class="p">,</span> <span class="n">unit</span><span class="p">,</span> <span class="n">section</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">                <span class="n">logg</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&#34;</span><span class="si">%s</span><span class="s2">: </span><span class="si">%s</span><span class="s2"> exe = </span><span class="si">%s</span><span class="s2">&#34;</span><span class="p">,</span> <span class="n">unit</span><span class="p">,</span> <span class="n">section</span><span class="p">,</span> <span class="n">exe</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">                <span class="n">errors</span> <span class="o">+=</span> <span class="mi">1</span>
</span></span><span class="line"><span class="cl">            <span class="n">usedExecStart</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">line</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">haveExecStop</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">            <span class="n">mode</span><span class="p">,</span> <span class="n">exe</span> <span class="o">=</span> <span class="n">exec_path</span><span class="p">(</span><span class="n">line</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">            <span class="k">if</span> <span class="ow">not</span> <span class="n">exe</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s2">&#34;/&#34;</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">                <span class="k">if</span> <span class="n">mode</span><span class="o">.</span><span class="n">check</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">                    <span class="n">logg</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&#34;  </span><span class="si">%s</span><span class="s2">: </span><span class="si">%s</span><span class="s2"> Executable path is not absolute.&#34;</span><span class="p">,</span> <span class="n">unit</span><span class="p">,</span> <span class="n">section</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">                <span class="k">else</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">                    <span class="n">logg</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&#34;</span><span class="si">%s</span><span class="s2">: </span><span class="si">%s</span><span class="s2"> Executable path is not absolute.&#34;</span><span class="p">,</span> <span class="n">unit</span><span class="p">,</span> <span class="n">section</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">                <span class="n">logg</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&#34;</span><span class="si">%s</span><span class="s2">: </span><span class="si">%s</span><span class="s2"> exe = </span><span class="si">%s</span><span class="s2">&#34;</span><span class="p">,</span> <span class="n">unit</span><span class="p">,</span> <span class="n">section</span><span class="p">,</span> <span class="n">exe</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">                <span class="n">errors</span> <span class="o">+=</span> <span class="mi">1</span>
</span></span><span class="line"><span class="cl">            <span class="n">usedExecStop</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">line</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">haveExecReload</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">            <span class="n">mode</span><span class="p">,</span> <span class="n">exe</span> <span class="o">=</span> <span class="n">exec_path</span><span class="p">(</span><span class="n">line</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">            <span class="k">if</span> <span class="ow">not</span> <span class="n">exe</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s2">&#34;/&#34;</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">                <span class="k">if</span> <span class="n">mode</span><span class="o">.</span><span class="n">check</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">                    <span class="n">logg</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&#34;  </span><span class="si">%s</span><span class="s2">: </span><span class="si">%s</span><span class="s2"> Executable path is not absolute.&#34;</span><span class="p">,</span> <span class="n">unit</span><span class="p">,</span> <span class="n">section</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">                <span class="k">else</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">                    <span class="n">logg</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&#34;</span><span class="si">%s</span><span class="s2">: </span><span class="si">%s</span><span class="s2"> Executable path is not absolute.&#34;</span><span class="p">,</span> <span class="n">unit</span><span class="p">,</span> <span class="n">section</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">                <span class="n">logg</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&#34;</span><span class="si">%s</span><span class="s2">: </span><span class="si">%s</span><span class="s2"> exe = </span><span class="si">%s</span><span class="s2">&#34;</span><span class="p">,</span> <span class="n">unit</span><span class="p">,</span> <span class="n">section</span><span class="p">,</span> <span class="n">exe</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">                <span class="n">errors</span> <span class="o">+=</span> <span class="mi">1</span>
</span></span><span class="line"><span class="cl">            <span class="n">usedExecReload</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">line</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="n">haveType</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&#34;simple&#34;</span><span class="p">,</span> <span class="s2">&#34;exec&#34;</span><span class="p">,</span> <span class="s2">&#34;notify&#34;</span><span class="p">,</span> <span class="s2">&#34;forking&#34;</span><span class="p">,</span> <span class="s2">&#34;idle&#34;</span><span class="p">]:</span>
</span></span><span class="line"><span class="cl">            <span class="k">if</span> <span class="ow">not</span> <span class="n">usedExecStart</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">usedExecStop</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">                <span class="n">logg</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&#34; </span><span class="si">%s</span><span class="s2">: </span><span class="si">%s</span><span class="s2"> lacks both ExecStart and ExecStop= setting. Refusing.&#34;</span><span class="p">,</span> <span class="n">unit</span><span class="p">,</span> <span class="n">section</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">                <span class="n">errors</span> <span class="o">+=</span> <span class="mi">101</span>
</span></span><span class="line"><span class="cl">            <span class="k">elif</span> <span class="ow">not</span> <span class="n">usedExecStart</span> <span class="ow">and</span> <span class="n">haveType</span> <span class="o">!=</span> <span class="s2">&#34;oneshot&#34;</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">                <span class="n">logg</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&#34; </span><span class="si">%s</span><span class="s2">: </span><span class="si">%s</span><span class="s2"> has no ExecStart= setting, which is only allowed for Type=oneshot services. Refusing.&#34;</span><span class="p">,</span> <span class="n">unit</span><span class="p">,</span> <span class="n">section</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">                <span class="n">errors</span> <span class="o">+=</span> <span class="mi">101</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">usedExecStart</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span> <span class="ow">and</span> <span class="n">haveType</span> <span class="o">!=</span> <span class="s2">&#34;oneshot&#34;</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">            <span class="n">logg</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&#34; </span><span class="si">%s</span><span class="s2">: there may be only one </span><span class="si">%s</span><span class="s2"> ExecStart statement (unless for &#39;oneshot&#39; services).&#34;</span> <span class="o">+</span>
</span></span><span class="line"><span class="cl">                       <span class="s2">&#34;</span><span class="se">\n\t\t\t</span><span class="s2">You can use ExecStartPre / ExecStartPost to add additional commands.&#34;</span><span class="p">,</span> <span class="n">unit</span><span class="p">,</span> <span class="n">section</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">            <span class="n">errors</span> <span class="o">+=</span> <span class="mi">1</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">usedExecStop</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span> <span class="ow">and</span> <span class="n">haveType</span> <span class="o">!=</span> <span class="s2">&#34;oneshot&#34;</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">            <span class="n">logg</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&#34; </span><span class="si">%s</span><span class="s2">: there should be only one </span><span class="si">%s</span><span class="s2"> ExecStop statement (unless for &#39;oneshot&#39; services).&#34;</span> <span class="o">+</span>
</span></span><span class="line"><span class="cl">                      <span class="s2">&#34;</span><span class="se">\n\t\t\t</span><span class="s2">You can use ExecStopPost to add additional commands (also executed on failed Start)&#34;</span><span class="p">,</span> <span class="n">unit</span><span class="p">,</span> <span class="n">section</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">usedExecReload</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">            <span class="n">logg</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&#34; </span><span class="si">%s</span><span class="s2">: there should be only one </span><span class="si">%s</span><span class="s2"> ExecReload statement.&#34;</span> <span class="o">+</span>
</span></span><span class="line"><span class="cl">                      <span class="s2">&#34;</span><span class="se">\n\t\t\t</span><span class="s2">Use &#39; ; &#39; for multiple commands (ExecReloadPost or ExedReloadPre do not exist)&#34;</span><span class="p">,</span> <span class="n">unit</span><span class="p">,</span> <span class="n">section</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">usedExecReload</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="ow">and</span> <span class="s2">&#34;/bin/kill &#34;</span> <span class="ow">in</span> <span class="n">usedExecReload</span><span class="p">[</span><span class="mi">0</span><span class="p">]:</span>
</span></span><span class="line"><span class="cl">            <span class="n">logg</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&#34; </span><span class="si">%s</span><span class="s2">: the use of /bin/kill is not recommended for </span><span class="si">%s</span><span class="s2"> ExecReload as it is asynchronous.&#34;</span> <span class="o">+</span>
</span></span><span class="line"><span class="cl">                         <span class="s2">&#34;</span><span class="se">\n\t\t\t</span><span class="s2">That means all the dependencies will perform the reload simultaneously / out of order.&#34;</span><span class="p">,</span> <span class="n">unit</span><span class="p">,</span> <span class="n">section</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="n">conf</span><span class="o">.</span><span class="n">getlist</span><span class="p">(</span><span class="n">Service</span><span class="p">,</span> <span class="s2">&#34;ExecRestart&#34;</span><span class="p">,</span> <span class="p">[]):</span>  <span class="c1"># pragma: no cover</span>
</span></span><span class="line"><span class="cl">            <span class="n">logg</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&#34; </span><span class="si">%s</span><span class="s2">: there no such thing as an </span><span class="si">%s</span><span class="s2"> ExecRestart (ignored)&#34;</span><span class="p">,</span> <span class="n">unit</span><span class="p">,</span> <span class="n">section</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="n">conf</span><span class="o">.</span><span class="n">getlist</span><span class="p">(</span><span class="n">Service</span><span class="p">,</span> <span class="s2">&#34;ExecRestartPre&#34;</span><span class="p">,</span> <span class="p">[]):</span>  <span class="c1"># pragma: no cover</span>
</span></span><span class="line"><span class="cl">            <span class="n">logg</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&#34; </span><span class="si">%s</span><span class="s2">: there no such thing as an </span><span class="si">%s</span><span class="s2"> ExecRestartPre (ignored)&#34;</span><span class="p">,</span> <span class="n">unit</span><span class="p">,</span> <span class="n">section</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="n">conf</span><span class="o">.</span><span class="n">getlist</span><span class="p">(</span><span class="n">Service</span><span class="p">,</span> <span class="s2">&#34;ExecRestartPost&#34;</span><span class="p">,</span> <span class="p">[]):</span>  <span class="c1"># pragma: no cover</span>
</span></span><span class="line"><span class="cl">            <span class="n">logg</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&#34; </span><span class="si">%s</span><span class="s2">: there no such thing as an </span><span class="si">%s</span><span class="s2"> ExecRestartPost (ignored)&#34;</span><span class="p">,</span> <span class="n">unit</span><span class="p">,</span> <span class="n">section</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="n">conf</span><span class="o">.</span><span class="n">getlist</span><span class="p">(</span><span class="n">Service</span><span class="p">,</span> <span class="s2">&#34;ExecReloadPre&#34;</span><span class="p">,</span> <span class="p">[]):</span>  <span class="c1"># pragma: no cover</span>
</span></span><span class="line"><span class="cl">            <span class="n">logg</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&#34; </span><span class="si">%s</span><span class="s2">: there no such thing as an </span><span class="si">%s</span><span class="s2"> ExecReloadPre (ignored)&#34;</span><span class="p">,</span> <span class="n">unit</span><span class="p">,</span> <span class="n">section</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="n">conf</span><span class="o">.</span><span class="n">getlist</span><span class="p">(</span><span class="n">Service</span><span class="p">,</span> <span class="s2">&#34;ExecReloadPost&#34;</span><span class="p">,</span> <span class="p">[]):</span>  <span class="c1"># pragma: no cover</span>
</span></span><span class="line"><span class="cl">            <span class="n">logg</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&#34; </span><span class="si">%s</span><span class="s2">: there no such thing as an </span><span class="si">%s</span><span class="s2"> ExecReloadPost (ignored)&#34;</span><span class="p">,</span> <span class="n">unit</span><span class="p">,</span> <span class="n">section</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="n">conf</span><span class="o">.</span><span class="n">getlist</span><span class="p">(</span><span class="n">Service</span><span class="p">,</span> <span class="s2">&#34;ExecStopPre&#34;</span><span class="p">,</span> <span class="p">[]):</span>  <span class="c1"># pragma: no cover</span>
</span></span><span class="line"><span class="cl">            <span class="n">logg</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&#34; </span><span class="si">%s</span><span class="s2">: there no such thing as an </span><span class="si">%s</span><span class="s2"> ExecStopPre (ignored)&#34;</span><span class="p">,</span> <span class="n">unit</span><span class="p">,</span> <span class="n">section</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="k">for</span> <span class="n">env_file</span> <span class="ow">in</span> <span class="n">conf</span><span class="o">.</span><span class="n">getlist</span><span class="p">(</span><span class="n">Service</span><span class="p">,</span> <span class="s2">&#34;EnvironmentFile&#34;</span><span class="p">,</span> <span class="p">[]):</span>
</span></span><span class="line"><span class="cl">            <span class="k">if</span> <span class="n">env_file</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s2">&#34;-&#34;</span><span class="p">):</span> <span class="k">continue</span>
</span></span><span class="line"><span class="cl">            <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isfile</span><span class="p">(</span><span class="n">os_path</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_root</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">expand_special</span><span class="p">(</span><span class="n">env_file</span><span class="p">,</span> <span class="n">conf</span><span class="p">))):</span>
</span></span><span class="line"><span class="cl">                <span class="n">logg</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&#34; </span><span class="si">%s</span><span class="s2">: Failed to load environment files: </span><span class="si">%s</span><span class="s2">&#34;</span><span class="p">,</span> <span class="n">unit</span><span class="p">,</span> <span class="n">env_file</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">                <span class="n">errors</span> <span class="o">+=</span> <span class="mi">101</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="n">errors</span>
</span></span><span class="line"><span class="cl">    <span class="k">def</span> <span class="nf">exec_check_unit</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">conf</span><span class="p">,</span> <span class="n">env</span><span class="p">,</span> <span class="n">section</span> <span class="o">=</span> <span class="n">Service</span><span class="p">,</span> <span class="n">exectype</span> <span class="o">=</span> <span class="s2">&#34;&#34;</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="n">conf</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span> <span class="c1"># pragma: no cover (is never null)</span>
</span></span><span class="line"><span class="cl">            <span class="k">return</span> <span class="kc">True</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="ow">not</span> <span class="n">conf</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">has_section</span><span class="p">(</span><span class="n">section</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">            <span class="k">return</span> <span class="kc">True</span>  <span class="c1"># pragma: no cover</span>
</span></span><span class="line"><span class="cl">        <span class="n">haveType</span> <span class="o">=</span> <span class="n">conf</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">section</span><span class="p">,</span> <span class="s2">&#34;Type&#34;</span><span class="p">,</span> <span class="s2">&#34;simple&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">is_sysv_file</span><span class="p">(</span><span class="n">conf</span><span class="o">.</span><span class="n">filename</span><span class="p">()):</span>
</span></span><span class="line"><span class="cl">            <span class="k">return</span> <span class="kc">True</span> <span class="c1"># we don&#39;t care about that</span>
</span></span><span class="line"><span class="cl">        <span class="n">unit</span> <span class="o">=</span> <span class="n">conf</span><span class="o">.</span><span class="n">name</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">        <span class="n">abspath</span> <span class="o">=</span> <span class="mi">0</span>
</span></span><span class="line"><span class="cl">        <span class="n">notexists</span> <span class="o">=</span> <span class="mi">0</span>
</span></span><span class="line"><span class="cl">        <span class="n">badusers</span> <span class="o">=</span> <span class="mi">0</span>
</span></span><span class="line"><span class="cl">        <span class="n">badgroups</span> <span class="o">=</span> <span class="mi">0</span>
</span></span><span class="line"><span class="cl">        <span class="k">for</span> <span class="n">execs</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&#34;ExecStartPre&#34;</span><span class="p">,</span> <span class="s2">&#34;ExecStart&#34;</span><span class="p">,</span> <span class="s2">&#34;ExecStartPost&#34;</span><span class="p">,</span> <span class="s2">&#34;ExecStop&#34;</span><span class="p">,</span> <span class="s2">&#34;ExecStopPost&#34;</span><span class="p">,</span> <span class="s2">&#34;ExecReload&#34;</span><span class="p">]:</span>
</span></span><span class="line"><span class="cl">            <span class="k">if</span> <span class="ow">not</span> <span class="n">execs</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="n">exectype</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">                <span class="k">continue</span>
</span></span><span class="line"><span class="cl">            <span class="k">for</span> <span class="n">cmd</span> <span class="ow">in</span> <span class="n">conf</span><span class="o">.</span><span class="n">getlist</span><span class="p">(</span><span class="n">section</span><span class="p">,</span> <span class="n">execs</span><span class="p">,</span> <span class="p">[]):</span>
</span></span><span class="line"><span class="cl">                <span class="n">mode</span><span class="p">,</span> <span class="n">newcmd</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">exec_newcmd</span><span class="p">(</span><span class="n">cmd</span><span class="p">,</span> <span class="n">env</span><span class="p">,</span> <span class="n">conf</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">                <span class="k">if</span> <span class="ow">not</span> <span class="n">newcmd</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">                    <span class="k">continue</span>
</span></span><span class="line"><span class="cl">                <span class="n">exe</span> <span class="o">=</span> <span class="n">newcmd</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
</span></span><span class="line"><span class="cl">                <span class="k">if</span> <span class="ow">not</span> <span class="n">exe</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">                    <span class="k">continue</span>
</span></span><span class="line"><span class="cl">                <span class="k">if</span> <span class="n">exe</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">!=</span> <span class="s2">&#34;/&#34;</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">                    <span class="n">logg</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&#34; </span><span class="si">%s</span><span class="s2">: Exec is not an absolute path:  </span><span class="si">%s</span><span class="s2">=</span><span class="si">%s</span><span class="s2">&#34;</span><span class="p">,</span> <span class="n">unit</span><span class="p">,</span> <span class="n">execs</span><span class="p">,</span> <span class="n">cmd</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">                    <span class="n">abspath</span> <span class="o">+=</span> <span class="mi">1</span>
</span></span><span class="line"><span class="cl">                <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isfile</span><span class="p">(</span><span class="n">exe</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">                    <span class="n">logg</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&#34; </span><span class="si">%s</span><span class="s2">: Exec command does not exist: (</span><span class="si">%s</span><span class="s2">) </span><span class="si">%s</span><span class="s2">&#34;</span><span class="p">,</span> <span class="n">unit</span><span class="p">,</span> <span class="n">execs</span><span class="p">,</span> <span class="n">exe</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">                    <span class="k">if</span> <span class="n">mode</span><span class="o">.</span><span class="n">check</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">                        <span class="n">notexists</span> <span class="o">+=</span> <span class="mi">1</span>
</span></span><span class="line"><span class="cl">                    <span class="n">newexe1</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="s2">&#34;/usr/bin&#34;</span><span class="p">,</span> <span class="n">exe</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">                    <span class="n">newexe2</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="s2">&#34;/bin&#34;</span><span class="p">,</span> <span class="n">exe</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">                    <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">newexe1</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">                        <span class="n">logg</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&#34; </span><span class="si">%s</span><span class="s2">: but this does exist: </span><span class="si">%s</span><span class="s2">  </span><span class="si">%s</span><span class="s2">&#34;</span><span class="p">,</span> <span class="n">unit</span><span class="p">,</span> <span class="s2">&#34; &#34;</span> <span class="o">*</span> <span class="nb">len</span><span class="p">(</span><span class="n">execs</span><span class="p">),</span> <span class="n">newexe1</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">                    <span class="k">elif</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">newexe2</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">                        <span class="n">logg</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&#34; </span><span class="si">%s</span><span class="s2">: but this does exist: </span><span class="si">%s</span><span class="s2">      </span><span class="si">%s</span><span class="s2">&#34;</span><span class="p">,</span> <span class="n">unit</span><span class="p">,</span> <span class="s2">&#34; &#34;</span> <span class="o">*</span> <span class="nb">len</span><span class="p">(</span><span class="n">execs</span><span class="p">),</span> <span class="n">newexe2</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="n">users</span> <span class="o">=</span> <span class="p">[</span><span class="n">conf</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">section</span><span class="p">,</span> <span class="s2">&#34;User&#34;</span><span class="p">,</span> <span class="s2">&#34;&#34;</span><span class="p">),</span> <span class="n">conf</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">section</span><span class="p">,</span> <span class="s2">&#34;SocketUser&#34;</span><span class="p">,</span> <span class="s2">&#34;&#34;</span><span class="p">)]</span>
</span></span><span class="line"><span class="cl">        <span class="n">groups</span> <span class="o">=</span> <span class="p">[</span><span class="n">conf</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">section</span><span class="p">,</span> <span class="s2">&#34;Group&#34;</span><span class="p">,</span> <span class="s2">&#34;&#34;</span><span class="p">),</span> <span class="n">conf</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">section</span><span class="p">,</span> <span class="s2">&#34;SocketGroup&#34;</span><span class="p">,</span> <span class="s2">&#34;&#34;</span><span class="p">)]</span> <span class="o">+</span> <span class="n">conf</span><span class="o">.</span><span class="n">getlist</span><span class="p">(</span><span class="n">section</span><span class="p">,</span> <span class="s2">&#34;SupplementaryGroups&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="k">for</span> <span class="n">user</span> <span class="ow">in</span> <span class="n">users</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">            <span class="k">if</span> <span class="n">user</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">                <span class="k">try</span><span class="p">:</span> <span class="n">pwd</span><span class="o">.</span><span class="n">getpwnam</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">expand_special</span><span class="p">(</span><span class="n">user</span><span class="p">,</span> <span class="n">conf</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">                <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">                    <span class="n">logg</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&#34; </span><span class="si">%s</span><span class="s2">: User does not exist: </span><span class="si">%s</span><span class="s2"> (</span><span class="si">%s</span><span class="s2">)&#34;</span><span class="p">,</span> <span class="n">unit</span><span class="p">,</span> <span class="n">user</span><span class="p">,</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">e</span><span class="p">,</span> <span class="s2">&#34;__doc__&#34;</span><span class="p">,</span> <span class="s2">&#34;&#34;</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">                    <span class="n">badusers</span> <span class="o">+=</span> <span class="mi">1</span>
</span></span><span class="line"><span class="cl">        <span class="k">for</span> <span class="n">group</span> <span class="ow">in</span> <span class="n">groups</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">            <span class="k">if</span> <span class="n">group</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">                <span class="k">try</span><span class="p">:</span> <span class="n">grp</span><span class="o">.</span><span class="n">getgrnam</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">expand_special</span><span class="p">(</span><span class="n">group</span><span class="p">,</span> <span class="n">conf</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">                <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">                    <span class="n">logg</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&#34; </span><span class="si">%s</span><span class="s2">: Group does not exist: </span><span class="si">%s</span><span class="s2"> (</span><span class="si">%s</span><span class="s2">)&#34;</span><span class="p">,</span> <span class="n">unit</span><span class="p">,</span> <span class="n">group</span><span class="p">,</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">e</span><span class="p">,</span> <span class="s2">&#34;__doc__&#34;</span><span class="p">,</span> <span class="s2">&#34;&#34;</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">                    <span class="n">badgroups</span> <span class="o">+=</span> <span class="mi">1</span>
</span></span><span class="line"><span class="cl">        <span class="n">tmpproblems</span> <span class="o">=</span> <span class="mi">0</span>
</span></span><span class="line"><span class="cl">        <span class="k">for</span> <span class="n">setting</span> <span class="ow">in</span> <span class="p">(</span><span class="s2">&#34;RootDirectory&#34;</span><span class="p">,</span> <span class="s2">&#34;RootImage&#34;</span><span class="p">,</span> <span class="s2">&#34;BindPaths&#34;</span><span class="p">,</span> <span class="s2">&#34;BindReadOnlyPaths&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                        <span class="s2">&#34;ReadWritePaths&#34;</span><span class="p">,</span> <span class="s2">&#34;ReadOnlyPaths&#34;</span><span class="p">,</span> <span class="s2">&#34;TemporaryFileSystem&#34;</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">            <span class="n">setting_value</span> <span class="o">=</span> <span class="n">conf</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">section</span><span class="p">,</span> <span class="n">setting</span><span class="p">,</span> <span class="s2">&#34;&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">            <span class="k">if</span> <span class="n">setting_value</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">                <span class="n">logg</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&#34;</span><span class="si">%s</span><span class="s2">: </span><span class="si">%s</span><span class="s2"> private directory remounts ignored: </span><span class="si">%s</span><span class="s2">=</span><span class="si">%s</span><span class="s2">&#34;</span><span class="p">,</span> <span class="n">unit</span><span class="p">,</span> <span class="n">section</span><span class="p">,</span> <span class="n">setting</span><span class="p">,</span> <span class="n">setting_value</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">                <span class="n">tmpproblems</span> <span class="o">+=</span> <span class="mi">1</span>
</span></span><span class="line"><span class="cl">        <span class="k">for</span> <span class="n">setting</span> <span class="ow">in</span> <span class="p">(</span><span class="s2">&#34;PrivateTmp&#34;</span><span class="p">,</span> <span class="s2">&#34;PrivateDevices&#34;</span><span class="p">,</span> <span class="s2">&#34;PrivateNetwork&#34;</span><span class="p">,</span> <span class="s2">&#34;PrivateUsers&#34;</span><span class="p">,</span> <span class="s2">&#34;DynamicUser&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                        <span class="s2">&#34;ProtectSystem&#34;</span><span class="p">,</span> <span class="s2">&#34;ProjectHome&#34;</span><span class="p">,</span> <span class="s2">&#34;ProtectHostname&#34;</span><span class="p">,</span> <span class="s2">&#34;PrivateMounts&#34;</span><span class="p">,</span> <span class="s2">&#34;MountAPIVFS&#34;</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">            <span class="n">setting_yes</span> <span class="o">=</span> <span class="n">conf</span><span class="o">.</span><span class="n">getbool</span><span class="p">(</span><span class="n">section</span><span class="p">,</span> <span class="n">setting</span><span class="p">,</span> <span class="s2">&#34;no&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">            <span class="k">if</span> <span class="n">setting_yes</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">                <span class="n">logg</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&#34;</span><span class="si">%s</span><span class="s2">: </span><span class="si">%s</span><span class="s2"> private directory option is ignored: </span><span class="si">%s</span><span class="s2">=yes&#34;</span><span class="p">,</span> <span class="n">unit</span><span class="p">,</span> <span class="n">section</span><span class="p">,</span> <span class="n">setting</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">                <span class="n">tmpproblems</span> <span class="o">+=</span> <span class="mi">1</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="ow">not</span> <span class="n">abspath</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">notexists</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">badusers</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">badgroups</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">            <span class="k">return</span> <span class="kc">True</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="kc">True</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">            <span class="n">filename</span> <span class="o">=</span> <span class="n">strE</span><span class="p">(</span><span class="n">conf</span><span class="o">.</span><span class="n">filename</span><span class="p">())</span>
</span></span><span class="line"><span class="cl">            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">filename</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">44</span><span class="p">:</span> <span class="n">filename</span> <span class="o">=</span> <span class="n">o44</span><span class="p">(</span><span class="n">filename</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">            <span class="n">logg</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&#34; !!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">            <span class="k">if</span> <span class="n">abspath</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">                <span class="n">logg</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&#34; The SystemD ExecXY commands must always be absolute paths by definition.&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">                <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">            <span class="k">if</span> <span class="n">notexists</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">                <span class="n">logg</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&#34; Oops, </span><span class="si">%s</span><span class="s2"> executable paths were not found in the current environment. Refusing.&#34;</span><span class="p">,</span> <span class="n">notexists</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">                <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">            <span class="k">if</span> <span class="n">badusers</span> <span class="ow">or</span> <span class="n">badgroups</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">                <span class="n">logg</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&#34; Oops, </span><span class="si">%s</span><span class="s2"> user names and </span><span class="si">%s</span><span class="s2"> group names were not found. Refusing.&#34;</span><span class="p">,</span> <span class="n">badusers</span><span class="p">,</span> <span class="n">badgroups</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">                <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">            <span class="k">if</span> <span class="n">tmpproblems</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">                <span class="n">logg</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&#34;  Note, </span><span class="si">%s</span><span class="s2"> private directory settings are ignored. The application should not depend on it.&#34;</span><span class="p">,</span> <span class="n">tmpproblems</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">                <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">            <span class="n">logg</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&#34; !!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="kc">False</span>
</span></span><span class="line"><span class="cl">    <span class="k">def</span> <span class="nf">show_modules</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">modules</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">        <span class="s2">&#34;&#34;&#34; [PATTERN]... -- Show properties of one or more units
</span></span></span><span class="line"><span class="cl"><span class="s2">           Show properties of one or more units (or the manager itself).
</span></span></span><span class="line"><span class="cl"><span class="s2">           If no argument is specified, properties of the manager will be
</span></span></span><span class="line"><span class="cl"><span class="s2">           shown. If a unit name is specified, properties of the unit is
</span></span></span><span class="line"><span class="cl"><span class="s2">           shown. By default, empty properties are suppressed. Use --all to
</span></span></span><span class="line"><span class="cl"><span class="s2">           show those too. To select specific properties to show, use
</span></span></span><span class="line"><span class="cl"><span class="s2">           --property=. This command is intended to be used whenever
</span></span></span><span class="line"><span class="cl"><span class="s2">           computer-parsable output is required. Use status if you are looking
</span></span></span><span class="line"><span class="cl"><span class="s2">           for formatted human-readable output.
</span></span></span><span class="line"><span class="cl"><span class="s2">           /
</span></span></span><span class="line"><span class="cl"><span class="s2">           NOTE: only a subset of properties is implemented &#34;&#34;&#34;</span>
</span></span><span class="line"><span class="cl">        <span class="n">notfound</span> <span class="o">=</span> <span class="p">[]</span>
</span></span><span class="line"><span class="cl">        <span class="n">units</span> <span class="o">=</span> <span class="p">[]</span>
</span></span><span class="line"><span class="cl">        <span class="n">found_all</span> <span class="o">=</span> <span class="kc">True</span>
</span></span><span class="line"><span class="cl">        <span class="k">for</span> <span class="n">module</span> <span class="ow">in</span> <span class="n">modules</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">            <span class="n">matched</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">match_units</span><span class="p">(</span><span class="n">to_list</span><span class="p">(</span><span class="n">module</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">            <span class="k">if</span> <span class="ow">not</span> <span class="n">matched</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">                <span class="n">logg</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&#34;Unit </span><span class="si">%s</span><span class="s2"> could not be found.&#34;</span><span class="p">,</span> <span class="n">unit_of</span><span class="p">(</span><span class="n">module</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">                <span class="n">units</span> <span class="o">+=</span> <span class="p">[</span><span class="n">module</span><span class="p">]</span>
</span></span><span class="line"><span class="cl">                <span class="c1"># self.error |= NOT_FOUND</span>
</span></span><span class="line"><span class="cl">                <span class="n">found_all</span> <span class="o">=</span> <span class="kc">False</span>
</span></span><span class="line"><span class="cl">                <span class="k">continue</span>
</span></span><span class="line"><span class="cl">            <span class="k">for</span> <span class="n">unit</span> <span class="ow">in</span> <span class="n">matched</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">                <span class="k">if</span> <span class="n">unit</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">units</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">                    <span class="n">units</span> <span class="o">+=</span> <span class="p">[</span><span class="n">unit</span><span class="p">]</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">show_units</span><span class="p">(</span><span class="n">units</span><span class="p">)</span> <span class="o">+</span> <span class="n">notfound</span> <span class="c1"># and found_all</span>
</span></span><span class="line"><span class="cl">    <span class="k">def</span> <span class="nf">show_units</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">units</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">        <span class="n">logg</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&#34;show --property=</span><span class="si">%s</span><span class="s2">&#34;</span><span class="p">,</span> <span class="s2">&#34;,&#34;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_only_property</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">        <span class="n">result</span> <span class="o">=</span> <span class="p">[]</span>
</span></span><span class="line"><span class="cl">        <span class="k">for</span> <span class="n">unit</span> <span class="ow">in</span> <span class="n">units</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">            <span class="k">if</span> <span class="n">result</span><span class="p">:</span> <span class="n">result</span> <span class="o">+=</span> <span class="p">[</span><span class="s2">&#34;&#34;</span><span class="p">]</span>
</span></span><span class="line"><span class="cl">            <span class="k">for</span> <span class="n">var</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">show_unit_items</span><span class="p">(</span><span class="n">unit</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_only_property</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">                    <span class="k">if</span> <span class="n">var</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_only_property</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">                        <span class="k">continue</span>
</span></span><span class="line"><span class="cl">                <span class="k">else</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">                    <span class="k">if</span> <span class="ow">not</span> <span class="n">value</span> <span class="ow">and</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_show_all</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">                        <span class="k">continue</span>
</span></span><span class="line"><span class="cl">                <span class="n">result</span> <span class="o">+=</span> <span class="p">[</span><span class="s2">&#34;</span><span class="si">%s</span><span class="s2">=</span><span class="si">%s</span><span class="s2">&#34;</span> <span class="o">%</span> <span class="p">(</span><span class="n">var</span><span class="p">,</span> <span class="n">value</span><span class="p">)]</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="n">result</span>
</span></span><span class="line"><span class="cl">    <span class="k">def</span> <span class="nf">show_unit_items</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">unit</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">        <span class="s2">&#34;&#34;&#34; [UNIT]... -- show properties of a unit.
</span></span></span><span class="line"><span class="cl"><span class="s2">        &#34;&#34;&#34;</span>
</span></span><span class="line"><span class="cl">        <span class="n">logg</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&#34;try read unit </span><span class="si">%s</span><span class="s2">&#34;</span><span class="p">,</span> <span class="n">unit</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="n">conf</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_unit_conf</span><span class="p">(</span><span class="n">unit</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="k">for</span> <span class="n">entry</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">each_unit_items</span><span class="p">(</span><span class="n">unit</span><span class="p">,</span> <span class="n">conf</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">            <span class="k">yield</span> <span class="n">entry</span>
</span></span><span class="line"><span class="cl">    <span class="k">def</span> <span class="nf">each_unit_items</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">unit</span><span class="p">,</span> <span class="n">conf</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">        <span class="n">loaded</span> <span class="o">=</span> <span class="n">conf</span><span class="o">.</span><span class="n">loaded</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="ow">not</span> <span class="n">loaded</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">            <span class="n">loaded</span> <span class="o">=</span> <span class="s2">&#34;not-loaded&#34;</span>
</span></span><span class="line"><span class="cl">            <span class="k">if</span> <span class="s2">&#34;NOT-FOUND&#34;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_description_from</span><span class="p">(</span><span class="n">conf</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">                <span class="n">loaded</span> <span class="o">=</span> <span class="s2">&#34;not-found&#34;</span>
</span></span><span class="line"><span class="cl">        <span class="n">names</span> <span class="o">=</span> <span class="p">{</span><span class="n">unit</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span> <span class="n">conf</span><span class="o">.</span><span class="n">name</span><span class="p">():</span> <span class="mi">1</span><span class="p">}</span>
</span></span><span class="line"><span class="cl">        <span class="k">yield</span> <span class="s2">&#34;Id&#34;</span><span class="p">,</span> <span class="n">conf</span><span class="o">.</span><span class="n">name</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">        <span class="k">yield</span> <span class="s2">&#34;Names&#34;</span><span class="p">,</span> <span class="s2">&#34; &#34;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="nb">sorted</span><span class="p">(</span><span class="n">names</span><span class="o">.</span><span class="n">keys</span><span class="p">()))</span>
</span></span><span class="line"><span class="cl">        <span class="k">yield</span> <span class="s2">&#34;Description&#34;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_description_from</span><span class="p">(</span><span class="n">conf</span><span class="p">)</span> <span class="c1"># conf.get(Unit, &#34;Description&#34;)</span>
</span></span><span class="line"><span class="cl">        <span class="k">yield</span> <span class="s2">&#34;PIDFile&#34;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_pid_file</span><span class="p">(</span><span class="n">conf</span><span class="p">)</span> <span class="c1"># not self.pid_file_from w/o default location</span>
</span></span><span class="line"><span class="cl">        <span class="k">yield</span> <span class="s2">&#34;PIDFilePath&#34;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">pid_file_from</span><span class="p">(</span><span class="n">conf</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="k">yield</span> <span class="s2">&#34;MainPID&#34;</span><span class="p">,</span> <span class="n">strE</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">active_pid_from</span><span class="p">(</span><span class="n">conf</span><span class="p">))</span>            <span class="c1"># status[&#34;MainPID&#34;] or PIDFile-read</span>
</span></span><span class="line"><span class="cl">        <span class="k">yield</span> <span class="s2">&#34;SubState&#34;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_substate_from</span><span class="p">(</span><span class="n">conf</span><span class="p">)</span> <span class="ow">or</span> <span class="s2">&#34;unknown&#34;</span>  <span class="c1"># status[&#34;SubState&#34;] or notify-result</span>
</span></span><span class="line"><span class="cl">        <span class="k">yield</span> <span class="s2">&#34;ActiveState&#34;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_active_from</span><span class="p">(</span><span class="n">conf</span><span class="p">)</span> <span class="ow">or</span> <span class="s2">&#34;unknown&#34;</span> <span class="c1"># status[&#34;ActiveState&#34;]</span>
</span></span><span class="line"><span class="cl">        <span class="k">yield</span> <span class="s2">&#34;LoadState&#34;</span><span class="p">,</span> <span class="n">loaded</span>
</span></span><span class="line"><span class="cl">        <span class="k">yield</span> <span class="s2">&#34;UnitFileState&#34;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">enabled_from</span><span class="p">(</span><span class="n">conf</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="k">yield</span> <span class="s2">&#34;StatusFile&#34;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_StatusFile</span><span class="p">(</span><span class="n">conf</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="k">yield</span> <span class="s2">&#34;StatusFilePath&#34;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_status_file_from</span><span class="p">(</span><span class="n">conf</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="k">yield</span> <span class="s2">&#34;JournalFile&#34;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_journal_log</span><span class="p">(</span><span class="n">conf</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="k">yield</span> <span class="s2">&#34;JournalFilePath&#34;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_journal_log_from</span><span class="p">(</span><span class="n">conf</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="k">yield</span> <span class="s2">&#34;NotifySocket&#34;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_notify_socket_from</span><span class="p">(</span><span class="n">conf</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="k">yield</span> <span class="s2">&#34;User&#34;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_User</span><span class="p">(</span><span class="n">conf</span><span class="p">)</span> <span class="ow">or</span> <span class="s2">&#34;&#34;</span>
</span></span><span class="line"><span class="cl">        <span class="k">yield</span> <span class="s2">&#34;Group&#34;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_Group</span><span class="p">(</span><span class="n">conf</span><span class="p">)</span> <span class="ow">or</span> <span class="s2">&#34;&#34;</span>
</span></span><span class="line"><span class="cl">        <span class="k">yield</span> <span class="s2">&#34;SupplementaryGroups&#34;</span><span class="p">,</span> <span class="s2">&#34; &#34;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">get_SupplementaryGroups</span><span class="p">(</span><span class="n">conf</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">        <span class="k">yield</span> <span class="s2">&#34;TimeoutStartUSec&#34;</span><span class="p">,</span> <span class="n">seconds_to_time</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">get_TimeoutStartSec</span><span class="p">(</span><span class="n">conf</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">        <span class="k">yield</span> <span class="s2">&#34;TimeoutStopUSec&#34;</span><span class="p">,</span> <span class="n">seconds_to_time</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">get_TimeoutStopSec</span><span class="p">(</span><span class="n">conf</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">        <span class="k">yield</span> <span class="s2">&#34;NeedDaemonReload&#34;</span><span class="p">,</span> <span class="s2">&#34;no&#34;</span>
</span></span><span class="line"><span class="cl">        <span class="k">yield</span> <span class="s2">&#34;SendSIGKILL&#34;</span><span class="p">,</span> <span class="n">strYes</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">get_SendSIGKILL</span><span class="p">(</span><span class="n">conf</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">        <span class="k">yield</span> <span class="s2">&#34;SendSIGHUP&#34;</span><span class="p">,</span> <span class="n">strYes</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">get_SendSIGHUP</span><span class="p">(</span><span class="n">conf</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">        <span class="k">yield</span> <span class="s2">&#34;KillMode&#34;</span><span class="p">,</span> <span class="n">strE</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">get_KillMode</span><span class="p">(</span><span class="n">conf</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">        <span class="k">yield</span> <span class="s2">&#34;KillSignal&#34;</span><span class="p">,</span> <span class="n">strE</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">get_KillSignal</span><span class="p">(</span><span class="n">conf</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">        <span class="k">yield</span> <span class="s2">&#34;StartLimitBurst&#34;</span><span class="p">,</span> <span class="n">strE</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">get_StartLimitBurst</span><span class="p">(</span><span class="n">conf</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">        <span class="k">yield</span> <span class="s2">&#34;StartLimitIntervalSec&#34;</span><span class="p">,</span> <span class="n">seconds_to_time</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">get_StartLimitIntervalSec</span><span class="p">(</span><span class="n">conf</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">        <span class="k">yield</span> <span class="s2">&#34;RestartSec&#34;</span><span class="p">,</span> <span class="n">seconds_to_time</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">get_RestartSec</span><span class="p">(</span><span class="n">conf</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">        <span class="k">yield</span> <span class="s2">&#34;RemainAfterExit&#34;</span><span class="p">,</span> <span class="n">strYes</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">get_RemainAfterExit</span><span class="p">(</span><span class="n">conf</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">        <span class="k">yield</span> <span class="s2">&#34;WorkingDirectory&#34;</span><span class="p">,</span> <span class="n">strE</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">get_WorkingDirectory</span><span class="p">(</span><span class="n">conf</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">        <span class="n">env_parts</span> <span class="o">=</span> <span class="p">[]</span>
</span></span><span class="line"><span class="cl">        <span class="k">for</span> <span class="n">env_part</span> <span class="ow">in</span> <span class="n">conf</span><span class="o">.</span><span class="n">getlist</span><span class="p">(</span><span class="n">Service</span><span class="p">,</span> <span class="s2">&#34;Environment&#34;</span><span class="p">,</span> <span class="p">[]):</span>
</span></span><span class="line"><span class="cl">            <span class="n">env_parts</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">expand_special</span><span class="p">(</span><span class="n">env_part</span><span class="p">,</span> <span class="n">conf</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="n">env_parts</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">            <span class="k">yield</span> <span class="s2">&#34;Environment&#34;</span><span class="p">,</span> <span class="s2">&#34; &#34;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">env_parts</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="n">env_files</span> <span class="o">=</span> <span class="p">[]</span>
</span></span><span class="line"><span class="cl">        <span class="k">for</span> <span class="n">env_file</span> <span class="ow">in</span> <span class="n">conf</span><span class="o">.</span><span class="n">getlist</span><span class="p">(</span><span class="n">Service</span><span class="p">,</span> <span class="s2">&#34;EnvironmentFile&#34;</span><span class="p">,</span> <span class="p">[]):</span>
</span></span><span class="line"><span class="cl">            <span class="n">env_files</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">expand_special</span><span class="p">(</span><span class="n">env_file</span><span class="p">,</span> <span class="n">conf</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="n">env_files</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">            <span class="k">yield</span> <span class="s2">&#34;EnvironmentFile&#34;</span><span class="p">,</span> <span class="s2">&#34; &#34;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">env_files</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="k">def</span> <span class="nf">get_SendSIGKILL</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">conf</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="n">conf</span><span class="o">.</span><span class="n">getbool</span><span class="p">(</span><span class="n">Service</span><span class="p">,</span> <span class="s2">&#34;SendSIGKILL&#34;</span><span class="p">,</span> <span class="s2">&#34;yes&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="k">def</span> <span class="nf">get_SendSIGHUP</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">conf</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="n">conf</span><span class="o">.</span><span class="n">getbool</span><span class="p">(</span><span class="n">Service</span><span class="p">,</span> <span class="s2">&#34;SendSIGHUP&#34;</span><span class="p">,</span> <span class="s2">&#34;no&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="k">def</span> <span class="nf">get_KillMode</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">conf</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="n">conf</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">Service</span><span class="p">,</span> <span class="s2">&#34;KillMode&#34;</span><span class="p">,</span> <span class="s2">&#34;control-group&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="k">def</span> <span class="nf">get_KillSignal</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">conf</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="n">conf</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">Service</span><span class="p">,</span> <span class="s2">&#34;KillSignal&#34;</span><span class="p">,</span> <span class="s2">&#34;SIGTERM&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="c1">#</span>
</span></span><span class="line"><span class="cl">    <span class="n">igno_centos</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&#34;netconsole&#34;</span><span class="p">,</span> <span class="s2">&#34;network&#34;</span><span class="p">]</span>
</span></span><span class="line"><span class="cl">    <span class="n">igno_opensuse</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&#34;raw&#34;</span><span class="p">,</span> <span class="s2">&#34;pppoe&#34;</span><span class="p">,</span> <span class="s2">&#34;*.local&#34;</span><span class="p">,</span> <span class="s2">&#34;boot.*&#34;</span><span class="p">,</span> <span class="s2">&#34;rpmconf*&#34;</span><span class="p">,</span> <span class="s2">&#34;postfix*&#34;</span><span class="p">]</span>
</span></span><span class="line"><span class="cl">    <span class="n">igno_ubuntu</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&#34;mount*&#34;</span><span class="p">,</span> <span class="s2">&#34;umount*&#34;</span><span class="p">,</span> <span class="s2">&#34;ondemand&#34;</span><span class="p">,</span> <span class="s2">&#34;*.local&#34;</span><span class="p">]</span>
</span></span><span class="line"><span class="cl">    <span class="n">igno_always</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&#34;network*&#34;</span><span class="p">,</span> <span class="s2">&#34;dbus*&#34;</span><span class="p">,</span> <span class="s2">&#34;systemd-*&#34;</span><span class="p">,</span> <span class="s2">&#34;kdump*&#34;</span><span class="p">,</span> <span class="s2">&#34;kmod*&#34;</span><span class="p">]</span>
</span></span><span class="line"><span class="cl">    <span class="n">igno_always</span> <span class="o">+=</span> <span class="p">[</span><span class="s2">&#34;purge-kernels.service&#34;</span><span class="p">,</span> <span class="s2">&#34;after-local.service&#34;</span><span class="p">,</span> <span class="s2">&#34;dm-event.*&#34;</span><span class="p">]</span> <span class="c1"># as on opensuse</span>
</span></span><span class="line"><span class="cl">    <span class="n">igno_targets</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&#34;remote-fs.target&#34;</span><span class="p">]</span>
</span></span><span class="line"><span class="cl">    <span class="k">def</span> <span class="nf">_ignored_unit</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">unit</span><span class="p">,</span> <span class="n">ignore_list</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">        <span class="k">for</span> <span class="n">ignore</span> <span class="ow">in</span> <span class="n">ignore_list</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">            <span class="k">if</span> <span class="n">fnmatch</span><span class="o">.</span><span class="n">fnmatchcase</span><span class="p">(</span><span class="n">unit</span><span class="p">,</span> <span class="n">ignore</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">                <span class="k">return</span> <span class="kc">True</span> <span class="c1"># ignore</span>
</span></span><span class="line"><span class="cl">            <span class="k">if</span> <span class="n">fnmatch</span><span class="o">.</span><span class="n">fnmatchcase</span><span class="p">(</span><span class="n">unit</span><span class="p">,</span> <span class="n">ignore</span><span class="o">+</span><span class="s2">&#34;.service&#34;</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">                <span class="k">return</span> <span class="kc">True</span> <span class="c1"># ignore</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="kc">False</span>
</span></span><span class="line"><span class="cl">    <span class="k">def</span> <span class="nf">default_services_modules</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">modules</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">        <span class="s2">&#34;&#34;&#34; show the default services
</span></span></span><span class="line"><span class="cl"><span class="s2">            This is used internally to know the list of service to be started in the &#39;get-default&#39;
</span></span></span><span class="line"><span class="cl"><span class="s2">            target runlevel when the container is started through default initialisation. It will
</span></span></span><span class="line"><span class="cl"><span class="s2">            ignore a number of services - use &#39;--all&#39; to show a longer list of services and
</span></span></span><span class="line"><span class="cl"><span class="s2">            use &#39;--all --force&#39; if not even a minimal filter shall be used.
</span></span></span><span class="line"><span class="cl"><span class="s2">        &#34;&#34;&#34;</span>
</span></span><span class="line"><span class="cl">        <span class="n">results</span> <span class="o">=</span> <span class="p">[]</span>
</span></span><span class="line"><span class="cl">        <span class="n">targets</span> <span class="o">=</span> <span class="n">modules</span> <span class="ow">or</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">get_default_target</span><span class="p">()]</span>
</span></span><span class="line"><span class="cl">        <span class="k">for</span> <span class="n">target</span> <span class="ow">in</span> <span class="n">targets</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">            <span class="n">units</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">target_default_services</span><span class="p">(</span><span class="n">target</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">            <span class="n">logg</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&#34; </span><span class="si">%s</span><span class="s2"> # </span><span class="si">%s</span><span class="s2">&#34;</span><span class="p">,</span> <span class="s2">&#34; &#34;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">units</span><span class="p">),</span> <span class="n">target</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">            <span class="k">for</span> <span class="n">unit</span> <span class="ow">in</span> <span class="n">units</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">                <span class="k">if</span> <span class="n">unit</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">results</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">                    <span class="n">results</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">unit</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="n">results</span>
</span></span><span class="line"><span class="cl">    <span class="k">def</span> <span class="nf">target_default_services</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">target</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">sysv</span> <span class="o">=</span> <span class="s2">&#34;S&#34;</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">        <span class="s2">&#34;&#34;&#34; get the default services for a target - this will ignore a number of services,
</span></span></span><span class="line"><span class="cl"><span class="s2">            use &#39;--all&#39; and --force&#39; to get more services.
</span></span></span><span class="line"><span class="cl"><span class="s2">        &#34;&#34;&#34;</span>
</span></span><span class="line"><span class="cl">        <span class="n">igno</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">igno_centos</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">igno_opensuse</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">igno_ubuntu</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">igno_always</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_show_all</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">            <span class="n">igno</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">igno_always</span>
</span></span><span class="line"><span class="cl">            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_force</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">                <span class="n">igno</span> <span class="o">=</span> <span class="p">[]</span>
</span></span><span class="line"><span class="cl">        <span class="n">logg</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&#34;ignored services filter for default.target:</span><span class="se">\n\t</span><span class="si">%s</span><span class="s2">&#34;</span><span class="p">,</span> <span class="n">igno</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="n">default_target</span> <span class="o">=</span> <span class="n">target</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_default_target</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">enabled_target_services</span><span class="p">(</span><span class="n">default_target</span><span class="p">,</span> <span class="n">sysv</span><span class="p">,</span> <span class="n">igno</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="k">def</span> <span class="nf">enabled_target_services</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">target</span><span class="p">,</span> <span class="n">sysv</span> <span class="o">=</span> <span class="s2">&#34;S&#34;</span><span class="p">,</span> <span class="n">igno</span> <span class="o">=</span> <span class="p">[]):</span>
</span></span><span class="line"><span class="cl">        <span class="n">units</span> <span class="o">=</span> <span class="p">[]</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">user_mode</span><span class="p">():</span>
</span></span><span class="line"><span class="cl">            <span class="n">targetlist</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_target_list</span><span class="p">(</span><span class="n">target</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">            <span class="n">logg</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&#34;check for </span><span class="si">%s</span><span class="s2"> user services : </span><span class="si">%s</span><span class="s2">&#34;</span><span class="p">,</span> <span class="n">target</span><span class="p">,</span> <span class="n">targetlist</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">            <span class="k">for</span> <span class="n">targets</span> <span class="ow">in</span> <span class="n">targetlist</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">                <span class="k">for</span> <span class="n">unit</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">enabled_target_user_local_units</span><span class="p">(</span><span class="n">targets</span><span class="p">,</span> <span class="s2">&#34;.target&#34;</span><span class="p">,</span> <span class="n">igno</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">                    <span class="k">if</span> <span class="n">unit</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">units</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">                        <span class="n">units</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">unit</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">            <span class="k">for</span> <span class="n">targets</span> <span class="ow">in</span> <span class="n">targetlist</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">                <span class="k">for</span> <span class="n">unit</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">required_target_units</span><span class="p">(</span><span class="n">targets</span><span class="p">,</span> <span class="s2">&#34;.socket&#34;</span><span class="p">,</span> <span class="n">igno</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">                    <span class="k">if</span> <span class="n">unit</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">units</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">                        <span class="n">units</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">unit</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">            <span class="k">for</span> <span class="n">targets</span> <span class="ow">in</span> <span class="n">targetlist</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">                <span class="k">for</span> <span class="n">unit</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">enabled_target_user_local_units</span><span class="p">(</span><span class="n">targets</span><span class="p">,</span> <span class="s2">&#34;.socket&#34;</span><span class="p">,</span> <span class="n">igno</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">                    <span class="k">if</span> <span class="n">unit</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">units</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">                        <span class="n">units</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">unit</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">            <span class="k">for</span> <span class="n">targets</span> <span class="ow">in</span> <span class="n">targetlist</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">                <span class="k">for</span> <span class="n">unit</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">required_target_units</span><span class="p">(</span><span class="n">targets</span><span class="p">,</span> <span class="s2">&#34;.service&#34;</span><span class="p">,</span> <span class="n">igno</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">                    <span class="k">if</span> <span class="n">unit</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">units</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">                        <span class="n">units</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">unit</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">            <span class="k">for</span> <span class="n">targets</span> <span class="ow">in</span> <span class="n">targetlist</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">                <span class="k">for</span> <span class="n">unit</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">enabled_target_user_local_units</span><span class="p">(</span><span class="n">targets</span><span class="p">,</span> <span class="s2">&#34;.service&#34;</span><span class="p">,</span> <span class="n">igno</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">                    <span class="k">if</span> <span class="n">unit</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">units</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">                        <span class="n">units</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">unit</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">            <span class="k">for</span> <span class="n">targets</span> <span class="ow">in</span> <span class="n">targetlist</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">                <span class="k">for</span> <span class="n">unit</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">enabled_target_user_system_units</span><span class="p">(</span><span class="n">targets</span><span class="p">,</span> <span class="s2">&#34;.service&#34;</span><span class="p">,</span> <span class="n">igno</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">                    <span class="k">if</span> <span class="n">unit</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">units</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">                        <span class="n">units</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">unit</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="k">else</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">            <span class="n">targetlist</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_target_list</span><span class="p">(</span><span class="n">target</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">            <span class="n">logg</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&#34;check for </span><span class="si">%s</span><span class="s2"> system services: </span><span class="si">%s</span><span class="s2">&#34;</span><span class="p">,</span> <span class="n">target</span><span class="p">,</span> <span class="n">targetlist</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">            <span class="k">for</span> <span class="n">targets</span> <span class="ow">in</span> <span class="n">targetlist</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">                <span class="k">for</span> <span class="n">unit</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">enabled_target_configured_system_units</span><span class="p">(</span><span class="n">targets</span><span class="p">,</span> <span class="s2">&#34;.target&#34;</span><span class="p">,</span> <span class="n">igno</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">igno_targets</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">                    <span class="k">if</span> <span class="n">unit</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">units</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">                        <span class="n">units</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">unit</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">            <span class="k">for</span> <span class="n">targets</span> <span class="ow">in</span> <span class="n">targetlist</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">                <span class="k">for</span> <span class="n">unit</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">required_target_units</span><span class="p">(</span><span class="n">targets</span><span class="p">,</span> <span class="s2">&#34;.socket&#34;</span><span class="p">,</span> <span class="n">igno</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">                    <span class="k">if</span> <span class="n">unit</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">units</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">                        <span class="n">units</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">unit</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">            <span class="k">for</span> <span class="n">targets</span> <span class="ow">in</span> <span class="n">targetlist</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">                <span class="k">for</span> <span class="n">unit</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">enabled_target_installed_system_units</span><span class="p">(</span><span class="n">targets</span><span class="p">,</span> <span class="s2">&#34;.socket&#34;</span><span class="p">,</span> <span class="n">igno</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">                    <span class="k">if</span> <span class="n">unit</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">units</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">                        <span class="n">units</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">unit</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">            <span class="k">for</span> <span class="n">targets</span> <span class="ow">in</span> <span class="n">targetlist</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">                <span class="k">for</span> <span class="n">unit</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">required_target_units</span><span class="p">(</span><span class="n">targets</span><span class="p">,</span> <span class="s2">&#34;.service&#34;</span><span class="p">,</span> <span class="n">igno</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">                    <span class="k">if</span> <span class="n">unit</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">units</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">                        <span class="n">units</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">unit</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">            <span class="k">for</span> <span class="n">targets</span> <span class="ow">in</span> <span class="n">targetlist</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">                <span class="k">for</span> <span class="n">unit</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">enabled_target_installed_system_units</span><span class="p">(</span><span class="n">targets</span><span class="p">,</span> <span class="s2">&#34;.service&#34;</span><span class="p">,</span> <span class="n">igno</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">                    <span class="k">if</span> <span class="n">unit</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">units</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">                        <span class="n">units</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">unit</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">            <span class="k">for</span> <span class="n">targets</span> <span class="ow">in</span> <span class="n">targetlist</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">                <span class="k">for</span> <span class="n">unit</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">enabled_target_sysv_units</span><span class="p">(</span><span class="n">targets</span><span class="p">,</span> <span class="n">sysv</span><span class="p">,</span> <span class="n">igno</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">                    <span class="k">if</span> <span class="n">unit</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">units</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">                        <span class="n">units</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">unit</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="n">units</span>
</span></span><span class="line"><span class="cl">    <span class="k">def</span> <span class="nf">enabled_target_user_local_units</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">target</span><span class="p">,</span> <span class="n">unit_kind</span> <span class="o">=</span> <span class="s2">&#34;.service&#34;</span><span class="p">,</span> <span class="n">igno</span> <span class="o">=</span> <span class="p">[]):</span>
</span></span><span class="line"><span class="cl">        <span class="n">units</span> <span class="o">=</span> <span class="p">[]</span>
</span></span><span class="line"><span class="cl">        <span class="k">for</span> <span class="n">basefolder</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">user_folders</span><span class="p">():</span>
</span></span><span class="line"><span class="cl">            <span class="k">if</span> <span class="ow">not</span> <span class="n">basefolder</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">                <span class="k">continue</span>
</span></span><span class="line"><span class="cl">            <span class="n">folder</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">default_enablefolder</span><span class="p">(</span><span class="n">target</span><span class="p">,</span> <span class="n">basefolder</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_root</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">                <span class="n">folder</span> <span class="o">=</span> <span class="n">os_path</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_root</span><span class="p">,</span> <span class="n">folder</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">            <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isdir</span><span class="p">(</span><span class="n">folder</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">                <span class="k">for</span> <span class="n">unit</span> <span class="ow">in</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">listdir</span><span class="p">(</span><span class="n">folder</span><span class="p">)):</span>
</span></span><span class="line"><span class="cl">                    <span class="n">path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">folder</span><span class="p">,</span> <span class="n">unit</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">                    <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isdir</span><span class="p">(</span><span class="n">path</span><span class="p">):</span> <span class="k">continue</span>
</span></span><span class="line"><span class="cl">                    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_ignored_unit</span><span class="p">(</span><span class="n">unit</span><span class="p">,</span> <span class="n">igno</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">                        <span class="k">continue</span> <span class="c1"># ignore</span>
</span></span><span class="line"><span class="cl">                    <span class="k">if</span> <span class="n">unit</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="n">unit_kind</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">                        <span class="n">units</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">unit</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="n">units</span>
</span></span><span class="line"><span class="cl">    <span class="k">def</span> <span class="nf">enabled_target_user_system_units</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">target</span><span class="p">,</span> <span class="n">unit_kind</span> <span class="o">=</span> <span class="s2">&#34;.service&#34;</span><span class="p">,</span> <span class="n">igno</span> <span class="o">=</span> <span class="p">[]):</span>
</span></span><span class="line"><span class="cl">        <span class="n">units</span> <span class="o">=</span> <span class="p">[]</span>
</span></span><span class="line"><span class="cl">        <span class="k">for</span> <span class="n">basefolder</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">system_folders</span><span class="p">():</span>
</span></span><span class="line"><span class="cl">            <span class="k">if</span> <span class="ow">not</span> <span class="n">basefolder</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">                <span class="k">continue</span>
</span></span><span class="line"><span class="cl">            <span class="n">folder</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">default_enablefolder</span><span class="p">(</span><span class="n">target</span><span class="p">,</span> <span class="n">basefolder</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_root</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">                <span class="n">folder</span> <span class="o">=</span> <span class="n">os_path</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_root</span><span class="p">,</span> <span class="n">folder</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">            <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isdir</span><span class="p">(</span><span class="n">folder</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">                <span class="k">for</span> <span class="n">unit</span> <span class="ow">in</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">listdir</span><span class="p">(</span><span class="n">folder</span><span class="p">)):</span>
</span></span><span class="line"><span class="cl">                    <span class="n">path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">folder</span><span class="p">,</span> <span class="n">unit</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">                    <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isdir</span><span class="p">(</span><span class="n">path</span><span class="p">):</span> <span class="k">continue</span>
</span></span><span class="line"><span class="cl">                    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_ignored_unit</span><span class="p">(</span><span class="n">unit</span><span class="p">,</span> <span class="n">igno</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">                        <span class="k">continue</span> <span class="c1"># ignore</span>
</span></span><span class="line"><span class="cl">                    <span class="k">if</span> <span class="n">unit</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="n">unit_kind</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">                        <span class="n">conf</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">load_unit_conf</span><span class="p">(</span><span class="n">unit</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">                        <span class="k">if</span> <span class="n">conf</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">                            <span class="k">pass</span>
</span></span><span class="line"><span class="cl">                        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">not_user_conf</span><span class="p">(</span><span class="n">conf</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">                            <span class="k">pass</span>
</span></span><span class="line"><span class="cl">                        <span class="k">else</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">                            <span class="n">units</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">unit</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="n">units</span>
</span></span><span class="line"><span class="cl">    <span class="k">def</span> <span class="nf">enabled_target_installed_system_units</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">target</span><span class="p">,</span> <span class="n">unit_type</span> <span class="o">=</span> <span class="s2">&#34;.service&#34;</span><span class="p">,</span> <span class="n">igno</span> <span class="o">=</span> <span class="p">[]):</span>
</span></span><span class="line"><span class="cl">        <span class="n">units</span> <span class="o">=</span> <span class="p">[]</span>
</span></span><span class="line"><span class="cl">        <span class="k">for</span> <span class="n">basefolder</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">system_folders</span><span class="p">():</span>
</span></span><span class="line"><span class="cl">            <span class="k">if</span> <span class="ow">not</span> <span class="n">basefolder</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">                <span class="k">continue</span>
</span></span><span class="line"><span class="cl">            <span class="n">folder</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">default_enablefolder</span><span class="p">(</span><span class="n">target</span><span class="p">,</span> <span class="n">basefolder</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_root</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">                <span class="n">folder</span> <span class="o">=</span> <span class="n">os_path</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_root</span><span class="p">,</span> <span class="n">folder</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">            <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isdir</span><span class="p">(</span><span class="n">folder</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">                <span class="k">for</span> <span class="n">unit</span> <span class="ow">in</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">listdir</span><span class="p">(</span><span class="n">folder</span><span class="p">)):</span>
</span></span><span class="line"><span class="cl">                    <span class="n">path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">folder</span><span class="p">,</span> <span class="n">unit</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">                    <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isdir</span><span class="p">(</span><span class="n">path</span><span class="p">):</span> <span class="k">continue</span>
</span></span><span class="line"><span class="cl">                    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_ignored_unit</span><span class="p">(</span><span class="n">unit</span><span class="p">,</span> <span class="n">igno</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">                        <span class="k">continue</span> <span class="c1"># ignore</span>
</span></span><span class="line"><span class="cl">                    <span class="k">if</span> <span class="n">unit</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="n">unit_type</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">                        <span class="n">units</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">unit</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="n">units</span>
</span></span><span class="line"><span class="cl">    <span class="k">def</span> <span class="nf">enabled_target_configured_system_units</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">target</span><span class="p">,</span> <span class="n">unit_type</span> <span class="o">=</span> <span class="s2">&#34;.service&#34;</span><span class="p">,</span> <span class="n">igno</span> <span class="o">=</span> <span class="p">[]):</span>
</span></span><span class="line"><span class="cl">        <span class="n">units</span> <span class="o">=</span> <span class="p">[]</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="kc">True</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">            <span class="n">folder</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">default_enablefolder</span><span class="p">(</span><span class="n">target</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_root</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">                <span class="n">folder</span> <span class="o">=</span> <span class="n">os_path</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_root</span><span class="p">,</span> <span class="n">folder</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">            <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isdir</span><span class="p">(</span><span class="n">folder</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">                <span class="k">for</span> <span class="n">unit</span> <span class="ow">in</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">listdir</span><span class="p">(</span><span class="n">folder</span><span class="p">)):</span>
</span></span><span class="line"><span class="cl">                    <span class="n">path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">folder</span><span class="p">,</span> <span class="n">unit</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">                    <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isdir</span><span class="p">(</span><span class="n">path</span><span class="p">):</span> <span class="k">continue</span>
</span></span><span class="line"><span class="cl">                    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_ignored_unit</span><span class="p">(</span><span class="n">unit</span><span class="p">,</span> <span class="n">igno</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">                        <span class="k">continue</span> <span class="c1"># ignore</span>
</span></span><span class="line"><span class="cl">                    <span class="k">if</span> <span class="n">unit</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="n">unit_type</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">                        <span class="n">units</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">unit</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="n">units</span>
</span></span><span class="line"><span class="cl">    <span class="k">def</span> <span class="nf">enabled_target_sysv_units</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">target</span><span class="p">,</span> <span class="n">sysv</span> <span class="o">=</span> <span class="s2">&#34;S&#34;</span><span class="p">,</span> <span class="n">igno</span> <span class="o">=</span> <span class="p">[]):</span>
</span></span><span class="line"><span class="cl">        <span class="n">units</span> <span class="o">=</span> <span class="p">[]</span>
</span></span><span class="line"><span class="cl">        <span class="n">folders</span> <span class="o">=</span> <span class="p">[]</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="n">target</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&#34;multi-user.target&#34;</span><span class="p">,</span> <span class="n">DefaultUnit</span><span class="p">]:</span>
</span></span><span class="line"><span class="cl">            <span class="n">folders</span> <span class="o">+=</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">rc3_root_folder</span><span class="p">()]</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="n">target</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&#34;graphical.target&#34;</span><span class="p">]:</span>
</span></span><span class="line"><span class="cl">            <span class="n">folders</span> <span class="o">+=</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">rc5_root_folder</span><span class="p">()]</span>
</span></span><span class="line"><span class="cl">        <span class="k">for</span> <span class="n">folder</span> <span class="ow">in</span> <span class="n">folders</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">            <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isdir</span><span class="p">(</span><span class="n">folder</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">                <span class="n">logg</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&#34;non-existent </span><span class="si">%s</span><span class="s2">&#34;</span><span class="p">,</span> <span class="n">folder</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">                <span class="k">continue</span>
</span></span><span class="line"><span class="cl">            <span class="k">for</span> <span class="n">unit</span> <span class="ow">in</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">listdir</span><span class="p">(</span><span class="n">folder</span><span class="p">)):</span>
</span></span><span class="line"><span class="cl">                <span class="n">path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">folder</span><span class="p">,</span> <span class="n">unit</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">                <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isdir</span><span class="p">(</span><span class="n">path</span><span class="p">):</span> <span class="k">continue</span>
</span></span><span class="line"><span class="cl">                <span class="n">m</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="k">match</span><span class="p">(</span><span class="n">sysv</span><span class="o">+</span><span class="sa">r</span><span class="s2">&#34;\d\d(.*)&#34;</span><span class="p">,</span> <span class="n">unit</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">                <span class="k">if</span> <span class="n">m</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">                    <span class="n">service</span> <span class="o">=</span> <span class="n">m</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">                    <span class="n">unit</span> <span class="o">=</span> <span class="n">service</span> <span class="o">+</span> <span class="s2">&#34;.service&#34;</span>
</span></span><span class="line"><span class="cl">                    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_ignored_unit</span><span class="p">(</span><span class="n">unit</span><span class="p">,</span> <span class="n">igno</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">                        <span class="k">continue</span> <span class="c1"># ignore</span>
</span></span><span class="line"><span class="cl">                    <span class="n">units</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">unit</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="n">units</span>
</span></span><span class="line"><span class="cl">    <span class="k">def</span> <span class="nf">required_target_units</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">target</span><span class="p">,</span> <span class="n">unit_type</span><span class="p">,</span> <span class="n">igno</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">        <span class="n">units</span> <span class="o">=</span> <span class="p">[]</span>
</span></span><span class="line"><span class="cl">        <span class="n">deps</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_required_dependencies</span><span class="p">(</span><span class="n">target</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="k">for</span> <span class="n">unit</span> <span class="ow">in</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">deps</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_ignored_unit</span><span class="p">(</span><span class="n">unit</span><span class="p">,</span> <span class="n">igno</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">                <span class="k">continue</span> <span class="c1"># ignore</span>
</span></span><span class="line"><span class="cl">            <span class="k">if</span> <span class="n">unit</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="n">unit_type</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">                <span class="k">if</span> <span class="n">unit</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">units</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">                    <span class="n">units</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">unit</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="n">units</span>
</span></span><span class="line"><span class="cl">    <span class="k">def</span> <span class="nf">get_target_conf</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">module</span><span class="p">):</span> <span class="c1"># -&gt; conf (conf | default-conf)</span>
</span></span><span class="line"><span class="cl">        <span class="s2">&#34;&#34;&#34; accept that a unit does not exist
</span></span></span><span class="line"><span class="cl"><span class="s2">            and return a unit conf that says &#39;not-loaded&#39; &#34;&#34;&#34;</span>
</span></span><span class="line"><span class="cl">        <span class="n">conf</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">load_unit_conf</span><span class="p">(</span><span class="n">module</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="n">conf</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">            <span class="k">return</span> <span class="n">conf</span>
</span></span><span class="line"><span class="cl">        <span class="n">target_conf</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">default_unit_conf</span><span class="p">(</span><span class="n">module</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="n">module</span> <span class="ow">in</span> <span class="n">target_requires</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">            <span class="n">target_conf</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="n">Unit</span><span class="p">,</span> <span class="s2">&#34;Requires&#34;</span><span class="p">,</span> <span class="n">target_requires</span><span class="p">[</span><span class="n">module</span><span class="p">])</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="n">target_conf</span>
</span></span><span class="line"><span class="cl">    <span class="k">def</span> <span class="nf">get_target_list</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">module</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">        <span class="s2">&#34;&#34;&#34; the Requires= in target units are only accepted if known &#34;&#34;&#34;</span>
</span></span><span class="line"><span class="cl">        <span class="n">target</span> <span class="o">=</span> <span class="n">module</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="s2">&#34;.&#34;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">target</span><span class="p">:</span> <span class="n">target</span> <span class="o">+=</span> <span class="s2">&#34;.target&#34;</span>
</span></span><span class="line"><span class="cl">        <span class="n">targets</span> <span class="o">=</span> <span class="p">[</span><span class="n">target</span><span class="p">]</span>
</span></span><span class="line"><span class="cl">        <span class="n">conf</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_target_conf</span><span class="p">(</span><span class="n">module</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="n">requires</span> <span class="o">=</span> <span class="n">conf</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">Unit</span><span class="p">,</span> <span class="s2">&#34;Requires&#34;</span><span class="p">,</span> <span class="s2">&#34;&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="k">while</span> <span class="n">requires</span> <span class="ow">in</span> <span class="n">target_requires</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">            <span class="n">targets</span> <span class="o">=</span> <span class="p">[</span><span class="n">requires</span><span class="p">]</span> <span class="o">+</span> <span class="n">targets</span>
</span></span><span class="line"><span class="cl">            <span class="n">requires</span> <span class="o">=</span> <span class="n">target_requires</span><span class="p">[</span><span class="n">requires</span><span class="p">]</span>
</span></span><span class="line"><span class="cl">        <span class="n">logg</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&#34;the </span><span class="si">%s</span><span class="s2"> requires </span><span class="si">%s</span><span class="s2">&#34;</span><span class="p">,</span> <span class="n">module</span><span class="p">,</span> <span class="n">targets</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="n">targets</span>
</span></span><span class="line"><span class="cl">    <span class="k">def</span> <span class="nf">default_system</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">arg</span> <span class="o">=</span> <span class="kc">True</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">        <span class="s2">&#34;&#34;&#34; start units for default system level
</span></span></span><span class="line"><span class="cl"><span class="s2">            This will go through the enabled services in the default &#39;multi-user.target&#39;.
</span></span></span><span class="line"><span class="cl"><span class="s2">            However some services are ignored as being known to be installation garbage
</span></span></span><span class="line"><span class="cl"><span class="s2">            from unintended services. Use &#39;--all&#39; so start all of the installed services
</span></span></span><span class="line"><span class="cl"><span class="s2">            and with &#39;--all --force&#39; even those services that are otherwise wrong.
</span></span></span><span class="line"><span class="cl"><span class="s2">            /// SPECIAL: with --now or --init the init-loop is run and afterwards
</span></span></span><span class="line"><span class="cl"><span class="s2">                a system_halt is performed with the enabled services to be stopped.&#34;&#34;&#34;</span>
</span></span><span class="line"><span class="cl">        <span class="bp">self</span><span class="o">.</span><span class="n">sysinit_status</span><span class="p">(</span><span class="n">SubState</span> <span class="o">=</span> <span class="s2">&#34;initializing&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="n">logg</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&#34;system default requested - </span><span class="si">%s</span><span class="s2">&#34;</span><span class="p">,</span> <span class="n">arg</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="n">init</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_now</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">_init</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">start_system_default</span><span class="p">(</span><span class="n">init</span> <span class="o">=</span> <span class="n">init</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="k">def</span> <span class="nf">start_system_default</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">init</span> <span class="o">=</span> <span class="kc">False</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">        <span class="s2">&#34;&#34;&#34; detect the default.target services and start them.
</span></span></span><span class="line"><span class="cl"><span class="s2">            When --init is given then the init-loop is run and
</span></span></span><span class="line"><span class="cl"><span class="s2">            the services are stopped again by &#39;systemctl halt&#39;.&#34;&#34;&#34;</span>
</span></span><span class="line"><span class="cl">        <span class="n">target</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_default_target</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">        <span class="n">services</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">start_target_system</span><span class="p">(</span><span class="n">target</span><span class="p">,</span> <span class="n">init</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="n">logg</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&#34;</span><span class="si">%s</span><span class="s2"> system is up&#34;</span><span class="p">,</span> <span class="n">target</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="n">init</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">            <span class="n">logg</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&#34;init-loop start&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">            <span class="n">sig</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">init_loop_until_stop</span><span class="p">(</span><span class="n">services</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">            <span class="n">logg</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&#34;init-loop </span><span class="si">%s</span><span class="s2">&#34;</span><span class="p">,</span> <span class="n">sig</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">            <span class="bp">self</span><span class="o">.</span><span class="n">stop_system_default</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="ow">not</span> <span class="ow">not</span> <span class="n">services</span>
</span></span><span class="line"><span class="cl">    <span class="k">def</span> <span class="nf">start_target_system</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">target</span><span class="p">,</span> <span class="n">init</span> <span class="o">=</span> <span class="kc">False</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">        <span class="n">services</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">target_default_services</span><span class="p">(</span><span class="n">target</span><span class="p">,</span> <span class="s2">&#34;S&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="bp">self</span><span class="o">.</span><span class="n">sysinit_status</span><span class="p">(</span><span class="n">SubState</span> <span class="o">=</span> <span class="s2">&#34;starting&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="bp">self</span><span class="o">.</span><span class="n">start_units</span><span class="p">(</span><span class="n">services</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="n">services</span>
</span></span><span class="line"><span class="cl">    <span class="k">def</span> <span class="nf">do_start_target_from</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">conf</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">        <span class="n">target</span> <span class="o">=</span> <span class="n">conf</span><span class="o">.</span><span class="n">name</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">        <span class="c1"># services = self.start_target_system(target)</span>
</span></span><span class="line"><span class="cl">        <span class="n">services</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">target_default_services</span><span class="p">(</span><span class="n">target</span><span class="p">,</span> <span class="s2">&#34;S&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="n">units</span> <span class="o">=</span> <span class="p">[</span><span class="n">service</span> <span class="k">for</span> <span class="n">service</span> <span class="ow">in</span> <span class="n">services</span> <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">is_running_unit</span><span class="p">(</span><span class="n">service</span><span class="p">)]</span>
</span></span><span class="line"><span class="cl">        <span class="n">logg</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&#34;start </span><span class="si">%s</span><span class="s2"> is starting </span><span class="si">%s</span><span class="s2"> from </span><span class="si">%s</span><span class="s2">&#34;</span><span class="p">,</span> <span class="n">target</span><span class="p">,</span> <span class="n">units</span><span class="p">,</span> <span class="n">services</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">start_units</span><span class="p">(</span><span class="n">units</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="k">def</span> <span class="nf">stop_system_default</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">        <span class="s2">&#34;&#34;&#34; detect the default.target services and stop them.
</span></span></span><span class="line"><span class="cl"><span class="s2">            This is commonly run through &#39;systemctl halt&#39; or
</span></span></span><span class="line"><span class="cl"><span class="s2">            at the end of a &#39;systemctl --init default&#39; loop.&#34;&#34;&#34;</span>
</span></span><span class="line"><span class="cl">        <span class="n">target</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_default_target</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">        <span class="n">services</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">stop_target_system</span><span class="p">(</span><span class="n">target</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="n">logg</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&#34;</span><span class="si">%s</span><span class="s2"> system is down&#34;</span><span class="p">,</span> <span class="n">target</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="ow">not</span> <span class="ow">not</span> <span class="n">services</span>
</span></span><span class="line"><span class="cl">    <span class="k">def</span> <span class="nf">stop_target_system</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">target</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">        <span class="n">services</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">target_default_services</span><span class="p">(</span><span class="n">target</span><span class="p">,</span> <span class="s2">&#34;K&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="bp">self</span><span class="o">.</span><span class="n">sysinit_status</span><span class="p">(</span><span class="n">SubState</span> <span class="o">=</span> <span class="s2">&#34;stopping&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="bp">self</span><span class="o">.</span><span class="n">stop_units</span><span class="p">(</span><span class="n">services</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="n">services</span>
</span></span><span class="line"><span class="cl">    <span class="k">def</span> <span class="nf">do_stop_target_from</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">conf</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">        <span class="n">target</span> <span class="o">=</span> <span class="n">conf</span><span class="o">.</span><span class="n">name</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">        <span class="c1"># services = self.stop_target_system(target)</span>
</span></span><span class="line"><span class="cl">        <span class="n">services</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">target_default_services</span><span class="p">(</span><span class="n">target</span><span class="p">,</span> <span class="s2">&#34;K&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="n">units</span> <span class="o">=</span> <span class="p">[</span><span class="n">service</span> <span class="k">for</span> <span class="n">service</span> <span class="ow">in</span> <span class="n">services</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">is_running_unit</span><span class="p">(</span><span class="n">service</span><span class="p">)]</span>
</span></span><span class="line"><span class="cl">        <span class="n">logg</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&#34;stop </span><span class="si">%s</span><span class="s2"> is stopping </span><span class="si">%s</span><span class="s2"> from </span><span class="si">%s</span><span class="s2">&#34;</span><span class="p">,</span> <span class="n">target</span><span class="p">,</span> <span class="n">units</span><span class="p">,</span> <span class="n">services</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">stop_units</span><span class="p">(</span><span class="n">units</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="k">def</span> <span class="nf">do_reload_target_from</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">conf</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">        <span class="n">target</span> <span class="o">=</span> <span class="n">conf</span><span class="o">.</span><span class="n">name</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">reload_target_system</span><span class="p">(</span><span class="n">target</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="k">def</span> <span class="nf">reload_target_system</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">target</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">        <span class="n">services</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">target_default_services</span><span class="p">(</span><span class="n">target</span><span class="p">,</span> <span class="s2">&#34;S&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="n">units</span> <span class="o">=</span> <span class="p">[</span><span class="n">service</span> <span class="k">for</span> <span class="n">service</span> <span class="ow">in</span> <span class="n">services</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">is_running_unit</span><span class="p">(</span><span class="n">service</span><span class="p">)]</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">reload_units</span><span class="p">(</span><span class="n">units</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="k">def</span> <span class="nf">halt_target</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">arg</span> <span class="o">=</span> <span class="kc">True</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">        <span class="s2">&#34;&#34;&#34; stop units from default system level &#34;&#34;&#34;</span>
</span></span><span class="line"><span class="cl">        <span class="n">logg</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&#34;system halt requested - </span><span class="si">%s</span><span class="s2">&#34;</span><span class="p">,</span> <span class="n">arg</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="n">done</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">stop_system_default</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">        <span class="k">try</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">            <span class="n">os</span><span class="o">.</span><span class="n">kill</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">signal</span><span class="o">.</span><span class="n">SIGQUIT</span><span class="p">)</span> <span class="c1"># exit init-loop on no_more_procs</span>
</span></span><span class="line"><span class="cl">        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">            <span class="n">logg</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&#34;SIGQUIT to init-loop on PID-1: </span><span class="si">%s</span><span class="s2">&#34;</span><span class="p">,</span> <span class="n">e</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="n">done</span>
</span></span><span class="line"><span class="cl">    <span class="k">def</span> <span class="nf">system_get_default</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">        <span class="s2">&#34;&#34;&#34; get current default run-level&#34;&#34;&#34;</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_default_target</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">    <span class="k">def</span> <span class="nf">get_targets_folder</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="n">os_path</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_root</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">mask_folder</span><span class="p">())</span>
</span></span><span class="line"><span class="cl">    <span class="k">def</span> <span class="nf">get_default_target_file</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">        <span class="n">targets_folder</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_targets_folder</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">targets_folder</span><span class="p">,</span> <span class="n">DefaultUnit</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="k">def</span> <span class="nf">get_default_target</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">default_target</span> <span class="o">=</span> <span class="kc">None</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">        <span class="s2">&#34;&#34;&#34; get current default run-level&#34;&#34;&#34;</span>
</span></span><span class="line"><span class="cl">        <span class="n">current</span> <span class="o">=</span> <span class="n">default_target</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">_default_target</span>
</span></span><span class="line"><span class="cl">        <span class="n">default_target_file</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_default_target_file</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">islink</span><span class="p">(</span><span class="n">default_target_file</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">            <span class="n">current</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">basename</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">readlink</span><span class="p">(</span><span class="n">default_target_file</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="n">current</span>
</span></span><span class="line"><span class="cl">    <span class="k">def</span> <span class="nf">set_default_modules</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">modules</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">        <span class="s2">&#34;&#34;&#34; set current default run-level&#34;&#34;&#34;</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="ow">not</span> <span class="n">modules</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">            <span class="n">logg</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&#34;.. no runlevel given&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">            <span class="bp">self</span><span class="o">.</span><span class="n">error</span> <span class="o">|=</span> <span class="n">NOT_OK</span>
</span></span><span class="line"><span class="cl">            <span class="k">return</span> <span class="s2">&#34;Too few arguments&#34;</span>
</span></span><span class="line"><span class="cl">        <span class="n">current</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_default_target</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">        <span class="n">default_target_file</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_default_target_file</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">        <span class="n">msg</span> <span class="o">=</span> <span class="s2">&#34;&#34;</span>
</span></span><span class="line"><span class="cl">        <span class="k">for</span> <span class="n">module</span> <span class="ow">in</span> <span class="n">modules</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">            <span class="k">if</span> <span class="n">module</span> <span class="o">==</span> <span class="n">current</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">                <span class="k">continue</span>
</span></span><span class="line"><span class="cl">            <span class="n">targetfile</span> <span class="o">=</span> <span class="kc">None</span>
</span></span><span class="line"><span class="cl">            <span class="k">for</span> <span class="n">targetname</span><span class="p">,</span> <span class="n">targetpath</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">each_target_file</span><span class="p">():</span>
</span></span><span class="line"><span class="cl">                <span class="k">if</span> <span class="n">targetname</span> <span class="o">==</span> <span class="n">module</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">                    <span class="n">targetfile</span> <span class="o">=</span> <span class="n">targetpath</span>
</span></span><span class="line"><span class="cl">            <span class="k">if</span> <span class="ow">not</span> <span class="n">targetfile</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">                <span class="bp">self</span><span class="o">.</span><span class="n">error</span> <span class="o">|=</span> <span class="n">NOT_OK</span> <span class="o">|</span> <span class="n">NOT_ACTIVE</span> <span class="c1"># 3</span>
</span></span><span class="line"><span class="cl">                <span class="n">msg</span> <span class="o">=</span> <span class="s2">&#34;No such runlevel </span><span class="si">%s</span><span class="s2">&#34;</span> <span class="o">%</span> <span class="p">(</span><span class="n">module</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">                <span class="k">continue</span>
</span></span><span class="line"><span class="cl">            <span class="c1">#</span>
</span></span><span class="line"><span class="cl">            <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">islink</span><span class="p">(</span><span class="n">default_target_file</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">                <span class="n">os</span><span class="o">.</span><span class="n">unlink</span><span class="p">(</span><span class="n">default_target_file</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">            <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isdir</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="n">default_target_file</span><span class="p">)):</span>
</span></span><span class="line"><span class="cl">                <span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="n">default_target_file</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">            <span class="n">os</span><span class="o">.</span><span class="n">symlink</span><span class="p">(</span><span class="n">targetfile</span><span class="p">,</span> <span class="n">default_target_file</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">            <span class="n">msg</span> <span class="o">=</span> <span class="s2">&#34;Created symlink from </span><span class="si">%s</span><span class="s2"> -&gt; </span><span class="si">%s</span><span class="s2">&#34;</span> <span class="o">%</span> <span class="p">(</span><span class="n">default_target_file</span><span class="p">,</span> <span class="n">targetfile</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">            <span class="n">logg</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&#34;</span><span class="si">%s</span><span class="s2">&#34;</span><span class="p">,</span> <span class="n">msg</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="n">msg</span>
</span></span><span class="line"><span class="cl">    <span class="k">def</span> <span class="nf">init_modules</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">modules</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">        <span class="s2">&#34;&#34;&#34; [UNIT*] -- init loop: &#39;--init default&#39; or &#39;--init start UNIT*&#39;
</span></span></span><span class="line"><span class="cl"><span class="s2">        The systemctl init service will start the enabled &#39;default&#39; services,
</span></span></span><span class="line"><span class="cl"><span class="s2">        and then wait for any  zombies to be reaped. When a SIGINT is received
</span></span></span><span class="line"><span class="cl"><span class="s2">        then a clean shutdown of the enabled services is ensured. A Control-C in
</span></span></span><span class="line"><span class="cl"><span class="s2">        in interactive mode will also run &#39;stop&#39; on all the enabled services. //
</span></span></span><span class="line"><span class="cl"><span class="s2">        When a UNIT name is given then only that one is started instead of the
</span></span></span><span class="line"><span class="cl"><span class="s2">        services in the &#39;default.target&#39;. Using &#39;init UNIT&#39; is better than
</span></span></span><span class="line"><span class="cl"><span class="s2">        &#39;--init start UNIT&#39; because the UNIT is also stopped cleanly even when
</span></span></span><span class="line"><span class="cl"><span class="s2">        it was never enabled in the system.
</span></span></span><span class="line"><span class="cl"><span class="s2">        /// SPECIAL: when using --now then only the init-loop is started,
</span></span></span><span class="line"><span class="cl"><span class="s2">        with the reap-zombies function and waiting for an interrupt.
</span></span></span><span class="line"><span class="cl"><span class="s2">        (and no unit is started/stoppped wether given or not).
</span></span></span><span class="line"><span class="cl"><span class="s2">        &#34;&#34;&#34;</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_now</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">            <span class="n">result</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">init_loop_until_stop</span><span class="p">([])</span>
</span></span><span class="line"><span class="cl">            <span class="k">return</span> <span class="ow">not</span> <span class="ow">not</span> <span class="n">result</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="ow">not</span> <span class="n">modules</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">            <span class="c1"># like &#39;systemctl --init default&#39;</span>
</span></span><span class="line"><span class="cl">            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_now</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">_show_all</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">                <span class="n">logg</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&#34;init default --now --all =&gt; no_more_procs&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">                <span class="bp">self</span><span class="o">.</span><span class="n">doExitWhenNoMoreProcs</span> <span class="o">=</span> <span class="kc">True</span>
</span></span><span class="line"><span class="cl">            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">start_system_default</span><span class="p">(</span><span class="n">init</span> <span class="o">=</span> <span class="kc">True</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="c1">#</span>
</span></span><span class="line"><span class="cl">        <span class="c1"># otherwise quit when all the init-services have died</span>
</span></span><span class="line"><span class="cl">        <span class="bp">self</span><span class="o">.</span><span class="n">doExitWhenNoMoreServices</span> <span class="o">=</span> <span class="kc">True</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_now</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">_show_all</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">            <span class="n">logg</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&#34;init services --now --all =&gt; no_more_procs&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">            <span class="bp">self</span><span class="o">.</span><span class="n">doExitWhenNoMoreProcs</span> <span class="o">=</span> <span class="kc">True</span>
</span></span><span class="line"><span class="cl">        <span class="n">found_all</span> <span class="o">=</span> <span class="kc">True</span>
</span></span><span class="line"><span class="cl">        <span class="n">units</span> <span class="o">=</span> <span class="p">[]</span>
</span></span><span class="line"><span class="cl">        <span class="k">for</span> <span class="n">module</span> <span class="ow">in</span> <span class="n">modules</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">            <span class="n">matched</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">match_units</span><span class="p">(</span><span class="n">to_list</span><span class="p">(</span><span class="n">module</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">            <span class="k">if</span> <span class="ow">not</span> <span class="n">matched</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">                <span class="n">logg</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&#34;Unit </span><span class="si">%s</span><span class="s2"> could not be found.&#34;</span><span class="p">,</span> <span class="n">unit_of</span><span class="p">(</span><span class="n">module</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">                <span class="n">found_all</span> <span class="o">=</span> <span class="kc">False</span>
</span></span><span class="line"><span class="cl">                <span class="k">continue</span>
</span></span><span class="line"><span class="cl">            <span class="k">for</span> <span class="n">unit</span> <span class="ow">in</span> <span class="n">matched</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">                <span class="k">if</span> <span class="n">unit</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">units</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">                    <span class="n">units</span> <span class="o">+=</span> <span class="p">[</span><span class="n">unit</span><span class="p">]</span>
</span></span><span class="line"><span class="cl">        <span class="n">logg</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&#34;init </span><span class="si">%s</span><span class="s2"> -&gt; start </span><span class="si">%s</span><span class="s2">&#34;</span><span class="p">,</span> <span class="s2">&#34;,&#34;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">modules</span><span class="p">),</span> <span class="s2">&#34;,&#34;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">units</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">        <span class="n">done</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">start_units</span><span class="p">(</span><span class="n">units</span><span class="p">,</span> <span class="n">init</span> <span class="o">=</span> <span class="kc">True</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="n">logg</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&#34;-- init is done&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="n">done</span> <span class="c1"># and found_all</span>
</span></span><span class="line"><span class="cl">    <span class="k">def</span> <span class="nf">start_log_files</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">units</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">        <span class="bp">self</span><span class="o">.</span><span class="n">_log_file</span> <span class="o">=</span> <span class="p">{}</span>
</span></span><span class="line"><span class="cl">        <span class="bp">self</span><span class="o">.</span><span class="n">_log_hold</span> <span class="o">=</span> <span class="p">{}</span>
</span></span><span class="line"><span class="cl">        <span class="k">for</span> <span class="n">unit</span> <span class="ow">in</span> <span class="n">units</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">            <span class="n">conf</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">load_unit_conf</span><span class="p">(</span><span class="n">unit</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">            <span class="k">if</span> <span class="ow">not</span> <span class="n">conf</span><span class="p">:</span> <span class="k">continue</span>
</span></span><span class="line"><span class="cl">            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">skip_journal_log</span><span class="p">(</span><span class="n">conf</span><span class="p">):</span> <span class="k">continue</span>
</span></span><span class="line"><span class="cl">            <span class="n">log_path</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_journal_log_from</span><span class="p">(</span><span class="n">conf</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">            <span class="k">try</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">                <span class="n">opened</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">log_path</span><span class="p">,</span> <span class="n">os</span><span class="o">.</span><span class="n">O_RDONLY</span> <span class="o">|</span> <span class="n">os</span><span class="o">.</span><span class="n">O_NONBLOCK</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">                <span class="bp">self</span><span class="o">.</span><span class="n">_log_file</span><span class="p">[</span><span class="n">unit</span><span class="p">]</span> <span class="o">=</span> <span class="n">opened</span>
</span></span><span class="line"><span class="cl">                <span class="bp">self</span><span class="o">.</span><span class="n">_log_hold</span><span class="p">[</span><span class="n">unit</span><span class="p">]</span> <span class="o">=</span> <span class="sa">b</span><span class="s2">&#34;&#34;</span>
</span></span><span class="line"><span class="cl">            <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">                <span class="n">logg</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&#34;can not open </span><span class="si">%s</span><span class="s2"> log: </span><span class="si">%s</span><span class="se">\n\t</span><span class="si">%s</span><span class="s2">&#34;</span><span class="p">,</span> <span class="n">unit</span><span class="p">,</span> <span class="n">log_path</span><span class="p">,</span> <span class="n">e</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="k">def</span> <span class="nf">read_log_files</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">units</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">        <span class="bp">self</span><span class="o">.</span><span class="n">print_log_files</span><span class="p">(</span><span class="n">units</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="k">def</span> <span class="nf">print_log_files</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">units</span><span class="p">,</span> <span class="n">stdout</span> <span class="o">=</span> <span class="mi">1</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">        <span class="n">BUFSIZE</span><span class="o">=</span><span class="mi">8192</span>
</span></span><span class="line"><span class="cl">        <span class="n">printed</span> <span class="o">=</span> <span class="mi">0</span>
</span></span><span class="line"><span class="cl">        <span class="k">for</span> <span class="n">unit</span> <span class="ow">in</span> <span class="n">units</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">            <span class="k">if</span> <span class="n">unit</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_log_file</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">                <span class="n">new_text</span> <span class="o">=</span> <span class="sa">b</span><span class="s2">&#34;&#34;</span>
</span></span><span class="line"><span class="cl">                <span class="k">while</span> <span class="kc">True</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">                    <span class="n">buf</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_log_file</span><span class="p">[</span><span class="n">unit</span><span class="p">],</span> <span class="n">BUFSIZE</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">                    <span class="k">if</span> <span class="ow">not</span> <span class="n">buf</span><span class="p">:</span> <span class="k">break</span>
</span></span><span class="line"><span class="cl">                    <span class="n">new_text</span> <span class="o">+=</span> <span class="n">buf</span>
</span></span><span class="line"><span class="cl">                    <span class="k">continue</span>
</span></span><span class="line"><span class="cl">                <span class="n">text</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_log_hold</span><span class="p">[</span><span class="n">unit</span><span class="p">]</span> <span class="o">+</span> <span class="n">new_text</span>
</span></span><span class="line"><span class="cl">                <span class="k">if</span> <span class="ow">not</span> <span class="n">text</span><span class="p">:</span> <span class="k">continue</span>
</span></span><span class="line"><span class="cl">                <span class="n">lines</span> <span class="o">=</span> <span class="n">text</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="sa">b</span><span class="s2">&#34;</span><span class="se">\n</span><span class="s2">&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">                <span class="k">if</span> <span class="ow">not</span> <span class="n">text</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="sa">b</span><span class="s2">&#34;</span><span class="se">\n</span><span class="s2">&#34;</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">                    <span class="bp">self</span><span class="o">.</span><span class="n">_log_hold</span><span class="p">[</span><span class="n">unit</span><span class="p">]</span> <span class="o">=</span> <span class="n">lines</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
</span></span><span class="line"><span class="cl">                    <span class="n">lines</span> <span class="o">=</span> <span class="n">lines</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
</span></span><span class="line"><span class="cl">                <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">lines</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">                    <span class="n">prefix</span> <span class="o">=</span> <span class="n">unit</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="s2">&#34;utf-8&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">                    <span class="n">content</span> <span class="o">=</span> <span class="n">prefix</span><span class="o">+</span><span class="sa">b</span><span class="s2">&#34;: &#34;</span><span class="o">+</span><span class="n">line</span><span class="o">+</span><span class="sa">b</span><span class="s2">&#34;</span><span class="se">\n</span><span class="s2">&#34;</span>
</span></span><span class="line"><span class="cl">                    <span class="k">try</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">                        <span class="n">os</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">stdout</span><span class="p">,</span> <span class="n">content</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">                        <span class="k">try</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">                            <span class="n">os</span><span class="o">.</span><span class="n">fsync</span><span class="p">(</span><span class="n">stdout</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">                        <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">                            <span class="k">pass</span>
</span></span><span class="line"><span class="cl">                        <span class="n">printed</span> <span class="o">+=</span> <span class="mi">1</span>
</span></span><span class="line"><span class="cl">                    <span class="k">except</span> <span class="ne">BlockingIOError</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">                        <span class="k">pass</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="n">printed</span>
</span></span><span class="line"><span class="cl">    <span class="k">def</span> <span class="nf">stop_log_files</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">units</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">        <span class="k">for</span> <span class="n">unit</span> <span class="ow">in</span> <span class="n">units</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">            <span class="k">try</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">                <span class="k">if</span> <span class="n">unit</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_log_file</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">                    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_log_file</span><span class="p">[</span><span class="n">unit</span><span class="p">]:</span>
</span></span><span class="line"><span class="cl">                        <span class="n">os</span><span class="o">.</span><span class="n">close</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_log_file</span><span class="p">[</span><span class="n">unit</span><span class="p">])</span>
</span></span><span class="line"><span class="cl">            <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">                <span class="n">logg</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&#34;can not close log: </span><span class="si">%s</span><span class="se">\n\t</span><span class="si">%s</span><span class="s2">&#34;</span><span class="p">,</span> <span class="n">unit</span><span class="p">,</span> <span class="n">e</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="bp">self</span><span class="o">.</span><span class="n">_log_file</span> <span class="o">=</span> <span class="p">{}</span>
</span></span><span class="line"><span class="cl">        <span class="bp">self</span><span class="o">.</span><span class="n">_log_hold</span> <span class="o">=</span> <span class="p">{}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">def</span> <span class="nf">get_StartLimitBurst</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">conf</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">        <span class="n">defaults</span> <span class="o">=</span> <span class="n">DefaultStartLimitBurst</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="n">to_int</span><span class="p">(</span><span class="n">conf</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">Service</span><span class="p">,</span> <span class="s2">&#34;StartLimitBurst&#34;</span><span class="p">,</span> <span class="n">strE</span><span class="p">(</span><span class="n">defaults</span><span class="p">)),</span> <span class="n">defaults</span><span class="p">)</span> <span class="c1"># 5</span>
</span></span><span class="line"><span class="cl">    <span class="k">def</span> <span class="nf">get_StartLimitIntervalSec</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">conf</span><span class="p">,</span> <span class="n">maximum</span> <span class="o">=</span> <span class="kc">None</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">        <span class="n">maximum</span> <span class="o">=</span> <span class="n">maximum</span> <span class="ow">or</span> <span class="mi">999</span>
</span></span><span class="line"><span class="cl">        <span class="n">defaults</span> <span class="o">=</span> <span class="n">DefaultStartLimitIntervalSec</span>
</span></span><span class="line"><span class="cl">        <span class="n">interval</span> <span class="o">=</span> <span class="n">conf</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">Service</span><span class="p">,</span> <span class="s2">&#34;StartLimitIntervalSec&#34;</span><span class="p">,</span> <span class="n">strE</span><span class="p">(</span><span class="n">defaults</span><span class="p">))</span> <span class="c1"># 10s</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="n">time_to_seconds</span><span class="p">(</span><span class="n">interval</span><span class="p">,</span> <span class="n">maximum</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="k">def</span> <span class="nf">get_RestartSec</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">conf</span><span class="p">,</span> <span class="n">maximum</span> <span class="o">=</span> <span class="kc">None</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">        <span class="n">maximum</span> <span class="o">=</span> <span class="n">maximum</span> <span class="ow">or</span> <span class="n">DefaultMaximumTimeout</span>
</span></span><span class="line"><span class="cl">        <span class="n">delay</span> <span class="o">=</span> <span class="n">conf</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">Service</span><span class="p">,</span> <span class="s2">&#34;RestartSec&#34;</span><span class="p">,</span> <span class="n">strE</span><span class="p">(</span><span class="n">DefaultRestartSec</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="n">time_to_seconds</span><span class="p">(</span><span class="n">delay</span><span class="p">,</span> <span class="n">maximum</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="k">def</span> <span class="nf">restart_failed_units</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">units</span><span class="p">,</span> <span class="n">maximum</span> <span class="o">=</span> <span class="kc">None</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">        <span class="s2">&#34;&#34;&#34; This function will restart failed units.
</span></span></span><span class="line"><span class="cl"><span class="s2">        /
</span></span></span><span class="line"><span class="cl"><span class="s2">        NOTE that with standard settings the LimitBurst implementation has no effect. If
</span></span></span><span class="line"><span class="cl"><span class="s2">        the InitLoopSleep is ticking at the Default of 5sec and the LimitBurst Default
</span></span></span><span class="line"><span class="cl"><span class="s2">        is 5x within a Default 10secs time frame then within those 10sec only 2 loop
</span></span></span><span class="line"><span class="cl"><span class="s2">        rounds have come here checking for possible restarts. You can directly shorten
</span></span></span><span class="line"><span class="cl"><span class="s2">        the interval (&#39;-c InitLoopSleep=1&#39;) or have it indirectly shorter from the
</span></span></span><span class="line"><span class="cl"><span class="s2">        service descriptor&#39;s RestartSec (&#34;RestartSec=2s&#34;).
</span></span></span><span class="line"><span class="cl"><span class="s2">        &#34;&#34;&#34;</span>
</span></span><span class="line"><span class="cl">        <span class="k">global</span> <span class="n">InitLoopSleep</span>
</span></span><span class="line"><span class="cl">        <span class="n">me</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">getpid</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">        <span class="n">maximum</span> <span class="o">=</span> <span class="n">maximum</span> <span class="ow">or</span> <span class="n">DefaultStartLimitIntervalSec</span>
</span></span><span class="line"><span class="cl">        <span class="n">restartDelay</span> <span class="o">=</span> <span class="n">MinimumYield</span>
</span></span><span class="line"><span class="cl">        <span class="k">for</span> <span class="n">unit</span> <span class="ow">in</span> <span class="n">units</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">            <span class="n">now</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">            <span class="k">try</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">                <span class="n">conf</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">load_unit_conf</span><span class="p">(</span><span class="n">unit</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">                <span class="k">if</span> <span class="ow">not</span> <span class="n">conf</span><span class="p">:</span> <span class="k">continue</span>
</span></span><span class="line"><span class="cl">                <span class="n">restartPolicy</span> <span class="o">=</span> <span class="n">conf</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">Service</span><span class="p">,</span> <span class="s2">&#34;Restart&#34;</span><span class="p">,</span> <span class="s2">&#34;no&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">                <span class="k">if</span> <span class="n">restartPolicy</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&#34;no&#34;</span><span class="p">,</span> <span class="s2">&#34;on-success&#34;</span><span class="p">]:</span>
</span></span><span class="line"><span class="cl">                    <span class="n">logg</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&#34;[</span><span class="si">%s</span><span class="s2">] [</span><span class="si">%s</span><span class="s2">] Current NoCheck (Restart=</span><span class="si">%s</span><span class="s2">)&#34;</span><span class="p">,</span> <span class="n">me</span><span class="p">,</span> <span class="n">unit</span><span class="p">,</span> <span class="n">restartPolicy</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">                    <span class="k">continue</span>
</span></span><span class="line"><span class="cl">                <span class="n">restartSec</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_RestartSec</span><span class="p">(</span><span class="n">conf</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">                <span class="k">if</span> <span class="n">restartSec</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">                    <span class="k">if</span> <span class="n">InitLoopSleep</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">                        <span class="n">logg</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&#34;[</span><span class="si">%s</span><span class="s2">] set InitLoopSleep from </span><span class="si">%s</span><span class="s2">s to 1 (caused by RestartSec=0!)&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                                     <span class="n">unit</span><span class="p">,</span> <span class="n">InitLoopSleep</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">                        <span class="n">InitLoopSleep</span> <span class="o">=</span> <span class="mi">1</span>
</span></span><span class="line"><span class="cl">                <span class="k">elif</span> <span class="n">restartSec</span> <span class="o">&gt;</span> <span class="mf">0.9</span> <span class="ow">and</span> <span class="n">restartSec</span> <span class="o">&lt;</span> <span class="n">InitLoopSleep</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">                    <span class="n">restartSleep</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">restartSec</span> <span class="o">+</span> <span class="mf">0.2</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">                    <span class="k">if</span> <span class="n">restartSleep</span> <span class="o">&lt;</span> <span class="n">InitLoopSleep</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">                        <span class="n">logg</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&#34;[</span><span class="si">%s</span><span class="s2">] set InitLoopSleep from </span><span class="si">%s</span><span class="s2">s to </span><span class="si">%s</span><span class="s2"> (caused by RestartSec=</span><span class="si">%.3f</span><span class="s2">s)&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                                     <span class="n">unit</span><span class="p">,</span> <span class="n">InitLoopSleep</span><span class="p">,</span> <span class="n">restartSleep</span><span class="p">,</span> <span class="n">restartSec</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">                        <span class="n">InitLoopSleep</span> <span class="o">=</span> <span class="n">restartSleep</span>
</span></span><span class="line"><span class="cl">                <span class="n">isUnitState</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_active_from</span><span class="p">(</span><span class="n">conf</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">                <span class="n">isUnitFailed</span> <span class="o">=</span> <span class="n">isUnitState</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&#34;failed&#34;</span><span class="p">]</span>
</span></span><span class="line"><span class="cl">                <span class="n">logg</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&#34;[</span><span class="si">%s</span><span class="s2">] [</span><span class="si">%s</span><span class="s2">] Current Status: </span><span class="si">%s</span><span class="s2"> (</span><span class="si">%s</span><span class="s2">)&#34;</span><span class="p">,</span> <span class="n">me</span><span class="p">,</span> <span class="n">unit</span><span class="p">,</span> <span class="n">isUnitState</span><span class="p">,</span> <span class="n">isUnitFailed</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">                <span class="k">if</span> <span class="ow">not</span> <span class="n">isUnitFailed</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">                    <span class="k">if</span> <span class="n">unit</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_restart_failed_units</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">                        <span class="k">del</span> <span class="bp">self</span><span class="o">.</span><span class="n">_restart_failed_units</span><span class="p">[</span><span class="n">unit</span><span class="p">]</span>
</span></span><span class="line"><span class="cl">                    <span class="k">continue</span>
</span></span><span class="line"><span class="cl">                <span class="n">limitBurst</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_StartLimitBurst</span><span class="p">(</span><span class="n">conf</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">                <span class="n">limitSecs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_StartLimitIntervalSec</span><span class="p">(</span><span class="n">conf</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">                <span class="k">if</span> <span class="n">limitBurst</span> <span class="o">&gt;</span> <span class="mi">1</span> <span class="ow">and</span> <span class="n">limitSecs</span> <span class="o">&gt;=</span> <span class="mi">1</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">                    <span class="k">try</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">                        <span class="k">if</span> <span class="n">unit</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_restarted_unit</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">                            <span class="bp">self</span><span class="o">.</span><span class="n">_restarted_unit</span><span class="p">[</span><span class="n">unit</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
</span></span><span class="line"><span class="cl">                            <span class="c1"># we want to register restarts from now on</span>
</span></span><span class="line"><span class="cl">                        <span class="n">restarted</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_restarted_unit</span><span class="p">[</span><span class="n">unit</span><span class="p">]</span>
</span></span><span class="line"><span class="cl">                        <span class="n">logg</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&#34;[</span><span class="si">%s</span><span class="s2">] [</span><span class="si">%s</span><span class="s2">] Current limitSecs=</span><span class="si">%s</span><span class="s2">s limitBurst=</span><span class="si">%s</span><span class="s2">x (restarted </span><span class="si">%s</span><span class="s2">x)&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                                   <span class="n">me</span><span class="p">,</span> <span class="n">unit</span><span class="p">,</span> <span class="n">limitSecs</span><span class="p">,</span> <span class="n">limitBurst</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">restarted</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">                        <span class="n">oldest</span> <span class="o">=</span> <span class="mf">0.</span>
</span></span><span class="line"><span class="cl">                        <span class="n">interval</span> <span class="o">=</span> <span class="mf">0.</span>
</span></span><span class="line"><span class="cl">                        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">restarted</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="n">limitBurst</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">                            <span class="n">logg</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&#34;[</span><span class="si">%s</span><span class="s2">] [</span><span class="si">%s</span><span class="s2">] restarted </span><span class="si">%s</span><span class="s2">&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                                       <span class="n">me</span><span class="p">,</span> <span class="n">unit</span><span class="p">,</span> <span class="p">[</span><span class="s2">&#34;</span><span class="si">%.3f</span><span class="s2">s&#34;</span> <span class="o">%</span> <span class="p">(</span><span class="n">t</span> <span class="o">-</span> <span class="n">now</span><span class="p">)</span> <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">restarted</span><span class="p">])</span>
</span></span><span class="line"><span class="cl">                            <span class="k">while</span> <span class="nb">len</span><span class="p">(</span><span class="n">restarted</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">                                <span class="n">oldest</span> <span class="o">=</span> <span class="n">restarted</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
</span></span><span class="line"><span class="cl">                                <span class="n">interval</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span> <span class="o">-</span> <span class="n">oldest</span>
</span></span><span class="line"><span class="cl">                                <span class="k">if</span> <span class="n">interval</span> <span class="o">&gt;</span> <span class="n">limitSecs</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">                                    <span class="n">restarted</span> <span class="o">=</span> <span class="n">restarted</span><span class="p">[</span><span class="mi">1</span><span class="p">:]</span>
</span></span><span class="line"><span class="cl">                                    <span class="k">continue</span>
</span></span><span class="line"><span class="cl">                                <span class="k">break</span>
</span></span><span class="line"><span class="cl">                            <span class="bp">self</span><span class="o">.</span><span class="n">_restarted_unit</span><span class="p">[</span><span class="n">unit</span><span class="p">]</span> <span class="o">=</span> <span class="n">restarted</span>
</span></span><span class="line"><span class="cl">                            <span class="n">logg</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&#34;[</span><span class="si">%s</span><span class="s2">] [</span><span class="si">%s</span><span class="s2">] ratelimit </span><span class="si">%s</span><span class="s2">&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                                       <span class="n">me</span><span class="p">,</span> <span class="n">unit</span><span class="p">,</span> <span class="p">[</span><span class="s2">&#34;</span><span class="si">%.3f</span><span class="s2">s&#34;</span> <span class="o">%</span> <span class="p">(</span><span class="n">t</span> <span class="o">-</span> <span class="n">now</span><span class="p">)</span> <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">restarted</span><span class="p">])</span>
</span></span><span class="line"><span class="cl">                            <span class="c1"># all values in restarted have a time below limitSecs</span>
</span></span><span class="line"><span class="cl">                        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">restarted</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="n">limitBurst</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">                            <span class="n">logg</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&#34;[</span><span class="si">%s</span><span class="s2">] [</span><span class="si">%s</span><span class="s2">] Blocking Restart - oldest </span><span class="si">%s</span><span class="s2"> is </span><span class="si">%s</span><span class="s2"> ago (allowed </span><span class="si">%s</span><span class="s2">)&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                                      <span class="n">me</span><span class="p">,</span> <span class="n">unit</span><span class="p">,</span> <span class="n">oldest</span><span class="p">,</span> <span class="n">interval</span><span class="p">,</span> <span class="n">limitSecs</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">                            <span class="bp">self</span><span class="o">.</span><span class="n">write_status_from</span><span class="p">(</span><span class="n">conf</span><span class="p">,</span> <span class="n">AS</span><span class="o">=</span><span class="s2">&#34;error&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">                            <span class="n">unit</span> <span class="o">=</span> <span class="s2">&#34;&#34;</span> <span class="c1"># dropped out</span>
</span></span><span class="line"><span class="cl">                            <span class="k">continue</span>
</span></span><span class="line"><span class="cl">                    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">                        <span class="n">logg</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&#34;[</span><span class="si">%s</span><span class="s2">] burst exception </span><span class="si">%s</span><span class="s2">&#34;</span><span class="p">,</span> <span class="n">unit</span><span class="p">,</span> <span class="n">e</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">                <span class="k">if</span> <span class="n">unit</span><span class="p">:</span> <span class="c1"># not dropped out</span>
</span></span><span class="line"><span class="cl">                    <span class="k">if</span> <span class="n">unit</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_restart_failed_units</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">                        <span class="bp">self</span><span class="o">.</span><span class="n">_restart_failed_units</span><span class="p">[</span><span class="n">unit</span><span class="p">]</span> <span class="o">=</span> <span class="n">now</span> <span class="o">+</span> <span class="n">restartSec</span>
</span></span><span class="line"><span class="cl">                        <span class="n">logg</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&#34;[</span><span class="si">%s</span><span class="s2">] [</span><span class="si">%s</span><span class="s2">] restart scheduled in </span><span class="si">%+.3f</span><span class="s2">s&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                                   <span class="n">me</span><span class="p">,</span> <span class="n">unit</span><span class="p">,</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_restart_failed_units</span><span class="p">[</span><span class="n">unit</span><span class="p">]</span> <span class="o">-</span> <span class="n">now</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">            <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">                <span class="n">logg</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&#34;[</span><span class="si">%s</span><span class="s2">] [</span><span class="si">%s</span><span class="s2">] An error occurred while restart checking: </span><span class="si">%s</span><span class="s2">&#34;</span><span class="p">,</span> <span class="n">me</span><span class="p">,</span> <span class="n">unit</span><span class="p">,</span> <span class="n">e</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_restart_failed_units</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">            <span class="bp">self</span><span class="o">.</span><span class="n">error</span> <span class="o">|=</span> <span class="n">NOT_OK</span>
</span></span><span class="line"><span class="cl">            <span class="k">return</span> <span class="p">[]</span>
</span></span><span class="line"><span class="cl">        <span class="c1"># NOTE: this function is only called from InitLoop when &#34;running&#34;</span>
</span></span><span class="line"><span class="cl">        <span class="c1"># let&#39;s check if any of the restart_units has its restartSec expired</span>
</span></span><span class="line"><span class="cl">        <span class="n">now</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">        <span class="n">restart_done</span> <span class="o">=</span> <span class="p">[]</span>
</span></span><span class="line"><span class="cl">        <span class="n">logg</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&#34;[</span><span class="si">%s</span><span class="s2">] Restart checking  </span><span class="si">%s</span><span class="s2">&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                   <span class="n">me</span><span class="p">,</span> <span class="p">[</span><span class="s2">&#34;</span><span class="si">%+.3f</span><span class="s2">s&#34;</span> <span class="o">%</span> <span class="p">(</span><span class="n">t</span> <span class="o">-</span> <span class="n">now</span><span class="p">)</span> <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_restart_failed_units</span><span class="o">.</span><span class="n">values</span><span class="p">()])</span>
</span></span><span class="line"><span class="cl">        <span class="k">for</span> <span class="n">unit</span> <span class="ow">in</span> <span class="nb">sorted</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_restart_failed_units</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">            <span class="n">restartAt</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_restart_failed_units</span><span class="p">[</span><span class="n">unit</span><span class="p">]</span>
</span></span><span class="line"><span class="cl">            <span class="k">if</span> <span class="n">restartAt</span> <span class="o">&gt;</span> <span class="n">now</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">                <span class="k">continue</span>
</span></span><span class="line"><span class="cl">            <span class="n">restart_done</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">unit</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">            <span class="k">try</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">                <span class="n">conf</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">load_unit_conf</span><span class="p">(</span><span class="n">unit</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">                <span class="k">if</span> <span class="ow">not</span> <span class="n">conf</span><span class="p">:</span> <span class="k">continue</span>
</span></span><span class="line"><span class="cl">                <span class="n">isUnitState</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_active_from</span><span class="p">(</span><span class="n">conf</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">                <span class="n">isUnitFailed</span> <span class="o">=</span> <span class="n">isUnitState</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&#34;failed&#34;</span><span class="p">]</span>
</span></span><span class="line"><span class="cl">                <span class="n">logg</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&#34;[</span><span class="si">%s</span><span class="s2">] [</span><span class="si">%s</span><span class="s2">] Restart Status: </span><span class="si">%s</span><span class="s2"> (</span><span class="si">%s</span><span class="s2">)&#34;</span><span class="p">,</span> <span class="n">me</span><span class="p">,</span> <span class="n">unit</span><span class="p">,</span> <span class="n">isUnitState</span><span class="p">,</span> <span class="n">isUnitFailed</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">                <span class="k">if</span> <span class="n">isUnitFailed</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">                    <span class="n">logg</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&#34;[</span><span class="si">%s</span><span class="s2">] [</span><span class="si">%s</span><span class="s2">] --- restarting failed unit...&#34;</span><span class="p">,</span> <span class="n">me</span><span class="p">,</span> <span class="n">unit</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">                    <span class="bp">self</span><span class="o">.</span><span class="n">restart_unit</span><span class="p">(</span><span class="n">unit</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">                    <span class="n">logg</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&#34;[</span><span class="si">%s</span><span class="s2">] [</span><span class="si">%s</span><span class="s2">] --- has been restarted.&#34;</span><span class="p">,</span> <span class="n">me</span><span class="p">,</span> <span class="n">unit</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">                    <span class="k">if</span> <span class="n">unit</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_restarted_unit</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">                        <span class="bp">self</span><span class="o">.</span><span class="n">_restarted_unit</span><span class="p">[</span><span class="n">unit</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">())</span>
</span></span><span class="line"><span class="cl">            <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">                <span class="n">logg</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&#34;[</span><span class="si">%s</span><span class="s2">] [</span><span class="si">%s</span><span class="s2">] An error occurred while restarting: </span><span class="si">%s</span><span class="s2">&#34;</span><span class="p">,</span> <span class="n">me</span><span class="p">,</span> <span class="n">unit</span><span class="p">,</span> <span class="n">e</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="k">for</span> <span class="n">unit</span> <span class="ow">in</span> <span class="n">restart_done</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">            <span class="k">if</span> <span class="n">unit</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_restart_failed_units</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">                <span class="k">del</span> <span class="bp">self</span><span class="o">.</span><span class="n">_restart_failed_units</span><span class="p">[</span><span class="n">unit</span><span class="p">]</span>
</span></span><span class="line"><span class="cl">        <span class="n">logg</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&#34;[</span><span class="si">%s</span><span class="s2">] Restart remaining </span><span class="si">%s</span><span class="s2">&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                   <span class="n">me</span><span class="p">,</span> <span class="p">[</span><span class="s2">&#34;</span><span class="si">%+.3f</span><span class="s2">s&#34;</span> <span class="o">%</span> <span class="p">(</span><span class="n">t</span> <span class="o">-</span> <span class="n">now</span><span class="p">)</span> <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_restart_failed_units</span><span class="o">.</span><span class="n">values</span><span class="p">()])</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="n">restart_done</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">def</span> <span class="nf">init_loop_until_stop</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">units</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">        <span class="s2">&#34;&#34;&#34; this is the init-loop - it checks for any zombies to be reaped and
</span></span></span><span class="line"><span class="cl"><span class="s2">            waits for an interrupt. When a SIGTERM /SIGINT /Control-C signal
</span></span></span><span class="line"><span class="cl"><span class="s2">            is received then the signal name is returned. Any other signal will
</span></span></span><span class="line"><span class="cl"><span class="s2">            just raise an Exception like one would normally expect. As a special
</span></span></span><span class="line"><span class="cl"><span class="s2">            the &#39;systemctl halt&#39; emits SIGQUIT which puts it into no_more_procs mode.&#34;&#34;&#34;</span>
</span></span><span class="line"><span class="cl">        <span class="n">signal</span><span class="o">.</span><span class="n">signal</span><span class="p">(</span><span class="n">signal</span><span class="o">.</span><span class="n">SIGQUIT</span><span class="p">,</span> <span class="k">lambda</span> <span class="n">signum</span><span class="p">,</span> <span class="n">frame</span><span class="p">:</span> <span class="n">ignore_signals_and_raise_keyboard_interrupt</span><span class="p">(</span><span class="s2">&#34;SIGQUIT&#34;</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">        <span class="n">signal</span><span class="o">.</span><span class="n">signal</span><span class="p">(</span><span class="n">signal</span><span class="o">.</span><span class="n">SIGINT</span><span class="p">,</span> <span class="k">lambda</span> <span class="n">signum</span><span class="p">,</span> <span class="n">frame</span><span class="p">:</span> <span class="n">ignore_signals_and_raise_keyboard_interrupt</span><span class="p">(</span><span class="s2">&#34;SIGINT&#34;</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">        <span class="n">signal</span><span class="o">.</span><span class="n">signal</span><span class="p">(</span><span class="n">signal</span><span class="o">.</span><span class="n">SIGTERM</span><span class="p">,</span> <span class="k">lambda</span> <span class="n">signum</span><span class="p">,</span> <span class="n">frame</span><span class="p">:</span> <span class="n">ignore_signals_and_raise_keyboard_interrupt</span><span class="p">(</span><span class="s2">&#34;SIGTERM&#34;</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">        <span class="n">result</span> <span class="o">=</span> <span class="kc">None</span>
</span></span><span class="line"><span class="cl">        <span class="c1">#</span>
</span></span><span class="line"><span class="cl">        <span class="bp">self</span><span class="o">.</span><span class="n">start_log_files</span><span class="p">(</span><span class="n">units</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="n">logg</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&#34;start listen&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="n">listen</span> <span class="o">=</span> <span class="n">SystemctlListenThread</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="n">logg</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&#34;starts listen&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="n">listen</span><span class="o">.</span><span class="n">start</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">        <span class="n">logg</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&#34;started listen&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="bp">self</span><span class="o">.</span><span class="n">sysinit_status</span><span class="p">(</span><span class="n">ActiveState</span> <span class="o">=</span> <span class="s2">&#34;active&#34;</span><span class="p">,</span> <span class="n">SubState</span> <span class="o">=</span> <span class="s2">&#34;running&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="n">timestamp</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">        <span class="k">while</span> <span class="kc">True</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">            <span class="k">try</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">                <span class="k">if</span> <span class="n">DEBUG_INITLOOP</span><span class="p">:</span> <span class="c1"># pragma: no cover</span>
</span></span><span class="line"><span class="cl">                    <span class="n">logg</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&#34;DONE InitLoop (sleep </span><span class="si">%s</span><span class="s2">s)&#34;</span><span class="p">,</span> <span class="n">InitLoopSleep</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">                <span class="n">sleep_sec</span> <span class="o">=</span> <span class="n">InitLoopSleep</span> <span class="o">-</span> <span class="p">(</span><span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span> <span class="o">-</span> <span class="n">timestamp</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">                <span class="k">if</span> <span class="n">sleep_sec</span> <span class="o">&lt;</span> <span class="n">MinimumYield</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">                    <span class="n">sleep_sec</span> <span class="o">=</span> <span class="n">MinimumYield</span>
</span></span><span class="line"><span class="cl">                <span class="n">sleeping</span> <span class="o">=</span> <span class="n">sleep_sec</span>
</span></span><span class="line"><span class="cl">                <span class="k">while</span> <span class="n">sleeping</span> <span class="o">&gt;</span> <span class="mi">2</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">                    <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="c1"># accept signals atleast every second</span>
</span></span><span class="line"><span class="cl">                    <span class="n">sleeping</span> <span class="o">=</span> <span class="n">InitLoopSleep</span> <span class="o">-</span> <span class="p">(</span><span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span> <span class="o">-</span> <span class="n">timestamp</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">                    <span class="k">if</span> <span class="n">sleeping</span> <span class="o">&lt;</span> <span class="n">MinimumYield</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">                        <span class="n">sleeping</span> <span class="o">=</span> <span class="n">MinimumYield</span>
</span></span><span class="line"><span class="cl">                        <span class="k">break</span>
</span></span><span class="line"><span class="cl">                <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="n">sleeping</span><span class="p">)</span> <span class="c1"># remainder waits less that 2 seconds</span>
</span></span><span class="line"><span class="cl">                <span class="n">timestamp</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">                <span class="bp">self</span><span class="o">.</span><span class="n">loop</span><span class="o">.</span><span class="n">acquire</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">                <span class="k">if</span> <span class="n">DEBUG_INITLOOP</span><span class="p">:</span> <span class="c1"># pragma: no cover</span>
</span></span><span class="line"><span class="cl">                    <span class="n">logg</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&#34;NEXT InitLoop (after </span><span class="si">%s</span><span class="s2">s)&#34;</span><span class="p">,</span> <span class="n">sleep_sec</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">                <span class="bp">self</span><span class="o">.</span><span class="n">read_log_files</span><span class="p">(</span><span class="n">units</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">                <span class="k">if</span> <span class="n">DEBUG_INITLOOP</span><span class="p">:</span> <span class="c1"># pragma: no cover</span>
</span></span><span class="line"><span class="cl">                    <span class="n">logg</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&#34;reap zombies - check current processes&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">                <span class="n">running</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">reap_zombies</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">                <span class="k">if</span> <span class="n">DEBUG_INITLOOP</span><span class="p">:</span> <span class="c1"># pragma: no cover</span>
</span></span><span class="line"><span class="cl">                    <span class="n">logg</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&#34;reap zombies - init-loop found </span><span class="si">%s</span><span class="s2"> running procs&#34;</span><span class="p">,</span> <span class="n">running</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">doExitWhenNoMoreServices</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">                    <span class="n">active</span> <span class="o">=</span> <span class="kc">False</span>
</span></span><span class="line"><span class="cl">                    <span class="k">for</span> <span class="n">unit</span> <span class="ow">in</span> <span class="n">units</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">                        <span class="n">conf</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">load_unit_conf</span><span class="p">(</span><span class="n">unit</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">                        <span class="k">if</span> <span class="ow">not</span> <span class="n">conf</span><span class="p">:</span> <span class="k">continue</span>
</span></span><span class="line"><span class="cl">                        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">is_active_from</span><span class="p">(</span><span class="n">conf</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">                            <span class="n">active</span> <span class="o">=</span> <span class="kc">True</span>
</span></span><span class="line"><span class="cl">                    <span class="k">if</span> <span class="ow">not</span> <span class="n">active</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">                        <span class="n">logg</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&#34;no more services - exit init-loop&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">                        <span class="k">break</span>
</span></span><span class="line"><span class="cl">                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">doExitWhenNoMoreProcs</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">                    <span class="k">if</span> <span class="ow">not</span> <span class="n">running</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">                        <span class="n">logg</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&#34;no more procs - exit init-loop&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">                        <span class="k">break</span>
</span></span><span class="line"><span class="cl">                <span class="k">if</span> <span class="n">RESTART_FAILED_UNITS</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">                    <span class="bp">self</span><span class="o">.</span><span class="n">restart_failed_units</span><span class="p">(</span><span class="n">units</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">                <span class="bp">self</span><span class="o">.</span><span class="n">loop</span><span class="o">.</span><span class="n">release</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">            <span class="k">except</span> <span class="ne">KeyboardInterrupt</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">                <span class="k">if</span> <span class="n">e</span><span class="o">.</span><span class="n">args</span> <span class="ow">and</span> <span class="n">e</span><span class="o">.</span><span class="n">args</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&#34;SIGQUIT&#34;</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">                    <span class="c1"># the original systemd puts a coredump on that signal.</span>
</span></span><span class="line"><span class="cl">                    <span class="n">logg</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&#34;SIGQUIT - switch to no more procs check&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">                    <span class="bp">self</span><span class="o">.</span><span class="n">doExitWhenNoMoreProcs</span> <span class="o">=</span> <span class="kc">True</span>
</span></span><span class="line"><span class="cl">                    <span class="k">continue</span>
</span></span><span class="line"><span class="cl">                <span class="n">signal</span><span class="o">.</span><span class="n">signal</span><span class="p">(</span><span class="n">signal</span><span class="o">.</span><span class="n">SIGTERM</span><span class="p">,</span> <span class="n">signal</span><span class="o">.</span><span class="n">SIG_DFL</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">                <span class="n">signal</span><span class="o">.</span><span class="n">signal</span><span class="p">(</span><span class="n">signal</span><span class="o">.</span><span class="n">SIGINT</span><span class="p">,</span> <span class="n">signal</span><span class="o">.</span><span class="n">SIG_DFL</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">                <span class="n">logg</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&#34;interrupted - exit init-loop&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">                <span class="n">result</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">)</span> <span class="ow">or</span> <span class="s2">&#34;STOPPED&#34;</span>
</span></span><span class="line"><span class="cl">                <span class="k">break</span>
</span></span><span class="line"><span class="cl">            <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">                <span class="n">logg</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&#34;interrupted - exception </span><span class="si">%s</span><span class="s2">&#34;</span><span class="p">,</span> <span class="n">e</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">                <span class="k">raise</span>
</span></span><span class="line"><span class="cl">        <span class="bp">self</span><span class="o">.</span><span class="n">sysinit_status</span><span class="p">(</span><span class="n">ActiveState</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">SubState</span> <span class="o">=</span> <span class="s2">&#34;degraded&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="k">try</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">loop</span><span class="o">.</span><span class="n">release</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">        <span class="k">except</span><span class="p">:</span> <span class="k">pass</span>
</span></span><span class="line"><span class="cl">        <span class="n">listen</span><span class="o">.</span><span class="n">stop</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">        <span class="n">listen</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="bp">self</span><span class="o">.</span><span class="n">read_log_files</span><span class="p">(</span><span class="n">units</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="bp">self</span><span class="o">.</span><span class="n">read_log_files</span><span class="p">(</span><span class="n">units</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="bp">self</span><span class="o">.</span><span class="n">stop_log_files</span><span class="p">(</span><span class="n">units</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="n">logg</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&#34;done - init loop&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="n">result</span>
</span></span><span class="line"><span class="cl">    <span class="k">def</span> <span class="nf">reap_zombies_target</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">        <span class="s2">&#34;&#34;&#34; -- check to reap children (internal) &#34;&#34;&#34;</span>
</span></span><span class="line"><span class="cl">        <span class="n">running</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">reap_zombies</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="s2">&#34;remaining </span><span class="si">{running}</span><span class="s2"> process&#34;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="o">**</span><span class="nb">locals</span><span class="p">())</span>
</span></span><span class="line"><span class="cl">    <span class="k">def</span> <span class="nf">reap_zombies</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">        <span class="s2">&#34;&#34;&#34; check to reap children &#34;&#34;&#34;</span>
</span></span><span class="line"><span class="cl">        <span class="n">selfpid</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">getpid</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">        <span class="n">running</span> <span class="o">=</span> <span class="mi">0</span>
</span></span><span class="line"><span class="cl">        <span class="k">for</span> <span class="n">pid_entry</span> <span class="ow">in</span> <span class="n">os</span><span class="o">.</span><span class="n">listdir</span><span class="p">(</span><span class="n">_proc_pid_dir</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">            <span class="n">pid</span> <span class="o">=</span> <span class="n">to_intN</span><span class="p">(</span><span class="n">pid_entry</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">            <span class="k">if</span> <span class="n">pid</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">                <span class="k">continue</span>
</span></span><span class="line"><span class="cl">            <span class="k">if</span> <span class="n">pid</span> <span class="o">==</span> <span class="n">selfpid</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">                <span class="k">continue</span>
</span></span><span class="line"><span class="cl">            <span class="n">proc_status</span> <span class="o">=</span> <span class="n">_proc_pid_status</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="o">**</span><span class="nb">locals</span><span class="p">())</span>
</span></span><span class="line"><span class="cl">            <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isfile</span><span class="p">(</span><span class="n">proc_status</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">                <span class="n">zombie</span> <span class="o">=</span> <span class="kc">False</span>
</span></span><span class="line"><span class="cl">                <span class="n">ppid</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span>
</span></span><span class="line"><span class="cl">                <span class="k">try</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">                    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">proc_status</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">                        <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">f</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">                            <span class="n">m</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="k">match</span><span class="p">(</span><span class="sa">r</span><span class="s2">&#34;State:\s*Z.*&#34;</span><span class="p">,</span> <span class="n">line</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">                            <span class="k">if</span> <span class="n">m</span><span class="p">:</span> <span class="n">zombie</span> <span class="o">=</span> <span class="kc">True</span>
</span></span><span class="line"><span class="cl">                            <span class="n">m</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="k">match</span><span class="p">(</span><span class="sa">r</span><span class="s2">&#34;PPid:\s*(\d+)&#34;</span><span class="p">,</span> <span class="n">line</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">                            <span class="k">if</span> <span class="n">m</span><span class="p">:</span> <span class="n">ppid</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">m</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">1</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">                <span class="k">except</span> <span class="ne">IOError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">                    <span class="n">logg</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&#34;</span><span class="si">%s</span><span class="s2"> : </span><span class="si">%s</span><span class="s2">&#34;</span><span class="p">,</span> <span class="n">proc_status</span><span class="p">,</span> <span class="n">e</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">                    <span class="k">continue</span>
</span></span><span class="line"><span class="cl">                <span class="k">if</span> <span class="n">zombie</span> <span class="ow">and</span> <span class="n">ppid</span> <span class="o">==</span> <span class="n">os</span><span class="o">.</span><span class="n">getpid</span><span class="p">():</span>
</span></span><span class="line"><span class="cl">                    <span class="n">logg</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&#34;reap zombie </span><span class="si">%s</span><span class="s2">&#34;</span><span class="p">,</span> <span class="n">pid</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">                    <span class="k">try</span><span class="p">:</span> <span class="n">os</span><span class="o">.</span><span class="n">waitpid</span><span class="p">(</span><span class="n">pid</span><span class="p">,</span> <span class="n">os</span><span class="o">.</span><span class="n">WNOHANG</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">                    <span class="k">except</span> <span class="ne">OSError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">                        <span class="n">logg</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&#34;reap zombie </span><span class="si">%s</span><span class="s2">: </span><span class="si">%s</span><span class="s2">&#34;</span><span class="p">,</span> <span class="n">e</span><span class="o">.</span><span class="n">strerror</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">            <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isfile</span><span class="p">(</span><span class="n">proc_status</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">                <span class="k">if</span> <span class="n">pid</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">                    <span class="n">running</span> <span class="o">+=</span> <span class="mi">1</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="n">running</span> <span class="c1"># except PID 0 and PID 1</span>
</span></span><span class="line"><span class="cl">    <span class="k">def</span> <span class="nf">sysinit_status</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">**</span><span class="n">status</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">        <span class="n">conf</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">sysinit_target</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">        <span class="bp">self</span><span class="o">.</span><span class="n">write_status_from</span><span class="p">(</span><span class="n">conf</span><span class="p">,</span> <span class="o">**</span><span class="n">status</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="k">def</span> <span class="nf">sysinit_target</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_sysinit_target</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">            <span class="bp">self</span><span class="o">.</span><span class="n">_sysinit_target</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">default_unit_conf</span><span class="p">(</span><span class="n">SysInitTarget</span><span class="p">,</span> <span class="s2">&#34;System Initialization&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="k">assert</span> <span class="bp">self</span><span class="o">.</span><span class="n">_sysinit_target</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_sysinit_target</span>
</span></span><span class="line"><span class="cl">    <span class="k">def</span> <span class="nf">is_system_running</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">        <span class="n">conf</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">sysinit_target</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">is_running_unit_from</span><span class="p">(</span><span class="n">conf</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">            <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="n">MinimumYield</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">is_running_unit_from</span><span class="p">(</span><span class="n">conf</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">            <span class="k">return</span> <span class="s2">&#34;offline&#34;</span>
</span></span><span class="line"><span class="cl">        <span class="n">status</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">read_status_from</span><span class="p">(</span><span class="n">conf</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="n">status</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&#34;SubState&#34;</span><span class="p">,</span> <span class="s2">&#34;unknown&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="k">def</span> <span class="nf">is_system_running_info</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">        <span class="n">state</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">is_system_running</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="n">state</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&#34;running&#34;</span><span class="p">]:</span>
</span></span><span class="line"><span class="cl">            <span class="bp">self</span><span class="o">.</span><span class="n">error</span> <span class="o">|=</span> <span class="n">NOT_OK</span> <span class="c1"># 1</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_quiet</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">            <span class="k">return</span> <span class="kc">None</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="n">state</span>
</span></span><span class="line"><span class="cl">    <span class="k">def</span> <span class="nf">wait_system</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">target</span> <span class="o">=</span> <span class="kc">None</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">        <span class="n">target</span> <span class="o">=</span> <span class="n">target</span> <span class="ow">or</span> <span class="n">SysInitTarget</span>
</span></span><span class="line"><span class="cl">        <span class="k">for</span> <span class="n">attempt</span> <span class="ow">in</span> <span class="n">xrange</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">SysInitWait</span><span class="p">)):</span>
</span></span><span class="line"><span class="cl">            <span class="n">state</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">is_system_running</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">            <span class="k">if</span> <span class="s2">&#34;init&#34;</span> <span class="ow">in</span> <span class="n">state</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">                <span class="k">if</span> <span class="n">target</span> <span class="ow">in</span> <span class="p">[</span><span class="n">SysInitTarget</span><span class="p">,</span> <span class="s2">&#34;basic.target&#34;</span><span class="p">]:</span>
</span></span><span class="line"><span class="cl">                    <span class="n">logg</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&#34;system not initialized - wait </span><span class="si">%s</span><span class="s2">&#34;</span><span class="p">,</span> <span class="n">target</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">                    <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">                    <span class="k">continue</span>
</span></span><span class="line"><span class="cl">            <span class="k">if</span> <span class="s2">&#34;start&#34;</span> <span class="ow">in</span> <span class="n">state</span> <span class="ow">or</span> <span class="s2">&#34;stop&#34;</span> <span class="ow">in</span> <span class="n">state</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">                <span class="k">if</span> <span class="n">target</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&#34;basic.target&#34;</span><span class="p">]:</span>
</span></span><span class="line"><span class="cl">                    <span class="n">logg</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&#34;system not running - wait </span><span class="si">%s</span><span class="s2">&#34;</span><span class="p">,</span> <span class="n">target</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">                    <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">                    <span class="k">continue</span>
</span></span><span class="line"><span class="cl">            <span class="k">if</span> <span class="s2">&#34;running&#34;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">state</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">                <span class="n">logg</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&#34;system is </span><span class="si">%s</span><span class="s2">&#34;</span><span class="p">,</span> <span class="n">state</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">            <span class="k">break</span>
</span></span><span class="line"><span class="cl">    <span class="k">def</span> <span class="nf">is_running_unit_from</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">conf</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">        <span class="n">status_file</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_status_file_from</span><span class="p">(</span><span class="n">conf</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="n">pid_file</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">pid_file_from</span><span class="p">(</span><span class="n">conf</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">getsize</span><span class="p">(</span><span class="n">status_file</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">getsize</span><span class="p">(</span><span class="n">pid_file</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span>
</span></span><span class="line"><span class="cl">    <span class="k">def</span> <span class="nf">is_running_unit</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">unit</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">        <span class="n">conf</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_unit_conf</span><span class="p">(</span><span class="n">unit</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">is_running_unit_from</span><span class="p">(</span><span class="n">conf</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="k">def</span> <span class="nf">pidlist_of</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">pid</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="ow">not</span> <span class="n">pid</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">            <span class="k">return</span> <span class="p">[]</span>
</span></span><span class="line"><span class="cl">        <span class="n">pidlist</span> <span class="o">=</span> <span class="p">[</span><span class="n">pid</span><span class="p">]</span>
</span></span><span class="line"><span class="cl">        <span class="n">pids</span> <span class="o">=</span> <span class="p">[</span><span class="n">pid</span><span class="p">]</span>
</span></span><span class="line"><span class="cl">        <span class="k">for</span> <span class="n">depth</span> <span class="ow">in</span> <span class="n">xrange</span><span class="p">(</span><span class="n">PROC_MAX_DEPTH</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">            <span class="k">for</span> <span class="n">pid_entry</span> <span class="ow">in</span> <span class="n">os</span><span class="o">.</span><span class="n">listdir</span><span class="p">(</span><span class="n">_proc_pid_dir</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">                <span class="n">pid</span> <span class="o">=</span> <span class="n">to_intN</span><span class="p">(</span><span class="n">pid_entry</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">                <span class="k">if</span> <span class="n">pid</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">                    <span class="k">continue</span>
</span></span><span class="line"><span class="cl">                <span class="n">proc_status</span> <span class="o">=</span> <span class="n">_proc_pid_status</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="o">**</span><span class="nb">locals</span><span class="p">())</span>
</span></span><span class="line"><span class="cl">                <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isfile</span><span class="p">(</span><span class="n">proc_status</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">                    <span class="k">try</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">                        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">proc_status</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">                            <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">f</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">                                <span class="k">if</span> <span class="n">line</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s2">&#34;PPid:&#34;</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">                                    <span class="n">ppid_text</span> <span class="o">=</span> <span class="n">line</span><span class="p">[</span><span class="nb">len</span><span class="p">(</span><span class="s2">&#34;PPid:&#34;</span><span class="p">):]</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">                                    <span class="k">try</span><span class="p">:</span> <span class="n">ppid</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">ppid_text</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">                                    <span class="k">except</span><span class="p">:</span> <span class="k">continue</span>
</span></span><span class="line"><span class="cl">                                    <span class="k">if</span> <span class="n">ppid</span> <span class="ow">in</span> <span class="n">pidlist</span> <span class="ow">and</span> <span class="n">pid</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">pids</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">                                        <span class="n">pids</span> <span class="o">+=</span> <span class="p">[</span><span class="n">pid</span><span class="p">]</span>
</span></span><span class="line"><span class="cl">                    <span class="k">except</span> <span class="ne">IOError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">                        <span class="n">logg</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&#34;</span><span class="si">%s</span><span class="s2"> : </span><span class="si">%s</span><span class="s2">&#34;</span><span class="p">,</span> <span class="n">proc_status</span><span class="p">,</span> <span class="n">e</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">                        <span class="k">continue</span>
</span></span><span class="line"><span class="cl">            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">pids</span><span class="p">)</span> <span class="o">!=</span> <span class="nb">len</span><span class="p">(</span><span class="n">pidlist</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">                <span class="n">pidlist</span> <span class="o">=</span> <span class="n">pids</span><span class="p">[:]</span>
</span></span><span class="line"><span class="cl">                <span class="k">continue</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="n">pids</span>
</span></span><span class="line"><span class="cl">    <span class="k">def</span> <span class="nf">echo</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">targets</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">        <span class="n">line</span> <span class="o">=</span> <span class="s2">&#34; &#34;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="o">*</span><span class="n">targets</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="n">logg</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&#34; == echo == </span><span class="si">%s</span><span class="s2">&#34;</span><span class="p">,</span> <span class="n">line</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="n">line</span>
</span></span><span class="line"><span class="cl">    <span class="k">def</span> <span class="nf">killall</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">targets</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">        <span class="n">mapping</span> <span class="o">=</span> <span class="p">{}</span>
</span></span><span class="line"><span class="cl">        <span class="n">mapping</span><span class="p">[</span><span class="s2">&#34;:3&#34;</span><span class="p">]</span> <span class="o">=</span> <span class="n">signal</span><span class="o">.</span><span class="n">SIGQUIT</span>
</span></span><span class="line"><span class="cl">        <span class="n">mapping</span><span class="p">[</span><span class="s2">&#34;:QUIT&#34;</span><span class="p">]</span> <span class="o">=</span> <span class="n">signal</span><span class="o">.</span><span class="n">SIGQUIT</span>
</span></span><span class="line"><span class="cl">        <span class="n">mapping</span><span class="p">[</span><span class="s2">&#34;:6&#34;</span><span class="p">]</span> <span class="o">=</span> <span class="n">signal</span><span class="o">.</span><span class="n">SIGABRT</span>
</span></span><span class="line"><span class="cl">        <span class="n">mapping</span><span class="p">[</span><span class="s2">&#34;:ABRT&#34;</span><span class="p">]</span> <span class="o">=</span> <span class="n">signal</span><span class="o">.</span><span class="n">SIGABRT</span>
</span></span><span class="line"><span class="cl">        <span class="n">mapping</span><span class="p">[</span><span class="s2">&#34;:9&#34;</span><span class="p">]</span> <span class="o">=</span> <span class="n">signal</span><span class="o">.</span><span class="n">SIGKILL</span>
</span></span><span class="line"><span class="cl">        <span class="n">mapping</span><span class="p">[</span><span class="s2">&#34;:KILL&#34;</span><span class="p">]</span> <span class="o">=</span> <span class="n">signal</span><span class="o">.</span><span class="n">SIGKILL</span>
</span></span><span class="line"><span class="cl">        <span class="n">sig</span> <span class="o">=</span> <span class="n">signal</span><span class="o">.</span><span class="n">SIGTERM</span>
</span></span><span class="line"><span class="cl">        <span class="k">for</span> <span class="n">target</span> <span class="ow">in</span> <span class="n">targets</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">            <span class="k">if</span> <span class="n">target</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s2">&#34;:&#34;</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">                <span class="k">if</span> <span class="n">target</span> <span class="ow">in</span> <span class="n">mapping</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">                    <span class="n">sig</span> <span class="o">=</span> <span class="n">mapping</span><span class="p">[</span><span class="n">target</span><span class="p">]</span>
</span></span><span class="line"><span class="cl">                <span class="k">else</span><span class="p">:</span> <span class="c1"># pragma: no cover</span>
</span></span><span class="line"><span class="cl">                    <span class="n">logg</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&#34;unsupported </span><span class="si">%s</span><span class="s2">&#34;</span><span class="p">,</span> <span class="n">target</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">                <span class="k">continue</span>
</span></span><span class="line"><span class="cl">            <span class="k">for</span> <span class="n">pid_entry</span> <span class="ow">in</span> <span class="n">os</span><span class="o">.</span><span class="n">listdir</span><span class="p">(</span><span class="n">_proc_pid_dir</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">                <span class="n">pid</span> <span class="o">=</span> <span class="n">to_intN</span><span class="p">(</span><span class="n">pid_entry</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">                <span class="k">if</span> <span class="n">pid</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">                    <span class="k">try</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">                        <span class="n">cmdline</span> <span class="o">=</span> <span class="n">_proc_pid_cmdline</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="o">**</span><span class="nb">locals</span><span class="p">())</span>
</span></span><span class="line"><span class="cl">                        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">cmdline</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">                            <span class="n">cmd</span> <span class="o">=</span> <span class="n">f</span><span class="o">.</span><span class="n">read</span><span class="p">()</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&#34;</span><span class="se">\0</span><span class="s2">&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">                        <span class="k">if</span> <span class="n">DEBUG_KILLALL</span><span class="p">:</span> <span class="n">logg</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&#34;cmdline </span><span class="si">%s</span><span class="s2">&#34;</span><span class="p">,</span> <span class="n">cmd</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">                        <span class="n">found</span> <span class="o">=</span> <span class="kc">None</span>
</span></span><span class="line"><span class="cl">                        <span class="n">cmd_exe</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">basename</span><span class="p">(</span><span class="n">cmd</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
</span></span><span class="line"><span class="cl">                        <span class="k">if</span> <span class="n">DEBUG_KILLALL</span><span class="p">:</span> <span class="n">logg</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&#34;cmd.exe &#39;</span><span class="si">%s</span><span class="s2">&#39;&#34;</span><span class="p">,</span> <span class="n">cmd_exe</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">                        <span class="k">if</span> <span class="n">fnmatch</span><span class="o">.</span><span class="n">fnmatchcase</span><span class="p">(</span><span class="n">cmd_exe</span><span class="p">,</span> <span class="n">target</span><span class="p">):</span> <span class="n">found</span> <span class="o">=</span> <span class="s2">&#34;exe&#34;</span>
</span></span><span class="line"><span class="cl">                        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">cmd</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span> <span class="ow">and</span> <span class="n">cmd_exe</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s2">&#34;python&#34;</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">                            <span class="n">X</span> <span class="o">=</span> <span class="mi">1</span>
</span></span><span class="line"><span class="cl">                            <span class="k">while</span> <span class="n">cmd</span><span class="p">[</span><span class="n">X</span><span class="p">]</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s2">&#34;-&#34;</span><span class="p">):</span> <span class="n">X</span> <span class="o">+=</span> <span class="mi">1</span> <span class="c1"># atleast &#39;-u&#39; unbuffered</span>
</span></span><span class="line"><span class="cl">                            <span class="n">cmd_arg</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">basename</span><span class="p">(</span><span class="n">cmd</span><span class="p">[</span><span class="n">X</span><span class="p">])</span>
</span></span><span class="line"><span class="cl">                            <span class="k">if</span> <span class="n">DEBUG_KILLALL</span><span class="p">:</span> <span class="n">logg</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&#34;cmd.arg &#39;</span><span class="si">%s</span><span class="s2">&#39;&#34;</span><span class="p">,</span> <span class="n">cmd_arg</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">                            <span class="k">if</span> <span class="n">fnmatch</span><span class="o">.</span><span class="n">fnmatchcase</span><span class="p">(</span><span class="n">cmd_arg</span><span class="p">,</span> <span class="n">target</span><span class="p">):</span> <span class="n">found</span> <span class="o">=</span> <span class="s2">&#34;arg&#34;</span>
</span></span><span class="line"><span class="cl">                            <span class="k">if</span> <span class="n">cmd_exe</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s2">&#34;coverage&#34;</span><span class="p">)</span> <span class="ow">or</span> <span class="n">cmd_arg</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s2">&#34;coverage&#34;</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">                                <span class="n">x</span> <span class="o">=</span> <span class="n">cmd</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="s2">&#34;--&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">                                <span class="k">if</span> <span class="n">x</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="ow">and</span> <span class="n">x</span><span class="o">+</span><span class="mi">1</span> <span class="o">&lt;</span> <span class="nb">len</span><span class="p">(</span><span class="n">cmd</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">                                    <span class="n">cmd_run</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">basename</span><span class="p">(</span><span class="n">cmd</span><span class="p">[</span><span class="n">x</span><span class="o">+</span><span class="mi">1</span><span class="p">])</span>
</span></span><span class="line"><span class="cl">                                    <span class="k">if</span> <span class="n">DEBUG_KILLALL</span><span class="p">:</span> <span class="n">logg</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&#34;cmd.run &#39;</span><span class="si">%s</span><span class="s2">&#39;&#34;</span><span class="p">,</span> <span class="n">cmd_run</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">                                    <span class="k">if</span> <span class="n">fnmatch</span><span class="o">.</span><span class="n">fnmatchcase</span><span class="p">(</span><span class="n">cmd_run</span><span class="p">,</span> <span class="n">target</span><span class="p">):</span> <span class="n">found</span> <span class="o">=</span> <span class="s2">&#34;run&#34;</span>
</span></span><span class="line"><span class="cl">                        <span class="k">if</span> <span class="n">found</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">                            <span class="k">if</span> <span class="n">DEBUG_KILLALL</span><span class="p">:</span> <span class="n">logg</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&#34;</span><span class="si">%s</span><span class="s2"> found </span><span class="si">%s</span><span class="s2"> </span><span class="si">%s</span><span class="s2">&#34;</span><span class="p">,</span> <span class="n">found</span><span class="p">,</span> <span class="n">pid</span><span class="p">,</span> <span class="p">[</span><span class="n">c</span> <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">cmd</span><span class="p">])</span>
</span></span><span class="line"><span class="cl">                            <span class="k">if</span> <span class="n">pid</span> <span class="o">!=</span> <span class="n">os</span><span class="o">.</span><span class="n">getpid</span><span class="p">():</span>
</span></span><span class="line"><span class="cl">                                <span class="n">logg</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&#34; kill -</span><span class="si">%s</span><span class="s2"> </span><span class="si">%s</span><span class="s2"> # </span><span class="si">%s</span><span class="s2">&#34;</span><span class="p">,</span> <span class="n">sig</span><span class="p">,</span> <span class="n">pid</span><span class="p">,</span> <span class="n">target</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">                                <span class="n">os</span><span class="o">.</span><span class="n">kill</span><span class="p">(</span><span class="n">pid</span><span class="p">,</span> <span class="n">sig</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">                    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">                        <span class="n">logg</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&#34;kill -</span><span class="si">%s</span><span class="s2"> </span><span class="si">%s</span><span class="s2"> : </span><span class="si">%s</span><span class="s2">&#34;</span><span class="p">,</span> <span class="n">sig</span><span class="p">,</span> <span class="n">pid</span><span class="p">,</span> <span class="n">e</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="kc">True</span>
</span></span><span class="line"><span class="cl">    <span class="k">def</span> <span class="nf">force_ipv4</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">        <span class="s2">&#34;&#34;&#34; only ipv4 localhost in /etc/hosts &#34;&#34;&#34;</span>
</span></span><span class="line"><span class="cl">        <span class="n">logg</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&#34;checking hosts sysconf for &#39;::1 localhost&#39;&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="n">lines</span> <span class="o">=</span> <span class="p">[]</span>
</span></span><span class="line"><span class="cl">        <span class="n">sysconf_hosts</span> <span class="o">=</span> <span class="n">os_path</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_root</span><span class="p">,</span> <span class="n">_etc_hosts</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">sysconf_hosts</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">            <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">f</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">                <span class="k">if</span> <span class="s2">&#34;::1&#34;</span> <span class="ow">in</span> <span class="n">line</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">                    <span class="n">newline</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">sub</span><span class="p">(</span><span class="s2">&#34;</span><span class="se">\\</span><span class="s2">slocalhost</span><span class="se">\\</span><span class="s2">s&#34;</span><span class="p">,</span> <span class="s2">&#34; &#34;</span><span class="p">,</span> <span class="n">line</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">                    <span class="k">if</span> <span class="n">line</span> <span class="o">!=</span> <span class="n">newline</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">                        <span class="n">logg</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&#34;</span><span class="si">%s</span><span class="s2">: &#39;</span><span class="si">%s</span><span class="s2">&#39; =&gt; &#39;</span><span class="si">%s</span><span class="s2">&#39;&#34;</span><span class="p">,</span> <span class="n">_etc_hosts</span><span class="p">,</span> <span class="n">line</span><span class="o">.</span><span class="n">rstrip</span><span class="p">(),</span> <span class="n">newline</span><span class="o">.</span><span class="n">rstrip</span><span class="p">())</span>
</span></span><span class="line"><span class="cl">                        <span class="n">line</span> <span class="o">=</span> <span class="n">newline</span>
</span></span><span class="line"><span class="cl">                <span class="n">lines</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">line</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">sysconf_hosts</span><span class="p">,</span> <span class="s2">&#34;w&#34;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">            <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">lines</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">                <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">line</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="k">def</span> <span class="nf">force_ipv6</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">        <span class="s2">&#34;&#34;&#34; only ipv4 localhost in /etc/hosts &#34;&#34;&#34;</span>
</span></span><span class="line"><span class="cl">        <span class="n">logg</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&#34;checking hosts sysconf for &#39;127.0.0.1 localhost&#39;&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="n">lines</span> <span class="o">=</span> <span class="p">[]</span>
</span></span><span class="line"><span class="cl">        <span class="n">sysconf_hosts</span> <span class="o">=</span> <span class="n">os_path</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_root</span><span class="p">,</span> <span class="n">_etc_hosts</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">sysconf_hosts</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">            <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">f</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">                <span class="k">if</span> <span class="s2">&#34;127.0.0.1&#34;</span> <span class="ow">in</span> <span class="n">line</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">                    <span class="n">newline</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">sub</span><span class="p">(</span><span class="s2">&#34;</span><span class="se">\\</span><span class="s2">slocalhost</span><span class="se">\\</span><span class="s2">s&#34;</span><span class="p">,</span> <span class="s2">&#34; &#34;</span><span class="p">,</span> <span class="n">line</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">                    <span class="k">if</span> <span class="n">line</span> <span class="o">!=</span> <span class="n">newline</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">                        <span class="n">logg</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&#34;</span><span class="si">%s</span><span class="s2">: &#39;</span><span class="si">%s</span><span class="s2">&#39; =&gt; &#39;</span><span class="si">%s</span><span class="s2">&#39;&#34;</span><span class="p">,</span> <span class="n">_etc_hosts</span><span class="p">,</span> <span class="n">line</span><span class="o">.</span><span class="n">rstrip</span><span class="p">(),</span> <span class="n">newline</span><span class="o">.</span><span class="n">rstrip</span><span class="p">())</span>
</span></span><span class="line"><span class="cl">                        <span class="n">line</span> <span class="o">=</span> <span class="n">newline</span>
</span></span><span class="line"><span class="cl">                <span class="n">lines</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">line</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">sysconf_hosts</span><span class="p">,</span> <span class="s2">&#34;w&#34;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">            <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">lines</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">                <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">line</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="k">def</span> <span class="nf">help_modules</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">        <span class="s2">&#34;&#34;&#34;[command] -- show this help
</span></span></span><span class="line"><span class="cl"><span class="s2">        &#34;&#34;&#34;</span>
</span></span><span class="line"><span class="cl">        <span class="n">lines</span> <span class="o">=</span> <span class="p">[]</span>
</span></span><span class="line"><span class="cl">        <span class="n">okay</span> <span class="o">=</span> <span class="kc">True</span>
</span></span><span class="line"><span class="cl">        <span class="n">prog</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">basename</span><span class="p">(</span><span class="n">sys</span><span class="o">.</span><span class="n">argv</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="ow">not</span> <span class="n">args</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">            <span class="n">argz</span> <span class="o">=</span> <span class="p">{}</span>
</span></span><span class="line"><span class="cl">            <span class="k">for</span> <span class="n">name</span> <span class="ow">in</span> <span class="nb">dir</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">                <span class="n">arg</span> <span class="o">=</span> <span class="kc">None</span>
</span></span><span class="line"><span class="cl">                <span class="k">if</span> <span class="n">name</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s2">&#34;system_&#34;</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">                    <span class="n">arg</span> <span class="o">=</span> <span class="n">name</span><span class="p">[</span><span class="nb">len</span><span class="p">(</span><span class="s2">&#34;system_&#34;</span><span class="p">):]</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&#34;_&#34;</span><span class="p">,</span> <span class="s2">&#34;-&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">                <span class="k">if</span> <span class="n">name</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s2">&#34;show_&#34;</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">                    <span class="n">arg</span> <span class="o">=</span> <span class="n">name</span><span class="p">[</span><span class="nb">len</span><span class="p">(</span><span class="s2">&#34;show_&#34;</span><span class="p">):]</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&#34;_&#34;</span><span class="p">,</span> <span class="s2">&#34;-&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">                <span class="k">if</span> <span class="n">name</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s2">&#34;_of_unit&#34;</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">                    <span class="n">arg</span> <span class="o">=</span> <span class="n">name</span><span class="p">[:</span><span class="o">-</span><span class="nb">len</span><span class="p">(</span><span class="s2">&#34;_of_unit&#34;</span><span class="p">)]</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&#34;_&#34;</span><span class="p">,</span> <span class="s2">&#34;-&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">                <span class="k">if</span> <span class="n">name</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s2">&#34;_modules&#34;</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">                    <span class="n">arg</span> <span class="o">=</span> <span class="n">name</span><span class="p">[:</span><span class="o">-</span><span class="nb">len</span><span class="p">(</span><span class="s2">&#34;_modules&#34;</span><span class="p">)]</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&#34;_&#34;</span><span class="p">,</span> <span class="s2">&#34;-&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">                <span class="k">if</span> <span class="n">arg</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">                    <span class="n">argz</span><span class="p">[</span><span class="n">arg</span><span class="p">]</span> <span class="o">=</span> <span class="n">name</span>
</span></span><span class="line"><span class="cl">            <span class="n">lines</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&#34;</span><span class="si">%s</span><span class="s2"> command [options]...&#34;</span> <span class="o">%</span> <span class="n">prog</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">            <span class="n">lines</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&#34;&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">            <span class="n">lines</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&#34;Commands:&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">            <span class="k">for</span> <span class="n">arg</span> <span class="ow">in</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">argz</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">                <span class="n">name</span> <span class="o">=</span> <span class="n">argz</span><span class="p">[</span><span class="n">arg</span><span class="p">]</span>
</span></span><span class="line"><span class="cl">                <span class="n">method</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">                <span class="n">doc</span> <span class="o">=</span> <span class="s2">&#34;...&#34;</span>
</span></span><span class="line"><span class="cl">                <span class="n">doctext</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">method</span><span class="p">,</span> <span class="s2">&#34;__doc__&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">                <span class="k">if</span> <span class="n">doctext</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">                    <span class="n">doc</span> <span class="o">=</span> <span class="n">doctext</span>
</span></span><span class="line"><span class="cl">                <span class="k">elif</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_show_all</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">                    <span class="k">continue</span> <span class="c1"># pragma: no cover</span>
</span></span><span class="line"><span class="cl">                <span class="n">firstline</span> <span class="o">=</span> <span class="n">doc</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&#34;</span><span class="se">\n</span><span class="s2">&#34;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
</span></span><span class="line"><span class="cl">                <span class="n">doc_text</span> <span class="o">=</span> <span class="n">firstline</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">                <span class="k">if</span> <span class="s2">&#34;--&#34;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">firstline</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">                    <span class="n">doc_text</span> <span class="o">=</span> <span class="s2">&#34;-- &#34;</span> <span class="o">+</span> <span class="n">doc_text</span>
</span></span><span class="line"><span class="cl">                <span class="n">lines</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&#34; </span><span class="si">%s</span><span class="s2"> </span><span class="si">%s</span><span class="s2">&#34;</span> <span class="o">%</span> <span class="p">(</span><span class="n">arg</span><span class="p">,</span> <span class="n">firstline</span><span class="o">.</span><span class="n">strip</span><span class="p">()))</span>
</span></span><span class="line"><span class="cl">            <span class="k">return</span> <span class="n">lines</span>
</span></span><span class="line"><span class="cl">        <span class="k">for</span> <span class="n">arg</span> <span class="ow">in</span> <span class="n">args</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">            <span class="n">arg</span> <span class="o">=</span> <span class="n">arg</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&#34;-&#34;</span><span class="p">,</span> <span class="s2">&#34;_&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">            <span class="n">func1</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="vm">__class__</span><span class="p">,</span> <span class="n">arg</span><span class="o">+</span><span class="s2">&#34;_modules&#34;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">            <span class="n">func2</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="vm">__class__</span><span class="p">,</span> <span class="n">arg</span><span class="o">+</span><span class="s2">&#34;_of_unit&#34;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">            <span class="n">func3</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="vm">__class__</span><span class="p">,</span> <span class="s2">&#34;show_&#34;</span><span class="o">+</span><span class="n">arg</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">            <span class="n">func4</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="vm">__class__</span><span class="p">,</span> <span class="s2">&#34;system_&#34;</span><span class="o">+</span><span class="n">arg</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">            <span class="n">func5</span> <span class="o">=</span> <span class="kc">None</span>
</span></span><span class="line"><span class="cl">            <span class="k">if</span> <span class="n">arg</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s2">&#34;__&#34;</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">                <span class="n">func5</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="vm">__class__</span><span class="p">,</span> <span class="n">arg</span><span class="p">[</span><span class="mi">2</span><span class="p">:],</span> <span class="kc">None</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">            <span class="n">func</span> <span class="o">=</span> <span class="n">func1</span> <span class="ow">or</span> <span class="n">func2</span> <span class="ow">or</span> <span class="n">func3</span> <span class="ow">or</span> <span class="n">func4</span> <span class="ow">or</span> <span class="n">func5</span>
</span></span><span class="line"><span class="cl">            <span class="k">if</span> <span class="n">func</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">                <span class="nb">print</span><span class="p">(</span><span class="s2">&#34;error: no such command &#39;</span><span class="si">%s</span><span class="s2">&#39;&#34;</span> <span class="o">%</span> <span class="n">arg</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">                <span class="n">okay</span> <span class="o">=</span> <span class="kc">False</span>
</span></span><span class="line"><span class="cl">            <span class="k">else</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">                <span class="n">doc_text</span> <span class="o">=</span> <span class="s2">&#34;...&#34;</span>
</span></span><span class="line"><span class="cl">                <span class="n">doc</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">func</span><span class="p">,</span> <span class="s2">&#34;__doc__&#34;</span><span class="p">,</span> <span class="s2">&#34;&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">                <span class="k">if</span> <span class="n">doc</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">                    <span class="n">doc_text</span> <span class="o">=</span> <span class="n">doc</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&#34;</span><span class="se">\n</span><span class="s2">&#34;</span><span class="p">,</span> <span class="s2">&#34;</span><span class="se">\n\n</span><span class="s2">&#34;</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">                    <span class="k">if</span> <span class="s2">&#34;--&#34;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">doc_text</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">                        <span class="n">doc_text</span> <span class="o">=</span> <span class="s2">&#34;-- &#34;</span> <span class="o">+</span> <span class="n">doc_text</span>
</span></span><span class="line"><span class="cl">                <span class="k">else</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">                    <span class="n">func_name</span> <span class="o">=</span> <span class="n">arg</span> <span class="c1"># FIXME</span>
</span></span><span class="line"><span class="cl">                    <span class="n">logg</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&#34;__doc__ of </span><span class="si">%s</span><span class="s2"> is none&#34;</span><span class="p">,</span> <span class="n">func_name</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">                    <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_show_all</span><span class="p">:</span> <span class="k">continue</span>
</span></span><span class="line"><span class="cl">                <span class="n">lines</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&#34;</span><span class="si">%s</span><span class="s2"> </span><span class="si">%s</span><span class="s2"> </span><span class="si">%s</span><span class="s2">&#34;</span> <span class="o">%</span> <span class="p">(</span><span class="n">prog</span><span class="p">,</span> <span class="n">arg</span><span class="p">,</span> <span class="n">doc_text</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="ow">not</span> <span class="n">okay</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">            <span class="bp">self</span><span class="o">.</span><span class="n">help_modules</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">            <span class="bp">self</span><span class="o">.</span><span class="n">error</span> <span class="o">|=</span> <span class="n">NOT_OK</span>
</span></span><span class="line"><span class="cl">            <span class="k">return</span> <span class="p">[]</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="n">lines</span>
</span></span><span class="line"><span class="cl">    <span class="k">def</span> <span class="nf">systemd_version</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">        <span class="s2">&#34;&#34;&#34; the version line for systemd compatibility &#34;&#34;&#34;</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="s2">&#34;systemd </span><span class="si">%s</span><span class="se">\n</span><span class="s2">  - via systemctl.py </span><span class="si">%s</span><span class="s2">&#34;</span> <span class="o">%</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_systemd_version</span><span class="p">,</span> <span class="n">__version__</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="k">def</span> <span class="nf">systemd_features</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">        <span class="s2">&#34;&#34;&#34; the info line for systemd features &#34;&#34;&#34;</span>
</span></span><span class="line"><span class="cl">        <span class="n">features1</span> <span class="o">=</span> <span class="s2">&#34;-PAM -AUDIT -SELINUX -IMA -APPARMOR -SMACK&#34;</span>
</span></span><span class="line"><span class="cl">        <span class="n">features2</span> <span class="o">=</span> <span class="s2">&#34; +SYSVINIT -UTMP -LIBCRYPTSETUP -GCRYPT -GNUTLS&#34;</span>
</span></span><span class="line"><span class="cl">        <span class="n">features3</span> <span class="o">=</span> <span class="s2">&#34; -ACL -XZ -LZ4 -SECCOMP -BLKID -ELFUTILS -KMOD -IDN&#34;</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="n">features1</span><span class="o">+</span><span class="n">features2</span><span class="o">+</span><span class="n">features3</span>
</span></span><span class="line"><span class="cl">    <span class="k">def</span> <span class="nf">version_info</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">systemd_version</span><span class="p">(),</span> <span class="bp">self</span><span class="o">.</span><span class="n">systemd_features</span><span class="p">()]</span>
</span></span><span class="line"><span class="cl">    <span class="k">def</span> <span class="nf">test_float</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="mf">0.</span> <span class="c1"># &#34;Unknown result type&#34;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">def</span> <span class="nf">print_begin</span><span class="p">(</span><span class="n">argv</span><span class="p">,</span> <span class="n">args</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">    <span class="n">script</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">realpath</span><span class="p">(</span><span class="n">argv</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
</span></span><span class="line"><span class="cl">    <span class="n">system</span> <span class="o">=</span> <span class="n">_user_mode</span> <span class="ow">and</span> <span class="s2">&#34; --user&#34;</span> <span class="ow">or</span> <span class="s2">&#34; --system&#34;</span>
</span></span><span class="line"><span class="cl">    <span class="n">init</span> <span class="o">=</span> <span class="n">_init</span> <span class="ow">and</span> <span class="s2">&#34; --init&#34;</span> <span class="ow">or</span> <span class="s2">&#34;&#34;</span>
</span></span><span class="line"><span class="cl">    <span class="n">logg</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&#34;EXEC BEGIN </span><span class="si">%s</span><span class="s2"> </span><span class="si">%s%s%s</span><span class="s2">&#34;</span><span class="p">,</span> <span class="n">script</span><span class="p">,</span> <span class="s2">&#34; &#34;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">args</span><span class="p">),</span> <span class="n">system</span><span class="p">,</span> <span class="n">init</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="n">_root</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">is_good_root</span><span class="p">(</span><span class="n">_root</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">        <span class="n">root44</span> <span class="o">=</span> <span class="n">path44</span><span class="p">(</span><span class="n">_root</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="n">logg</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&#34;the --root=</span><span class="si">%s</span><span class="s2"> should have atleast three levels /tmp/test_123/root&#34;</span><span class="p">,</span> <span class="n">root44</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">def</span> <span class="nf">print_begin2</span><span class="p">(</span><span class="n">args</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">    <span class="n">logg</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&#34;======= systemctl.py </span><span class="si">%s</span><span class="s2">&#34;</span><span class="p">,</span> <span class="s2">&#34; &#34;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">args</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">def</span> <span class="nf">is_not_ok</span><span class="p">(</span><span class="n">result</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="n">DebugPrintResult</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">        <span class="n">logg</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">HINT</span><span class="p">,</span> <span class="s2">&#34;EXEC END </span><span class="si">%s</span><span class="s2">&#34;</span><span class="p">,</span> <span class="n">result</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="n">result</span> <span class="ow">is</span> <span class="kc">False</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="n">NOT_OK</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="mi">0</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">def</span> <span class="nf">print_str</span><span class="p">(</span><span class="n">result</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="n">result</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="n">DebugPrintResult</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">            <span class="n">logg</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&#34;    END </span><span class="si">%s</span><span class="s2">&#34;</span><span class="p">,</span> <span class="n">result</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span>
</span></span><span class="line"><span class="cl">    <span class="nb">print</span><span class="p">(</span><span class="n">result</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="n">DebugPrintResult</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">        <span class="n">result1</span> <span class="o">=</span> <span class="n">result</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&#34;</span><span class="se">\n</span><span class="s2">&#34;</span><span class="p">)[</span><span class="mi">0</span><span class="p">][:</span><span class="o">-</span><span class="mi">20</span><span class="p">]</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="n">result</span> <span class="o">==</span> <span class="n">result1</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">            <span class="n">logg</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">HINT</span><span class="p">,</span> <span class="s2">&#34;EXEC END &#39;</span><span class="si">%s</span><span class="s2">&#39;&#34;</span><span class="p">,</span> <span class="n">result</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="k">else</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">            <span class="n">logg</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">HINT</span><span class="p">,</span> <span class="s2">&#34;EXEC END &#39;</span><span class="si">%s</span><span class="s2">...&#39;&#34;</span><span class="p">,</span> <span class="n">result1</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">            <span class="n">logg</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&#34;    END &#39;</span><span class="si">%s</span><span class="s2">&#39;&#34;</span><span class="p">,</span> <span class="n">result</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="k">def</span> <span class="nf">print_str_list</span><span class="p">(</span><span class="n">result</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="n">result</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="n">DebugPrintResult</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">            <span class="n">logg</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&#34;    END </span><span class="si">%s</span><span class="s2">&#34;</span><span class="p">,</span> <span class="n">result</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span>
</span></span><span class="line"><span class="cl">    <span class="n">shown</span> <span class="o">=</span> <span class="mi">0</span>
</span></span><span class="line"><span class="cl">    <span class="k">for</span> <span class="n">element</span> <span class="ow">in</span> <span class="n">result</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">        <span class="nb">print</span><span class="p">(</span><span class="n">element</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="n">shown</span> <span class="o">+=</span> <span class="mi">1</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="n">DebugPrintResult</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">        <span class="n">logg</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">HINT</span><span class="p">,</span> <span class="s2">&#34;EXEC END </span><span class="si">%i</span><span class="s2"> items&#34;</span><span class="p">,</span> <span class="n">shown</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="n">logg</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&#34;    END </span><span class="si">%s</span><span class="s2">&#34;</span><span class="p">,</span> <span class="n">result</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="k">def</span> <span class="nf">print_str_list_list</span><span class="p">(</span><span class="n">result</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">    <span class="n">shown</span> <span class="o">=</span> <span class="mi">0</span>
</span></span><span class="line"><span class="cl">    <span class="k">for</span> <span class="n">element</span> <span class="ow">in</span> <span class="n">result</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">        <span class="nb">print</span><span class="p">(</span><span class="s2">&#34;</span><span class="se">\t</span><span class="s2">&#34;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="nb">str</span><span class="p">(</span><span class="n">elem</span><span class="p">)</span> <span class="k">for</span> <span class="n">elem</span> <span class="ow">in</span> <span class="n">element</span><span class="p">]))</span>
</span></span><span class="line"><span class="cl">        <span class="n">shown</span> <span class="o">+=</span> <span class="mi">1</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="n">DebugPrintResult</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">        <span class="n">logg</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">HINT</span><span class="p">,</span> <span class="s2">&#34;EXEC END </span><span class="si">%i</span><span class="s2"> items&#34;</span><span class="p">,</span> <span class="n">shown</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="n">logg</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&#34;    END </span><span class="si">%s</span><span class="s2">&#34;</span><span class="p">,</span> <span class="n">result</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="k">def</span> <span class="nf">print_str_dict</span><span class="p">(</span><span class="n">result</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="n">result</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="n">DebugPrintResult</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">            <span class="n">logg</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&#34;    END </span><span class="si">%s</span><span class="s2">&#34;</span><span class="p">,</span> <span class="n">result</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span>
</span></span><span class="line"><span class="cl">    <span class="n">shown</span> <span class="o">=</span> <span class="mi">0</span>
</span></span><span class="line"><span class="cl">    <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">result</span><span class="o">.</span><span class="n">keys</span><span class="p">()):</span>
</span></span><span class="line"><span class="cl">        <span class="n">element</span> <span class="o">=</span> <span class="n">result</span><span class="p">[</span><span class="n">key</span><span class="p">]</span>
</span></span><span class="line"><span class="cl">        <span class="nb">print</span><span class="p">(</span><span class="s2">&#34;</span><span class="si">%s</span><span class="s2">=</span><span class="si">%s</span><span class="s2">&#34;</span> <span class="o">%</span> <span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="n">element</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">        <span class="n">shown</span> <span class="o">+=</span> <span class="mi">1</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="n">DebugPrintResult</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">        <span class="n">logg</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">HINT</span><span class="p">,</span> <span class="s2">&#34;EXEC END </span><span class="si">%i</span><span class="s2"> items&#34;</span><span class="p">,</span> <span class="n">shown</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="n">logg</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&#34;    END </span><span class="si">%s</span><span class="s2">&#34;</span><span class="p">,</span> <span class="n">result</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="k">def</span> <span class="nf">print_str_dict_dict</span><span class="p">(</span><span class="n">result</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="n">result</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="n">DebugPrintResult</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">            <span class="n">logg</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&#34;    END </span><span class="si">%s</span><span class="s2">&#34;</span><span class="p">,</span> <span class="n">result</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span>
</span></span><span class="line"><span class="cl">    <span class="n">shown</span> <span class="o">=</span> <span class="mi">0</span>
</span></span><span class="line"><span class="cl">    <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">result</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">        <span class="n">element</span> <span class="o">=</span> <span class="n">result</span><span class="p">[</span><span class="n">key</span><span class="p">]</span>
</span></span><span class="line"><span class="cl">        <span class="k">for</span> <span class="n">name</span> <span class="ow">in</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">element</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">            <span class="n">value</span> <span class="o">=</span> <span class="n">element</span><span class="p">[</span><span class="n">name</span><span class="p">]</span>
</span></span><span class="line"><span class="cl">            <span class="nb">print</span><span class="p">(</span><span class="s2">&#34;</span><span class="si">%s</span><span class="s2"> [</span><span class="si">%s</span><span class="s2">] </span><span class="si">%s</span><span class="s2">&#34;</span> <span class="o">%</span> <span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="n">value</span><span class="p">,</span> <span class="n">name</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">        <span class="n">shown</span> <span class="o">+=</span> <span class="mi">1</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="n">DebugPrintResult</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">        <span class="n">logg</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">HINT</span><span class="p">,</span> <span class="s2">&#34;EXEC END </span><span class="si">%i</span><span class="s2"> items&#34;</span><span class="p">,</span> <span class="n">shown</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="n">logg</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&#34;    END </span><span class="si">%s</span><span class="s2">&#34;</span><span class="p">,</span> <span class="n">result</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">def</span> <span class="nf">runcommand</span><span class="p">(</span><span class="n">command</span><span class="p">,</span> <span class="o">*</span><span class="n">modules</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">    <span class="n">systemctl</span> <span class="o">=</span> <span class="n">Systemctl</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="n">FORCE_IPV4</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">        <span class="n">systemctl</span><span class="o">.</span><span class="n">force_ipv4</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">    <span class="k">elif</span> <span class="n">FORCE_IPV6</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">        <span class="n">systemctl</span><span class="o">.</span><span class="n">force_ipv6</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">    <span class="n">exitcode</span> <span class="o">=</span> <span class="mi">0</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="n">command</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&#34;help&#34;</span><span class="p">]:</span>
</span></span><span class="line"><span class="cl">        <span class="n">print_str_list</span><span class="p">(</span><span class="n">systemctl</span><span class="o">.</span><span class="n">help_modules</span><span class="p">(</span><span class="o">*</span><span class="n">modules</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">    <span class="k">elif</span> <span class="n">command</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&#34;cat&#34;</span><span class="p">]:</span>
</span></span><span class="line"><span class="cl">        <span class="n">print_str</span><span class="p">(</span><span class="n">systemctl</span><span class="o">.</span><span class="n">cat_modules</span><span class="p">(</span><span class="o">*</span><span class="n">modules</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">    <span class="k">elif</span> <span class="n">command</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&#34;clean&#34;</span><span class="p">]:</span>
</span></span><span class="line"><span class="cl">        <span class="n">exitcode</span> <span class="o">=</span> <span class="n">is_not_ok</span><span class="p">(</span><span class="n">systemctl</span><span class="o">.</span><span class="n">clean_modules</span><span class="p">(</span><span class="o">*</span><span class="n">modules</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">    <span class="k">elif</span> <span class="n">command</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&#34;command&#34;</span><span class="p">]:</span>
</span></span><span class="line"><span class="cl">        <span class="n">print_str_list</span><span class="p">(</span><span class="n">systemctl</span><span class="o">.</span><span class="n">command_of_unit</span><span class="p">(</span><span class="o">*</span><span class="n">modules</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">    <span class="k">elif</span> <span class="n">command</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&#34;daemon-reload&#34;</span><span class="p">]:</span>
</span></span><span class="line"><span class="cl">        <span class="n">exitcode</span> <span class="o">=</span> <span class="n">is_not_ok</span><span class="p">(</span><span class="n">systemctl</span><span class="o">.</span><span class="n">daemon_reload_target</span><span class="p">())</span>
</span></span><span class="line"><span class="cl">    <span class="k">elif</span> <span class="n">command</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&#34;default&#34;</span><span class="p">]:</span>
</span></span><span class="line"><span class="cl">        <span class="n">exitcode</span> <span class="o">=</span> <span class="n">is_not_ok</span><span class="p">(</span><span class="n">systemctl</span><span class="o">.</span><span class="n">default_system</span><span class="p">())</span>
</span></span><span class="line"><span class="cl">    <span class="k">elif</span> <span class="n">command</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&#34;default-services&#34;</span><span class="p">]:</span>
</span></span><span class="line"><span class="cl">        <span class="n">print_str_list</span><span class="p">(</span><span class="n">systemctl</span><span class="o">.</span><span class="n">default_services_modules</span><span class="p">(</span><span class="o">*</span><span class="n">modules</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">    <span class="k">elif</span> <span class="n">command</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&#34;disable&#34;</span><span class="p">]:</span>
</span></span><span class="line"><span class="cl">        <span class="n">exitcode</span> <span class="o">=</span> <span class="n">is_not_ok</span><span class="p">(</span><span class="n">systemctl</span><span class="o">.</span><span class="n">disable_modules</span><span class="p">(</span><span class="o">*</span><span class="n">modules</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">    <span class="k">elif</span> <span class="n">command</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&#34;enable&#34;</span><span class="p">]:</span>
</span></span><span class="line"><span class="cl">        <span class="n">exitcode</span> <span class="o">=</span> <span class="n">is_not_ok</span><span class="p">(</span><span class="n">systemctl</span><span class="o">.</span><span class="n">enable_modules</span><span class="p">(</span><span class="o">*</span><span class="n">modules</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">    <span class="k">elif</span> <span class="n">command</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&#34;environment&#34;</span><span class="p">]:</span>
</span></span><span class="line"><span class="cl">        <span class="n">print_str_dict</span><span class="p">(</span><span class="n">systemctl</span><span class="o">.</span><span class="n">environment_of_unit</span><span class="p">(</span><span class="o">*</span><span class="n">modules</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">    <span class="k">elif</span> <span class="n">command</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&#34;get-default&#34;</span><span class="p">]:</span>
</span></span><span class="line"><span class="cl">        <span class="n">print_str</span><span class="p">(</span><span class="n">systemctl</span><span class="o">.</span><span class="n">get_default_target</span><span class="p">())</span>
</span></span><span class="line"><span class="cl">    <span class="k">elif</span> <span class="n">command</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&#34;get-preset&#34;</span><span class="p">]:</span>
</span></span><span class="line"><span class="cl">        <span class="n">print_str</span><span class="p">(</span><span class="n">systemctl</span><span class="o">.</span><span class="n">get_preset_of_unit</span><span class="p">(</span><span class="o">*</span><span class="n">modules</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">    <span class="k">elif</span> <span class="n">command</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&#34;halt&#34;</span><span class="p">]:</span>
</span></span><span class="line"><span class="cl">        <span class="n">exitcode</span> <span class="o">=</span> <span class="n">is_not_ok</span><span class="p">(</span><span class="n">systemctl</span><span class="o">.</span><span class="n">halt_target</span><span class="p">())</span>
</span></span><span class="line"><span class="cl">    <span class="k">elif</span> <span class="n">command</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&#34;init&#34;</span><span class="p">]:</span>
</span></span><span class="line"><span class="cl">        <span class="n">exitcode</span> <span class="o">=</span> <span class="n">is_not_ok</span><span class="p">(</span><span class="n">systemctl</span><span class="o">.</span><span class="n">init_modules</span><span class="p">(</span><span class="o">*</span><span class="n">modules</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">    <span class="k">elif</span> <span class="n">command</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&#34;is-active&#34;</span><span class="p">]:</span>
</span></span><span class="line"><span class="cl">        <span class="n">print_str_list</span><span class="p">(</span><span class="n">systemctl</span><span class="o">.</span><span class="n">is_active_modules</span><span class="p">(</span><span class="o">*</span><span class="n">modules</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">    <span class="k">elif</span> <span class="n">command</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&#34;is-enabled&#34;</span><span class="p">]:</span>
</span></span><span class="line"><span class="cl">        <span class="n">print_str_list</span><span class="p">(</span><span class="n">systemctl</span><span class="o">.</span><span class="n">is_enabled_modules</span><span class="p">(</span><span class="o">*</span><span class="n">modules</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">    <span class="k">elif</span> <span class="n">command</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&#34;is-failed&#34;</span><span class="p">]:</span>
</span></span><span class="line"><span class="cl">        <span class="n">print_str_list</span><span class="p">(</span><span class="n">systemctl</span><span class="o">.</span><span class="n">is_failed_modules</span><span class="p">(</span><span class="o">*</span><span class="n">modules</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">    <span class="k">elif</span> <span class="n">command</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&#34;is-system-running&#34;</span><span class="p">]:</span>
</span></span><span class="line"><span class="cl">        <span class="n">print_str</span><span class="p">(</span><span class="n">systemctl</span><span class="o">.</span><span class="n">is_system_running_info</span><span class="p">())</span>
</span></span><span class="line"><span class="cl">    <span class="k">elif</span> <span class="n">command</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&#34;kill&#34;</span><span class="p">]:</span>
</span></span><span class="line"><span class="cl">        <span class="n">exitcode</span> <span class="o">=</span> <span class="n">is_not_ok</span><span class="p">(</span><span class="n">systemctl</span><span class="o">.</span><span class="n">kill_modules</span><span class="p">(</span><span class="o">*</span><span class="n">modules</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">    <span class="k">elif</span> <span class="n">command</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&#34;list-start-dependencies&#34;</span><span class="p">]:</span>
</span></span><span class="line"><span class="cl">        <span class="n">print_str_list_list</span><span class="p">(</span><span class="n">systemctl</span><span class="o">.</span><span class="n">list_start_dependencies_modules</span><span class="p">(</span><span class="o">*</span><span class="n">modules</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">    <span class="k">elif</span> <span class="n">command</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&#34;list-dependencies&#34;</span><span class="p">]:</span>
</span></span><span class="line"><span class="cl">        <span class="n">print_str_list</span><span class="p">(</span><span class="n">systemctl</span><span class="o">.</span><span class="n">list_dependencies_modules</span><span class="p">(</span><span class="o">*</span><span class="n">modules</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">    <span class="k">elif</span> <span class="n">command</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&#34;list-unit-files&#34;</span><span class="p">]:</span>
</span></span><span class="line"><span class="cl">        <span class="n">print_str_list_list</span><span class="p">(</span><span class="n">systemctl</span><span class="o">.</span><span class="n">list_unit_files_modules</span><span class="p">(</span><span class="o">*</span><span class="n">modules</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">    <span class="k">elif</span> <span class="n">command</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&#34;list-units&#34;</span><span class="p">]:</span>
</span></span><span class="line"><span class="cl">        <span class="n">print_str_list_list</span><span class="p">(</span><span class="n">systemctl</span><span class="o">.</span><span class="n">list_units_modules</span><span class="p">(</span><span class="o">*</span><span class="n">modules</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">    <span class="k">elif</span> <span class="n">command</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&#34;listen&#34;</span><span class="p">]:</span>
</span></span><span class="line"><span class="cl">        <span class="n">exitcode</span> <span class="o">=</span> <span class="n">is_not_ok</span><span class="p">(</span><span class="n">systemctl</span><span class="o">.</span><span class="n">listen_modules</span><span class="p">(</span><span class="o">*</span><span class="n">modules</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">    <span class="k">elif</span> <span class="n">command</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&#34;log&#34;</span><span class="p">,</span> <span class="s2">&#34;logs&#34;</span><span class="p">]:</span>
</span></span><span class="line"><span class="cl">        <span class="n">exitcode</span> <span class="o">=</span> <span class="n">is_not_ok</span><span class="p">(</span><span class="n">systemctl</span><span class="o">.</span><span class="n">log_modules</span><span class="p">(</span><span class="o">*</span><span class="n">modules</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">    <span class="k">elif</span> <span class="n">command</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&#34;mask&#34;</span><span class="p">]:</span>
</span></span><span class="line"><span class="cl">        <span class="n">exitcode</span> <span class="o">=</span> <span class="n">is_not_ok</span><span class="p">(</span><span class="n">systemctl</span><span class="o">.</span><span class="n">mask_modules</span><span class="p">(</span><span class="o">*</span><span class="n">modules</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">    <span class="k">elif</span> <span class="n">command</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&#34;preset&#34;</span><span class="p">]:</span>
</span></span><span class="line"><span class="cl">        <span class="n">exitcode</span> <span class="o">=</span> <span class="n">is_not_ok</span><span class="p">(</span><span class="n">systemctl</span><span class="o">.</span><span class="n">preset_modules</span><span class="p">(</span><span class="o">*</span><span class="n">modules</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">    <span class="k">elif</span> <span class="n">command</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&#34;preset-all&#34;</span><span class="p">]:</span>
</span></span><span class="line"><span class="cl">        <span class="n">exitcode</span> <span class="o">=</span> <span class="n">is_not_ok</span><span class="p">(</span><span class="n">systemctl</span><span class="o">.</span><span class="n">preset_all_modules</span><span class="p">())</span>
</span></span><span class="line"><span class="cl">    <span class="k">elif</span> <span class="n">command</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&#34;reap-zombies&#34;</span><span class="p">]:</span>
</span></span><span class="line"><span class="cl">        <span class="n">print_str</span><span class="p">(</span><span class="n">systemctl</span><span class="o">.</span><span class="n">reap_zombies_target</span><span class="p">())</span>
</span></span><span class="line"><span class="cl">    <span class="k">elif</span> <span class="n">command</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&#34;reload&#34;</span><span class="p">]:</span>
</span></span><span class="line"><span class="cl">        <span class="n">exitcode</span> <span class="o">=</span> <span class="n">is_not_ok</span><span class="p">(</span><span class="n">systemctl</span><span class="o">.</span><span class="n">reload_modules</span><span class="p">(</span><span class="o">*</span><span class="n">modules</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">    <span class="k">elif</span> <span class="n">command</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&#34;reload-or-restart&#34;</span><span class="p">]:</span>
</span></span><span class="line"><span class="cl">        <span class="n">exitcode</span> <span class="o">=</span> <span class="n">is_not_ok</span><span class="p">(</span><span class="n">systemctl</span><span class="o">.</span><span class="n">reload_or_restart_modules</span><span class="p">(</span><span class="o">*</span><span class="n">modules</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">    <span class="k">elif</span> <span class="n">command</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&#34;reload-or-try-restart&#34;</span><span class="p">]:</span>
</span></span><span class="line"><span class="cl">        <span class="n">exitcode</span> <span class="o">=</span> <span class="n">is_not_ok</span><span class="p">(</span><span class="n">systemctl</span><span class="o">.</span><span class="n">reload_or_try_restart_modules</span><span class="p">(</span><span class="o">*</span><span class="n">modules</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">    <span class="k">elif</span> <span class="n">command</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&#34;reset-failed&#34;</span><span class="p">]:</span>
</span></span><span class="line"><span class="cl">        <span class="n">exitcode</span> <span class="o">=</span> <span class="n">is_not_ok</span><span class="p">(</span><span class="n">systemctl</span><span class="o">.</span><span class="n">reset_failed_modules</span><span class="p">(</span><span class="o">*</span><span class="n">modules</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">    <span class="k">elif</span> <span class="n">command</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&#34;restart&#34;</span><span class="p">]:</span>
</span></span><span class="line"><span class="cl">        <span class="n">exitcode</span> <span class="o">=</span> <span class="n">is_not_ok</span><span class="p">(</span><span class="n">systemctl</span><span class="o">.</span><span class="n">restart_modules</span><span class="p">(</span><span class="o">*</span><span class="n">modules</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">    <span class="k">elif</span> <span class="n">command</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&#34;set-default&#34;</span><span class="p">]:</span>
</span></span><span class="line"><span class="cl">        <span class="n">print_str</span><span class="p">(</span><span class="n">systemctl</span><span class="o">.</span><span class="n">set_default_modules</span><span class="p">(</span><span class="o">*</span><span class="n">modules</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">    <span class="k">elif</span> <span class="n">command</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&#34;show&#34;</span><span class="p">]:</span>
</span></span><span class="line"><span class="cl">        <span class="n">print_str_list</span><span class="p">(</span><span class="n">systemctl</span><span class="o">.</span><span class="n">show_modules</span><span class="p">(</span><span class="o">*</span><span class="n">modules</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">    <span class="k">elif</span> <span class="n">command</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&#34;start&#34;</span><span class="p">]:</span>
</span></span><span class="line"><span class="cl">        <span class="n">exitcode</span> <span class="o">=</span> <span class="n">is_not_ok</span><span class="p">(</span><span class="n">systemctl</span><span class="o">.</span><span class="n">start_modules</span><span class="p">(</span><span class="o">*</span><span class="n">modules</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">    <span class="k">elif</span> <span class="n">command</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&#34;status&#34;</span><span class="p">]:</span>
</span></span><span class="line"><span class="cl">        <span class="n">print_str</span><span class="p">(</span><span class="n">systemctl</span><span class="o">.</span><span class="n">status_modules</span><span class="p">(</span><span class="o">*</span><span class="n">modules</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">    <span class="k">elif</span> <span class="n">command</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&#34;stop&#34;</span><span class="p">]:</span>
</span></span><span class="line"><span class="cl">        <span class="n">exitcode</span> <span class="o">=</span> <span class="n">is_not_ok</span><span class="p">(</span><span class="n">systemctl</span><span class="o">.</span><span class="n">stop_modules</span><span class="p">(</span><span class="o">*</span><span class="n">modules</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">    <span class="k">elif</span> <span class="n">command</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&#34;try-restart&#34;</span><span class="p">]:</span>
</span></span><span class="line"><span class="cl">        <span class="n">exitcode</span> <span class="o">=</span> <span class="n">is_not_ok</span><span class="p">(</span><span class="n">systemctl</span><span class="o">.</span><span class="n">try_restart_modules</span><span class="p">(</span><span class="o">*</span><span class="n">modules</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">    <span class="k">elif</span> <span class="n">command</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&#34;unmask&#34;</span><span class="p">]:</span>
</span></span><span class="line"><span class="cl">        <span class="n">exitcode</span> <span class="o">=</span> <span class="n">is_not_ok</span><span class="p">(</span><span class="n">systemctl</span><span class="o">.</span><span class="n">unmask_modules</span><span class="p">(</span><span class="o">*</span><span class="n">modules</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">    <span class="k">elif</span> <span class="n">command</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&#34;version&#34;</span><span class="p">]:</span>
</span></span><span class="line"><span class="cl">        <span class="n">print_str_list</span><span class="p">(</span><span class="n">systemctl</span><span class="o">.</span><span class="n">version_info</span><span class="p">())</span>
</span></span><span class="line"><span class="cl">    <span class="k">elif</span> <span class="n">command</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&#34;__cat_unit&#34;</span><span class="p">]:</span>
</span></span><span class="line"><span class="cl">        <span class="n">print_str</span><span class="p">(</span><span class="n">systemctl</span><span class="o">.</span><span class="n">cat_unit</span><span class="p">(</span><span class="o">*</span><span class="n">modules</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">    <span class="k">elif</span> <span class="n">command</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&#34;__get_active_unit&#34;</span><span class="p">]:</span>
</span></span><span class="line"><span class="cl">        <span class="n">print_str</span><span class="p">(</span><span class="n">systemctl</span><span class="o">.</span><span class="n">get_active_unit</span><span class="p">(</span><span class="o">*</span><span class="n">modules</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">    <span class="k">elif</span> <span class="n">command</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&#34;__get_description&#34;</span><span class="p">]:</span>
</span></span><span class="line"><span class="cl">        <span class="n">print_str</span><span class="p">(</span><span class="n">systemctl</span><span class="o">.</span><span class="n">get_description</span><span class="p">(</span><span class="o">*</span><span class="n">modules</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">    <span class="k">elif</span> <span class="n">command</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&#34;__get_status_file&#34;</span><span class="p">]:</span>
</span></span><span class="line"><span class="cl">        <span class="n">print_str</span><span class="p">(</span><span class="n">systemctl</span><span class="o">.</span><span class="n">get_status_file</span><span class="p">(</span><span class="n">modules</span><span class="p">[</span><span class="mi">0</span><span class="p">]))</span>
</span></span><span class="line"><span class="cl">    <span class="k">elif</span> <span class="n">command</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&#34;__get_status_pid_file&#34;</span><span class="p">,</span> <span class="s2">&#34;__get_pid_file&#34;</span><span class="p">]:</span>
</span></span><span class="line"><span class="cl">        <span class="n">print_str</span><span class="p">(</span><span class="n">systemctl</span><span class="o">.</span><span class="n">get_status_pid_file</span><span class="p">(</span><span class="n">modules</span><span class="p">[</span><span class="mi">0</span><span class="p">]))</span>
</span></span><span class="line"><span class="cl">    <span class="k">elif</span> <span class="n">command</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&#34;__disable_unit&#34;</span><span class="p">]:</span>
</span></span><span class="line"><span class="cl">        <span class="n">exitcode</span> <span class="o">=</span> <span class="n">is_not_ok</span><span class="p">(</span><span class="n">systemctl</span><span class="o">.</span><span class="n">disable_unit</span><span class="p">(</span><span class="o">*</span><span class="n">modules</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">    <span class="k">elif</span> <span class="n">command</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&#34;__enable_unit&#34;</span><span class="p">]:</span>
</span></span><span class="line"><span class="cl">        <span class="n">exitcode</span> <span class="o">=</span> <span class="n">is_not_ok</span><span class="p">(</span><span class="n">systemctl</span><span class="o">.</span><span class="n">enable_unit</span><span class="p">(</span><span class="o">*</span><span class="n">modules</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">    <span class="k">elif</span> <span class="n">command</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&#34;__is_enabled&#34;</span><span class="p">]:</span>
</span></span><span class="line"><span class="cl">        <span class="n">exitcode</span> <span class="o">=</span> <span class="n">is_not_ok</span><span class="p">(</span><span class="n">systemctl</span><span class="o">.</span><span class="n">is_enabled</span><span class="p">(</span><span class="o">*</span><span class="n">modules</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">    <span class="k">elif</span> <span class="n">command</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&#34;__killall&#34;</span><span class="p">]:</span>
</span></span><span class="line"><span class="cl">        <span class="n">exitcode</span> <span class="o">=</span> <span class="n">is_not_ok</span><span class="p">(</span><span class="n">systemctl</span><span class="o">.</span><span class="n">killall</span><span class="p">(</span><span class="o">*</span><span class="n">modules</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">    <span class="k">elif</span> <span class="n">command</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&#34;__kill_unit&#34;</span><span class="p">]:</span>
</span></span><span class="line"><span class="cl">        <span class="n">exitcode</span> <span class="o">=</span> <span class="n">is_not_ok</span><span class="p">(</span><span class="n">systemctl</span><span class="o">.</span><span class="n">kill_unit</span><span class="p">(</span><span class="o">*</span><span class="n">modules</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">    <span class="k">elif</span> <span class="n">command</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&#34;__load_preset_files&#34;</span><span class="p">]:</span>
</span></span><span class="line"><span class="cl">        <span class="n">print_str_list</span><span class="p">(</span><span class="n">systemctl</span><span class="o">.</span><span class="n">load_preset_files</span><span class="p">(</span><span class="o">*</span><span class="n">modules</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">    <span class="k">elif</span> <span class="n">command</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&#34;__mask_unit&#34;</span><span class="p">]:</span>
</span></span><span class="line"><span class="cl">        <span class="n">exitcode</span> <span class="o">=</span> <span class="n">is_not_ok</span><span class="p">(</span><span class="n">systemctl</span><span class="o">.</span><span class="n">mask_unit</span><span class="p">(</span><span class="o">*</span><span class="n">modules</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">    <span class="k">elif</span> <span class="n">command</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&#34;__read_env_file&#34;</span><span class="p">]:</span>
</span></span><span class="line"><span class="cl">        <span class="n">print_str_list_list</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="n">systemctl</span><span class="o">.</span><span class="n">read_env_file</span><span class="p">(</span><span class="o">*</span><span class="n">modules</span><span class="p">)))</span>
</span></span><span class="line"><span class="cl">    <span class="k">elif</span> <span class="n">command</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&#34;__reload_unit&#34;</span><span class="p">]:</span>
</span></span><span class="line"><span class="cl">        <span class="n">exitcode</span> <span class="o">=</span> <span class="n">is_not_ok</span><span class="p">(</span><span class="n">systemctl</span><span class="o">.</span><span class="n">reload_unit</span><span class="p">(</span><span class="o">*</span><span class="n">modules</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">    <span class="k">elif</span> <span class="n">command</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&#34;__reload_or_restart_unit&#34;</span><span class="p">]:</span>
</span></span><span class="line"><span class="cl">        <span class="n">exitcode</span> <span class="o">=</span> <span class="n">is_not_ok</span><span class="p">(</span><span class="n">systemctl</span><span class="o">.</span><span class="n">reload_or_restart_unit</span><span class="p">(</span><span class="o">*</span><span class="n">modules</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">    <span class="k">elif</span> <span class="n">command</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&#34;__reload_or_try_restart_unit&#34;</span><span class="p">]:</span>
</span></span><span class="line"><span class="cl">        <span class="n">exitcode</span> <span class="o">=</span> <span class="n">is_not_ok</span><span class="p">(</span><span class="n">systemctl</span><span class="o">.</span><span class="n">reload_or_try_restart_unit</span><span class="p">(</span><span class="o">*</span><span class="n">modules</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">    <span class="k">elif</span> <span class="n">command</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&#34;__reset_failed_unit&#34;</span><span class="p">]:</span>
</span></span><span class="line"><span class="cl">        <span class="n">exitcode</span> <span class="o">=</span> <span class="n">is_not_ok</span><span class="p">(</span><span class="n">systemctl</span><span class="o">.</span><span class="n">reset_failed_unit</span><span class="p">(</span><span class="o">*</span><span class="n">modules</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">    <span class="k">elif</span> <span class="n">command</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&#34;__restart_unit&#34;</span><span class="p">]:</span>
</span></span><span class="line"><span class="cl">        <span class="n">exitcode</span> <span class="o">=</span> <span class="n">is_not_ok</span><span class="p">(</span><span class="n">systemctl</span><span class="o">.</span><span class="n">restart_unit</span><span class="p">(</span><span class="o">*</span><span class="n">modules</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">    <span class="k">elif</span> <span class="n">command</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&#34;__start_unit&#34;</span><span class="p">]:</span>
</span></span><span class="line"><span class="cl">        <span class="n">exitcode</span> <span class="o">=</span> <span class="n">is_not_ok</span><span class="p">(</span><span class="n">systemctl</span><span class="o">.</span><span class="n">start_unit</span><span class="p">(</span><span class="o">*</span><span class="n">modules</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">    <span class="k">elif</span> <span class="n">command</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&#34;__stop_unit&#34;</span><span class="p">]:</span>
</span></span><span class="line"><span class="cl">        <span class="n">exitcode</span> <span class="o">=</span> <span class="n">is_not_ok</span><span class="p">(</span><span class="n">systemctl</span><span class="o">.</span><span class="n">stop_unit</span><span class="p">(</span><span class="o">*</span><span class="n">modules</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">    <span class="k">elif</span> <span class="n">command</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&#34;__try_restart_unit&#34;</span><span class="p">]:</span>
</span></span><span class="line"><span class="cl">        <span class="n">exitcode</span> <span class="o">=</span> <span class="n">is_not_ok</span><span class="p">(</span><span class="n">systemctl</span><span class="o">.</span><span class="n">try_restart_unit</span><span class="p">(</span><span class="o">*</span><span class="n">modules</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">    <span class="k">elif</span> <span class="n">command</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&#34;__test_start_unit&#34;</span><span class="p">]:</span>
</span></span><span class="line"><span class="cl">        <span class="n">systemctl</span><span class="o">.</span><span class="n">test_start_unit</span><span class="p">(</span><span class="o">*</span><span class="n">modules</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="k">elif</span> <span class="n">command</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&#34;__unmask_unit&#34;</span><span class="p">]:</span>
</span></span><span class="line"><span class="cl">        <span class="n">exitcode</span> <span class="o">=</span> <span class="n">is_not_ok</span><span class="p">(</span><span class="n">systemctl</span><span class="o">.</span><span class="n">unmask_unit</span><span class="p">(</span><span class="o">*</span><span class="n">modules</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">    <span class="k">elif</span> <span class="n">command</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&#34;__show_unit_items&#34;</span><span class="p">]:</span>
</span></span><span class="line"><span class="cl">        <span class="n">print_str_list_list</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="n">systemctl</span><span class="o">.</span><span class="n">show_unit_items</span><span class="p">(</span><span class="o">*</span><span class="n">modules</span><span class="p">)))</span>
</span></span><span class="line"><span class="cl">    <span class="k">else</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">        <span class="n">logg</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&#34;Unknown operation </span><span class="si">%s</span><span class="s2">&#34;</span><span class="p">,</span> <span class="n">command</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="n">EXIT_FAILURE</span>
</span></span><span class="line"><span class="cl">    <span class="c1">#</span>
</span></span><span class="line"><span class="cl">    <span class="n">exitcode</span> <span class="o">|=</span> <span class="n">systemctl</span><span class="o">.</span><span class="n">error</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="n">exitcode</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s2">&#34;__main__&#34;</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">    <span class="kn">import</span> <span class="nn">optparse</span>
</span></span><span class="line"><span class="cl">    <span class="n">_o</span> <span class="o">=</span> <span class="n">optparse</span><span class="o">.</span><span class="n">OptionParser</span><span class="p">(</span><span class="s2">&#34;%prog [options] command [name...]&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                               <span class="n">epilog</span><span class="o">=</span><span class="s2">&#34;use &#39;help&#39; command for more information&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="n">_o</span><span class="o">.</span><span class="n">add_option</span><span class="p">(</span><span class="s2">&#34;--version&#34;</span><span class="p">,</span> <span class="n">action</span><span class="o">=</span><span class="s2">&#34;store_true&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                  <span class="n">help</span><span class="o">=</span><span class="s2">&#34;Show package version&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="n">_o</span><span class="o">.</span><span class="n">add_option</span><span class="p">(</span><span class="s2">&#34;--system&#34;</span><span class="p">,</span> <span class="n">action</span><span class="o">=</span><span class="s2">&#34;store_true&#34;</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                  <span class="n">help</span><span class="o">=</span><span class="s2">&#34;Connect to system manager (default)&#34;</span><span class="p">)</span> <span class="c1"># overrides --user</span>
</span></span><span class="line"><span class="cl">    <span class="n">_o</span><span class="o">.</span><span class="n">add_option</span><span class="p">(</span><span class="s2">&#34;--user&#34;</span><span class="p">,</span> <span class="n">action</span><span class="o">=</span><span class="s2">&#34;store_true&#34;</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="n">_user_mode</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                  <span class="n">help</span><span class="o">=</span><span class="s2">&#34;Connect to user service manager&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="c1"># _o.add_option(&#34;-H&#34;, &#34;--host&#34;, metavar=&#34;[USER@]HOST&#34;,</span>
</span></span><span class="line"><span class="cl">    <span class="c1">#     help=&#34;Operate on remote host*&#34;)</span>
</span></span><span class="line"><span class="cl">    <span class="c1"># _o.add_option(&#34;-M&#34;, &#34;--machine&#34;, metavar=&#34;CONTAINER&#34;,</span>
</span></span><span class="line"><span class="cl">    <span class="c1">#     help=&#34;Operate on local container*&#34;)</span>
</span></span><span class="line"><span class="cl">    <span class="n">_o</span><span class="o">.</span><span class="n">add_option</span><span class="p">(</span><span class="s2">&#34;-t&#34;</span><span class="p">,</span> <span class="s2">&#34;--type&#34;</span><span class="p">,</span> <span class="n">metavar</span><span class="o">=</span><span class="s2">&#34;TYPE&#34;</span><span class="p">,</span> <span class="n">action</span><span class="o">=</span><span class="s2">&#34;append&#34;</span><span class="p">,</span> <span class="n">dest</span><span class="o">=</span><span class="s2">&#34;only_type&#34;</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="n">_only_type</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                  <span class="n">help</span><span class="o">=</span><span class="s2">&#34;List units of a particual type&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="n">_o</span><span class="o">.</span><span class="n">add_option</span><span class="p">(</span><span class="s2">&#34;--state&#34;</span><span class="p">,</span> <span class="n">metavar</span><span class="o">=</span><span class="s2">&#34;STATE&#34;</span><span class="p">,</span> <span class="n">action</span><span class="o">=</span><span class="s2">&#34;append&#34;</span><span class="p">,</span> <span class="n">dest</span><span class="o">=</span><span class="s2">&#34;only_state&#34;</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="n">_only_state</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                  <span class="n">help</span><span class="o">=</span><span class="s2">&#34;List units with particular LOAD or SUB or ACTIVE state&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="n">_o</span><span class="o">.</span><span class="n">add_option</span><span class="p">(</span><span class="s2">&#34;-p&#34;</span><span class="p">,</span> <span class="s2">&#34;--property&#34;</span><span class="p">,</span> <span class="n">metavar</span><span class="o">=</span><span class="s2">&#34;NAME&#34;</span><span class="p">,</span> <span class="n">action</span><span class="o">=</span><span class="s2">&#34;append&#34;</span><span class="p">,</span> <span class="n">dest</span><span class="o">=</span><span class="s2">&#34;only_property&#34;</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="n">_only_property</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                  <span class="n">help</span><span class="o">=</span><span class="s2">&#34;Show only properties by this name&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="n">_o</span><span class="o">.</span><span class="n">add_option</span><span class="p">(</span><span class="s2">&#34;--what&#34;</span><span class="p">,</span> <span class="n">metavar</span><span class="o">=</span><span class="s2">&#34;TYPE&#34;</span><span class="p">,</span> <span class="n">action</span><span class="o">=</span><span class="s2">&#34;append&#34;</span><span class="p">,</span> <span class="n">dest</span><span class="o">=</span><span class="s2">&#34;only_what&#34;</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="n">_only_what</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                  <span class="n">help</span><span class="o">=</span><span class="s2">&#34;Defines the service directories to be cleaned (configuration, state, cache, logs, runtime)&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="n">_o</span><span class="o">.</span><span class="n">add_option</span><span class="p">(</span><span class="s2">&#34;-a&#34;</span><span class="p">,</span> <span class="s2">&#34;--all&#34;</span><span class="p">,</span> <span class="n">action</span><span class="o">=</span><span class="s2">&#34;store_true&#34;</span><span class="p">,</span> <span class="n">dest</span><span class="o">=</span><span class="s2">&#34;show_all&#34;</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="n">_show_all</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                  <span class="n">help</span><span class="o">=</span><span class="s2">&#34;Show all loaded units/properties, including dead empty ones. To list all units installed on the system, use the &#39;list-unit-files&#39; command instead&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="n">_o</span><span class="o">.</span><span class="n">add_option</span><span class="p">(</span><span class="s2">&#34;-l&#34;</span><span class="p">,</span> <span class="s2">&#34;--full&#34;</span><span class="p">,</span> <span class="n">action</span><span class="o">=</span><span class="s2">&#34;store_true&#34;</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="n">_full</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                  <span class="n">help</span><span class="o">=</span><span class="s2">&#34;Don&#39;t ellipsize unit names on output (never ellipsized)&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="n">_o</span><span class="o">.</span><span class="n">add_option</span><span class="p">(</span><span class="s2">&#34;--reverse&#34;</span><span class="p">,</span> <span class="n">action</span><span class="o">=</span><span class="s2">&#34;store_true&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                  <span class="n">help</span><span class="o">=</span><span class="s2">&#34;Show reverse dependencies with &#39;list-dependencies&#39; (ignored)&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="n">_o</span><span class="o">.</span><span class="n">add_option</span><span class="p">(</span><span class="s2">&#34;--job-mode&#34;</span><span class="p">,</span> <span class="n">metavar</span><span class="o">=</span><span class="s2">&#34;MODE&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                  <span class="n">help</span><span class="o">=</span><span class="s2">&#34;Specify how to deal with already queued jobs, when queuing a new job (ignored)&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="n">_o</span><span class="o">.</span><span class="n">add_option</span><span class="p">(</span><span class="s2">&#34;--show-types&#34;</span><span class="p">,</span> <span class="n">action</span><span class="o">=</span><span class="s2">&#34;store_true&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                  <span class="n">help</span><span class="o">=</span><span class="s2">&#34;When showing sockets, explicitly show their type (ignored)&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="n">_o</span><span class="o">.</span><span class="n">add_option</span><span class="p">(</span><span class="s2">&#34;-i&#34;</span><span class="p">,</span> <span class="s2">&#34;--ignore-inhibitors&#34;</span><span class="p">,</span> <span class="n">action</span><span class="o">=</span><span class="s2">&#34;store_true&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                  <span class="n">help</span><span class="o">=</span><span class="s2">&#34;When shutting down or sleeping, ignore inhibitors (ignored)&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="n">_o</span><span class="o">.</span><span class="n">add_option</span><span class="p">(</span><span class="s2">&#34;--kill-who&#34;</span><span class="p">,</span> <span class="n">metavar</span><span class="o">=</span><span class="s2">&#34;WHO&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                  <span class="n">help</span><span class="o">=</span><span class="s2">&#34;Who to send signal to (ignored)&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="n">_o</span><span class="o">.</span><span class="n">add_option</span><span class="p">(</span><span class="s2">&#34;-s&#34;</span><span class="p">,</span> <span class="s2">&#34;--signal&#34;</span><span class="p">,</span> <span class="n">metavar</span><span class="o">=</span><span class="s2">&#34;SIG&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                  <span class="n">help</span><span class="o">=</span><span class="s2">&#34;Which signal to send (ignored)&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="n">_o</span><span class="o">.</span><span class="n">add_option</span><span class="p">(</span><span class="s2">&#34;--now&#34;</span><span class="p">,</span> <span class="n">action</span><span class="o">=</span><span class="s2">&#34;store_true&#34;</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="n">_now</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                  <span class="n">help</span><span class="o">=</span><span class="s2">&#34;Start or stop unit in addition to enabling or disabling it&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="n">_o</span><span class="o">.</span><span class="n">add_option</span><span class="p">(</span><span class="s2">&#34;-q&#34;</span><span class="p">,</span> <span class="s2">&#34;--quiet&#34;</span><span class="p">,</span> <span class="n">action</span><span class="o">=</span><span class="s2">&#34;store_true&#34;</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="n">_quiet</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                  <span class="n">help</span><span class="o">=</span><span class="s2">&#34;Suppress output&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="n">_o</span><span class="o">.</span><span class="n">add_option</span><span class="p">(</span><span class="s2">&#34;--no-block&#34;</span><span class="p">,</span> <span class="n">action</span><span class="o">=</span><span class="s2">&#34;store_true&#34;</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                  <span class="n">help</span><span class="o">=</span><span class="s2">&#34;Do not wait until operation finished (ignored)&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="n">_o</span><span class="o">.</span><span class="n">add_option</span><span class="p">(</span><span class="s2">&#34;--no-legend&#34;</span><span class="p">,</span> <span class="n">action</span><span class="o">=</span><span class="s2">&#34;store_true&#34;</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="n">_no_legend</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                  <span class="n">help</span><span class="o">=</span><span class="s2">&#34;Do not print a legend (column headers and hints)&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="n">_o</span><span class="o">.</span><span class="n">add_option</span><span class="p">(</span><span class="s2">&#34;--no-wall&#34;</span><span class="p">,</span> <span class="n">action</span><span class="o">=</span><span class="s2">&#34;store_true&#34;</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                  <span class="n">help</span><span class="o">=</span><span class="s2">&#34;Don&#39;t send wall message before halt/power-off/reboot (ignored)&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="n">_o</span><span class="o">.</span><span class="n">add_option</span><span class="p">(</span><span class="s2">&#34;--no-reload&#34;</span><span class="p">,</span> <span class="n">action</span><span class="o">=</span><span class="s2">&#34;store_true&#34;</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="n">_no_reload</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                  <span class="n">help</span><span class="o">=</span><span class="s2">&#34;Don&#39;t reload daemon after en-/dis-abling unit files&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="n">_o</span><span class="o">.</span><span class="n">add_option</span><span class="p">(</span><span class="s2">&#34;--no-ask-password&#34;</span><span class="p">,</span> <span class="n">action</span><span class="o">=</span><span class="s2">&#34;store_true&#34;</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="n">_no_ask_password</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                  <span class="n">help</span><span class="o">=</span><span class="s2">&#34;Do not ask for system passwords&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="c1"># _o.add_option(&#34;--global&#34;, action=&#34;store_true&#34;, dest=&#34;globally&#34;, default=_globally,</span>
</span></span><span class="line"><span class="cl">    <span class="c1">#    help=&#34;Enable/disable unit files globally&#34;) # for all user logins</span>
</span></span><span class="line"><span class="cl">    <span class="c1"># _o.add_option(&#34;--runtime&#34;, action=&#34;store_true&#34;,</span>
</span></span><span class="line"><span class="cl">    <span class="c1">#     help=&#34;Enable unit files only temporarily until next reboot&#34;)</span>
</span></span><span class="line"><span class="cl">    <span class="n">_o</span><span class="o">.</span><span class="n">add_option</span><span class="p">(</span><span class="s2">&#34;-f&#34;</span><span class="p">,</span> <span class="s2">&#34;--force&#34;</span><span class="p">,</span> <span class="n">action</span><span class="o">=</span><span class="s2">&#34;store_true&#34;</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="n">_force</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                  <span class="n">help</span><span class="o">=</span><span class="s2">&#34;When enabling unit files, override existing symblinks / When shutting down, execute action immediately&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="n">_o</span><span class="o">.</span><span class="n">add_option</span><span class="p">(</span><span class="s2">&#34;--preset-mode&#34;</span><span class="p">,</span> <span class="n">metavar</span><span class="o">=</span><span class="s2">&#34;TYPE&#34;</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="n">_preset_mode</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                  <span class="n">help</span><span class="o">=</span><span class="s2">&#34;Apply only enable, only disable, or all presets [</span><span class="si">%d</span><span class="s2">efault]&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="n">_o</span><span class="o">.</span><span class="n">add_option</span><span class="p">(</span><span class="s2">&#34;--root&#34;</span><span class="p">,</span> <span class="n">metavar</span><span class="o">=</span><span class="s2">&#34;PATH&#34;</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="n">_root</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                  <span class="n">help</span><span class="o">=</span><span class="s2">&#34;Enable unit files in the specified root directory (used for alternative root prefix)&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="n">_o</span><span class="o">.</span><span class="n">add_option</span><span class="p">(</span><span class="s2">&#34;-n&#34;</span><span class="p">,</span> <span class="s2">&#34;--lines&#34;</span><span class="p">,</span> <span class="n">metavar</span><span class="o">=</span><span class="s2">&#34;NUM&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                  <span class="n">help</span><span class="o">=</span><span class="s2">&#34;Number of journal entries to show&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="n">_o</span><span class="o">.</span><span class="n">add_option</span><span class="p">(</span><span class="s2">&#34;-o&#34;</span><span class="p">,</span> <span class="s2">&#34;--output&#34;</span><span class="p">,</span> <span class="n">metavar</span><span class="o">=</span><span class="s2">&#34;CAT&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                  <span class="n">help</span><span class="o">=</span><span class="s2">&#34;change journal output mode [short, ..., cat] (ignored)&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="n">_o</span><span class="o">.</span><span class="n">add_option</span><span class="p">(</span><span class="s2">&#34;--plain&#34;</span><span class="p">,</span> <span class="n">action</span><span class="o">=</span><span class="s2">&#34;store_true&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                  <span class="n">help</span><span class="o">=</span><span class="s2">&#34;Print unit dependencies as a list instead of a tree (ignored)&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="n">_o</span><span class="o">.</span><span class="n">add_option</span><span class="p">(</span><span class="s2">&#34;--no-pager&#34;</span><span class="p">,</span> <span class="n">action</span><span class="o">=</span><span class="s2">&#34;store_true&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                  <span class="n">help</span><span class="o">=</span><span class="s2">&#34;Do not pipe output into pager (mostly ignored)&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="n">_o</span><span class="o">.</span><span class="n">add_option</span><span class="p">(</span><span class="s2">&#34;--no-warn&#34;</span><span class="p">,</span> <span class="n">action</span><span class="o">=</span><span class="s2">&#34;store_true&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                  <span class="n">help</span><span class="o">=</span><span class="s2">&#34;Do not generate certain warnings (ignored)&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="c1">#</span>
</span></span><span class="line"><span class="cl">    <span class="n">_o</span><span class="o">.</span><span class="n">add_option</span><span class="p">(</span><span class="s2">&#34;-c&#34;</span><span class="p">,</span> <span class="s2">&#34;--config&#34;</span><span class="p">,</span> <span class="n">metavar</span><span class="o">=</span><span class="s2">&#34;NAME=VAL&#34;</span><span class="p">,</span> <span class="n">action</span><span class="o">=</span><span class="s2">&#34;append&#34;</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="p">[],</span>
</span></span><span class="line"><span class="cl">                  <span class="n">help</span><span class="o">=</span><span class="s2">&#34;..override internal variables (InitLoopSleep,SysInitTarget) {</span><span class="si">%d</span><span class="s2">efault}&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="n">_o</span><span class="o">.</span><span class="n">add_option</span><span class="p">(</span><span class="s2">&#34;-e&#34;</span><span class="p">,</span> <span class="s2">&#34;--extra-vars&#34;</span><span class="p">,</span> <span class="s2">&#34;--environment&#34;</span><span class="p">,</span> <span class="n">metavar</span><span class="o">=</span><span class="s2">&#34;NAME=VAL&#34;</span><span class="p">,</span> <span class="n">action</span><span class="o">=</span><span class="s2">&#34;append&#34;</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="p">[],</span>
</span></span><span class="line"><span class="cl">                  <span class="n">help</span><span class="o">=</span><span class="s2">&#34;..override settings in the syntax of &#39;Environment=&#39;&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="n">_o</span><span class="o">.</span><span class="n">add_option</span><span class="p">(</span><span class="s2">&#34;-v&#34;</span><span class="p">,</span> <span class="s2">&#34;--verbose&#34;</span><span class="p">,</span> <span class="n">action</span><span class="o">=</span><span class="s2">&#34;count&#34;</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                  <span class="n">help</span><span class="o">=</span><span class="s2">&#34;..increase debugging information level&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="n">_o</span><span class="o">.</span><span class="n">add_option</span><span class="p">(</span><span class="s2">&#34;-4&#34;</span><span class="p">,</span> <span class="s2">&#34;--ipv4&#34;</span><span class="p">,</span> <span class="n">action</span><span class="o">=</span><span class="s2">&#34;store_true&#34;</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                  <span class="n">help</span><span class="o">=</span><span class="s2">&#34;..only keep ipv4 localhost in /etc/hosts&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="n">_o</span><span class="o">.</span><span class="n">add_option</span><span class="p">(</span><span class="s2">&#34;-6&#34;</span><span class="p">,</span> <span class="s2">&#34;--ipv6&#34;</span><span class="p">,</span> <span class="n">action</span><span class="o">=</span><span class="s2">&#34;store_true&#34;</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                  <span class="n">help</span><span class="o">=</span><span class="s2">&#34;..only keep ipv6 localhost in /etc/hosts&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="n">_o</span><span class="o">.</span><span class="n">add_option</span><span class="p">(</span><span class="s2">&#34;-1&#34;</span><span class="p">,</span> <span class="s2">&#34;--init&#34;</span><span class="p">,</span> <span class="n">action</span><span class="o">=</span><span class="s2">&#34;store_true&#34;</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                  <span class="n">help</span><span class="o">=</span><span class="s2">&#34;..keep running as init-process (default if PID 1)&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="n">opt</span><span class="p">,</span> <span class="n">args</span> <span class="o">=</span> <span class="n">_o</span><span class="o">.</span><span class="n">parse_args</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">    <span class="n">logging</span><span class="o">.</span><span class="n">basicConfig</span><span class="p">(</span><span class="n">level</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">logging</span><span class="o">.</span><span class="n">FATAL</span> <span class="o">-</span> <span class="mi">10</span> <span class="o">*</span> <span class="n">opt</span><span class="o">.</span><span class="n">verbose</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">    <span class="n">logg</span><span class="o">.</span><span class="n">setLevel</span><span class="p">(</span><span class="nb">max</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">logging</span><span class="o">.</span><span class="n">ERROR</span> <span class="o">-</span> <span class="mi">10</span> <span class="o">*</span> <span class="n">opt</span><span class="o">.</span><span class="n">verbose</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">    <span class="c1">#</span>
</span></span><span class="line"><span class="cl">    <span class="n">_extra_vars</span> <span class="o">=</span> <span class="n">opt</span><span class="o">.</span><span class="n">extra_vars</span>
</span></span><span class="line"><span class="cl">    <span class="n">_force</span> <span class="o">=</span> <span class="n">opt</span><span class="o">.</span><span class="n">force</span>
</span></span><span class="line"><span class="cl">    <span class="n">_full</span> <span class="o">=</span> <span class="n">opt</span><span class="o">.</span><span class="n">full</span>
</span></span><span class="line"><span class="cl">    <span class="n">_log_lines</span> <span class="o">=</span> <span class="n">opt</span><span class="o">.</span><span class="n">lines</span>
</span></span><span class="line"><span class="cl">    <span class="n">_no_pager</span> <span class="o">=</span> <span class="n">opt</span><span class="o">.</span><span class="n">no_pager</span>
</span></span><span class="line"><span class="cl">    <span class="n">_no_reload</span> <span class="o">=</span> <span class="n">opt</span><span class="o">.</span><span class="n">no_reload</span>
</span></span><span class="line"><span class="cl">    <span class="n">_no_legend</span> <span class="o">=</span> <span class="n">opt</span><span class="o">.</span><span class="n">no_legend</span>
</span></span><span class="line"><span class="cl">    <span class="n">_no_ask_password</span> <span class="o">=</span> <span class="n">opt</span><span class="o">.</span><span class="n">no_ask_password</span>
</span></span><span class="line"><span class="cl">    <span class="n">_now</span> <span class="o">=</span> <span class="n">opt</span><span class="o">.</span><span class="n">now</span>
</span></span><span class="line"><span class="cl">    <span class="n">_preset_mode</span> <span class="o">=</span> <span class="n">opt</span><span class="o">.</span><span class="n">preset_mode</span>
</span></span><span class="line"><span class="cl">    <span class="n">_quiet</span> <span class="o">=</span> <span class="n">opt</span><span class="o">.</span><span class="n">quiet</span>
</span></span><span class="line"><span class="cl">    <span class="n">_root</span> <span class="o">=</span> <span class="n">opt</span><span class="o">.</span><span class="n">root</span>
</span></span><span class="line"><span class="cl">    <span class="n">_show_all</span> <span class="o">=</span> <span class="n">opt</span><span class="o">.</span><span class="n">show_all</span>
</span></span><span class="line"><span class="cl">    <span class="n">_only_state</span> <span class="o">=</span> <span class="n">opt</span><span class="o">.</span><span class="n">only_state</span>
</span></span><span class="line"><span class="cl">    <span class="n">_only_type</span> <span class="o">=</span> <span class="n">opt</span><span class="o">.</span><span class="n">only_type</span>
</span></span><span class="line"><span class="cl">    <span class="n">_only_property</span> <span class="o">=</span> <span class="n">opt</span><span class="o">.</span><span class="n">only_property</span>
</span></span><span class="line"><span class="cl">    <span class="n">_only_what</span> <span class="o">=</span> <span class="n">opt</span><span class="o">.</span><span class="n">only_what</span>
</span></span><span class="line"><span class="cl">    <span class="n">FORCE_IPV4</span> <span class="o">=</span> <span class="n">opt</span><span class="o">.</span><span class="n">ipv4</span>
</span></span><span class="line"><span class="cl">    <span class="n">FORCE_IPV6</span> <span class="o">=</span> <span class="n">opt</span><span class="o">.</span><span class="n">ipv6</span>
</span></span><span class="line"><span class="cl">    <span class="c1"># being PID 1 (or 0) in a container will imply --init</span>
</span></span><span class="line"><span class="cl">    <span class="n">_pid</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">getpid</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">    <span class="n">_init</span> <span class="o">=</span> <span class="n">opt</span><span class="o">.</span><span class="n">init</span> <span class="ow">or</span> <span class="n">_pid</span> <span class="ow">in</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span>
</span></span><span class="line"><span class="cl">    <span class="n">_user_mode</span> <span class="o">=</span> <span class="n">opt</span><span class="o">.</span><span class="n">user</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">geteuid</span><span class="p">()</span> <span class="ow">and</span> <span class="n">_pid</span> <span class="ow">in</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">]:</span>
</span></span><span class="line"><span class="cl">        <span class="n">_user_mode</span> <span class="o">=</span> <span class="kc">True</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="n">opt</span><span class="o">.</span><span class="n">system</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">        <span class="n">_user_mode</span> <span class="o">=</span> <span class="kc">False</span> <span class="c1"># override --user</span>
</span></span><span class="line"><span class="cl">    <span class="c1">#</span>
</span></span><span class="line"><span class="cl">    <span class="k">for</span> <span class="n">setting</span> <span class="ow">in</span> <span class="n">opt</span><span class="o">.</span><span class="n">config</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">        <span class="n">nam</span><span class="p">,</span> <span class="n">val</span> <span class="o">=</span> <span class="n">setting</span><span class="p">,</span> <span class="s2">&#34;1&#34;</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="s2">&#34;=&#34;</span> <span class="ow">in</span> <span class="n">setting</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">            <span class="n">nam</span><span class="p">,</span> <span class="n">val</span> <span class="o">=</span> <span class="n">setting</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&#34;=&#34;</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="k">elif</span> <span class="n">nam</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s2">&#34;no-&#34;</span><span class="p">)</span> <span class="ow">or</span> <span class="n">nam</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s2">&#34;NO-&#34;</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">            <span class="n">nam</span><span class="p">,</span> <span class="n">val</span> <span class="o">=</span> <span class="n">nam</span><span class="p">[</span><span class="mi">3</span><span class="p">:],</span> <span class="s2">&#34;0&#34;</span>
</span></span><span class="line"><span class="cl">        <span class="k">elif</span> <span class="n">nam</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s2">&#34;No&#34;</span><span class="p">)</span> <span class="ow">or</span> <span class="n">nam</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s2">&#34;NO&#34;</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">            <span class="n">nam</span><span class="p">,</span> <span class="n">val</span> <span class="o">=</span> <span class="n">nam</span><span class="p">[</span><span class="mi">2</span><span class="p">:],</span> <span class="s2">&#34;0&#34;</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="n">nam</span> <span class="ow">in</span> <span class="nb">globals</span><span class="p">():</span>
</span></span><span class="line"><span class="cl">            <span class="n">old</span> <span class="o">=</span> <span class="nb">globals</span><span class="p">()[</span><span class="n">nam</span><span class="p">]</span>
</span></span><span class="line"><span class="cl">            <span class="k">if</span> <span class="n">old</span> <span class="ow">is</span> <span class="kc">False</span> <span class="ow">or</span> <span class="n">old</span> <span class="ow">is</span> <span class="kc">True</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">                <span class="n">logg</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&#34;yes </span><span class="si">%s</span><span class="s2">=</span><span class="si">%s</span><span class="s2">&#34;</span><span class="p">,</span> <span class="n">nam</span><span class="p">,</span> <span class="n">val</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">                <span class="nb">globals</span><span class="p">()[</span><span class="n">nam</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">val</span> <span class="ow">in</span> <span class="p">(</span><span class="s2">&#34;true&#34;</span><span class="p">,</span> <span class="s2">&#34;True&#34;</span><span class="p">,</span> <span class="s2">&#34;TRUE&#34;</span><span class="p">,</span> <span class="s2">&#34;yes&#34;</span><span class="p">,</span> <span class="s2">&#34;y&#34;</span><span class="p">,</span> <span class="s2">&#34;Y&#34;</span><span class="p">,</span> <span class="s2">&#34;YES&#34;</span><span class="p">,</span> <span class="s2">&#34;1&#34;</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">                <span class="n">logg</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&#34;... _show_all=</span><span class="si">%s</span><span class="s2">&#34;</span><span class="p">,</span> <span class="n">_show_all</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">            <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">old</span><span class="p">,</span> <span class="nb">float</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">                <span class="n">logg</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&#34;num </span><span class="si">%s</span><span class="s2">=</span><span class="si">%s</span><span class="s2">&#34;</span><span class="p">,</span> <span class="n">nam</span><span class="p">,</span> <span class="n">val</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">                <span class="nb">globals</span><span class="p">()[</span><span class="n">nam</span><span class="p">]</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">val</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">                <span class="n">logg</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&#34;... MinimumYield=</span><span class="si">%s</span><span class="s2">&#34;</span><span class="p">,</span> <span class="n">MinimumYield</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">            <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">old</span><span class="p">,</span> <span class="nb">int</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">                <span class="n">logg</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&#34;int </span><span class="si">%s</span><span class="s2">=</span><span class="si">%s</span><span class="s2">&#34;</span><span class="p">,</span> <span class="n">nam</span><span class="p">,</span> <span class="n">val</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">                <span class="nb">globals</span><span class="p">()[</span><span class="n">nam</span><span class="p">]</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">val</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">                <span class="n">logg</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&#34;... InitLoopSleep=</span><span class="si">%s</span><span class="s2">&#34;</span><span class="p">,</span> <span class="n">InitLoopSleep</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">            <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">old</span><span class="p">,</span> <span class="n">basestring</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">                <span class="n">logg</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&#34;str </span><span class="si">%s</span><span class="s2">=</span><span class="si">%s</span><span class="s2">&#34;</span><span class="p">,</span> <span class="n">nam</span><span class="p">,</span> <span class="n">val</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">                <span class="nb">globals</span><span class="p">()[</span><span class="n">nam</span><span class="p">]</span> <span class="o">=</span> <span class="n">val</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">                <span class="n">logg</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&#34;... SysInitTarget=</span><span class="si">%s</span><span class="s2">&#34;</span><span class="p">,</span> <span class="n">SysInitTarget</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">            <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">old</span><span class="p">,</span> <span class="nb">list</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">                <span class="n">logg</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&#34;str </span><span class="si">%s</span><span class="s2">+=[</span><span class="si">%s</span><span class="s2">]&#34;</span><span class="p">,</span> <span class="n">nam</span><span class="p">,</span> <span class="n">val</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">                <span class="nb">globals</span><span class="p">()[</span><span class="n">nam</span><span class="p">]</span> <span class="o">+=</span> <span class="n">val</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&#34;,&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">                <span class="n">logg</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&#34;... _extra_vars=</span><span class="si">%s</span><span class="s2">&#34;</span><span class="p">,</span> <span class="n">_extra_vars</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">            <span class="k">else</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">                <span class="n">logg</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&#34;(ignored) unknown target type -c &#39;</span><span class="si">%s</span><span class="s2">&#39; : </span><span class="si">%s</span><span class="s2">&#34;</span><span class="p">,</span> <span class="n">nam</span><span class="p">,</span> <span class="nb">type</span><span class="p">(</span><span class="n">old</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">        <span class="k">else</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">            <span class="n">logg</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&#34;(ignored) unknown target config -c &#39;</span><span class="si">%s</span><span class="s2">&#39; : no such variable&#34;</span><span class="p">,</span> <span class="n">nam</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="c1">#</span>
</span></span><span class="line"><span class="cl">    <span class="n">systemctl_debug_log</span> <span class="o">=</span> <span class="n">os_path</span><span class="p">(</span><span class="n">_root</span><span class="p">,</span> <span class="n">expand_path</span><span class="p">(</span><span class="n">SYSTEMCTL_DEBUG_LOG</span><span class="p">,</span> <span class="ow">not</span> <span class="n">_user_mode</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">    <span class="n">systemctl_extra_log</span> <span class="o">=</span> <span class="n">os_path</span><span class="p">(</span><span class="n">_root</span><span class="p">,</span> <span class="n">expand_path</span><span class="p">(</span><span class="n">SYSTEMCTL_EXTRA_LOG</span><span class="p">,</span> <span class="ow">not</span> <span class="n">_user_mode</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">access</span><span class="p">(</span><span class="n">systemctl_extra_log</span><span class="p">,</span> <span class="n">os</span><span class="o">.</span><span class="n">W_OK</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">        <span class="n">loggfile</span> <span class="o">=</span> <span class="n">logging</span><span class="o">.</span><span class="n">FileHandler</span><span class="p">(</span><span class="n">systemctl_extra_log</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="n">loggfile</span><span class="o">.</span><span class="n">setFormatter</span><span class="p">(</span><span class="n">logging</span><span class="o">.</span><span class="n">Formatter</span><span class="p">(</span><span class="s2">&#34;</span><span class="si">%(asctime)s</span><span class="s2"> </span><span class="si">%(levelname)s</span><span class="s2"> </span><span class="si">%(message)s</span><span class="s2">&#34;</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">        <span class="n">logg</span><span class="o">.</span><span class="n">addHandler</span><span class="p">(</span><span class="n">loggfile</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="n">logg</span><span class="o">.</span><span class="n">setLevel</span><span class="p">(</span><span class="nb">max</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">logging</span><span class="o">.</span><span class="n">INFO</span> <span class="o">-</span> <span class="mi">10</span> <span class="o">*</span> <span class="n">opt</span><span class="o">.</span><span class="n">verbose</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">access</span><span class="p">(</span><span class="n">systemctl_debug_log</span><span class="p">,</span> <span class="n">os</span><span class="o">.</span><span class="n">W_OK</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">        <span class="n">loggfile</span> <span class="o">=</span> <span class="n">logging</span><span class="o">.</span><span class="n">FileHandler</span><span class="p">(</span><span class="n">systemctl_debug_log</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="n">loggfile</span><span class="o">.</span><span class="n">setFormatter</span><span class="p">(</span><span class="n">logging</span><span class="o">.</span><span class="n">Formatter</span><span class="p">(</span><span class="s2">&#34;</span><span class="si">%(asctime)s</span><span class="s2"> </span><span class="si">%(levelname)s</span><span class="s2"> </span><span class="si">%(message)s</span><span class="s2">&#34;</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">        <span class="n">logg</span><span class="o">.</span><span class="n">addHandler</span><span class="p">(</span><span class="n">loggfile</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="n">logg</span><span class="o">.</span><span class="n">setLevel</span><span class="p">(</span><span class="n">logging</span><span class="o">.</span><span class="n">DEBUG</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="c1">#</span>
</span></span><span class="line"><span class="cl">    <span class="n">print_begin</span><span class="p">(</span><span class="n">sys</span><span class="o">.</span><span class="n">argv</span><span class="p">,</span> <span class="n">args</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="c1">#</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="n">opt</span><span class="o">.</span><span class="n">version</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">        <span class="n">args</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&#34;version&#34;</span><span class="p">]</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="ow">not</span> <span class="n">args</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="n">_init</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">            <span class="n">args</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&#34;default&#34;</span><span class="p">]</span>
</span></span><span class="line"><span class="cl">        <span class="k">else</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">            <span class="n">args</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&#34;list-units&#34;</span><span class="p">]</span>
</span></span><span class="line"><span class="cl">    <span class="n">print_begin2</span><span class="p">(</span><span class="n">args</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="n">command</span> <span class="o">=</span> <span class="n">args</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
</span></span><span class="line"><span class="cl">    <span class="n">modules</span> <span class="o">=</span> <span class="n">args</span><span class="p">[</span><span class="mi">1</span><span class="p">:]</span>
</span></span><span class="line"><span class="cl">    <span class="k">try</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">        <span class="n">modules</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="s2">&#34;service&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="k">except</span> <span class="ne">ValueError</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">        <span class="k">pass</span>
</span></span><span class="line"><span class="cl">    <span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">(</span><span class="n">runcommand</span><span class="p">(</span><span class="n">command</span><span class="p">,</span> <span class="o">*</span><span class="n">modules</span><span class="p">))</span>
</span></span></code></pre></td></tr></table>
</div>
</div>]]></description></item><item><title>Database Penetration Testing 数据库渗透测</title><link>https://yangyingchao.github.io/2025/12/database-penetration-testing/</link><pubDate>Tue, 09 Dec 2025 00:00:00 +0000</pubDate><author>yc</author><guid>https://yangyingchao.github.io/2025/12/database-penetration-testing/</guid><description><![CDATA[<div class="ox-hugo-toc toc has-section-numbers">
<div class="heading">Table of Contents</div>
<ul>
<li><span class="section-num">1</span> <a href="#what-is-database-penetration-testing-%e6%95%b0%e6%8d%ae%e5%ba%93%e6%b8%97%e9%80%8f%e6%b5%8b%e8%af%95%e6%98%af%e4%bb%80%e4%b9%88" rel="">What is Database Penetration Testing? 数据库渗透测试是什么？</a></li>
<li><span class="section-num">2</span> <a href="#why-is-database-penetration-testing-important-%e6%95%b0%e6%8d%ae%e5%ba%93%e6%b8%97%e9%80%8f%e6%b5%8b%e8%af%95%e4%b8%ba%e4%bd%95%e9%87%8d%e8%a6%81" rel="">Why is database penetration testing important?数据库渗透测试为何重要？</a></li>
<li><span class="section-num">3</span> <a href="#types-of-vulnerabilities-that-affect-database-system-%e5%bd%b1%e5%93%8d%e6%95%b0%e6%8d%ae%e5%ba%93%e7%b3%bb%e7%bb%9f%e7%9a%84%e6%bc%8f%e6%b4%9e%e7%b1%bb%e5%9e%8b" rel="">Types of Vulnerabilities that affect database system 影响数据库系统的漏洞类型</a></li>
<li><span class="section-num">4</span> <a href="#how-to-perform-database-penetration-testing-%e5%a6%82%e4%bd%95%e6%89%a7%e8%a1%8c%e6%95%b0%e6%8d%ae%e5%ba%93%e6%b8%97%e9%80%8f%e6%b5%8b%e8%af%95" rel="">How to Perform Database Penetration Testing? 如何执行数据库渗透测试？</a>
<ul>
<li><span class="section-num">4.1</span> <a href="#planning-and-preparation-%e8%ae%a1%e5%88%92%e4%b8%8e%e5%87%86%e5%a4%87" rel="">Planning and Preparation 计划与准备</a></li>
<li><span class="section-num">4.2</span> <a href="#information-gathering-and-reconnaissance-%e4%bf%a1%e6%81%af%e6%94%b6%e9%9b%86%e4%b8%8e%e4%be%a6%e6%9f%a5" rel="">Information Gathering and Reconnaissance 信息收集与侦查</a></li>
<li><span class="section-num">4.3</span> <a href="#vulnerability-assessment-%e6%bc%8f%e6%b4%9e%e8%af%84%e4%bc%b0" rel="">Vulnerability Assessment 漏洞评估</a></li>
<li><span class="section-num">4.4</span> <a href="#exploitatio-%e6%bc%8f%e6%b4%9e%e5%88%a9%e7%94%a8" rel="">Exploitatio 漏洞利用</a></li>
<li><span class="section-num">4.5</span> <a href="#post-exploitation-%e5%90%8e%e6%9c%9f%e5%88%a9%e7%94%a8" rel="">Post-Exploitation 后期利用</a></li>
<li><span class="section-num">4.6</span> <a href="#analysis-and-reporting-%e5%88%86%e6%9e%90%e4%b8%8e%e6%8a%a5%e5%91%8a" rel="">Analysis and Reporting 分析与报告</a></li>
<li><span class="section-num">4.7</span> <a href="#remediation-support-and-retesting-%e8%a1%a5%e6%95%91%e6%94%af%e6%8c%81%e4%b8%8e%e9%87%8d%e6%96%b0%e6%b5%8b%e8%af%95" rel="">Remediation Support and Retesting 补救支持与重新测试</a></li>
</ul>
</li>
<li><span class="section-num">5</span> <a href="#database-security-testing-tools-%e6%95%b0%e6%8d%ae%e5%ba%93%e5%ae%89%e5%85%a8%e6%b5%8b%e8%af%95%e5%b7%a5%e5%85%b7" rel="">Database Security Testing Tools 数据库安全测试工具</a></li>
<li><span class="section-num">6</span> <a href="#database-penetration-testing-checklist-%e6%95%b0%e6%8d%ae%e5%ba%93%e6%b8%97%e9%80%8f%e6%b5%8b%e8%af%95%e6%a3%80%e6%9f%a5%e8%a1%a8" rel="">Database Penetration Testing Checklist 数据库渗透测试检查表</a></li>
</ul>
</div>
<!--endtoc-->
<p>本文为摘录(或转载)，侵删，原文为： <a href="https://thecyphere.com/blog/database-penetration-testing/" target="_blank" rel="noopener noreffer ">https://thecyphere.com/blog/database-penetration-testing/</a></p>]]></description></item><item><title>Penetration Testing_ Discovering Network Vulnerabilities</title><link>https://yangyingchao.github.io/2025/12/penetration-testing_-discovering-network-vulnerabilities/</link><pubDate>Tue, 09 Dec 2025 00:00:00 +0000</pubDate><author>yc</author><guid>https://yangyingchao.github.io/2025/12/penetration-testing_-discovering-network-vulnerabilities/</guid><description><![CDATA[<div class="ox-hugo-toc toc has-section-numbers">
<div class="heading">Table of Contents</div>
<ul>
<li><span class="section-num">1</span> <a href="#different-methods-and-types-of-penetration-testing-%e6%b8%97%e9%80%8f%e6%b5%8b%e8%af%95%e7%9a%84%e4%b8%8d%e5%90%8c%e7%b1%bb%e5%9e%8b%e5%92%8c%e6%96%b9%e6%b3%95" rel="">Different Methods and Types of Penetration Testing 渗透测试的不同类型和方法</a></li>
<li><span class="section-num">2</span> <a href="#comprehensive-and-limited-testing-%e5%85%a8%e9%9d%a2%e4%b8%8e%e6%9c%89%e9%99%90%e6%b5%8b%e8%af%95" rel="">Comprehensive &amp; Limited Testing 全面与有限测试</a></li>
<li><span class="section-num">3</span> <a href="#red-and-blue-teams-%e7%ba%a2%e9%98%9f%e4%b8%8e%e8%93%9d%e9%98%9f" rel="">Red &amp; Blue Teams 红队与蓝队</a></li>
<li><span class="section-num">4</span> <a href="#starting-a-pentesting-program" rel="">Starting a Pentesting Program</a></li>
<li><span class="section-num">5</span> <a href="#penetration-testing-methodologies-%e6%b8%97%e9%80%8f%e6%b5%8b%e8%af%95%e6%96%b9%e6%b3%95%e8%ae%ba" rel="">Penetration Testing Methodologies 渗透测试方法论</a></li>
<li><span class="section-num">6</span> <a href="#top-pentesting-tools" rel="">Top Pentesting Tools</a></li>
<li><span class="section-num">7</span> <a href="#what-to-do-after-a-penetration-test" rel="">What to Do After a Penetration Test</a></li>
</ul>
</div>
<!--endtoc-->
<p>本文为摘录(或转载)，侵删，原文为： <a href="https://www.esecurityplanet.com/networks/penetration-testing/" target="_blank" rel="noopener noreffer ">https://www.esecurityplanet.com/networks/penetration-testing/</a></p>]]></description></item><item><title>Pre-engagement - The Penetration Testing Execution Standard</title><link>https://yangyingchao.github.io/2025/12/pre-engagement---the-penetration-testing-execution-standard/</link><pubDate>Tue, 09 Dec 2025 00:00:00 +0000</pubDate><author>yc</author><guid>https://yangyingchao.github.io/2025/12/pre-engagement---the-penetration-testing-execution-standard/</guid><description><![CDATA[<div class="ox-hugo-toc toc has-section-numbers">
<div class="heading">Table of Contents</div>
<ul>
<li><span class="section-num">1</span> <a href="#overview" rel="">Overview</a></li>
<li><span class="section-num">2</span> <a href="#introduction-to-scope-%e8%8c%83%e5%9b%b4%e7%9a%84%e4%bb%8b%e7%bb%8d" rel="">Introduction to Scope 范围的介绍</a></li>
<li><span class="section-num">3</span> <a href="#metrics-for-time-estimation-%e6%97%b6%e9%97%b4%e4%bc%b0%e7%ae%97%e6%8c%87%e6%a0%87" rel="">Metrics for Time Estimation 时间估算指标</a></li>
<li><span class="section-num">4</span> <a href="#questionnaires-%e9%97%ae%e5%8d%b7%e8%b0%83%e6%9f%a5" rel="">Questionnaires 问卷调查</a></li>
<li><span class="section-num">5</span> <a href="#general-questions-%e4%b8%80%e8%88%ac%e9%97%ae%e9%a2%98" rel="">General Questions 一般问题</a>
<ul>
<li><span class="section-num">5.1</span> <a href="#network-penetration-test" rel="">Network Penetration Test</a></li>
<li><span class="section-num">5.2</span> <a href="#web-application-penetration-test" rel="">Web Application Penetration Test</a></li>
<li><span class="section-num">5.3</span> <a href="#wireless-network-penetration-test" rel="">Wireless Network Penetration Test</a></li>
<li><span class="section-num">5.4</span> <a href="#physical-penetration-test" rel="">Physical Penetration Test</a></li>
<li><span class="section-num">5.5</span> <a href="#social-engineering" rel="">Social Engineering</a></li>
<li><span class="section-num">5.6</span> <a href="#questions-for-business-unit-managers" rel="">Questions for Business Unit Managers</a></li>
<li><span class="section-num">5.7</span> <a href="#questions-for-systems-administrators" rel="">Questions for Systems Administrators</a></li>
</ul>
</li>
</ul>
</div>
<!--endtoc-->
<p>本文为摘录(或转载)，侵删，原文为： <a href="http://www.pentest-standard.org/index.php/Pre-engagement" target="_blank" rel="noopener noreffer ">http://www.pentest-standard.org/index.php/Pre-engagement</a></p>]]></description></item><item><title>渗透测试执行标准 The Penetration Testing Execution Standard</title><link>https://yangyingchao.github.io/2025/12/%E6%B8%97%E9%80%8F%E6%B5%8B%E8%AF%95%E6%89%A7%E8%A1%8C%E6%A0%87%E5%87%86-the-penetration-testing-execution-standard/</link><pubDate>Tue, 09 Dec 2025 00:00:00 +0000</pubDate><author>yc</author><guid>https://yangyingchao.github.io/2025/12/%E6%B8%97%E9%80%8F%E6%B5%8B%E8%AF%95%E6%89%A7%E8%A1%8C%E6%A0%87%E5%87%86-the-penetration-testing-execution-standard/</guid><description><![CDATA[<div class="ox-hugo-toc toc has-section-numbers">
<div class="heading">Table of Contents</div>
<ul>
<li><span class="section-num">1</span> <a href="#high-level-organization-of-the-standard" rel="">High Level Organization of the Standard</a></li>
</ul>
</div>
<!--endtoc-->
<p>本文为摘录(或转载)，侵删，原文为： <a href="http://www.pentest-standard.org/index.php/Main_Page" target="_blank" rel="noopener noreffer ">http://www.pentest-standard.org/index.php/Main_Page</a></p>
<h2 id="high-level-organization-of-the-standard"><span class="section-num">1</span> High Level Organization of the Standard</h2>
<p>渗透测试执行标准 （Penetration Testing Execution Standard, PTES）由七（7）个主要部分组成。这些部分涵盖了与渗透测试相关的方方面面——从初步沟通和渗透测试的理由开始，通过情报收集和威胁建模阶段，测试人员在幕后工作以更好地理解被测试的组织，再到漏洞分析、利用和利用后阶段，在这些阶段中，测试人员的技术安全专业知识与业务理解相结合，最后到报告阶段，捕捉整个过程，以一种对客户有意义且提供最大价值的方式呈现。</p>]]></description></item><item><title>寻路中国_从乡村到工厂的自驾之旅-[美] 彼得·海斯勒;李雪顺</title><link>https://yangyingchao.github.io/2025/12/%E7%AC%94%E8%AE%B0%E5%AF%BB%E8%B7%AF%E4%B8%AD%E5%9B%BD_%E4%BB%8E%E4%B9%A1%E6%9D%91%E5%88%B0%E5%B7%A5%E5%8E%82%E7%9A%84%E8%87%AA%E9%A9%BE%E4%B9%8B%E6%97%85-%E7%BE%8E-%E5%BD%BC%E5%BE%97%E6%B5%B7%E6%96%AF%E5%8B%92%E6%9D%8E%E9%9B%AA%E9%A1%BA/</link><pubDate>Mon, 08 Dec 2025 00:00:00 +0000</pubDate><author>yc</author><guid>https://yangyingchao.github.io/2025/12/%E7%AC%94%E8%AE%B0%E5%AF%BB%E8%B7%AF%E4%B8%AD%E5%9B%BD_%E4%BB%8E%E4%B9%A1%E6%9D%91%E5%88%B0%E5%B7%A5%E5%8E%82%E7%9A%84%E8%87%AA%E9%A9%BE%E4%B9%8B%E6%97%85-%E7%BE%8E-%E5%BD%BC%E5%BE%97%E6%B5%B7%E6%96%AF%E5%8B%92%E6%9D%8E%E9%9B%AA%E9%A1%BA/</guid><description><![CDATA[<p>这个老外很特别，跟普通国人一住就是数年，可以跟着去上坟，为别人孩子健康奔波，深谙国人处事之道，什么都明白，但不会说破。。。</p>
<ul>
<li>
<p>572-575, 标注, 2025 年 12 月 7 日星期日 下午 10:14:16</p>]]></description></item><item><title>二千年间-胡绳</title><link>https://yangyingchao.github.io/2025/12/%E7%AC%94%E8%AE%B0%E4%BA%8C%E5%8D%83%E5%B9%B4%E9%97%B4-%E8%83%A1%E7%BB%B3/</link><pubDate>Sat, 06 Dec 2025 00:00:00 +0000</pubDate><author>yc</author><guid>https://yangyingchao.github.io/2025/12/%E7%AC%94%E8%AE%B0%E4%BA%8C%E5%8D%83%E5%B9%B4%E9%97%B4-%E8%83%A1%E7%BB%B3/</guid><description></description></item></channel></rss>