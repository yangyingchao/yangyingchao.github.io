<!doctype html><html lang=zh-cn dir=auto><head><meta charset=utf-8><meta http-equiv=x-ua-compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no"><meta name=robots content="index, follow"><title>ByteHTAP: ByteDance’s HTAP System with High Data Freshness and Strong Data Consistency | MyNotes</title><meta name=keywords content="HTAP,ByteDance"><meta name=description content="1 INTRODUCTION 2 RELATED WORK 3 SYSTEM ARCHITECTURE 3.1 ByteNDB Overview 3.2 System Overview 3.3 Metadata Service 3.4 OLAP Engine 4 SHARED STORAGE WITH HIGH DATA FRESHNESS 4.1 Delta Store 4.2 Base Store 4.3 High Data Freshness 5 LSN-BASED STRONG DATA CONSISTENCY 6 OLAP QUERY PERFORMANCE OPTIMIZATION 6.1 Delete Optimization for Scans 6.2 Computation Pushdown to Storage Engine 6.3 OLAP Query Engine Optimization 本文为摘录，原"><meta name=author content><link rel=canonical href=https://yangyingchao.github.io/posts/bytehtap-bytedances-htap-system-with-high-data-freshness-and-strong-data-consistency/><link crossorigin=anonymous href=/assets/css/stylesheet.6a98292fb8fa8cf0f3ba4042d4b75515c04267550f3ad49ff6271b5af9562443.css integrity="sha256-apgpL7j6jPDzukBC1LdVFcBCZ1UPOtSf9icbWvlWJEM=" rel="preload stylesheet" as=style><script defer crossorigin=anonymous src=/assets/js/highlight.f413e19d0714851f6474e7ee9632408e58ac146fbdbe62747134bea2fa3415e0.js integrity="sha256-9BPhnQcUhR9kdOfuljJAjlisFG+9vmJ0cTS+ovo0FeA=" onload=hljs.initHighlightingOnLoad()></script>
<link rel=icon href=https://yangyingchao.github.io/favicon.ico><link rel=icon type=image/png sizes=16x16 href=https://yangyingchao.github.io/favicon-16x16.png><link rel=icon type=image/png sizes=32x32 href=https://yangyingchao.github.io/favicon-32x32.png><link rel=apple-touch-icon href=https://yangyingchao.github.io/apple-touch-icon.png><link rel=mask-icon href=https://yangyingchao.github.io/safari-pinned-tab.svg><meta name=theme-color content="#2e2e33"><meta name=msapplication-TileColor content="#2e2e33"><noscript><style>#theme-toggle,.top-link{display:none}</style><style>@media(prefers-color-scheme:dark){:root{--theme:rgb(29, 30, 32);--entry:rgb(46, 46, 51);--primary:rgb(218, 218, 219);--secondary:rgb(155, 156, 157);--tertiary:rgb(65, 66, 68);--content:rgb(196, 196, 197);--hljs-bg:rgb(46, 46, 51);--code-bg:rgb(55, 56, 62);--border:rgb(51, 51, 51)}.list{background:var(--theme)}.list:not(.dark)::-webkit-scrollbar-track{background:0 0}.list:not(.dark)::-webkit-scrollbar-thumb{border-color:var(--theme)}}</style></noscript><meta property="og:title" content="ByteHTAP: ByteDance’s HTAP System with High Data Freshness and Strong Data Consistency"><meta property="og:description" content="1 INTRODUCTION 2 RELATED WORK 3 SYSTEM ARCHITECTURE 3.1 ByteNDB Overview 3.2 System Overview 3.3 Metadata Service 3.4 OLAP Engine 4 SHARED STORAGE WITH HIGH DATA FRESHNESS 4.1 Delta Store 4.2 Base Store 4.3 High Data Freshness 5 LSN-BASED STRONG DATA CONSISTENCY 6 OLAP QUERY PERFORMANCE OPTIMIZATION 6.1 Delete Optimization for Scans 6.2 Computation Pushdown to Storage Engine 6.3 OLAP Query Engine Optimization 本文为摘录，原"><meta property="og:type" content="article"><meta property="og:url" content="https://yangyingchao.github.io/posts/bytehtap-bytedances-htap-system-with-high-data-freshness-and-strong-data-consistency/"><meta property="article:section" content="posts"><meta name=twitter:card content="summary"><meta name=twitter:title content="ByteHTAP: ByteDance’s HTAP System with High Data Freshness and Strong Data Consistency"><meta name=twitter:description content="1 INTRODUCTION 2 RELATED WORK 3 SYSTEM ARCHITECTURE 3.1 ByteNDB Overview 3.2 System Overview 3.3 Metadata Service 3.4 OLAP Engine 4 SHARED STORAGE WITH HIGH DATA FRESHNESS 4.1 Delta Store 4.2 Base Store 4.3 High Data Freshness 5 LSN-BASED STRONG DATA CONSISTENCY 6 OLAP QUERY PERFORMANCE OPTIMIZATION 6.1 Delete Optimization for Scans 6.2 Computation Pushdown to Storage Engine 6.3 OLAP Query Engine Optimization 本文为摘录，原"><script type=application/ld+json>{"@context":"https://schema.org","@type":"BreadcrumbList","itemListElement":[{"@type":"ListItem","position":2,"name":"Posts","item":"https://yangyingchao.github.io/posts/"},{"@type":"ListItem","position":3,"name":"ByteHTAP: ByteDance’s HTAP System with High Data Freshness and Strong Data Consistency","item":"https://yangyingchao.github.io/posts/bytehtap-bytedances-htap-system-with-high-data-freshness-and-strong-data-consistency/"}]}</script><script type=application/ld+json>{"@context":"https://schema.org","@type":"BlogPosting","headline":"ByteHTAP: ByteDance’s HTAP System with High Data Freshness and Strong Data Consistency","name":"ByteHTAP: ByteDance’s HTAP System with High Data Freshness and Strong Data Consistency","description":"1 INTRODUCTION 2 RELATED WORK 3 SYSTEM ARCHITECTURE 3.1 ByteNDB Overview 3.2 System Overview 3.3 Metadata Service 3.4 OLAP Engine 4 SHARED STORAGE WITH HIGH DATA FRESHNESS 4.1 Delta Store 4.2 Base Store 4.3 High Data Freshness 5 LSN-BASED STRONG DATA CONSISTENCY 6 OLAP QUERY PERFORMANCE OPTIMIZATION 6.1 Delete Optimization for Scans 6.2 Computation Pushdown to Storage Engine 6.3 OLAP Query Engine Optimization 本文为摘录，原","keywords":["HTAP","ByteDance"],"articleBody":" 1 INTRODUCTION 2 RELATED WORK 3 SYSTEM ARCHITECTURE 3.1 ByteNDB Overview 3.2 System Overview 3.3 Metadata Service 3.4 OLAP Engine 4 SHARED STORAGE WITH HIGH DATA FRESHNESS 4.1 Delta Store 4.2 Base Store 4.3 High Data Freshness 5 LSN-BASED STRONG DATA CONSISTENCY 6 OLAP QUERY PERFORMANCE OPTIMIZATION 6.1 Delete Optimization for Scans 6.2 Computation Pushdown to Storage Engine 6.3 OLAP Query Engine Optimization 本文为摘录，原文为： ../pdf/5/p3411-chen.pdf\nByteHTAP: an HTAP system with high data freshness and strong data consistency. 独立引擎和共享存储架构 1 INTRODUCTION 字节的实际需求： 对刚刚(sub-second, 亚秒级)导入的数据进行复杂分析 支持事务和强一致性 Build HTAP with following Global Designs: 规模大 (Large Scale) 字节的应用，有亿级的用户，需要构建分布式、实时分析系统，可以支撑 PB 级数据 实时 （Real time） 高度新数据 Highly fresh data changes 数据强一致性 根据架构，可将 HTAP 分为两类： 1 单引擎系统\n使用一个引擎，例如 SAP Hana 和 MemSQL 。 根据数据格式可以分成两类： 单一数据格式 或者 混合数据格式 2 独立引擎 使用不同的引擎来处理 AP 和 TP ，例如 WildFire 和 TiDB 根据存储结构可以分成： 独立存储 生产中使用较为广泛 数据不够“新鲜” 共享存储 字节采用了 独立引擎 + 共享存储 ： 独立引擎 开发一个能够处理 AP 和 TP 的单一引擎，工作量不小 开源的、能够很好的处理混合模型的引擎没几个 而处理单一模型的引擎则较多（开源或者闭源的） 采用独立引擎，各司其职： TP: ByteNDB AP: Apache Flink 共享存储\n字节现有的基础系统采用存储计算分离模型 ByteNDB 的架构类似于 Amazon Aurora 将 ByteNDB 的复制存储进行拓展，支持了列存，以便将变更以最小延迟在存储存传播 列存用于 OLAP 还做了一个内存中的 delta store, 用于保存最新的数据变更， 供 OLAP 使用 架构对用户透明\n用户使用一套 SQL API 来进行 AP 和 TP 的查询 由代理 （proxy） 将 SQL 自动转发给 AP 或者 TP 引擎 模块化设计，将来可以方便的将 AP 引擎换成其他引擎 仅需要实现一个存储和新引擎之间的 connector 2 RELATED WORK SAP Hana MemSQL TiDB TiKV TiFlash WildFire Spark Wiser 3 SYSTEM ARCHITECTURE 3.1 ByteNDB Overview ByteNDB 的总体架构如图 1 所示。\n一写多读 改进了 MySQL 的缓存池， 事务和锁管理 （ 所以 ByteNDB 是基于 MySQL 改的 ？）以支持 master-replica 同步 Log Store: 存储 redo log Page Store: 应用 redo log, 形成真正数据 类似 Aurora: Log is Database! 两个 Store 都是构建在分布式存储之上 3.2 System Overview ByteHTAP 的架构如图 2 所示：\n采用 独立引擎+共享存储\n一套 API， 通过 proxy 自动分发给 OLTP 或者 OLAP 引擎\nOLTP \\[\\Longrightarrow\\] ByteNDB OLAP \\[\\Longrightarrow\\] Flink Proxy 规则\n交由 OLTP: DML, DDL, 简单查询 其他需要使用 TP 表的查询 交由 OLAP: 复杂查询 （join, aggr） 每个表必须有一个主键：\n列存要按照该建进行排序 主键值可以通过 DML 更改 （受 OLTP 引擎自动提供的约束限制） 用户可对对列存表指定分区列\n当前仅支持哈希分区 数据一致性\n每个 DML \u0026 DDL 都有一个唯一的 LSN 同一事务中的语句包装在一起 元数据服务向 OLAP 引擎提供全局已提交的 LSN 任何小于此 LSN 的 LSN 都应该已经被 OLAP 所接收并持久化 OLAP 的查询会被赋予一个基于全局已提交 LSN 生成的只读 LSN 用于查询 data changes 通常控制在 1 秒以内。 目前 不支持混合了 DML 与只读查询的事务 无分布式事务支持\n3.3 Metadata Service 中心化的元数据服务 (Metadata Service MDS)\n用于提供统一的服务，包括：\ncatalog 系统表 仅供 AP 使用 TP 自行存储 跨 AP 和 TP 的分区信息 供 AP 和 TP 所使用的数据统计信息 减少其他 ByteHTAP 模块的状态信息 提供全局已提交 LSN 用于 OLAP 查询作为只读 LSN 使用 MDS 基于 Zookeeper 构建，支持高可用\nMDS 的客户端\n集成进了 OLAP 计算引擎以及存储服务 以便和 MDS 交互，获取多版本的元数据 集成进了 DDL 解析器 MDS 信息来源： DDL 逻辑日志：\n由 OLTP 引擎生成，包含元数据变更信息 由复制框架中继传播给 TP 的 Page Store 和 AP 的 Column Store 以及 MDS MDS 对逻辑日志进行解析，由此产生系统表和分区 schema，并进行序列化和持久化，向外提供信息 3.4 OLAP Engine 使用 Apache Flink 作为 AP 的计算引擎\n评估过 Spark, Flink, Presto TPC-H 和 TPC-DS 性能相近 选用 Flink: 公司内使用广泛 支持流式查询 （Streaming Queries） Flink 结合列存，形成计算引擎 Data Connector\n用于高效、并行读取列存数据 支持聚集和扫描下推 支持分区修正 （partition prune），过滤掉不需要的分区 4 SHARED STORAGE WITH HIGH DATA FRESHNESS 共享存储： Delta Store + Base Store Delta Store\n保存在内存中 行模式 及时应用日志（低延迟）生成新鲜数据供 OLAP 使用 Base Store\n以列存形式持久化保存 复制框架 Replication Framework\n管理 Delta Store, Base Store 和 Log Store, Page Store 4.1 Delta Store 高可用：\n分区： OLAP 表会进行分区 副本： 每个分区有三个副本 Delta Store: 每个分区的每个副本一个 Delta Store Delta Store 包含两个列表， 以逻辑日志中的 LSN 为序\nInsertion List 记录插入操作 Deletion List 记录删除操作 Delete Hash Map SCAN 操作需要访问 base store 和 delta store 来检查某一行是否已经删除 从 Deletion List 构建 Delete Hash Map, 用于加速查询 Delta Store 有四种主要的操作，且可以并行：\n日志应用 LogApply Flush 从 Delta Store 生成 Base Store Garbage Collection Scan 4.2 Base Store 持久化列存\n每个分片的每个副本创建一个 Base Store 中不保存 LSN\n优点 减少存储负担 提升 scan 和 update 的效率 缺点 只能读取 Delta Store 中保存的快照 更老的快照无法获取 Base Store 的数据\n保存格式为 Partitioned Attributes Across （PAX）\n每个 Base Store 包含多个数据块 （data blocks）\n每个数据块默认大为 32MB, 由若干行组成 数据块内部按照主键排序 内部既保存了： 块级的元数据\n行数 key range 主键构建的 BloomFilter （XXX: 这个可以考虑） 每列的统计信息：如 min/max 每一列编码后的数据 (encoded data for each column)\n仅支持 value based index\nGroom\nWhy?\n数据删除操作，仅更新 bitmap, 而不删除数据 长期操作会导致磁盘使用空间不断增长 Flush 操作产生的分区表的范围可能重叠 scan 操作需要访问多个分区，性能差 数据合并\n后台线程运行 周期性检查： 已删除的数据占比 不同数据块主键重叠 将符合上述特征的数据块进行合并 新块将不包含已删除数据 最小化重叠的主键 合并后 更新 metadata 将原 block 添加到 GC list 垃圾回收\n后台运行 定期检查 GC list 如果没有 active session 在访问，则删除之 4.3 High Data Freshness 5 LSN-BASED STRONG DATA CONSISTENCY 6 OLAP QUERY PERFORMANCE OPTIMIZATION 6.1 Delete Optimization for Scans 6.2 Computation Pushdown to Storage Engine Predicate Pushdown\nmin/max 块级过滤 减少无用 IO 延迟物化 优先计算条件列 再去读取其他列 减少 IO Aggregate Pushdown\n每个分片上先做部分聚集 (Partial Aggregate) 最后汇总二次聚集 6.3 OLAP Query Engine Optimization 对 Flink 的改进，包括：\n统计信息收集 异步读取 并行优化 ","wordCount":"2122","inLanguage":"zh-cn","datePublished":"0001-01-01T00:00:00Z","dateModified":"0001-01-01T00:00:00Z","mainEntityOfPage":{"@type":"WebPage","@id":"https://yangyingchao.github.io/posts/bytehtap-bytedances-htap-system-with-high-data-freshness-and-strong-data-consistency/"},"publisher":{"@type":"Organization","name":"MyNotes","logo":{"@type":"ImageObject","url":"https://yangyingchao.github.io/favicon.ico"}}}</script></head><body id=top><script>localStorage.getItem("pref-theme")==="dark"?document.body.classList.add("dark"):localStorage.getItem("pref-theme")==="light"?document.body.classList.remove("dark"):window.matchMedia("(prefers-color-scheme: dark)").matches&&document.body.classList.add("dark")</script><header class=header><nav class=nav><div class=logo><a href=https://yangyingchao.github.io accesskey=h title="MyNotes (Alt + H)">MyNotes</a><div class=logo-switches><button id=theme-toggle accesskey=t title="(Alt + T)"><svg id="moon" xmlns="http://www.w3.org/2000/svg" width="24" height="18" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 12.79A9 9 0 1111.21 3 7 7 0 0021 12.79z"/></svg><svg id="sun" xmlns="http://www.w3.org/2000/svg" width="24" height="18" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="5"/><line x1="12" y1="1" x2="12" y2="3"/><line x1="12" y1="21" x2="12" y2="23"/><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"/><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"/><line x1="1" y1="12" x2="3" y2="12"/><line x1="21" y1="12" x2="23" y2="12"/><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"/><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"/></svg></button></div></div><ul id=menu><li><a href=https://yangyingchao.github.io/ title=Home><span>Home</span></a></li><li><a href=https://yangyingchao.github.io/posts/ title=Archives><span>Archives</span></a></li><li><a href=https://yangyingchao.github.io/tags/ title=Tags><span>Tags</span></a></li><li><a href=https://yangyingchao.github.io/categories/ title=Categories><span>Categories</span></a></li><li><a href=https://yangyingchao.github.io/contact/ title="Contact me"><span>Contact me</span></a></li></ul></nav></header><main class=main><article class=post-single><header class=post-header><h1 class=post-title>ByteHTAP: ByteDance’s HTAP System with High Data Freshness and Strong Data Consistency</h1><div class=post-meta></div></header><div class=post-content><ul><li>1 <a href=#h:1d0256eb-7020-40a9-8734-ff2cd768b879>INTRODUCTION</a></li><li>2 <a href=#h:f8850aab-d346-4ff0-9db5-7a5014c2be57>RELATED WORK</a></li><li>3 <a href=#h:2b77a1b6-e6f1-4061-9ba0-b25ce802c414>SYSTEM ARCHITECTURE</a><ul><li>3.1 <a href=#h:12bb623b-2631-4d79-a371-c3f4e2d4f331>ByteNDB Overview</a></li><li>3.2 <a href=#h:0e2a5f9a-94a5-468d-b067-77b7e5b84e75>System Overview</a></li><li>3.3 <a href=#h:bbd56a7b-4e5b-417f-9186-7d8a6a2ea1cd>Metadata Service</a></li><li>3.4 <a href=#h:e1123c8f-6aaa-4885-b6f6-60ba97a24542>OLAP Engine</a></li></ul></li><li>4 <a href=#h:efe671ff-4fbf-4403-93e8-dace57e327e3>SHARED STORAGE WITH HIGH DATA FRESHNESS</a><ul><li>4.1 <a href=#h:a2a82346-1519-440d-a9ea-5dc25449b2bc>Delta Store</a></li><li>4.2 <a href=#h:0c98ab5d-943f-4a7d-95e6-e7c13a230012>Base Store</a></li><li>4.3 <a href=#h:bb669fd7-9dac-4593-954c-febfc556e2d9>High Data Freshness</a></li></ul></li><li>5 <a href=#h:1a6bd9a4-09ea-406c-b57d-ab9ac767366e>LSN-BASED STRONG DATA CONSISTENCY</a></li><li>6 <a href=#h:c50f0fdb-da92-467e-a262-6eaf4fe962b1>OLAP QUERY PERFORMANCE OPTIMIZATION</a><ul><li>6.1 <a href=#h:43cd5013-4a01-4792-8ddd-dad936aebd11>Delete Optimization for Scans</a></li><li>6.2 <a href=#h:6529c719-ecf6-4f88-81ca-b2b81039ac09>Computation Pushdown to Storage Engine</a></li><li>6.3 <a href=#h:c9ff9c1e-96b2-488b-94d5-3b35d3a459d7>OLAP Query Engine Optimization</a></li></ul></li></ul><p>本文为摘录，原文为： ../pdf/5/p3411-chen.pdf</p><ul><li><strong>ByteHTAP</strong>: an HTAP system with high data freshness and strong data consistency.</li><li>独立引擎和共享存储架构</li></ul><h2 id=h:1d0256eb-7020-40a9-8734-ff2cd768b879>1 INTRODUCTION<a hidden class=anchor aria-hidden=true href=#h:1d0256eb-7020-40a9-8734-ff2cd768b879>#</a></h2><ul><li>字节的实际需求：<ul><li>对刚刚(sub-second, 亚秒级)导入的数据进行复杂分析</li><li>支持事务和强一致性</li></ul></li></ul><ul><li>Build HTAP with following <strong>Global Designs</strong>:<ul><li>规模大 (Large Scale)
字节的应用，有亿级的用户，需要构建分布式、实时分析系统，可以支撑 PB 级数据</li><li>实时 （Real time）</li><li>高度新数据 Highly fresh data changes</li><li>数据强一致性</li></ul></li></ul><ul><li><p>根据架构，可将 HTAP 分为两类：
1 单引擎系统</p><ul><li>使用一个引擎，例如 SAP Hana 和 MemSQL 。</li><li>根据数据格式可以分成两类：<ul><li>单一数据格式 或者</li><li>混合数据格式</li></ul></li></ul><p>2 独立引擎</p><ul><li>使用不同的引擎来处理 AP 和 TP ，例如 WildFire 和 TiDB</li><li>根据存储结构可以分成：<ul><li>独立存储<ul><li>生产中使用较为广泛</li><li>数据不够“新鲜”</li></ul></li><li>共享存储</li></ul></li></ul></li></ul><ul><li>字节采用了 <strong>独立引擎</strong> + <strong>共享存储</strong> ：<ul><li><p>独立引擎</p><ul><li>开发一个能够处理 AP 和 TP 的单一引擎，工作量不小</li><li>开源的、能够很好的处理混合模型的引擎没几个</li><li>而处理单一模型的引擎则较多（开源或者闭源的）</li><li>采用独立引擎，各司其职：<ul><li>TP: ByteNDB</li><li>AP: Apache Flink</li></ul></li></ul></li><li><p>共享存储</p><ul><li>字节现有的基础系统采用存储计算分离模型</li><li>ByteNDB 的架构类似于 Amazon Aurora</li><li>将 ByteNDB 的复制存储进行拓展，支持了列存，以便将变更以最小延迟在存储存传播</li><li>列存用于 OLAP</li><li>还做了一个内存中的 delta store, 用于保存最新的数据变更， 供 OLAP 使用</li></ul></li><li><p>架构对用户透明</p><ul><li>用户使用一套 SQL API 来进行 AP 和 TP 的查询</li><li>由代理 （proxy） 将 SQL 自动转发给 AP 或者 TP 引擎</li><li>模块化设计，将来可以方便的将 AP 引擎换成其他引擎<ul><li>仅需要实现一个存储和新引擎之间的 connector</li></ul></li></ul></li></ul></li></ul><h2 id=h:f8850aab-d346-4ff0-9db5-7a5014c2be57>2 RELATED WORK<a hidden class=anchor aria-hidden=true href=#h:f8850aab-d346-4ff0-9db5-7a5014c2be57>#</a></h2><ul><li>SAP Hana</li><li>MemSQL</li><li>TiDB<ul><li>TiKV</li><li>TiFlash</li></ul></li><li>WildFire<ul><li>Spark</li><li>Wiser</li></ul></li></ul><h2 id=h:2b77a1b6-e6f1-4061-9ba0-b25ce802c414>3 SYSTEM ARCHITECTURE<a hidden class=anchor aria-hidden=true href=#h:2b77a1b6-e6f1-4061-9ba0-b25ce802c414>#</a></h2><h3 id=h:12bb623b-2631-4d79-a371-c3f4e2d4f331>3.1 ByteNDB Overview<a hidden class=anchor aria-hidden=true href=#h:12bb623b-2631-4d79-a371-c3f4e2d4f331>#</a></h3><p>ByteNDB 的总体架构如图 <a href=#figure--fig:screenshot@2022-10-05-16:59:24>1</a> 所示。</p><p></p><figure><img loading=lazy src=/ox-hugo/screenshot@2022-10-05_16:59:24.png width=800px></figure><ul><li>一写多读</li><li>改进了 MySQL 的缓存池， 事务和锁管理 （ <code>所以 ByteNDB 是基于 MySQL 改的</code> ？）以支持 master-replica 同步</li><li>Log Store: 存储 redo log</li><li>Page Store: 应用 redo log, 形成真正数据</li><li>类似 Aurora: Log is Database!</li><li>两个 Store 都是构建在分布式存储之上</li></ul><h3 id=h:0e2a5f9a-94a5-468d-b067-77b7e5b84e75>3.2 System Overview<a hidden class=anchor aria-hidden=true href=#h:0e2a5f9a-94a5-468d-b067-77b7e5b84e75>#</a></h3><p>ByteHTAP 的架构如图 <a href=#figure--fig:screenshot@2022-10-05-17:11:28>2</a> 所示：</p><p></p><figure><img loading=lazy src=/ox-hugo/screenshot@2022-10-05_17:11:28.png width=800px></figure><ul><li><p>采用 <strong>独立引擎+共享存储</strong></p></li><li><p>一套 API， 通过 proxy 自动分发给 OLTP 或者 OLAP 引擎</p><ul><li>OLTP \[\Longrightarrow\] ByteNDB</li><li>OLAP \[\Longrightarrow\] Flink</li></ul></li><li><p>Proxy 规则</p><ul><li>交由 OLTP:<ul><li>DML, DDL, 简单查询</li><li>其他需要使用 TP 表的查询</li></ul></li><li>交由 OLAP:<ul><li>复杂查询 （join, aggr）</li></ul></li></ul></li><li><p>每个表必须有一个主键：</p><ul><li>列存要按照该建进行排序</li><li>主键值可以通过 DML 更改 （受 OLTP 引擎自动提供的约束限制）</li></ul></li><li><p>用户可对对列存表指定分区列</p><ul><li>当前仅支持哈希分区</li></ul></li><li><p>数据一致性</p><ul><li>每个 DML & DDL 都有一个唯一的 LSN</li><li>同一事务中的语句包装在一起</li><li>元数据服务向 OLAP 引擎提供全局已提交的 LSN<ul><li>任何小于此 LSN 的 LSN 都应该已经被 OLAP 所接收并持久化</li><li>OLAP 的查询会被赋予一个基于全局已提交 LSN 生成的只读 LSN 用于查询</li><li>data changes 通常控制在 1 秒以内。</li></ul></li></ul></li><li><p>目前 <strong>不支持混合了 DML 与只读查询的事务</strong>
无分布式事务支持</p></li></ul><h3 id=h:bbd56a7b-4e5b-417f-9186-7d8a6a2ea1cd>3.3 Metadata Service<a hidden class=anchor aria-hidden=true href=#h:bbd56a7b-4e5b-417f-9186-7d8a6a2ea1cd>#</a></h3><ul><li><p>中心化的元数据服务 (Metadata Service MDS)</p></li><li><p>用于提供统一的服务，包括：</p><ul><li>catalog 系统表<ul><li>仅供 AP 使用</li><li>TP 自行存储</li></ul></li><li>跨 AP 和 TP 的分区信息</li><li>供 AP 和 TP 所使用的数据统计信息</li><li>减少其他 ByteHTAP 模块的状态信息</li><li>提供全局已提交 LSN<ul><li>用于 OLAP 查询作为只读 LSN 使用</li></ul></li></ul></li><li><p>MDS 基于 Zookeeper 构建，支持高可用</p></li><li><p>MDS 的客户端</p><ul><li>集成进了 OLAP 计算引擎以及存储服务
以便和 MDS 交互，获取多版本的元数据</li><li>集成进了 DDL 解析器</li></ul></li><li><p>MDS 信息来源： DDL 逻辑日志：</p><ul><li>由 OLTP 引擎生成，包含元数据变更信息</li><li>由复制框架中继传播给 TP 的 Page Store 和 AP 的 Column Store 以及 MDS</li><li>MDS 对逻辑日志进行解析，由此产生系统表和分区 schema，并进行序列化和持久化，向外提供信息</li></ul></li></ul><h3 id=h:e1123c8f-6aaa-4885-b6f6-60ba97a24542>3.4 OLAP Engine<a hidden class=anchor aria-hidden=true href=#h:e1123c8f-6aaa-4885-b6f6-60ba97a24542>#</a></h3><ul><li><p>使用 Apache Flink 作为 AP 的计算引擎</p><ul><li>评估过 Spark, Flink, Presto</li><li>TPC-H 和 TPC-DS 性能相近</li><li>选用 Flink:<ul><li>公司内使用广泛</li><li>支持流式查询 （Streaming Queries）</li></ul></li><li>Flink 结合列存，形成计算引擎</li></ul></li><li><p>Data Connector</p><ul><li>用于高效、并行读取列存数据</li><li>支持聚集和扫描下推</li><li>支持分区修正 （partition prune），过滤掉不需要的分区</li></ul></li></ul><h2 id=h:efe671ff-4fbf-4403-93e8-dace57e327e3>4 SHARED STORAGE WITH HIGH DATA FRESHNESS<a hidden class=anchor aria-hidden=true href=#h:efe671ff-4fbf-4403-93e8-dace57e327e3>#</a></h2><ul><li>共享存储： Delta Store + Base Store<ul><li><p>Delta Store</p><ul><li>保存在内存中</li><li>行模式</li><li>及时应用日志（低延迟）生成新鲜数据供 OLAP 使用</li></ul></li><li><p>Base Store</p><ul><li>以列存形式持久化保存</li></ul></li><li><p>复制框架 Replication Framework</p><ul><li>管理 Delta Store, Base Store 和 Log Store, Page Store</li></ul></li></ul></li></ul><h3 id=h:a2a82346-1519-440d-a9ea-5dc25449b2bc>4.1 Delta Store<a hidden class=anchor aria-hidden=true href=#h:a2a82346-1519-440d-a9ea-5dc25449b2bc>#</a></h3><ul><li><p>高可用：</p><ul><li>分区： OLAP 表会进行分区</li><li>副本： 每个分区有三个副本</li><li>Delta Store: 每个分区的每个副本一个 Delta Store</li></ul></li><li><p>Delta Store 包含两个列表， 以逻辑日志中的 LSN 为序</p><ul><li>Insertion List<ul><li>记录插入操作</li></ul></li><li>Deletion List<ul><li>记录删除操作</li></ul></li><li>Delete Hash Map<ul><li>SCAN 操作需要访问 base store 和 delta store 来检查某一行是否已经删除</li><li>从 Deletion List 构建 Delete Hash Map, 用于加速查询</li></ul></li></ul></li><li><p>Delta Store 有四种主要的操作，且可以并行：</p><ul><li>日志应用 LogApply</li><li>Flush
从 Delta Store 生成 Base Store</li><li>Garbage Collection</li><li>Scan</li></ul></li></ul><h3 id=h:0c98ab5d-943f-4a7d-95e6-e7c13a230012>4.2 Base Store<a hidden class=anchor aria-hidden=true href=#h:0c98ab5d-943f-4a7d-95e6-e7c13a230012>#</a></h3><ul><li><p>持久化列存</p><ul><li>每个分片的每个副本创建一个</li></ul></li><li><p>Base Store 中不保存 LSN</p><ul><li>优点<ul><li>减少存储负担</li><li>提升 scan 和 update 的效率</li></ul></li><li>缺点<ul><li>只能读取 Delta Store 中保存的快照</li><li>更老的快照无法获取</li></ul></li></ul></li><li><p>Base Store 的数据</p><ul><li><p>保存格式为 Partitioned Attributes Across （<a href=https://cloud.tencent.com/developer/article/1705936>PAX</a>）</p></li><li><p>每个 Base Store 包含多个数据块 （data blocks）</p><ul><li>每个数据块默认大为 32MB, 由若干行组成</li><li>数据块内部按照主键排序</li><li>内部既保存了：<ul><li><p>块级的元数据</p><ul><li>行数</li><li>key range</li><li>主键构建的 BloomFilter （XXX: 这个可以考虑）</li><li>每列的统计信息：如 min/max</li></ul></li><li><p>每一列编码后的数据 (encoded data for each column)</p></li></ul></li></ul></li><li><p>仅支持 value based index</p></li></ul></li><li><p>Groom</p><ul><li><p>Why?</p><ul><li>数据删除操作，仅更新 bitmap, 而不删除数据</li><li>长期操作会导致磁盘使用空间不断增长</li><li>Flush 操作产生的分区表的范围可能重叠<ul><li>scan 操作需要访问多个分区，性能差</li></ul></li></ul></li><li><p>数据合并</p><ul><li>后台线程运行</li><li>周期性检查：<ul><li>已删除的数据占比</li><li>不同数据块主键重叠</li></ul></li><li>将符合上述特征的数据块进行合并<ul><li>新块将不包含已删除数据</li><li>最小化重叠的主键</li></ul></li><li>合并后<ul><li>更新 metadata</li><li>将原 block 添加到 GC list</li></ul></li></ul></li><li><p>垃圾回收</p><ul><li>后台运行</li><li>定期检查 GC list<ul><li>如果没有 active session 在访问，则删除之</li></ul></li></ul></li></ul></li></ul><h3 id=h:bb669fd7-9dac-4593-954c-febfc556e2d9>4.3 High Data Freshness<a hidden class=anchor aria-hidden=true href=#h:bb669fd7-9dac-4593-954c-febfc556e2d9>#</a></h3><h2 id=h:1a6bd9a4-09ea-406c-b57d-ab9ac767366e>5 LSN-BASED STRONG DATA CONSISTENCY<a hidden class=anchor aria-hidden=true href=#h:1a6bd9a4-09ea-406c-b57d-ab9ac767366e>#</a></h2><h2 id=h:c50f0fdb-da92-467e-a262-6eaf4fe962b1>6 OLAP QUERY PERFORMANCE OPTIMIZATION<a hidden class=anchor aria-hidden=true href=#h:c50f0fdb-da92-467e-a262-6eaf4fe962b1>#</a></h2><h3 id=h:43cd5013-4a01-4792-8ddd-dad936aebd11>6.1 Delete Optimization for Scans<a hidden class=anchor aria-hidden=true href=#h:43cd5013-4a01-4792-8ddd-dad936aebd11>#</a></h3><h3 id=h:6529c719-ecf6-4f88-81ca-b2b81039ac09>6.2 Computation Pushdown to Storage Engine<a hidden class=anchor aria-hidden=true href=#h:6529c719-ecf6-4f88-81ca-b2b81039ac09>#</a></h3><ul><li><p>Predicate Pushdown</p><ul><li>min/max 块级过滤<ul><li>减少无用 IO</li></ul></li><li>延迟物化<ul><li>优先计算条件列</li><li>再去读取其他列</li><li>减少 IO</li></ul></li></ul></li><li><p>Aggregate Pushdown</p><ul><li>每个分片上先做部分聚集 (Partial Aggregate)</li><li>最后汇总二次聚集</li></ul></li></ul><h3 id=h:c9ff9c1e-96b2-488b-94d5-3b35d3a459d7>6.3 OLAP Query Engine Optimization<a hidden class=anchor aria-hidden=true href=#h:c9ff9c1e-96b2-488b-94d5-3b35d3a459d7>#</a></h3><p>对 Flink 的改进，包括：</p><ul><li>统计信息收集</li><li>异步读取</li><li>并行优化</li></ul></div><footer class=post-footer><ul class=post-tags><li><a href=https://yangyingchao.github.io/tags/htap/>HTAP</a></li><li><a href=https://yangyingchao.github.io/tags/bytedance/>ByteDance</a></li></ul></footer></article></main><footer class=footer><span>&copy; 2025 <a href=https://yangyingchao.github.io>MyNotes</a></span>
<span>Powered by
<a href=https://gohugo.io/ rel="noopener noreferrer" target=_blank>Hugo</a> &
        <a href=https://github.com/adityatelange/hugo-PaperMod/ rel=noopener target=_blank>PaperMod</a></span></footer><a href=#top aria-label="go to top" title="Go to Top (Alt + G)" class=top-link id=top-link accesskey=g><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 12 6" fill="currentcolor"><path d="M12 6H0l6-6z"/></svg></a><script>let menu=document.getElementById("menu");menu&&(menu.scrollLeft=localStorage.getItem("menu-scroll-position"),menu.onscroll=function(){localStorage.setItem("menu-scroll-position",menu.scrollLeft)}),document.querySelectorAll('a[href^="#"]').forEach(e=>{e.addEventListener("click",function(e){e.preventDefault();var t=this.getAttribute("href").substr(1);window.matchMedia("(prefers-reduced-motion: reduce)").matches?document.querySelector(`[id='${decodeURIComponent(t)}']`).scrollIntoView():document.querySelector(`[id='${decodeURIComponent(t)}']`).scrollIntoView({behavior:"smooth"}),t==="top"?history.replaceState(null,null," "):history.pushState(null,null,`#${t}`)})})</script><script>var mybutton=document.getElementById("top-link");window.onscroll=function(){document.body.scrollTop>800||document.documentElement.scrollTop>800?(mybutton.style.visibility="visible",mybutton.style.opacity="1"):(mybutton.style.visibility="hidden",mybutton.style.opacity="0")}</script><script>document.getElementById("theme-toggle").addEventListener("click",()=>{document.body.className.includes("dark")?(document.body.classList.remove("dark"),localStorage.setItem("pref-theme","light")):(document.body.classList.add("dark"),localStorage.setItem("pref-theme","dark"))})</script></body></html>