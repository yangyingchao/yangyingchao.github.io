<!doctype html><html lang=zh-cn dir=auto><head><meta charset=utf-8><meta http-equiv=x-ua-compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no"><meta name=robots content="index, follow"><title>gpcheckcat | MyNotes</title><meta name=keywords content="gp,catlog,repair"><meta name=description content="1 概述 2 pg_class 3 namespace 4 unique_index_violation 5 duplicate 1 概述 GP 提供了 gpcheckcat 用于在集群内检查系统表。 | 检查项 || 描述 || Utility 模式 || 复合查询 || 错误等级 | |&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;|&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;-|&mdash;&mdash;&mdash;&mdash;|&mdash;&mdash;|&mdash;&mdash;| | pg_class || Check pg_class entry that does not have any correspond pg_attribute entry || Y"><meta name=author content><link rel=canonical href=https://yangyingchao.github.io/posts/gpcheckcat/><link crossorigin=anonymous href=/assets/css/stylesheet.fc220c15db4aef0318bbf30adc45d33d4d7c88deff3238b23eb255afdc472ca6.css integrity="sha256-/CIMFdtK7wMYu/MK3EXTPU18iN7/MjiyPrJVr9xHLKY=" rel="preload stylesheet" as=style><link rel=icon href=https://yangyingchao.github.io/favicon.ico><link rel=icon type=image/png sizes=16x16 href=https://yangyingchao.github.io/favicon-16x16.png><link rel=icon type=image/png sizes=32x32 href=https://yangyingchao.github.io/favicon-32x32.png><link rel=apple-touch-icon href=https://yangyingchao.github.io/apple-touch-icon.png><link rel=mask-icon href=https://yangyingchao.github.io/safari-pinned-tab.svg><meta name=theme-color content="#2e2e33"><meta name=msapplication-TileColor content="#2e2e33"><noscript><style>#theme-toggle,.top-link{display:none}</style><style>@media(prefers-color-scheme:dark){:root{--theme:rgb(29, 30, 32);--entry:rgb(46, 46, 51);--primary:rgb(218, 218, 219);--secondary:rgb(155, 156, 157);--tertiary:rgb(65, 66, 68);--content:rgb(196, 196, 197);--code-block-bg:rgb(46, 46, 51);--code-bg:rgb(55, 56, 62);--border:rgb(51, 51, 51)}.list{background:var(--theme)}.list:not(.dark)::-webkit-scrollbar-track{background:0 0}.list:not(.dark)::-webkit-scrollbar-thumb{border-color:var(--theme)}}</style></noscript><meta property="og:title" content="gpcheckcat"><meta property="og:description" content="1 概述 2 pg_class 3 namespace 4 unique_index_violation 5 duplicate 1 概述 GP 提供了 gpcheckcat 用于在集群内检查系统表。 | 检查项 || 描述 || Utility 模式 || 复合查询 || 错误等级 | |&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;|&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;-|&mdash;&mdash;&mdash;&mdash;|&mdash;&mdash;|&mdash;&mdash;| | pg_class || Check pg_class entry that does not have any correspond pg_attribute entry || Y"><meta property="og:type" content="article"><meta property="og:url" content="https://yangyingchao.github.io/posts/gpcheckcat/"><meta property="article:section" content="posts"><meta name=twitter:card content="summary"><meta name=twitter:title content="gpcheckcat"><meta name=twitter:description content="1 概述 2 pg_class 3 namespace 4 unique_index_violation 5 duplicate 1 概述 GP 提供了 gpcheckcat 用于在集群内检查系统表。 | 检查项 || 描述 || Utility 模式 || 复合查询 || 错误等级 | |&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;|&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;-|&mdash;&mdash;&mdash;&mdash;|&mdash;&mdash;|&mdash;&mdash;| | pg_class || Check pg_class entry that does not have any correspond pg_attribute entry || Y"><script type=application/ld+json>{"@context":"https://schema.org","@type":"BreadcrumbList","itemListElement":[{"@type":"ListItem","position":1,"name":"Posts","item":"https://yangyingchao.github.io/posts/"},{"@type":"ListItem","position":2,"name":"gpcheckcat","item":"https://yangyingchao.github.io/posts/gpcheckcat/"}]}</script><script type=application/ld+json>{"@context":"https://schema.org","@type":"BlogPosting","headline":"gpcheckcat","name":"gpcheckcat","description":"1 概述 2 pg_class 3 namespace 4 unique_index_violation 5 duplicate 1 概述 GP 提供了 gpcheckcat 用于在集群内检查系统表。 | 检查项 || 描述 || Utility 模式 || 复合查询 || 错误等级 | |\u0026mdash;\u0026mdash;\u0026mdash;\u0026mdash;\u0026mdash;\u0026mdash;\u0026mdash;|\u0026mdash;\u0026mdash;\u0026mdash;\u0026mdash;\u0026mdash;\u0026mdash;\u0026mdash;\u0026mdash;\u0026mdash;\u0026mdash;\u0026mdash;\u0026mdash;\u0026mdash;\u0026mdash;\u0026mdash;\u0026mdash;\u0026mdash;\u0026mdash;\u0026mdash;\u0026mdash;\u0026mdash;\u0026mdash;\u0026mdash;\u0026mdash;-|\u0026mdash;\u0026mdash;\u0026mdash;\u0026mdash;|\u0026mdash;\u0026mdash;|\u0026mdash;\u0026mdash;| | pg_class || Check pg_class entry that does not have any correspond pg_attribute entry || Y","keywords":["gp","catlog","repair"],"articleBody":" 1 概述 2 pg_class 3 namespace 4 unique_index_violation 5 duplicate 1 概述 GP 提供了 gpcheckcat 用于在集群内检查系统表。\n| 检查项 || 描述 || Utility 模式 || 复合查询 || 错误等级 | |———————|————————————————————————-|————|——|——| | pg_class || Check pg_class entry that does not have any correspond pg_attribute entry || Y || N || NOREPAIR | | namespace || Check for schemas with a missing schema definition || Y || N || NOREPAIR | | unique_index_violation || Check for violated unique indexes || N || Y || NOREPAIR | | duplicate || Check for duplicate entries || N || Y || | | missing_extraneous || Cross consistency check for missing or extraneous entries || N || Y || | | inconsistent || Cross consistency check for coordinator segment inconsistency || N || || | | foreign_key || Check foreign keys || N || || | | || || || || |\nNote:\nUtility 模式： 对应 SQL 是否执行在 utility 模式下 有些 SQL 只能在集群中执行\n复合查询： 下发的 SQL 是否为动态生成 有些 SQL 为根据表定义或者其他条件拼接而成\n错误等级：\nSUCCESS success REMOVE error, with repair script removes objects RESYNC error, with repair script that resynchronizes objects NOREPAIR error, no repair script 2 pg_class SELECT relname, relkind, tc.oid as oid FROM pg_class tc left outer join pg_attribute ta on (tc.oid = ta.attrelid) WHERE ta.attrelid is NULL and tc.relnatts != 0; 3 namespace SELECT o.catalog, o.nsp FROM pg_namespace n right outer join (select 'pg_class' as catalog, relnamespace as nsp from pg_class union select 'pg_type' as catalog, typnamespace as nsp from pg_type union select 'pg_operator' as catalog, oprnamespace as nsp from pg_operator union select 'pg_proc' as catalog,pronamespace as nsp from pg_proc) o on (n.oid = o.nsp) WHERE n.oid is NULL; 4 unique_index_violation SQL 为拼接而成，分成两步：\n获取有唯一索引约束的表和索引 逐一检查每个表是否违反了唯一约束 代码： unique_index_violation_check.py\nclass UniqueIndexViolationCheck: unique_indexes_query = \"\"\" select table_oid, index_name, table_name, array_agg(attname) as column_names from pg_attribute, ( select pg_index.indrelid as table_oid, index_class.relname as index_name, table_class.relname as table_name, unnest(pg_index.indkey) as column_index from pg_index, pg_class index_class, pg_class table_class where pg_index.indisunique='t' and index_class.relnamespace = (select oid from pg_namespace where nspname = 'pg_catalog') and index_class.relkind = 'i' and index_class.oid = pg_index.indexrelid and table_class.oid = pg_index.indrelid ) as unique_catalog_index_columns where attnum = column_index and attrelid = table_oid group by table_oid, index_name, table_name; \"\"\" def __init__(self): self.violated_segments_query = \"\"\" select distinct(gp_segment_id) from ( (select gp_segment_id, %s from gp_dist_random('%s') where (%s) is not null group by gp_segment_id, %s having count(*) \u003e 1) union (select gp_segment_id, %s from %s where (%s) is not null group by gp_segment_id, %s having count(*) \u003e 1) ) as violations \"\"\" def runCheck(self, db_connection): unique_indexes = db_connection.query(self.unique_indexes_query).getresult() violations = [] for (table_oid, index_name, table_name, column_names) in unique_indexes: column_names = \",\".join(column_names) sql = self.get_violated_segments_query(table_name, column_names) violated_segments = db_connection.query(sql).getresult() if violated_segments: violations.append(dict(table_oid=table_oid, table_name=table_name, index_name=index_name, column_names=column_names, violated_segments=[row[0] for row in violated_segments])) return violations def get_violated_segments_query(self, table_name, column_names): return self.violated_segments_query % ( column_names, table_name, column_names, column_names, column_names, table_name, column_names, column_names ) 5 duplicate ","wordCount":"578","inLanguage":"zh-cn","datePublished":"0001-01-01T00:00:00Z","dateModified":"0001-01-01T00:00:00Z","mainEntityOfPage":{"@type":"WebPage","@id":"https://yangyingchao.github.io/posts/gpcheckcat/"},"publisher":{"@type":"Organization","name":"MyNotes","logo":{"@type":"ImageObject","url":"https://yangyingchao.github.io/favicon.ico"}}}</script></head><body id=top><script>localStorage.getItem("pref-theme")==="dark"?document.body.classList.add("dark"):localStorage.getItem("pref-theme")==="light"?document.body.classList.remove("dark"):window.matchMedia("(prefers-color-scheme: dark)").matches&&document.body.classList.add("dark")</script><header class=header><nav class=nav><div class=logo><a href=https://yangyingchao.github.io accesskey=h title="MyNotes (Alt + H)">MyNotes</a><div class=logo-switches><button id=theme-toggle accesskey=t title="(Alt + T)"><svg id="moon" xmlns="http://www.w3.org/2000/svg" width="24" height="18" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 12.79A9 9 0 1111.21 3 7 7 0 0021 12.79z"/></svg><svg id="sun" xmlns="http://www.w3.org/2000/svg" width="24" height="18" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="5"/><line x1="12" y1="1" x2="12" y2="3"/><line x1="12" y1="21" x2="12" y2="23"/><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"/><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"/><line x1="1" y1="12" x2="3" y2="12"/><line x1="21" y1="12" x2="23" y2="12"/><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"/><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"/></svg></button></div></div><ul id=menu><li><a href=https://yangyingchao.github.io/ title=Home><span>Home</span></a></li><li><a href=https://yangyingchao.github.io/posts/ title=Archives><span>Archives</span></a></li><li><a href=https://yangyingchao.github.io/tags/ title=Tags><span>Tags</span></a></li><li><a href=https://yangyingchao.github.io/categories/ title=Categories><span>Categories</span></a></li><li><a href=https://yangyingchao.github.io/contact/ title="Contact me"><span>Contact me</span></a></li></ul></nav></header><main class=main><article class=post-single><header class=post-header><h1 class="post-title entry-hint-parent">gpcheckcat</h1><div class=post-meta></div></header><div class=post-content><ul><li>1 <a href=#h:bfa36016-e178-44c5-b78a-c8c0bd52f193>概述</a></li><li>2 <a href=#h:85f7df11-2f89-46c4-909c-db8f5f11cd1b>pg_class</a></li><li>3 <a href=#h:d87adc91-5c8e-46a9-84fd-1e5415b0bc5f>namespace</a></li><li>4 <a href=#h:f8543ff9-a368-452c-a51f-a5c76ba2b516>unique_index_violation</a></li><li>5 <a href=#h:4aae321e-1ac2-462c-8adf-6ed7b44069d3>duplicate</a></li></ul><h2 id=h:bfa36016-e178-44c5-b78a-c8c0bd52f193>1 概述<a hidden class=anchor aria-hidden=true href=#h:bfa36016-e178-44c5-b78a-c8c0bd52f193>#</a></h2><p>GP 提供了 <a href=https://github.com/greenplum-db/gpdb/blob/master/gpMgmt/bin/gpcheckcat>gpcheckcat</a> 用于在集群内检查系统表。</p><p></p><p>| 检查项 || 描述 || Utility 模式 || 复合查询 || 错误等级 |
|&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;|&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;-|&mdash;&mdash;&mdash;&mdash;|&mdash;&mdash;|&mdash;&mdash;|
| pg_class || Check pg_class entry that does not have any correspond pg_attribute entry || Y || N || NOREPAIR |
| namespace || Check for schemas with a missing schema definition || Y || N || NOREPAIR |
| unique_index_violation || Check for violated unique indexes || N || Y || NOREPAIR |
| duplicate || Check for duplicate entries || N || Y || |
| missing_extraneous || Cross consistency check for missing or extraneous entries || N || Y || |
| inconsistent || Cross consistency check for coordinator segment inconsistency || N || || |
| foreign_key || Check foreign keys || N || || |
| || || || || |</p><p>Note:</p><ul><li><p>Utility 模式： 对应 SQL 是否执行在 utility 模式下
有些 SQL 只能在集群中执行</p></li><li><p>复合查询： 下发的 SQL 是否为动态生成
有些 SQL 为根据表定义或者其他条件拼接而成</p></li><li><p>错误等级：</p><ul><li>SUCCESS
success</li><li>REMOVE
error, with repair script removes objects</li><li>RESYNC
error, with repair script that resynchronizes objects</li><li>NOREPAIR
error, no repair script</li></ul></li></ul><h2 id=h:85f7df11-2f89-46c4-909c-db8f5f11cd1b>2 pg_class<a hidden class=anchor aria-hidden=true href=#h:85f7df11-2f89-46c4-909c-db8f5f11cd1b>#</a></h2><div class=highlight><pre tabindex=0 style=-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sql data-lang=sql><span style=display:flex><span><span style=color:green;font-weight:700>SELECT</span><span style=color:#bbb> </span>relname,<span style=color:#bbb> </span>relkind,<span style=color:#bbb> </span>tc.oid<span style=color:#bbb> </span><span style=color:green;font-weight:700>as</span><span style=color:#bbb> </span>oid<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:green;font-weight:700>FROM</span><span style=color:#bbb>   </span>pg_class<span style=color:#bbb> </span>tc<span style=color:#bbb> </span><span style=color:green;font-weight:700>left</span><span style=color:#bbb> </span><span style=color:green;font-weight:700>outer</span><span style=color:#bbb> </span><span style=color:green;font-weight:700>join</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>       </span>pg_attribute<span style=color:#bbb> </span>ta<span style=color:#bbb> </span><span style=color:green;font-weight:700>on</span><span style=color:#bbb> </span>(tc.oid<span style=color:#bbb> </span><span style=color:#666>=</span><span style=color:#bbb> </span>ta.attrelid)<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:green;font-weight:700>WHERE</span><span style=color:#bbb>  </span>ta.attrelid<span style=color:#bbb> </span><span style=color:green;font-weight:700>is</span><span style=color:#bbb> </span><span style=color:green;font-weight:700>NULL</span><span style=color:#bbb> </span><span style=color:green;font-weight:700>and</span><span style=color:#bbb> </span>tc.relnatts<span style=color:#bbb> </span><span style=color:#666>!=</span><span style=color:#bbb> </span><span style=color:#666>0</span>;<span style=color:#bbb>
</span></span></span></code></pre></div><h2 id=h:d87adc91-5c8e-46a9-84fd-1e5415b0bc5f>3 namespace<a hidden class=anchor aria-hidden=true href=#h:d87adc91-5c8e-46a9-84fd-1e5415b0bc5f>#</a></h2><div class=highlight><pre tabindex=0 style=-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sql data-lang=sql><span style=display:flex><span><span style=color:green;font-weight:700>SELECT</span><span style=color:#bbb> </span>o.<span style=color:green;font-weight:700>catalog</span>,<span style=color:#bbb> </span>o.nsp<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:green;font-weight:700>FROM</span><span style=color:#bbb> </span>pg_namespace<span style=color:#bbb> </span>n<span style=color:#bbb> </span><span style=color:green;font-weight:700>right</span><span style=color:#bbb> </span><span style=color:green;font-weight:700>outer</span><span style=color:#bbb> </span><span style=color:green;font-weight:700>join</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>     </span>(<span style=color:green;font-weight:700>select</span><span style=color:#bbb> </span><span style=color:#ba2121>&#39;pg_class&#39;</span><span style=color:#bbb> </span><span style=color:green;font-weight:700>as</span><span style=color:#bbb> </span><span style=color:green;font-weight:700>catalog</span>,<span style=color:#bbb> </span>relnamespace<span style=color:#bbb> </span><span style=color:green;font-weight:700>as</span><span style=color:#bbb> </span>nsp<span style=color:#bbb> </span><span style=color:green;font-weight:700>from</span><span style=color:#bbb> </span>pg_class<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>      </span><span style=color:green;font-weight:700>union</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>      </span><span style=color:green;font-weight:700>select</span><span style=color:#bbb> </span><span style=color:#ba2121>&#39;pg_type&#39;</span><span style=color:#bbb> </span><span style=color:green;font-weight:700>as</span><span style=color:#bbb> </span><span style=color:green;font-weight:700>catalog</span>,<span style=color:#bbb> </span>typnamespace<span style=color:#bbb> </span><span style=color:green;font-weight:700>as</span><span style=color:#bbb> </span>nsp<span style=color:#bbb> </span><span style=color:green;font-weight:700>from</span><span style=color:#bbb> </span>pg_type<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>      </span><span style=color:green;font-weight:700>union</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>      </span><span style=color:green;font-weight:700>select</span><span style=color:#bbb> </span><span style=color:#ba2121>&#39;pg_operator&#39;</span><span style=color:#bbb> </span><span style=color:green;font-weight:700>as</span><span style=color:#bbb> </span><span style=color:green;font-weight:700>catalog</span>,<span style=color:#bbb> </span>oprnamespace<span style=color:#bbb> </span><span style=color:green;font-weight:700>as</span><span style=color:#bbb> </span>nsp<span style=color:#bbb> </span><span style=color:green;font-weight:700>from</span><span style=color:#bbb> </span>pg_operator<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>      </span><span style=color:green;font-weight:700>union</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>      </span><span style=color:green;font-weight:700>select</span><span style=color:#bbb> </span><span style=color:#ba2121>&#39;pg_proc&#39;</span><span style=color:#bbb> </span><span style=color:green;font-weight:700>as</span><span style=color:#bbb> </span><span style=color:green;font-weight:700>catalog</span>,pronamespace<span style=color:#bbb> </span><span style=color:green;font-weight:700>as</span><span style=color:#bbb> </span>nsp<span style=color:#bbb> </span><span style=color:green;font-weight:700>from</span><span style=color:#bbb> </span>pg_proc)<span style=color:#bbb> </span>o<span style=color:#bbb> </span><span style=color:green;font-weight:700>on</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>      </span>(n.oid<span style=color:#bbb> </span><span style=color:#666>=</span><span style=color:#bbb> </span>o.nsp)<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:green;font-weight:700>WHERE</span><span style=color:#bbb> </span>n.oid<span style=color:#bbb> </span><span style=color:green;font-weight:700>is</span><span style=color:#bbb> </span><span style=color:green;font-weight:700>NULL</span>;<span style=color:#bbb>
</span></span></span></code></pre></div><h2 id=h:f8543ff9-a368-452c-a51f-a5c76ba2b516>4 unique_index_violation<a hidden class=anchor aria-hidden=true href=#h:f8543ff9-a368-452c-a51f-a5c76ba2b516>#</a></h2><p>SQL 为拼接而成，分成两步：</p><ol><li>获取有唯一索引约束的表和索引</li><li>逐一检查每个表是否违反了唯一约束</li></ol><p>代码： <a href=https://github.com/greenplum-db/gpdb/blob/master/gpMgmt/bin/gpcheckcat_modules/unique_index_violation_check.py>unique_index_violation_check.py</a></p><div class=highlight><pre tabindex=0 style=-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=display:flex><span><span style=color:green;font-weight:700>class</span> <span style=color:#00f;font-weight:700>UniqueIndexViolationCheck</span>:
</span></span><span style=display:flex><span>    unique_indexes_query <span style=color:#666>=</span> <span style=color:#ba2121>&#34;&#34;&#34;
</span></span></span><span style=display:flex><span><span style=color:#ba2121>        select table_oid, index_name, table_name, array_agg(attname) as column_names
</span></span></span><span style=display:flex><span><span style=color:#ba2121>        from pg_attribute, (
</span></span></span><span style=display:flex><span><span style=color:#ba2121>            select pg_index.indrelid as table_oid, index_class.relname as index_name, table_class.relname as table_name, unnest(pg_index.indkey) as column_index
</span></span></span><span style=display:flex><span><span style=color:#ba2121>            from pg_index, pg_class index_class, pg_class table_class
</span></span></span><span style=display:flex><span><span style=color:#ba2121>            where pg_index.indisunique=&#39;t&#39;
</span></span></span><span style=display:flex><span><span style=color:#ba2121>            and index_class.relnamespace = (select oid from pg_namespace where nspname = &#39;pg_catalog&#39;)
</span></span></span><span style=display:flex><span><span style=color:#ba2121>            and index_class.relkind = &#39;i&#39;
</span></span></span><span style=display:flex><span><span style=color:#ba2121>            and index_class.oid = pg_index.indexrelid
</span></span></span><span style=display:flex><span><span style=color:#ba2121>            and table_class.oid = pg_index.indrelid
</span></span></span><span style=display:flex><span><span style=color:#ba2121>        ) as unique_catalog_index_columns
</span></span></span><span style=display:flex><span><span style=color:#ba2121>        where attnum = column_index
</span></span></span><span style=display:flex><span><span style=color:#ba2121>        and attrelid = table_oid
</span></span></span><span style=display:flex><span><span style=color:#ba2121>        group by table_oid, index_name, table_name;
</span></span></span><span style=display:flex><span><span style=color:#ba2121>    &#34;&#34;&#34;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:green;font-weight:700>def</span> __init__(self):
</span></span><span style=display:flex><span>        self<span style=color:#666>.</span>violated_segments_query <span style=color:#666>=</span> <span style=color:#ba2121>&#34;&#34;&#34;
</span></span></span><span style=display:flex><span><span style=color:#ba2121>            select distinct(gp_segment_id) from (
</span></span></span><span style=display:flex><span><span style=color:#ba2121>                (select gp_segment_id, </span><span style=color:#b68;font-weight:700>%s</span><span style=color:#ba2121>
</span></span></span><span style=display:flex><span><span style=color:#ba2121>                from gp_dist_random(&#39;</span><span style=color:#b68;font-weight:700>%s</span><span style=color:#ba2121>&#39;)
</span></span></span><span style=display:flex><span><span style=color:#ba2121>                where (</span><span style=color:#b68;font-weight:700>%s</span><span style=color:#ba2121>) is not null
</span></span></span><span style=display:flex><span><span style=color:#ba2121>                group by gp_segment_id, </span><span style=color:#b68;font-weight:700>%s</span><span style=color:#ba2121>
</span></span></span><span style=display:flex><span><span style=color:#ba2121>                having count(*) &gt; 1)
</span></span></span><span style=display:flex><span><span style=color:#ba2121>                union
</span></span></span><span style=display:flex><span><span style=color:#ba2121>                (select gp_segment_id, </span><span style=color:#b68;font-weight:700>%s</span><span style=color:#ba2121>
</span></span></span><span style=display:flex><span><span style=color:#ba2121>                from </span><span style=color:#b68;font-weight:700>%s</span><span style=color:#ba2121>
</span></span></span><span style=display:flex><span><span style=color:#ba2121>                where (</span><span style=color:#b68;font-weight:700>%s</span><span style=color:#ba2121>) is not null
</span></span></span><span style=display:flex><span><span style=color:#ba2121>                group by gp_segment_id, </span><span style=color:#b68;font-weight:700>%s</span><span style=color:#ba2121>
</span></span></span><span style=display:flex><span><span style=color:#ba2121>                having count(*) &gt; 1)
</span></span></span><span style=display:flex><span><span style=color:#ba2121>            ) as violations
</span></span></span><span style=display:flex><span><span style=color:#ba2121>        &#34;&#34;&#34;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:green;font-weight:700>def</span> <span style=color:#00f>runCheck</span>(self, db_connection):
</span></span><span style=display:flex><span>        unique_indexes <span style=color:#666>=</span> db_connection<span style=color:#666>.</span>query(self<span style=color:#666>.</span>unique_indexes_query)<span style=color:#666>.</span>getresult()
</span></span><span style=display:flex><span>        violations <span style=color:#666>=</span> []
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:green;font-weight:700>for</span> (table_oid, index_name, table_name, column_names) <span style=color:#a2f;font-weight:700>in</span> unique_indexes:
</span></span><span style=display:flex><span>            column_names <span style=color:#666>=</span> <span style=color:#ba2121>&#34;,&#34;</span><span style=color:#666>.</span>join(column_names)
</span></span><span style=display:flex><span>            sql <span style=color:#666>=</span> self<span style=color:#666>.</span>get_violated_segments_query(table_name, column_names)
</span></span><span style=display:flex><span>            violated_segments <span style=color:#666>=</span> db_connection<span style=color:#666>.</span>query(sql)<span style=color:#666>.</span>getresult()
</span></span><span style=display:flex><span>            <span style=color:green;font-weight:700>if</span> violated_segments:
</span></span><span style=display:flex><span>                violations<span style=color:#666>.</span>append(<span style=color:green>dict</span>(table_oid<span style=color:#666>=</span>table_oid,
</span></span><span style=display:flex><span>                                       table_name<span style=color:#666>=</span>table_name,
</span></span><span style=display:flex><span>                                       index_name<span style=color:#666>=</span>index_name,
</span></span><span style=display:flex><span>                                       column_names<span style=color:#666>=</span>column_names,
</span></span><span style=display:flex><span>                                       violated_segments<span style=color:#666>=</span>[row[<span style=color:#666>0</span>] <span style=color:green;font-weight:700>for</span> row <span style=color:#a2f;font-weight:700>in</span> violated_segments]))
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:green;font-weight:700>return</span> violations
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:green;font-weight:700>def</span> <span style=color:#00f>get_violated_segments_query</span>(self, table_name, column_names):
</span></span><span style=display:flex><span>        <span style=color:green;font-weight:700>return</span> self<span style=color:#666>.</span>violated_segments_query <span style=color:#666>%</span> (
</span></span><span style=display:flex><span>            column_names, table_name, column_names, column_names, column_names, table_name, column_names, column_names
</span></span><span style=display:flex><span>        )
</span></span></code></pre></div><h2 id=h:4aae321e-1ac2-462c-8adf-6ed7b44069d3>5 duplicate<a hidden class=anchor aria-hidden=true href=#h:4aae321e-1ac2-462c-8adf-6ed7b44069d3>#</a></h2></div><footer class=post-footer><ul class=post-tags><li><a href=https://yangyingchao.github.io/tags/gp/>gp</a></li><li><a href=https://yangyingchao.github.io/tags/catlog/>catlog</a></li><li><a href=https://yangyingchao.github.io/tags/repair/>repair</a></li></ul></footer></article></main><footer class=footer><span>&copy; 2025 <a href=https://yangyingchao.github.io>MyNotes</a></span> ·
<span>Powered by
<a href=https://gohugo.io/ rel="noopener noreferrer" target=_blank>Hugo</a> &
        <a href=https://github.com/adityatelange/hugo-PaperMod/ rel=noopener target=_blank>PaperMod</a></span></footer><a href=#top aria-label="go to top" title="Go to Top (Alt + G)" class=top-link id=top-link accesskey=g><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 12 6" fill="currentcolor"><path d="M12 6H0l6-6z"/></svg></a><script>let menu=document.getElementById("menu");menu&&(menu.scrollLeft=localStorage.getItem("menu-scroll-position"),menu.onscroll=function(){localStorage.setItem("menu-scroll-position",menu.scrollLeft)}),document.querySelectorAll('a[href^="#"]').forEach(e=>{e.addEventListener("click",function(e){e.preventDefault();var t=this.getAttribute("href").substr(1);window.matchMedia("(prefers-reduced-motion: reduce)").matches?document.querySelector(`[id='${decodeURIComponent(t)}']`).scrollIntoView():document.querySelector(`[id='${decodeURIComponent(t)}']`).scrollIntoView({behavior:"smooth"}),t==="top"?history.replaceState(null,null," "):history.pushState(null,null,`#${t}`)})})</script><script>var mybutton=document.getElementById("top-link");window.onscroll=function(){document.body.scrollTop>800||document.documentElement.scrollTop>800?(mybutton.style.visibility="visible",mybutton.style.opacity="1"):(mybutton.style.visibility="hidden",mybutton.style.opacity="0")}</script><script>document.getElementById("theme-toggle").addEventListener("click",()=>{document.body.className.includes("dark")?(document.body.classList.remove("dark"),localStorage.setItem("pref-theme","light")):(document.body.classList.add("dark"),localStorage.setItem("pref-theme","dark"))})</script></body></html>