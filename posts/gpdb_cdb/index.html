<!doctype html><html lang=zh-cn><head><title>gpdb cdb · MyNotes</title><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta name=color-scheme content="light dark"><meta name=author content="yyc"><meta name=description content="1 Data structures 1.1 Slice Table 2 PostgresMain 2.1 Call graph (QE): 2.2 QD 3 Receiver 4 Sender 1 Data structures 链接到标题 1.1 Slice Table 链接到标题 @startuml class SliceTable { + NodeTag type + int localSlice + int numSlices + ExecSlice slices + bool hasMotions + int instrument_options + uint32 ic_instance_id } note right of SliceTable::localSlice Index of the slice to execute"><meta name=keywords content="blog,developer,personal"><meta name=twitter:card content="summary"><meta name=twitter:title content="gpdb cdb"><meta name=twitter:description content="1 Data structures 1.1 Slice Table 2 PostgresMain 2.1 Call graph (QE): 2.2 QD 3 Receiver 4 Sender 1 Data structures 链接到标题 1.1 Slice Table 链接到标题 @startuml class SliceTable { + NodeTag type + int localSlice + int numSlices + ExecSlice slices + bool hasMotions + int instrument_options + uint32 ic_instance_id } note right of SliceTable::localSlice Index of the slice to execute"><meta property="og:title" content="gpdb cdb"><meta property="og:description" content="1 Data structures 1.1 Slice Table 2 PostgresMain 2.1 Call graph (QE): 2.2 QD 3 Receiver 4 Sender 1 Data structures 链接到标题 1.1 Slice Table 链接到标题 @startuml class SliceTable { + NodeTag type + int localSlice + int numSlices + ExecSlice slices + bool hasMotions + int instrument_options + uint32 ic_instance_id } note right of SliceTable::localSlice Index of the slice to execute"><meta property="og:type" content="article"><meta property="og:url" content="https://yangyingchao.github.io/posts/gpdb_cdb/"><meta property="article:section" content="posts"><link rel=canonical href=https://yangyingchao.github.io/posts/gpdb_cdb/><link rel=preload href="/fonts/forkawesome-webfont.woff2?v=1.2.0" as=font type=font/woff2 crossorigin><link rel=stylesheet href=/css/coder.min.135e22c97ff685fe983fc60048e309ced8f00d8d38f536aa67dba8a13a03dfa4.css integrity="sha256-E14iyX/2hf6YP8YASOMJztjwDY049TaqZ9uooToD36Q=" crossorigin=anonymous media=screen><link rel=stylesheet href=/css/coder-dark.min.a00e6364bacbc8266ad1cc81230774a1397198f8cfb7bcba29b7d6fcb54ce57f.css integrity="sha256-oA5jZLrLyCZq0cyBIwd0oTlxmPjPt7y6KbfW/LVM5X8=" crossorigin=anonymous media=screen><link rel=icon type=image/svg+xml href=/images/favicon.svg sizes=any><link rel=icon type=image/png href=/images/favicon-32x32.png sizes=32x32><link rel=icon type=image/png href=/images/favicon-16x16.png sizes=16x16><link rel=apple-touch-icon href=/images/apple-touch-icon.png><link rel=apple-touch-icon sizes=180x180 href=/images/apple-touch-icon.png><link rel=manifest href=/site.webmanifest><link rel=mask-icon href=/images/safari-pinned-tab.svg color=#5bbad5></head><body class="preload-transitions colorscheme-auto"><div class=float-container><a id=dark-mode-toggle class=colorscheme-toggle><i class="fa fa-adjust fa-fw" aria-hidden=true></i></a></div><main class=wrapper><nav class=navigation><section class=container><a class=navigation-title href=/>MyNotes</a>
<input type=checkbox id=menu-toggle>
<label class="menu-button float-right" for=menu-toggle><i class="fa fa-bars fa-fw" aria-hidden=true></i></label><ul class=navigation-list><li class=navigation-item><a class=navigation-link href=/posts/>Blog</a></li><li class=navigation-item><a class=navigation-link href=/tags/>Tags</a></li><li class=navigation-item><a class=navigation-link href=/contact/>Contact me</a></li></ul></section></nav><div class=content><section class="container post"><article><header><div class=post-title><h1 class=title><a class=title-link href=https://yangyingchao.github.io/posts/gpdb_cdb/>gpdb cdb</a></h1></div><div class=post-meta><div class=date><span class=posted-on><i class="fa fa-calendar" aria-hidden=true></i>
<time datetime=0001-01-01T00:00:00Z>January 1, 0001</time></span>
<span class=reading-time><i class="fa fa-clock-o" aria-hidden=true></i>
阅读时间：2 分钟</span></div></div></header><div class=post-content><ul><li>1 <a href=#h:3a9ecefa-c67a-4512-a5d4-69adb4c9a0d6>Data structures</a><ul><li>1.1 <a href=#h:1223137a-c35a-4cca-8922-447664c4cc0b>Slice Table</a></li></ul></li><li>2 <a href=#h:9a8ad5db-0d8c-4bef-bbc8-4a27cd48ef45>PostgresMain</a><ul><li>2.1 <a href=#h:554948eb-a908-49ea-89f4-324ac2f96fe7>Call graph (QE):</a></li><li>2.2 <a href=#h:e1a256d3-301b-4ba1-be57-8749befb730f>QD</a></li></ul></li><li>3 <a href=#h:c37bea35-e940-428c-befb-d19fa51a1295>Receiver</a></li><li>4 <a href=#h:d1532cbd-394f-42b8-9331-0704d91794b7>Sender</a></li></ul><h2 id=h:3a9ecefa-c67a-4512-a5d4-69adb4c9a0d6>1 Data structures
<a class=heading-link href=#h:3a9ecefa-c67a-4512-a5d4-69adb4c9a0d6><i class="fa fa-link" aria-hidden=true title=链接到标题></i>
<span class=sr-only>链接到标题</span></a></h2><h3 id=h:1223137a-c35a-4cca-8922-447664c4cc0b>1.1 Slice Table
<a class=heading-link href=#h:1223137a-c35a-4cca-8922-447664c4cc0b><i class="fa fa-link" aria-hidden=true title=链接到标题></i>
<span class=sr-only>链接到标题</span></a></h3><pre tabindex=0><code class=language-plantuml data-lang=plantuml>@startuml
class SliceTable {
+ NodeTag type
+ int localSlice
+ int numSlices
+ ExecSlice slices
+ bool hasMotions
+ int instrument_options
+ uint32 ic_instance_id
}

note right of SliceTable::localSlice
Index of the slice to execute
end note

note right of SliceTable::slices
Array of slices, indexed by SliceIndex
end note


note right of SliceTable::hasMotions
Are there any Motion nodes anywhere in the plan?
end note


class ExecSlice {
+ int sliceIndex
+ int rootIndex
+ int parentIndex
+ int planNumSegments
+ List children
+ GangType gangType
+ List segments
+ struct primaryGang
+ List primaryProcesses
+ Bitmapset processesMap
}

note right of ExecSlice::primaryProcesses
A list of CDBProcess nodes corresponding to the worker
processes allocated to implement this plan slice.
end note

note right of ExecSlice::processesMap
A bitmap to identify which QE should execute this slice
end note

SliceTable o-- ExecSlice

class Gang {
+ GangType type
+ int size
+ struct db_descriptors
+ bool allocated
}

note right of Gang::db_descriptors
Array of QEs/segDBs that make up this gang.
Sorted by segment index.
end note


ExecSlice *-- Gang

class CdbProcess {
+ NodeTag type
+ char listenerAddr
+ int listenerPort
+ int pid
+ int contentid
+ int dbid
}

ExecSlice o-- CdbProcess



class SegmentDatabaseDescriptor {
+ struct segment_database_info
+ int segindex
+ int conn
+ int motionListener
+ int backendPid
+ char whoami
+ int isWriter
+ int identifier
}

Gang o-- SegmentDatabaseDescriptor



class CdbComponentDatabases {
+ CdbComponentDatabaseInfo segment_db_info
+ int total_segment_dbs
+ CdbComponentDatabaseInfo entry_db_info
+ int total_entry_dbs
+ int total_segments
+ int fts_version
+ int expand_version
+ int numActiveQEs
+ int numIdleQEs
+ int qeCounter
+ List freeCounterList
}

note right of CdbComponentDatabaseInfo::segment_db_info
array of  SegmentDatabaseInfo for segment databases
end note

note right of CdbComponentDatabaseInfo::entry_db_info
array of  SegmentDatabaseInfo for entry databases
end note


class CdbComponentDatabaseInfo {
+ struct config
+ CdbComponentDatabases cdbs
+ int hostSegs
+ List freelist
+ int numIdleQEs
+ int numActiveQEs
}

note right of CdbComponentDatabaseInfo::cdbs
point to owners
end note

CdbComponentDatabases o-- CdbComponentDatabaseInfo



class GpSegConfigEntry {
+ int dbid
+ int segindex
+ char role
+ char preferred_role
+ char mode
+ char status
+ int port
+ char hostname
+ char address
+ char datadir
+ char hostip
+ char hostaddrs
}

CdbComponentDatabaseInfo o-- GpSegConfigEntry

SegmentDatabaseDescriptor o-- CdbComponentDatabaseInfo

@enduml
</code></pre><p></p><p>2<img src=/ox-hugo/SliceTable-gen-e3de35057480a3f67a59b81aff9b1a55.png alt></p><h4 id=h:529c866c-a184-44fa-be5a-62154cd53821>1.1.1 SliceTable
<a class=heading-link href=#h:529c866c-a184-44fa-be5a-62154cd53821><i class="fa fa-link" aria-hidden=true title=链接到标题></i>
<span class=sr-only>链接到标题</span></a></h4><p><code>SliceTable</code> : 由 Slice 组成的链表， Slice 组织成三类：</p><ul><li><p>root slices:
Slice 0</p></li><li><p>motion slices
<code>1 ~ n</code> 为 motion slices, 每个 slice 的根为 sending motion</p></li><li><p>其余为 initPlans</p></li></ul><h4 id=h:384cef30-3dad-4d92-9f0a-a892701e42b5>1.1.2 ExecSlice
<a class=heading-link href=#h:384cef30-3dad-4d92-9f0a-a892701e42b5><i class="fa fa-link" aria-hidden=true title=链接到标题></i>
<span class=sr-only>链接到标题</span></a></h4><ul><li>MPP 中，计划树 (PlanTree) 被切分成多个单独的执行单元 （又称 <strong>Slice</strong> ）</li><li>一个 Slice 在进程组 （process gang） 的一个 worker 上执行</li></ul><h2 id=h:9a8ad5db-0d8c-4bef-bbc8-4a27cd48ef45>2 PostgresMain
<a class=heading-link href=#h:9a8ad5db-0d8c-4bef-bbc8-4a27cd48ef45><i class="fa fa-link" aria-hidden=true title=链接到标题></i>
<span class=sr-only>链接到标题</span></a></h2><h3 id=h:554948eb-a908-49ea-89f4-324ac2f96fe7>2.1 Call graph (QE):
<a class=heading-link href=#h:554948eb-a908-49ea-89f4-324ac2f96fe7><i class="fa fa-link" aria-hidden=true title=链接到标题></i>
<span class=sr-only>链接到标题</span></a></h3><div class=highlight><pre tabindex=0 style=-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-text data-lang=text><span style=display:flex><span>Main()
</span></span><span style=display:flex><span>  PostmasterMain()
</span></span><span style=display:flex><span>    ServerLoop()
</span></span><span style=display:flex><span>      BackendStartup()
</span></span><span style=display:flex><span>        BackendRun()
</span></span><span style=display:flex><span>          PostgresMain()
</span></span><span style=display:flex><span>            InitPostgres()
</span></span><span style=display:flex><span>              cdb_setup()
</span></span><span style=display:flex><span>                ensureInterconnectAddress()
</span></span><span style=display:flex><span>                InitMotionLayerIPC()
</span></span><span style=display:flex><span>                  InitMotionTCP()
</span></span><span style=display:flex><span>                      setupTCPListeningSocket()
</span></span><span style=display:flex><span>            sendQEDetails()
</span></span></code></pre></div><p><code>setupTCPListeningSocket()</code> 会由操作系统分配端口，并返回上层。并在 <code>InitMotionlayerIPC()</code> 中存储在全局变量
<code>Gp_listener_port</code> 中，并随后在函数 <code>sendQEDetails(void)</code> 中将端口信息 &ldquo;qe_listener_port&rdquo; 发送给 client 。</p><h3 id=h:e1a256d3-301b-4ba1-be57-8749befb730f>2.2 QD
<a class=heading-link href=#h:e1a256d3-301b-4ba1-be57-8749befb730f><i class="fa fa-link" aria-hidden=true title=链接到标题></i>
<span class=sr-only>链接到标题</span></a></h3><div class=highlight><pre tabindex=0 style=-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-text data-lang=text><span style=display:flex><span>standard_ExecutorStart()
</span></span><span style=display:flex><span>  CdbDispatchPlan()
</span></span><span style=display:flex><span>    cdbdisp_dispatchX()
</span></span><span style=display:flex><span>      AssignGangs()
</span></span><span style=display:flex><span>        AssignWriterGangFirst()
</span></span><span style=display:flex><span>          AllocateGang()
</span></span><span style=display:flex><span>            cdbgang_createGang()
</span></span><span style=display:flex><span>              cdbgang_createGang_async()
</span></span><span style=display:flex><span>                cdbconn_doConnectComplete()
</span></span><span style=display:flex><span>                  cdbconn_get_motion_listener_port()
</span></span><span style=display:flex><span>          setupCdbProcessList()
</span></span></code></pre></div><p>函数 <a href=~/Work/gpdb/src/backend/executor/execUtils.c>AssignGangs()</a> 在 QD 上执行， 将 Executor 工厂分配的 gangs 分配给 slice table 中的 slices.
从而构建全局的 slice table 。该过程分成了两步：</p><ul><li><p><a href=~/Work/gpdb/src/backend/executor/execUtils.c>AssignWriterGangFirst()</a></p><ul><li><p><a href=~/Work/gpdb/src/backend/executor/execUtils.c>AllocateGang()</a></p><p>登录到涉及到的 segDB ， 生成会话 （进程）， 从而创建进程组。</p><ul><li><a href=~/Work/gpdb/src/backend/cdb/dispatcher/cdbgang_async.c>cdbgang_createGang_async()</a><ul><li><p><a href=~/Work/gpdb/src/backend/cdb/dispatcher/cdbgang.c>buildGangDefinition()</a>
读取 GP 系统表， 构建 <code>CdbComponentDatabases</code> ，随后将该结构转换成为 <code>Gang</code> 结构， 并初始化其中与 connection 无
关的成员。随后对其中每个 seg 发起连接。</p></li><li><p><a href=~/Work/gpdb/src/backend/cdb/dispatcher/cdbgang_async.c>cdbconn_doConnectStart()</a>
填充 keywords 之后，使用 <code>PQconnectStartParams()</code> 发起连接。</p></li><li><p><a href=~/Work/gpdb/src/backend/cdb/dispatcher/cdbgang_async.c>cdbconn_doConnectComplete()</a>
完成连接</p><ul><li><a href=~/Work/gpdb/src/backend/cdb/dispatcher/cdbconn.c>cdbconn_get_motion_listener_port()</a>
与 QE 建立连接后，读取 &ldquo;qe_listener_port&rdquo;</li></ul></li></ul></li></ul></li><li><p><a href=~/Work/gpdb/src/backend/executor/execUtils.c>setupCdbProcessList()</a>
Create a list of CdbProcess and initialize with Gang information.</p></li></ul></li><li><p><a href=~/Work/gpdb/src/backend/executor/execUtils.c>InventorySliceTree()</a>
Helper for AssignGangs takes a simple inventory of the gangs required by a slice tree.</p></li></ul><h2 id=h:c37bea35-e940-428c-befb-d19fa51a1295>3 Receiver
<a class=heading-link href=#h:c37bea35-e940-428c-befb-d19fa51a1295><i class="fa fa-link" aria-hidden=true title=链接到标题></i>
<span class=sr-only>链接到标题</span></a></h2><h2 id=h:d1532cbd-394f-42b8-9331-0704d91794b7>4 Sender
<a class=heading-link href=#h:d1532cbd-394f-42b8-9331-0704d91794b7><i class="fa fa-link" aria-hidden=true title=链接到标题></i>
<span class=sr-only>链接到标题</span></a></h2></div><footer></footer></article></section></div><footer class=footer><section class=container>©
2023
yyc
·
技术支持 <a href=https://gohugo.io/ target=_blank rel=noopener>Hugo</a> & <a href=https://github.com/luizdepra/hugo-coder/ target=_blank rel=noopener>Coder</a>.</section></footer></main><script src=/js/coder.min.6ae284be93d2d19dad1f02b0039508d9aab3180a12a06dcc71b0b0ef7825a317.js integrity="sha256-auKEvpPS0Z2tHwKwA5UI2aqzGAoSoG3McbCw73gloxc="></script></body></html>