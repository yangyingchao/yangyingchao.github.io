<!doctype html><html lang=zh-cn dir=auto><head><meta charset=utf-8><meta http-equiv=x-ua-compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no"><meta name=robots content="index, follow"><title>这个博客是怎么生成的？ | MyNotes</title><meta name=keywords content="hugo,blog"><meta name=description content="1 用 Org Mode + Hugo 写博客，并通过 Github Action 自动部署到 Github Pages 1.1 准备工作 1.2 写博客 1.3 部署篇 1.4 遇到的问题 2 使用 Emacs Script 自动将 org 文件导出为 Markdown 2.1 痛点 2.2 如何解决 2.3 存在的问题"><meta name=author content="Yang, Ying-chao"><link rel=canonical href=https://yangyingchao.github.io/posts/how-this-blog-is-generated/><link crossorigin=anonymous href=/assets/css/stylesheet.fc220c15db4aef0318bbf30adc45d33d4d7c88deff3238b23eb255afdc472ca6.css integrity="sha256-/CIMFdtK7wMYu/MK3EXTPU18iN7/MjiyPrJVr9xHLKY=" rel="preload stylesheet" as=style><link rel=icon href=https://yangyingchao.github.io/favicon.ico><link rel=icon type=image/png sizes=16x16 href=https://yangyingchao.github.io/favicon-16x16.png><link rel=icon type=image/png sizes=32x32 href=https://yangyingchao.github.io/favicon-32x32.png><link rel=apple-touch-icon href=https://yangyingchao.github.io/apple-touch-icon.png><link rel=mask-icon href=https://yangyingchao.github.io/safari-pinned-tab.svg><meta name=theme-color content="#2e2e33"><meta name=msapplication-TileColor content="#2e2e33"><noscript><style>#theme-toggle,.top-link{display:none}</style><style>@media(prefers-color-scheme:dark){:root{--theme:rgb(29, 30, 32);--entry:rgb(46, 46, 51);--primary:rgb(218, 218, 219);--secondary:rgb(155, 156, 157);--tertiary:rgb(65, 66, 68);--content:rgb(196, 196, 197);--code-block-bg:rgb(46, 46, 51);--code-bg:rgb(55, 56, 62);--border:rgb(51, 51, 51)}.list{background:var(--theme)}.list:not(.dark)::-webkit-scrollbar-track{background:0 0}.list:not(.dark)::-webkit-scrollbar-thumb{border-color:var(--theme)}}</style></noscript><meta property="og:title" content="这个博客是怎么生成的？"><meta property="og:description" content="1 用 Org Mode + Hugo 写博客，并通过 Github Action 自动部署到 Github Pages 1.1 准备工作 1.2 写博客 1.3 部署篇 1.4 遇到的问题 2 使用 Emacs Script 自动将 org 文件导出为 Markdown 2.1 痛点 2.2 如何解决 2.3 存在的问题"><meta property="og:type" content="article"><meta property="og:url" content="https://yangyingchao.github.io/posts/how-this-blog-is-generated/"><meta property="article:section" content="posts"><meta property="article:published_time" content="2023-09-05T00:00:00+00:00"><meta property="article:modified_time" content="2023-09-05T00:00:00+00:00"><meta name=twitter:card content="summary"><meta name=twitter:title content="这个博客是怎么生成的？"><meta name=twitter:description content="1 用 Org Mode + Hugo 写博客，并通过 Github Action 自动部署到 Github Pages 1.1 准备工作 1.2 写博客 1.3 部署篇 1.4 遇到的问题 2 使用 Emacs Script 自动将 org 文件导出为 Markdown 2.1 痛点 2.2 如何解决 2.3 存在的问题"><script type=application/ld+json>{"@context":"https://schema.org","@type":"BreadcrumbList","itemListElement":[{"@type":"ListItem","position":1,"name":"Posts","item":"https://yangyingchao.github.io/posts/"},{"@type":"ListItem","position":2,"name":"这个博客是怎么生成的？","item":"https://yangyingchao.github.io/posts/how-this-blog-is-generated/"}]}</script><script type=application/ld+json>{"@context":"https://schema.org","@type":"BlogPosting","headline":"这个博客是怎么生成的？","name":"这个博客是怎么生成的？","description":"1 用 Org Mode + Hugo 写博客，并通过 Github Action 自动部署到 Github Pages 1.1 准备工作 1.2 写博客 1.3 部署篇 1.4 遇到的问题 2 使用 Emacs Script 自动将 org 文件导出为 Markdown 2.1 痛点 2.2 如何解决 2.3 存在的问题","keywords":["hugo","blog"],"articleBody":" 1 用 Org Mode + Hugo 写博客，并通过 Github Action 自动部署到 Github Pages 1.1 准备工作 1.2 写博客 1.3 部署篇 1.4 遇到的问题 2 使用 Emacs Script 自动将 org 文件导出为 Markdown 2.1 痛点 2.2 如何解决 2.3 存在的问题 2.4 遇到的问题 3 附录 3.1 我正在用的 github actions 3.2 当前用的脚本 参考这里：\nhttps://superbear.github.io/post/2021/11/use-org-mode-and-hugo-to-write-blog/ https://superbear.github.io/post/2021/12/batch-export-org-files-to-markdown-with-emacs-script-and-ox-hugo/ 搬运一下，放丢。。。\n以下内容转自 superbear 的博客。\n1 用 Org Mode + Hugo 写博客，并通过 Github Action 自动部署到 Github Pages 1.1 准备工作 1.1.1 创建两个 Github 仓库 用来放 org 文件. markdown 文件及 Hugo 相关配置，可以设置成私有，如 blog。 Github Pages 仓库，用来放生成的静态文件。一般是{username}.github.io。 1.1.2 安装 Hugo a static site generator written in Go 1.1.3 安装 ox-hugo 将 org 文件翻译成 markdown 文件，written in Emacs Lisp。Hugo 支持 Org Mode，但据说支持得不是很好 1。 毕竟 Emacs Lisp 处理 org 文件相关的包比 Go 多，就直接用 ox-hugo 转 markdown 的方案了。 不是 Emacs 用户？\n可跳过 Org Mode 相关内容 1.1.4 配置环境 各软件版本\nEmacs 27.1\nOrg Mode 9.3\nox-hugo 20210916.1332\nHugo v0.89.4\n配置 Hugo\n# 在 blog 仓库中新建 hugo site cd /path/to/blog \u0026\u0026 hugo new site hugo # 选个主题，并设置成子模块（后续升级/替换都比较方便） git submodule add https://github.com/olOwOlo/hugo-theme-even.git hugo/themes/even # 修改默认配置 开启本地实时预览\n# 配置修改. markdown 文件改动都会被监控到 cd blog \u0026\u0026 hugo –source hugo server -D 配置 ox-hugo\n;;; 在 init.el 里或其他文件里加以下代码 (with-eval-after-load 'ox (require 'ox-hugo)) ;;; 可选。全局配置，如导出目录等字段，也可以在 org 文件里进行配置 ;;; M-x customize-variable org-hugo 1.2 写博客 新建 org 目录及文件\ncd blog \u0026\u0026 mkdir -p org/2021/11 # 可选，可以不按年月日分拆分目录。拆分后方便管理，但如果用户直接访问某年的数据，页面就会 404 新建 org 文件，如 test.org\n#+OPTIONS: author:nil ^:{} # 告诉 ox-hugo 将导出的 markdown 文件放到哪里。注意：even 主题需要发布到 post 目录。 # see: https://ox-hugo.scripter.co/#before-you-export #+HUGO_BASE_DIR: ../../../hugo #+HUGO_SECTION: post/2021/11 #+HUGO_CUSTOM_FRONT_MATTER: :toc true #+HUGO_AUTO_SET_LASTMOD: t #+HUGO_DRAFT: false #+DATE: [2021-11-28 Sun 19:28] #+TITLE: 标题 #+HUGO_TAGS: tag1 tag2 #+HUGO_CATEGORIES: category1 category2 Hello，World 导出 org 到 markdown 文件\n在 Emacs 里执行 C-c C-e H h（File to Md file）导出整个 org 文件到 markdown 文件，也可以导出 subtree， 具体看个人喜好\n访问http://127.0.0.1:1313/\n正常情况就会看到博客界面啦\n提交 org 及 markdown 文件到 blog 仓库\n使用 Yasnippet（推荐） 下次新建文件就不用 copy 一些元数据\n# -*- mode: snippet -*- # name: hugo # key: hugo # -- #+OPTIONS: author:nil ^:{} #+HUGO_BASE_DIR: ../../../hugo #+HUGO_SECTION: post/`(format-time-string \"%Y/%m\")` #+HUGO_CUSTOM_FRONT_MATTER: :toc true #+HUGO_AUTO_SET_LASTMOD: t #+HUGO_DRAFT: false #+DATE: `(format-time-string \"[%Y-%m-%d %a %H:%M]\")` #+TITLE: $1 #+HUGO_TAGS: $2 #+HUGO_CATEGORIES: $3 $0 1.2.1 目录结构 . ├── .github │ └── workflows ├── hugo │ ├── archetypes │ ├── content │ │ └── post │ ├── data │ ├── layouts │ │ └── _internal │ ├── static │ └── themes │ └── even ├── org │ └── 2021 │ └── 11 └── scripts 1.3 部署篇 1.3.1 配置 Github Action 在 blog 仓库下新增.github/workflows/main.yml 文件，内容如下：\nname: GitHub Pages on: push: branches: - main # Set a branch to deploy pull_request: jobs: deploy: runs-on: ubuntu-20.04 concurrency: group: ${{ github.workflow }}-${{ github.ref }} steps: # 修改时区 - name: Set Timezone run: sudo timedatectl set-timezone 'Asia/Shanghai' - uses: actions/checkout@v2 with: submodules: true # Fetch Hugo themes (true OR recursive) fetch-depth: 0 # Fetch all history for .GitInfo and .Lastmod - name: Setup Hugo uses: peaceiris/actions-hugo@v2 with: # 建议和本地用的版本保持一致，从而获得一致的体验 hugo-version: '0.89.4' # extended: true - name: Build run: | hugo --source hugo --minify --buildFuture --buildExpired - name: Deploy uses: peaceiris/actions-gh-pages@v3 if: ${{ github.ref == 'refs/heads/main' }} with: # github_token: ${{ secrets.PERSONAL_ACCESS_TOKEN }} # publish_branch: gh-pages # publish_dir: hugo/public deploy_key: ${{ secrets.DEPLOY_KEY }} external_repository: superbear/superbear.github.io # 默认是 master 目录，github 上可修改 publish_branch: master publish_dir: hugo/public 1.3.2 配置 DEPLOY_KEY 生成 github deploy-keys\n将公钥添加至{username}.github.io 仓的 Deploy keys（Settings -\u003e Deploy keys）中； 将私钥添加至 blog 仓库的 secrets（Settings -\u003e Secrets）中； 将本地 blog 目录的改动 push 到远程 blog 仓库 master 分支； 正常情况下，一段时间之后，可以在{username}.github.io 的 master 分支下看到 hugo 生成的静态文件； 没有的话，可以根据 blog 仓库的 Github Actions 日志排查下。 1.4 遇到的问题 部署完成却没有生成文件，就只有一个.nojekyll 文件\n1 \u003c!– actions log –\u003e 2 cp: no such file or directory: /home/runner/work/blog/hugo/public/*\n排查思路：排查 Github Actions 日志，以及写一些 shell 命令查看路径相关信息\nHugo 生成静态文件报错，报错信息如下：\n1 - unmarshal failed: Near line 4 (last key parsed ’tags’): Array contains values of type ‘Integer’ and ‘String’, but arrays must be homogeneous.\n原因：tags 的类型不一致，标签混用了数字和字符串 解决方案：去掉数字类型的标签或升级至最新版本的 hugo\n2 使用 Emacs Script 自动将 org 文件导出为 Markdown 接上篇 用 Org Mode + Hugo 写博客，并通过 Github Action 自动部署到 Github Pages\n2.1 痛点 代码仓库里会同时保存 org 文件和 markdown 文件，markdown 文件其实是中间产物，不想保存。\n2.2 如何解决 首先，Emacs 是可以执行 Emacs Script 的，写个脚本，然后在 Github Action 里执行即可。Emacs 环境哪里来？ purcell 大神已经准备好了。\n废话不多说，直接上代码。\n嵌入 Gist\n1 #+BEGIN_EXPORT html 2 ","wordCount":"2549","inLanguage":"zh-cn","datePublished":"2023-09-05T00:00:00Z","dateModified":"2023-09-05T00:00:00Z","author":[{"@type":"Person","name":"Yang"},{"@type":"Person","name":"Ying-chao"}],"mainEntityOfPage":{"@type":"WebPage","@id":"https://yangyingchao.github.io/posts/how-this-blog-is-generated/"},"publisher":{"@type":"Organization","name":"MyNotes","logo":{"@type":"ImageObject","url":"https://yangyingchao.github.io/favicon.ico"}}}</script></head><body id=top><script>localStorage.getItem("pref-theme")==="dark"?document.body.classList.add("dark"):localStorage.getItem("pref-theme")==="light"?document.body.classList.remove("dark"):window.matchMedia("(prefers-color-scheme: dark)").matches&&document.body.classList.add("dark")</script><header class=header><nav class=nav><div class=logo><a href=https://yangyingchao.github.io accesskey=h title="MyNotes (Alt + H)">MyNotes</a><div class=logo-switches><button id=theme-toggle accesskey=t title="(Alt + T)"><svg id="moon" xmlns="http://www.w3.org/2000/svg" width="24" height="18" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 12.79A9 9 0 1111.21 3 7 7 0 0021 12.79z"/></svg><svg id="sun" xmlns="http://www.w3.org/2000/svg" width="24" height="18" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="5"/><line x1="12" y1="1" x2="12" y2="3"/><line x1="12" y1="21" x2="12" y2="23"/><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"/><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"/><line x1="1" y1="12" x2="3" y2="12"/><line x1="21" y1="12" x2="23" y2="12"/><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"/><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"/></svg></button></div></div><ul id=menu><li><a href=https://yangyingchao.github.io/ title=Home><span>Home</span></a></li><li><a href=https://yangyingchao.github.io/posts/ title=Archives><span>Archives</span></a></li><li><a href=https://yangyingchao.github.io/tags/ title=Tags><span>Tags</span></a></li><li><a href=https://yangyingchao.github.io/categories/ title=Categories><span>Categories</span></a></li><li><a href=https://yangyingchao.github.io/contact/ title="Contact me"><span>Contact me</span></a></li></ul></nav></header><main class=main><article class=post-single><header class=post-header><h1 class="post-title entry-hint-parent">这个博客是怎么生成的？</h1><div class=post-meta><span title='2023-09-05 00:00:00 +0000 UTC'>September 5, 2023</span>&nbsp;·&nbsp;Yang, Ying-chao</div></header><div class=post-content><ul><li>1 <a href=#h:77d4f63b-c1fa-4f57-93b5-c757e41e1a71>用 Org Mode + Hugo 写博客，并通过 Github Action 自动部署到 Github Pages</a><ul><li>1.1 <a href=#h:ae0cb92a-bd96-42bf-9858-deed2ae7d6e4>准备工作</a></li><li>1.2 <a href=#h:a50720d1-7467-43fe-96bf-c99596239cae>写博客</a></li><li>1.3 <a href=#h:fb08f300-8df9-412a-8a7e-0a5978f7d02a>部署篇</a></li><li>1.4 <a href=#h:3d56e5b1-24da-4c13-a233-241622c7a523>遇到的问题</a></li></ul></li><li>2 <a href=#h:3dab7760-3b4f-456e-b112-e2e740204576>使用 Emacs Script 自动将 org 文件导出为 Markdown</a><ul><li>2.1 <a href=#h:d959fa6b-ae45-41e4-8da5-fd800606a0e6>痛点</a></li><li>2.2 <a href=#h:c5499c54-d782-4a29-b13c-e4e74d749915>如何解决</a></li><li>2.3 <a href=#h:b08e34c0-315f-43a9-9b4a-cc087fb86323>存在的问题</a></li><li>2.4 <a href=#h:43b5e31b-6034-4c46-bb48-782b103d0536>遇到的问题</a></li></ul></li><li>3 <a href=#h:7d9d2a30-9a98-4243-8da6-51eb1201b20e>附录</a><ul><li>3.1 <a href=#h:bbb920e4-d3fe-48e3-9221-e4c6c5b53844>我正在用的 github actions</a></li><li>3.2 <a href=#h:006ec282-c3c0-4055-9d39-f9f564afd922>当前用的脚本</a></li></ul></li></ul><p>参考这里：</p><ul><li><a href=https://superbear.github.io/post/2021/11/use-org-mode-and-hugo-to-write-blog/>https://superbear.github.io/post/2021/11/use-org-mode-and-hugo-to-write-blog/</a></li><li><a href=https://superbear.github.io/post/2021/12/batch-export-org-files-to-markdown-with-emacs-script-and-ox-hugo/>https://superbear.github.io/post/2021/12/batch-export-org-files-to-markdown-with-emacs-script-and-ox-hugo/</a></li></ul><p>搬运一下，放丢。。。</p><p>以下内容转自 superbear 的博客。</p><h2 id=h:77d4f63b-c1fa-4f57-93b5-c757e41e1a71>1 用 Org Mode + Hugo 写博客，并通过 Github Action 自动部署到 Github Pages<a hidden class=anchor aria-hidden=true href=#h:77d4f63b-c1fa-4f57-93b5-c757e41e1a71>#</a></h2><h3 id=h:ae0cb92a-bd96-42bf-9858-deed2ae7d6e4>1.1 准备工作<a hidden class=anchor aria-hidden=true href=#h:ae0cb92a-bd96-42bf-9858-deed2ae7d6e4>#</a></h3><h4 id=h:be11c5fd-358f-4257-a3de-991dacf33dfa>1.1.1 创建两个 Github 仓库<a hidden class=anchor aria-hidden=true href=#h:be11c5fd-358f-4257-a3de-991dacf33dfa>#</a></h4><ul><li>用来放 org 文件. markdown 文件及 Hugo 相关配置，可以设置成私有，如 blog。</li><li>Github Pages 仓库，用来放生成的静态文件。一般是{username}.github.io。</li></ul><h4 id=h:590f68ab-9703-405b-8365-c2b1805bb518>1.1.2 安装 Hugo<a hidden class=anchor aria-hidden=true href=#h:590f68ab-9703-405b-8365-c2b1805bb518>#</a></h4><ul><li>a static site generator written in Go</li></ul><h4 id=h:16bf7be3-b1f1-480f-a90a-194c11970799>1.1.3 安装 ox-hugo<a hidden class=anchor aria-hidden=true href=#h:16bf7be3-b1f1-480f-a90a-194c11970799>#</a></h4><ul><li>将 org 文件翻译成 markdown 文件，written in Emacs Lisp。Hugo 支持 Org Mode，但据说支持得不是很好 1。
毕竟 Emacs Lisp 处理 org 文件相关的包比 Go 多，就直接用 ox-hugo 转 markdown 的方案了。</li></ul><p>不是 Emacs 用户？</p><ul><li>可跳过 Org Mode 相关内容</li></ul><h4 id=h:221b082e-bedf-46ae-9957-6eb4272b962d>1.1.4 配置环境<a hidden class=anchor aria-hidden=true href=#h:221b082e-bedf-46ae-9957-6eb4272b962d>#</a></h4><p>各软件版本</p><ul><li><p>Emacs 27.1</p></li><li><p>Org Mode 9.3</p></li><li><p>ox-hugo 20210916.1332</p></li><li><p>Hugo v0.89.4</p></li><li><p>配置 Hugo</p><ol><li># 在 blog 仓库中新建 hugo site</li><li>cd /path/to/blog && hugo new site hugo</li><li># 选个主题，并设置成子模块（后续升级/替换都比较方便）</li><li>git submodule add <a href=https://github.com/olOwOlo/hugo-theme-even.git>https://github.com/olOwOlo/hugo-theme-even.git</a> hugo/themes/even</li><li># 修改默认配置</li></ol></li><li><p>开启本地实时预览</p><ol><li># 配置修改. markdown 文件改动都会被监控到</li><li>cd blog && hugo –source hugo server -D</li></ol></li><li><p>配置 ox-hugo</p></li></ul><div class=highlight><pre tabindex=0 style=color:#93a1a1;background-color:#002b36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-emacs-lisp data-lang=emacs-lisp><span style=display:flex><span><span style=color:#586e75>;;; 在 init.el 里或其他文件里加以下代码</span>
</span></span><span style=display:flex><span>(<span style=color:#b58900>with-eval-after-load</span> <span style=color:#2aa198>&#39;ox</span>
</span></span><span style=display:flex><span>  (<span style=color:#b58900>require</span> <span style=color:#2aa198>&#39;ox-hugo</span>))
</span></span><span style=display:flex><span><span style=color:#586e75>;;; 可选。全局配置，如导出目录等字段，也可以在 org 文件里进行配置</span>
</span></span><span style=display:flex><span><span style=color:#586e75>;;; M-x customize-variable org-hugo</span>
</span></span></code></pre></div><h3 id=h:a50720d1-7467-43fe-96bf-c99596239cae>1.2 写博客<a hidden class=anchor aria-hidden=true href=#h:a50720d1-7467-43fe-96bf-c99596239cae>#</a></h3><ol><li><p>新建 org 目录及文件</p><ol><li>cd blog && mkdir -p org/2021/11</li><li># 可选，可以不按年月日分拆分目录。拆分后方便管理，但如果用户直接访问某年的数据，页面就会 404</li></ol></li><li><p>新建 org 文件，如 test.org</p></li></ol><div class=highlight><pre tabindex=0 style=color:#93a1a1;background-color:#002b36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-org data-lang=org><span style=display:flex><span><span style=color:#719e07>#+OPTIONS</span><span style=color:#586e75>: author:nil ^:{}</span>
</span></span><span style=display:flex><span><span style=color:#586e75># 告诉 ox-hugo 将导出的 markdown 文件放到哪里。注意：even 主题需要发布到 post 目录。</span>
</span></span><span style=display:flex><span><span style=color:#586e75># see: https://ox-hugo.scripter.co/#before-you-export</span>
</span></span><span style=display:flex><span><span style=color:#719e07>#+HUGO_BASE_DIR</span><span style=color:#586e75>: ../../../hugo</span>
</span></span><span style=display:flex><span><span style=color:#719e07>#+HUGO_SECTION</span><span style=color:#586e75>: post/2021/11</span>
</span></span><span style=display:flex><span><span style=color:#719e07>#+HUGO_CUSTOM_FRONT_MATTER</span><span style=color:#586e75>: :toc true</span>
</span></span><span style=display:flex><span><span style=color:#719e07>#+HUGO_AUTO_SET_LASTMOD</span><span style=color:#586e75>: t</span>
</span></span><span style=display:flex><span><span style=color:#719e07>#+HUGO_DRAFT</span><span style=color:#586e75>: false</span>
</span></span><span style=display:flex><span><span style=color:#719e07>#+DATE</span><span style=color:#586e75>: [2021-11-28 Sun 19:28]</span>
</span></span><span style=display:flex><span><span style=color:#719e07>#+TITLE</span><span style=color:#586e75>: 标题</span>
</span></span><span style=display:flex><span><span style=color:#719e07>#+HUGO_TAGS</span><span style=color:#586e75>: tag1 tag2</span>
</span></span><span style=display:flex><span><span style=color:#719e07>#+HUGO_CATEGORIES</span><span style=color:#586e75>: category1 category2</span>
</span></span><span style=display:flex><span>Hello，World
</span></span></code></pre></div><ol><li><p>导出 org 到 markdown 文件</p></li><li><p>在 Emacs 里执行 C-c C-e H h（File to Md file）导出整个 org 文件到 markdown 文件，也可以导出 subtree，
具体看个人喜好</p></li><li><p>访问<a href=http://127.0.0.1:1313/>http://127.0.0.1:1313/</a></p></li><li><p>正常情况就会看到博客界面啦</p></li><li><p>提交 org 及 markdown 文件到 blog 仓库</p></li><li><p>使用 Yasnippet（推荐） 下次新建文件就不用 copy 一些元数据</p></li></ol><div class=highlight><pre tabindex=0 style=color:#93a1a1;background-color:#002b36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-fallback data-lang=fallback><span style=display:flex><span># -*- mode: snippet -*-
</span></span><span style=display:flex><span># name: hugo
</span></span><span style=display:flex><span># key: hugo
</span></span><span style=display:flex><span># --
</span></span><span style=display:flex><span>#+OPTIONS: author:nil ^:{}
</span></span><span style=display:flex><span>#+HUGO_BASE_DIR: ../../../hugo
</span></span><span style=display:flex><span>#+HUGO_SECTION: post/`(format-time-string &#34;%Y/%m&#34;)`
</span></span><span style=display:flex><span>#+HUGO_CUSTOM_FRONT_MATTER: :toc true
</span></span><span style=display:flex><span>#+HUGO_AUTO_SET_LASTMOD: t
</span></span><span style=display:flex><span>#+HUGO_DRAFT: false
</span></span><span style=display:flex><span>#+DATE: `(format-time-string &#34;[%Y-%m-%d %a %H:%M]&#34;)`
</span></span><span style=display:flex><span>#+TITLE: $1
</span></span><span style=display:flex><span>#+HUGO_TAGS: $2
</span></span><span style=display:flex><span>#+HUGO_CATEGORIES: $3
</span></span><span style=display:flex><span>$0
</span></span></code></pre></div><h4 id=h:2a8af21d-c8c0-41f1-8925-1c7a68063f84>1.2.1 目录结构<a hidden class=anchor aria-hidden=true href=#h:2a8af21d-c8c0-41f1-8925-1c7a68063f84>#</a></h4><div class=highlight><pre tabindex=0 style=color:#93a1a1;background-color:#002b36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-text data-lang=text><span style=display:flex><span> &lt;!-- blog 仓库目录结构如下 --&gt;
</span></span><span style=display:flex><span>  &lt;!-- tree -a -d -L 3 -I .git --&gt;
</span></span><span style=display:flex><span>.
</span></span><span style=display:flex><span>├── .github
</span></span><span style=display:flex><span>│   └── workflows
</span></span><span style=display:flex><span>├── hugo
</span></span><span style=display:flex><span>│   ├── archetypes
</span></span><span style=display:flex><span>│   ├── content
</span></span><span style=display:flex><span>│   │   └── post
</span></span><span style=display:flex><span>│   ├── data
</span></span><span style=display:flex><span>│   ├── layouts
</span></span><span style=display:flex><span>│   │   └── _internal
</span></span><span style=display:flex><span>│   ├── static
</span></span><span style=display:flex><span>│   └── themes
</span></span><span style=display:flex><span>│       └── even
</span></span><span style=display:flex><span>├── org
</span></span><span style=display:flex><span>│   └── 2021
</span></span><span style=display:flex><span>│       └── 11
</span></span><span style=display:flex><span>└── scripts
</span></span></code></pre></div><h3 id=h:fb08f300-8df9-412a-8a7e-0a5978f7d02a>1.3 部署篇<a hidden class=anchor aria-hidden=true href=#h:fb08f300-8df9-412a-8a7e-0a5978f7d02a>#</a></h3><h4 id=h:c47c61b5-6463-4b58-a111-0c975a87abf2>1.3.1 配置 Github Action<a hidden class=anchor aria-hidden=true href=#h:c47c61b5-6463-4b58-a111-0c975a87abf2>#</a></h4><p>在 blog 仓库下新增.github/workflows/main.yml 文件，内容如下：</p><div class=highlight><pre tabindex=0 style=color:#93a1a1;background-color:#002b36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#268bd2>name</span>: GitHub Pages
</span></span><span style=display:flex><span><span style=color:#268bd2>on</span>:
</span></span><span style=display:flex><span>  <span style=color:#268bd2>push</span>:
</span></span><span style=display:flex><span>    <span style=color:#268bd2>branches</span>:
</span></span><span style=display:flex><span>      - main  <span style=color:#586e75># Set a branch to deploy</span>
</span></span><span style=display:flex><span>  <span style=color:#268bd2>pull_request</span>:
</span></span><span style=display:flex><span><span style=color:#268bd2>jobs</span>:
</span></span><span style=display:flex><span>  <span style=color:#268bd2>deploy</span>:
</span></span><span style=display:flex><span>    <span style=color:#268bd2>runs-on</span>: ubuntu-20.04
</span></span><span style=display:flex><span>    <span style=color:#268bd2>concurrency</span>:
</span></span><span style=display:flex><span>      <span style=color:#268bd2>group</span>: ${{ github.workflow }}-${{ github.ref }}
</span></span><span style=display:flex><span>    <span style=color:#268bd2>steps</span>:
</span></span><span style=display:flex><span>      <span style=color:#586e75># 修改时区</span>
</span></span><span style=display:flex><span>      - <span style=color:#268bd2>name</span>: Set Timezone
</span></span><span style=display:flex><span>        <span style=color:#268bd2>run</span>: sudo timedatectl set-timezone &#39;Asia/Shanghai&#39;
</span></span><span style=display:flex><span>      - <span style=color:#268bd2>uses</span>: actions/checkout@v2
</span></span><span style=display:flex><span>        <span style=color:#268bd2>with</span>:
</span></span><span style=display:flex><span>          <span style=color:#268bd2>submodules</span>: <span style=color:#cb4b16>true</span>  <span style=color:#586e75># Fetch Hugo themes (true OR recursive)</span>
</span></span><span style=display:flex><span>          <span style=color:#268bd2>fetch-depth</span>: <span style=color:#2aa198>0</span>    <span style=color:#586e75># Fetch all history for .GitInfo and .Lastmod</span>
</span></span><span style=display:flex><span>      - <span style=color:#268bd2>name</span>: Setup Hugo
</span></span><span style=display:flex><span>        <span style=color:#268bd2>uses</span>: peaceiris/actions-hugo@v2
</span></span><span style=display:flex><span>        <span style=color:#268bd2>with</span>:
</span></span><span style=display:flex><span>          <span style=color:#586e75># 建议和本地用的版本保持一致，从而获得一致的体验</span>
</span></span><span style=display:flex><span>          <span style=color:#268bd2>hugo-version</span>: <span style=color:#2aa198>&#39;0.89.4&#39;</span>
</span></span><span style=display:flex><span>          <span style=color:#586e75># extended: true</span>
</span></span><span style=display:flex><span>      - <span style=color:#268bd2>name</span>: Build
</span></span><span style=display:flex><span>        <span style=color:#268bd2>run</span>: |<span style=color:#2aa198>
</span></span></span><span style=display:flex><span><span style=color:#2aa198>          hugo --source hugo --minify --buildFuture --buildExpired</span>          
</span></span><span style=display:flex><span>      - <span style=color:#268bd2>name</span>: Deploy
</span></span><span style=display:flex><span>        <span style=color:#268bd2>uses</span>: peaceiris/actions-gh-pages@v3
</span></span><span style=display:flex><span>        <span style=color:#268bd2>if</span>: ${{ github.ref == &#39;refs/heads/main&#39; }}
</span></span><span style=display:flex><span>        <span style=color:#268bd2>with</span>:
</span></span><span style=display:flex><span>          <span style=color:#586e75># github_token: ${{ secrets.PERSONAL_ACCESS_TOKEN }}</span>
</span></span><span style=display:flex><span>          <span style=color:#586e75># publish_branch: gh-pages</span>
</span></span><span style=display:flex><span>          <span style=color:#586e75># publish_dir: hugo/public</span>
</span></span><span style=display:flex><span>          <span style=color:#268bd2>deploy_key</span>: ${{ secrets.DEPLOY_KEY }}
</span></span><span style=display:flex><span>          <span style=color:#268bd2>external_repository</span>: superbear/superbear.github.io
</span></span><span style=display:flex><span>          <span style=color:#586e75># 默认是 master 目录，github 上可修改</span>
</span></span><span style=display:flex><span>          <span style=color:#268bd2>publish_branch</span>: master
</span></span><span style=display:flex><span>          <span style=color:#268bd2>publish_dir</span>: hugo/public
</span></span></code></pre></div><h4 id=h:fe0a2943-fea6-4455-a7c4-3300df3ed776>1.3.2 配置 DEPLOY_KEY<a hidden class=anchor aria-hidden=true href=#h:fe0a2943-fea6-4455-a7c4-3300df3ed776>#</a></h4><p>生成 github deploy-keys</p><ol><li>将公钥添加至{username}.github.io 仓的 Deploy keys（Settings -> Deploy keys）中；</li><li>将私钥添加至 blog 仓库的 secrets（Settings -> Secrets）中；</li><li>将本地 blog 目录的改动 push 到远程 blog 仓库 master 分支；</li><li>正常情况下，一段时间之后，可以在{username}.github.io 的 master 分支下看到 hugo 生成的静态文件；</li><li>没有的话，可以根据 blog 仓库的 Github Actions 日志排查下。</li></ol><h3 id=h:3d56e5b1-24da-4c13-a233-241622c7a523>1.4 遇到的问题<a hidden class=anchor aria-hidden=true href=#h:3d56e5b1-24da-4c13-a233-241622c7a523>#</a></h3><ol><li><p>部署完成却没有生成文件，就只有一个.nojekyll 文件</p><p>1 &lt;!– actions log –>
2 cp: no such file or directory: /home/runner/work/blog/hugo/public/*</p></li></ol><p>排查思路：排查 Github Actions 日志，以及写一些 shell 命令查看路径相关信息</p><ol><li><p>Hugo 生成静态文件报错，报错信息如下：</p><p>1 - unmarshal failed: Near line 4 (last key parsed &rsquo;tags&rsquo;): Array contains values of type &lsquo;Integer&rsquo; and &lsquo;String&rsquo;, but arrays must be homogeneous.</p></li></ol><p>原因：tags 的类型不一致，标签混用了数字和字符串
解决方案：去掉数字类型的标签或升级至最新版本的 hugo</p><h2 id=h:3dab7760-3b4f-456e-b112-e2e740204576>2 使用 Emacs Script 自动将 org 文件导出为 Markdown<a hidden class=anchor aria-hidden=true href=#h:3dab7760-3b4f-456e-b112-e2e740204576>#</a></h2><p>接上篇 用 Org Mode + Hugo 写博客，并通过 Github Action 自动部署到 Github Pages</p><h3 id=h:d959fa6b-ae45-41e4-8da5-fd800606a0e6>2.1 痛点<a hidden class=anchor aria-hidden=true href=#h:d959fa6b-ae45-41e4-8da5-fd800606a0e6>#</a></h3><p>代码仓库里会同时保存 org 文件和 markdown 文件，markdown 文件其实是中间产物，不想保存。</p><h3 id=h:c5499c54-d782-4a29-b13c-e4e74d749915>2.2 如何解决<a hidden class=anchor aria-hidden=true href=#h:c5499c54-d782-4a29-b13c-e4e74d749915>#</a></h3><p>首先，Emacs 是可以执行 Emacs Script 的，写个脚本，然后在 Github Action 里执行即可。Emacs 环境哪里来？
purcell 大神已经准备好了。</p><p>废话不多说，直接上代码。</p><p>嵌入 Gist</p><p>1 #+BEGIN_EXPORT html
2 &lt;script src="<a href=https://gist.github.com/superbear/28fb0dbbca505b5d7d83e10e35b822a4.js>https://gist.github.com/superbear/28fb0dbbca505b5d7d83e10e35b822a4.js</a>">&lt;/script>
3 #+END_EXPORT</p><p>等等，直接用 markdown 写是不是就没有这个痛点了？嗯😄。</p><h3 id=h:b08e34c0-315f-43a9-9b4a-cc087fb86323>2.3 存在的问题<a hidden class=anchor aria-hidden=true href=#h:b08e34c0-315f-43a9-9b4a-cc087fb86323>#</a></h3><p>目前是全量导出，找到指定目录下的全部 org 文件，然后转成 markdown 文件。 这样每提交一篇文章，就需要
处理全部存量文章。另外，全部文章的更新时间都会跟着变，这个和 HUGO_AUTO_SET_LASTMOD 这个 property
设置有关。详见：ox-hugo last modified 。待改成增量导出。</p><h3 id=h:43b5e31b-6034-4c46-bb48-782b103d0536>2.4 遇到的问题<a hidden class=anchor aria-hidden=true href=#h:43b5e31b-6034-4c46-bb48-782b103d0536>#</a></h3><ol><li>org 导出 markdown 文件了，但未生成静态文件</li></ol><p>原因：时区问题。Github Action 是按 UTC 时间执行的，而文件的发布日期是东八区的，这样 Hugo 可能会看到
发布日期还未到，就不处理了 1。
解决方案：修改 Github Action job 的时区，可一并解决文件修改时间不对的问题；或修改 Hugo 运行时的配
置，增加–buildFuture 参数。</p><h2 id=h:7d9d2a30-9a98-4243-8da6-51eb1201b20e>3 附录<a hidden class=anchor aria-hidden=true href=#h:7d9d2a30-9a98-4243-8da6-51eb1201b20e>#</a></h2><h3 id=h:bbb920e4-d3fe-48e3-9221-e4c6c5b53844>3.1 我正在用的 github actions<a hidden class=anchor aria-hidden=true href=#h:bbb920e4-d3fe-48e3-9221-e4c6c5b53844>#</a></h3><div class=highlight><pre tabindex=0 style=color:#93a1a1;background-color:#002b36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#586e75># Sample workflow for building and deploying a Hugo site to GitHub Pages</span>
</span></span><span style=display:flex><span><span style=color:#268bd2>name</span>: Deploy Hugo site to Pages
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#268bd2>on</span>:
</span></span><span style=display:flex><span>  <span style=color:#586e75># Runs on pushes targeting the default branch</span>
</span></span><span style=display:flex><span>  <span style=color:#268bd2>push</span>:
</span></span><span style=display:flex><span>    <span style=color:#268bd2>branches</span>: [<span style=color:#2aa198>&#34;master&#34;</span>]
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#586e75># Allows you to run this workflow manually from the Actions tab</span>
</span></span><span style=display:flex><span>  <span style=color:#268bd2>workflow_dispatch</span>:
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#586e75># Sets permissions of the GITHUB_TOKEN to allow deployment to GitHub Pages</span>
</span></span><span style=display:flex><span><span style=color:#268bd2>permissions</span>:
</span></span><span style=display:flex><span>  <span style=color:#268bd2>contents</span>: read
</span></span><span style=display:flex><span>  <span style=color:#268bd2>pages</span>: write
</span></span><span style=display:flex><span>  <span style=color:#268bd2>id-token</span>: write
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#586e75># Allow only one concurrent deployment, skipping runs queued between the run in-progress and latest queued.</span>
</span></span><span style=display:flex><span><span style=color:#586e75># However, do NOT cancel in-progress runs as we want to allow these production deployments to complete.</span>
</span></span><span style=display:flex><span><span style=color:#268bd2>concurrency</span>:
</span></span><span style=display:flex><span>  <span style=color:#268bd2>group</span>: <span style=color:#2aa198>&#34;pages&#34;</span>
</span></span><span style=display:flex><span>  <span style=color:#268bd2>cancel-in-progress</span>: <span style=color:#cb4b16>false</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#586e75># Default to bash</span>
</span></span><span style=display:flex><span><span style=color:#268bd2>defaults</span>:
</span></span><span style=display:flex><span>  <span style=color:#268bd2>run</span>:
</span></span><span style=display:flex><span>    <span style=color:#268bd2>shell</span>: bash
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#268bd2>jobs</span>:
</span></span><span style=display:flex><span>  <span style=color:#268bd2>build</span>:
</span></span><span style=display:flex><span>    <span style=color:#268bd2>runs-on</span>: ubuntu-20.04
</span></span><span style=display:flex><span>    <span style=color:#268bd2>concurrency</span>:
</span></span><span style=display:flex><span>      <span style=color:#268bd2>group</span>: ${{ github.workflow }}-${{ github.ref }}
</span></span><span style=display:flex><span>    <span style=color:#268bd2>steps</span>:
</span></span><span style=display:flex><span>      - <span style=color:#268bd2>uses</span>: actions/checkout@v2
</span></span><span style=display:flex><span>        <span style=color:#268bd2>with</span>:
</span></span><span style=display:flex><span>          <span style=color:#268bd2>submodules</span>: <span style=color:#cb4b16>true</span>  <span style=color:#586e75># Fetch Hugo themes (true OR recursive)</span>
</span></span><span style=display:flex><span>          <span style=color:#268bd2>fetch-depth</span>: <span style=color:#2aa198>0</span>    <span style=color:#586e75># Fetch all history for .GitInfo and .Lastmod</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>      - <span style=color:#268bd2>name</span>: Setup Hugo
</span></span><span style=display:flex><span>        <span style=color:#268bd2>uses</span>: peaceiris/actions-hugo@v2
</span></span><span style=display:flex><span>        <span style=color:#268bd2>with</span>:
</span></span><span style=display:flex><span>          <span style=color:#268bd2>hugo-version</span>: <span style=color:#2aa198>&#39;0.115.0&#39;</span>
</span></span><span style=display:flex><span>          <span style=color:#268bd2>extended</span>: <span style=color:#cb4b16>true</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>      - <span style=color:#268bd2>name</span>: Setup Emacs
</span></span><span style=display:flex><span>        <span style=color:#268bd2>uses</span>: purcell/setup-emacs@master
</span></span><span style=display:flex><span>        <span style=color:#268bd2>with</span>:
</span></span><span style=display:flex><span>          <span style=color:#268bd2>version</span>: <span style=color:#2aa198>29.1</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>      - <span style=color:#268bd2>name</span>: Export Markdown
</span></span><span style=display:flex><span>        <span style=color:#268bd2>run</span>: |<span style=color:#2aa198>
</span></span></span><span style=display:flex><span><span style=color:#2aa198>          # 将org文件导出成md文件
</span></span></span><span style=display:flex><span><span style=color:#2aa198>          mkdir ~/.emacs.d
</span></span></span><span style=display:flex><span><span style=color:#2aa198>          cd script &amp;&amp; sh batch-export-org-files-to-md-with-ox-hugo.el</span>          
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>      - <span style=color:#268bd2>name</span>: Build
</span></span><span style=display:flex><span>        <span style=color:#268bd2>run</span>: |<span style=color:#2aa198>
</span></span></span><span style=display:flex><span><span style=color:#2aa198>          cd hugo &amp;&amp; hugo --minify --buildFuture --buildExpired</span>          
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>      - <span style=color:#268bd2>name</span>: Upload artifact
</span></span><span style=display:flex><span>        <span style=color:#268bd2>uses</span>: actions/upload-pages-artifact@v2
</span></span><span style=display:flex><span>        <span style=color:#268bd2>with</span>:
</span></span><span style=display:flex><span>          <span style=color:#268bd2>path</span>: ./hugo/public
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>      - <span style=color:#268bd2>name</span>: Deploy
</span></span><span style=display:flex><span>        <span style=color:#268bd2>uses</span>: peaceiris/actions-gh-pages@v3
</span></span><span style=display:flex><span>        <span style=color:#586e75># If you&#39;re changing the branch from main,</span>
</span></span><span style=display:flex><span>        <span style=color:#586e75># also change the `main` in `refs/heads/main`</span>
</span></span><span style=display:flex><span>        <span style=color:#586e75># below accordingly.</span>
</span></span><span style=display:flex><span>        <span style=color:#268bd2>if</span>: github.ref == &#39;refs/heads/master&#39;
</span></span><span style=display:flex><span>        <span style=color:#268bd2>with</span>:
</span></span><span style=display:flex><span>          <span style=color:#268bd2>publish_branch</span>: master
</span></span><span style=display:flex><span>          <span style=color:#268bd2>publish_dir</span>: hugo/public
</span></span><span style=display:flex><span>          <span style=color:#268bd2>deploy_key</span>: ${{ secrets.DEPLOY }}
</span></span><span style=display:flex><span>          <span style=color:#268bd2>external_repository</span>: yangyingchao/yangyingchao.github.io
</span></span></code></pre></div><h3 id=h:006ec282-c3c0-4055-9d39-f9f564afd922>3.2 当前用的脚本<a hidden class=anchor aria-hidden=true href=#h:006ec282-c3c0-4055-9d39-f9f564afd922>#</a></h3><div class=highlight><pre tabindex=0 style=color:#93a1a1;background-color:#002b36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-emacs-lisp data-lang=emacs-lisp><span style=display:flex><span>#<span style=color:#268bd2>!/usr/bin/env</span> <span style=color:#268bd2>sh</span>
</span></span><span style=display:flex><span><span style=color:#719e07>:</span><span style=color:#586e75>; set -e # -*- mode: emacs-lisp; lexical-binding: t -*-</span>
</span></span><span style=display:flex><span><span style=color:#719e07>:</span><span style=color:#586e75>; emacs --no-site-file --script &#34;$0&#34; -- &#34;$@&#34; || __EXITCODE=$?</span>
</span></span><span style=display:flex><span><span style=color:#719e07>:</span><span style=color:#586e75>; exit 0</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#586e75>;;; Code:</span>
</span></span><span style=display:flex><span>(<span style=color:#b58900>defvar</span> <span style=color:#268bd2>bootstrap-version</span>)
</span></span><span style=display:flex><span>(<span style=color:#b58900>defvar</span> <span style=color:#268bd2>straight-base-dir</span>)
</span></span><span style=display:flex><span>(<span style=color:#b58900>defvar</span> <span style=color:#268bd2>straight-fix-org</span>)
</span></span><span style=display:flex><span>(<span style=color:#b58900>defvar</span> <span style=color:#268bd2>straight-vc-git-default-clone-depth</span> <span style=color:#2aa198>1</span>)
</span></span><span style=display:flex><span>(<span style=color:#b58900>defvar</span> <span style=color:#268bd2>publish--straight-repos-dir</span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>(<span style=color:#b58900>setq</span> <span style=color:#268bd2>gc-cons-threshold</span> <span style=color:#2aa198>83886080</span> <span style=color:#586e75>; 80MiB</span>
</span></span><span style=display:flex><span>      <span style=color:#268bd2>straight-base-dir</span> (<span style=color:#268bd2>expand-file-name</span> <span style=color:#2aa198>&#34;../..&#34;</span> (<span style=color:#b58900>or</span> <span style=color:#268bd2>load-file-name</span> <span style=color:#268bd2>buffer-file-name</span>))
</span></span><span style=display:flex><span>      <span style=color:#268bd2>straight-fix-org</span> <span style=color:#cb4b16>t</span>
</span></span><span style=display:flex><span>      <span style=color:#268bd2>straight-vc-git-default-clone-depth</span> <span style=color:#2aa198>1</span>
</span></span><span style=display:flex><span>      <span style=color:#268bd2>publish--straight-repos-dir</span> (<span style=color:#268bd2>expand-file-name</span> <span style=color:#2aa198>&#34;straight/repos/&#34;</span> <span style=color:#268bd2>straight-base-dir</span>))
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>(<span style=color:#b58900>let</span> ((<span style=color:#268bd2>bootstrap-file</span> (<span style=color:#268bd2>expand-file-name</span> <span style=color:#2aa198>&#34;straight/repos/straight.el/bootstrap.el&#34;</span> <span style=color:#268bd2>straight-base-dir</span>))
</span></span><span style=display:flex><span>      (<span style=color:#268bd2>bootstrap-version</span> <span style=color:#2aa198>5</span>))
</span></span><span style=display:flex><span>  (<span style=color:#b58900>unless</span> (<span style=color:#268bd2>file-exists-p</span> <span style=color:#268bd2>bootstrap-file</span>)
</span></span><span style=display:flex><span>    (<span style=color:#b58900>with-current-buffer</span>
</span></span><span style=display:flex><span>        (<span style=color:#268bd2>url-retrieve-synchronously</span>
</span></span><span style=display:flex><span>         <span style=color:#2aa198>&#34;https://raw.githubusercontent.com/raxod502/straight.el/develop/install.el&#34;</span>
</span></span><span style=display:flex><span>         <span style=color:#2aa198>&#39;silent</span> <span style=color:#2aa198>&#39;inhibit-cookies</span>)
</span></span><span style=display:flex><span>      (<span style=color:#268bd2>goto-char</span> (<span style=color:#268bd2>point-max</span>))
</span></span><span style=display:flex><span>      (<span style=color:#268bd2>eval-print-last-sexp</span>)))
</span></span><span style=display:flex><span>  (<span style=color:#268bd2>load</span> <span style=color:#268bd2>bootstrap-file</span> <span style=color:#cb4b16>nil</span> <span style=color:#2aa198>&#39;nomessage</span>))
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#586e75>;;; org &amp;&amp; ox-hugo</span>
</span></span><span style=display:flex><span>(<span style=color:#268bd2>straight-use-package</span> <span style=color:#719e07>&#39;</span>(<span style=color:#268bd2>org</span> <span style=color:#b58900>:type</span> <span style=color:#268bd2>built-in</span>))
</span></span><span style=display:flex><span>(<span style=color:#268bd2>straight-use-package</span>
</span></span><span style=display:flex><span> <span style=color:#719e07>&#39;</span>(<span style=color:#268bd2>ox-hugo</span> <span style=color:#b58900>:type</span> <span style=color:#268bd2>git</span>
</span></span><span style=display:flex><span>           <span style=color:#b58900>:host</span> <span style=color:#268bd2>github</span>
</span></span><span style=display:flex><span>           <span style=color:#b58900>:repo</span> <span style=color:#2aa198>&#34;kaushalmodi/ox-hugo&#34;</span>
</span></span><span style=display:flex><span>           <span style=color:#b58900>:nonrecursive</span> <span style=color:#cb4b16>t</span>))
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>(<span style=color:#b58900>require</span> <span style=color:#2aa198>&#39;ox-hugo</span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>(<span style=color:#b58900>defun</span> <span style=color:#268bd2>yc/org-hugo--build-toc-a</span> (<span style=color:#268bd2>content</span>)
</span></span><span style=display:flex><span>  <span style=color:#2aa198>&#34;Append my markers.
</span></span></span><span style=display:flex><span><span style=color:#2aa198>
</span></span></span><span style=display:flex><span><span style=color:#2aa198>These markers are used to identify original source of this note.&#34;</span>
</span></span><span style=display:flex><span>  (<span style=color:#268bd2>concat</span> (<span style=color:#b58900>or</span> <span style=color:#268bd2>content</span> <span style=color:#2aa198>&#34;&#34;</span>)
</span></span><span style=display:flex><span>    (<span style=color:#b58900>save-excursion</span>
</span></span><span style=display:flex><span>      (<span style=color:#268bd2>goto-char</span> (<span style=color:#268bd2>point-min</span>))
</span></span><span style=display:flex><span>      (<span style=color:#b58900>if</span> (<span style=color:#268bd2>re-search-forward</span> (<span style=color:#b58900>rx</span> <span style=color:#268bd2>bol</span> <span style=color:#2aa198>&#34;:NOTER_DOCUMENT:&#34;</span> (<span style=color:#268bd2>*</span> <span style=color:#268bd2>space</span>) (<span style=color:#268bd2>group</span> (<span style=color:#268bd2>+</span> <span style=color:#268bd2>nonl</span>)) <span style=color:#268bd2>eol</span>))
</span></span><span style=display:flex><span>          (<span style=color:#b58900>let</span> ((<span style=color:#268bd2>orig</span> (<span style=color:#268bd2>match-string</span> <span style=color:#2aa198>1</span>)))
</span></span><span style=display:flex><span>            (<span style=color:#268bd2>format</span> <span style=color:#2aa198>&#34;\n\n本文为摘录，原文为： %s\n&#34;</span> <span style=color:#268bd2>orig</span>))
</span></span><span style=display:flex><span>        <span style=color:#2aa198>&#34;&#34;</span>))))
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>(<span style=color:#268bd2>advice-add</span> <span style=color:#268bd2>#&#39;</span><span style=color:#268bd2>org-hugo--build-toc</span> <span style=color:#b58900>:filter-return</span> <span style=color:#268bd2>#&#39;</span><span style=color:#268bd2>yc/org-hugo--build-toc-a</span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>(<span style=color:#b58900>defun</span> <span style=color:#268bd2>tnote/export-org-file-to-md</span> (<span style=color:#268bd2>file</span>)
</span></span><span style=display:flex><span>  <span style=color:#2aa198>&#34;Export single FILE to markdown.&#34;</span>
</span></span><span style=display:flex><span>  (<span style=color:#268bd2>message</span> <span style=color:#2aa198>&#34;Checking file %s&#34;</span> <span style=color:#268bd2>file</span>)
</span></span><span style=display:flex><span>  (<span style=color:#b58900>if</span> (<span style=color:#b58900>and</span> (<span style=color:#268bd2>file-exists-p</span> <span style=color:#268bd2>file</span>)
</span></span><span style=display:flex><span>           (<span style=color:#268bd2>string-equal</span> (<span style=color:#268bd2>file-name-extension</span> <span style=color:#268bd2>file</span>) <span style=color:#2aa198>&#34;org&#34;</span>)
</span></span><span style=display:flex><span>           (<span style=color:#268bd2>not</span> (<span style=color:#268bd2>string-match-p</span> (<span style=color:#b58900>rx</span> (<span style=color:#b58900>or</span> <span style=color:#2aa198>&#34;inbox&#34;</span> <span style=color:#2aa198>&#34;gtd&#34;</span>)) <span style=color:#268bd2>file</span>)))
</span></span><span style=display:flex><span>            (<span style=color:#b58900>with-current-buffer</span> (<span style=color:#268bd2>find-file-noselect</span> <span style=color:#268bd2>file</span>)
</span></span><span style=display:flex><span>        (<span style=color:#268bd2>message</span> <span style=color:#2aa198>&#34;    Processing file: %s&#34;</span> <span style=color:#268bd2>file</span>)
</span></span><span style=display:flex><span>        (<span style=color:#b58900>condition-case</span> <span style=color:#268bd2>var</span>
</span></span><span style=display:flex><span>            (<span style=color:#268bd2>org-hugo-export-wim-to-md</span> <span style=color:#cb4b16>t</span>)
</span></span><span style=display:flex><span>          (<span style=color:#cb4b16>error</span> (<span style=color:#268bd2>message</span> <span style=color:#2aa198>&#34;ERROR: %s&#34;</span> <span style=color:#268bd2>var</span>)))
</span></span><span style=display:flex><span>        (<span style=color:#268bd2>message</span> <span style=color:#2aa198>&#34;    .... done&#34;</span>))
</span></span><span style=display:flex><span>    (<span style=color:#268bd2>message</span> <span style=color:#2aa198>&#34;    Skipping file: %s&#34;</span> <span style=color:#268bd2>file</span>)))
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>(<span style=color:#b58900>defun</span> <span style=color:#268bd2>batch-export-all-org-files-to-md</span> (<span style=color:#268bd2>dir</span>)
</span></span><span style=display:flex><span>  <span style=color:#2aa198>&#34;Export all org files in directory DIR to markdown.
</span></span></span><span style=display:flex><span><span style=color:#2aa198>
</span></span></span><span style=display:flex><span><span style=color:#2aa198>To perform a full export of all org files in the directory DIR to
</span></span></span><span style=display:flex><span><span style=color:#2aa198>markdown format, use this command. It should be called when a
</span></span></span><span style=display:flex><span><span style=color:#2aa198>full export is required, typically for the first time..&#34;</span>
</span></span><span style=display:flex><span>  (<span style=color:#268bd2>message</span> <span style=color:#2aa198>&#34;DIR: %s&#34;</span> <span style=color:#268bd2>dir</span>)
</span></span><span style=display:flex><span>  (<span style=color:#268bd2>mapc</span> <span style=color:#268bd2>#&#39;</span><span style=color:#268bd2>tnote/export-org-file-to-md</span> (<span style=color:#268bd2>directory-files-recursively</span> <span style=color:#268bd2>dir</span> <span style=color:#2aa198>&#34;\\`[^.#].*\\.org\\&#39;&#34;</span>)))
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>(<span style=color:#b58900>defun</span> <span style=color:#268bd2>batch-export-HEAD-files-to-md</span> ()
</span></span><span style=display:flex><span>  <span style=color:#2aa198>&#34;Export the files in the HEAD branch to markdown format.
</span></span></span><span style=display:flex><span><span style=color:#2aa198>
</span></span></span><span style=display:flex><span><span style=color:#2aa198>This command should be called in an incremental manner to
</span></span></span><span style=display:flex><span><span style=color:#2aa198>effectively export updated files..&#34;</span>
</span></span><span style=display:flex><span>  (<span style=color:#b58900>dolist</span> (<span style=color:#268bd2>it</span> (<span style=color:#268bd2>cdr</span> (<span style=color:#268bd2>string-lines</span> (<span style=color:#268bd2>shell-command-to-string</span> <span style=color:#2aa198>&#34;git show --oneline --name-only HEAD&#34;</span>))))
</span></span><span style=display:flex><span>    (<span style=color:#268bd2>tnote/export-org-file-to-md</span> (<span style=color:#268bd2>expand-file-name</span> <span style=color:#268bd2>it</span> <span style=color:#2aa198>&#34;..&#34;</span>))))
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#586e75>;;; export</span>
</span></span><span style=display:flex><span>(<span style=color:#b58900>setq</span> <span style=color:#268bd2>org-hugo-base-dir</span> (<span style=color:#268bd2>concat</span> <span style=color:#268bd2>default-directory</span> <span style=color:#2aa198>&#34;../hugo&#34;</span>))
</span></span><span style=display:flex><span>(<span style=color:#b58900>setq</span> <span style=color:#268bd2>org-file-dir</span> (<span style=color:#268bd2>concat</span> <span style=color:#268bd2>default-directory</span> <span style=color:#2aa198>&#34;../org/&#34;</span>))
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>(<span style=color:#268bd2>batch-export-all-org-files-to-md</span> <span style=color:#268bd2>org-file-dir</span>)
</span></span></code></pre></div></div><footer class=post-footer><ul class=post-tags><li><a href=https://yangyingchao.github.io/tags/hugo/>hugo</a></li><li><a href=https://yangyingchao.github.io/tags/blog/>blog</a></li></ul></footer><script src=https://giscus.app/client.js data-repo=yangyingchao/giscus data-repo-id=R_kgDON6NYZA data-category=Announcements data-category-id=DIC_kwDON6NYZM4CnANs data-mapping=pathname data-strict=0 data-reactions-enabled=1 data-emit-metadata=0 data-input-position=bottom data-theme=preferred_color_scheme data-lang=zh-CN crossorigin=anonymous async></script></article></main><footer class=footer><span>&copy; 2025 <a href=https://yangyingchao.github.io>MyNotes</a></span> ·
<span>Powered by
<a href=https://gohugo.io/ rel="noopener noreferrer" target=_blank>Hugo</a> &
        <a href=https://github.com/adityatelange/hugo-PaperMod/ rel=noopener target=_blank>PaperMod</a></span></footer><a href=#top aria-label="go to top" title="Go to Top (Alt + G)" class=top-link id=top-link accesskey=g><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 12 6" fill="currentcolor"><path d="M12 6H0l6-6z"/></svg></a><script>let menu=document.getElementById("menu");menu&&(menu.scrollLeft=localStorage.getItem("menu-scroll-position"),menu.onscroll=function(){localStorage.setItem("menu-scroll-position",menu.scrollLeft)}),document.querySelectorAll('a[href^="#"]').forEach(e=>{e.addEventListener("click",function(e){e.preventDefault();var t=this.getAttribute("href").substr(1);window.matchMedia("(prefers-reduced-motion: reduce)").matches?document.querySelector(`[id='${decodeURIComponent(t)}']`).scrollIntoView():document.querySelector(`[id='${decodeURIComponent(t)}']`).scrollIntoView({behavior:"smooth"}),t==="top"?history.replaceState(null,null," "):history.pushState(null,null,`#${t}`)})})</script><script>var mybutton=document.getElementById("top-link");window.onscroll=function(){document.body.scrollTop>800||document.documentElement.scrollTop>800?(mybutton.style.visibility="visible",mybutton.style.opacity="1"):(mybutton.style.visibility="hidden",mybutton.style.opacity="0")}</script><script>document.getElementById("theme-toggle").addEventListener("click",()=>{document.body.className.includes("dark")?(document.body.classList.remove("dark"),localStorage.setItem("pref-theme","light")):(document.body.classList.add("dark"),localStorage.setItem("pref-theme","dark"))})</script><script>document.querySelectorAll("pre > code").forEach(e=>{const n=e.parentNode.parentNode,t=document.createElement("button");t.classList.add("copy-code"),t.innerHTML="copy";function s(){t.innerHTML="copied!",setTimeout(()=>{t.innerHTML="copy"},2e3)}t.addEventListener("click",t=>{if("clipboard"in navigator){navigator.clipboard.writeText(e.textContent),s();return}const n=document.createRange();n.selectNodeContents(e);const o=window.getSelection();o.removeAllRanges(),o.addRange(n);try{document.execCommand("copy"),s()}catch{}o.removeRange(n)}),n.classList.contains("highlight")?n.appendChild(t):n.parentNode.firstChild==n||(e.parentNode.parentNode.parentNode.parentNode.parentNode.nodeName=="TABLE"?e.parentNode.parentNode.parentNode.parentNode.parentNode.appendChild(t):e.parentNode.appendChild(t))})</script></body></html>