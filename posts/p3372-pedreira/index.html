<!doctype html><html lang=zh-cn dir=auto><head><meta charset=utf-8><meta http-equiv=x-ua-compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no"><meta name=robots content="index, follow"><title>Velox: Meta’s Unified Execution Engine | MyNotes</title><meta name=keywords content="vectorization,engine"><meta name=description content="1 ABSTRACT 2 INTRODUCTION 3 LIBRARY OVERVIEW 4 USE CASES 5 DEEP DIVE 5.1 TODO Type System 5.2 Vectors 5.3 Expression Eval 5.4 Functions 5.5 Operators 5.6 Memory Management 1 ABSTRACT Velox: C++ database acceleration library 用来： 构建执行引擎 应对复杂数据类型 增强数据管理系统 (enhance data management system) 倚赖： 向量"><meta name=author content><link rel=canonical href=https://yangyingchao.github.io/posts/p3372-pedreira/><link crossorigin=anonymous href=/assets/css/stylesheet.6a98292fb8fa8cf0f3ba4042d4b75515c04267550f3ad49ff6271b5af9562443.css integrity="sha256-apgpL7j6jPDzukBC1LdVFcBCZ1UPOtSf9icbWvlWJEM=" rel="preload stylesheet" as=style><script defer crossorigin=anonymous src=/assets/js/highlight.f413e19d0714851f6474e7ee9632408e58ac146fbdbe62747134bea2fa3415e0.js integrity="sha256-9BPhnQcUhR9kdOfuljJAjlisFG+9vmJ0cTS+ovo0FeA=" onload=hljs.initHighlightingOnLoad()></script>
<link rel=icon href=https://yangyingchao.github.io/favicon.ico><link rel=icon type=image/png sizes=16x16 href=https://yangyingchao.github.io/favicon-16x16.png><link rel=icon type=image/png sizes=32x32 href=https://yangyingchao.github.io/favicon-32x32.png><link rel=apple-touch-icon href=https://yangyingchao.github.io/apple-touch-icon.png><link rel=mask-icon href=https://yangyingchao.github.io/safari-pinned-tab.svg><meta name=theme-color content="#2e2e33"><meta name=msapplication-TileColor content="#2e2e33"><noscript><style>#theme-toggle,.top-link{display:none}</style><style>@media(prefers-color-scheme:dark){:root{--theme:rgb(29, 30, 32);--entry:rgb(46, 46, 51);--primary:rgb(218, 218, 219);--secondary:rgb(155, 156, 157);--tertiary:rgb(65, 66, 68);--content:rgb(196, 196, 197);--hljs-bg:rgb(46, 46, 51);--code-bg:rgb(55, 56, 62);--border:rgb(51, 51, 51)}.list{background:var(--theme)}.list:not(.dark)::-webkit-scrollbar-track{background:0 0}.list:not(.dark)::-webkit-scrollbar-thumb{border-color:var(--theme)}}</style></noscript><meta property="og:title" content="Velox: Meta’s Unified Execution Engine"><meta property="og:description" content="1 ABSTRACT 2 INTRODUCTION 3 LIBRARY OVERVIEW 4 USE CASES 5 DEEP DIVE 5.1 TODO Type System 5.2 Vectors 5.3 Expression Eval 5.4 Functions 5.5 Operators 5.6 Memory Management 1 ABSTRACT Velox: C++ database acceleration library 用来： 构建执行引擎 应对复杂数据类型 增强数据管理系统 (enhance data management system) 倚赖： 向量"><meta property="og:type" content="article"><meta property="og:url" content="https://yangyingchao.github.io/posts/p3372-pedreira/"><meta property="article:section" content="posts"><meta name=twitter:card content="summary"><meta name=twitter:title content="Velox: Meta’s Unified Execution Engine"><meta name=twitter:description content="1 ABSTRACT 2 INTRODUCTION 3 LIBRARY OVERVIEW 4 USE CASES 5 DEEP DIVE 5.1 TODO Type System 5.2 Vectors 5.3 Expression Eval 5.4 Functions 5.5 Operators 5.6 Memory Management 1 ABSTRACT Velox: C++ database acceleration library 用来： 构建执行引擎 应对复杂数据类型 增强数据管理系统 (enhance data management system) 倚赖： 向量"><script type=application/ld+json>{"@context":"https://schema.org","@type":"BreadcrumbList","itemListElement":[{"@type":"ListItem","position":2,"name":"Posts","item":"https://yangyingchao.github.io/posts/"},{"@type":"ListItem","position":3,"name":"Velox: Meta’s Unified Execution Engine","item":"https://yangyingchao.github.io/posts/p3372-pedreira/"}]}</script><script type=application/ld+json>{"@context":"https://schema.org","@type":"BlogPosting","headline":"Velox: Meta’s Unified Execution Engine","name":"Velox: Meta’s Unified Execution Engine","description":"1 ABSTRACT 2 INTRODUCTION 3 LIBRARY OVERVIEW 4 USE CASES 5 DEEP DIVE 5.1 TODO Type System 5.2 Vectors 5.3 Expression Eval 5.4 Functions 5.5 Operators 5.6 Memory Management 1 ABSTRACT Velox: C++ database acceleration library 用来： 构建执行引擎 应对复杂数据类型 增强数据管理系统 (enhance data management system) 倚赖： 向量","keywords":["vectorization","engine"],"articleBody":" 1 ABSTRACT 2 INTRODUCTION 3 LIBRARY OVERVIEW 4 USE CASES 5 DEEP DIVE 5.1 TODO Type System 5.2 Vectors 5.3 Expression Eval 5.4 Functions 5.5 Operators 5.6 Memory Management 1 ABSTRACT Velox:\nC++ database acceleration library\n用来：\n构建执行引擎 应对复杂数据类型 增强数据管理系统 (enhance data management system) 倚赖：\n向量化 (vectorization) 自适应 (adaptivity) Meta 内部已经或正在将其与其他组件集成，包括：\n分析型查询引擎 Presto Spark 流处理平台 消息总线 数据仓库 机器学习 PyTorch 2 INTRODUCTION 仅做计算，无 SQL 解析、优化器等，其价值：\n效率 一致性 工程效率 3 LIBRARY OVERVIEW 是什么\n开源 C++ 数据库加速库 可用来加速、扩展和增强数据的计算引擎： 高性能计算 可重用 可扩展 不是什么\n无语法前端 SQL 解析 全局优化等 也就意味着：\nVelox 的输入是 已经优化好的执行计划 将执行计划在本地执行 Velox 的组件 4 USE CASES 5 DEEP DIVE TODO 5.1 Type System TypeSystem 用于表示各种数据类型：\n原生类型\n整形 不同精度的浮点数类型 字符串 varchar varbinary 日期 时间戳 函数 （lambda 表达式） 复杂类型\n数组 固定长度的数组 maps rows, structs 上述类型可以嵌套，并序列化、反序列化\n还可以包装 C++ 的结构体 支持类型扩展：\nFind How???? 5.2 Vectors Vectors 用来表示列式数据 列式、编码后的数据 用作组件之间的输入和输出 扩展自 Apache Arrow 格式，扩展包括 size （行数） type null bitmap 可嵌套 Velox Buffers\n从内存池中分配出的连续空间 Vector 保存在 Velox buffers 中 引用计数\nBuffer 和 Vector 都有引用计数 一个 buffer 可以被多个 Vector 引用 只有引用计数为 1 的数据是可变的 shared vector 和 buffer 可通用 copy-on-write 技术变成可写 5.2.1 Arrow Comparison 5.3 Expression Eval 表达式计算引擎，可用作\n过滤投影算子 – 用于过滤和投影表达式 TableScan 和 IO connectors: 过滤条件下推 用作单独的计算组件：计算表达式 使用 Expression Tree 用作输入\n树的每个节点可能是 input column 常量 函数调用，由函数名和一系列的参数（表达式）构成 CAST 表达式：用于类型转换？ lambda 函数 函数计算分成两个部分： 编译和执行\n5.3.1 Compilation 将输入的表达式树转换成为可执行的表达式，若干运行时优化技术：\nCommon Subexpression Elimination Constant Folding Adaptive Conjunct Reordering 5.3.2 Evaluation. 5.4 Functions 5.4.1 Scalar Functions. 5.4.2 Aggregate Functions 5.5 Operators 5.5.1 Table Scans, Filter, and Project 5.5.2 Aggregate and Hash Joins. 5.6 Memory Management 5.6.1 Caching ","wordCount":"697","inLanguage":"zh-cn","datePublished":"0001-01-01T00:00:00Z","dateModified":"0001-01-01T00:00:00Z","mainEntityOfPage":{"@type":"WebPage","@id":"https://yangyingchao.github.io/posts/p3372-pedreira/"},"publisher":{"@type":"Organization","name":"MyNotes","logo":{"@type":"ImageObject","url":"https://yangyingchao.github.io/favicon.ico"}}}</script></head><body id=top><script>localStorage.getItem("pref-theme")==="dark"?document.body.classList.add("dark"):localStorage.getItem("pref-theme")==="light"?document.body.classList.remove("dark"):window.matchMedia("(prefers-color-scheme: dark)").matches&&document.body.classList.add("dark")</script><header class=header><nav class=nav><div class=logo><a href=https://yangyingchao.github.io accesskey=h title="MyNotes (Alt + H)">MyNotes</a><div class=logo-switches><button id=theme-toggle accesskey=t title="(Alt + T)"><svg id="moon" xmlns="http://www.w3.org/2000/svg" width="24" height="18" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 12.79A9 9 0 1111.21 3 7 7 0 0021 12.79z"/></svg><svg id="sun" xmlns="http://www.w3.org/2000/svg" width="24" height="18" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="5"/><line x1="12" y1="1" x2="12" y2="3"/><line x1="12" y1="21" x2="12" y2="23"/><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"/><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"/><line x1="1" y1="12" x2="3" y2="12"/><line x1="21" y1="12" x2="23" y2="12"/><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"/><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"/></svg></button></div></div><ul id=menu><li><a href=https://yangyingchao.github.io/ title=Home><span>Home</span></a></li><li><a href=https://yangyingchao.github.io/posts/ title=Archives><span>Archives</span></a></li><li><a href=https://yangyingchao.github.io/tags/ title=Tags><span>Tags</span></a></li><li><a href=https://yangyingchao.github.io/categories/ title=Categories><span>Categories</span></a></li></ul></nav></header><main class=main><article class=post-single><header class=post-header><h1 class=post-title>Velox: Meta’s Unified Execution Engine</h1><div class=post-meta></div></header><div class=post-content><ul><li>1 <a href=#h:2feba2b4-8c5e-43d1-a350-894f13c55f6d>ABSTRACT</a></li><li>2 <a href=#h:894af9fe-ef1a-4830-bb2d-66fa3658ed9a>INTRODUCTION</a></li><li>3 <a href=#h:45c2ace0-0c5d-4839-bd76-e8fc71c4a50e>LIBRARY OVERVIEW</a></li><li>4 <a href=#h:02b95a98-47dd-4cc4-b09d-5e4961eb13ef>USE CASES</a></li><li>5 <a href=#h:28e04c87-3ab7-49ae-8dd2-2c9f60d16e72>DEEP DIVE</a><ul><li>5.1 <a href=#h:721c90b1-0101-4889-af09-0d80b80be023>TODO Type System</a></li><li>5.2 <a href=#h:c3f011fb-9660-4857-a677-9ccd96a0a439>Vectors</a></li><li>5.3 <a href=#h:a55899bf-019b-484b-9fa0-6ad73151ac95>Expression Eval</a></li><li>5.4 <a href=#h:b4d3982d-525d-467a-88c2-a4ac41eabd2b>Functions</a></li><li>5.5 <a href=#h:424ea8dc-5e15-4660-be04-855440d1184e>Operators</a></li><li>5.6 <a href=#h:ea91d67f-7e9d-4ff3-8c27-62cc34336120>Memory Management</a></li></ul></li></ul><h2 id=h:2feba2b4-8c5e-43d1-a350-894f13c55f6d>1 ABSTRACT<a hidden class=anchor aria-hidden=true href=#h:2feba2b4-8c5e-43d1-a350-894f13c55f6d>#</a></h2><p>Velox:</p><ul><li><p>C++ database acceleration library</p></li><li><p>用来：</p><ul><li>构建执行引擎<ul><li>应对复杂数据类型</li></ul></li><li>增强数据管理系统 (enhance data management system)</li></ul></li><li><p>倚赖：</p><ul><li>向量化 (vectorization)</li><li>自适应 (adaptivity)</li></ul></li><li><p>Meta 内部已经或正在将其与其他组件集成，包括：</p><ul><li>分析型查询引擎<ul><li>Presto</li><li>Spark</li></ul></li><li>流处理平台</li><li>消息总线</li><li>数据仓库</li><li>机器学习<ul><li>PyTorch</li></ul></li></ul></li></ul><h2 id=h:894af9fe-ef1a-4830-bb2d-66fa3658ed9a>2 INTRODUCTION<a hidden class=anchor aria-hidden=true href=#h:894af9fe-ef1a-4830-bb2d-66fa3658ed9a>#</a></h2><p>仅做计算，无 SQL 解析、优化器等，其价值：</p><ul><li>效率</li><li>一致性</li><li>工程效率</li></ul><h2 id=h:45c2ace0-0c5d-4839-bd76-e8fc71c4a50e>3 LIBRARY OVERVIEW<a hidden class=anchor aria-hidden=true href=#h:45c2ace0-0c5d-4839-bd76-e8fc71c4a50e>#</a></h2><ul><li><p>是什么</p><ul><li>开源 C++ 数据库加速库</li><li>可用来加速、扩展和增强数据的计算引擎：<ul><li>高性能计算</li><li>可重用</li><li>可扩展</li></ul></li></ul></li><li><p>不是什么</p><ul><li>无语法前端<ul><li>SQL 解析</li><li>全局优化等</li></ul></li></ul></li><li><p>也就意味着：</p><ul><li>Velox 的输入是 <strong>已经优化好的执行计划</strong></li><li>将执行计划在本地执行</li></ul></li></ul><ul><li>Velox 的组件</li></ul><p></p><figure><img loading=lazy src=images/velox:-meta%e2%80%99s-unified-execution-engine/screenshot@2022-10-11_09:31:24.png></figure><h2 id=h:02b95a98-47dd-4cc4-b09d-5e4961eb13ef>4 USE CASES<a hidden class=anchor aria-hidden=true href=#h:02b95a98-47dd-4cc4-b09d-5e4961eb13ef>#</a></h2><h2 id=h:28e04c87-3ab7-49ae-8dd2-2c9f60d16e72>5 DEEP DIVE<a hidden class=anchor aria-hidden=true href=#h:28e04c87-3ab7-49ae-8dd2-2c9f60d16e72>#</a></h2><h3 id=h:721c90b1-0101-4889-af09-0d80b80be023>TODO 5.1 Type System<a hidden class=anchor aria-hidden=true href=#h:721c90b1-0101-4889-af09-0d80b80be023>#</a></h3><ul><li><p>TypeSystem 用于表示各种数据类型：</p><ul><li><p>原生类型</p><ul><li>整形</li><li>不同精度的浮点数类型</li><li>字符串<ul><li>varchar</li><li>varbinary</li></ul></li><li>日期</li><li>时间戳</li><li>函数 （lambda 表达式）</li></ul></li><li><p>复杂类型</p><ul><li>数组</li><li>固定长度的数组</li><li>maps</li><li>rows, structs</li></ul></li></ul></li><li><p>上述类型可以嵌套，并序列化、反序列化</p><ul><li>还可以包装 C++ 的结构体</li></ul></li><li><p>支持类型扩展：</p><ul><li>Find How????</li></ul></li></ul><h3 id=h:c3f011fb-9660-4857-a677-9ccd96a0a439>5.2 Vectors<a hidden class=anchor aria-hidden=true href=#h:c3f011fb-9660-4857-a677-9ccd96a0a439>#</a></h3><ul><li>Vectors 用来表示列式数据<ul><li>列式、编码后的数据</li><li>用作组件之间的输入和输出</li><li>扩展自 Apache Arrow 格式，扩展包括<ul><li>size （行数）</li><li>type</li><li>null bitmap</li></ul></li><li>可嵌套</li></ul></li></ul><ul><li><p>Velox Buffers</p><ul><li>从内存池中分配出的连续空间</li><li>Vector 保存在 Velox buffers 中</li></ul></li><li><p>引用计数</p><ul><li>Buffer 和 Vector 都有引用计数</li><li>一个 buffer 可以被多个 Vector 引用</li><li>只有引用计数为 1 的数据是可变的<ul><li>shared vector 和 buffer 可通用 copy-on-write 技术变成可写</li></ul></li></ul></li></ul><h4 id=h:af0bc56f-4859-4da5-a2c1-f287f476d439>5.2.1 Arrow Comparison<a hidden class=anchor aria-hidden=true href=#h:af0bc56f-4859-4da5-a2c1-f287f476d439>#</a></h4><h3 id=h:a55899bf-019b-484b-9fa0-6ad73151ac95>5.3 Expression Eval<a hidden class=anchor aria-hidden=true href=#h:a55899bf-019b-484b-9fa0-6ad73151ac95>#</a></h3><ul><li><p>表达式计算引擎，可用作</p><ul><li>过滤投影算子 – 用于过滤和投影表达式</li><li>TableScan 和 IO connectors: 过滤条件下推</li><li>用作单独的计算组件：计算表达式</li></ul></li><li><p>使用 Expression Tree 用作输入</p><ul><li>树的每个节点可能是<ul><li>input column</li><li>常量</li><li>函数调用，由函数名和一系列的参数（表达式）构成</li><li>CAST 表达式：用于类型转换？</li><li>lambda 函数</li></ul></li></ul></li><li><p>函数计算分成两个部分： 编译和执行</p></li></ul><h4 id=h:25b08418-5bdd-455b-8561-bb95feab581a>5.3.1 Compilation<a hidden class=anchor aria-hidden=true href=#h:25b08418-5bdd-455b-8561-bb95feab581a>#</a></h4><p>将输入的表达式树转换成为可执行的表达式，若干运行时优化技术：</p><ul><li>Common Subexpression Elimination</li><li>Constant Folding</li><li>Adaptive Conjunct Reordering</li></ul><h4 id=h:6bb78bba-3183-4e38-b9f9-1124608d46ca>5.3.2 Evaluation.<a hidden class=anchor aria-hidden=true href=#h:6bb78bba-3183-4e38-b9f9-1124608d46ca>#</a></h4><h3 id=h:b4d3982d-525d-467a-88c2-a4ac41eabd2b>5.4 Functions<a hidden class=anchor aria-hidden=true href=#h:b4d3982d-525d-467a-88c2-a4ac41eabd2b>#</a></h3><h4 id=h:fd105474-377e-4196-8a19-1ab3e367e7af>5.4.1 Scalar Functions.<a hidden class=anchor aria-hidden=true href=#h:fd105474-377e-4196-8a19-1ab3e367e7af>#</a></h4><h4 id=h:06e0f855-5595-4139-af01-90ad7d4791f4>5.4.2 Aggregate Functions<a hidden class=anchor aria-hidden=true href=#h:06e0f855-5595-4139-af01-90ad7d4791f4>#</a></h4><h3 id=h:424ea8dc-5e15-4660-be04-855440d1184e>5.5 Operators<a hidden class=anchor aria-hidden=true href=#h:424ea8dc-5e15-4660-be04-855440d1184e>#</a></h3><h4 id=h:7d269783-7fd0-4801-8d8c-e3a5b3fe2feb>5.5.1 Table Scans, Filter, and Project<a hidden class=anchor aria-hidden=true href=#h:7d269783-7fd0-4801-8d8c-e3a5b3fe2feb>#</a></h4><h4 id=h:246de1ad-ba83-49f2-ba36-143633b69b64>5.5.2 Aggregate and Hash Joins.<a hidden class=anchor aria-hidden=true href=#h:246de1ad-ba83-49f2-ba36-143633b69b64>#</a></h4><h3 id=h:ea91d67f-7e9d-4ff3-8c27-62cc34336120>5.6 Memory Management<a hidden class=anchor aria-hidden=true href=#h:ea91d67f-7e9d-4ff3-8c27-62cc34336120>#</a></h3><h4 id=h:292ea0f6-123b-4663-99e5-786dbbafbc4b>5.6.1 Caching<a hidden class=anchor aria-hidden=true href=#h:292ea0f6-123b-4663-99e5-786dbbafbc4b>#</a></h4></div><footer class=post-footer><ul class=post-tags><li><a href=https://yangyingchao.github.io/tags/vectorization/>vectorization</a></li><li><a href=https://yangyingchao.github.io/tags/engine/>engine</a></li></ul></footer></article></main><footer class=footer><span>&copy; 2023 <a href=https://yangyingchao.github.io>MyNotes</a></span>
<span>Powered by
<a href=https://gohugo.io/ rel="noopener noreferrer" target=_blank>Hugo</a> &
        <a href=https://github.com/adityatelange/hugo-PaperMod/ rel=noopener target=_blank>PaperMod</a></span></footer><a href=#top aria-label="go to top" title="Go to Top (Alt + G)" class=top-link id=top-link accesskey=g><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 12 6" fill="currentcolor"><path d="M12 6H0l6-6z"/></svg></a><script>let menu=document.getElementById("menu");menu&&(menu.scrollLeft=localStorage.getItem("menu-scroll-position"),menu.onscroll=function(){localStorage.setItem("menu-scroll-position",menu.scrollLeft)}),document.querySelectorAll('a[href^="#"]').forEach(e=>{e.addEventListener("click",function(e){e.preventDefault();var t=this.getAttribute("href").substr(1);window.matchMedia("(prefers-reduced-motion: reduce)").matches?document.querySelector(`[id='${decodeURIComponent(t)}']`).scrollIntoView():document.querySelector(`[id='${decodeURIComponent(t)}']`).scrollIntoView({behavior:"smooth"}),t==="top"?history.replaceState(null,null," "):history.pushState(null,null,`#${t}`)})})</script><script>var mybutton=document.getElementById("top-link");window.onscroll=function(){document.body.scrollTop>800||document.documentElement.scrollTop>800?(mybutton.style.visibility="visible",mybutton.style.opacity="1"):(mybutton.style.visibility="hidden",mybutton.style.opacity="0")}</script><script>document.getElementById("theme-toggle").addEventListener("click",()=>{document.body.className.includes("dark")?(document.body.classList.remove("dark"),localStorage.setItem("pref-theme","light")):(document.body.classList.add("dark"),localStorage.setItem("pref-theme","dark"))})</script></body></html>