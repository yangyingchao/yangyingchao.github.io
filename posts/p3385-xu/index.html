<!doctype html><html lang=zh-cn dir=auto><head><meta charset=utf-8><meta http-equiv=x-ua-compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no"><meta name=robots content="index, follow"><title>OceanBase 707M tpmC | MyNotes</title><meta name=keywords content="database,oceanbase,tpmc"><meta name=description content="1 Introduction 2 DESIGN OVERVIEW 2.1 Goals 2.2 Criteria of Design 3 架构图 3.1 Application Layer 3.2 Proxy Layer 3.3 Data Service Layer 3.4 Zones 3.5 表 3.6 Node 3.7 SQL Engine 3.8 Multi-tenancy 3.9 Resource Isolation. 3.10 Features 4 STORAGE ENGINE 4.1 LSM Tree-Based Architecture 4.2 Asymmetric Read and Write 4.3 Daily Incremental Major Compaction 4.4 Replica Type 5 TRANSACTION PROCESSING ENGINE 5.1 Partition and Paxos Group"><meta name=author content><link rel=canonical href=https://yangyingchao.github.io/posts/p3385-xu/><link crossorigin=anonymous href=/assets/css/stylesheet.6a98292fb8fa8cf0f3ba4042d4b75515c04267550f3ad49ff6271b5af9562443.css integrity="sha256-apgpL7j6jPDzukBC1LdVFcBCZ1UPOtSf9icbWvlWJEM=" rel="preload stylesheet" as=style><script defer crossorigin=anonymous src=/assets/js/highlight.f413e19d0714851f6474e7ee9632408e58ac146fbdbe62747134bea2fa3415e0.js integrity="sha256-9BPhnQcUhR9kdOfuljJAjlisFG+9vmJ0cTS+ovo0FeA=" onload=hljs.initHighlightingOnLoad()></script>
<link rel=icon href=https://yangyingchao.github.io/favicon.ico><link rel=icon type=image/png sizes=16x16 href=https://yangyingchao.github.io/favicon-16x16.png><link rel=icon type=image/png sizes=32x32 href=https://yangyingchao.github.io/favicon-32x32.png><link rel=apple-touch-icon href=https://yangyingchao.github.io/apple-touch-icon.png><link rel=mask-icon href=https://yangyingchao.github.io/safari-pinned-tab.svg><meta name=theme-color content="#2e2e33"><meta name=msapplication-TileColor content="#2e2e33"><noscript><style>#theme-toggle,.top-link{display:none}</style><style>@media(prefers-color-scheme:dark){:root{--theme:rgb(29, 30, 32);--entry:rgb(46, 46, 51);--primary:rgb(218, 218, 219);--secondary:rgb(155, 156, 157);--tertiary:rgb(65, 66, 68);--content:rgb(196, 196, 197);--hljs-bg:rgb(46, 46, 51);--code-bg:rgb(55, 56, 62);--border:rgb(51, 51, 51)}.list{background:var(--theme)}.list:not(.dark)::-webkit-scrollbar-track{background:0 0}.list:not(.dark)::-webkit-scrollbar-thumb{border-color:var(--theme)}}</style></noscript><meta property="og:title" content="OceanBase 707M tpmC"><meta property="og:description" content="1 Introduction 2 DESIGN OVERVIEW 2.1 Goals 2.2 Criteria of Design 3 架构图 3.1 Application Layer 3.2 Proxy Layer 3.3 Data Service Layer 3.4 Zones 3.5 表 3.6 Node 3.7 SQL Engine 3.8 Multi-tenancy 3.9 Resource Isolation. 3.10 Features 4 STORAGE ENGINE 4.1 LSM Tree-Based Architecture 4.2 Asymmetric Read and Write 4.3 Daily Incremental Major Compaction 4.4 Replica Type 5 TRANSACTION PROCESSING ENGINE 5.1 Partition and Paxos Group"><meta property="og:type" content="article"><meta property="og:url" content="https://yangyingchao.github.io/posts/p3385-xu/"><meta property="article:section" content="posts"><meta name=twitter:card content="summary"><meta name=twitter:title content="OceanBase 707M tpmC"><meta name=twitter:description content="1 Introduction 2 DESIGN OVERVIEW 2.1 Goals 2.2 Criteria of Design 3 架构图 3.1 Application Layer 3.2 Proxy Layer 3.3 Data Service Layer 3.4 Zones 3.5 表 3.6 Node 3.7 SQL Engine 3.8 Multi-tenancy 3.9 Resource Isolation. 3.10 Features 4 STORAGE ENGINE 4.1 LSM Tree-Based Architecture 4.2 Asymmetric Read and Write 4.3 Daily Incremental Major Compaction 4.4 Replica Type 5 TRANSACTION PROCESSING ENGINE 5.1 Partition and Paxos Group"><script type=application/ld+json>{"@context":"https://schema.org","@type":"BreadcrumbList","itemListElement":[{"@type":"ListItem","position":2,"name":"Posts","item":"https://yangyingchao.github.io/posts/"},{"@type":"ListItem","position":3,"name":"OceanBase 707M tpmC","item":"https://yangyingchao.github.io/posts/p3385-xu/"}]}</script><script type=application/ld+json>{"@context":"https://schema.org","@type":"BlogPosting","headline":"OceanBase 707M tpmC","name":"OceanBase 707M tpmC","description":"1 Introduction 2 DESIGN OVERVIEW 2.1 Goals 2.2 Criteria of Design 3 架构图 3.1 Application Layer 3.2 Proxy Layer 3.3 Data Service Layer 3.4 Zones 3.5 表 3.6 Node 3.7 SQL Engine 3.8 Multi-tenancy 3.9 Resource Isolation. 3.10 Features 4 STORAGE ENGINE 4.1 LSM Tree-Based Architecture 4.2 Asymmetric Read and Write 4.3 Daily Incremental Major Compaction 4.4 Replica Type 5 TRANSACTION PROCESSING ENGINE 5.1 Partition and Paxos Group","keywords":["database","oceanbase","tpmc"],"articleBody":" 1 Introduction 2 DESIGN OVERVIEW 2.1 Goals 2.2 Criteria of Design 3 架构图 3.1 Application Layer 3.2 Proxy Layer 3.3 Data Service Layer 3.4 Zones 3.5 表 3.6 Node 3.7 SQL Engine 3.8 Multi-tenancy 3.9 Resource Isolation. 3.10 Features 4 STORAGE ENGINE 4.1 LSM Tree-Based Architecture 4.2 Asymmetric Read and Write 4.3 Daily Incremental Major Compaction 4.4 Replica Type 5 TRANSACTION PROCESSING ENGINE 5.1 Partition and Paxos Group 5.2 Timestamp Service 5.3 Transaction Processing 5.4 Isolation Level 5.5 Replicated Table 6 TPC-C BENCHMARK TEST 7 LESSONS IN BUILDING OCEANBASE 7.1 From NoSQL to NewSQL 7.2 Both cost and performance 7.3 Data validation 7.4 Partitioning vs. sharding 本文为摘录，原文为： attachments/pdf/d/p3385-xu.pdf\n1 Introduction 2 DESIGN OVERVIEW 2.1 Goals Fast scale-out (scale-in) on commodity hardware to achieve high performance and low TCO. Cross-region deployment and fault tolerance. 2.2 Criteria of Design 3 架构图 Figure 1: OceanBase 架构图\n3.1 Application Layer 3.2 Proxy Layer 3.3 Data Service Layer 3.4 Zones Zones can be restricted to one region or spead over multiple regions. 事务通过 Paxos 在多个区域中复制 Transactions are replicated among the zones, using Paxos. 3.5 表 由用户显式地进行分区，并作为数据分布和负载均衡的基本单元 每个分片在每个 zone 中都有一个副本 3.6 Node 每个 Node (OBServer) 与传统的 RDMS 相似。 从 SQL 生成执行计划 如果是 local plan ， 直接执行 否则， 通过两阶段提交协议来执行， 此时该节点作为 coordinator 当 Paxos 组中多数节点的 redo log 持久化后，才提交事务 3.7 SQL Engine 3.7.1 plan cache 收到请求后，仅进行简单的词法分析，然后在 plan cache 中匹配缓存的计划，找不到时候再去走完整的解析流程。 10x 提升。。。 3.8 Multi-tenancy 3.8.1 System Tenant 系统租户 系统内置，主要功能：\n作为系统表的容器 – 系统表都存储在系统租户的空间内 。。。 。。。 3.8.2 Ordinary Tenant 普通髭胡 3.9 Resource Isolation. 3.10 Features 4 STORAGE ENGINE 基于 LSM-tree, 支持非对称数据块读写，日常增量 compaction, 和不同的副本类型。\nFigure 3: OB 的存储引擎\n4.1 LSM Tree-Based Architecture 数据分成两部分：\n静态基准数据 (static baseline data): 存储于 SSTable 中 动态增量数据 (dynamic incremental data) ： 存储于 MemTable 中 SSTable \u0026 MemTable\nSSTable 为只读数据，生成之后就不再发生更改 MemTable 支持读写操作，只存在内存中 DML 操作 MemTable MemTable 打到一定大小以后， dump 到磁盘，生成 SSTable 查询针对两种存储分别进行，然后进行合并后返回给客户端 针对 SSTable 实现了 Block 缓存和行缓存，以减少对基线数据的随机访问 Compaction\nMinor Compaction 内存中数据达到一定大小后，开始进行 minor compaction Minor Compaction 将 MemTable 转换成为 SSTable Major Compaction\n由系统每天进行增量的 Major Compaction Major Compaction 将 SSTable 和当天发生的变化进行合并，形成新版本的基线 该设计导致每次查询需要读取基准数据和增量数据， OB 做了很多优化\n缓存 （block 级与行级） BloomFilter: 用于进行 empty checks 4.2 Asymmetric Read and Write OB 实现了非对称读写。\n读： 基本单元为 microblock 4K 或者 8K 写： 基本单元为 macroblock 2MB macroblock 同时也是存储系统的分配和垃圾回收的基础单元 多个 microblock 组装成一个 macroblock 磁盘使用更高效 但造成了一定程度上的写放大 4.3 Daily Incremental Major Compaction 数据且分成 2MB 大小的 macroblock, Major Compaction 中： 数据有修改，则重写该 block 数据无修改，则在新的 baseline 中直接重用，无 IO 开销 因此 Compaction 开销比 LevelDB RockDB 更小 4.4 Replica Type 有多种类型的副本：\nfull replica 完全副本，包含\n基线数据 增量数据 redo log Data replica, 数据副本\n包括基准数据和 relod log 根据需要从完全副本拷贝 minor compactions （compacted mutabtions） 重做完日志后，可以升级至完全副本 与完全副本相比，节省 CPU 和内存资源： 不必重做日志 没有 MemTable Log Replica 日志副本\n仅包含 redo log 作为 Paxos 组的成员 部署两个完全副本和一个日志副本，则： 拥有高可用特性\n存储和内存开销大大减少\n5 TRANSACTION PROCESSING ENGINE 5.1 Partition and Paxos Group Partition 分片是数据分布、负载均衡和 Paxos 同步的基础单元 每个分片一个 Paxos Group 5.2 Timestamp Service 使用 timestamp Paxos group 来实现时间戳服务的高可用 timestamp paxos group 的 leader 与表分片的 paxos group leader 通常放在一个区域（region）中 5.3 Transaction Processing 5.4 Isolation Level read committed: default isolation level 也支持 snapshot isolation 5.5 Replicated Table synchronously replicated table\n变更需要等所有节点完成 慢 asynchronously replicated table\n等待 paxos group 中的多数完成即可 快，但不保证所有节点的数据都为最新 如果查询中某节点遇到了老版本的数据，需要访问远端副本 6 TPC-C BENCHMARK TEST 7 LESSONS IN BUILDING OCEANBASE 7.1 From NoSQL to NewSQL 应用层不应将数据库尊为一个 key-value 存储系统来用，也不应该倚赖某些数据的高级特性 存储过程对某些 OLTP 应用来说仍有很大的价值 对于使用分布式数据库的应用来说，每个事务、每个 SQL 都应该有超时机制：分布式系统的出错率更高一些（网络，节点等原因） 7.2 Both cost and performance 7.3 Data validation 7.4 Partitioning vs. sharding ","wordCount":"1397","inLanguage":"zh-cn","datePublished":"0001-01-01T00:00:00Z","dateModified":"0001-01-01T00:00:00Z","mainEntityOfPage":{"@type":"WebPage","@id":"https://yangyingchao.github.io/posts/p3385-xu/"},"publisher":{"@type":"Organization","name":"MyNotes","logo":{"@type":"ImageObject","url":"https://yangyingchao.github.io/favicon.ico"}}}</script></head><body id=top><script>localStorage.getItem("pref-theme")==="dark"?document.body.classList.add("dark"):localStorage.getItem("pref-theme")==="light"?document.body.classList.remove("dark"):window.matchMedia("(prefers-color-scheme: dark)").matches&&document.body.classList.add("dark")</script><header class=header><nav class=nav><div class=logo><a href=https://yangyingchao.github.io accesskey=h title="MyNotes (Alt + H)">MyNotes</a><div class=logo-switches><button id=theme-toggle accesskey=t title="(Alt + T)"><svg id="moon" xmlns="http://www.w3.org/2000/svg" width="24" height="18" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 12.79A9 9 0 1111.21 3 7 7 0 0021 12.79z"/></svg><svg id="sun" xmlns="http://www.w3.org/2000/svg" width="24" height="18" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="5"/><line x1="12" y1="1" x2="12" y2="3"/><line x1="12" y1="21" x2="12" y2="23"/><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"/><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"/><line x1="1" y1="12" x2="3" y2="12"/><line x1="21" y1="12" x2="23" y2="12"/><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"/><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"/></svg></button></div></div><ul id=menu><li><a href=https://yangyingchao.github.io/ title=Home><span>Home</span></a></li><li><a href=https://yangyingchao.github.io/posts/ title=Archives><span>Archives</span></a></li><li><a href=https://yangyingchao.github.io/tags/ title=Tags><span>Tags</span></a></li><li><a href=https://yangyingchao.github.io/categories/ title=Categories><span>Categories</span></a></li><li><a href=https://yangyingchao.github.io/contact/ title="Contact me"><span>Contact me</span></a></li></ul></nav></header><main class=main><article class=post-single><header class=post-header><h1 class=post-title>OceanBase 707M tpmC</h1><div class=post-meta></div></header><div class=post-content><ul><li>1 <a href=#h:0a45267f-a3ae-43ad-8a8a-2a8ff4d14e35>Introduction</a></li><li>2 <a href=#h:81c079a8-b5c8-4073-b6dc-4390e495b9ac>DESIGN OVERVIEW</a><ul><li>2.1 <a href=#h:89cbb686-47c9-439f-94af-5baf3dbdec55>Goals</a></li><li>2.2 <a href=#h:d8875fcd-41a7-4eb3-bcdb-7f4698884d41>Criteria of Design</a></li></ul></li><li>3 <a href=#h:1d973c3d-dfa5-4501-806a-a3691d5f5ddb>架构图</a><ul><li>3.1 <a href=#h:8c3fca18-cdec-4d5c-a080-0d9f7ce5d187>Application Layer</a></li><li>3.2 <a href=#h:02cd8c19-34d7-4bbd-8ec9-c5e1df9a54b2>Proxy Layer</a></li><li>3.3 <a href=#h:dda54135-ae89-427a-88cd-a83212f504d5>Data Service Layer</a></li><li>3.4 <a href=#h:e6097928-8983-4e4e-a6e7-789f28d6ba2c>Zones</a></li><li>3.5 <a href=#h:e7b840bd-069f-43ac-9f26-efd8b9d23815>表</a></li><li>3.6 <a href=#h:b613b575-2ec7-4ac9-af01-6abc2ac33597>Node</a></li><li>3.7 <a href=#h:93134f71-c553-4bdf-85d9-b635dc2e6cfa>SQL Engine</a></li><li>3.8 <a href=#h:3ff4162e-c44a-44bf-a591-06272e393a61>Multi-tenancy</a></li><li>3.9 <a href=#h:795aebda-ad5d-423b-bbd8-18e201a3ea05>Resource Isolation.</a></li><li>3.10 <a href=#h:d1d0b2ec-39d3-4860-a5e2-1fc17e06cb0a>Features</a></li></ul></li><li>4 <a href=#h:b529b550-1b76-4517-b51e-c2ef317a50e8>STORAGE ENGINE</a><ul><li>4.1 <a href=#h:2d0129de-6b8c-4123-bcae-3381d34e2426>LSM Tree-Based Architecture</a></li><li>4.2 <a href=#h:3b88b7f0-2a81-46b3-a504-81ead89714dc>Asymmetric Read and Write</a></li><li>4.3 <a href=#h:fd24213c-c8e8-47e2-b267-b650ade48456>Daily Incremental Major Compaction</a></li><li>4.4 <a href=#h:38ef652e-1cac-4458-ab8d-c5a450387a17>Replica Type</a></li></ul></li><li>5 <a href=#h:daef193b-c166-40bc-897c-1ba68e6d2e7e>TRANSACTION PROCESSING ENGINE</a><ul><li>5.1 <a href=#h:9ddf467b-d11e-4b8e-9056-ff15b67602fe>Partition and Paxos Group</a></li><li>5.2 <a href=#h:af98d321-1caf-4efe-811a-12302ffb7321>Timestamp Service</a></li><li>5.3 <a href=#h:3fa0c121-d1e6-41d0-94b0-aba40baa6340>Transaction Processing</a></li><li>5.4 <a href=#h:48068368-5e2c-46d7-8973-fcd6ed207b2e>Isolation Level</a></li><li>5.5 <a href=#h:9c090d3d-1284-4a59-8748-5f4f41d92fd4>Replicated Table</a></li></ul></li><li>6 <a href=#h:b9272e56-7a6c-4576-bb2e-07d908598d53>TPC-C BENCHMARK TEST</a></li><li>7 <a href=#h:dd8ffbcb-ac77-4683-ae5b-4bdb8f828c61>LESSONS IN BUILDING OCEANBASE</a><ul><li>7.1 <a href=#h:bba12c9f-9272-42f1-ba0f-121f5f6a19fa>From NoSQL to NewSQL</a></li><li>7.2 <a href=#h:a901f7ee-f75f-41b7-aa25-cafb87bf5a98>Both cost and performance</a></li><li>7.3 <a href=#h:c0fcd1a9-665b-43af-b2be-8b02b1349136>Data validation</a></li><li>7.4 <a href=#h:823cf2bc-3ef4-4e03-b67d-154e672b80ec>Partitioning vs. sharding</a></li></ul></li></ul><p>本文为摘录，原文为： attachments/pdf/d/p3385-xu.pdf</p><h2 id=h:0a45267f-a3ae-43ad-8a8a-2a8ff4d14e35>1 Introduction<a hidden class=anchor aria-hidden=true href=#h:0a45267f-a3ae-43ad-8a8a-2a8ff4d14e35>#</a></h2><h2 id=h:81c079a8-b5c8-4073-b6dc-4390e495b9ac>2 DESIGN OVERVIEW<a hidden class=anchor aria-hidden=true href=#h:81c079a8-b5c8-4073-b6dc-4390e495b9ac>#</a></h2><h3 id=h:89cbb686-47c9-439f-94af-5baf3dbdec55>2.1 Goals<a hidden class=anchor aria-hidden=true href=#h:89cbb686-47c9-439f-94af-5baf3dbdec55>#</a></h3><ul><li>Fast scale-out (scale-in) on commodity hardware to achieve high performance and low TCO.</li><li>Cross-region deployment and fault tolerance.</li></ul><h3 id=h:d8875fcd-41a7-4eb3-bcdb-7f4698884d41>2.2 Criteria of Design<a hidden class=anchor aria-hidden=true href=#h:d8875fcd-41a7-4eb3-bcdb-7f4698884d41>#</a></h3><h2 id=h:1d973c3d-dfa5-4501-806a-a3691d5f5ddb>3 架构图<a hidden class=anchor aria-hidden=true href=#h:1d973c3d-dfa5-4501-806a-a3691d5f5ddb>#</a></h2><p></p><figure><img loading=lazy src=/ox-hugo/-003-002.jpg alt="Figure 1: OceanBase 架构图" width=800px><figcaption><p>Figure 1: OceanBase 架构图</p></figcaption></figure><h3 id=h:8c3fca18-cdec-4d5c-a080-0d9f7ce5d187>3.1 Application Layer<a hidden class=anchor aria-hidden=true href=#h:8c3fca18-cdec-4d5c-a080-0d9f7ce5d187>#</a></h3><h3 id=h:02cd8c19-34d7-4bbd-8ec9-c5e1df9a54b2>3.2 Proxy Layer<a hidden class=anchor aria-hidden=true href=#h:02cd8c19-34d7-4bbd-8ec9-c5e1df9a54b2>#</a></h3><h3 id=h:dda54135-ae89-427a-88cd-a83212f504d5>3.3 Data Service Layer<a hidden class=anchor aria-hidden=true href=#h:dda54135-ae89-427a-88cd-a83212f504d5>#</a></h3><h3 id=h:e6097928-8983-4e4e-a6e7-789f28d6ba2c>3.4 Zones<a hidden class=anchor aria-hidden=true href=#h:e6097928-8983-4e4e-a6e7-789f28d6ba2c>#</a></h3><ul><li>Zones can be restricted to one <strong>region</strong> or spead over multiple regions.</li><li>事务通过 Paxos 在多个区域中复制
Transactions are replicated among the zones, using Paxos.</li></ul><h3 id=h:e7b840bd-069f-43ac-9f26-efd8b9d23815>3.5 表<a hidden class=anchor aria-hidden=true href=#h:e7b840bd-069f-43ac-9f26-efd8b9d23815>#</a></h3><ul><li>由用户显式地进行分区，并作为数据分布和负载均衡的基本单元</li><li>每个分片在每个 zone 中都有一个副本</li></ul><h3 id=h:b613b575-2ec7-4ac9-af01-6abc2ac33597>3.6 Node<a hidden class=anchor aria-hidden=true href=#h:b613b575-2ec7-4ac9-af01-6abc2ac33597>#</a></h3><ul><li>每个 Node (OBServer) 与传统的 RDMS 相似。</li><li>从 SQL 生成执行计划<ul><li>如果是 local plan ， 直接执行</li><li>否则， 通过两阶段提交协议来执行，<ul><li>此时该节点作为 coordinator</li><li>当 Paxos 组中多数节点的 redo log 持久化后，才提交事务</li></ul></li></ul></li></ul><h3 id=h:93134f71-c553-4bdf-85d9-b635dc2e6cfa>3.7 SQL Engine<a hidden class=anchor aria-hidden=true href=#h:93134f71-c553-4bdf-85d9-b635dc2e6cfa>#</a></h3><p></p><figure><img loading=lazy src=/ox-hugo/screenshot@2022-09-09_18:10:13.png width=800px></figure><h4 id=h:ce19ec14-eb33-426a-a124-6aa866434e99>3.7.1 plan cache<a hidden class=anchor aria-hidden=true href=#h:ce19ec14-eb33-426a-a124-6aa866434e99>#</a></h4><ul><li>收到请求后，仅进行简单的词法分析，然后在 plan cache 中匹配缓存的计划，找不到时候再去走完整的解析流程。</li><li>10x 提升。。。</li></ul><h3 id=h:3ff4162e-c44a-44bf-a591-06272e393a61>3.8 Multi-tenancy<a hidden class=anchor aria-hidden=true href=#h:3ff4162e-c44a-44bf-a591-06272e393a61>#</a></h3><h4 id=h:1fa5cbc3-0369-4445-8702-0e6321751d4b>3.8.1 System Tenant 系统租户<a hidden class=anchor aria-hidden=true href=#h:1fa5cbc3-0369-4445-8702-0e6321751d4b>#</a></h4><p>系统内置，主要功能：</p><ul><li>作为系统表的容器 – 系统表都存储在系统租户的空间内</li><li>。。。</li><li>。。。</li></ul><h4 id=h:21a3b204-d403-41d9-a8f4-5760a4505658>3.8.2 Ordinary Tenant 普通髭胡<a hidden class=anchor aria-hidden=true href=#h:21a3b204-d403-41d9-a8f4-5760a4505658>#</a></h4><h3 id=h:795aebda-ad5d-423b-bbd8-18e201a3ea05>3.9 Resource Isolation.<a hidden class=anchor aria-hidden=true href=#h:795aebda-ad5d-423b-bbd8-18e201a3ea05>#</a></h3><h3 id=h:d1d0b2ec-39d3-4860-a5e2-1fc17e06cb0a>3.10 Features<a hidden class=anchor aria-hidden=true href=#h:d1d0b2ec-39d3-4860-a5e2-1fc17e06cb0a>#</a></h3><h2 id=h:b529b550-1b76-4517-b51e-c2ef317a50e8>4 STORAGE ENGINE<a hidden class=anchor aria-hidden=true href=#h:b529b550-1b76-4517-b51e-c2ef317a50e8>#</a></h2><p>基于 LSM-tree, 支持非对称数据块读写，日常增量 compaction, 和不同的副本类型。</p><p></p><figure><img loading=lazy src=/ox-hugo/-004-003.png alt="Figure 3: OB 的存储引擎" width=800px><figcaption><p>Figure 3: OB 的存储引擎</p></figcaption></figure><h3 id=h:2d0129de-6b8c-4123-bcae-3381d34e2426>4.1 LSM Tree-Based Architecture<a hidden class=anchor aria-hidden=true href=#h:2d0129de-6b8c-4123-bcae-3381d34e2426>#</a></h3><ul><li><p>数据分成两部分：</p><ul><li>静态基准数据 (static baseline data): 存储于 SSTable 中</li><li>动态增量数据 (dynamic incremental data) ： 存储于 MemTable 中</li></ul></li><li><p>SSTable & MemTable</p><ul><li>SSTable 为只读数据，生成之后就不再发生更改</li><li>MemTable 支持读写操作，只存在内存中</li><li>DML 操作 MemTable</li><li>MemTable 打到一定大小以后， dump 到磁盘，生成 SSTable</li><li>查询针对两种存储分别进行，然后进行合并后返回给客户端</li><li>针对 SSTable 实现了 Block 缓存和行缓存，以减少对基线数据的随机访问</li></ul></li><li><p>Compaction</p><ul><li><p>Minor Compaction</p><ul><li>内存中数据达到一定大小后，开始进行 minor compaction</li><li>Minor Compaction 将 MemTable 转换成为 SSTable</li></ul></li><li><p>Major Compaction</p><ul><li>由系统每天进行增量的 Major Compaction</li><li>Major Compaction 将 SSTable 和当天发生的变化进行合并，形成新版本的基线</li></ul></li></ul></li><li><p>该设计导致每次查询需要读取基准数据和增量数据， OB 做了很多优化</p><ul><li>缓存 （block 级与行级）</li><li>BloomFilter: 用于进行 empty checks</li></ul></li></ul><h3 id=h:3b88b7f0-2a81-46b3-a504-81ead89714dc>4.2 Asymmetric Read and Write<a hidden class=anchor aria-hidden=true href=#h:3b88b7f0-2a81-46b3-a504-81ead89714dc>#</a></h3><p>OB 实现了非对称读写。</p><ul><li>读：<ul><li>基本单元为 microblock</li><li>4K 或者 8K</li></ul></li><li>写：<ul><li>基本单元为 macroblock</li><li>2MB</li><li>macroblock 同时也是存储系统的分配和垃圾回收的基础单元</li></ul></li><li>多个 microblock 组装成一个 macroblock<ul><li>磁盘使用更高效</li><li>但造成了一定程度上的写放大</li></ul></li></ul><h3 id=h:fd24213c-c8e8-47e2-b267-b650ade48456>4.3 Daily Incremental Major Compaction<a hidden class=anchor aria-hidden=true href=#h:fd24213c-c8e8-47e2-b267-b650ade48456>#</a></h3><ul><li>数据且分成 2MB 大小的 macroblock, Major Compaction 中：<ul><li>数据有修改，则重写该 block</li><li>数据无修改，则在新的 baseline 中直接重用，无 IO 开销</li><li>因此 Compaction 开销比 LevelDB RockDB 更小</li></ul></li></ul><h3 id=h:38ef652e-1cac-4458-ab8d-c5a450387a17>4.4 Replica Type<a hidden class=anchor aria-hidden=true href=#h:38ef652e-1cac-4458-ab8d-c5a450387a17>#</a></h3><p>有多种类型的副本：</p><ul><li><p>full replica 完全副本，包含</p><ul><li>基线数据</li><li>增量数据</li><li>redo log</li></ul></li><li><p>Data replica, 数据副本</p><ul><li>包括基准数据和 relod log</li><li>根据需要从完全副本拷贝 minor compactions （compacted mutabtions）</li><li>重做完日志后，可以升级至完全副本</li><li>与完全副本相比，节省 CPU 和内存资源：<ul><li>不必重做日志</li><li>没有 MemTable</li></ul></li></ul></li><li><p>Log Replica 日志副本</p><ul><li>仅包含 redo log</li><li>作为 Paxos 组的成员</li><li>部署两个完全副本和一个日志副本，则：<ul><li><p>拥有高可用特性</p></li><li><p>存储和内存开销大大减少</p><p></p><figure><img loading=lazy src=/ox-hugo/screenshot@2022-09-13_10:17:00.png></figure></li></ul></li></ul></li></ul><h2 id=h:daef193b-c166-40bc-897c-1ba68e6d2e7e>5 TRANSACTION PROCESSING ENGINE<a hidden class=anchor aria-hidden=true href=#h:daef193b-c166-40bc-897c-1ba68e6d2e7e>#</a></h2><h3 id=h:9ddf467b-d11e-4b8e-9056-ff15b67602fe>5.1 Partition and Paxos Group<a hidden class=anchor aria-hidden=true href=#h:9ddf467b-d11e-4b8e-9056-ff15b67602fe>#</a></h3><ul><li>Partition 分片是数据分布、负载均衡和 Paxos 同步的基础单元</li><li>每个分片一个 Paxos Group</li></ul><h3 id=h:af98d321-1caf-4efe-811a-12302ffb7321>5.2 Timestamp Service<a hidden class=anchor aria-hidden=true href=#h:af98d321-1caf-4efe-811a-12302ffb7321>#</a></h3><ul><li>使用 timestamp Paxos group 来实现时间戳服务的高可用</li><li>timestamp paxos group 的 leader 与表分片的 paxos group leader 通常放在一个区域（region）中</li></ul><h3 id=h:3fa0c121-d1e6-41d0-94b0-aba40baa6340>5.3 Transaction Processing<a hidden class=anchor aria-hidden=true href=#h:3fa0c121-d1e6-41d0-94b0-aba40baa6340>#</a></h3><h3 id=h:48068368-5e2c-46d7-8973-fcd6ed207b2e>5.4 Isolation Level<a hidden class=anchor aria-hidden=true href=#h:48068368-5e2c-46d7-8973-fcd6ed207b2e>#</a></h3><ul><li>read committed: default isolation level</li><li>也支持 snapshot isolation</li></ul><h3 id=h:9c090d3d-1284-4a59-8748-5f4f41d92fd4>5.5 Replicated Table<a hidden class=anchor aria-hidden=true href=#h:9c090d3d-1284-4a59-8748-5f4f41d92fd4>#</a></h3><ul><li><p>synchronously replicated table</p><ul><li>变更需要等所有节点完成</li><li>慢</li></ul></li><li><p>asynchronously replicated table</p><ul><li>等待 paxos group 中的多数完成即可</li><li>快，但不保证所有节点的数据都为最新</li><li>如果查询中某节点遇到了老版本的数据，需要访问远端副本</li></ul></li></ul><h2 id=h:b9272e56-7a6c-4576-bb2e-07d908598d53>6 TPC-C BENCHMARK TEST<a hidden class=anchor aria-hidden=true href=#h:b9272e56-7a6c-4576-bb2e-07d908598d53>#</a></h2><h2 id=h:dd8ffbcb-ac77-4683-ae5b-4bdb8f828c61>7 LESSONS IN BUILDING OCEANBASE<a hidden class=anchor aria-hidden=true href=#h:dd8ffbcb-ac77-4683-ae5b-4bdb8f828c61>#</a></h2><h3 id=h:bba12c9f-9272-42f1-ba0f-121f5f6a19fa>7.1 From NoSQL to NewSQL<a hidden class=anchor aria-hidden=true href=#h:bba12c9f-9272-42f1-ba0f-121f5f6a19fa>#</a></h3><ul><li>应用层不应将数据库尊为一个 key-value 存储系统来用，也不应该倚赖某些数据的高级特性</li><li>存储过程对某些 OLTP 应用来说仍有很大的价值</li><li>对于使用分布式数据库的应用来说，每个事务、每个 SQL 都应该有超时机制：分布式系统的出错率更高一些（网络，节点等原因）</li></ul><h3 id=h:a901f7ee-f75f-41b7-aa25-cafb87bf5a98>7.2 Both cost and performance<a hidden class=anchor aria-hidden=true href=#h:a901f7ee-f75f-41b7-aa25-cafb87bf5a98>#</a></h3><h3 id=h:c0fcd1a9-665b-43af-b2be-8b02b1349136>7.3 Data validation<a hidden class=anchor aria-hidden=true href=#h:c0fcd1a9-665b-43af-b2be-8b02b1349136>#</a></h3><h3 id=h:823cf2bc-3ef4-4e03-b67d-154e672b80ec>7.4 Partitioning vs. sharding<a hidden class=anchor aria-hidden=true href=#h:823cf2bc-3ef4-4e03-b67d-154e672b80ec>#</a></h3></div><footer class=post-footer><ul class=post-tags><li><a href=https://yangyingchao.github.io/tags/database/>database</a></li><li><a href=https://yangyingchao.github.io/tags/oceanbase/>oceanbase</a></li><li><a href=https://yangyingchao.github.io/tags/tpmc/>tpmc</a></li></ul></footer></article></main><footer class=footer><span>&copy; 2025 <a href=https://yangyingchao.github.io>MyNotes</a></span>
<span>Powered by
<a href=https://gohugo.io/ rel="noopener noreferrer" target=_blank>Hugo</a> &
        <a href=https://github.com/adityatelange/hugo-PaperMod/ rel=noopener target=_blank>PaperMod</a></span></footer><a href=#top aria-label="go to top" title="Go to Top (Alt + G)" class=top-link id=top-link accesskey=g><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 12 6" fill="currentcolor"><path d="M12 6H0l6-6z"/></svg></a><script>let menu=document.getElementById("menu");menu&&(menu.scrollLeft=localStorage.getItem("menu-scroll-position"),menu.onscroll=function(){localStorage.setItem("menu-scroll-position",menu.scrollLeft)}),document.querySelectorAll('a[href^="#"]').forEach(e=>{e.addEventListener("click",function(e){e.preventDefault();var t=this.getAttribute("href").substr(1);window.matchMedia("(prefers-reduced-motion: reduce)").matches?document.querySelector(`[id='${decodeURIComponent(t)}']`).scrollIntoView():document.querySelector(`[id='${decodeURIComponent(t)}']`).scrollIntoView({behavior:"smooth"}),t==="top"?history.replaceState(null,null," "):history.pushState(null,null,`#${t}`)})})</script><script>var mybutton=document.getElementById("top-link");window.onscroll=function(){document.body.scrollTop>800||document.documentElement.scrollTop>800?(mybutton.style.visibility="visible",mybutton.style.opacity="1"):(mybutton.style.visibility="hidden",mybutton.style.opacity="0")}</script><script>document.getElementById("theme-toggle").addEventListener("click",()=>{document.body.className.includes("dark")?(document.body.classList.remove("dark"),localStorage.setItem("pref-theme","light")):(document.body.classList.add("dark"),localStorage.setItem("pref-theme","dark"))})</script></body></html>