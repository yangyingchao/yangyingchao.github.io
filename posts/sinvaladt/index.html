<!doctype html><html lang=zh-cn dir=auto><head><meta charset=utf-8><meta http-equiv=x-ua-compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no"><meta name=robots content="index, follow"><title>shared cache invalidation | MyNotes</title><meta name=keywords content="pg,cache,inval,msg,postgres"><meta name=description content="1 prelog 2 Configurable parameters 3 SICleanupQueue 3.1 重置后的处理 3.2 信号的处理 本文为摘录，原文为： https://github.com/postgres/postgres/blob/master/src/backend/storage/ipc/sinval.c 1 prelog 共享缓存失效消息在一个无限数组中存储，maxMsgNum 是下一个数组下标来"><meta name=author content="Yang, Ying-chao"><link rel=canonical href=https://yangyingchao.github.io/posts/sinvaladt/><link crossorigin=anonymous href=/assets/css/stylesheet.6a98292fb8fa8cf0f3ba4042d4b75515c04267550f3ad49ff6271b5af9562443.css integrity="sha256-apgpL7j6jPDzukBC1LdVFcBCZ1UPOtSf9icbWvlWJEM=" rel="preload stylesheet" as=style><script defer crossorigin=anonymous src=/assets/js/highlight.f413e19d0714851f6474e7ee9632408e58ac146fbdbe62747134bea2fa3415e0.js integrity="sha256-9BPhnQcUhR9kdOfuljJAjlisFG+9vmJ0cTS+ovo0FeA=" onload=hljs.initHighlightingOnLoad()></script>
<link rel=icon href=https://yangyingchao.github.io/favicon.ico><link rel=icon type=image/png sizes=16x16 href=https://yangyingchao.github.io/favicon-16x16.png><link rel=icon type=image/png sizes=32x32 href=https://yangyingchao.github.io/favicon-32x32.png><link rel=apple-touch-icon href=https://yangyingchao.github.io/apple-touch-icon.png><link rel=mask-icon href=https://yangyingchao.github.io/safari-pinned-tab.svg><meta name=theme-color content="#2e2e33"><meta name=msapplication-TileColor content="#2e2e33"><noscript><style>#theme-toggle,.top-link{display:none}</style><style>@media(prefers-color-scheme:dark){:root{--theme:rgb(29, 30, 32);--entry:rgb(46, 46, 51);--primary:rgb(218, 218, 219);--secondary:rgb(155, 156, 157);--tertiary:rgb(65, 66, 68);--content:rgb(196, 196, 197);--hljs-bg:rgb(46, 46, 51);--code-bg:rgb(55, 56, 62);--border:rgb(51, 51, 51)}.list{background:var(--theme)}.list:not(.dark)::-webkit-scrollbar-track{background:0 0}.list:not(.dark)::-webkit-scrollbar-thumb{border-color:var(--theme)}}</style></noscript><meta property="og:title" content="shared cache invalidation"><meta property="og:description" content="1 prelog 2 Configurable parameters 3 SICleanupQueue 3.1 重置后的处理 3.2 信号的处理 本文为摘录，原文为： https://github.com/postgres/postgres/blob/master/src/backend/storage/ipc/sinval.c 1 prelog 共享缓存失效消息在一个无限数组中存储，maxMsgNum 是下一个数组下标来"><meta property="og:type" content="article"><meta property="og:url" content="https://yangyingchao.github.io/posts/sinvaladt/"><meta property="article:section" content="posts"><meta property="article:published_time" content="2024-04-25T00:00:00+00:00"><meta property="article:modified_time" content="2024-04-25T00:00:00+00:00"><meta name=twitter:card content="summary"><meta name=twitter:title content="shared cache invalidation"><meta name=twitter:description content="1 prelog 2 Configurable parameters 3 SICleanupQueue 3.1 重置后的处理 3.2 信号的处理 本文为摘录，原文为： https://github.com/postgres/postgres/blob/master/src/backend/storage/ipc/sinval.c 1 prelog 共享缓存失效消息在一个无限数组中存储，maxMsgNum 是下一个数组下标来"><script type=application/ld+json>{"@context":"https://schema.org","@type":"BreadcrumbList","itemListElement":[{"@type":"ListItem","position":2,"name":"Posts","item":"https://yangyingchao.github.io/posts/"},{"@type":"ListItem","position":3,"name":"shared cache invalidation","item":"https://yangyingchao.github.io/posts/sinvaladt/"}]}</script><script type=application/ld+json>{"@context":"https://schema.org","@type":"BlogPosting","headline":"shared cache invalidation","name":"shared cache invalidation","description":"1 prelog 2 Configurable parameters 3 SICleanupQueue 3.1 重置后的处理 3.2 信号的处理 本文为摘录，原文为： https://github.com/postgres/postgres/blob/master/src/backend/storage/ipc/sinval.c 1 prelog 共享缓存失效消息在一个无限数组中存储，maxMsgNum 是下一个数组下标来","keywords":["pg","cache","inval","msg","postgres"],"articleBody":" 1 prelog 2 Configurable parameters 3 SICleanupQueue 3.1 重置后的处理 3.2 信号的处理 本文为摘录，原文为： https://github.com/postgres/postgres/blob/master/src/backend/storage/ipc/sinval.c\n1 prelog 共享缓存失效消息在一个无限数组中存储，maxMsgNum 是下一个数组下标来存储提交的消息， minMsgNum 是最小的数组下标，包含尚未被所有后端读取的消息，始终满足 maxMsgNum \u003e= minMsgNum。 每个活跃后端都有一个 nextMsgNum 指针，指示下一个需要读取的消息；对每个后端都有 maxMsgNum \u003e= nextMsgNum \u003e= minMsgNum。\n消息实际上存储在一个 MAXNUMMESSAGES 条目的循环缓冲区中。我们将 MsgNum 值转换为循环缓冲 区索引，通过计算 MsgNum % MAXNUMMESSAGES。只要 maxMsgNum 不比 minMsgNum 多出超过 MAXNUMMESSAGES，缓冲区就足够大。如果缓冲区溢出，我们通过为每个已经太落后的后端设置 “reset” 标志来恢复。\n为降低需要重置的概率，我们向任何看起来严重滞后的后端发送“catchup” 中断。当一个后端完成处 理 catchup 中断后，它执行 SICleanupQueue，这将在需要时向滞后最远的后端发送信号。这避免了多 个后端同时尝试赶上导致的不必要争用。然而，最落后的后端可能被困在无法赶上的状态。最终，它 会被重置，因此不会再给其他任何人带来问题。\n对共享 sinval 数组访问受两个锁的保护，SInvalReadLock 和 SInvalWriteLock。读者以共享模 式获取 SInvalReadLock；这允许它们修改自己的 ProcState，但不能修改或查看其他读者的。写者总 是以独占模式获取 SInvalWriteLock，以串行化向列队添加消息。最多一个这样的中断正在飞行，当一个 后端完成处理 catchup 中断后，它执行 SICleanupQueue，如果需要，则将信号传递给下一个最落后的 后端。\n/* 共享失效结构状态， 存在于每个后端中 */ typedef struct ProcState { /* 如果 ProcState 数组条目处于非活动状态，procPid 为零。 */ pid_t\tprocPid;\t// 后端的 PID，用于信号传递 */ /* 如果 procPid == 0 或 resetState 为真，则 nextMsgNum 没有意义。 */ int\tnextMsgNum;\t/* 下一个要读取的消息号 */ bool\tresetState;\t/* 后端需要重置其状态 */ bool\tsignaled;\t// 后端已发送“追赶”信号 */ bool\thasMessages;\t// 后端有未读消息 */ /* */ * 后端只发送失效信息，不接收失效信息。只有在恢复期间的启动进程才有意义， * 因为它不维护 relcache，但会发送失效消息以让查询后端看到模式更改。 */ bool\tsendOnly;\t// 后端只发送，不接收 */ /* * 每个空闲后端槽使用的下一个LocalTransactionId。 我们将其保存在这里是因为它由ProcNumber索引， * 并且在设置MyProcNumber时将值从本地内存复制到其中非常方便。在活动ProcState条目中没有意义。 */ LocalTransactionId nextLXID; } ProcState; /* 共享缓存失效内存段, 存在于共享内存中 */ typedef struct SISeg { /* 通用状态信息 */ int minMsgNum; /* 最早仍然需要的消息 */ int maxMsgNum; // 下一个要分配的消息数字 */ int nextThreshold; /* 调用 SICleanupQueue 的消息数量 */ slock_t msgnumLock; // 保护 maxMsgNum 的自旋锁 */ /* 保存共享失效消息的循环缓冲区 */ SharedInvalidationMessage buffer[MAXNUMMESSAGES]; /* * 每个后端失效状态信息 * * 'procState' 有 NumProcStateSlots 个条目，并且由 pgprocno 进行索引。 * 'numProcs' 是当前使用的插槽数，'pgprocnos' 是它们索引的稠密数组，以加快扫描所有正在使用的插槽的速度。 * * 'pgprocnos' 在很大程度上与 ProcArrayStruct-\u003epgprocnos 重复，但有了我们单独的副本，避免了 * ProcArrayLock 上的争用，并允许我们仅跟踪参与共享缓存失效的进程。 */ int numProcs; int *pgprocnos; ProcState procState[FLEXIBLE_ARRAY_MEMBER]; } SISeg; 2 Configurable parameters MAXNUMMESSAGES 我们可以缓冲的共享失效消息的最大数量。为了提高速度，必须是 2 的幂次方。\nMSGNUMWRAPAROUND 多久将 MsgNum 变量减小一次以避免溢出。必须是 MAXNUMMESSAGES 的倍数。应该足够大。\nCLEANUP_MIN 在我们打扰调用 SICleanupQueue 之前必须在缓冲区中存在的消息的最小数目。\nCLEANUP_QUANTUM 一旦超过 CLEANUP_MIN ，调用 SICleanupQueue 的频率（以消息数计）。为了提高速度，应为 2 的幂次方。\nSIG_THRESHOLD 后端必须落后多少个消息才会发送 PROCSIG_CATCHUP_INTERRUPT 的最小消息数量。\nWRITE_QUANTUM 在 SIInsertDataEntries 的每次迭代中将推送到缓冲区的最大消息数。 非关键，但应该小于 CLEANUP_QUANTUM ，因为我们每次迭代只考虑调用 SICleanupQueue 一次。\n3 SICleanupQueue 删除已被所有活跃后端进程消费的消息\n如果调用者持有 SInvalWriteLock，则 callerHasWriteLock 为 true。 minFree 是要释放的最小消息槽数量。\n落后太多的会被重置 (stateP-\u003eresetState = true) 严重落后但不至于重置的，会被发送信号 PROCSIG_CATCHUP_INTERRUPT 一次最多对一个后端进行信号处理。 注意：由于我们在信号其他后端进程时瞬时释放写锁，退出时不保证仍有 minFree 个空闲消息槽。调用者必须重新检查并可能重试。\n3.1 重置后的处理 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 void AcceptInvalidationMessages(void) { ReceiveSharedInvalidMessages(LocalExecuteInvalidationMessage, InvalidateSystemCaches); // ... skipped ... } void ReceiveSharedInvalidMessages(void (*invalFunction) (SharedInvalidationMessage *msg), void (*resetFunction) (void)) { // ... skipped ... getResult = SIGetDataEntries(messages, MAXINVALMSGS); if (getResult \u003c 0) { /* got a reset message */ elog(DEBUG4, \"cache state reset\"); SharedInvalidMessageCounter++; resetFunction(); break;\t/* nothing more to do */ } // ... skipped ... } int SIGetDataEntries(SharedInvalidationMessage *data, int datasize) { // ... skipped ... if (stateP-\u003eresetState) { /* * Force reset. We can say we have dealt with any messages added * since the reset, as well; and that means we should clear the * signaled flag, too. */ stateP-\u003enextMsgNum = max; stateP-\u003eresetState = false; stateP-\u003esignaled = false; LWLockRelease(SInvalReadLock); return -1; } // ... skipped ... } ReceiveSharedInvalidMessages() 中调用 SIGetDataEntries() 来取得未处理的消息 SIGetDataEntries() 发现被重置后，返回 -1 ReceiveSharedInvalidMessages() 检查到返回值小于 0 ，则调用传入的回调函数 InvalidateSystemCaches() 来进行清理缓存 3.2 信号的处理 信号处理最终会调到函数 ProcessCatchupInterrupt() ：\n/* * ProcessCatchupInterrupt * * 处理追赶中断的部分，运行在信号处理程序之外，使其能够实际处理待处理的失效消息。 */ void ProcessCatchupInterrupt(void) { while (catchupInterruptPending) { /* * 在这里我们需要让 ReceiveSharedInvalidMessages() 函数运行，它将进行必要的处理并重置 * catchupInterruptPending 标志。如果我们正在事务中，可以直接调用 AcceptInvalidationMessages() * 来执行这个操作。如果不是，在这里启动并立即结束一个事务；AcceptInvalidationMessages() 的调用 * 发生在事务启动内部。 * * 很诱人地，我们可以尝试只调用 AcceptInvalidationMessages()，而不执行事务启动/停止的其他操作， * 我认为在正常情况下这样做是可行的；但是如果出现错误，我不确定处理会不会很顺利。 */ if (IsTransactionOrTransactionBlock()) { elog(DEBUG4, \"ProcessCatchupEvent inside transaction\"); AcceptInvalidationMessages(); } else { elog(DEBUG4, \"ProcessCatchupEvent outside transaction\"); StartTransactionCommand(); CommitTransactionCommand(); } } } AcceptInvalidationMessages() 见 2 。\n","wordCount":"2191","inLanguage":"zh-cn","datePublished":"2024-04-25T00:00:00Z","dateModified":"2024-04-25T00:00:00Z","author":[{"@type":"Person","name":"Yang"},{"@type":"Person","name":"Ying-chao"}],"mainEntityOfPage":{"@type":"WebPage","@id":"https://yangyingchao.github.io/posts/sinvaladt/"},"publisher":{"@type":"Organization","name":"MyNotes","logo":{"@type":"ImageObject","url":"https://yangyingchao.github.io/favicon.ico"}}}</script></head><body id=top><script>localStorage.getItem("pref-theme")==="dark"?document.body.classList.add("dark"):localStorage.getItem("pref-theme")==="light"?document.body.classList.remove("dark"):window.matchMedia("(prefers-color-scheme: dark)").matches&&document.body.classList.add("dark")</script><header class=header><nav class=nav><div class=logo><a href=https://yangyingchao.github.io accesskey=h title="MyNotes (Alt + H)">MyNotes</a><div class=logo-switches><button id=theme-toggle accesskey=t title="(Alt + T)"><svg id="moon" xmlns="http://www.w3.org/2000/svg" width="24" height="18" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 12.79A9 9 0 1111.21 3 7 7 0 0021 12.79z"/></svg><svg id="sun" xmlns="http://www.w3.org/2000/svg" width="24" height="18" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="5"/><line x1="12" y1="1" x2="12" y2="3"/><line x1="12" y1="21" x2="12" y2="23"/><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"/><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"/><line x1="1" y1="12" x2="3" y2="12"/><line x1="21" y1="12" x2="23" y2="12"/><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"/><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"/></svg></button></div></div><ul id=menu><li><a href=https://yangyingchao.github.io/ title=Home><span>Home</span></a></li><li><a href=https://yangyingchao.github.io/posts/ title=Archives><span>Archives</span></a></li><li><a href=https://yangyingchao.github.io/tags/ title=Tags><span>Tags</span></a></li><li><a href=https://yangyingchao.github.io/categories/ title=Categories><span>Categories</span></a></li><li><a href=https://yangyingchao.github.io/contact/ title="Contact me"><span>Contact me</span></a></li></ul></nav></header><main class=main><article class=post-single><header class=post-header><h1 class=post-title>shared cache invalidation</h1><div class=post-meta><span title='2024-04-25 00:00:00 +0000 UTC'>April 25, 2024</span>&nbsp;·&nbsp;Yang, Ying-chao</div></header><div class=post-content><ul><li>1 <a href=#prelog>prelog</a></li><li>2 <a href=#configurable-parameters>Configurable parameters</a></li><li>3 <a href=#sicleanupqueue>SICleanupQueue</a><ul><li>3.1 <a href=#%E9%87%8D%E7%BD%AE%E5%90%8E%E7%9A%84%E5%A4%84%E7%90%86>重置后的处理</a></li><li>3.2 <a href=#%E4%BF%A1%E5%8F%B7%E7%9A%84%E5%A4%84%E7%90%86>信号的处理</a></li></ul></li></ul><p>本文为摘录，原文为： <a href=https://github.com/postgres/postgres/blob/master/src/backend/storage/ipc/sinval.c>https://github.com/postgres/postgres/blob/master/src/backend/storage/ipc/sinval.c</a></p><h2 id=prelog>1 prelog<a hidden class=anchor aria-hidden=true href=#prelog>#</a></h2><p>共享缓存失效消息在一个无限数组中存储，maxMsgNum 是下一个数组下标来存储提交的消息，
minMsgNum 是最小的数组下标，包含尚未被所有后端读取的消息，始终满足 maxMsgNum >= minMsgNum。
每个活跃后端都有一个 nextMsgNum 指针，指示下一个需要读取的消息；对每个后端都有
maxMsgNum >= nextMsgNum >= minMsgNum。</p><p>消息实际上存储在一个 MAXNUMMESSAGES 条目的循环缓冲区中。我们将 MsgNum 值转换为循环缓冲
区索引，通过计算 MsgNum % MAXNUMMESSAGES。只要 maxMsgNum 不比 minMsgNum 多出超过
MAXNUMMESSAGES，缓冲区就足够大。如果缓冲区溢出，我们通过为每个已经太落后的后端设置
&ldquo;reset&rdquo; 标志来恢复。</p><p>为降低需要重置的概率，我们向任何看起来严重滞后的后端发送“catchup” 中断。当一个后端完成处
理 catchup 中断后，它执行 SICleanupQueue，这将在需要时向滞后最远的后端发送信号。这避免了多
个后端同时尝试赶上导致的不必要争用。然而，最落后的后端可能被困在无法赶上的状态。最终，它
会被重置，因此不会再给其他任何人带来问题。</p><p>对共享 sinval 数组访问受两个锁的保护，SInvalReadLock 和 SInvalWriteLock。读者以共享模
式获取 SInvalReadLock；这允许它们修改自己的 ProcState，但不能修改或查看其他读者的。写者总
是以独占模式获取 SInvalWriteLock，以串行化向列队添加消息。最多一个这样的中断正在飞行，当一个
后端完成处理 catchup 中断后，它执行 SICleanupQueue，如果需要，则将信号传递给下一个最落后的
后端。</p><div class=highlight><pre tabindex=0 style=-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-c data-lang=c><span style=display:flex><span>  <span style=color:#408080;font-style:italic>/* 共享失效结构状态， 存在于每个后端中 */</span>
</span></span><span style=display:flex><span>  <span style=color:green;font-weight:700>typedef</span> <span style=color:green;font-weight:700>struct</span> ProcState
</span></span><span style=display:flex><span>  {
</span></span><span style=display:flex><span>      <span style=color:#408080;font-style:italic>/* 如果 ProcState 数组条目处于非活动状态，procPid 为零。 */</span>
</span></span><span style=display:flex><span>      <span style=color:#b00040>pid_t</span>		procPid;		<span style=color:#408080;font-style:italic>// 后端的 PID，用于信号传递 */
</span></span></span><span style=display:flex><span><span style=color:#408080;font-style:italic></span>      <span style=color:#408080;font-style:italic>/* 如果 procPid == 0 或 resetState 为真，则 nextMsgNum 没有意义。 */</span>
</span></span><span style=display:flex><span>      <span style=color:#b00040>int</span>			nextMsgNum;		<span style=color:#408080;font-style:italic>/* 下一个要读取的消息号 */</span>
</span></span><span style=display:flex><span>      <span style=color:#b00040>bool</span>		resetState;		<span style=color:#408080;font-style:italic>/* 后端需要重置其状态 */</span>
</span></span><span style=display:flex><span>      <span style=color:#b00040>bool</span>		signaled;		<span style=color:#408080;font-style:italic>// 后端已发送“追赶”信号 */
</span></span></span><span style=display:flex><span><span style=color:#408080;font-style:italic></span>      <span style=color:#b00040>bool</span>		hasMessages;	<span style=color:#408080;font-style:italic>// 后端有未读消息 */
</span></span></span><span style=display:flex><span><span style=color:#408080;font-style:italic></span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>      <span style=color:#408080;font-style:italic>/*  */</span>
</span></span><span style=display:flex><span>       <span style=color:#666>*</span> <span>后端只发送失效信息，不接收失效信息。只有在恢复期间的启动进程才有意义，</span>
</span></span><span style=display:flex><span>       <span style=color:#666>*</span> <span>因为它不维护</span> relcache<span>，但会发送失效消息以让查询后端看到模式更改。</span>
</span></span><span style=display:flex><span>       <span>*/</span>
</span></span><span style=display:flex><span>      <span style=color:#b00040>bool</span>		sendOnly;		<span style=color:#408080;font-style:italic>// 后端只发送，不接收 */
</span></span></span><span style=display:flex><span><span style=color:#408080;font-style:italic></span>
</span></span><span style=display:flex><span>      <span style=color:#408080;font-style:italic>/*
</span></span></span><span style=display:flex><span><span style=color:#408080;font-style:italic>       * 每个空闲后端槽使用的下一个LocalTransactionId。 我们将其保存在这里是因为它由ProcNumber索引，
</span></span></span><span style=display:flex><span><span style=color:#408080;font-style:italic>       * 并且在设置MyProcNumber时将值从本地内存复制到其中非常方便。在活动ProcState条目中没有意义。
</span></span></span><span style=display:flex><span><span style=color:#408080;font-style:italic>       */</span>
</span></span><span style=display:flex><span>      LocalTransactionId nextLXID;
</span></span><span style=display:flex><span>  } ProcState;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#408080;font-style:italic>/* 共享缓存失效内存段, 存在于共享内存中 */</span>
</span></span><span style=display:flex><span><span style=color:green;font-weight:700>typedef</span> <span style=color:green;font-weight:700>struct</span> SISeg
</span></span><span style=display:flex><span>{
</span></span><span style=display:flex><span>    <span style=color:#408080;font-style:italic>/* 通用状态信息   */</span>
</span></span><span style=display:flex><span>    <span style=color:#b00040>int</span>         minMsgNum;        <span style=color:#408080;font-style:italic>/* 最早仍然需要的消息 */</span>
</span></span><span style=display:flex><span>    <span style=color:#b00040>int</span>         maxMsgNum;        <span style=color:#408080;font-style:italic>// 下一个要分配的消息数字 */
</span></span></span><span style=display:flex><span><span style=color:#408080;font-style:italic></span>    <span style=color:#b00040>int</span>         nextThreshold;    <span style=color:#408080;font-style:italic>/* 调用 SICleanupQueue 的消息数量 */</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#b00040>slock_t</span>     msgnumLock;       <span style=color:#408080;font-style:italic>// 保护 maxMsgNum 的自旋锁 */
</span></span></span><span style=display:flex><span><span style=color:#408080;font-style:italic></span>
</span></span><span style=display:flex><span>    <span style=color:#408080;font-style:italic>/* 保存共享失效消息的循环缓冲区    */</span>
</span></span><span style=display:flex><span>    SharedInvalidationMessage buffer[MAXNUMMESSAGES];
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#408080;font-style:italic>/*
</span></span></span><span style=display:flex><span><span style=color:#408080;font-style:italic>     * 每个后端失效状态信息
</span></span></span><span style=display:flex><span><span style=color:#408080;font-style:italic>     *
</span></span></span><span style=display:flex><span><span style=color:#408080;font-style:italic>     * &#39;procState&#39; 有 NumProcStateSlots 个条目，并且由 pgprocno 进行索引。
</span></span></span><span style=display:flex><span><span style=color:#408080;font-style:italic>     * &#39;numProcs&#39; 是当前使用的插槽数，&#39;pgprocnos&#39; 是它们索引的稠密数组，以加快扫描所有正在使用的插槽的速度。
</span></span></span><span style=display:flex><span><span style=color:#408080;font-style:italic>     *
</span></span></span><span style=display:flex><span><span style=color:#408080;font-style:italic>     * &#39;pgprocnos&#39; 在很大程度上与 ProcArrayStruct-&gt;pgprocnos 重复，但有了我们单独的副本，避免了
</span></span></span><span style=display:flex><span><span style=color:#408080;font-style:italic>     * ProcArrayLock 上的争用，并允许我们仅跟踪参与共享缓存失效的进程。
</span></span></span><span style=display:flex><span><span style=color:#408080;font-style:italic>     */</span>
</span></span><span style=display:flex><span>    <span style=color:#b00040>int</span>         numProcs;
</span></span><span style=display:flex><span>    <span style=color:#b00040>int</span>         <span style=color:#666>*</span>pgprocnos;
</span></span><span style=display:flex><span>    ProcState   procState[FLEXIBLE_ARRAY_MEMBER];
</span></span><span style=display:flex><span>} SISeg;
</span></span></code></pre></div><h2 id=configurable-parameters>2 Configurable parameters<a hidden class=anchor aria-hidden=true href=#configurable-parameters>#</a></h2><ul><li><p><code>MAXNUMMESSAGES</code>
我们可以缓冲的共享失效消息的最大数量。为了提高速度，必须是 2 的幂次方。</p></li><li><p><code>MSGNUMWRAPAROUND</code>
多久将 MsgNum 变量减小一次以避免溢出。必须是 MAXNUMMESSAGES 的倍数。应该足够大。</p></li><li><p><code>CLEANUP_MIN</code>
在我们打扰调用 SICleanupQueue 之前必须在缓冲区中存在的消息的最小数目。</p></li><li><p><code>CLEANUP_QUANTUM</code>
一旦超过 <code>CLEANUP_MIN</code> ，调用 SICleanupQueue 的频率（以消息数计）。为了提高速度，应为 2 的幂次方。</p></li><li><p><code>SIG_THRESHOLD</code>
后端必须落后多少个消息才会发送 <code>PROCSIG_CATCHUP_INTERRUPT</code> 的最小消息数量。</p></li><li><p><code>WRITE_QUANTUM</code>
在 SIInsertDataEntries 的每次迭代中将推送到缓冲区的最大消息数。
非关键，但应该小于 <code>CLEANUP_QUANTUM</code> ，因为我们每次迭代只考虑调用 SICleanupQueue 一次。</p></li></ul><h2 id=sicleanupqueue>3 SICleanupQueue<a hidden class=anchor aria-hidden=true href=#sicleanupqueue>#</a></h2><p>删除已被所有活跃后端进程消费的消息</p><p>如果调用者持有 SInvalWriteLock，则 callerHasWriteLock 为 true。
minFree 是要释放的最小消息槽数量。</p><ul><li>落后太多的会被重置 (<code>stateP->resetState = true</code>)</li><li>严重落后但不至于重置的，会被发送信号 <code>PROCSIG_CATCHUP_INTERRUPT</code>
一次最多对一个后端进行信号处理。</li></ul><p>注意：由于我们在信号其他后端进程时瞬时释放写锁，退出时不保证仍有 minFree 个空闲消息槽。调用者必须重新检查并可能重试。</p><h3 id=重置后的处理>3.1 重置后的处理<a hidden class=anchor aria-hidden=true href=#重置后的处理>#</a></h3><div class=highlight><div style=-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=org-coderef--cd71af-1><a style=outline:none;text-decoration:none;color:inherit href=#org-coderef--cd71af-1> 1</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=org-coderef--cd71af-2><a style=outline:none;text-decoration:none;color:inherit href=#org-coderef--cd71af-2> 2</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=org-coderef--cd71af-3><a style=outline:none;text-decoration:none;color:inherit href=#org-coderef--cd71af-3> 3</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=org-coderef--cd71af-4><a style=outline:none;text-decoration:none;color:inherit href=#org-coderef--cd71af-4> 4</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=org-coderef--cd71af-5><a style=outline:none;text-decoration:none;color:inherit href=#org-coderef--cd71af-5> 5</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=org-coderef--cd71af-6><a style=outline:none;text-decoration:none;color:inherit href=#org-coderef--cd71af-6> 6</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=org-coderef--cd71af-7><a style=outline:none;text-decoration:none;color:inherit href=#org-coderef--cd71af-7> 7</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=org-coderef--cd71af-8><a style=outline:none;text-decoration:none;color:inherit href=#org-coderef--cd71af-8> 8</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=org-coderef--cd71af-9><a style=outline:none;text-decoration:none;color:inherit href=#org-coderef--cd71af-9> 9</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=org-coderef--cd71af-10><a style=outline:none;text-decoration:none;color:inherit href=#org-coderef--cd71af-10>10</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=org-coderef--cd71af-11><a style=outline:none;text-decoration:none;color:inherit href=#org-coderef--cd71af-11>11</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=org-coderef--cd71af-12><a style=outline:none;text-decoration:none;color:inherit href=#org-coderef--cd71af-12>12</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=org-coderef--cd71af-13><a style=outline:none;text-decoration:none;color:inherit href=#org-coderef--cd71af-13>13</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=org-coderef--cd71af-14><a style=outline:none;text-decoration:none;color:inherit href=#org-coderef--cd71af-14>14</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=org-coderef--cd71af-15><a style=outline:none;text-decoration:none;color:inherit href=#org-coderef--cd71af-15>15</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=org-coderef--cd71af-16><a style=outline:none;text-decoration:none;color:inherit href=#org-coderef--cd71af-16>16</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=org-coderef--cd71af-17><a style=outline:none;text-decoration:none;color:inherit href=#org-coderef--cd71af-17>17</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=org-coderef--cd71af-18><a style=outline:none;text-decoration:none;color:inherit href=#org-coderef--cd71af-18>18</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=org-coderef--cd71af-19><a style=outline:none;text-decoration:none;color:inherit href=#org-coderef--cd71af-19>19</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=org-coderef--cd71af-20><a style=outline:none;text-decoration:none;color:inherit href=#org-coderef--cd71af-20>20</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=org-coderef--cd71af-21><a style=outline:none;text-decoration:none;color:inherit href=#org-coderef--cd71af-21>21</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=org-coderef--cd71af-22><a style=outline:none;text-decoration:none;color:inherit href=#org-coderef--cd71af-22>22</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=org-coderef--cd71af-23><a style=outline:none;text-decoration:none;color:inherit href=#org-coderef--cd71af-23>23</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=org-coderef--cd71af-24><a style=outline:none;text-decoration:none;color:inherit href=#org-coderef--cd71af-24>24</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=org-coderef--cd71af-25><a style=outline:none;text-decoration:none;color:inherit href=#org-coderef--cd71af-25>25</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=org-coderef--cd71af-26><a style=outline:none;text-decoration:none;color:inherit href=#org-coderef--cd71af-26>26</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=org-coderef--cd71af-27><a style=outline:none;text-decoration:none;color:inherit href=#org-coderef--cd71af-27>27</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=org-coderef--cd71af-28><a style=outline:none;text-decoration:none;color:inherit href=#org-coderef--cd71af-28>28</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=org-coderef--cd71af-29><a style=outline:none;text-decoration:none;color:inherit href=#org-coderef--cd71af-29>29</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=org-coderef--cd71af-30><a style=outline:none;text-decoration:none;color:inherit href=#org-coderef--cd71af-30>30</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=org-coderef--cd71af-31><a style=outline:none;text-decoration:none;color:inherit href=#org-coderef--cd71af-31>31</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=org-coderef--cd71af-32><a style=outline:none;text-decoration:none;color:inherit href=#org-coderef--cd71af-32>32</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=org-coderef--cd71af-33><a style=outline:none;text-decoration:none;color:inherit href=#org-coderef--cd71af-33>33</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=org-coderef--cd71af-34><a style=outline:none;text-decoration:none;color:inherit href=#org-coderef--cd71af-34>34</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=org-coderef--cd71af-35><a style=outline:none;text-decoration:none;color:inherit href=#org-coderef--cd71af-35>35</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=org-coderef--cd71af-36><a style=outline:none;text-decoration:none;color:inherit href=#org-coderef--cd71af-36>36</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=org-coderef--cd71af-37><a style=outline:none;text-decoration:none;color:inherit href=#org-coderef--cd71af-37>37</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=org-coderef--cd71af-38><a style=outline:none;text-decoration:none;color:inherit href=#org-coderef--cd71af-38>38</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=org-coderef--cd71af-39><a style=outline:none;text-decoration:none;color:inherit href=#org-coderef--cd71af-39>39</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=org-coderef--cd71af-40><a style=outline:none;text-decoration:none;color:inherit href=#org-coderef--cd71af-40>40</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=org-coderef--cd71af-41><a style=outline:none;text-decoration:none;color:inherit href=#org-coderef--cd71af-41>41</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=org-coderef--cd71af-42><a style=outline:none;text-decoration:none;color:inherit href=#org-coderef--cd71af-42>42</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=org-coderef--cd71af-43><a style=outline:none;text-decoration:none;color:inherit href=#org-coderef--cd71af-43>43</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=org-coderef--cd71af-44><a style=outline:none;text-decoration:none;color:inherit href=#org-coderef--cd71af-44>44</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=org-coderef--cd71af-45><a style=outline:none;text-decoration:none;color:inherit href=#org-coderef--cd71af-45>45</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=org-coderef--cd71af-46><a style=outline:none;text-decoration:none;color:inherit href=#org-coderef--cd71af-46>46</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=org-coderef--cd71af-47><a style=outline:none;text-decoration:none;color:inherit href=#org-coderef--cd71af-47>47</a>
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-c data-lang=c><span style=display:flex><span><span style=color:#b00040>void</span>
</span></span><span style=display:flex><span><span style=color:#00f>AcceptInvalidationMessages</span>(<span style=color:#b00040>void</span>)
</span></span><span style=display:flex><span>{
</span></span><span style=display:flex><span>    <span style=color:#00f>ReceiveSharedInvalidMessages</span>(LocalExecuteInvalidationMessage,
</span></span><span style=display:flex><span>                                 InvalidateSystemCaches);
</span></span><span style=display:flex><span>    <span style=color:#408080;font-style:italic>// ... skipped ...
</span></span></span><span style=display:flex><span><span style=color:#408080;font-style:italic></span>}
</span></span><span style=display:flex><span><span style=color:#b00040>void</span>
</span></span><span style=display:flex><span><span style=color:#00f>ReceiveSharedInvalidMessages</span>(<span style=color:#b00040>void</span> (<span style=color:#666>*</span>invalFunction) (SharedInvalidationMessage <span style=color:#666>*</span>msg),
</span></span><span style=display:flex><span>                             <span style=color:#b00040>void</span> (<span style=color:#666>*</span>resetFunction) (<span style=color:#b00040>void</span>))
</span></span><span style=display:flex><span>{
</span></span><span style=display:flex><span>    <span style=color:#408080;font-style:italic>// ... skipped ...
</span></span></span><span style=display:flex><span><span style=color:#408080;font-style:italic></span>
</span></span><span style=display:flex><span>    getResult <span style=color:#666>=</span> <span style=color:#00f>SIGetDataEntries</span>(messages, MAXINVALMSGS);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:green;font-weight:700>if</span> (getResult <span style=color:#666>&lt;</span> <span style=color:#666>0</span>)
</span></span><span style=display:flex><span>    {
</span></span><span style=display:flex><span>        <span style=color:#408080;font-style:italic>/* got a reset message */</span>
</span></span><span style=display:flex><span>        <span style=color:#00f>elog</span>(DEBUG4, <span style=color:#ba2121>&#34;cache state reset&#34;</span>);
</span></span><span style=display:flex><span>        SharedInvalidMessageCounter<span style=color:#666>++</span>;
</span></span><span style=display:flex><span>        <span style=color:#00f>resetFunction</span>();
</span></span><span style=display:flex><span>        <span style=color:green;font-weight:700>break</span>;				<span style=color:#408080;font-style:italic>/* nothing more to do */</span>
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#408080;font-style:italic>// ... skipped ...
</span></span></span><span style=display:flex><span><span style=color:#408080;font-style:italic></span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#b00040>int</span>
</span></span><span style=display:flex><span><span style=color:#00f>SIGetDataEntries</span>(SharedInvalidationMessage <span style=color:#666>*</span>data, <span style=color:#b00040>int</span> datasize)
</span></span><span style=display:flex><span>{
</span></span><span style=display:flex><span>    <span style=color:#408080;font-style:italic>// ... skipped ...
</span></span></span><span style=display:flex><span><span style=color:#408080;font-style:italic></span>    <span style=color:green;font-weight:700>if</span> (stateP<span style=color:#666>-&gt;</span>resetState)
</span></span><span style=display:flex><span>    {
</span></span><span style=display:flex><span>        <span style=color:#408080;font-style:italic>/*
</span></span></span><span style=display:flex><span><span style=color:#408080;font-style:italic>         * Force reset.  We can say we have dealt with any messages added
</span></span></span><span style=display:flex><span><span style=color:#408080;font-style:italic>         * since the reset, as well; and that means we should clear the
</span></span></span><span style=display:flex><span><span style=color:#408080;font-style:italic>         * signaled flag, too.
</span></span></span><span style=display:flex><span><span style=color:#408080;font-style:italic>         */</span>
</span></span><span style=display:flex><span>        stateP<span style=color:#666>-&gt;</span>nextMsgNum <span style=color:#666>=</span> max;
</span></span><span style=display:flex><span>        stateP<span style=color:#666>-&gt;</span>resetState <span style=color:#666>=</span> <span style=color:green>false</span>;
</span></span><span style=display:flex><span>        stateP<span style=color:#666>-&gt;</span>signaled <span style=color:#666>=</span> <span style=color:green>false</span>;
</span></span><span style=display:flex><span>        <span style=color:#00f>LWLockRelease</span>(SInvalReadLock);
</span></span><span style=display:flex><span>        <span style=color:green;font-weight:700>return</span> <span style=color:#666>-</span><span style=color:#666>1</span>;
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#408080;font-style:italic>// ... skipped ...
</span></span></span><span style=display:flex><span><span style=color:#408080;font-style:italic></span>}
</span></span></code></pre></td></tr></table></div></div><ul><li><code>ReceiveSharedInvalidMessages()</code> 中调用 <code>SIGetDataEntries()</code> 来取得未处理的消息</li><li><code>SIGetDataEntries()</code> 发现被重置后，返回 <code>-1</code></li><li><code>ReceiveSharedInvalidMessages()</code> 检查到返回值小于 <code>0</code> ，则调用传入的回调函数
<code>InvalidateSystemCaches()</code> 来进行清理缓存</li></ul><h3 id=信号的处理>3.2 信号的处理<a hidden class=anchor aria-hidden=true href=#信号的处理>#</a></h3><p>信号处理最终会调到函数 <code>ProcessCatchupInterrupt()</code> ：</p><div class=highlight><pre tabindex=0 style=-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-c data-lang=c><span style=display:flex><span><span style=color:#408080;font-style:italic>/*
</span></span></span><span style=display:flex><span><span style=color:#408080;font-style:italic> * ProcessCatchupInterrupt
</span></span></span><span style=display:flex><span><span style=color:#408080;font-style:italic> *
</span></span></span><span style=display:flex><span><span style=color:#408080;font-style:italic> * 处理追赶中断的部分，运行在信号处理程序之外，使其能够实际处理待处理的失效消息。
</span></span></span><span style=display:flex><span><span style=color:#408080;font-style:italic> */</span>
</span></span><span style=display:flex><span><span style=color:#b00040>void</span>
</span></span><span style=display:flex><span><span style=color:#00f>ProcessCatchupInterrupt</span>(<span style=color:#b00040>void</span>)
</span></span><span style=display:flex><span>{
</span></span><span style=display:flex><span>    <span style=color:green;font-weight:700>while</span> (catchupInterruptPending)
</span></span><span style=display:flex><span>    {
</span></span><span style=display:flex><span>        <span style=color:#408080;font-style:italic>/*
</span></span></span><span style=display:flex><span><span style=color:#408080;font-style:italic>         * 在这里我们需要让 ReceiveSharedInvalidMessages() 函数运行，它将进行必要的处理并重置
</span></span></span><span style=display:flex><span><span style=color:#408080;font-style:italic>         * catchupInterruptPending 标志。如果我们正在事务中，可以直接调用 AcceptInvalidationMessages()
</span></span></span><span style=display:flex><span><span style=color:#408080;font-style:italic>         * 来执行这个操作。如果不是，在这里启动并立即结束一个事务；AcceptInvalidationMessages() 的调用
</span></span></span><span style=display:flex><span><span style=color:#408080;font-style:italic>         * 发生在事务启动内部。
</span></span></span><span style=display:flex><span><span style=color:#408080;font-style:italic>         *
</span></span></span><span style=display:flex><span><span style=color:#408080;font-style:italic>         * 很诱人地，我们可以尝试只调用 AcceptInvalidationMessages()，而不执行事务启动/停止的其他操作，
</span></span></span><span style=display:flex><span><span style=color:#408080;font-style:italic>         * 我认为在正常情况下这样做是可行的；但是如果出现错误，我不确定处理会不会很顺利。
</span></span></span><span style=display:flex><span><span style=color:#408080;font-style:italic>         */</span>
</span></span><span style=display:flex><span>        <span style=color:green;font-weight:700>if</span> (<span style=color:#00f>IsTransactionOrTransactionBlock</span>())
</span></span><span style=display:flex><span>        {
</span></span><span style=display:flex><span>            <span style=color:#00f>elog</span>(DEBUG4, <span style=color:#ba2121>&#34;ProcessCatchupEvent inside transaction&#34;</span>);
</span></span><span style=display:flex><span>            <span style=color:#00f>AcceptInvalidationMessages</span>();
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>        <span style=color:green;font-weight:700>else</span>
</span></span><span style=display:flex><span>        {
</span></span><span style=display:flex><span>            <span style=color:#00f>elog</span>(DEBUG4, <span style=color:#ba2121>&#34;ProcessCatchupEvent outside transaction&#34;</span>);
</span></span><span style=display:flex><span>            <span style=color:#00f>StartTransactionCommand</span>();
</span></span><span style=display:flex><span>            <span style=color:#00f>CommitTransactionCommand</span>();
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p><code>AcceptInvalidationMessages()</code> 见 <a href=#org-coderef--cd71af-2>2</a> 。</p></div><footer class=post-footer><ul class=post-tags><li><a href=https://yangyingchao.github.io/tags/pg/>pg</a></li><li><a href=https://yangyingchao.github.io/tags/cache/>cache</a></li><li><a href=https://yangyingchao.github.io/tags/inval/>inval</a></li><li><a href=https://yangyingchao.github.io/tags/msg/>msg</a></li><li><a href=https://yangyingchao.github.io/tags/postgres/>postgres</a></li></ul></footer></article></main><footer class=footer><span>&copy; 2024 <a href=https://yangyingchao.github.io>MyNotes</a></span>
<span>Powered by
<a href=https://gohugo.io/ rel="noopener noreferrer" target=_blank>Hugo</a> &
        <a href=https://github.com/adityatelange/hugo-PaperMod/ rel=noopener target=_blank>PaperMod</a></span></footer><a href=#top aria-label="go to top" title="Go to Top (Alt + G)" class=top-link id=top-link accesskey=g><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 12 6" fill="currentcolor"><path d="M12 6H0l6-6z"/></svg></a><script>let menu=document.getElementById("menu");menu&&(menu.scrollLeft=localStorage.getItem("menu-scroll-position"),menu.onscroll=function(){localStorage.setItem("menu-scroll-position",menu.scrollLeft)}),document.querySelectorAll('a[href^="#"]').forEach(e=>{e.addEventListener("click",function(e){e.preventDefault();var t=this.getAttribute("href").substr(1);window.matchMedia("(prefers-reduced-motion: reduce)").matches?document.querySelector(`[id='${decodeURIComponent(t)}']`).scrollIntoView():document.querySelector(`[id='${decodeURIComponent(t)}']`).scrollIntoView({behavior:"smooth"}),t==="top"?history.replaceState(null,null," "):history.pushState(null,null,`#${t}`)})})</script><script>var mybutton=document.getElementById("top-link");window.onscroll=function(){document.body.scrollTop>800||document.documentElement.scrollTop>800?(mybutton.style.visibility="visible",mybutton.style.opacity="1"):(mybutton.style.visibility="hidden",mybutton.style.opacity="0")}</script><script>document.getElementById("theme-toggle").addEventListener("click",()=>{document.body.className.includes("dark")?(document.body.classList.remove("dark"),localStorage.setItem("pref-theme","light")):(document.body.classList.add("dark"),localStorage.setItem("pref-theme","dark"))})</script></body></html>