<!doctype html><html lang=zh-cn dir=auto><head><meta charset=utf-8><meta http-equiv=x-ua-compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no"><meta name=robots content="index, follow"><title>用 pandoc 从 org 生成 docx | MyNotes</title><meta name=keywords content="org,pandoc,lua"><meta name=description content="1 所需软件 2 方法 2.1 advice to org-odt-export-to-odt 2.2 用到的资源文件 最近需要写一些 word 文档，因为一直在用 Emacs 的 org-mode, 不想离开 Emacs 环境，也不想去手动调整 word 格式， 所以花些时间研究了一"><meta name=author content="Yang, Ying-chao"><link rel=canonical href=https://yangyingchao.github.io/posts/%E7%94%A8-pandoc-%E4%BB%8E-org-%E7%94%9F%E6%88%90-docx/><link crossorigin=anonymous href=/assets/css/stylesheet.fc220c15db4aef0318bbf30adc45d33d4d7c88deff3238b23eb255afdc472ca6.css integrity="sha256-/CIMFdtK7wMYu/MK3EXTPU18iN7/MjiyPrJVr9xHLKY=" rel="preload stylesheet" as=style><link rel=icon href=https://yangyingchao.github.io/favicon.ico><link rel=icon type=image/png sizes=16x16 href=https://yangyingchao.github.io/favicon-16x16.png><link rel=icon type=image/png sizes=32x32 href=https://yangyingchao.github.io/favicon-32x32.png><link rel=apple-touch-icon href=https://yangyingchao.github.io/apple-touch-icon.png><link rel=mask-icon href=https://yangyingchao.github.io/safari-pinned-tab.svg><meta name=theme-color content="#2e2e33"><meta name=msapplication-TileColor content="#2e2e33"><noscript><style>#theme-toggle,.top-link{display:none}</style><style>@media(prefers-color-scheme:dark){:root{--theme:rgb(29, 30, 32);--entry:rgb(46, 46, 51);--primary:rgb(218, 218, 219);--secondary:rgb(155, 156, 157);--tertiary:rgb(65, 66, 68);--content:rgb(196, 196, 197);--code-block-bg:rgb(46, 46, 51);--code-bg:rgb(55, 56, 62);--border:rgb(51, 51, 51)}.list{background:var(--theme)}.list:not(.dark)::-webkit-scrollbar-track{background:0 0}.list:not(.dark)::-webkit-scrollbar-thumb{border-color:var(--theme)}}</style></noscript><meta property="og:title" content="用 pandoc 从 org 生成 docx"><meta property="og:description" content="1 所需软件 2 方法 2.1 advice to org-odt-export-to-odt 2.2 用到的资源文件 最近需要写一些 word 文档，因为一直在用 Emacs 的 org-mode, 不想离开 Emacs 环境，也不想去手动调整 word 格式， 所以花些时间研究了一"><meta property="og:type" content="article"><meta property="og:url" content="https://yangyingchao.github.io/posts/%E7%94%A8-pandoc-%E4%BB%8E-org-%E7%94%9F%E6%88%90-docx/"><meta property="article:section" content="posts"><meta property="article:published_time" content="2025-02-15T00:00:00+00:00"><meta property="article:modified_time" content="2025-02-15T00:00:00+00:00"><meta name=twitter:card content="summary"><meta name=twitter:title content="用 pandoc 从 org 生成 docx"><meta name=twitter:description content="1 所需软件 2 方法 2.1 advice to org-odt-export-to-odt 2.2 用到的资源文件 最近需要写一些 word 文档，因为一直在用 Emacs 的 org-mode, 不想离开 Emacs 环境，也不想去手动调整 word 格式， 所以花些时间研究了一"><script type=application/ld+json>{"@context":"https://schema.org","@type":"BreadcrumbList","itemListElement":[{"@type":"ListItem","position":1,"name":"Posts","item":"https://yangyingchao.github.io/posts/"},{"@type":"ListItem","position":2,"name":"用 pandoc 从 org 生成 docx","item":"https://yangyingchao.github.io/posts/%E7%94%A8-pandoc-%E4%BB%8E-org-%E7%94%9F%E6%88%90-docx/"}]}</script><script type=application/ld+json>{"@context":"https://schema.org","@type":"BlogPosting","headline":"用 pandoc 从 org 生成 docx","name":"用 pandoc 从 org 生成 docx","description":"1 所需软件 2 方法 2.1 advice to org-odt-export-to-odt 2.2 用到的资源文件 最近需要写一些 word 文档，因为一直在用 Emacs 的 org-mode, 不想离开 Emacs 环境，也不想去手动调整 word 格式， 所以花些时间研究了一","keywords":["org","pandoc","lua"],"articleBody":" 1 所需软件 2 方法 2.1 advice to org-odt-export-to-odt 2.2 用到的资源文件 最近需要写一些 word 文档，因为一直在用 Emacs 的 org-mode, 不想离开 Emacs 环境，也不想去手动调整 word 格式， 所以花些时间研究了一下怎么使用 pandoc 将 org 转换成 docx 。\n1 所需软件 emacs : i live in emacs pandoc : 文档转换界的瑞士军刀 pandoc-crossref : 一个 pandoc 过滤器，用于对图形、方程、表格进行编号以及对它们进行交叉引用 2 方法 2.1 advice to org-odt-export-to-odt Emacs 内置有命令 org-odt-export-to-odt 可以把 org 转换成 odt 格式，也可以再通过内置命令 org-odt-convert 来把 odt 转换成 docx ， 但这种方式生成的 word 文档在 wps 打开后，总是怪怪的，还是直接使用 pandoc 配合过滤器以及 reference-document 生成的文档看起来更舒服。 所以我给 org-odt-export-to-odt 加了个 advice ，让他在转换成 odt 之后，直接调用 pandoc 来生成 docx 。 之所以先生成 odt ，是为了在生成 odt 过程中 evaluate 各种 babel ，以便生成图片之类。\n(yc/defmacro defadvice! (how places symbol arglist \u0026optional docstring \u0026rest body) \"Define an advice called SYMBOL and add it to PLACES. ARGLIST is as in `defun'. HOW is a keyword as passed to `advice-add', and PLACE is the function to which to add the advice, like in `advice-add'. DOCSTRING and BODY are as in `defun'.\" (declare (doc-string 5) (indent defun)) (unless (stringp docstring) (push docstring body) (setq docstring nil)) `(progn (defun ,symbol ,arglist ,docstring ,@body) (dolist (target (ensure-list ,places)) (advice-add target ,how #',symbol)))) (defadvice! :after 'org-odt-export-to-odt yc/org-odt-export-to-odt-a (\u0026rest args) \"Export to docx, then convert with pandoc. With prefix-arg, open after converted.\" (let* ((curr (buffer-file-name)) (tmp (s-concat curr \"_tmp.org\")) (r-link (rx \"[[\" (group (or \"fig\" \"tbl\") \":\" (+? nonl)) \"]]\"))) (with-temp-file tmp (insert (s-replace-regexp r-link \"[cite:@\\\\1]\" (yc/buffer-content :file curr)))) (yc/pandoc-convert-to-docx tmp (f-swap-ext curr \"docx\") t (s-contains? \"toc:nil\" (or (cadar (org-collect-keywords '(\"options\") nil '(\"options\"))) \"\"))))) 这里函数 yc/org-odt-export-to-odt-a 在 org-odt-export-to-odt 后执行，它会首先使用原始 org 文件生成一个临时文件， 并将内置的 org 格式的引用替换成 pandoc 支持更好的 cite 方式，然后再根据 org header 中声明的是否自动生成 toc 来调用 yc/pandoc-convert-to-docx ：\n(defun yc/pandoc-convert-to-docx (\u0026optional ifile ofile delete no-toc) \"Convert FILES to docx.\" (interactive) (let ((it (or ifile (yc/choose (yc/get-files)))) (ofile (or ofile (f-swap-ext ifile \"docx\")))) (yc/interpret-command (s-join \" \" (list (yc/executable-find \"pandoc\" t) (unless no-toc \"--toc\") \"--filter=pandoc-crossref\" (format \"--lua-filter='%s'\" (yc/-locate-aux it \"doc_filter.lua\" \"~/.local/share/pandoc/doc_filter.lua\")) (format \"--metadata-file='%s'\" (yc/-locate-aux it \"metadata.yaml\" \"~/.local/share/pandoc/metadata.yaml\")) (format \"--reference-doc='%s'\" (yc/-locate-aux it \"custom-reference.docx\" \"~/.local/share/pandoc/custom-reference.docx\")) (format \"'%s' --from %s+east_asian_line_breaks -t docx -o \\\"%s\\\"\" it (pcase (f-ext it) (\"md\" \"markdown\") (_ (f-ext ifile))) ofile) (if delete (list \"; rm \" ifile)))) :infix \"convert-docx\" :popup 'auto :callback (lambda (f s) (if (not s) (error \"Convert failed...\") (message \"Convert finished...\" ) (if current-prefix-arg (let ((current-prefix-arg nil)) (yc/open-with-external-app ofile)))))))) 这个函数会检查本地的一些辅助文件，最终生成了一个 shell 脚本去执行，生成的脚本类似：\n/home/yyc/.emacs.d/lsp/bin/pandoc \\ --toc \\ --filter=pandoc-crossref \\ --lua-filter='/home/yyc/.local/share/pandoc/doc_filter.lua'\\ --metadata-file='/home/yyc/.local/share/pandoc/metadata.yaml' \\ --reference-doc='/home/yyc/.local/share/pandoc/custom-reference.docx' \\ 'tonydeng_github_io_threat-modeling-was-conducted-based-on-STRIDE.org_tmp.org' \\ --from org+east_asian_line_breaks \\ -t docx \\ -o \"tonydeng_github_io_threat-modeling-was-conducted-based-on-STRIDE.docx\" rm tonydeng_github_io_threat-modeling-was-conducted-based-on-STRIDE.org_tmp.org 用到的参数的具体含义，可以直接查看 pandoc --help 。\n2.2 用到的资源文件 doc_filter.lua 自己写的一个针对 docx 输出的过滤器，放在了 这里 主要功能：\n可以向 world 中插入分页符，只需要在 org 中插入下面这行即可：\n#+LATEX: \\newpage 可以手动生成 toc, 只需要在 org 中插入下面这行即可：\n#+LATEX: \\tableofcontents 可以手动添加多个空行：\n#+LATEX: \\vspace{90 mm} 10 mm 会替换成一个空行。\n手动执行忽略某些内容 如果一个 header 中包含标签 nodocx ，那么它的内容将不会输出到 word 中。\ncustom-reference.docx 根据我自己的需要调整过的 word 模板，其中比较坑的表格的边框，开始时候不管怎样调，边框都是透明的，用 wps 和 libreoffice 都不行， 直到最后用 ms office 调整过才生效。\nmetadata.yml 其中含有 pandoc 和 pandoc-crossref 用的配置，主要是中文本土化。\n","wordCount":"943","inLanguage":"zh-cn","datePublished":"2025-02-15T00:00:00Z","dateModified":"2025-02-15T00:00:00Z","author":[{"@type":"Person","name":"Yang"},{"@type":"Person","name":"Ying-chao"}],"mainEntityOfPage":{"@type":"WebPage","@id":"https://yangyingchao.github.io/posts/%E7%94%A8-pandoc-%E4%BB%8E-org-%E7%94%9F%E6%88%90-docx/"},"publisher":{"@type":"Organization","name":"MyNotes","logo":{"@type":"ImageObject","url":"https://yangyingchao.github.io/favicon.ico"}}}</script></head><body id=top><script>localStorage.getItem("pref-theme")==="dark"?document.body.classList.add("dark"):localStorage.getItem("pref-theme")==="light"?document.body.classList.remove("dark"):window.matchMedia("(prefers-color-scheme: dark)").matches&&document.body.classList.add("dark")</script><header class=header><nav class=nav><div class=logo><a href=https://yangyingchao.github.io accesskey=h title="MyNotes (Alt + H)">MyNotes</a><div class=logo-switches><button id=theme-toggle accesskey=t title="(Alt + T)"><svg id="moon" xmlns="http://www.w3.org/2000/svg" width="24" height="18" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 12.79A9 9 0 1111.21 3 7 7 0 0021 12.79z"/></svg><svg id="sun" xmlns="http://www.w3.org/2000/svg" width="24" height="18" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="5"/><line x1="12" y1="1" x2="12" y2="3"/><line x1="12" y1="21" x2="12" y2="23"/><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"/><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"/><line x1="1" y1="12" x2="3" y2="12"/><line x1="21" y1="12" x2="23" y2="12"/><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"/><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"/></svg></button></div></div><ul id=menu><li><a href=https://yangyingchao.github.io/ title=Home><span>Home</span></a></li><li><a href=https://yangyingchao.github.io/posts/ title=Archives><span>Archives</span></a></li><li><a href=https://yangyingchao.github.io/tags/ title=Tags><span>Tags</span></a></li><li><a href=https://yangyingchao.github.io/categories/ title=Categories><span>Categories</span></a></li><li><a href=https://yangyingchao.github.io/contact/ title="Contact me"><span>Contact me</span></a></li></ul></nav></header><main class=main><article class=post-single><header class=post-header><h1 class="post-title entry-hint-parent">用 pandoc 从 org 生成 docx</h1><div class=post-meta><span title='2025-02-15 00:00:00 +0000 UTC'>February 15, 2025</span>&nbsp;·&nbsp;Yang, Ying-chao</div></header><div class=post-content><ul><li>1 <a href=#%E6%89%80%E9%9C%80%E8%BD%AF%E4%BB%B6>所需软件</a></li><li>2 <a href=#%E6%96%B9%E6%B3%95>方法</a><ul><li>2.1 <a href=#advice-to-org-odt-export-to-odt>advice to org-odt-export-to-odt</a></li><li>2.2 <a href=#%E7%94%A8%E5%88%B0%E7%9A%84%E8%B5%84%E6%BA%90%E6%96%87%E4%BB%B6>用到的资源文件</a></li></ul></li></ul><p>最近需要写一些 word 文档，因为一直在用 Emacs 的 org-mode, 不想离开 Emacs 环境，也不想去手动调整 word 格式，
所以花些时间研究了一下怎么使用 pandoc 将 org 转换成 docx 。</p><h2 id=所需软件>1 所需软件<a hidden class=anchor aria-hidden=true href=#所需软件>#</a></h2><ul><li><a href=https://www.gnu.org/s/emacs/>emacs</a> : i live in emacs</li><li><a href=https://github.com/jgm/pandoc/>pandoc</a> : 文档转换界的瑞士军刀</li><li><a href=https://github.com/lierdakil/pandoc-crossref>pandoc-crossref</a> : 一个 pandoc 过滤器，用于对图形、方程、表格进行编号以及对它们进行交叉引用</li></ul><h2 id=方法>2 方法<a hidden class=anchor aria-hidden=true href=#方法>#</a></h2><h3 id=advice-to-org-odt-export-to-odt>2.1 advice to org-odt-export-to-odt<a hidden class=anchor aria-hidden=true href=#advice-to-org-odt-export-to-odt>#</a></h3><p>Emacs 内置有命令 <code>org-odt-export-to-odt</code> 可以把 <code>org</code> 转换成 <code>odt</code> 格式，也可以再通过内置命令 <code>org-odt-convert</code>
来把 <code>odt</code> 转换成 <code>docx</code> ， 但这种方式生成的 word 文档在 wps 打开后，总是怪怪的，还是直接使用 pandoc 配合过滤器以及
reference-document 生成的文档看起来更舒服。
所以我给 <code>org-odt-export-to-odt</code> 加了个 <code>advice</code> ，让他在转换成 <code>odt</code> 之后，直接调用 pandoc 来生成 <code>docx</code> 。
之所以先生成 <code>odt</code> ，是为了在生成 <code>odt</code> 过程中 evaluate 各种 babel ，以便生成图片之类。</p><div class=highlight><pre tabindex=0 style=-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-emacs-lisp data-lang=emacs-lisp><span style=display:flex><span>(<span style=color:#19177c>yc/defmacro</span> <span style=color:#19177c>defadvice!</span> (<span style=color:#19177c>how</span> <span style=color:#19177c>places</span> <span style=color:#19177c>symbol</span> <span style=color:#19177c>arglist</span> <span style=color:green>&amp;optional</span> <span style=color:#19177c>docstring</span> <span style=color:green>&amp;rest</span> <span style=color:#19177c>body</span>)
</span></span><span style=display:flex><span>  <span style=color:#ba2121>&#34;Define an advice called SYMBOL and add it to PLACES.
</span></span></span><span style=display:flex><span><span style=color:#ba2121>
</span></span></span><span style=display:flex><span><span style=color:#ba2121>   ARGLIST is as in </span><span style=color:#19177c>`defun&#39;</span><span style=color:#ba2121>.  HOW is a keyword as passed to </span><span style=color:#19177c>`advice-add&#39;</span><span style=color:#ba2121>, and
</span></span></span><span style=display:flex><span><span style=color:#ba2121>   PLACE is the function to which to add the advice, like in </span><span style=color:#19177c>`advice-add&#39;</span><span style=color:#ba2121>.
</span></span></span><span style=display:flex><span><span style=color:#ba2121>   DOCSTRING and BODY are as in </span><span style=color:#19177c>`defun&#39;</span><span style=color:#ba2121>.&#34;</span>
</span></span><span style=display:flex><span>  (<span style=color:green>declare</span> (<span style=color:#19177c>doc-string</span> <span style=color:#666>5</span>) (<span style=color:#19177c>indent</span> <span style=color:green>defun</span>))
</span></span><span style=display:flex><span>  (<span style=color:green>unless</span> (<span style=color:#00f>stringp</span> <span style=color:#19177c>docstring</span>)
</span></span><span style=display:flex><span>    (<span style=color:green>push</span> <span style=color:#19177c>docstring</span> <span style=color:#19177c>body</span>)
</span></span><span style=display:flex><span>    (<span style=color:green>setq</span> <span style=color:#19177c>docstring</span> <span style=color:#800>nil</span>))
</span></span><span style=display:flex><span>  <span style=color:#666>`</span>(<span style=color:green>progn</span>
</span></span><span style=display:flex><span>     (<span style=color:green>defun</span> <span style=color:#666>,</span><span style=color:#19177c>symbol</span> <span style=color:#666>,</span><span style=color:#19177c>arglist</span> <span style=color:#666>,</span><span style=color:#19177c>docstring</span> <span style=color:#666>,@</span><span style=color:#19177c>body</span>)
</span></span><span style=display:flex><span>     (<span style=color:green>dolist</span> (<span style=color:#19177c>target</span> (<span style=color:#19177c>ensure-list</span> <span style=color:#666>,</span><span style=color:#19177c>places</span>))
</span></span><span style=display:flex><span>       (<span style=color:#19177c>advice-add</span> <span style=color:#19177c>target</span> <span style=color:#666>,</span><span style=color:#19177c>how</span> <span style=color:#00f>#&#39;</span><span style=color:#666>,</span><span style=color:#19177c>symbol</span>))))
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>(<span style=color:#19177c>defadvice!</span> <span style=color:green>:after</span> <span style=color:#19177c>&#39;org-odt-export-to-odt</span> <span style=color:#19177c>yc/org-odt-export-to-odt-a</span> (<span style=color:green>&amp;rest</span> <span style=color:#19177c>args</span>)
</span></span><span style=display:flex><span>  <span style=color:#ba2121>&#34;Export to docx, then convert with pandoc. With prefix-arg, open after converted.&#34;</span>
</span></span><span style=display:flex><span>  (<span style=color:green>let*</span> ((<span style=color:#19177c>curr</span> (<span style=color:#00f>buffer-file-name</span>))
</span></span><span style=display:flex><span>         (<span style=color:#19177c>tmp</span> (<span style=color:#19177c>s-concat</span> <span style=color:#19177c>curr</span> <span style=color:#ba2121>&#34;_tmp.org&#34;</span>))
</span></span><span style=display:flex><span>         (<span style=color:#19177c>r-link</span> (<span style=color:green>rx</span> <span style=color:#ba2121>&#34;[[&#34;</span> (<span style=color:#19177c>group</span> (<span style=color:green>or</span> <span style=color:#ba2121>&#34;fig&#34;</span> <span style=color:#ba2121>&#34;tbl&#34;</span>) <span style=color:#ba2121>&#34;:&#34;</span> (<span style=color:#19177c>+?</span> <span style=color:#19177c>nonl</span>)) <span style=color:#ba2121>&#34;]]&#34;</span>)))
</span></span><span style=display:flex><span>    (<span style=color:green>with-temp-file</span> <span style=color:#19177c>tmp</span>
</span></span><span style=display:flex><span>      (<span style=color:#00f>insert</span> (<span style=color:#19177c>s-replace-regexp</span> <span style=color:#19177c>r-link</span> <span style=color:#ba2121>&#34;[cite:@\\1]&#34;</span> (<span style=color:#19177c>yc/buffer-content</span> <span style=color:green>:file</span> <span style=color:#19177c>curr</span>))))
</span></span><span style=display:flex><span>    (<span style=color:#19177c>yc/pandoc-convert-to-docx</span> <span style=color:#19177c>tmp</span> (<span style=color:#19177c>f-swap-ext</span> <span style=color:#19177c>curr</span> <span style=color:#ba2121>&#34;docx&#34;</span>) <span style=color:#800>t</span>
</span></span><span style=display:flex><span>      (<span style=color:#19177c>s-contains?</span> <span style=color:#ba2121>&#34;toc:nil&#34;</span> (<span style=color:green>or</span> (<span style=color:#19177c>cadar</span> (<span style=color:#19177c>org-collect-keywords</span> <span style=color:#666>&#39;</span>(<span style=color:#ba2121>&#34;options&#34;</span>) <span style=color:#800>nil</span> <span style=color:#666>&#39;</span>(<span style=color:#ba2121>&#34;options&#34;</span>))) <span style=color:#ba2121>&#34;&#34;</span>)))))
</span></span></code></pre></div><p>这里函数 <code>yc/org-odt-export-to-odt-a</code> 在 <code>org-odt-export-to-odt</code> 后执行，它会首先使用原始 <code>org</code> 文件生成一个临时文件，
并将内置的 org 格式的引用替换成 pandoc 支持更好的 cite 方式，然后再根据 org header 中声明的是否自动生成 toc 来调用
<code>yc/pandoc-convert-to-docx</code> ：</p><div class=highlight><pre tabindex=0 style=-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-emacs-lisp data-lang=emacs-lisp><span style=display:flex><span>(<span style=color:green>defun</span> <span style=color:#19177c>yc/pandoc-convert-to-docx</span> (<span style=color:green>&amp;optional</span> <span style=color:#19177c>ifile</span> <span style=color:#19177c>ofile</span> <span style=color:#00f>delete</span> <span style=color:#19177c>no-toc</span>)
</span></span><span style=display:flex><span>  <span style=color:#ba2121>&#34;Convert FILES to docx.&#34;</span>
</span></span><span style=display:flex><span>  (<span style=color:green>interactive</span>)
</span></span><span style=display:flex><span>  (<span style=color:green>let</span> ((<span style=color:#19177c>it</span> (<span style=color:green>or</span> <span style=color:#19177c>ifile</span> (<span style=color:#19177c>yc/choose</span> (<span style=color:#19177c>yc/get-files</span>))))
</span></span><span style=display:flex><span>        (<span style=color:#19177c>ofile</span> (<span style=color:green>or</span> <span style=color:#19177c>ofile</span> (<span style=color:#19177c>f-swap-ext</span> <span style=color:#19177c>ifile</span> <span style=color:#ba2121>&#34;docx&#34;</span>))))
</span></span><span style=display:flex><span>    (<span style=color:#19177c>yc/interpret-command</span>
</span></span><span style=display:flex><span>      (<span style=color:#19177c>s-join</span> <span style=color:#ba2121>&#34; &#34;</span>
</span></span><span style=display:flex><span>        (<span style=color:#00f>list</span>
</span></span><span style=display:flex><span>         (<span style=color:#19177c>yc/executable-find</span> <span style=color:#ba2121>&#34;pandoc&#34;</span> <span style=color:#800>t</span>) (<span style=color:green>unless</span> <span style=color:#19177c>no-toc</span> <span style=color:#ba2121>&#34;--toc&#34;</span>) <span style=color:#ba2121>&#34;--filter=pandoc-crossref&#34;</span>
</span></span><span style=display:flex><span>         (<span style=color:#00f>format</span> <span style=color:#ba2121>&#34;--lua-filter=&#39;%s&#39;&#34;</span>
</span></span><span style=display:flex><span>           (<span style=color:#19177c>yc/-locate-aux</span> <span style=color:#19177c>it</span> <span style=color:#ba2121>&#34;doc_filter.lua&#34;</span> <span style=color:#ba2121>&#34;~/.local/share/pandoc/doc_filter.lua&#34;</span>))
</span></span><span style=display:flex><span>         (<span style=color:#00f>format</span> <span style=color:#ba2121>&#34;--metadata-file=&#39;%s&#39;&#34;</span>
</span></span><span style=display:flex><span>           (<span style=color:#19177c>yc/-locate-aux</span> <span style=color:#19177c>it</span> <span style=color:#ba2121>&#34;metadata.yaml&#34;</span> <span style=color:#ba2121>&#34;~/.local/share/pandoc/metadata.yaml&#34;</span>))
</span></span><span style=display:flex><span>         (<span style=color:#00f>format</span> <span style=color:#ba2121>&#34;--reference-doc=&#39;%s&#39;&#34;</span>
</span></span><span style=display:flex><span>           (<span style=color:#19177c>yc/-locate-aux</span> <span style=color:#19177c>it</span> <span style=color:#ba2121>&#34;custom-reference.docx&#34;</span> <span style=color:#ba2121>&#34;~/.local/share/pandoc/custom-reference.docx&#34;</span>))
</span></span><span style=display:flex><span>         (<span style=color:#00f>format</span> <span style=color:#ba2121>&#34;&#39;%s&#39; --from %s+east_asian_line_breaks -t docx -o \&#34;%s\&#34;&#34;</span>
</span></span><span style=display:flex><span>           <span style=color:#19177c>it</span> (<span style=color:green>pcase</span> (<span style=color:#19177c>f-ext</span> <span style=color:#19177c>it</span>) (<span style=color:#ba2121>&#34;md&#34;</span> <span style=color:#ba2121>&#34;markdown&#34;</span>) (<span style=color:#19177c>_</span> (<span style=color:#19177c>f-ext</span> <span style=color:#19177c>ifile</span>))) <span style=color:#19177c>ofile</span>)
</span></span><span style=display:flex><span>         (<span style=color:green>if</span> <span style=color:#00f>delete</span> (<span style=color:#00f>list</span> <span style=color:#ba2121>&#34;; rm &#34;</span> <span style=color:#19177c>ifile</span>))))
</span></span><span style=display:flex><span>      <span style=color:green>:infix</span> <span style=color:#ba2121>&#34;convert-docx&#34;</span> <span style=color:green>:popup</span> <span style=color:#19177c>&#39;auto</span> <span style=color:green>:callback</span> (<span style=color:green>lambda</span> (<span style=color:#19177c>f</span> <span style=color:#19177c>s</span>)
</span></span><span style=display:flex><span>                                                     (<span style=color:green>if</span> (<span style=color:#19177c>not</span> <span style=color:#19177c>s</span>)
</span></span><span style=display:flex><span>                                                         (<span style=color:#d2413a;font-weight:700>error</span> <span style=color:#ba2121>&#34;Convert failed...&#34;</span>)
</span></span><span style=display:flex><span>                                                       (<span style=color:#00f>message</span> <span style=color:#ba2121>&#34;Convert finished...&#34;</span> )
</span></span><span style=display:flex><span>                                                       (<span style=color:green>if</span> <span style=color:#19177c>current-prefix-arg</span>
</span></span><span style=display:flex><span>                                                           (<span style=color:green>let</span> ((<span style=color:#19177c>current-prefix-arg</span> <span style=color:#800>nil</span>))
</span></span><span style=display:flex><span>                                                             (<span style=color:#19177c>yc/open-with-external-app</span> <span style=color:#19177c>ofile</span>))))))))
</span></span></code></pre></div><p>这个函数会检查本地的一些辅助文件，最终生成了一个 shell 脚本去执行，生成的脚本类似：</p><div class=highlight><pre tabindex=0 style=-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sh data-lang=sh><span style=display:flex><span>/home/yyc/.emacs.d/lsp/bin/pandoc <span style=color:#b62;font-weight:700>\
</span></span></span><span style=display:flex><span><span style=color:#b62;font-weight:700></span>    --toc <span style=color:#b62;font-weight:700>\
</span></span></span><span style=display:flex><span><span style=color:#b62;font-weight:700></span>    --filter<span style=color:#666>=</span>pandoc-crossref <span style=color:#b62;font-weight:700>\
</span></span></span><span style=display:flex><span><span style=color:#b62;font-weight:700></span>    --lua-filter<span style=color:#666>=</span><span style=color:#ba2121>&#39;/home/yyc/.local/share/pandoc/doc_filter.lua&#39;</span><span style=color:#b62;font-weight:700>\
</span></span></span><span style=display:flex><span><span style=color:#b62;font-weight:700></span>    --metadata-file<span style=color:#666>=</span><span style=color:#ba2121>&#39;/home/yyc/.local/share/pandoc/metadata.yaml&#39;</span> <span style=color:#b62;font-weight:700>\
</span></span></span><span style=display:flex><span><span style=color:#b62;font-weight:700></span>    --reference-doc<span style=color:#666>=</span><span style=color:#ba2121>&#39;/home/yyc/.local/share/pandoc/custom-reference.docx&#39;</span> <span style=color:#b62;font-weight:700>\
</span></span></span><span style=display:flex><span><span style=color:#b62;font-weight:700></span>    <span style=color:#ba2121>&#39;tonydeng_github_io_threat-modeling-was-conducted-based-on-STRIDE.org_tmp.org&#39;</span> <span style=color:#b62;font-weight:700>\
</span></span></span><span style=display:flex><span><span style=color:#b62;font-weight:700></span>    --from org+east_asian_line_breaks <span style=color:#b62;font-weight:700>\
</span></span></span><span style=display:flex><span><span style=color:#b62;font-weight:700></span>    -t docx <span style=color:#b62;font-weight:700>\
</span></span></span><span style=display:flex><span><span style=color:#b62;font-weight:700></span>    -o <span style=color:#ba2121>&#34;tonydeng_github_io_threat-modeling-was-conducted-based-on-STRIDE.docx&#34;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>rm  tonydeng_github_io_threat-modeling-was-conducted-based-on-STRIDE.org_tmp.org
</span></span></code></pre></div><p>用到的参数的具体含义，可以直接查看 <code>pandoc --help</code> 。</p><h3 id=用到的资源文件>2.2 用到的资源文件<a hidden class=anchor aria-hidden=true href=#用到的资源文件>#</a></h3><ul><li><p><code>doc_filter.lua</code>
自己写的一个针对 docx 输出的过滤器，放在了 <a href=assets/doc_filter.lua>这里</a> 主要功能：</p><ul><li><p>可以向 world 中插入分页符，只需要在 org 中插入下面这行即可：</p><div class=highlight><pre tabindex=0 style=-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-org data-lang=org><span style=display:flex><span><span style=color:#408080;font-style:italic>#+LATEX</span><span style=color:#408080;font-style:italic>: \newpage</span>
</span></span></code></pre></div></li><li><p>可以手动生成 toc, 只需要在 org 中插入下面这行即可：</p><div class=highlight><pre tabindex=0 style=-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-org data-lang=org><span style=display:flex><span><span style=color:#408080;font-style:italic>#+LATEX</span><span style=color:#408080;font-style:italic>: \tableofcontents</span>
</span></span></code></pre></div></li><li><p>可以手动添加多个空行：</p><div class=highlight><pre tabindex=0 style=-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-org data-lang=org><span style=display:flex><span><span style=color:#408080;font-style:italic>#+LATEX</span><span style=color:#408080;font-style:italic>: \vspace{90 mm}</span>
</span></span></code></pre></div><p><code>10 mm</code> 会替换成一个空行。</p></li><li><p>手动执行忽略某些内容
如果一个 header 中包含标签 <code>nodocx</code> ，那么它的内容将不会输出到 word 中。</p></li></ul></li><li><p><a href=/ox-hugo/custom-reference.docx>custom-reference.docx</a>
根据我自己的需要调整过的 word 模板，其中比较坑的表格的边框，开始时候不管怎样调，边框都是透明的，用 wps 和 libreoffice 都不行，
直到最后用 ms office 调整过才生效。</p></li><li><p><a href=assets/metadata.yaml>metadata.yml</a>
其中含有 pandoc 和 pandoc-crossref 用的配置，主要是中文本土化。</p></li></ul></div><footer class=post-footer><ul class=post-tags><li><a href=https://yangyingchao.github.io/tags/org/>org</a></li><li><a href=https://yangyingchao.github.io/tags/pandoc/>pandoc</a></li><li><a href=https://yangyingchao.github.io/tags/lua/>lua</a></li></ul></footer></article></main><footer class=footer><span>&copy; 2025 <a href=https://yangyingchao.github.io>MyNotes</a></span> ·
<span>Powered by
<a href=https://gohugo.io/ rel="noopener noreferrer" target=_blank>Hugo</a> &
        <a href=https://github.com/adityatelange/hugo-PaperMod/ rel=noopener target=_blank>PaperMod</a></span></footer><a href=#top aria-label="go to top" title="Go to Top (Alt + G)" class=top-link id=top-link accesskey=g><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 12 6" fill="currentcolor"><path d="M12 6H0l6-6z"/></svg></a><script>let menu=document.getElementById("menu");menu&&(menu.scrollLeft=localStorage.getItem("menu-scroll-position"),menu.onscroll=function(){localStorage.setItem("menu-scroll-position",menu.scrollLeft)}),document.querySelectorAll('a[href^="#"]').forEach(e=>{e.addEventListener("click",function(e){e.preventDefault();var t=this.getAttribute("href").substr(1);window.matchMedia("(prefers-reduced-motion: reduce)").matches?document.querySelector(`[id='${decodeURIComponent(t)}']`).scrollIntoView():document.querySelector(`[id='${decodeURIComponent(t)}']`).scrollIntoView({behavior:"smooth"}),t==="top"?history.replaceState(null,null," "):history.pushState(null,null,`#${t}`)})})</script><script>var mybutton=document.getElementById("top-link");window.onscroll=function(){document.body.scrollTop>800||document.documentElement.scrollTop>800?(mybutton.style.visibility="visible",mybutton.style.opacity="1"):(mybutton.style.visibility="hidden",mybutton.style.opacity="0")}</script><script>document.getElementById("theme-toggle").addEventListener("click",()=>{document.body.className.includes("dark")?(document.body.classList.remove("dark"),localStorage.setItem("pref-theme","light")):(document.body.classList.add("dark"),localStorage.setItem("pref-theme","dark"))})</script></body></html>