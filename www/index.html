<!doctype html><html lang=zh-cn><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta name=robots content="noodp"><title>分布式 PostgreSQL之Citus 架构-postgresql 分布式 - 杂货铺</title><meta name=Description content="杂七杂八的，随手记录。"><meta property="og:url" content="https://yangyingchao.github.io/www/">
<meta property="og:site_name" content="杂货铺"><meta property="og:title" content="分布式 PostgreSQL之Citus 架构-postgresql 分布式"><meta property="og:description" content="Table of Contents 1 节点 1.1 Coordinator 与 Worker 2 分布式数据 2.1 表类型 2.2 Shards 3 查询执行 本文为摘录(或转载)，侵删，原文为： https://www.51cto.com/article/703272.html
1 节点 Citus 是一种 PostgreSQL 扩展，它允许数据库服务器(称为节点)在“无共享(shared nothing)”架构中相互协调。这些节点形成一个集群，允许 PostgreSQL 保存比单台计算机上更多的数据和使用更多的 CPU 内核。这种架构还允许通过简单地向集群添加更多节点来扩容数据库。"><meta property="og:locale" content="zh_cn"><meta property="og:type" content="article"><meta property="article:section" content="posts"><meta property="article:published_time" content="2024-05-13T00:00:00+00:00"><meta property="article:modified_time" content="2024-05-13T00:00:00+00:00"><meta property="article:tag" content="Transaction"><meta property="article:tag" content="Pg"><meta property="article:tag" content="Citus"><meta property="og:image" content="https://yangyingchao.github.io/logo.png"><meta name=twitter:card content="summary_large_image"><meta name=twitter:image content="https://yangyingchao.github.io/logo.png"><meta name=twitter:title content="分布式 PostgreSQL之Citus 架构-postgresql 分布式"><meta name=twitter:description content="Table of Contents 1 节点 1.1 Coordinator 与 Worker 2 分布式数据 2.1 表类型 2.2 Shards 3 查询执行 本文为摘录(或转载)，侵删，原文为： https://www.51cto.com/article/703272.html
1 节点 Citus 是一种 PostgreSQL 扩展，它允许数据库服务器(称为节点)在“无共享(shared nothing)”架构中相互协调。这些节点形成一个集群，允许 PostgreSQL 保存比单台计算机上更多的数据和使用更多的 CPU 内核。这种架构还允许通过简单地向集群添加更多节点来扩容数据库。"><meta name=application-name content="LoveIt"><meta name=apple-mobile-web-app-title content="LoveIt"><meta name=theme-color content="#ffffff"><meta name=msapplication-TileColor content="#da532c"><link rel="shortcut icon" type=image/x-icon href=/favicon.ico><link rel=icon type=image/png sizes=32x32 href=/favicon-32x32.png><link rel=icon type=image/png sizes=16x16 href=/favicon-16x16.png><link rel=apple-touch-icon sizes=180x180 href=/apple-touch-icon.png><link rel=mask-icon href=/safari-pinned-tab.svg color=#5bbad5><link rel=manifest href=/site.webmanifest><link rel=canonical href=https://yangyingchao.github.io/www/><link rel=prev href=https://yangyingchao.github.io/stackoverflow/><link rel=next href=https://yangyingchao.github.io/org-fold-core/><link rel=stylesheet href=/css/style.min.css><link rel=preload href=https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6.1.1/css/all.min.css as=style onload='this.onload=null,this.rel="stylesheet"'><noscript><link rel=stylesheet href=https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6.1.1/css/all.min.css></noscript><link rel=preload href=https://cdn.jsdelivr.net/npm/animate.css@4.1.1/animate.min.css as=style onload='this.onload=null,this.rel="stylesheet"'><noscript><link rel=stylesheet href=https://cdn.jsdelivr.net/npm/animate.css@4.1.1/animate.min.css></noscript><script type=application/ld+json>{"@context":"http://schema.org","@type":"BlogPosting","headline":"分布式 PostgreSQL之Citus 架构-postgresql 分布式","inLanguage":"zh-cn","mainEntityOfPage":{"@type":"WebPage","@id":"https:\/\/yangyingchao.github.io\/www\/"},"image":["https:\/\/yangyingchao.github.io\/images\/Apple-Devices-Preview.png"],"genre":"posts","keywords":"transaction, pg, citus","wordcount":2835,"url":"https:\/\/yangyingchao.github.io\/www\/","datePublished":"2024-05-13T00:00:00+00:00","dateModified":"2024-05-13T00:00:00+00:00","publisher":{"@type":"Organization","name":"xxxx","logo":"https:\/\/yangyingchao.github.io\/images\/avatar.png"},"author":{"@type":"Person","name":"yc"},"description":""}</script></head><body data-header-desktop=normal data-header-mobile=auto><script type=text/javascript>(window.localStorage&&localStorage.getItem("theme")?localStorage.getItem("theme")==="dark":"auto"==="auto"?window.matchMedia("(prefers-color-scheme: dark)").matches:"auto"==="dark")&&document.body.setAttribute("theme","dark")</script><div id=mask></div><div class=wrapper><header class=desktop id=header-desktop><div class=header-wrapper><div class=header-title><a href=/ title=杂货铺><span class=header-title-pre><i class="fa-solid fa-house-chimney"></i></span>老杨的杂货铺</a></div><div class=menu><div class=menu-inner><a class=menu-item href=/posts/>所有文章 </a><a class=menu-item href=/tags/>标签 </a><a class=menu-item href=/categories/>分类 </a><a class=menu-item href=https://github.com/yangyingchao/MyNotes title=GitHub rel="noopener noreffer" target=_blank><i class='fab fa-github fa-fw' aria-hidden=true></i> </a><span class="menu-item delimiter"></span><span class="menu-item search" id=search-desktop>
<input type=text placeholder=搜索文章标题或内容... id=search-input-desktop>
<a href=javascript:void(0); class="search-button search-toggle" id=search-toggle-desktop title=搜索><i class="fas fa-search fa-fw" aria-hidden=true></i>
</a><a href=javascript:void(0); class="search-button search-clear" id=search-clear-desktop title=清空><i class="fas fa-times-circle fa-fw" aria-hidden=true></i>
</a><span class="search-button search-loading" id=search-loading-desktop><i class="fas fa-spinner fa-fw fa-spin" aria-hidden=true></i>
</span></span><a href=javascript:void(0); class="menu-item theme-switch" title=切换主题><i class="fas fa-adjust fa-fw" aria-hidden=true></i></a></div></div></div></header><header class=mobile id=header-mobile><div class=header-container><div class=header-wrapper><div class=header-title><a href=/ title=杂货铺><span class=header-title-pre><i class="fa-solid fa-house-chimney"></i></span>老杨的杂货铺</a></div><div class=menu-toggle id=menu-toggle-mobile><span></span><span></span><span></span></div></div><div class=menu id=menu-mobile><div class=search-wrapper><div class="search mobile" id=search-mobile><input type=text placeholder=搜索文章标题或内容... id=search-input-mobile>
<a href=javascript:void(0); class="search-button search-toggle" id=search-toggle-mobile title=搜索><i class="fas fa-search fa-fw" aria-hidden=true></i>
</a><a href=javascript:void(0); class="search-button search-clear" id=search-clear-mobile title=清空><i class="fas fa-times-circle fa-fw" aria-hidden=true></i>
</a><span class="search-button search-loading" id=search-loading-mobile><i class="fas fa-spinner fa-fw fa-spin" aria-hidden=true></i></span></div><a href=javascript:void(0); class=search-cancel id=search-cancel-mobile>取消</a></div><a class=menu-item href=/posts/ title>所有文章</a><a class=menu-item href=/tags/ title>标签</a><a class=menu-item href=/categories/ title>分类</a><a class=menu-item href=https://github.com/yangyingchao/MyNotes title=GitHub rel="noopener noreffer" target=_blank><i class='fab fa-github fa-fw' aria-hidden=true></i> </a><a href=javascript:void(0); class="menu-item theme-switch" title=切换主题><i class="fas fa-adjust fa-fw" aria-hidden=true></i></a></div></div></header><div class="search-dropdown desktop"><div id=search-dropdown-desktop></div></div><div class="search-dropdown mobile"><div id=search-dropdown-mobile></div></div><main class=main><div class=container><div class=toc id=toc-auto><h2 class=toc-title>目录</h2><div class=toc-content id=toc-content-auto></div></div><article class="page single"><h1 class="single-title animate__animated animate__flipInX">分布式 PostgreSQL之Citus 架构-postgresql 分布式</h1><div class=post-meta><div class=post-meta-line><span class=post-author><a href=/ title=Author rel=author class=author><i class="fas fa-user-circle fa-fw" aria-hidden=true></i>yc</a></span></div><div class=post-meta-line><i class="far fa-calendar-alt fa-fw" aria-hidden=true></i>&nbsp;<time datetime=2024-05-13>2024-05-13</time>&nbsp;<i class="fas fa-pencil-alt fa-fw" aria-hidden=true></i>&nbsp;约 2835 字&nbsp;
<i class="far fa-clock fa-fw" aria-hidden=true></i>&nbsp;预计阅读 6 分钟&nbsp;</div></div><div class="details toc" id=toc-static data-kept><div class="details-summary toc-title"><span>目录</span>
<span><i class="details-icon fas fa-angle-right" aria-hidden=true></i></span></div><div class="details-content toc-content" id=toc-content-static><nav id=TableOfContents><ul><li><a href=#节点><span class=section-num>1</span> 节点</a><ul><li><a href=#coordinator-与-worker><span class=section-num>1.1</span> Coordinator 与 Worker</a></li></ul></li><li><a href=#分布式数据><span class=section-num>2</span> 分布式数据</a><ul><li><a href=#表类型><span class=section-num>2.1</span> 表类型</a><ul><li><a href=#类型-1-分布式表><span class=section-num>2.1.1</span> 类型 1：分布式表</a><ul><li><a href=#分布列><span class=section-num>2.1.1.1</span> 分布列</a></li></ul></li><li><a href=#类型-2-引用表-复制表><span class=section-num>2.1.2</span> 类型 2：引用表 （复制表）</a></li><li><a href=#类型-3-本地表><span class=section-num>2.1.3</span> 类型 3：本地表</a></li></ul></li><li><a href=#shards><span class=section-num>2.2</span> Shards</a><ul><li><ul><li><a href=#分片放置><span class=section-num>2.2.0.1</span> 分片放置</a></li><li><a href=#共置><span class=section-num>2.2.0.2</span> 共置</a></li><li><a href=#并行性><span class=section-num>2.2.0.3</span> 并行性</a></li></ul></li></ul></li></ul></li><li><a href=#查询执行><span class=section-num>3</span> 查询执行</a></li></ul></nav></div></div><div class=content id=content><div class="ox-hugo-toc toc has-section-numbers"><div class=heading>Table of Contents</div><ul><li><span class=section-num>1</span> <a href=#%e8%8a%82%e7%82%b9 rel>节点</a><ul><li><span class=section-num>1.1</span> <a href=#coordinator-%e4%b8%8e-worker rel>Coordinator 与 Worker</a></li></ul></li><li><span class=section-num>2</span> <a href=#%e5%88%86%e5%b8%83%e5%bc%8f%e6%95%b0%e6%8d%ae rel>分布式数据</a><ul><li><span class=section-num>2.1</span> <a href=#%e8%a1%a8%e7%b1%bb%e5%9e%8b rel>表类型</a></li><li><span class=section-num>2.2</span> <a href=#shards rel>Shards</a></li></ul></li><li><span class=section-num>3</span> <a href=#%e6%9f%a5%e8%af%a2%e6%89%a7%e8%a1%8c rel>查询执行</a></li></ul></div><p>本文为摘录(或转载)，侵删，原文为： <a href=https://www.51cto.com/article/703272.html target=_blank rel="noopener noreffer">https://www.51cto.com/article/703272.html</a></p><h2 id=节点><span class=section-num>1</span> 节点</h2><p>Citus 是一种 PostgreSQL 扩展，它允许数据库服务器(称为节点)在“无共享(shared nothing)”架构中相互协调。这些节点形成一个集群，允许 PostgreSQL 保存比单台计算机上更多的数据和使用更多的 CPU 内核。这种架构还允许通过简单地向集群添加更多节点来扩容数据库。</p><h3 id=coordinator-与-worker><span class=section-num>1.1</span> Coordinator 与 Worker</h3><p>每个 cluster 都有一个称为 coordinator (协调器) 的特殊节点(其他节点称为 worker 节点)。</p><ul><li><p>应用程序将它们的查询发送到 coordinator 节点，</p></li><li><p>coordinator 节点将其转发给相关的 worker 并累积结果。</p></li><li><p>对于每个查询，coordinator 根据所需数据是位于单个节点上还是多个节点上：</p><ul><li>要么将其路由到单个 worker 节点，</li><li>要么将其并行化到多个节点，</li></ul></li><li><p>coordinator 通过查阅其 <strong>元数据表</strong> 知道如何做到这一点</p><ul><li>这些 Citus 特定表跟踪 worker 节点的 DNS 名称和运行状况， 以及跨节点数据的分布情况。</li></ul></li></ul><h2 id=分布式数据><span class=section-num>2</span> 分布式数据</h2><h3 id=表类型><span class=section-num>2.1</span> 表类型</h3><p>Citus 集群中有三种类型的表，每种表都以不同方式存储在节点中，并且用于不同的目的：</p><ul><li>分布表</li><li>引用表</li><li>本地表</li></ul><h4 id=类型-1-分布式表><span class=section-num>2.1.1</span> 类型 1：分布式表</h4><p>第一种类型，也是最常见的，是分布式表。对于 SQL 语句而言，它们看似是普通的表，但在 worker 节点之间 <strong>水平分区</strong> 。</p><figure><img src=/ox-hugo/911f207084d89908c1c242675bfbe2d047cf2e.png width=660px></figure><p>这里 table 的行存储在 worker 的表 <code>table_1001</code> 、 <code>table_1002</code> 等中。组件 worker 表称为分片(shards)。</p><h5 id=分布列><span class=section-num>2.1.1.1</span> 分布列</h5><p>Citus 使用使用分片算法将行分配到分片。基于表列(称为 <strong>分布列</strong> (distribution column))的值执行分配，此分配具有确定性。集群管理员在分布表时必须指定此列。做出正确的选择，这一点对于性能和功能有重要影响。</p><h4 id=类型-2-引用表-复制表><span class=section-num>2.1.2</span> 类型 2：引用表 （复制表）</h4><ul><li><strong>引用表</strong> 是一种分布式表，其全部内容都集中到单个分片中，并在每个 worker 上复制。</li><li>对任何 worker 的查询都可以在本地访问引用信息，无需从另一个节点请求行，因此也不会产生此类网络开销。</li><li>引用表没有分布列，因为无需区分每行的各个分片。</li><li>引用表通常很小，用于存储与在任何工作节点上运行的查询相关的数据。<br>例如，订单状态或产品类别等枚举值。</li></ul><p>当与 引用表 交互时，我们会自动对事务执行两阶段提交 (2PC)。这意味着 Citus 确保您的数据始终处于一致状态，无论您是在写入、修改还是删除它。</p><ul><li>2PC</li></ul><p><a href=https://en.wikipedia.org/wiki/Two-phase_commit_protocol target=_blank rel="noopener noreffer">https://en.wikipedia.org/wiki/Two-phase_commit_protocol</a></p><h4 id=类型-3-本地表><span class=section-num>2.1.3</span> 类型 3：本地表</h4><p>当您使用 Citus 时，您连接并与之交互的 coordinator 节点是安装了 Citus 扩展的常规 PostgreSQL 数据库。因此，您可以创建普通表并选择不对其进行分片。这对于不参与连接查询的小型管理表很有用。一个示例是用于应用程序登录和身份验证的用户表。</p><p>创建标准 PostgreSQL 表很容易，因为它是默认值。这是你运行 CREATE TABLE 时得到的。在几乎每个 Citus 部署中，我们都会看到标准
PostgreSQL 表与 distributed 和 reference 表共存。事实上，如前所述，Citus 本身使用本地表来保存集群元数据。</p><h3 id=shards><span class=section-num>2.2</span> Shards</h3><p>上一节将分片描述为在 worker 节点内的较小表中包含分布式表的行的子集。本节详细介绍了技术细节。</p><p>协调器上的 <code>pg_dist_shard</code> 元数据表包含系统中每个分布式表的每个分片的行。该行与分片 ID 相匹配，分片 ID 的范围是一组哈希整数
<code>(shardminvalue, shardmaxvalue)</code> 。</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span><span class=lnt>7
</span><span class=lnt>8
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-sql data-lang=sql><span class=line><span class=cl><span class=k>SELECT</span><span class=w> </span><span class=o>*</span><span class=w> </span><span class=k>from</span><span class=w> </span><span class=n>pg_dist_shard</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w> </span><span class=n>logicalrelid</span><span class=w>  </span><span class=o>|</span><span class=w> </span><span class=n>shardid</span><span class=w> </span><span class=o>|</span><span class=w> </span><span class=n>shardstorage</span><span class=w> </span><span class=o>|</span><span class=w> </span><span class=n>shardminvalue</span><span class=w> </span><span class=o>|</span><span class=w> </span><span class=n>shardmaxvalue</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=c1>---------------+---------+--------------+---------------+---------------
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=w> </span><span class=n>github_events</span><span class=w> </span><span class=o>|</span><span class=w>  </span><span class=mi>102026</span><span class=w> </span><span class=o>|</span><span class=w> </span><span class=n>t</span><span class=w>            </span><span class=o>|</span><span class=w> </span><span class=mi>268435456</span><span class=w>     </span><span class=o>|</span><span class=w> </span><span class=mi>402653183</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w> </span><span class=n>github_events</span><span class=w> </span><span class=o>|</span><span class=w>  </span><span class=mi>102027</span><span class=w> </span><span class=o>|</span><span class=w> </span><span class=n>t</span><span class=w>            </span><span class=o>|</span><span class=w> </span><span class=mi>402653184</span><span class=w>     </span><span class=o>|</span><span class=w> </span><span class=mi>536870911</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w> </span><span class=n>github_events</span><span class=w> </span><span class=o>|</span><span class=w>  </span><span class=mi>102028</span><span class=w> </span><span class=o>|</span><span class=w> </span><span class=n>t</span><span class=w>            </span><span class=o>|</span><span class=w> </span><span class=mi>536870912</span><span class=w>     </span><span class=o>|</span><span class=w> </span><span class=mi>671088639</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w> </span><span class=n>github_events</span><span class=w> </span><span class=o>|</span><span class=w>  </span><span class=mi>102029</span><span class=w> </span><span class=o>|</span><span class=w> </span><span class=n>t</span><span class=w>            </span><span class=o>|</span><span class=w> </span><span class=mi>671088640</span><span class=w>     </span><span class=o>|</span><span class=w> </span><span class=mi>805306367</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>(</span><span class=mi>4</span><span class=w> </span><span class=k>rows</span><span class=p>)</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><p>如果 coordinator 节点要确定哪个分片包含 <code>github_events</code> 行，它将对行中分布列的值执行哈希算法。然后此节点检查哪个分片的范围包含此哈希值。定义范围后，哈希函数的 image(图像) 就是两者的并查。</p><h5 id=分片放置><span class=section-num>2.2.0.1</span> 分片放置</h5><p>假设分片 102027 与相应的行关联。在某个 worker 中的 github_events_102027 表中读取或写入此行。是哪个 worker?这完全由元数据表确定。分片映射到 worker 的过程称为分片放置(shard placement)。</p><p>coordinator 节点将查询重写为引用特定表(例如 github_events_102027)的片段，并对相应 worker 运行这些片段。下面的查询示例在后台运行，旨在查找分片 ID 为 102027 的节点。</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-sql data-lang=sql><span class=line><span class=cl><span class=k>SELECT</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>shardid</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>node</span><span class=p>.</span><span class=n>nodename</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>node</span><span class=p>.</span><span class=n>nodeport</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=k>FROM</span><span class=w> </span><span class=n>pg_dist_placement</span><span class=w> </span><span class=n>placement</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=k>JOIN</span><span class=w> </span><span class=n>pg_dist_node</span><span class=w> </span><span class=n>node</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=k>ON</span><span class=w> </span><span class=n>placement</span><span class=p>.</span><span class=n>groupid</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>node</span><span class=p>.</span><span class=n>groupid</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=k>AND</span><span class=w> </span><span class=n>node</span><span class=p>.</span><span class=n>noderole</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=s1>&#39;primary&#39;</span><span class=p>::</span><span class=n>noderole</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=k>WHERE</span><span class=w> </span><span class=n>shardid</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=mi>102027</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=err>┌─────────┬───────────┬──────────┐</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=err>│</span><span class=w> </span><span class=n>shardid</span><span class=w> </span><span class=err>│</span><span class=w> </span><span class=n>nodename</span><span class=w>  </span><span class=err>│</span><span class=w> </span><span class=n>nodeport</span><span class=w> </span><span class=err>│</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=err>├─────────┼───────────┼──────────┤</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=err>│</span><span class=w>  </span><span class=mi>102027</span><span class=w> </span><span class=err>│</span><span class=w> </span><span class=n>localhost</span><span class=w> </span><span class=err>│</span><span class=w>     </span><span class=mi>5433</span><span class=w> </span><span class=err>│</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=err>└─────────┴───────────┴──────────┘</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><p>在 github_events 示例中，有四个分片。每个表的分片数量在其在集群中分布时是可配置的。</p><p>最后请注意，Citus 允许复制分片以防止数据丢失。有两种复制“模式”：Citus 复制和流复制。前者创建额外的备份分片放置并针对所有更新它们的所有它们运行查询。后者效率更高，利用 PostgreSQL 的流式复制将每个节点的整个数据库备份到一个 follower 数据库。这是透明的，不需要 Citus 元数据表的参与。</p><h5 id=共置><span class=section-num>2.2.0.2</span> 共置</h5><p>由于可以根据需要将分片及其副本放置在节点上，因此将包含相关表的相关行的分片放在同一节点上是有意义的。这样，它们之间的连接查询可以避免通过网络发送尽可能多的信息，并且可以在单个 Citus 节点内执行。</p><p>一个示例是包含商店、产品和购买的数据库。如果所有三个表都包含 - 并且由 - store_id 列分布，那么限制在单个存储中的所有查询都可以在单个工作节点上高效运行。即使查询涉及这些表的任意组合也是如此。</p><h5 id=并行性><span class=section-num>2.2.0.3</span> 并行性</h5><p>跨多台机器分散查询允许一次运行更多查询，并允许通过向集群添加新机器来扩展处理速度。此外，如上一节所述，将单个查询拆分为片段可以提高专用于它的处理能力。后一种情况实现了最大的并行性，这意味着 CPU 内核的利用率。</p><p>读取或影响均匀分布在多个节点上的分片的查询能够以“实时”速度运行。请注意，查询的结果仍然需要通过协调器节点传回，因此当最终结果紧凑时(例如计数和描述性统计等聚合函数)，加速效果最为明显。</p><h2 id=查询执行><span class=section-num>3</span> 查询执行</h2><p>在执行多分片查询时，Citus 必须平衡并行性的收益与数据库连接的开销(网络延迟和工作节点资源使用)。要配置 Citus 的查询执行以获得最佳的数据库工作负载结果，它有助于了解 Citus 如何管理和保存协调节点和工作节点之间的数据库连接。</p><p>Citus 将每个传入的多分片查询会话转换为称为任务的每个分片查询。它将任务排队，并在能够获得与相关工作节点的连接时运行它们。对于分布式表 foo 和 bar 的查询，下面是连接管理图：</p><figure><img src=/ox-hugo/71549bc185ecdac0529037ad4fe9c6f95a7c7f.png width=800px></figure><p>coordinator 节点为每个会话都有一个连接池。每个查询(例如图中的 SELECT * FROM foo)仅限于为每个 worker 的任务打开最多
citus.max_adaptive_executor_pool_size(整数)个同时连接。该设置可在会话级别进行配置，以进行优先级管理。</p><p>在同一连接上按顺序执行短任务比为它们并行建立新连接更快。另一方面，长时间运行的任务受益于更直接的并行性。</p><p>为了平衡短任务和长任务的需求，Citus 使用 citus.executor_slow_start_interval(整数)。该设置指定多分片查询中任务的连接尝试之间的延迟。当查询首先对任务进行排队时，这些任务只能获取一个连接。在每个有待处理连接的时间间隔结束时，Citus 会增加它将打开的同时连接数。通过将 GUC 设置为 0，可以完全禁用慢启动行为。</p><p>当任务完成使用连接时，会话池将保持连接打开以供以后使用。缓存连接避免了 coordinator 和 worker 之间重新建立连接的开销。但是，每个池一次打开的空闲连接不超过 citus.max_cached_conns_per_worker(整数)个，以限制 worker 中空闲连接资源的使用。</p><p>最后，设置 citus.max_shared_pool_size (integer) 充当故障保险。它限制了所有任务之间每个 worker 的总连接数。</p></div><div class=post-footer id=post-footer><div class=post-info><div class=post-info-line><div class=post-info-mod><span>更新于 2024-05-13</span></div></div><div class=post-info-line><div class=post-info-md><span><a class=link-to-markdown href=/www/index.md target=_blank>阅读原始文档</a></span></div><div class=post-info-share><span></span></div></div></div><div class=post-info-more><section class=post-tags><i class="fas fa-tags fa-fw" aria-hidden=true></i>&nbsp;<a href=/tags/transaction/>Transaction</a>,&nbsp;<a href=/tags/pg/>Pg</a>,&nbsp;<a href=/tags/citus/>Citus</a></section><section><span><a href=javascript:void(0); onclick=window.history.back()>返回</a></span>&nbsp;|&nbsp;<span><a href=/>主页</a></span></section></div><div class=post-nav><a href=/stackoverflow/ class=prev rel=prev title="Github API: Fetch issues with exceeds rate limit prematurely"><i class="fas fa-angle-left fa-fw" aria-hidden=true></i>Github API: Fetch issues with exceeds rate limit prematurely</a>
<a href=/org-fold-core/ class=next rel=next title=org-fold-core>org-fold-core<i class="fas fa-angle-right fa-fw" aria-hidden=true></i></a></div></div><div id=comments><div id=giscus class=comment></div><noscript>Please enable JavaScript to view the comments powered by <a href=https://giscus.app>Giscus</a>.</noscript></div></article></div></main><footer class=footer><div class=footer-container><div class=footer-line itemscope itemtype=http://schema.org/CreativeWork>&nbsp;|&nbsp;<span class=license><a rel="license external nofollow noopener noreffer" href=https://creativecommons.org/licenses/by-nc/4.0/ target=_blank>CC BY-NC 4.0</a></span></div></div></footer></div><div id=fixed-buttons><a href=# id=back-to-top class=fixed-button title=回到顶部><i class="fas fa-arrow-up fa-fw" aria-hidden=true></i>
</a><a href=# id=view-comments class=fixed-button title=查看评论><i class="fas fa-comment fa-fw" aria-hidden=true></i></a></div><script type=text/javascript src=https://cdn.jsdelivr.net/npm/autocomplete.js@0.38.1/dist/autocomplete.min.js></script><script type=text/javascript src=https://cdn.jsdelivr.net/npm/algoliasearch@4.13.1/dist/algoliasearch-lite.umd.min.js></script><script type=text/javascript src=https://cdn.jsdelivr.net/npm/lazysizes@5.3.2/lazysizes.min.js></script><script type=text/javascript src=https://cdn.jsdelivr.net/npm/clipboard@2.0.11/dist/clipboard.min.js></script><script type=text/javascript>window.config={code:{copyTitle:"复制到剪贴板",maxShownLines:50},comment:{giscus:{category:"Announcements",categoryId:"R_kgDON6NYZA",darkTheme:"dark",emitMetadata:"0",inputPosition:"bottom",lang:"zh-CN",lazyLoading:!1,lightTheme:"light",mapping:"pathname",reactionsEnabled:"1",repo:"yangyingchao/giscus",repoId:""}},search:{algoliaAppID:null,algoliaIndex:"index.zh-cn",algoliaSearchKey:null,highlightTag:"em",maxResultLength:10,noResultsFound:"没有找到结果",snippetLength:30,type:"algolia"}}</script><script type=text/javascript src=/js/theme.min.js></script></body></html>